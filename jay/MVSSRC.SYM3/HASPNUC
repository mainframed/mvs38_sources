NUC      TITLE 'HASP NUCLEUS PROLOG'                           @OZ18212 70001000
*********************************************************************** 70002000
*                                                                     * 70003000
* MODULE NAME = HASJES20 ( HASPNUC CSECT )                            * 70004000
*                                                                     * 70005000
* DESCRIPTIVE NAME = HASPNUC CSECT OF JES2 MAIN MODULE                * 70006000
*                                                                     * 70007000
* COPYRIGHT = NONE                                                    * 70008100
*                                                                     * 70009000
* STATUS = OS/VS2 MVS   --  SEE &VERSION (BELOW) FOR JES2 LEVEL       * 70010000
*                                                                     * 70011000
* FUNCTION = THE HASPNUC CSECT PROVIDES THE BASIC PROCESSOR CONTROL   * 70012000
*            BLOCKS AND SERVICE ROUTINES FOR THE MAIN JES2 TASK.      * 70013000
*            IT ALSO CONTAINS BASIC COMMUNICATIONS WITH DAUGHTER      * 70014000
*            TASKS.                                                   * 70015000
*                                                                     * 70016000
* NOTES = SEE BELOW                                                   * 70017000
*                                                                     * 70018000
*    DEPENDENCIES = EXCP ACCESS METHOD, DYNAMIC ALLOCATION,           * 70019000
*                   DYNAMIC UNALLOCATION, TIMER INTERFACE, AND        * 70020000
*                   ABNORMAL END EXIT INTERFACE.                      * 70021000
*                                                                     * 70022000
*    RESTRICTIONS = NONE                                              * 70023000
*                                                                     * 70024000
*    REGISTER CONVENTIONS = SEE ENTRY POINT DOCUMENTATION             * 70025000
*                                                                     * 70026000
*    PATCH LABEL = $PATCHSP                                           * 70027000
*                                                                     * 70028000
* MODULE TYPE = PROCEDURE, TABLE ( CSECT TYPE )                       * 70029000
*                                                                     * 70030000
*    PROCESSOR = ASSEMBLER F                                          * 70031000
*                                                                     * 70032000
*    MODULE SIZE = SEE $DLENGTH MACRO EXPANSION(S) AT END OF ASSEMBLY * 70033000
*                                                                     * 70034000
*    ATTRIBUTES = 1ST 4K NOT REUSABLE, REMAINDER READ ONLY AND        * 70035000
*                 HASP REENTRANT                                      * 70036000
*                                                                     * 70037000
* ENTRY POINT =    HASP     - INITIAL ENTRY TO INITIALIZE THE JES2    * 70038000
*                             SYSTEM FOLLOWING BRANCH TO HASPINGO.    * 70039000
*                                                                     * 70040000
*                  $WAIT    - ENTRY TO PUT PCE IN $WAIT STATE         * 70041000
*                             AND DISPATCH ANOTHER JES2 PROCESSOR     * 70042000
*                             OR WAIT FOR AN OS POST.                 * 70043000
*                                                                     * 70044000
*                  $WAITR   - ENTRY TO PUT PCE IN $WAIT STATE ON      * 70045000
*                             A RESOURCE WAIT QUEUE AND DISPATCH      * 70046000
*                             ANOTHER JES2 PROCESSOR OR WAIT FOR      * 70047000
*                             AN OS POST.                             * 70048000
*                                                                     * 70049000
*                  $POST    - ENTRY TO PUT AN INDIVIDUAL JES2         * 70050000
*                             PROCESSOR ON THE READY QUEUE FOR        * 70051000
*                             DISPATCHING.                            * 70052000
*                                                                     * 70053000
*                  $EXCPR   - ENTRY TO EXCP ACCESS METHOD             * 70054000
*                             INTERFACE ROUTINE FOR SCHEDULLING       * 70055000
*                             I/O OPERATIONS.                         * 70056000
*                                                                     * 70057000
*                  $QADD    - ENTRY TO JES2 JOB QUEUE MANAGER QADD    * 70058000
*                             SERVICE ROUTINE TO ADD A NEW JOB TO     * 70059000
*                             THE SYSTEM.                             * 70060000
*                                                                     * 70061000
*                  $QGET    - ENTRY TO JES2 JOB QUEUE MANAGER QGET    * 70062000
*                             SERVICE ROUTINE TO GET A QUEUED JOB     * 70063000
*                             MAKING IT ACTIVE.                       * 70064000
*                                                                     * 70065000
*                  $QPUT    - ENTRY TO JES2 JOB QUEUE MANAGER QPUT    * 70066000
*                             SERVICE ROUTINE TO PUT A JOB ON A       * 70067000
*                             LOGICAL QUEUE.                          * 70068000
*                                                                     * 70069000
*                  $QREM    - ENTRY TO JES2 JOB QUEUE MANAGER QREM    * 70070000
*                             SERVICE ROUTINE TO REMOVE A JOB FROM    * 70071000
*                             THE SYSTEM.                             * 70072000
*                                                                     * 70073000
*                  $QLOC    - ENTRY TO JES2 JOB QUEUE MANAGER QLOC    * 70074000
*                             SERVICE ROUTINE TO LOCATE A JOB QUEUE   * 70075000
*                             ENTRY FOR A GIVEN JOB BY NUMBER.        * 70076000
*                                                                     * 70077000
*                  $QCKPT   - ENTRY TO JES2 JOB QUEUE MANAGER QCKPT   * 70078000
*                             SERVICE ROUTINE TO SCHEDULE A           * 70079000
*                             CHECKPOINT OF A JOB QUEUE ELEMENT.      * 70080000
*                                                                     * 70081000
*                  $QMOD    - ENTRY TO JES2 JOB QUEUE MANAGER QMOD    * 70082000
*                             SERVICE ROUTINE TO MODIFY CHAIN         * 70083000
*                             FIELDS OF JOB QUEUE ELEMENTS ON         * 70084000
*                             BEHALF OF A JOB.                        * 70085000
*                                                                     * 70086000
*                  $QSUSE   - ENTRY TO REQUEST ACCESS (FOR POTENTIAL  * 70087000
*                             CHANGE) TO ANY INFORMATION IN THE JOB   * 70088000
*                             AND JOT QUEUE CHECKPOINTED RECORDS.     * 70089000
*                                                                     * 70090000
*                  $GETUNIT - ENTRY TO JES2 UNIT SERVICES TO          * 70091000
*                             ALLOCATE A DEVICE CONTROL TABLE         * 70092000
*                             (DCT) FOR USE BY A PROCESSOR.           * 70093000
*                                                                     * 70094000
*                  $FREUNIT - ENTRY TO JES2 UNIT SERVICES TO          * 70095000
*                             FREE A DEVICE FOR USE BY ANOTHER        * 70096000
*                             PROCESSOR, PLACE THE DEVICE IN A        * 70097000
*                             HOLD STATUS, OR DRAIN THE DEVICE        * 70098000
*                             WITH POSSIBLE OS UNALLOCATION.          * 70099000
*                                                                     * 70100000
*                  $STIMER  - ENTRY TO JES2 INTERVAL TIMER MANAGER    * 70101000
*                             TO QUEUE A JES2 TIMER QUEUE ELEMENT.    * 70102000
*                                                                     * 70103000
*                  $TTIMER  - ENTRY TO JES2 INTERVAL TIMER MANAGER    * 70104000
*                             TO DETERMINE REMAINING TIME AND         * 70105000
*                             OPTIONALLY TERMINATE THE INTERVAL.      * 70106000
*                                                                     * 70107000
*                  $GETSMFB - ENTRY TO JES2 SMF MANAGEMENT TO GET     * 70108000
*                             A FREE SMF BUFFER.                      * 70109000
*                                                                     * 70110000
*                  $QUESMFB - ENTRY TO JES2 SMF MANAGEMENT TO QUEUE   * 70111000
*                             A SMF BUFFER FOR OUTPUT BY THE SMF      * 70112000
*                             INTERFACE DAUGHTER TASK.                * 70113000
*                                                                     * 70114000
*                  $PURGER  - ENTRY TO DIRECT ACCESS TRACK MANAGEMENT * 70115000
*                             TO PURGE TRACKS FREEING SPACE FOR       * 70116000
*                             USE BY OTHERS.                          * 70117000
*                                                                     * 70118000
*                  $BFRBLDR - ENTRY TO BUFFER PREFIX-BUILD ROUTINE    * 70119000
*                             TO CONSTRUCT AN IOB OR RPL AT THE       * 70120000
*                             BEGINNING OF A BUFFER.                  * 70121000
*                                                                     * 70122000
*                  $XMPOSTR - ENTRY TO ROUTINE TO PERFORM A BRANCH-   * 70123000
*                             ENTRY POST OF AN ECB.                   * 70124000
*                                                                     * 70125000
*                  $PGRLSER - ENTRY TO JES2 PAGE SERVICES TO DO A     * 70126000
*                             PAGE RELEASE VIA BRANCH ENTRY TO MVS    * 70127000
*                             PAGE SERVICES.                          * 70128000
*                                                                     * 70129000
*                  $PGFREER - ENTRY TO JES2 PAGE SERVICES TO DO A     * 70130000
*                             PAGE FREE VIA BRANCH ENTRY TO MVS       * 70131000
*                             PAGE SERVICES.                          * 70132000
*                                                                     * 70133000
*                  $PGFIXR  - ENTRY TO JES2 PAGE SERVICES TO DO A     * 70134000
*                             PAGE FIX VIA BRANCH ENTRY TO MVS        * 70135000
*                             PAGE SERVICES.                          * 70136000
*                                                                     * 70137000
*                  $TRACKR  - ENTRY TO DIRECT ACCESS MANAGEMENT       * 70138000
*                             TO ASSIGN THE NEXT RECORD ADDRESS TO    * 70139000
*                             WRITE SPOOL RECORDS.                    * 70140000
*                                                                     * 70141000
*                  $GETBUFR - ENTRY TO BUFFER POOL MANAGEMENT TO      * 70142000
*                             GET ONE OR MORE FREE BUFFERS.           * 70143000
*                                                                     * 70144000
*                  $FREEBFR - ENTRY TO BUFFER POOL MANAGEMENT TO      * 70145000
*                             FREE ONE OR MORE BUFFERS.               * 70146000
*                                                                     * 70147000
*                  $GETCELR - ENTRY TO CELL SERVICES                  * 70148000
*                             TO CLAIM A COMMON STORAGE AREA CELL.    * 70149000
*                                                                     * 70150000
*                  $FRECELR - ENTRY TO CELL SERVICES TO FREE A        * 70151000
*                             COMMON STORAGE AREA CELL.               * 70152000
*                                                                     * 70153000
*                  $GETLOKR - ENTRY TO LOCK SERVICES TO GET THE       * 70154000
*                             OS CMS LOCK.                            * 70155000
*                                                                     * 70156000
*                  $FRELOKR - ENTRY TO LOCK SERVICES TO FREE THE      * 70157000
*                             OS CMS LOCK.                            * 70158000
*                                                                     * 70159000
*                  HASPATTN - ENTRY TO UNSOLICITED DEVICE END         * 70160000
*                             ATTENTION ROUTINE.                      * 70161000
*                                                                     * 70162000
*                  $IOAPPEN - INPUT/OUTPUT APPENDAGE VECTOR TABLE     * 70163000
*                             FOR JES2 $EXCP SERVICES AND APPENDAGE   * 70164000
*                             ROUTINES.                               * 70165000
*                                                                     * 70166000
*                  $ASYNC   - ENTRY TO ASYNCHRONOUS INPUT/OUTPUT      * 70167000
*                             PROCESSOR.                              * 70168000
*                                                                     * 70169000
*                  $TIMER   - ENTRY TO JES2 TIMER PROCESSOR.          * 70170000
*                                                                     * 70171000
*                  $DYN     - ENTRY TO INTERFACE TO OS ALLOCATE       * 70172000
*                             AND UNALLOCATE UNIT RECORD DEVICES.     * 70173000
*                                                                     * 70174000
*                  $#BLD    - ENTRY TO JES2 JOT SERVICES TO BUILD     * 70175000
*                             A PAIR OF WORK AND CHARACTERISTICS      * 70176000
*                             JOES.                                   * 70177000
*                                                                     * 70178000
*                  $#ADD    - ENTRY TO JES2 JOT SERVICES TO COPY      * 70179000
*                             A PAIR OF WORK AND CHARACTERISTICS      * 70180000
*                             JOES INTO THE JOT.                      * 70181000
*                                                                     * 70182000
*                  $#GET    - ENTRY TO JES2 JOT SERVICES TO SELECT    * 70183000
*                             A WORK JOE FROM THE JOT BASED UPON      * 70184000
*                             DEVICE CHARACTERISTICS.                 * 70185000
*                                                                     * 70186000
*                  $#PUT    - ENTRY TO JES2 JOT SERVICES TO RETURN    * 70187000
*                             A WORK JOE TO THE JOT FOR LATER         * 70188000
*                             PROCESSING.                             * 70189000
*                                                                     * 70190000
*                  $#REM    - ENTRY TO JES2 JOT SERVICES TO REMOVE    * 70196000
*                             A WORK JOE FROM THE JOT FOR WHICH       * 70197000
*                             ALL OUTPUT HAS BEEN PROCESSED.          * 70198000
*                                                                     * 70199000
*                  $#CAN    - ENTRY TO JES2 JOT SERVICES TO REMOVE    * 70200000
*                             FROM THE JOT ALL NON-BUSY JOES FOR      * 70201000
*                             A SPECIFIED JOB.                        * 70202000
*                                                                     * 70203000
*                  $#JCTRDR - ENTRY TO JES2 JOT SERVICES TO OBTAIN    * 70204000
*                             THE BUFFER ADDRESS OF A RESIDENT JCT    * 70205000
*                             FOR A SPECIFIED JOB, OBTAINING THE JCT  * 70206000
*                             FROM SPOOL IF NECESSARY.                * 70207000
*                                                                     * 70208000
*                  $#JCTWTR - ENTRY TO JES2 JOT SERVICES TO WRITE     * 70209000
*                             TO SPOOL A RESIDENT JCT.                * 70210000
*                                                                     * 70211000
*                  $#JCTFRE - ENTRY TO JES2 JOT SERVICES TO RELEASE   * 70212000
*                             OWNERSHIP OF A RESIDENT JCT.            * 70213000
*                                                                     * 70214000
*                  $#WTR    - ENTRY TO JES2 SERVICE ROUTINE TO POST   * 70215000
*                             ANY EXTERNAL WRITERS WAITIJG ON JOT.    * 70216000
*                                                                     * 70217000
*                  $$WTO    - ENTRY TO JES2 ROUTINE TO ISSUE WTO      * 70218000
*                             AND WTOR MESSAGES DIRECTLY.             * 70219000
*                                                                     * 70220000
*                  $DISTERR - ENTRY TO DISASTEROUS ERROR ROUTINE      * 70221000
*                             TO ISSUE $WTO MESSAGE.                  * 70222000
*                                                                     * 70223000
*                  $ERROR   - ENTRY TO CATASTROPHIC ERROR ROUTINE     * 70224000
*                             TO ABNORMALLY TERMINATE PROCESSING.     * 70225000
*                                                                     * 70226000
*                  $HEXIT   - ENTRY TO CATASTROPHIC ERROR ROUTINE     * 70227000
*                             TO NORMALLY TERMINATE PROCESSING.       * 70228000
*                                                                     * 70229000
*                  $IOERROR - ENTRY TO I/O ERROR ROUTINE TO FORMAT    * 70230000
*                             AND DISPLAY MESSAGE.                    * 70231000
*                                                                     * 70232000
*                  $ABEND   - ENTRY TO ABNORMAL END EXIT ROUTINE.     * 70233000
*                                                                     * 70234000
*    PURPOSE = SEE FUNCTION                                           * 70235000
*                                                                     * 70236000
*    LINKAGE = SEE ENTRY POINT DOCUMENTATION                          * 70237000
*                                                                     * 70238000
* INPUT = SEE ENTRY POINT DOCUMENTATION                               * 70239000
*                                                                     * 70240000
* OUTPUT = SEE ENTRY POINT DOCUMENTATION                              * 70241000
*                                                                     * 70242000
* EXIT-NORMAL = SEE ENTRY POINT DOCUMENTATION                         * 70243000
*                                                                     * 70244000
* EXIT-ERROR = CATASTROPHIC ERROR ROUTINE ISSUES MESSAGE AND          * 70245000
*              RESPONDS TO OPERATORS REQUEST.                         * 70246000
*                                                                     * 70247000
* EXTERNAL REFERENCES = SEE BELOW                                     * 70248000
*                                                                     * 70249000
*    ROUTINES = SVC 1, SVC 2, SVC 0, SVC 46, SVC 47, SETLOCK,         * 70250000
*               SVC 35, SVC 3, SVC 62, $SVTRAK2, $SVGCMNS, $SVGCELL,  * 70251000
*               $SVFCELL, $WTOR, $FRECMBR, SVC 87                     * 70252000
*                                                                     * 70253000
*    DATA AREAS = SEE $HASPCB MACRO EXPANSION                         * 70254000
*                                                                     * 70255000
*    CONTROL BLOCKS = SEE $HASPCB MACRO EXPANSION                     * 70256000
*                                                                     * 70257000
* TABLES = SEE BELOW                                                  * 70258000
*                                                                     * 70259000
* MACROS = EXCP, WAIT, POST, WTO, WTOR, TTIMER, STIMER, SETLOCK,      * 70260000
*          MODESET, DETACH, DOM                                       * 70261000
* CHANGE ACTIVITY                                                     * 70262000
*                                                                     * 70262100
*     RELEASE 4.0 = OZ03342,OZ04345,OZ05783,OZ07436,OZ09024,OZ09095   * 70262300
*                                                                     * 70262400
*     RELEASE 4.1 = OZ09073,OZ11742,OZ11744,OZ11751,OZ11763,OZ12274,  * 70262500
*                   OZ12298,OZ14413                                   * 70262600
*                                                                     * 70264000
*********************************************************************** 70265000
         TITLE 'HASP CONTROL BLOCK GENERATION MACRO'                    70266000
*                                                                       70267000
***** $HASPCB *****           GENERATE HASP CONTROL BLOCKS              70268000
*                                                                       70269000
*                                                                       70270000
         MACRO                                                          70271000
         $HASPCB &DOC=NO,&LIST=NO                                       70272000
         GBLC  &PRINT,&GEN,&DATA                                        70273000
         PUSH  PRINT                                                    70274000
         PRINT &PRINT                                                   70275000
         $ASCB LIST=&LIST          GENERATE OS ASCB DSECT      @OZ18608 70275500
         $PSA  LIST=&LIST          GENERATE OS PSA DSECT                70276000
         $CVT  LIST=&LIST          GENERATE OS CVT DSECT                70277000
         $SSOB (SO),LIST=&LIST     GENERATE OS SSOB DSECT            R4 70278000
         $SRB  LIST=&LIST          GENERATE OS SRB DSECT                70279000
         $DCB  LIST=&LIST          GENERATE OS DCB DSECT                70280000
         $DEB  LIST=&LIST          GENERATE OS DEB DSECT                70281000
         $IOSB LIST=&LIST          GENERATE OS IOSB DSECT               70282000
         $RPL  LIST=&LIST          GENERATE OS RPL DSECT             R4 70283000
         $UCB  LIST=&LIST          GENERATE OS UCB DSECT                70284000
         $DYN  LIST=&LIST          GENERATE OS DYN DSECT                70285000
         $UCM  LIST=&LIST          GENERATE OS UCM DSECT             R4 70286000
         $IOCM LIST=&LIST          GENERATE OS IOCM DSECT               70287000
         $TCB  LIST=&LIST          GENERATE OS TCB DSECT       @OZ32566 70287400
         $TIOT LIST=&LIST          GENERATE OS TIOT DSECT      @OZ32566 70287600
         $SDWA LIST=&LIST          GENERATE OS SDWA DSECT      @OZ32566 70287800
         $EWA  LIST=&LIST          GENERATE OS EWA DSECT             R4 70288000
         $TED  DOC=&DOC            GENERATE HASP TED DSECT              70289000
         $TGB  DOC=&DOC            GENERATE HASP TGB DSECT              70290000
         $TGM  DOC=&DOC            GENERATE HASP TGM DSECT              70291000
         $TAB  DOC=&DOC            GENERATE HASP TAB DSECT           R4 70292000
         $PCIE DOC=&DOC            GENERATE HASP PCIE DSECT          R4 70293000
         $SVT  DOC=&DOC            GENERATE HASP SSVT DSECT             70294000
         $SJB  DOC=&DOC            GENERATE HASP SJB DSECT              70295000
         $PCE  DOC=&DOC            GENERATE HASP PCE DSECT              70296000
         $BUFFER DOC=&DOC          GENERATE HASP BUFFER DSECT           70297000
         $BPM  DOC=&DOC            GENERATE HASP BPM DSECT           R4 70298000
         $CMB  DOC=&DOC            GENERATE HASP CMB DSECT              70299000
         $SMF  DOC=&DOC            GENERATE HASP SMF DSECT              70300000
         $ICE  DOC=&DOC            GENERATE HASP ICE DSECT          R41 70300500
         $FMH  DOC=&DOC            GENERATE HASP FMH DSECT          R41 70300600
         $JQE  DOC=&DOC            GENERATE HASP JQE DSECT              70301000
         $JOE  DOC=&DOC            GENERATE HASP JOE DSECT           R4 70302000
         $JOT  DOC=&DOC            GENERATE HASP JOT DSECT           R4 70303000
         $QSE  DOC=&DOC            GENERATE HASP QSE DSECT              70304000
         $JCT  DOC=&DOC            GENERATE HASP JCT DSECT              70305000
         $PDDB DOC=&DOC            GENERATE HASP PDDB DSECT          R4 70306000
         $IOT  DOC=&DOC            GENERATE HASP IOT DSECT           R4 70307000
         $SCAT DOC=&DOC            GENERATE OS SCAT DSECT            R4 70308000
         $DCT  DOC=&DOC            GENERATE HASP DCT DSECT              70309000
         $TQE  DOC=&DOC            GENERATE HASP TQE DSECT              70310000
         $CCA  DOC=&DOC            GENERATE HASP CCA DSECT           R4 70311000
         $CCE  DOC=&DOC            GENERATE HASP CCE DSECT           R4 70312000
         $PSO  DOC=&DOC            GENERATE HASP PSO DSECT           R4 70313000
         $DTE  DOC=&DOC            GENERATE HASP DTE DSECT              70314000
         $EEL  DOC=&DOC            GENERATE HASP EEL DSECT     @OZ32566 70314500
         $PPPWORK DOC=&DOC         GENERATE HASP PPPWORK DSECT       R4 70315000
         POP   PRINT                                                    70316000
         PRINT &GEN,&DATA          SET ASSEMBLY PRINT OPTIONS           70317000
         $HCT  DOC=&DOC            GENERATE HASP HCT                    70318000
         SPACE 1                                                        70319000
         MEND                                                           70320000
         TITLE 'HASP DAUGHTER TASK ELEMENT FORMAT GENERATION MACRO'     70321000
         SPACE 5                                                        70322000
*                                                                       70323000
***** $DTE *****              DEFINE HASP DAUGHTER-TASK ELEMENT         70324000
*                                                                       70325000
*                                                                       70326000
         MACRO                                                          70327000
         $DTE  &DOC=NO                                                  70328000
         TITLE 'HASP DAUGHTER TASK ELEMENT (DTE) DSECT'                 70329000
         SPACE 5                                                        70330000
DTEDSECT DSECT                                                          70331000
DTETCB   DS    A                   SUB-TASK TCB ADDRESS                 70332000
DTETECB  DS    F                   SUB-TASK TERMINATION ECB             70333000
DTEWECB  DS    F                   SUB-TASK WORK ECB                    70334000
&SYSECT  CSECT                     END OF DTE DSECT                     70335000
         MEND                                                           70336000
         TITLE 'HASP ESTAE ELEMENT (EEL) MACRO DEFINITION'     @OZ32566 70336200
         SPACE 3                                               @OZ32566 70336300
*                                                              @OZ32566 70336400
***** $EEL *****                   DEFINE HASP ESTAE ELEMENT   @OZ32566 70336500
*                                                              @OZ32566 70336600
*                                                              @OZ32566 70336700
         MACRO -- $EEL -- HASP ESTAE ELEMENT DSECT             @OZ32566 70336800
        $EEL   &DOC=NO                                         @OZ32566 70336900
         TITLE 'HASP ESTAE ELEMENT (EEL) DSECT'                @OZ32566 70337000
         SPACE 2                                               @OZ32566 70337100
EELDSECT DSECT                     HASP ESTAE ELEMENT DSECT    @OZ32566 70337200
         SPACE 1                                               @OZ32566 70337300
EELFLAGS DS    X                   FLAG BYTE                   @OZ32566 70337400
EELILC   DS    X                   INSTR. LNGTH CODE (IN BYTES)@OZ32566 70337500
         DS    H                   RESERVED FOR FUTURE USE     @OZ32566 70337600
EELCODE  DS    CL4                 ABEND OR $ERROR CODE        @OZ32566 70337700
EELFADDR DS    A                   ADDRESS OF FAILURE          @OZ32566 70337800
EELPCE   DS    A                   ADDRESS OF FAILING PCE      @OZ32566 70337900
EELPSW   DS    2A                  PSW AT TIME OF ABEND        @OZ32566 70338000
EELREGS  DS    XL(16*4)            REGISTERS AT TIME OF ABEND  @OZ32566 70338100
         DS    F                   RESERVED                    @OZ32566 70338200
         SPACE 1                                               @OZ32566 70338300
EELSIZE  EQU   *-EELDSECT          SIZE OF AN EEL              @OZ32566 70338400
         SPACE 4                                               @OZ32566 70338500
*        EELFLAGS                                              @OZ32566 70338600
         SPACE 2                                               @OZ32566 70338700
EELJESAB EQU   B'10000000'   80    JES2 $ERROR                 @OZ32566 70338800
EELSYSAB EQU   B'01000000'   40    JES2 SYSTEM ABEND           @OZ32566 70338900
EELREGSA EQU   B'00100000'   20    REGISTERS AVAILABLE IN EEL  @OZ32566 70339000
&SYSECT  CSECT                                                 @OZ32566 70339100
.END     MEND                                                  @OZ32566 70339200
         TITLE 'HASP NUCLEUS'                                  @OZ32566 70339400
         SPACE 5                                               @OZ32566 70339500
HASPNUC  START 0                   HASP NUCLEUS                @OZ32566 70339600
         SPACE 5                                                        70340000
*                                                                       70341000
*                             EXTERNAL REFERENCES                       70342000
*                                                                       70343000
         SPACE 3                                                        70344000
         ENTRY HASP                MAIN ENTRY                           70345000
         ENTRY $QINDEX             ADDRESS OF JOB QUEUE INDEX TABLE     70346000
         ENTRY $IOAPPEN            I/O APPENDAGE TABLE                  70347000
         ENTRY $ABEND              HASP STAE EXIT ROUTINE               70348000
         ENTRY $GETCELR            ADDRESS OF GET CELL ROUTINE          70349000
         ENTRY $FRECELR            ADDRESS OF FREE CELL ROUTINE         70350000
         ENTRY $GETLOKR            ADDRESS OF GET LOCK ROUTINE          70351000
         ENTRY $FRELOKR            ADDRESS OF FREE LOCK ROUTINE         70352000
         ENTRY $DYN                ADDRESS OF ALLOCATION ROUTINE        70353000
         ENTRY $HEXIT              ADDRESS OF HASP EXIT ROUTINE         70354000
         ENTRY HASPATTN            ADDRESS OF HASP ATTENTION APPENDAGE  70355000
         ENTRY $ERRORSA            ADDRESS OF ERROR EXIT REGISTER SAVE  70356000
         SPACE 5                                                        70357000
         COPY  $HASPGEN            COPY HASPGEN PARAMETERS              70358000
         SPACE 5                                                     R4 70359000
         GBLB  &IECIHDR            IOSGEN DOCUMENTATION OPTION       R4 70360000
         GBLB  &IECITP             IOSGEN DOCUMENTATION OPTION       R4 70361000
         TITLE 'HASP CONTROL BLOCKS'                                    70362000
*                                                                       70363000
*                             DOCUMENTATION OPTIONS FOR THIS ASSEMBLY   70364000
*                                                                       70365000
         SPACE 3                                                        70366000
        $SYSPARM (OFF,GEN,NODATA,NO,NO)                                 70367000
         SPACE 5                                                        70368000
*                                                                       70369000
*                             GENERATE HASP CONTROL BLOCKS              70370000
*                                                                       70371000
         SPACE 3                                                        70372000
        $HASPCB DOC=&DOC,LIST=&LIST  GENERATE HASP CONTROL BLOCKS       70373000
         TITLE 'HASP DISPATCHER'                                        70374000
*********************************************************************** 70375000
*                                                                     * 70376000
*        $WAIT - WAIT ON A SPECIFIC $POST                             * 70377000
*                                                                     * 70378000
*        R11   = HCT ADDRESS (BASE1)                                  * 70379000
*        R13   = PCE ADDRESS (SAVE)                                   * 70380000
*        R15   = NEW ENTRY ADDRESS                                    * 70381000
*                                                                     * 70382000
*********************************************************************** 70383000
         SPACE 1                                                     R4 70384000
         CNOP  0,8                                                   R4 70385000
$WAITS   NULL                      $WAIT SAVE=YES FOR AN EVENT       R4 70386000
         ST    R14,PCELINK         SAVE PROCESSORS                   R4 70387000
         STM   R0,R12,PCER0            REGISTERS                     R4 70388000
         SPACE 1                                                     R4 70389000
$WAIT    NULL                      $WAIT SAVE=NO FOR AN EVENT        R4 70390000
         ST    R15,PCER15          SAVE RE-ENTRY ADDRESS             R4 70391000
         LM    R2,R3,PCEPCEA       POINT TO NEXT AND PREVIOUS PCE       70392000
         ST    R2,PCEPCEA-PCEDSECT(,R3) REMOVE PCE                      70393000
         ST    R3,PCEPCEB-PCEDSECT(,R2) FROM QUEUE                      70394000
         ST    SAVE,PCEPCEA        SET NEXT WAITING TO ITSELF           70395000
         ST    SAVE,PCEPCEB        SET PREVIOUS WAITING TO ITSELF       70396000
         B     HASPDISP            DISPATCH NEXT READY               R4 70397000
         EJECT                                                       R4 70398000
*********************************************************************** 70399000
*                                                                     * 70400000
*        $WAITR - WAIT ON A RESOURCE ( REGISTERS SAVED BY MACRO )     * 70401000
*                                                                     * 70402000
*        R1    = WAIT CHAIN ELEMENT ADDRESS MINUS (PCEPCEA-PCEDSECT)  * 70403000
*        R11   = HCT ADDRESS (BASE1)                                  * 70404000
*        R13   = PCE ADDRESS (SAVE)                                   * 70405000
*        R15   = NEW ENTRY ADDRESS                                    * 70406000
*                                                                     * 70407000
*********************************************************************** 70408000
         SPACE 1                                                     R4 70409000
$WAITR   NULL                      $WAIT SAVE=NO FOR A RESOURCE      R4 70410000
         ST    R15,PCER15          SAVE RE-ENTRY ADDRESS             R4 70411000
         SPACE 1                                                     R4 70412000
$WAITRQ  LM    R2,R3,PCEPCEA       POINT TO NEXT AND PREVIOUS PCES   R4 70413000
         ST    R2,PCEPCEA-PCEDSECT(,R3) REMOVE PCE                      70414000
         ST    R3,PCEPCEB-PCEDSECT(,R2) FROM QUEUE                      70415000
         L     R2,PCEPCEB-PCEDSECT(,R1) POINT TO LAST OF NEXT QUEUE     70416000
         ST    SAVE,PCEPCEA-PCEDSECT(,R2) PUT WAITER ON END             70417000
         ST    SAVE,PCEPCEB-PCEDSECT(,R1) POINT QUEUE END TO CURRENT    70418000
         ST    R2,PCEPCEB          POINT CURRENT PCE TO PREVIOUS        70419000
         ST    R1,PCEPCEA          POINT TO CURRENT QUEUE HEADER        70420000
         EJECT                                                          70421000
*********************************************************************** 70422000
*                                                                     * 70423000
*        DISPATCH READY PCES                                          * 70424000
*                                                                     * 70425000
*********************************************************************** 70426000
         SPACE 1                                                     R4 70427000
HASPDISP LA    R1,$READY-(PCEPCEA-PCEDSECT) POINT TO ACTIVE PCE ZERO R4 70428000
         L     SAVE,PCEPCEA-PCEDSECT(,R1) POINT TO FIRST READY PCE      70429000
         ST    SAVE,$CURPCE        SET CURRENT PCE POINTER              70430000
         CR    SAVE,R1             IS IT PCE ZERO                       70431000
         BE    HASPLOOK            LOOK FOR MORE WORK IF PCE ZERO       70432000
         LM    R14,R12,PCELINK     PICK UP REGISTERS                    70433000
         MVI   PCEEWF,$EWFPOST     SET NORMAL POST INHIBITOR            70434000
         BR    R15                 ENTER PROCESSOR                      70435000
         SPACE 2                                                     R4 70436000
*********************************************************************** 70437000
*                                                                     * 70438000
*        LOOK FOR MORE WORK                                           * 70439000
*                                                                     * 70440000
*********************************************************************** 70441000
         SPACE 1                                                     R4 70442000
         CNOP  2,8                                                   R4 70443000
HASPLOOK CLC   $HASPECF,=X'FFFF'   HAS ANY RESOURCE BEEN $POSTED...  R4 70444000
         BE    HASPSPEC            TEST $$POST IF NOT                   70445000
         SPACE 1                                                     R4 70446000
HASPOST  LA    R7,$EWQ1-(PCEPCEA-PCEDSECT) POINT TO FIRST PCE ZERO      70447000
         LA    R4,8                GET OFFSET                           70448000
         LA    R5,$EWQL-(PCEPCEA-PCEDSECT) POINT TO LAST PCE ZERO       70449000
         LH    R6,$HASPECF         PICK UP POST MASK                    70450000
         SLL   R6,31-($EWQL-$EWQ1)/8 ALIGN CORRESPONDING BITS           70451000
         SPACE 1                                                     R4 70452000
HASPOSTL ALR   R6,R6               SHIFT ONE AND CHECK OVERFLOW         70453000
         BC    2+1,HASPOSTC        DO NOT $POST IF CARRY                70454000
         LR    R1,R7               POINT TO RESOURCE PCE ZERO           70455000
         BAL   LINK,$POSTR         POST RESOURCE                        70456000
         SPACE 1                                                     R4 70457000
HASPOSTC BXLE  R7,R4,HASPOSTL      LOOP                                 70458000
         XC    $HASPECF,MHASPECF   CHECK IF MLLM IS WAITING FOR      R4 70459000
         NC    $HASPECF,MHASPECF    ANY OF NOW POSTED RESOURCES      R4 70460000
         BZ    HASPOSTR            DON'T POST IF NONE AWAITING       R4 70461000
         XC    MHASPECF,$HASPECF   RESET APPROPRIATE RESOURCE BITS   R4 70462000
         TM    MHASPECF+$EWBPOST,$EWFPOST TEST IF POST REQUIRED      R4 70463000
         BZ    HASPOSTR            BRANCH IF NO IMMEDIATE POST       R4 70464000
         L     R1,$MLLMPCE         GET MLLM PCE ADDRESS              R4 70465000
         BAL   LINK,HASPOSTW       POST THE LINE MANAGER             R4 70466000
         SPACE 1                                                     R4 70467000
HASPOSTR MVC   $HASPECF,=X'FFFF'   RESET POST FLAGS                  R4 70468000
         B     HASPDISP            DISPATCH ANY PCES                    70469000
         EJECT                                                          70470000
*********************************************************************** 70471000
*                                                                     * 70472000
*        HANDLE ANY $$POSTS                                           * 70473000
*                                                                     * 70474000
*********************************************************************** 70475000
         SPACE 1                                                     R4 70476000
         USING $SVDSECT,R10        PROVIDE SSVT ADDRESSABILITY       R4 70477000
         SPACE 1                                                     R4 70478000
         CNOP  2,8                                                   R4 70479000
HASPSPEC L     R10,$SSVT           GET ADDRESS OF SSVT               R4 70480000
         SPACE 1                                                     R4 70481000
HASPDL   L     R1,$HASPECB         RESET HASP                        R4 70482000
         MVI   0(R1),0              ECB                              R4 70483000
         TM    $SVPOSTW(R1),X'80'  IS ANY WORK REQUIRED...           R4 70484000
         BZ    HNOSPEC             BRANCH IF NOT.                       70485000
         MVI   $SVPOSTW(R1),0      ELSE CLEAR INDICATOR              R4 70486000
         L     R1,$SVECF           PICK UP ECF FIELD                    70487000
         SLR   R0,R0               SET MASK FOR CS INSTRUCTION          70488000
         CS    R1,R0,$SVECF        RESET POST FLAGS                     70489000
         BNE   *-4                 LOOP UNTIL RESET                     70490000
         LCR   R1,R1               GET TWOS COMPLIMENT                  70491000
         BCTR  R1,0                BACK TO ONES COMPLIMENT              70492000
         STH   R1,$HASPECF         SET MASTER EVENT CONTROL             70493000
         LA    R0,$SVPCENO         SET NO OF PCES TO POST      @OZ19496 70494000
         LA    R1,$SVCOMM          POINT TO FIRST ELEMENT      @OZ19496 70495000
         CLI   $ASYNCP,255         ASYNC PROCESSOR POSTED...   @OZ19496 70496000
         BNE   HPPCEL              BR IF NO                    @OZ19496 70497000
         SPACE 1                                               @OZ19496 70497100
HPPOST   L     R3,$SVASYNC         GET ASYNC POST ELEMENT      @OZ19496 70498000
         LA    R2,255              GET MASK FOR $$POST         @OZ19496 70499000
         SLL   R2,24               ALIGN MASK                  @OZ19496 70499100
         OR    R2,R3               SET REGISTER FOR SWAP       @OZ19496 70499200
         CS    R3,R2,$SVASYNC      CONVERT POST TO $$POST      @OZ19496 70499300
         BNE   HPPOST              LOOP UNTILL POSTED          @OZ19496 70499400
         MVI   $ASYNCP,0           RESET POST INDICATOR        @OZ19496 70499500
         SPACE 1                                                     R4 70500000
HPPCEL   CLI   0(R1),X'FF'         TEST FOR POST REQUIRED               70501000
         BNE   HPNPCE              SKIP THIS PCE IF NOT REQUIRED        70502000
         L     SAVE,0(0,R1)        PICK UP PCE ADDRESS                  70503000
         MVI   0(R1),X'80'         SET TO NOT POST UNTIL REQUIRED       70504000
         LA    SAVE,0(0,SAVE)      PURIFY ADDRESS                       70505000
         $POST (SAVE),WORK         POST PCE                             70506000
         SPACE 1                                                     R4 70507000
HPNPCE   LA    R1,4(0,R1)          UP TO NEXT ELEMENT                   70508000
         BCT   R0,HPPCEL           LOOP                                 70509000
         EJECT                                                       R4 70510000
HPIRDR   TM    $SVIRDR,X'80'       $SVIRDR --- IS ACTION REQD...        70511000
         BZ    HPNEXT              BRANCH IF NO ACTION.                 70512000
         MVI   $SVIRDR,0           CLEAR TS BYTE.                       70513000
         L     R1,$SVIRDRS         POINT TO FIRST INTRDR DCT.           70514000
         SPACE 1                                                     R4 70515000
         USING DCTDSECT,R1         USE THE DCT DSECT.                   70516000
         SPACE 1                                                     R4 70517000
HPIRDR1  LTR   R1,R1               ARE WE OUT OF DCTS...                70518000
         BZ    HPNEXT              BRANCH IF SO.                        70519000
         CLI   DCTDEVTP,DCTINR     ARE WE STILL IN INTRDRS...           70520000
         BNE   HPNEXT              BRANCH IF NOT.                       70521000
         TM    RIDFLAGS,RIDPOST    DOES PCE REQUIRE IO POST...          70522000
         BZ    HPIRDR2             BRANCH IF NOT.                       70523000
         NI    RIDFLAGS,255-RIDPOST  RESET THE POST SWITCH.             70524000
         L     SAVE,DCTPCE         YES.  POINT TO THE PCE.              70525000
         LA    SAVE,0(0,SAVE)      PURIFY ADDRESS                       70526000
         $POST (SAVE),IO           POST IT FOR I/O                      70527000
         SPACE 1                                                     R4 70528000
HPIRDR2  L     R1,DCTCHAIN         POINT TO THE NEXT DCT                70529000
         B     HPIRDR1             AND LOOP.                            70530000
         SPACE 1                                                     R4 70531000
         DROP  R1                  KILL DCT ADDRESSABILITY              70532000
         SPACE 1                                                     R4 70533000
HPNEXT   LA    R1,$EWQABIT-(PCEPCEA-PCEDSECT)  POINT TO WAIT A BIT   R4 70534000
         BAL   LINK,$POSTR         POST THE RESOURCE                    70535000
         B     HASPDISP            DISPATCH WHAT WE HAVE                70536000
         EJECT                                                       R4 70537000
*********************************************************************** 70538000
*                                                                     * 70539000
*        LOOK FOR ALL AVAILABLE FUNCTIONS COMPLETE AND WAIT           * 70540000
*                                                                     * 70541000
*********************************************************************** 70542000
         SPACE 1                                                     R4 70543000
HNOSPEC  CLI   $ACTIVE,0           TEST ACTIVE COUNT                 R4 70544000
         BNE   HASPACT             BRANCH IF FUNCTIONS ARE ACTIVE       70545000
         LH    R1,$EXCPCT          TEST OUTSTANDING I/O                 70546000
         A     R1,$BUSYQUE         TEST                                 70547000
         A     R1,$SVPIDLE         ADD $SVPIDLE COUNT                   70548000
         BNZ   HASPWAIT            BRANCH IF SYSTEM IS ACTIVE           70549000
         TM    $STATUS,$ALMSGSW    TEST SYSTEM STATUS                   70550000
         BO    HASPWAIT            BRANCH IF MESSAGE HAS BEEN ISSUED    70551000
        $WTO   HASPALL,L'HASPALL,JOB=NO,WAIT=NO,                     R4C70552000
               ROUTE=$ALL,CLASS=$ALWAYS,PRI=$HI    FUNCTIONS COMPLETE   70553000
         BZ    HASPWAIT            $WTO WAS UNSUCCESSFUL, WAIT          70554000
         OI    $STATUS,$ALMSGSW    SET MESSAGE ISSUED SWITCH            70555000
         B     HASPLOOK            LOOK FOR MORE WORK                   70556000
         SPACE 1                                                     R4 70557000
HASPALL  $MSG  099,'ALL AVAILABLE FUNCTIONS COMPLETE'                   70558000
         SPACE 1                                                     R4 70559000
HASPACT  NI    $STATUS,255-$ALMSGSW     RESET MESSAGE ISSUED SWITCH     70560000
         SPACE 1                                                     R4 70561000
HASPWAIT L     R1,$HASPECB         GET HASP ECB POINTER              R4 70562000
         WAIT  ECB=(1)             WAIT FOR SOMETHING TO DO          R4 70563000
         B     HASPDL              DISPATCH ELIGIBLE PROCESSORS         70564000
         SPACE 1                                                     R4 70565000
         DROP  R10                 DROP SSVT ADDRESSABILITY.            70566000
         EJECT                                                          70567000
*********************************************************************** 70568000
*                                                                     * 70569000
*        $POST - PUT A SINGLE PCE ON READY QUEUE                      * 70570000
*                                                                     * 70571000
*        R1    = PCE ADDRESS                                          * 70572000
*        R2    = WORK                                                 * 70573000
*        R3    = WORK                                                 * 70574000
*        R11   = HCT ADDRESS (BASE1)                                  * 70575000
*        R14   = RETURN ADDRESS                                       * 70576000
*                                                                     * 70577000
*********************************************************************** 70578000
         SPACE 1                                                     R4 70579000
HASPOSTW NI    PCEEWF-PCEDSECT(R1),255-$EWFWORK RESET WORK INHIBIT   R4 70580000
         BNZR  LINK                SKIP QUEUEING IF STILL INHIBITED  R4 70581000
         SPACE 1                                                     R4 70582000
$POST    MVI   PCEEWF+$EWBPOST-PCEDSECT(R1),$EWFPOST  SET INHIBIT    R4 70583000
         LM    R2,R3,PCEPCEA-PCEDSECT(R1) POINT TO NEXT AND PREVIOUS    70584000
         ST    R2,PCEPCEA-PCEDSECT(,R3) PULL PCE OFF NEXT CHAIN         70585000
         ST    R3,PCEPCEB-PCEDSECT(,R2) PULL PCE OFF PREVIOUS CHAIN     70586000
         LR    R3,R1               MAKE FIRST AND                       70587000
         LR    R2,R1               LAST POINT TO CURRENT                70588000
         SPACE 1                                                     R4 70589000
HASPREDY L     R1,$READY+(PCEPCEB-PCEPCEA) POINT TO LAST ACTIVE PCE     70590000
         MVC   PCEPCEA-PCEDSECT(,R3),PCEPCEA-PCEDSECT(R1) FIX NEXT      70591000
         ST    R3,$READY+(PCEPCEB-PCEPCEA) SET NEW LAST                 70592000
         ST    R1,PCEPCEB-PCEDSECT(,R2) POINT PREVIOUS TO OLD LAST      70593000
         ST    R2,PCEPCEA-PCEDSECT(,R1) SET NEXT IN OLD LAST            70594000
         BR    LINK                RETURN                               70595000
         SPACE 1                                                     R4 70596000
*********************************************************************** 70597000
*                                                                     * 70598000
*        $POSTR - PUT A GROUP OF PCES ON READY QUEUE                  * 70599000
*                                                                     * 70600000
*        R1    = RESOURCE HEADER ADDRESS MINUS (PCEPCEA-PCEDSECT)     * 70601000
*        R2    = WORK                                                 * 70602000
*        R3    = WORK                                                 * 70603000
*        R11   = HCT ADDRESS (BASE1)                                  * 70604000
*        R14   = RETURN ADDRESS                                       * 70605000
*                                                                     * 70606000
*********************************************************************** 70607000
         SPACE 1                                                     R4 70608000
         CNOP  0,8                                                   R4 70609000
$POSTR   LM    R2,R3,PCEPCEA-PCEDSECT(R1)  POINT TO 1ST AND LAST PCE R4 70610000
         CR    R2,R1               IS FIRST ALSO PCE ZERO               70611000
         BER   LINK                NOTHING TO POST, EXIT                70612000
         ST    R1,PCEPCEA-PCEDSECT(,R1) REMOVE PCES FROM QUEUE          70613000
         ST    R1,PCEPCEB-PCEDSECT(,R1) REMOVE LAST ALSO                70614000
         B     HASPREDY            PUT ON READY QUEUE                   70615000
         SPACE 3                                                        70616000
         TITLE 'HASP INPUT/OUTPUT SUPERVISOR'                           70617000
*********************************************************************** 70618000
*                                                                     * 70619000
*        $EXCP - EXECUTE CHANNEL PROGRAM SUBROUTINE                   * 70620000
*                                                                     * 70621000
*        R0    = WORK, UNPREDICTABLE ON EXIT                          * 70622000
*        R1    = DCT ADDRESS, UNPREDICTABLE ON EXIT IF WAIT=NO        * 70623000
*                             BUFFER ADDR   ON EXIT IF WAIT=YES       * 70624000
*        R11   = HCT ADDRESS (BASE1)                                  * 70625000
*        R13   = PCE ADDRESS (SAVE)                                   * 70626000
*        R14   = RETURN ADDRESS (HIGH ORDER BIT ON IF EXCPVR)         * 70627000
*        R15   = ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 70628000
*                                                                     * 70629000
*********************************************************************** 70630000
         SPACE 1                                                     R4 70631000
         ENTRY $EXCPR              PROVIDE $EXCP ROUTINE ENTRY       R4 70632000
         USING DCTDSECT,R1         PROVIDE DCT ADDRESSABILITY        R4 70633000
         USING BUFDSECT,WA         PROVIDE BUFFER ADDRESSABILITY     R4 70634000
         SPACE 1                                                     R4 70635000
$EXCPR   STM   WA,WB,ESAVE         SAVE WORK REGISTERS               R4 70636000
         L     WA,DCTBUFAD         FROM DCT POINT TO THE IOB/BUFFER.    70637000
         $TRACE                    WITH R1 AND WA LOADED, TRACE.        70638000
         MVI   IOBFLAG1,X'42'      SHOW CMD CHAINING, UNRELATED IN IOB. 70639000
         MVC   BUFEWF,DCTEWF       MOVE INFO FOR $ASYNC INTO THE IOB.   70640000
         STCM  R1,7,BUFDCT+1       MAKE THE IOB POINT TO THE DCT.       70641000
         IC    WB,DCTBUFCT         ADD 1 TO THE COUNT OF BUFFERS        70642000
         LA    WB,1(,WB)           PENDING COMPLETION UNDER THIS DCT.   70643000
         STC   WB,DCTBUFCT         (THE COUNT IS USED BY $ASYNC.)       70644000
         MVC   IOBDCBPT+1(3),DCTDCB+1  SET DCB ADDRESS IN IOB.          70645000
         CLI   DCTDEVTP,PCEDAWR    TEST FOR DIRECT ACCESS REQUEST       70646000
         BH    ESENDIT             BR IF NO                             70647000
         SPACE 1                                                     R4 70648000
*********************************************************************** 70649000
*                                                                     * 70650000
*           EXTRA PROCESSING FOR ALL DIRECT-ACCESS REQUESTS           * 70651000
*                                                                     * 70652000
*********************************************************************** 70653000
         SPACE 1                                                     R4 70654000
         MVI   IOBCCW4,5           SET CHANNEL COMMAND TO WRITE         70655000
         BE    *+8                 BR IF WRITE REQUEST                  70656000
         MVI   IOBCCW4,6           SET CHANNEL COMMAND TO READ          70657000
         MVC   IOBDCBPT+1(3),$HASPDCB+1  POINT TO HASP DA DCB           70658000
         CLC   PCESEEK(1),$NUMDA   TEST FOR VALID EXTENT             R4 70659000
         BNL   EXCPERR             BR IF NO TO CAUSE X'42' POST      R4 70660000
         L     WB,PCESEEK          PREPARE TO SET MBBCCHHR IN IOB       70661000
         LA    R0,0(,WB)           GET MTTR AND ISOLATE TTR IN R0.      70662000
         XR    WB,R0               THEN ISOLATE M IN WB.                70663000
         ST    WB,IOBXTENT         SET 'M000' IN THE IOB.               70664000
         STC   R0,IOBSEEK+6        MBB0000R                          R4 70665000
         SRL   WB,24               SHIFT 'M' (EXTENT NR) FOR MULTIPLY.  70666000
         MH    WB,=AL2(TEDSIZ)     COMPUTE ADDRESS OF EXTENT DATA       70667000
         A     WB,$TEDADDR         APPLICABLE TO THE I/O REQUEST.       70668000
         EJECT                                                       R4 70669000
         DROP  R1                  KILL DCT ADDRESSABILITY              70670000
         USING TEDDSECT,WB         PROVIDE TED ADDRESSABILITY        R4 70671000
         SPACE 1                                                     R4 70672000
         SRDL  R0,40               SHIFT 'TT' FOR DIVIDE.               70673000
         L     R15,TNTC            IF INVALID                        R4 70674000
         LTR   R15,R15              TED ENTRY,                       R4 70675000
         BZ    EXCPERR               BR TO CAUSE X'42' POST          R4 70676000
         DR    R0,R15              COMPUTE CYLINDER AND HEAD NUMBERS R4 70677000
         STCM  R1,3,IOBSEEK+2      MBBCC00R                          R4 70678000
         STCM  R0,3,IOBSEEK+4      MBBCCHHR                          R4 70679000
         TM    $RUNOPTS,$RPS       TEST RPS OPTION                   R4 70680000
         BZ    ESENDIT             BR IF NOT SELECTED                R4 70681000
         SPACE 1                                                     R4 70682000
*********************************************************************** 70683000
*                                                                     * 70684000
*           COMPUTE RPS SECTOR NUMBER IF APPLICABLE                   * 70685000
*                                                                     * 70686000
*********************************************************************** 70687000
         SPACE 1                                                     R4 70688000
         L     WB,TRPS             GET ADDRESS OF RPS TABLE.            70689000
         MVI   IOBCCW1,X'03'       SET FIRST CHANNEL COMMAND TO NOP.    70690000
         LTR   WB,WB               DOES EXTENT SUPPORT RPS...           70691000
         BZ    ESENDIT             IF NOT, SKIP RPS COMPUTATION.        70692000
         MVI   IOBCCW1,X'23'       SET CHANNEL COMMAND TO SET SECTOR.   70693000
         SR    R1,R1               ZERO R1 FOR INSERT-CHARACTER.        70694000
         IC    R1,IOBSEEK+6        GET RECORD NUMBER FROM IOB.          70695000
         IC    R1,0(R1,WB)         GET CORRESPONDING SECTOR NUMBER.     70696000
         STC   R1,IOBCCW1+5        SET SECTOR NUMBER IN SET-SECTOR.     70697000
         EJECT                                                       R4 70698000
*********************************************************************** 70699000
*                                                                     * 70700000
*        ISSUE EXCP/EXCPVR FOR ALL REQUESTS HERE                      * 70701000
*                                                                     * 70702000
*********************************************************************** 70703000
         SPACE 1                                                     R4 70704000
ESENDIT  MVI   BUFECBCC,0          SET COMPLETION CODE TO ZERO       R4 70705000
         LA    R1,IOBFLAG1         SET IOB ADDRESS AS ARGUMENT TO EXCP. 70706000
         LH    WB,$EXCPCT          ADD ONE                              70707000
         LA    WB,1(,WB)             TO THE                             70708000
         STH   WB,$EXCPCT              $EXCP COUNTER.                   70709000
         LM    WA,WB,ESAVE         RESTORE WORK REGISTERS            R4 70710000
         LTR   LINK,LINK           TEST REQUEST TYPE                 R4 70711000
         BM    ESENDVR             BR IF EXCPVR                      R4 70712000
         EXCP  (1)                 CALL THE OS I/O SUPERVISOR.          70713000
         B     EXCPXIT             THEN BR TO EXIT                   R4 70714000
         SPACE 1                                                     R4 70715000
ESENDVR  EXCPVR (1),SUBSYS         CALL THE OS I/O SUPERVISOR        R4 70716000
         SPACE 1                                                     R4 70717000
EXCPXIT  CLI   0(LINK),0           WAIT FOR I/O...                   R4 70718000
         BNER  LINK                RETURN IF NO                      R4 70719000
         L     R1,PCEBUFAD         GET BUFFER ADDRESS                R4 70720000
         SPACE 1                                                     R4 70721000
EXCPIO  $WAIT  IO                  WAIT FOR I/O TO COMPLETE          R4 70722000
         TM    BUFECBCC-BUFDSECT(R1),X'7F'  TEST COMPLETION CODE     R4 70723000
         BO    2(,LINK)            RETURN IF COMPLETE AND OK TO +2   R4 70724000
         BZ    EXCPIO              LOOP IF NOT COMPLETE              R4 70725000
         LA    LINK,2(,LINK)       ADVANCE RETURN ADDRESS            R4 70726000
         L     R15,$IOERROR        GET I/O ERROR ROUTINE ADDRESS     R4 70727000
         BR    R15                 BR TO ISSUE I/O ERROR MSG AND RETURN 70728000
         SPACE 1                                                     R4 70729000
EXCPERR  MVI   IOBSEEK,X'FF'       SET INVALID BB IN IOB             R4 70730000
         MVI   IOBXTENT,X'00'      INSURE EXTENT IS VALID      @OZ33184 70730500
         B     ESENDIT             BR TO CAUSE X'42' I/O ERROR POST  R4 70731000
         SPACE 1                                                     R4 70732000
         DROP  WA,WB               KILL CTL BLOCK ADDRESSABILITY        70733000
         SPACE 1                                                     R4 70734000
ESAVE    EQU   $CSAVREG            SAVE AREA FOR REGS WA,WB          R4 70735000
         TITLE 'HASP JOB QUEUE MANAGER'                                 70736000
*********************************************************************** 70737000
*                                                                     * 70738000
*        $QADD - ADD A JOB TO THE ACTIVE JOB QUEUE                    * 70739000
*                                                                     * 70740000
*        R0    = QUEUE ID, UNPREDICTABLE ON EXIT                      * 70741000
*        R1    = JOB QUEUE ELEMENT IMAGE ADDRESS, JQE ADDRESS ON EXIT * 70742000
*        R11   = HCT ADDRESS (BASE1)                                  * 70743000
*        R13   = PCE ADDRESS (SAVE)                                   * 70744000
*        R14   = RETURN ADDRESS                                       * 70745000
*        R15   = WORK, UNPREDICTABLE ON EXIT                          * 70746000
*                                                                     * 70747000
*********************************************************************** 70748000
         SPACE 1                                                        70749000
         USING JQEDSECT,R1         PROVIDE JQE ADDRESSABILITY           70750000
         SPACE 1                                                        70751000
$QADD   $QSUSE                     REQUEST ACCESS TO CHECKPOINT DATA    70752000
         STM   WA,WB,PCEWA         PRESERVE WORK REGISTERS              70753000
         LH    WB,$JQFREE          GET OFFSET                           70754000
         N     WB,=X'0000FFFF'      OF 1ST FREE JQE                     70755000
         BZ    QBACK2              BR IF NO FREE JQES                   70756000
         SLL   WB,2                 ELSE CONVERT OFFSET                 70757000
         AL    WB,$JOBQPTR           TO ABSOLUTE ADDRESS                70758000
         MVC   $JQFREE,QUECHAIN(WB)  REMOVE JQE FROM FREE CHAIN         70759000
         MVC   0(JQELNGTH,WB),JQE     AND INITIALIZE NEW QUEUE ENTRY    70760000
         SPACE 1                                                        70761000
QADD     LR    R1,WB               RELOAD JQE ADDRESS                   70762000
         STC   R0,JQETYPE          SET NEW QUEUE TYPE                   70763000
         TM    JQEFLAGS,QUEPURGE+QUEOPCAN  TEST FOR CANCEL              70764000
         BZ    QADDIT              BR IF NO                             70765000
         TM    JQEFLAGS,QUEPURGE   IF PURGE NOT REQUESTED,              70766000
         BZ    QOPCAN               BR TO TEST CURRENT QUEUE            70767000
         MVI   JQETYPE,$HARDCPY      ELSE QUEUE JOB FOR $HARDCPY        70768000
         LH    R15,JQEJOECT        TEST JOB FOR                         70769000
         AH    R15,JQEHLDCT         HELD OR JOT OUTPUT                  70770000
         BNZ   QADDIT              BR IF SO                             70771000
         MVI   JQETYPE,$PURGE       ELSE QUEUE JOB FOR $PURGE           70772000
         B     QADDIT              THEN BR TO QUEUE THE JOB             70773000
         EJECT                                                       R4 70774000
         CNOP  0,8                                                      70775000
QOPCAN   TM    JQETYPE,$XEQ        TEST FOR CNVT OR EXECUTE          R4 70783000
         BZ    QADDIT              BR IF NO                          R4 70784000
         MVI   JQETYPE,$OUTPUT      ELSE RE-QUEUE FOR $OUTPUT        R4 70785000
         SPACE 1                                                     R4 70787000
QADDIT   SLR   WA,WA               GET                                  70788000
         IC    WA,JQETYPE           INDEX                               70789000
         IC    WA,$QINDEX(WA)        TO NEW                             70790000
         LTR   WA,WA                  QUEUE                             70791000
         BZ    Q02                 BR IF NO SUCH QUEUE                  70792000
         LA    WA,$JQHEADS-2-QUECHAIN(WA)  ELSE PREPARE TO SCAN Q       70793000
         SPACE 1                                                        70794000
QNEXT1   LR    R15,WA              RELOAD CHAIN ADDRESS                 70795000
         LH    WA,QUECHAIN(,WA)    GET OFFSET                           70796000
         N     WA,=X'0000FFFF'      OF NEXT JQE                         70797000
         BZ    QINSERT             BR IF END OF QUEUE                   70798000
         SLL   WA,2                 ELSE CONVERT OFFSET                 70799000
         AL    WA,$JOBQPTR           TO ABSOLUTE ADDRESS                70800000
         CLC   JQEPRIO,QUEPRIO(WA) TEST CURRENT PRIORITY                70801000
         BNH   QNEXT1              BR IF NEW ELEMENT NOT HIGHER         70802000
         SL    WA,$JOBQPTR          ELSE REDUCE ADDRESS TO              70803000
         SRL   WA,2                  RELATIVE WORD OFFSET               70804000
         SPACE 1                                                        70805000
QINSERT  SL    R1,$JOBQPTR         REDUCE NEW ELEMENT ADDRESS TO        70806000
         SRL   R1,2                 RELATIVE WORD OFFSET                70807000
         STH   R1,QUECHAIN(,R15)   INSERT NEW QUEUE ELEMENT             70808000
         STH   WA,QUECHAIN(,WB)     INTO CURRENT JOB QUEUE              70809000
         LR    R1,R15              POINT TO MODIFIED JQE                70810000
         BAL   R15,QCKPT            AND FORCE CHECKPOINT OF JQE         70811000
         B     QPOST2              THEN BR TO $POST JOB                 70812000
         EJECT                                                          70813000
*********************************************************************** 70814000
*                                                                     * 70815000
*        $QGET - OBTAIN CONTROL OF A JQE FROM LOGICAL QUEUE           * 70816000
*                                                                     * 70817000
*        R0    = WORK, UNPREDICTABLE ON EXIT                          * 70819000
*        R1    = QUEUE TYPE, JQE ADDRESS (0 IF NONE) ON EXIT          * 70823000
*        R11   = HCT ADDRESS (BASE1)                                  * 70824000
*        R13   = PCE ADDRESS (SAVE)                                   * 70825000
*        R14   = RETURN ADDRESS                                       * 70826000
*        R15   = WORK, UNPREDICTABLE ON EXIT                          * 70827000
*                                                                     * 70828000
*********************************************************************** 70829000
         SPACE 1                                                        70830000
         CNOP  4,8                                                   R4 70831000
$QGET   $QSUSE                     REQUEST ACCESS TO CHECKPOINT DATA    70832000
         N     R1,=A(255)          MASK OFF HI-ORDER BYTES              70833000
         IC    R1,$QINDEX(R1)      GET JOB QUEUE HEADER OFFSET          70834000
         TM    $STATUS,$DRAINED    IF SYSTEM NOT DRAINING,              70835000
         BZ    *+6                  BR TO VALIDATE QUEUE TYPE           70836000
         SLR   R1,R1                 ELSE ENSURE INVALID TYPE           70837000
         LTR   R1,R1               IF INVALID QUEUE TYPE,               70838000
         BZR   LINK                 RETURN WITH CC = 0                  70839000
         LA    R1,$JQHEADS-2-QUECHAIN(R1)  SCAN REQUESTED JOB QUEUE     70840000
         SPACE 1                                                        70841000
QNEXT    LH    R1,JQECHAIN         GET OFFSET                           70842000
         N     R1,=X'0000FFFF'      OF NEXT JQE                         70843000
         BZR   LINK                RETURN IF END OF QUEUE WITH CC=0     70844000
         SLL   R1,2                 ELSE CONVERT OFFSET                 70845000
         AL    R1,$JOBQPTR           TO ABSOLUTE ADDRESS                70846000
         TM    JQEFLAGS,QUEHOLDA+QUEHOLD1+QUEHOLD2+QUEBUSY              70847000
         BNZ   QNEXT               BR IF JOB ACTIVE OR HELD             70848000
*              NOTE -- MASK ON NEXT INSTR SET AT END OF INITIALIZATION  70853000
$QGETAFF TM    JQEFLAG2,*-*        MAY JOB RUN ON THIS SYSTEM           70854000
         BZ    QNEXT               BR IF NO TO TEST NEXT JQE            70855000
         SPACE 1                                                     R4 70856000
QIND     TM    $STATUS,$INDMODE    CPU IN INDEPENDENT MODE...       R41 70857000
         BO    QCPUIND             BR IF YES                        R41 70858000
         TM    JQEFLAG2,QUEINDAF   JOB IN INDEPENDENT MODE...       R41 70859000
         BO    QNEXT               BR IF YES TO CHECK NEXT JQE      R41 70859100
         SPACE 1                                                    R41 70859200
QGETCONT DS    0H                                                   R41 70859300
         SPACE 1                                                     R4 70869000
QGOT     OC    JQEFLAGS,$SIDBUSY   MAKE JQE ACTIVE                   R4 70870000
         ST    R1,PCEJQE           SET JQE ADDRESS IN PCE      @OZ32566 70871000
         BAL   R15,QCKPT           FORCE CKPT OF JQE (SET CC)           70872000
         L     R1,PCEJQE           RESTORE JQE ADDRESS         @OZ32566 70873000
         BR    LINK                 AND RETURN                          70874000
         SPACE 1                                                    R41 70874100
QCPUIND  TM    JQEFLAG2,QUEINDAF   JOB IN INDEPENDENT MODE...       R41 70874200
         BZ    QNEXT               BR IF NO TO CHECK NEXT JQE       R41 70874300
         B     QGETCONT             ELSE CONTINUE QGET              R41 70874400
         EJECT                                                          70875000
*********************************************************************** 70876000
*                                                                     * 70877000
*        $QPUT - RELEASE CONTROL OF JQE TO LOGICAL QUEUE              * 70878000
*                                                                     * 70879000
*        R0    = QUEUE ID, UNPREDICTABLE ON EXIT                      * 70880000
*        R1    = JQE ADDRESS, UNPREDICTABLE ON EXIT                   * 70881000
*        R11   = HCT ADDRESS (BASE1)                                  * 70882000
*        R13   = PCE ADDRESS (SAVE)                                   * 70883000
*        R14   = RETURN ADDRESS                                       * 70884000
*        R15   = WORK, UNPREDICTABLE ON EXIT                          * 70885000
*                                                                     * 70886000
*********************************************************************** 70887000
         SPACE 1                                                        70888000
         CNOP  0,8                                                      70889000
$QPUT   $QSUSE                     REQUEST ACCESS TO CHECKPOINT DATA    70890000
         CLM   R0,1,JQETYPE        IF QUEUE TYPE HAS CHANGED,           70891000
         BNE   QMOD                 BR TO RE-QUEUE THE JOB              70892000
         TM    JQEFLAGS,QUEPURGE+QUEOPCAN  IF JOB BEING CANCELLED,      70893000
         BNZ   QMOD                         BR TO RE-QUEUE IT           70894000
SKIP20   STM   WA,WB,PCEWA         PRESERVE WORK REGISTERS              70901000
         NI    JQEFLAGS,255-QUEBUSY  RESET BUSY BITS                    70902000
         LR    WB,R1               RE-LOAD JQE ADDRESS                  70903000
         EJECT                                                          70904000
         USING JQEDSECT,WB         PROVIDE JQE ADDRESSABILITY           70905000
         SPACE 1                                                        70906000
QPOST2   TM    JQEFLAGS,QUEBUSY    IS JOB BEING PROCESSED               70907000
         BNZ   QPOST3              BR IF SO                             70908000
         CLI   JQETYPE,$XEQ        IS JOB QUEUED FOR CONVERSION...      70909000
         BE    QPOSTCNV            BR IF SO                             70910000
         TM    JQETYPE,$XEQ        IS JOB QUEUED FOR EXECUTION...       70911000
         BO    QPOSTXEQ            BR IF SO                             70912000
         CLI   JQETYPE,$OUTPUT     IS JOB QUEUED FOR OUTPUT...          70913000
         BE    QPOSTOUT            BR IF SO                             70914000
         CLI   JQETYPE,$PURGE      IS JOB QUEUED FOR PURGE...           70915000
         BE    QPOSTPRG            BR IF SO                             70916000
         SPACE 1                                                        70917000
QPOST2A $POST  $HASPECF,JOB        $POST ALL FOR JOB                 R4 70918000
         OI    $AQSE,QSEPJOB       INDICATE CROSS-SYSTEM $POST          70919000
         B     QPOST3              THEN BR TO $POST CKPT                70920000
         SPACE 1                                                        70921000
QPOSTCNV L     R1,$JCLPCE          GET CONVERSION PROCESSOR PCE ADDR R4 70922000
         OI    $AQSE,QSEPCNV       INDICATE CROSS-SYSTEM $POST          70923000
         B     Q$POST               AND BR TO $POST UNIQUE PROCESSOR    70924000
         SPACE 1                                                        70925000
QPOSTXEQ L     R1,$SSVT                   $$POST EXECUTION              70926000
         OI    $SVJOB-$SVDSECT(R1),X'80'   PROCESSOR                 R4 70927000
         L     R1,$EXECPCE         GET EXECUTION PROCESSOR PCE ADDR  R4 70928000
         OI    $AQSE,QSEPXEQ       INDICATE CROSS-SYSTEM $POST          70929000
         B     Q$POST               AND BR TO $POST UNIQUE PROCESSOR    70930000
         SPACE 1                                                        70931000
QPOSTOUT L     R1,$OUTPCE          GET OUTPUT PROCESSOR PCE ADDR     R4 70932000
         OI    $AQSE,QSEPOUT       INDICATE CROSS-SYSTEM $POST          70933000
         B     Q$POST               AND BR TO $POST UNIQUE PROCESSOR    70934000
         SPACE 1                                                        70935000
QPOSTPRG NI    JQEFLAGS,255-QUEHOLDA-QUEHOLD1-QUEHOLD2  RELEASE JOB  R4 70936000
         OI    JQEFLAG2,QUESYSAF   SET AFFINITY FOR ALL SYSTEMS     R41 70936500
         L     R1,$PRGPCE          GET PURGE PROCESSOR PCE ADDR      R4 70937000
         OI    $AQSE,QSEPPRG       INDICATE CROSS-SYSTEM $POST          70938000
         SPACE 1                                                        70939000
Q$POST  $POST  (R1),JOB            $POST UNIQUE PROCESSOR FOR JOB       70940000
         SPACE 1                                                        70941000
QPOST3  $POST  $HASPECF,CKPW       $POST CHECKPOINT WRITER           R4 70942000
         LR    R1,WB               POINT TO MODIFIED ELEMENT            70943000
         BAL   R15,QCKPT           CAUSE CHECKPOINT                     70944000
         SPACE 1                                                        70945000
QBACK2   LTR   R1,WB               R1 = QUEUE ENTRY (OR 0), SET CC      70946000
         LM    WA,WB,PCEWA         RESTORE REGISTERS                    70947000
         BR    LINK                RETURN                               70948000
         SPACE 1                                                        70949000
         DROP  WB                  KILL LOCAL JQE ADDRESSABILITY        70950000
         EJECT                                                          70951000
*********************************************************************** 70952000
*                                                                     * 70953000
*        $QREM - REMOVE A JOB FROM THE ACTIVE JOB QUEUE               * 70954000
*                                                                     * 70955000
*        R0    = UNPREDICTABLE ON EXIT                                * 70956000
*        R1    = JQE ADDRESS, UNPREDICTABLE ON EXIT                   * 70957000
*        R11   = HCT ADDRESS (BASE1)                                  * 70958000
*        R13   = PCE ADDRESS (SAVE)                                   * 70959000
*        R14   = RETURN ADDRESS                                       * 70960000
*        R15   = WORK, UNPREDICTABLE ON EXIT                          * 70961000
*                                                                     * 70962000
*********************************************************************** 70963000
         SPACE 1                                                        70964000
         CNOP  2,8                                                   R4 70965000
$QREM   $QSUSE                     REQUEST ACCESS TO CHECKPOINT DATA    70966000
         STM   WA,WB,PCEWA         PRESERVE WORK REGISTERS              70967000
         BAL   R15,QREM            REMOVE JQE FROM CURRENT QUEUE        70968000
         LA    WA,$JQFREE-QUECHAIN PREPARE TO SCAN FREE QUEUE           70969000
         SPACE 1                                                        70970000
QNEXT3   LR    R1,WA               RELOAD CHAIN ADDRESS                 70971000
         LH    WA,JQECHAIN         GET OFFSET                           70972000
         N     WA,=X'0000FFFF'      OF NEXT JQE                         70973000
         BZ    QREMQIT             BR IF END OF QUEUE                   70974000
         SLL   WA,2                 ELSE CONVERT OFFSET                 70975000
         AL    WA,$JOBQPTR           TO ABSOLUTE ADDRESS                70976000
         CLR   WB,WA               TEST CURRENT ADDRESS                 70977000
         BH    QNEXT3              BR IF FREE ELEMENT STILL HIGHER      70978000
         SPACE 1                                                        70979000
QREMQIT  LH    R0,$JQFREE          SAVE OFFSET OF 1ST FREE JQE          70980000
         LR    R15,WB              INSERT NEW                           70981000
         SL    R15,$JOBQPTR         FREE ELEMENT                        70982000
         SRL   R15,2                 INTO                               70983000
         STH   R15,JQECHAIN           FREE CHAIN                        70984000
         LTR   WA,WA               IF NEW ELEMENT AT END OF CHAIN,      70985000
         BZ    *+12                 BR AROUND NEXT 2 INSTRUCTIONS       70986000
         SL    WA,$JOBQPTR           ELSE RECONNECT                     70987000
         SRL   WA,2                   REMAINING                         70988000
         STH   WA,QUECHAIN(,WB)        FREE ELEMENTS                    70989000
         LTR   R0,R0               IF FREE QUEUE HAD BEEN EMPTY,        70990000
         BZ    QPOST2A              BR TO $POST JOB                     70991000
         BAL   R15,QCKPT             ELSE FORCE CKPT OF MODIFIED JQE    70992000
         B     QPOST3                 AND BR TO $POST CKPT              70993000
         EJECT                                                          70994000
         CNOP  2,8                                                      70995000
QREM     SLR   WA,WA               GET                                  70996000
         IC    WA,JQETYPE           INDEX                               70997000
         IC    WA,$QINDEX(WA)        TO CURRENT                         70998000
         LTR   WA,WA                  JOB QUEUE                         70999000
         BZ    Q02                 BR IF NO SUCH QUEUE                  71000000
         LA    WA,$JQHEADS-2-QUECHAIN(WA)  ELSE PREPARE TO SCAN Q       71001000
         LR    WB,R1               SAVE JQE ADDRESS                     71002000
         SPACE 1                                                        71003000
QNEXT3A  LR    R1,WA               RELOAD CHAIN ADDRESS                 71004000
         LH    WA,JQECHAIN         GET OFFSET                           71005000
         N     WA,=X'0000FFFF'      OF NEXT JQE                         71006000
         BZ    Q01                 BR IF JOB NOT ON QUEUE               71007000
         SLL   WA,2                 ELSE CONVERT OFFSET                 71008000
         AL    WA,$JOBQPTR           TO ABSOLUTE ADDRESS                71009000
         CLR   WA,WB               IF NOT THE CURRENT JQE,              71010000
         BNE   QNEXT3A              BR TO TEST NEXT JQE                 71011000
         SPACE 1                                                        71012000
         MVC   JQECHAIN,QUECHAIN(WB)  DECHAIN CURRENT JQE               71013000
         B     QCKPT                   AND BR TO CKPT MODIFIED JQE      71014000
         SPACE 1                                                        71015000
Q01     $ERROR                     JOB QUEUE ERROR                      71016000
         SPACE 1                                                        71017000
Q02     $ERROR                     ILLEGAL JOB QUEUE TYPE               71018000
         EJECT                                                          71019000
         SPACE 3                                                        71020000
*********************************************************************** 71021000
*                                                                     * 71022000
*        $QLOC - LOCATE A JQE BY JOB NUMBER                           * 71023000
*                                                                     * 71024000
*        R0    = WORK, UNPREDICTABLE ON EXIT                          * 71025000
*        R1    = JOB NUMBER, JQE ADDRESS (0 IF NONE) ON EXIT          * 71026000
*        R11   = HCT ADDRESS (BASE1)                                  * 71027000
*        R14   = RETURN ADDRESS                                       * 71028000
*        R15   = UNPREDICTABLE ON EXIT                                * 71029000
*                                                                     * 71030000
*********************************************************************** 71031000
         SPACE 1                                                        71032000
         CNOP  4,8                                                   R4 71033000
$QLOC   $QSUSE                     REQUEST ACCESS TO CHECKPOINT DATA    71034000
         LR    R0,R1               SAVE JOB NUMBER                      71035000
         LA    R15,$JQTYPES*2      INITIALIZE QUEUE HEADER OFFSET       71036000
         SPACE 1                                                        71037000
QLOC     LA    R1,$JQHEADS-2-QUECHAIN(R15)  PREPARE TO SCAN QUEUE       71038000
         SPACE 1                                                        71039000
QNEXT4   LH    R1,JQECHAIN         GET OFFSET                           71040000
         N     R1,=X'0000FFFF'     OF NEXT JQE                          71041000
         BZ    QLOOP               BR IF END OF QUEUE                   71042000
         SLL   R1,2                 ELSE CONVERT OFFSET                 71043000
         AL    R1,$JOBQPTR           TO ABSOLUTE ADDRESS                71044000
         CH    R0,JQEJOBNO         IF NOT THE CURRENT JQE               71045000
         BNE   QNEXT4               BR TO TEST NEXT JQE                 71046000
         LTR   R1,R1                 ELSE SET CC                        71047000
         BR    LINK                   AND RETURN                        71048000
         SPACE 1                                                        71049000
         CNOP  0,8                                                      71050000
QLOOP    BCTR  R15,0               IF ANOTHER JOB QUEUE,                71051000
         BCT   R15,QLOC             BR TO SCAN IT                       71052000
         BR    LINK                  ELSE RETURN WITH CC = 0            71053000
         SPACE 1                                                        71054000
         EJECT                                                          71055000
*********************************************************************** 71056000
*                                                                     * 71057000
*        $QCKPT - SCHEDULE CHECKPOINT FOR ALTERED JQE                 * 71058000
*                                                                     * 71059000
*        R0    = WORK, UNPREDICTABLE ON EXIT                          * 71060000
*        R1    = JQE ADDRESS                                          * 71061000
*        R11   = HCT ADDRESS (BASE1)                                  * 71062000
*        R13   = PCE ADDRESS (SAVE)                                   * 71063000
*        R15   = RETURN ADDRESS                                       * 71064000
*                                                                     * 71065000
*********************************************************************** 71066000
         SPACE 1                                                        71067000
$QCKPT   STM   WA,WB,PCEWA         PRESERVE REGISTERS                   71068000
         LR    WB,R1               POINT TO MODIFIED ELEMENT            71069000
         B     QPOST3              CAUSE CHECKPOINT                     71070000
         SPACE 1                                                        71071000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71072000
QCKPT    S     R1,$JOBQPTR         MAKE POINTER RELATIVE       @OZ20010 71073000
         BMR   R15                 RETURN IF BELOW JOB QUEUE            71074000
         C     R1,$JOBQSIZ         CHECK FOR WITHIN JOB QUEUE        R4 71075000
         BHR   R15                 RETURN IF ABOVE QUEUE                71076000
         LR    R0,R1               REMEMBER JQE OFFSET         @OZ20010 71076100
         SRL   R1,12               DIVIDE BY LENGTH OF A PAGE  @OZ20010 71077000
         AL    R1,$JOBCTLB         POINT TO CHECKPOINT CONTROL       R4 71078000
         MVC   0(1,R1),$SIDAFF     TURN ON CKPT INDICATOR      @OZ20010 71079000
         LR    R1,R0               RELOAD JQE OFFSET           @OZ20010 71079100
         LA    R1,JQELNGTH-1(,R1)  LOCATE END OF JQE           @OZ20010 71079200
         SRL   R1,12               DIVIDE BY PAGE LENGTH       @OZ20010 71079300
         AL    R1,$JOBCTLB         POINT TO CHECKPOINT CONTROL @OZ20010 71079400
         MVC   0(1,R1),$SIDAFF     TURN ON CHKPT INDICATOR     @OZ20010 71079500
         BR    R15                 RETURN                               71080000
         EJECT                                                          71081000
*********************************************************************** 71082000
*                                                                     * 71083000
*        $QMOD - MODIFY JOB QUEUE CHAIN FIELD FOR ALTERED JQE         * 71084000
*                                                                     * 71085000
* REGISTERS                                                           * 71086000
*                                                                     * 71087000
*        R0    = QUEUE TYPE, UNPREDICTABLE ON EXIT                    * 71088000
*        R1    = JQE ADDRESS                                          * 71089000
*        R11   = HCT ADDRESS (BASE1)                                  * 71090000
*        R13   = PCE ADDRESS (SAVE)                                   * 71091000
*        R14   = RETURN ADDRESS                                       * 71092000
*        R15   = WORK, UNPREDICTABLE ON EXIT                          * 71093000
*                                                                     * 71094000
* NOTES                                                               * 71095000
*                                                                     * 71096000
*        CHECKPOINT MUST NOT BE ACTIVE ON ENTRY                       * 71097000
*        THIS ROUTINE IS USED TO ALTER QUEUE TYPE AND PRIORITY        * 71098000
*        IF ONLY QUEUE TYPE IS TO BE ALTERED $QPUT SHOULD BE USED     * 71099000
*                                                                     * 71100000
*********************************************************************** 71101000
         SPACE 1                                                        71102000
         CNOP  0,8                                                      71103000
$QMOD    LA    R1,0(,R1)           CLEAR HI-ORDER BYTE                  71104000
        $QSUSE TYPE=TEST           MAY QUEUES BE USED...             R4 71105000
         BNZ   Q01                 BR IF NO (LOGIC ERROR)               71106000
         SPACE 1                                                        71107000
QMOD     ST    R0,PCER0            STORE QUEUE TYPE                  R4 71108000
         SPACE 1                                                     R4 71119000
QMODA    STM   WA,WB,PCEWA         PRESERVE WORK REGISTERS           R4 71120000
         NI    JQEFLAGS,255-QUEBUSY  RESET BUSY BITS                    71121000
         BAL   R15,QREM            REMOVE JQE FROM CURRENT QUEUE        71122000
         L     R0,PCER0            RESTORE NEW QUEUE TYPE               71123000
         B     QADD                 AND BR TO ADD JQE TO NEW QUEUE      71124000
         SPACE 1                                                        71125000
         DROP  R1                  KILL JQE ADDRESSABILITY              71126000
         EJECT                                                          71127000
*********************************************************************** 71128000
*                                                                     * 71129000
*        $QSUSE - REQUEST ACCESS TO SHARED QUEUES                     * 71130000
*                                                                     * 71131000
*        R15   = RETURN ADDRESS                                       * 71132000
*        ALL OTHER REGISTERS ARE PRESERVED                            * 71133000
*                                                                     * 71134000
*        EXITS BY BRANCHING INTO THE $WAIT ROUTINE                    * 71135000
*                                                                     * 71136000
*********************************************************************** 71137000
         SPACE 1                                                     R4 71138000
         CNOP  0,8                                                      71139000
$QSUSES  DS    0H                  $QSUSE SAVE=YES ENTRY             R4 71140000
         STM   LINK,BASE2,PCELINK  SAVE REGISTERS                    R4 71141000
         SPACE 1                                                     R4 71142000
$QSUSE   DS    0H                  $QSUSE SAVE=NO ENTRY              R4 71143000
         TM    $STATUS,$CKPTACT    IS CHECKPOINT ACTIVE                 71144000
         BO    QSU1                BRANCH IF YES                        71145000
         $POST $HASPECF,CKPW       ACTIVATE CHECKPOINT PROCESSOR        71146000
         SPACE 1                                                     R4 71147000
QSU1     MVI   PCEEWF,$EWFPOST     INHIBIT SPECIFIC $POSTS              71148000
         LA    R1,$EWQCKPT-(PCEPCEA-PCEDSECT)  POINT TO PCE ZERO        71149000
         B     $WAITR              $WAIT FOR CKPT RESOURCE           R4 71150000
         TITLE 'HASP UNIT ALLOCATOR / DE-ALLOCATOR'                     71151000
*********************************************************************** 71152000
*                                                                     * 71153000
*        $GETUNIT - OBTAIN CONTROL OF A HASP DEVICE                   * 71154000
*                                                                     * 71155000
*        R0    = RESERVED, UNPREDICTABLE ON EXIT                      * 71156000
*        R1    = DCT ADDRESS                                          * 71157000
*        R11   = HCT ADDRESS (BASE1)                                  * 71158000
*        R13   = PCE ADDRESS (SAVE)                                   * 71159000
*        R14   = RETURN ADDRESS                                       * 71160000
*        R15   = RESERVED, UNPREDICTABLE ON EXIT                      * 71161000
*                                                                     * 71162000
*********************************************************************** 71163000
         SPACE 1                                                     R4 71164000
         USING DCTDSECT,R1         PROVIDE DCT ADDRESSABILITY        R4 71165000
         SPACE 1                                                     R4 71166000
         CNOP  0,8                                                      71167000
$GETUNIT DS    0H                                                       71168000
         TM    DCTSTAT,DCTINUSE+DCTDRAIN+DCTHOLD+DCTPAUSE  TEST DCT  R4 71169000
         BZ    UNIAVAIL            BRANCH IF AVAILABLE               R4 71170000
         SR    R0,R0               SET UNSUCCESSFUL CONDITION CODE   R4 71171000
         BR    LINK                 AND RETURN                       R4 71172000
         SPACE 3                                                     R4 71173000
UNIAVAIL OI    DCTSTAT,DCTINUSE    INDICATE DEVICE IS IN USE         R4 71174000
         LA    R1,0(,R1)           PURIFY DCT ADDRESS                R4 71175000
         BR    LINK                RETURN TO CALLER                  R4 71176000
         EJECT                                                          71177000
*********************************************************************** 71178000
*                                                                     * 71179000
*        $FREUNIT - RELEASE CONTROL OF A HASP DEVICE                  * 71180000
*                                                                     * 71181000
*        R0    = WORK, UNPREDICTABLE ON EXIT                          * 71182000
*        R1    = DCT ADDRESS                                          * 71183000
*        R11   = HCT ADDRESS (BASE1)                                  * 71184000
*        R13   = PCE ADDRESS (SAVE)                                   * 71185000
*        R14   = RETURN ADDRESS                                       * 71186000
*        R15   = WORK, UNPREDICTABLE ON EXIT                          * 71187000
*                                                                     * 71188000
*********************************************************************** 71189000
         SPACE 1                                                     R4 71190000
         CNOP  0,8                                                      71191000
UNIFREE  $WAIT BUF                 WAIT FOR BUFFERS TO BE RELEASED      71192000
         SPACE 1                                                     R4 71193000
$FREUNIT CLI   DCTBUFCT,0          CHECK BUFFERS ASSOCIATED WITH DCT R4 71194000
         BNE   UNIFREE             BRANCH IF NOT ZERO                   71195000
         NI    DCTSTAT,255-DCTINUSE TURN OFF USE BIT                    71196000
         TM    DCTDEVTP,DCTRJE     TEST DEVICE TYPE                  R4 71198000
         BZ    UNINORJE            BRANCH IF NOT RJE                R41 71199000
         TM    MDCTTYPE,DCTPSNA    TEST DEVICE TYPE                 R41 71203100
         BZ    UNINORDV            BR IF NOT SNA               @OZ20025 71203200
         L     R15,MDCTICE         PICK UP POTENTIAL ICE ADDRESS    R41 71203300
         LTR   R15,R15             TEST FOR ICE ADDRESS (PRE-ALLOC) R41 71203400
         BZ    UNINOICP            BRANCH IF NO ICE PRESENT         R41 71203500
         SLR   R0,R0               CLEAR REGISTER                   R41 71203600
         CL    R1,ICERDCT-ICEDSECT(,R15) IS ICE PREALLOCATED        R41 71203700
         BNE   UNINOICA            NO, BRANCH TO CLEAR DCT PTR      R41 71203800
         ST    R0,ICERDCT-ICEDSECT(,R15) CLEAR ICE POINTER TO DCT   R41 71203900
         SPACE 1                                                    R41 71204000
UNINOICA ST    R0,MDCTICE          CLEAR DCT POINTER TO ICE         R41 71204100
         SPACE 1                                                    R41 71204200
UNINOICP TM    DCTDEVTP,DCTDEV     TEST FOR RMT DEVICE              R41 71204300
         BZ    UNINORDV            NO, SKIP DEVICE RESETS           R41 71204400
         NI    MDCTSTAT,255-DCTADS RESET DEVICE RELATED FLAGS       R41 71204500
         SPACE 1                                                    R41 71204600
UNINORDV NI    MDCTSTAT,255-DCTEOF-DCTPOST-DCTABORT-DCTETX RESET    R41 71204700
         SPACE 1                                                    R41 71204800
UNINORJE TM    DCTSTAT,DCTDRAIN    TEST FOR $P COMMAND              R41 71205000
         BZR   LINK                RETURN IF UNIT NOT DRAINED           71206000
         ST    LINK,PCESAVEA       SAVE LINK REGISTER                   71207000
        $ALLOC (R1)                UNALLOCATE THE DEVICE             R4 71208000
         ST    R1,PCER1            SAVE DCT ADDRESS                  R4 71209000
         EJECT                                                      R41 71210000
UNIWTO   MVC   UDRMSG(8),DCTDEVN   SET UP MESSAGE                    R4 71211000
        $WTO   UDRMSN,L'UDRMSN,WAIT=NO,JOB=NO,  ISSUE DRAIN MSG      R4C71212000
               ROUTE=$LOG+$UR+$TP,CLASS=$TRIVIA,PRI=$ST              R4 71213000
         L     R1,PCER1            RESTORE DCT ADDRESS               R4 71214000
         BZ    UNIWAIT             BR IF $WTO UNSUCCESSFUL           R4 71215000
         L     LINK,PCESAVEA        ELSE RESTORE RETURN ADDRESS      R4 71216000
         BR    LINK                  AND RETURN                      R4 71217000
         SPACE 1                                                     R4 71218000
UNIWAIT $WAIT  CMB                 WAIT FOR MESSAGE BUFFER           R4 71219000
         B     UNIWTO              TRY AGAIN TO ISSUE MESSAGE        R4 71220000
         SPACE 1                                                     R4 71221000
         DROP  R1                  KILL DCT ADDRESSABILITY              71222000
         SPACE 1                                                        71223000
UDRMSN   $MSG  097,'******** IS DRAINED',SYMB=UDRMSG                    71224000
                                   PRINT OFF - SECTION DELETED @OZ20010 71225000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71226000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71227000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71228000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71229000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71230000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71231000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71232000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71233000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71234000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71235000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71236000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71237000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71238000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71239000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240100
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240200
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240300
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240400
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240500
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240600
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240700
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240800
*                                  THIS CARD DELETED BY APAR   @OZ20010 71240900
*                                  THIS CARD DELETED BY APAR   @OZ20010 71241000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71241100
*                                  THIS CARD DELETED BY APAR   @OZ20010 71241200
*                                  THIS CARD DELETED BY APAR   @OZ20010 71242000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71243000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71244000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71245000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71246000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71247000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71248000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71249000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71250000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71251000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71252000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71253000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71254000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71255000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71256000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71257000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71258000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71259000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71260000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71261000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71262000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71263000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71264000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71265000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71266000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71267000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71268000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71269000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71270000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71271000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71272000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71273000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71274000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71275000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71276000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71277000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71278000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71279000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71280000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71281000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71282000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71283000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71284000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71285000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71286000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71287000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71288000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71289000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71290000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71291000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71292000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71293000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71294000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71295000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71296000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71297000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71298000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71299000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71300000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71301000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71302000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71303000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71304000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71305000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71306000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71307000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71308000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71309000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71310000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71311000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71312000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71313000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71314000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71315000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71316000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71317000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71318000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71319000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71320000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71321000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71322000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71323000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71324000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71325000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71326000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71327000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71328000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71329000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71330000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71331000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71332000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71333000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71334000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71335000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71336000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71337000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71338000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71339000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71340000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71341000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71342000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71343000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71344000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71345000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71346000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71347000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71348000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71349000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71350000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71351000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71352000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71353000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71354000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71355000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71356000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71357000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71358000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71359000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71360000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71361000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71362000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71363000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71364000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71365000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71366000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71367000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71368000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71369000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71370000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71371000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71372000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71373000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71374000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71375000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71376000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71377000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71378000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71379000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71380000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71381000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71382000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71383000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71384000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71385000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71386000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71387000
*                                  THIS CARD DELETED BY APAR   @OZ20010 71388000
                                   PRINT ON -- SECTION DELETED @OZ20010 71389000
                                   PRINT ON -- SECTION DELETED @OZ20010 71390000
         TITLE 'HASP REMOVE SMF BUFFER FROM QUEUE ROUTINE'              71391000
*********************************************************************** 71392000
*                                                                     * 71393000
* FUNCTION/OPERATION-                                                 * 71394000
*                                                                     * 71395000
*      THE FOLLOWING SUBROUTINE TAKES A HASP SMF BUFFER FROM          * 71396000
*      $SMFFREE FREE BUFFER POOL AND RETURNS. IF THERE ARE            * 71397000
*      NO BUFFERS AVAILABLE THE PROCESSOR IS $WAITED FOR SMF,         * 71398000
*      WHICH IS EQUATED TO CMB, UNTIL A BUFFER IS AVAILABLE,          * 71399000
*      UNLESS THE CALLING ROUTINE REQUESTS IMMEDIATE RETURN.          * 71400000
*      GOTTEN BUFFER IS CLEARED TO ZERO PRIOR TO RETURN.              * 71401000
*                                                                     * 71402000
* INPUT -                                                             * 71403000
*                                                                     * 71404000
*      R14 - RETURN ADDRESS OF CALLING ROUTINE                        * 71405000
*      R1  - ZERO     = DO NOT WAIT IF NO BUFFERS AVAILABLE           * 71406000
*            NON-ZERO = $WAIT SMF IF NO BUFFERS AVAILABLE             * 71407000
*                                                                     * 71408000
* OUTPUT -                                                            * 71409000
*      R1  - ZERO = NO BUFFER AVAILABLE                               * 71410000
*            NON-ZERO = BUFFER ADDRESS                                * 71411000
*      CC  - SET BY LTR R1,R1 PRIOR TO RETURN                         * 71412000
*                                                                     * 71413000
*********************************************************************** 71414000
         SPACE 1                                                        71415000
         CNOP  0,8                                                      71416000
SWAITBF $WAIT  SMF                                                      71417000
         SPACE 1                                                        71418000
$GETSMFB OC    $SMFFREE,$SMFFREE   TEST FOR AVAILABLE BUFFER            71419000
         BNZ   SGETBUF             CONTINUE IF YES                      71420000
         LTR   R1,R1               TEST FOR WAIT FOR BUFFER             71421000
         BNZ   SWAITBF             BR IF YES                            71422000
         BR    LINK                 ELSE RETURN TO CALLER               71423000
         SPACE 1                                                        71424000
         CNOP  0,8                                                      71425000
SGETBUF  L     R1,$SMFFREE         CHAIN STARTER                        71426000
         STM   WA,WB,$POSTSAV      SAVE WORK REGISTERS               R4 71427000
         SPACE 1                                                        71428000
SRECYCLE L     R15,0(,R1)          NEXT CHAIN POINTER                   71429000
         CS    R1,R15,$SMFFREE     UPDATE CHAIN                         71430000
         BNE   SRECYCLE            TRY AGAIN IF NOT SUCCESSFUL          71431000
         LA    WB,SMFLNG           CLEAR                             R4 71432000
         LR    WA,R1                ENTIRE                           R4 71433000
         SLR   R15,R15               SMF                             R4 71434000
         MVCL  WA,R14                 BUFFER                         R4 71435000
         LM    WA,WB,$POSTSAV      RESTORE WORK REGISTERS            R4 71436000
         LTR   R1,R1               SET CONDITION CODE                   71437000
         BR    LINK                RETURN                               71438000
         TITLE 'HASP PUT SMF BUFFER ON BUSY QUEUE ROUTINE'              71439000
*********************************************************************** 71440000
*                                                                     * 71441000
* FUNCTION/OPERATION -                                                * 71442000
*                                                                     * 71443000
*      THE FOLLOWING SUBROUTINE PLACES A SMF BUFFER AT BEGINNING      * 71444000
*      OF THE $SMFBUSY CHAIN AND ISSUES AN OS POST FOR HASPACCT       * 71445000
*      SUBTASK TO PROCESS SMF RECORD.                                 * 71446000
*                                                                     * 71447000
* INPUT  R1    = HASP SMF BUFFER ADDRESS                              * 71448000
*        R14   = RETURN ADDRESS                                       * 71449000
*                                                                     * 71450000
* OUTPUT       = NONE                                                 * 71451000
*                                                                     * 71452000
*********************************************************************** 71453000
         SPACE 1                                                        71454000
         CNOP  0,8                                                      71455000
$QUESMFB L     R15,$SMFBUSY        GRAB HEAD CHAIN POINTER              71456000
         SPACE 1                                                        71457000
SUPDTPTR ST    R15,0(,R1)          COMPLETE NEW CHAIN                   71458000
         CS    R15,R1,$SMFBUSY     RESTORE HEAD CHAIN PTR. WITH         71459000
         BNE   SUPDTPTR               NEW ADDRESS                       71460000
         LA    R1,$ACCTECB         POST HASPACCT SUBTASK FOR WORK       71461000
         POST  (1)                      FOR WORK                        71462000
         BR    LINK                RETURN                               71463000
         TITLE 'HASP DIRECT ACCESS PURGE ROUTINE'                       71464000
*********************************************************************** 71465000
*                                                                     * 71466000
*        $PURGER - RELEASE SPOOL SPACE TO THE MASTER TRACK GROUP MAP  * 71467000
*                                                                     * 71468000
*        R0    = RESERVED, UNPREDICTABLE ON EXIT                      * 71469000
*        R1    = USER TRACK GROUP MAP TGMDSECT                        * 71470000
*        R11   = HCT ADDRESS (BASE1)                                  * 71471000
*        R13   = PCE ADDRESS (SAVE)                                   * 71472000
*        R14   = RETURN ADDRESS                                       * 71473000
*        R15   = RESERVED, UNPREDICTABLE ON EXIT                      * 71474000
*                                                                     * 71475000
*********************************************************************** 71476000
         SPACE 1                                                     R4 71477000
         CNOP  0,8                                                   R4 71478000
$PURGER $TRACE                     TRACE THIS ACTIVITY               R4 71479000
        $QSUSE                     REQUEST ACCESS TO CHECKPOINT DATA R4 71480000
         STM   LINK,R1,PCELINK     SAVE REGISTERS                    R4 71481000
         LA    R15,TGMAP-TGMDSECT(,R1)  POINT TO USER MAP            R4 71482000
         L     R0,$CYLMAPL         GET LENGTH OF TRACK GROUP MAP     R4 71483000
         L     R1,$TGMAP           FREE USER'S TRACKS FROM           R4 71484000
        $VFL   OC,(R1),(R15),(R0)   MASTER TRACK GROUP MAP           R4 71485000
         L     R1,PCER1              RESTORE POINTER                 R4 71486000
         LA    R0,TGMAP-TGMDSECT(,R1) TO USER MAP                    R4 71487000
         L     R1,$CYLMAPL         CLEAR USER                        R4 71488000
         SLR   R15,R15              TRACK GROUP MAP                  R4 71489000
         MVCL  R0,R14                TO ZEROES                       R4 71490000
        $POST  $HASPECF,CKPW       REQUEST CHECKPOINT                R4 71491000
         LM    LINK,R1,PCELINK     RESTORE REGISTERS                 R4 71492000
         BR    LINK                 AND RETURN                       R4 71493000
         TITLE 'HASP CONTROL SERVICE PROGRAM LITERAL POOL'           R4 71494000
         SPACE 5                                                     R4 71495000
*********************************************************************** 71496000
*                                                                     * 71497000
*        HASP CONTROL SERVICE PROGRAM LITERAL POOL                    * 71498000
*                                                                     * 71499000
*********************************************************************** 71500000
         SPACE 5                                                     R4 71501000
         LTORG                                                       R4 71502000
         TITLE 'HASP BASE1-ADDRESSABLE PATCH SPACE'                  R4 71503000
*********************************************************************** 71504000
*                                                                     * 71505000
*        HASP BASE1 (HCT) ADDRESSABLE PATCH SPACE                     * 71506000
*                                                                     * 71507000
*********************************************************************** 71508000
         SPACE 1                                                     R4 71509000
         USING HASP+4096,R1        PROVIDE DUMMY ADDRESSABILITY      R4 71510000
         SPACE 1                                                     R4 71511000
$PATCHSP $PATCHSP 300              GENERATE PATCH SPACE              R4 71512000
         SPACE 1                                                     R4 71513000
         DROP  R1                  KILL DUMMY ADDRESSABILITY         R4 71514000
         SPACE 1                                                     R4 71515000
         ORG   HASP+4094           OVERLAY NON-ADDRESSABLE SPACE     R4 71516000
         TITLE 'HASP JOB QUEUES INDEX TABLE'                         R4 71517000
*********************************************************************** 71518000
*                                                                     * 71519000
*        THIS TABLE IS USED BY THE HASP JOB QUEUE MANAGEMENT          * 71520000
*        ROUTINES TO LOCATE THE OFFSET OF THE JOB QUEUE HEADER        * 71521000
*        (RELATIVE TO $JQHEADS-2) BASED UPON THE JQETYPE FIELD.       * 71522000
*        AN OFFSET OF ZERO IS INTERPRETED TO MEAN THAT NO SUCH        * 71523000
*        QUEUE HEADER EXISTS.                                         * 71524000
*                                                                     * 71525000
*********************************************************************** 71526000
         SPACE 5                                                     R4 71527000
$QINDEX  DC    AL1(2)                                      $PURGE    R4 71528000
         DC    AL1(4)                                      $HARDCPY  R4 71529000
         DC    AL1(6,0)                                    $OUTPUT   R4 71530000
         DC    AL1(8,0,0,0)                                $RECEIVE  R4 71531000
         DC    AL1(10),7AL1(0)                             $SETUP    R4 71532000
         DC    AL1(12),15AL1(0)                            $XMIT     R4 71533000
         DC    AL1(14),31AL1(0)                            $INPUT    R4 71534000
         DC    AL1(16)                                     $XEQ      R4 71535000
         DC    AL1(24,26,28,30,32,34,36,38,40),6AL1(0)     CLASS A-I R4 71536000
         DC    AL1(20)                                     STC CLASS R4 71537000
         DC    AL1(42,44,46,48,50,52,54,56,58),6AL1(0)     CLASS J-R R4 71538000
         DC    AL1(22,0)                                   TSU CLASS R4 71539000
         DC    AL1(60,62,64,66,68,70,72,74),6AL1(0)        CLASS S-Z R4 71540000
         DC    AL1(76,78,80,82,84,86,88,90,92,94),6AL1(0)  CLASS 0-9 R4 71541000
         DC    AL1(18),127AL1(0)                           $DUMMY    R4 71542000
         TITLE 'HASP BRANCH-ENTRY XM POST ROUTINE'                   R4 71543000
*********************************************************************** 71544000
*                                                                     * 71545000
*        $XMPOST - PERFORM BRANCH-ENTRY XM POST                       * 71546000
*                                                                     * 71547000
* INPUT  R1    - ADDRESS OF 3-WORD POST ELEMENT                       * 71548000
*                                                                     * 71549000
*                   +0    ECB ADDRESS                                 * 71550000
*                   +4    ASCB ADDRESS                                * 71551000
*                   +8    ERROR ROUTINE ADDRESS                       * 71552000
*                                                                     * 71553000
*        R13   - PCE ADDRESS                                          * 71554000
*        R14   - RETURN ADDRESS                                       * 71555000
*        R15   - ENTRY ADDRESS                                        * 71556000
*                                                                     * 71557000
*********************************************************************** 71558000
         SPACE 1                                                     R4 71559000
         ENTRY $XMPOSTR            PROVIDE ENTRY FOR $XMPOST ROUTINE R4 71560000
         USING $XMPOSTR,R15        PROVIDE LOCAL ADDRESSABILITY      R4 71561000
         SPACE 1                                                     R4 71562000
         CNOP  0,8                                                   R4 71563000
$XMPOSTR STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 71564000
         L     R11,0(,R1)          GET ADDRESS OF ECB TO BE POSTED   R4 71565000
         L     R2,0(,R11)          THEN LOAD THE ECB                 R4 71566000
         SPACE 1                                                     R4 71567000
XMTEST   LTR   R2,R2               IF WAIT HAS BEEN ISSUED,          R4 71568000
         BM    XMPOST               BR TO SLOW-POST THE ECB          R4 71569000
         L     R3,=A(X'40000000')    ELSE GET POST CODE              R4 71570000
         CS    R2,R3,0(R11)           AND FAST-POST THE ECB          R4 71571000
         BNE   XMTEST              BR IF UNSUCCESSFUL TO TRY AGAIN   R4 71572000
         LM    WA,R11,PCEWA         ELSE RESTORE CALLER'S REGISTERS  R4 71573000
         BR    LINK                  AND RETURN                      R4 71574000
         SPACE 1                                                     R4 71575000
         CNOP  0,8                                                   R4 71576000
XMPOST   LR    R9,SAVE             SAVE CALLER'S SAVE AREA ADDRESS   R4 71577000
         ICM   R11,8,=AL1(X'80')   SET HI-ORDER BIT FOR XMPOST       R4 71578000
         L     R12,8(,R1)          GET ADDRESS OF ERROR ROUTINE      R4 71579000
         L     R13,4(,R1)          GET ADDRESS OF RELATED ASCB       R4 71580000
         L     R10,=A(X'40000000') SET XMPOST CODE                   R4 71581000
         L     R15,CVTPTR          GET CVT ADDRESS                   R4 71582000
         L     R15,CVT0PT01-CVT(,R15) GET ADDR OF BR ENTRY TO XMPOST R4 71583000
         MODESET EXTKEY=ZERO       SET PROTECT KEY FOR XMPOST        R4 71584000
         BALR  LINK,R15            ENTER XMPOST ROUTINE              R4 71585000
         MODESET EXTKEY=HASP       RESTORE HASP'S PROTECT KEY        R4 71586000
         LR    SAVE,R9             RESTORE CALLER'S SAVE AREA ADDR   R4 71587000
         LM    LINK,R12,PCELINK    RESTORE CALLER'S REGISTERS        R4 71588000
         BR    LINK                 AND RETURN                       R4 71589000
         SPACE 1                                                     R4 71590000
         DROP  R15                 KILL LOCAL ADDRESSABILITY         R4 71591000
         TITLE 'HASP VIRTUAL PAGE SERVICES ROUTINES'                 R4 71592000
*********************************************************************** 71593000
*                                                                     * 71594000
*        PGRLSE (BRANCH ENTRY)     PAGE RELEASE ROUTINE               * 71595000
*        PGFREE (BRANCH ENTRY)     PAGE FREE ROUTINE                  * 71596000
*        PGFIX  (BRANCH ENTRY)     PAGE FIX ROUTINE                   * 71597000
*                                                                     * 71598000
* INPUT  R0    - PAGE AREA LENGTH                                     * 71599000
*        R1    - ADDRESS OF 1ST BYTE OF PAGE AREA                     * 71600000
*        R2    - ADDRESS OF WAIT ECB (PGFIX ONLY) - NOTE - CALLER     * 71601000
*                MUST DO OWN WAIT BASED ON RC RETURNED IN R15         * 71602000
*        R11   - HCT ADDRESS (BASE1)                                  * 71603000
*        R14   - RETURN ADDRESS                                       * 71604000
*        R15   - ENTRY ADDRESS                                        * 71605000
*                                                                     * 71606000
* OUTPUT       - RETURN CODE IN R15                                   * 71607000
*                                                                     * 71608000
* NOTE   -     ONLY 1ST 32 BYTES OF $CSAVREG MAY BE USED BY THIS RTN  * 71609000
*                                                                     * 71610000
*********************************************************************** 71611000
         SPACE 1                                                     R4 71612000
         ENTRY $PGRLSER            SET UP ENTRY POINT                R4 71613000
         USING $PGRLSER,R15        LOCAL ADDRESSABILITY              R4 71614000
         SPACE 1                                                     R4 71615000
         CNOP  0,8                                                   R4 71616000
$PGRLSER $TRACE                                                      R4 71617000
         STM   R14,R5,$CSAVREG     SAVE WORK REGISTERS               R4 71618000
         SLR   R5,R5               SHOW NO ECB                       R4 71619000
         LA    R1,0(,R1)           CLEAR PARAMETER VALUE       @OZ20010 71620000
         LA    R15,$PGFIXR         RESET BASE ADDRESS AND BRANCH     R4 71621000
         B     PGRTNRLS-$PGFIXR(,R15)  TO MVS PAGE SERVICES    @OZ20010 71622000
         SPACE 1                                                     R4 71623000
         ENTRY $PGFREER            SET UP ENTRY POINT                R4 71624000
         USING $PGFREER,R15        LOCAL ADDRESSABILITY              R4 71625000
         SPACE 1                                                     R4 71626000
         CNOP  0,8                                                   R4 71627000
$PGFREER $TRACE                                                      R4 71628000
         STM   R14,R5,$CSAVREG     SAVE WORK REGISTERS               R4 71629000
         SLR   R5,R5               SHOW NO ECB                       R4 71630000
         ICM   R1,8,=AL1(X'20')    FLAG1 = PGFREE                    R4 71631000
         LA    R15,$PGFIXR         RESET BASE ADDRESS AND BRANCH     R4 71632000
         B     PGRTN-$PGFIXR(,R15)  TO MVS VIRTUAL PAGE SERVICES     R4 71633000
         SPACE 1                                                     R4 71634000
         ENTRY $PGFIXR             SET UP ENTRY POINT                R4 71635000
         USING $PGFIXR,R15         LOCAL ADDRESSABILITY              R4 71636000
         SPACE 1                                                     R4 71637000
         CNOP  0,8                                                   R4 71638000
$PGFIXR  $TRACE                                                      R4 71639000
         STM   R14,R5,$CSAVREG     SAVE WORK REGISTERS               R4 71640000
         LR    R5,R2               ADDR OF WAIT ECB                  R4 71641000
         XC    0(4,R5),0(R5)       CLEAR ECB                         R4 71642000
         LTR   LINK,LINK           RELEASE=Y...                @OZ20010 71642100
         BM    PGRTNRLS            BR IF YES                   @OZ20010 71642200
         ICM   R1,8,=AL1(X'42')    FLAG1 = LONG PGFIX                R4 71643000
         CLI   0(R1),*-*           FETCH PAGE INTO STORAGE           R4 71644000
         EJECT                                                       R4 71645000
PGRTN    LTR   LINK,LINK           RELEASE=Y...                @OZ20010 71645100
         BNM   *+8                 BRANCH IF NOT               @OZ20010 71645200
PGRTNRLS O     R1,=A(X'08000000')  SET RELEASE OPTION          @OZ20010 71645300
         L     R4,$HASPTCB         R4= HASP'S TCB ADDRESS      @OZ20010 71646000
         LR    R3,R1               R3 = A(1ST BYTE OF PAGE AREA)     R4 71647000
         LR    R2,R0               R2 = ADDRESS OF END OF            R4 71648000
         ALR   R2,R1                     PAGE AREA (+1)              R4 71649000
         ICM   R2,8,=AL1(X'80')    FLAG2 = END OF SUB-AREA LIST      R4 71650000
         MODESET EXTKEY=ZERO       SET PROTECT KEY FOR PG SERVICES   R4 71651000
PGO      SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,   GET LOCAL LOCK     R4C71652000
               REGS=USE,RELATED=($PGSRVC,HASPNUC(PGR))               R4 71653000
         LR    R0,R5               ADDR OF ECB, OR ZERO              R4 71654000
         LR    R1,R3               RE-LOAD R1 FOR PG SERVICES        R4 71655000
         L     R15,CVTPTR          GET ADDRESS OF BRANCH ENTRY TO    R4 71656000
         L     R15,CVTVPSIB-CVT(,R15)   MVS VIRTUAL PAGE SERVICES    R4 71657000
         BALR  R14,R15             AND GO DO IT                      R4 71658000
         ST    R15,$CSAVREG+4      PUT RC IN R15 IN SAVE AREA        R4 71659000
PGR      SETLOCK RELEASE,TYPE=LOCAL,    GIVE UP LOCAL LOCK           R4C71664000
               REGS=USE,RELATED=($PGSRVC,HASPNUC(PGO))         @OZ20010 71665000
         MODESET EXTKEY=HASP       GET BACK OUR PROTECT KEY          R4 71666000
         L     R15,$PGFIX          RELOAD BASE REGISTER             R41 71666100
         CLM   R3,8,=AL1(X'42')    WAS THIS PAGE-FIX REQUEST...     R41 71666200
         BNE   *+8                 BR IF NOT                        R41 71666400
         CLI   0(R3),*-*            ELSE REF. PAGE TO ENSURE FIX    R41 71666500
         LM    R14,R5,$CSAVREG     RESTORE WORK REGISTERS            R4 71667000
         BR    R14                  AND RETURN                       R4 71668000
         SPACE 1                                                     R4 71669000
         DROP  R15                 KILL LOCAL ADDRESSABILITY         R4 71670000
         TITLE 'HASP DIRECT ACCESS SPACE ALLOCATION ROUTINE'         R4 71671000
*********************************************************************** 71672000
*                                                                     * 71673000
* $TRACK - HASP VERSION OF SPOOL SPACE ALLOCATION                     * 71674000
*                                                                     * 71675000
*                                                                     * 71676000
* FUNCTION ---                                                        * 71677000
*                                                                     * 71678000
*                                                                     * 71679000
*  (1)  IF CALL IS FOR INITIAL ALLOCATION, A TRACK GROUP              * 71680000
*       IS OBTAINED FROM THE TRACK GROUP BLOCK (TGB) MAINTAINED       * 71681000
*       BY THE JES2 CHECKPOINT PROCESSOR.                             * 71682000
*                                                                     * 71683000
*  (2)  IF CALL IS NOT FOR INITIAL ALLOCATION, AN ATTEMPT             * 71684000
*       IS MADE TO SUPPLY AN MTTR BASED ON THE TRACK CELL (TAB)       * 71685000
*       REFERENCED BY R1.  IF SUCCESSFUL, THE MTTR IS RETURNED        * 71686000
*       IN R1.  IF NOT, WE TRY TO OBTAIN A NEW TRACK CELL FROM        * 71687000
*       THE CURRENT TRACK GROUP.  IF THIS IS SUCCESSFUL, AN           * 71688000
*       MTTR IS RETURNED IN R1.  IF NOT, A SEARCH FOR A NEW TG        * 71689000
*       IS PERFORMED USING THE TGB.                                   * 71690000
*                                                                     * 71691000
*  (3)  IF THE TGB IS EMPTY, THE CALLER IS $WAITED.  THE JES2         * 71692000
*       CHECKPOINT PROCESSOR IS $POSTED TO CAUSE A REFILLING          * 71693000
*       OF THE TGB.                                                   * 71694000
*                                                                     * 71695000
*                                                                     * 71696000
* INPUT ---                                                           * 71697000
*                                                                     * 71698000
*  (1)  R1 CONTAINS THE ADDRESS OF A MASTER TAB (SEE TABDSECT).       * 71699000
*                                                                     * 71700000
*  (2)  THE FIRST WORD OF THE MASTER TAB IS NOT USED.  SINCE          * 71701000
*       THE MASTER TAB IS IN THE IOT, WE CAN USE THE MASTER           * 71702000
*       TAB'S ADDRESS TO GET THE ADDRESS OF THE TGM.  THE             * 71703000
*       SECOND WORD CONTAINS AN MTTR OF THE LAST ALLOCATED            * 71704000
*       BUFFER FROM THE TRACK CELL ASSIGNED TO THE TAB.  THE          * 71705000
*       THIRD WORD CONTAINS A FLAG BYTE TO TELL WHAT KIND OF          * 71706000
*       TAB THIS IS,  THE SUB-PERMUTATION NUMBER ASSOCIATED WITH      * 71707000
*       THE CURRENT TRACK CELL (SEE $STRAK IN HASPSSSM FOR A          * 71708000
*       COMPLETE DISCUSSION), THE MAXIMUM NUMBER OF RECORDS THAT      * 71709000
*       WILL FIT ON A TRACK IN THE CURRENT TRACK CELL, AND THE        * 71710000
*       NBR OF BUFFERS LEFT IN THE TRACK CELL.  IF THE BUFFER         * 71711000
*       COUNT IS 0, AND THE LAST ALLOCATED BUFFER IS 0, THE CALL      * 71712000
*       IS FOR THE INITIAL ALLOCATION OF A BUFFER.                    * 71713000
*                                                                     * 71714000
*                                                                     * 71715000
* OUTPUT ---                                                          * 71716000
*                                                                     * 71717000
*  (1)  R1 CONTAINS AN UPDATED MTTR.  THIS IS THE SAME VALUE AS       * 71718000
*       IS SET IN THE 2ND WORD OF THE INPUT TAB.                      * 71719000
*                                                                     * 71720000
*  (2)  CC IS SET TO ZERO IF A NEW TG HAS BEEN ALLOCATED.             * 71721000
*       CC IS SET TO NON-ZERO IF AN OLD TG HAS BEEN ALLOCATED.        * 71722000
*                                                                     * 71723000
*********************************************************************** 71724000
         EJECT                                                       R4 71725000
*                                                                    R4 71726000
*********************************************************************** 71727000
*                                                                     * 71728000
*        $TRACK -- GET A NEW MTTR FOR CALLER                          * 71729000
*                                                                     * 71730000
*********************************************************************** 71731000
*                                                                     * 71732000
         SPACE 1                                                     R4 71733000
         USING TABDSECT,R3         TAB ADDRESSABILITY                R4 71734000
         USING TGMDSECT,R4         TGM ADDRESSABILITY                R4 71735000
         USING $TRACKR,BASE2       PROVIDE LOCAL ADDRESSABILITY      R4 71736000
         ENTRY $TRACKR             PROVIDE ENTRY FOR $TRACK ROUTINE  R4 71737000
         SPACE 1                                                     R4 71738000
         CNOP  0,8                                                   R4 71739000
$TRACKR  STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 71740000
         LR    BASE2,R15           RELOAD BASE                       R4 71741000
         LR    R3,R1               SETUP TAB DSECT                   R4 71742000
         LA    R4,IOTTGMAP-IOTMSTAB(,R1)  OBTAIN ADDRESS OF TGM      R4 71743000
         SPACE 1                                                     R4 71744000
TRECORD  ICM   R6,1,TABUFCNT       NBR OF BUFFERS LEFT IN TRAKCELL   R4 71745000
         BZ    TCELL               NONE LEFT - NEED A NEW TRAKCELL   R4 71746000
         BCTR  R6,0                SUBTRACT 1                        R4 71747000
         STC   R6,TABUFCNT         SAVE NEW BUFFER COUNT             R4 71748000
         SLR   R1,R1               ZERO OUT WORK FIELD               R4 71749000
         IC    R1,$RECINCR         PICK UP &RECINCR                  R4 71750000
         AL    R1,TABMTTR          PT AT POTENTIAL NEW BUFFER        R4 71751000
         ST    R1,TABMTTR           AND SAVE ITS MTTR                R4 71752000
         CLC   TABMTTR+3(1),TABMAXR  HAVE WE GONE OFF THE TRACK...   R4 71753000
         BNH   T1RETURN            NO - MTTR IS VALID - EXIT         R4 71754000
         IC    R1,TABSPN           YES - GET CURRENT SUB-PERM NBR    R4 71755000
         AL    R1,=F'1'            ADD 1 TO IT                       R4 71756000
         STC   R1,TABSPN           SAVE NEW SUB-PERM NBR             R4 71757000
         STC   R1,TABMTTR+3        PUT NEW VALUE OF R IN MTTR        R4 71758000
         SPACE 1                                                     R4 71759000
T1RETURN ST    R1,PCER1            PUT NEW MTTR IN SAVE AREA         R4 71760000
         LM    LINK,R12,PCELINK    RESTORE CALLER'S REGISTERS        R4 71761000
         LTR   R15,R15             SET CONDITION CODE                R4 71762000
         BR    R14                 RETURN TO CALLER                  R4 71763000
         SPACE 2                                                     R4 71764000
TTRKF256 DC    F'256'              FULLWORD CONSTANT OF 256          R4 71765000
         EJECT                                                       R4 71766000
         CNOP  0,8                                                   R4 71767000
TCELL    ICM   R1,15,TGMCELL       MTTR OF NEXT AVAILABLE TRAKCELL   R4 71768000
         BZ    TBLOBA              NOTHING THERE - 1ST TIME THRU     R4 71769000
         CLM   R1,1,TGMCYMXM+3     R OF TGMCELL GT MAX R OF TG...    R4 71770000
         BH    TTRACK              YES - NO MORE TRAKCELLS ON THIS   R4C71771000
                                   TRACK - NEED A NEW TRACK          R4 71772000
         SPACE 1                                                     R4 71773000
TCRETRY  ST    R1,TABMTTR          SAVE MTTR OF 1ST BFR IN NEW TKCEL R4 71774000
         MVC   TABSPN,TGMCYMXM     GET SUB-PERM FOR NEW TRAKCELL     R4 71775000
         MVC   TABMAXR,TGMCYMXM+3  GET MAX R OF TRACK GROUP          R4 71776000
         SLR   R6,R6               ZERO OUT CTR FOR FINDING TABUFCNT R4 71777000
         SLR   R0,R0               CLEAR WORK REG                    R4 71778000
         IC    R0,$RECINCR         PICK UP &RECINCR                  R4 71779000
         SPACE 1                                                     R4 71780000
TCLOOP   ALR   R1,R0               POINT TO NEXT BUFFER IN TRAKCELL  R4 71781000
         LA    R6,1(,R6)           ADD 1 TO BUFCNT                   R4 71782000
         SPACE 1                                                     R4 71783000
TCCHECK  CLM   R1,1,TGMCYMXM+3     R GONE PAST MAX R FOR THE TG...   R4 71784000
         BNH   TCLOOPND            NO - HAVE WE REACHED $TCELSIZ     R4 71785000
         CLC   TGMCYMXM(1),$RECINCR     IS SUB-PERM STILL VALID...   R4 71786000
         BNL   TCEND               NO - FINISH UP.  NOTE THAT        R4C71787000
                                   TGMCELL WILL NOW HAVE AN INVALID  R4C71788000
                                   MTTR (I.E. - R IS TOO LARGE)      R4 71789000
         IC    R1,TGMCYMXM         PICK UP TGMSPN                    R4 71790000
         AL    R1,=F'1'            UP IT BY ONE                      R4 71791000
         STC   R1,TGMCYMXM         SAVE NEW TGMSPN - WE'VE ALSO      R4C71792000
                                   PUT NEW R IN MTTR OF TGMCELL      R4C71793000
                                   BEING CALCULATED                  R4 71794000
         B     TCCHECK             SEE IF R IS STILL VALID           R4 71795000
         SPACE 1                                                     R4 71796000
         CNOP  0,8                                                   R4 71797000
TCLOOPND CLM   R6,1,$TCELSIZ       DO WE HAVE A FULL TRACK CELL...   R4 71798000
         BL    TCLOOP              NO - COUNT ANOTHER BUFFER         R4 71799000
         SPACE 1                                                     R4 71800000
TCEND    ST    R1,TGMCELL          SAVE MTTR OF NEXT AVALIABLE TKCEL R4 71801000
         BCTR  R6,0                SUBTRACT 1 SINCE 1ST BUFFER IN    R4C71802000
                                   NEW TRAKCELL IS ALLOCATED         R4 71803000
         STC   R6,TABUFCNT         SAVE NEW BUFFERS LEFT COUNT       R4 71804000
         L     R1,TABMTTR          GET READY TO EXIT                 R4 71805000
         B     T1RETURN             AND LEAVE                        R4 71806000
         SPACE 1                                                     R4 71807000
         CNOP  0,8                                                   R4 71808000
TTRACK   AL    R1,TTRKF256         INCREASE TT IN TGMCELL BY 1       R4 71809000
         CLM   R1,6,TGMCYMXM+1     OUT OF OUR TRACK GROUP...         R4 71810000
         BH    TBLOBA              YES - GET A NEW TRACK GROUP       R4 71811000
         IC    R1,TTRKF256+2       MAKE R IN TGMCELL A 1             R4 71812000
         MVI   TGMCYMXM,1          SET TGMSPN BACK TO 1              R4 71813000
         B     TCRETRY             INITIALIZE NEXT TRAKCELL          R4 71814000
         TITLE 'HASP DA SPACE ALLOCATION (TG FROM TGB)'                 71815000
*********************************************************************** 71816000
*                                                                     * 71817000
*              ALLOCATE MTTR FROM TGB                                 * 71818000
*                                                                     * 71819000
*********************************************************************** 71820000
         SPACE 1                                                        71821000
         USING $SVDSECT,R10        PROVIDE SSVT ADDRESSABILITY       R4 71822000
         SPACE 1                                                     R4 71823000
         CNOP  4,8                                                   R4 71824000
TBLOBA   L     R10,$SSVT           R10 = SSVT ADDRESS                R4 71825000
         SLR   R2,R2               R2 = 0 (FOR CDS)                     71826000
         SLR   R3,R3               R3 = 0 (FOR CDS)                     71827000
         SPACE 1                                                     R4 71828000
TBLOBB   LM    R5,R7,$SVTTGBA      R5=1ST, R6=SIZE, R7=LAST TGB         71829000
         SPACE 1                                                     R4 71830000
         USING TGBDSECT,R5         TGB ADDRESSABILITY                   71831000
         SPACE 1                                                     R4 71832000
TBLOBC   LM    R0,R1,TGBENTRY      FETCH TGB ENTRY                      71833000
         LTR   R1,R1               TEST FOR AVAILABLE TG                71834000
         BZ    TBLOBD              BRANCH IF NOT                        71835000
         CDS   R0,R2,TGBENTRY      TRY TO ALLOCATE                      71836000
         BE    TBLOBE              BRANCH IF SUCCESSFUL                 71837000
         SPACE 1                                                     R4 71838000
TBLOBD   BXLE  R5,R6,TBLOBC        TRY NEXT ENTRY                       71839000
         SPACE 1                                                        71840000
*********************************************************************** 71841000
*                                                                     * 71842000
*              TGB DEPLETED. FORCE RE-BLOB.                           * 71843000
*                                                                     * 71844000
*********************************************************************** 71845000
         SPACE 1                                                        71846000
        $POST  $HASPECF,CKPW       TELL CHECKPOINT PROCESSOR         R4 71847000
         TM    PCELINK,X'80'       DID USER WANT TO WAIT...          R4 71848000
         BZ    TBWAIT              BR IF YES TO $WAIT                R4 71849000
         LM    LINK,R12,PCELINK    RESTORE CALLER'S REGISTERS        R4 71850000
         SR    R1,R1               SET MTTR TO ZERO                  R4 71851000
         BR    LINK                RETURN WITH NO TRACKS             R4 71852000
         SPACE 1                                                     R4 71853000
         CNOP  0,8                                                   R4 71854000
TBWAIT  $WAIT  TRAK,SAVE=NO        WAIT ON RESOURCE                  R4 71855000
         L     BASE2,$TRACK        RESTORE BASE REGISTER             R4 71856000
         LA    R4,IOTTGMAP-IOTMSTAB(,R1)     A(TGM) FOR TGMDSECT     R4 71857000
         B     TBLOBA              TRY AGAIN                            71858000
         EJECT                                                       R4 71859000
*********************************************************************** 71860000
*                                                                     * 71861000
*              TGB ALLOCATED. ESTABLISH TED ADDRESSABILITY            * 71862000
*                                                                     * 71863000
*********************************************************************** 71864000
         SPACE 1                                                        71865000
         CNOP  0,8                                                   R4 71866000
TBLOBE   LR    R2,R1               R2 = MTTR                            71867000
         SRL   R2,24               R2 = 000M                            71868000
         MH    R2,=AL2(TEDSIZ)     R2 = M * TEDSIZE                     71869000
         AL    R2,$TEDADDR         R2 = ADDRESS OF TED                  71870000
         SPACE 1                                                     R4 71871000
         USING TEDDSECT,R2         TED ADDRESSABILITY                   71872000
         SPACE 1                                                     R4 71873000
*********************************************************************** 71874000
*                                                                     * 71875000
*              SHOW TRACK GROUP ALLOCATION IN USERS MAP               * 71876000
*                                                                     * 71877000
*********************************************************************** 71878000
         SPACE 1                                                        71879000
         LR    R3,R0               R3 = OFFSET & BIT MASK               71880000
         SRL   R3,16               R3 = OFFSET TO ALLOCATION BYTE       71881000
         IC    R8,TGMAP(R3)        T8 = MAP BYTE                        71882000
         OR    R8,R0               SHOW ALLOCATION                      71883000
         STC   R8,TGMAP(R3)         FOR THIS TG                         71884000
         SPACE 1                                                        71885000
*********************************************************************** 71886000
*                                                                     * 71887000
*              DEVELOP NEW PTTR FROM MTTR & TED                       * 71888000
*                                                                     * 71889000
*********************************************************************** 71890000
         SPACE 1                                                        71891000
         LR    R0,R1               R0 = NEW MTTR                        71892000
         SRL   R0,8                R0 = 0MTT                            71893000
         AH    R0,TNTG             R0 = MAX TT + 1                      71894000
         BCTR  R0,0                R0 = MAX TT                          71895000
         SLL   R0,8                R0 = MAX TT0                         71896000
         AH    R0,TNRT             R0 = MAX TTR                         71897000
         ICM   R0,8,=X'01'         R0 = PTTR                            71898000
         SPACE 1                                                     R4 71899000
         DROP  R2                  FORGET TED                           71900000
         SPACE 1                                                        71901000
*********************************************************************** 71902000
*                                                                     * 71903000
*              STORE NEW PTTR (MAX) & MTTR IN TGM                     * 71904000
*                                                                     * 71905000
*********************************************************************** 71906000
         SPACE 1                                                        71907000
         LM    R2,R3,TGMCYMXM      FETCH CURRENT VALUE                  71908000
         CDS   R2,R0,TGMCYMXM      REPLACE WITH NEW                     71909000
         L     R3,PCER1            A(MSTR TAB) FROM R1 IN SAVE AREA  R4 71910000
         XC    PCER15,PCER15       SHOW A NEW TG WAS OBTAINED        R4 71911000
         B     TCRETRY             INITIALIZE A NEW TRAKCELL         R4 71912000
         SPACE 1                                                        71913000
         DROP  R3,R4,R5,R10,BASE2  FORGET ALL                        R4 71914000
         TITLE 'HASP BUFFER POOL MANAGEMENT'                         R4 71915000
*********************************************************************** 71916000
*                                                                     * 71917000
*        $GETBUF - GET SOME KIND OF JES2 BUFFER                       * 71918000
*                                                                     * 71919000
*        R0    - NUMBER OF BUFFERS REQUESTED, IF GREATER THAN 1       * 71920000
*        R1    - TYPE OF BUFFER WANTED (INPUT), 1ST BUF ADDR (OUTPUT) * 71921000
*        R11   - HCT ADDRESS (BASE1)                                  * 71922000
*        R14   - RETURN ADDRESS                                       * 71923000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 71924000
*                                                                     * 71925000
*********************************************************************** 71926000
         SPACE 1                                                     R4 71927000
         USING BUFDSECT,R4         PROVIDE BUFFER ADDRESSABILITY     R4 71928000
         USING BPMDSECT,WB         PROVIDE BPM ADDRESSABILITY        R4 71929000
         USING $GETBUFR,R15        PROVIDE LOCAL ADDRESSABILITY      R4 71930000
         ENTRY $GETBUFR            ENTRY TO GENERAL BUFFER GET RTN   R4 71931000
         SPACE 1                                                     R4 71932000
$BUFSAVE EQU   $CSAVREG+32         USE LAST 32 BYTES OF $CSAVREG FOR R4C71933000
                                   STORING REGS BECAUSE OTHER        R4C71934000
                                   SERVICE ROUTINES WILL BE CALLED   R4 71935000
         SPACE 1                                                     R4 71936000
         CNOP  0,8                                                   R4 71937000
$GETBUFR $TRACE                                                      R4 71938000
         STM   LINK,R5,$BUFSAVE    SAVE WORK REGS                    R4 71939000
         XC    $BUFSAVE+12(4),$BUFSAVE+12  ZERO R1 IN SAVE AREA      R4 71940000
         LA    R4,$BUFSAVE+12-(BUFCHAIN-BUFDSECT)  INITIAL CHAIN ADR R4 71941000
         ST    R1,$BUFSAVE+4       SAVE BUFTYPE IN R15 IN SAVE AREA  R4 71942000
         LA    R5,1                ASSUME REQUEST FOR SINGLE BUFFER  R4 71943000
         TM    $BUFSAVE+7,BUFMULT  TEST ASSUMPTION                   R4 71944000
         BZ    SKIP40              BR IF VALID                       R4 71945000
         LR    R5,R0               SET UP LOOP CTR                   R4 71946000
SKIP40   N     R1,=F'7'            EXTRACT $BPMTABL REL ENTRY NUMBER R4 71947000
         SLL   R1,2                MULTIPLY BY 4                     R4 71948000
         L     WB,$BPMTABL(R1)     GET PROPER BUFFER POOL            R4 71949000
         L     WB,0(,WB)            MAP ADDRESS                      R4 71950000
         LA    WB,0(,WB)           CLEAR HI-ORDER BYTE               R4 71951000
         CH    R5,BPMBUFCT         ENOUGH BUFFERS AVAILABLE...       R4 71952000
         BNH   BUFGET              BR IF YES TO ALLOCATE BUFFERS     R4 71953000
         TM    $BUFSAVE+7,BUFTP    TEST FOR TP BUFFER                R4 71954000
         BZ    SKIP50              BR IF NO                          R4 71955000
         MVI   $TPBFMAP,0           ELSE INDICATE NO TP BUFFERS      R4 71956000
SKIP50   LM    R2,R5,$BUFSAVE+16   RESTORE WORK REGISTERS            R4 71957000
         TM    $BUFSAVE,X'40'      DOES CALLER WISH TO WAIT...       R4 71958000
         BZR   LINK                RETURN IF NO WITH CC = 0          R4 71959000
         L     R1,$BUFSAVE+4       RESTORE R1                        R4 71960000
        $WAIT  BUF                 WAIT FOR BUFFER(S)                R4 71961000
         L     R15,$GETBUF         RESTORE ENTRY POINT ADDRESS       R4 71962000
         B     $GETBUFR             AND BR TO RETRY REQUEST          R4 71963000
         EJECT                                                       R4 71964000
*********************************************************************** 71965000
*                                                                     * 71966000
*        BUFFER AVAILABLE - COMPUTE ADDRESS AND RECONTRUCT IOB        * 71967000
*                                                                     * 71968000
*********************************************************************** 71969000
         SPACE 1                                                     R4 71970000
         CNOP  0,8                                                   R4 71971000
BUFGET   SLR   R1,R1               CLEAR WORK                        R4 71972000
         SLR   WA,WA                REGISTERS                        R4 71973000
         TRT   BPMMAP,BUFTRTBL     TEST FOR AVAILABLE BUFFER         R4 71974000
         BNZ   BUFAVAIL            BR IF YES                         R4 71975000
B02     $ERROR                     AVAILABLE BUFFER COUNT INVALID    R4 71976000
         SPACE 1                                                     R4 71977000
BUFAVAIL LH    WA,BUFTBL1-2(WA)    ALLOCATE                          R4 71978000
         EX    WA,BUFALLOC          THE BUFFER                       R4 71979000
         SRL   WA,8                RELATIVE BUFFER WITHIN MASK BYTE  R4 71980000
         SL    R1,BPMAPADR         R1 = NUMBER OF                    R4 71981000
         SLL   R1,3                      PAGES OF                    R4 71982000
         ALR   R1,WA                      BUFFERS PRECEEDING         R4 71983000
         SLR   R0,R0                       NEWLY ALLOCATED           R4 71984000
         D     R0,BPMPGBFS                  BUFFER                   R4 71985000
         SLL   R1,12               R1 = ADDRESS                      R4 71986000
         MH    R0,BPMBFSIZ               OF NEWLY                    R4 71987000
         ALR   R1,R0                      ALLOCATED                  R4 71988000
         ALR   R1,WB                       BUFFER                    R4 71989000
         ST    R1,BUFCHAIN         CHAIN BUFFER TO PREVIOUS BUFFER   R4 71990000
         LR    R4,R1               PREV BUFFER PTR AND DSECT         R4 71991000
         IC    R0,$BUFSAVE+7       GET BUFFER TYPE                   R4 71992000
        $BFRBLD (R1),TYPE=(R0)     CONSTRUCT BUFFER                  R4 71993000
         L     R15,$GETBUF         RESTORE BASE REGISTER             R4 71994000
         TM    BUFTYPE,BUFFIX      PAGE-FIX THIS BUFFER...           R4 71995000
         BZ    BUFGET1             NO                                R4 71996000
         LH    R0,BPMBFSIZ         LENGTH OF A BUFFER                R4 71997000
         LA    R2,BUFSTART         GET ADDRESS OF PSEUDO-ECB         R4 71998000
         XC    0(4,R2),0(R2)        AND CLEAR FOR $PGFIX             R4 71999000
        $PGSRVC FIX,(R1),(R0),(R2) PAGE-FIX THE BUFFER               R4 72000000
         L     R15,$GETBUF         RESTORE BASE REGISTER             R4 72001000
         CLI   BUFSTART,0          ENSURE BUFFER NOW IN MAIN STORAGE R4C72002000
                                   (AND HENCE FIXED) -- NO NEED THEN R4C72003000
                                   TO WAIT ON PSEUDO ECB.            R4 72004000
         EJECT                                                       R4 72005000
BUFGET1  LH    R1,BPMBUFCT         DECREMENT                         R4 72006000
         BCTR  R1,0                 BUFFER                           R4 72007000
         STH   R1,BPMBUFCT           COUNT                           R4 72008000
         BCT   R5,BUFGET           IF WANTED, GET ANOTHER BUFFER     R4 72009000
         SPACE 1                                                     R4 72010000
         XC    BUFCHAIN,BUFCHAIN   SHOW END OF BUFFER CHAIN          R4 72011000
         LM    LINK,R5,$BUFSAVE    RESTORE REGS                      R4 72012000
         LTR   LINK,LINK           SET NON-ZERO CC                   R4 72013000
         BR    LINK                RETURN                            R4 72014000
         SPACE 1                                                     R4 72015000
BUFALLOC NI    0(R1),*-*           *** EXECUTE ONLY ***              R4 72016000
         SPACE 1                                                     R4 72017000
BUFTBL1  DC    AL1(0,255-X'80',1,255-X'40',2,255-X'20',3,255-X'10')  R4 72018000
         DC    AL1(4,255-X'08',5,255-X'04',6,255-X'02',7,255-X'01')  R4 72019000
         SPACE 1                                                     R4 72020000
BUFTRTBL DC    AL1(0,16,14,14),4AL1(12),8AL1(10)                     R4 72021000
         DC    16AL1(8),32AL1(6),64AL1(4),128AL1(2)                  R4 72022000
         SPACE 1                                                     R4 72023000
         DROP  R4,WB,R15           KILL LOCAL ADDRESSABILITY         R4 72024000
         EJECT                                                       R4 72025000
*********************************************************************** 72026000
*                                                                     * 72027000
*        $FREEBUF - RELEASE BUFFER TO FREE POOL                       * 72028000
*                                                                     * 72029000
*        R0    - WORK, UNPREDICTABLE ON EXIT                          * 72030000
*        R1    - BUFFER ADDRESS, UNPREDICTABLE ON EXIT                * 72031000
*        R11   - HCT ADDRESS (BASE1)                                  * 72032000
*        R14   - RETURN ADDR (HI-ORDER BIT ON IF MULTIPLE BFR FREE)   * 72033000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 72034000
*                                                                     * 72035000
*********************************************************************** 72036000
         SPACE 1                                                     R4 72037000
         USING BUFDSECT,R1         PROVIDE BUFFER ADDRESSABILITY     R4 72038000
         USING BPMDSECT,WB         PROVIDE BFR MAP ADDRESSABILITY    R4 72039000
         USING $FREEBFR,R15        PROVIDE LOCAL ADDRESSABILITY      R4 72040000
         ENTRY $FREEBFR            ENTRY TO BUFFER FREE ROUTINE      R4 72041000
         SPACE 1                                                     R4 72042000
         CNOP  0,8                                                   R4 72043000
$FREEBFR $TRACE                                                      R4 72044000
         STM   LINK,R5,$BUFSAVE    SAVE WORK REGS                    R4 72045000
         LTR   LINK,LINK           FREE MULTIPLE BUFFERS...          R4 72046000
         BM    SKIP60              BR IF YES                         R4 72047000
         XC    BUFCHAIN,BUFCHAIN   NO - FORCE 1 BUFFER TO BE FREED   R4 72048000
SKIP60   IC    R5,BUFTYPE          PICK UP BUFFER TYPE               R4 72049000
         N     R5,=F'7'            EXTRACT $BPMTABL REL ENTRY NUMBER R4 72050000
         SLL   R5,2                MULTIPLY BY 4                     R4 72051000
         L     WA,$BPMTABL(R5)     GET PROPER BUFFER POOL            R4 72052000
         L     WB,0(,WA)            MAP ADDRESS AND                  R4 72053000
         LA    WB,0(,WB)             CLEAR HI-ORDER BYTE             R4 72054000
         TM    BUFTYPE,BUFTP       IS THIS A TP BUFFER               R4 72055000
         BZ    FREEBF1             BR IF NO                          R4 72056000
         MVI   0(WA),X'80'         SHOW TP BUFFER PRESENT FOR RTAM   R4 72057000
         SPACE 1                                                     R4 72058000
FREEBF1  L     R5,BUFCHAIN         SAVE BUFCHAIN                     R4 72059000
         LA    R5,0(,R5)           CLEAR HI-ORDER BYTE               R4 72060000
         LA    R4,0(,R1)           RELOAD PURIFIED BUFFER ADDRESS    R4 72061000
         CL    R4,BPMBFR1          IF BUFFER                         R4 72062000
         BL    FREERROR             ADDRESS IN                       R4 72063000
         CL    R4,BPMLAST            VALID RANGE,                    R4 72064000
         BNH   BUFVALID               BR TO CONTINUE                 R4 72065000
         SPACE 1                                                     R4 72066000
FREERROR L     R14,$BUFSAVE        RESTORE FOR DEBUG PURPOSES        R4 72067000
B01     $ERROR                     INVALID BUFFER ADDRESS            R4 72068000
         SPACE 1                                                     R4 72069000
         DROP  R1                  KILL BUFFER ADDRESSABILITY        R4 72070000
         EJECT                                                       R4 72071000
         USING BUFDSECT,R4         PROVIDE BUFFER ADDRESSABILITY     R4 72072000
         SPACE 1                                                     R4 72073000
         CNOP  0,8                                                   R4 72074000
BUFVALID LR    WA,R4               WA = NUMBER OF BUFFERS            R4 72075000
         SLR   WA,WB                     IN PAGES PRECEEDING         R4 72076000
         SRL   WA,12                      PAGE CONTAINING            R4 72077000
         MH    WA,BPMPGBFS+2               CURRENT BUFFER            R4 72078000
         SLR   R0,R0               R1 = RELATIVE                     R4 72079000
         N     R1,BUFMASK1               BUFFER                      R4 72080000
         LH    R14,BPMBFSIZ               NUMBER                     R4 72081000
         DR    R0,R14                      WITHIN                    R4 72082000
         ALR   R1,WA                        BUFFER POOL              R4 72083000
         LR    R14,R1              R14 = ADDR OF MAP BYTE            R4 72084000
         SRL   R14,3                      REPRESENTING BUFFER        R4 72085000
         AL    R14,BPMAPADR                BEING FREED               R4 72086000
         N     R1,BUFMASK2         R1 = RELATIVE BIT WITHIN MAP BYTE R4 72087000
         LA    R1,BUFTBL2(R1)      POINT TO ALLOCATION MASK BYTE     R4 72088000
         OC    0(1,R14),0(R1)      MAKE BUFFER AVAILABLE             R4 72089000
        $POST  $HASPECF,BUF        INDICATE BUFFER AVAILABLE         R4 72090000
         TM    BUFTYPE,BUFFIX      WAS THE BUFFER FIXED...           R4 72091000
         BZ    FREEBF2             BR IF NO                          R4 72092000
         LH    R0,BPMBFSIZ         LENGTH OF A BUFFER                R4 72093000
         LR    R1,R4               ADDR OF BUFFER TO BE FREED        R4 72094000
        $PGSRVC FREE,(R1),(R0)     PAGE-FREE THE BUFFER              R4 72095000
         LM    R14,R15,$BUFSAVE    RESTORE DESTROYED REGS            R4 72096000
         SPACE 1                                                     R4 72097000
FREEBF2  LR    R1,WA               R1 = ADDRESS OF MASK BYTE         R4 72098000
         SRL   R1,3                      REPRESENTING 1ST BUFFER IN  R4 72099000
         AL    R1,BPMAPADR                PAGE CONTAING FREED BUFFER R4 72100000
         N     WA,BUFMASK2         R0 = BITS FROM BIT MAP,           R4 72101000
         ICM   R0,12,0(R1)               LEFT JUSTIFIED,             R4 72102000
         SLL   R0,0(WA)                   REPRESENTING BUFFERS       R4 72103000
         ST    R0,$BUFSAVE+8               IN PAGE CONTAINING        R4 72104000
         IC    R1,BPMMASK                   BUFFER JUST FREED        R4 72105000
         EX    R1,BUFTEST          TEST OTHER BFRS IN PAGE (IF ANY)  R4 72106000
         BO    BUFFREE             BR IF PAGE CAN BE RELEASED        R4 72107000
         SPACE 1                                                     R4 72108000
FREEBF3  LH    R1,BPMBUFCT         INCREMENT                         R4 72109000
         LA    R1,1(,R1)            BUFFER                           R4 72110000
         STH   R1,BPMBUFCT           COUNT                           R4 72111000
         LTR   R1,R5               POINT TO NEXT BUFFER IN CHAIN     R4 72112000
         BNZ   FREEBF1             FREE NEXT BUFFER                  R4 72113000
         LM    LINK,R5,$BUFSAVE    RESTORE REGS                      R4 72114000
         BR    LINK                 AND RETURN WITH CC = 0           R4 72115000
         EJECT                                                       R4 72116000
*********************************************************************** 72117000
*                                                                     * 72118000
*        PAGE-RELEASE PAGE CONTAINING FREED BUFFER                    * 72119000
*                                                                     * 72120000
*********************************************************************** 72121000
         SPACE 1                                                     R4 72122000
         CNOP  0,8                                                   R4 72123000
BUFFREE  LR    R1,R4               ADDR OF BUFFER IN PG TO BE FREED  R4 72124000
         N     R1,BUFMASK3         DROP DOWN TO PAGE BNDRY           R4 72125000
         L     R0,BUFPGSIZ         PAGE SIZE                         R4 72126000
        $PGSRVC RLSE,(R1),(R0)     RELEASE THE PAGE                  R4 72127000
         LM    R14,R15,$BUFSAVE    RESTORE DESTROYED REGS            R4 72128000
         B     FREEBF3             CHECK FOR ANOTHER BUFFER          R4 72129000
         SPACE 1                                                     R4 72130000
BUFTEST  TM    $BUFSAVE+8,*-*      *** EXECUTE ONLY ***              R4 72131000
         SPACE 1                                                     R4 72132000
BUFPGSIZ DC    F'4096'             OS/VS2 PAGE SIZE                  R4 72133000
BUFMASK1 DC    X'00000FFF'         ADDRESS MASK                      R4 72134000
BUFMASK2 DC    X'00000007'         ADDRESS MASK                      R4 72135000
BUFMASK3 DC    X'00FFF000'         ADDRESS MASK                      R4 72136000
         SPACE 1                                                     R4 72137000
$BPMTABL DS    0A                  TABLE OF BPMAP ADDRESSES          R4 72138000
         DC    A($BFRMAP)          REGULAR JES2 BUFFERS              R4 72139000
         DC    A($TPBFMAP)         TP BUFFERS                        R4 72140000
         DC    A($PGBFMAP)         PAGE BUFFERS                      R4 72141000
         DC    A($PPBFMAP)         PP BUFFERS                        R4 72142000
         SPACE 1                                                     R4 72143000
BUFTBL2  DC    X'8040201008040201' ALLOCATION MAP BYTE MASK          R4 72144000
         SPACE 1                                                     R4 72145000
         DROP  R4,WB,R15           KILL LOCAL ADDRESSABILITY         R4 72146000
         TITLE 'HASP BUFFER BUILD ROUTINE'                           R4 72147000
*********************************************************************** 72148000
*                                                                     * 72149000
*        $BFRBLD - BUILD A BUFFER (INITIALIZE PREFIX)                 * 72150000
*                                                                     * 72151000
*        R0    - BFR TYPE IF ENTERED VIA BAL, UNPREDICTABLE ON EXIT   * 72152000
*        R1    - ADDRESS OF THE BUFFER                                * 72153000
*        R11   - HCT ADDRESS (BASE1)                                  * 72154000
*        LINK  - RETURN ADDRESS, HI-ORDER BIT ON IF BFR TYPE IN R0    * 72155000
*        R15   - ENTRY POINT ADDRESS (USED AS LOCAL BASE)             * 72156000
*                                                                     * 72157000
*********************************************************************** 72158000
         SPACE 1                                                     R4 72159000
         ENTRY $BFRBLDR            PROVIDE ENTRY FOR $BFRBLD ROUTINE R4 72160000
         USING $BFRBLDR,R15        PROVIDE LOCAL ADDRESSABILITY      R4 72161000
         USING BUFDSECT,R1         PROVIDE BUFFER ADDRESSABILITY     R4 72162000
         SPACE 3                                                     R4 72163000
         CNOP  0,8                                                   R4 72164000
$BFRBLDR $TRACE                                                      R4 72165000
         SPACE 1                                                     R4 72166000
*********************************************************************** 72167000
*                                                                     * 72168000
*        DETERMINE TYPE OF BUFFER TO BUILD                            * 72169000
*                                                                     * 72170000
*********************************************************************** 72171000
         SPACE 1                                                     R4 72172000
         LTR   LINK,LINK           WAS BUFFER TYPE PROVIDED...       R4 72173000
         BM    SKIP70              BR IF YES                         R4 72174000
         LA    R0,BUFHASP           ELSE SUPPLY DEFAULT              R4 72175000
SKIP70   STC   R0,BUFTYPE          STORE BUFFER TYPE IN BUFFER       R4 72176000
         TM    BUFTYPE,BUFRPL      TEST FOR RPL TYPE BUFFER          R4 72178000
         BO    BFRBLRPL            BUILD AN RPL IF YES               R4 72179000
         TM    BUFTYPE,BUFIOB      TEST FOR IOB TYPE BUFFER          R4 72181000
         BNOR  LINK                RETURN TO CALLER IF NOT           R4 72182000
         EJECT                                                       R4 72183000
*********************************************************************** 72184000
*                                                                     * 72185000
*        CONSTRUCT AN IOB IN THE BUFFER                               * 72186000
*                                                                     * 72187000
*********************************************************************** 72188000
         SPACE 1                                                     R4 72189000
BFRBLIOB DS    0H                  BUILD IOB IN FRONT OF BUFFER      R4 72190000
         XC    BUFDSECT(BUFSTART-BUFDSECT),BUFDSECT  ZERO BUFDSECT   R4 72191000
         STC   R0,BUFTYPE          RESTORE BUFTYPE                   R4 72192000
         MVI   IOBFLAG1,X'42'      SET IOBFLAG1 (CMD CHAIN, UNREL)   R4 72193000
         MVC   IOBECBPT,$HASPECB   SET HASP ECB POINTER              R4 72194000
         MVI   IOBSEEK+6,1         RECORD 1 INDICATION               R4 72195000
         LA    R0,IOBCCW1          SET ADDRESS OF START              R4 72196000
         ST    R0,IOBSTART          OF CHANNEL PROGRAM               R4 72197000
         LA    R0,IOBCCW1+5        FIRST CCW                         R4 72198000
         ST    R0,IOBCCW1           SET TO                           R4 72199000
         MVI   IOBCCW1,3             NOP                             R4 72200000
         MVI   IOBCCW1+4,X'40'        WITH                           R4 72201000
         MVI   IOBCCW1+7,1             COMMAND CHAINING              R4 72202000
         LA    R0,IOBSEEK+2        SECOND CCW                        R4 72203000
         ST    R0,IOBCCW2           SET TO                           R4 72204000
         MVI   IOBCCW2,X'31'         SEARCH ID EQUAL                 R4 72205000
         MVI   IOBCCW2+4,X'40'        WITH                           R4 72206000
         MVI   IOBCCW2+7,5             COMMAND CHAINING              R4 72207000
         LA    R0,IOBCCW2          THIRD CCW SET                     R4 72208000
         ST    R0,IOBCCW3           TO TIC TO                        R4 72209000
         MVI   IOBCCW3,8             SECOND CCW                      R4 72210000
         LA    R0,BUFSTART         FOURTH CCW SET                    R4 72211000
         ST    R0,IOBCCW4           TO READ/WRITE                    R4 72212000
         MVC   IOBCCW4+6(2),$BUFSIZE INTO/FROM BUFSTART              R4 72213000
         BR    LINK                RETURN TO CALLER                  R4 72214000
         EJECT                                                       R4 72216000
*********************************************************************** 72217000
*                                                                     * 72218000
*        CONSTRUCT AN RPL IN THE BUFFER                               * 72219000
*                                                                     * 72220000
*********************************************************************** 72221000
         SPACE 1                                                     R4 72222000
BFRBLRPL DS    0H                  BUILD RPL IN FRONT OF BUFFER      R4 72223000
         XC    BUFDSECT(RPLSIZE),BUFDSECT  CLEAR RPL BUFFER          R4 72224000
         STC   R0,BUFTYPE          RESTORE BUFTYPE                   R4 72225000
         SPACE 1                                                     R4 72226000
         USING RPLDSECT,R1         PROVIDE RPL ADDRESSABILTIY        R4 72227000
         SPACE 1                                                     R4 72228000
         MVI   RPLSTYP,RPLSVTAM    SET SUBTYPE = VTAM                R4 72229000
         LA    R0,RPLLNGTH         GET LENGTH OF VTAM RPL            R4 72230000
         STC   R0,RPLLEN           STORE IN RPL LENGTH FIELD         R4 72231000
         SPACE 1                                                     R4 72232000
         LA    R0,RPLBUFST                 AREA = RPLBUFST           R4 72233000
         ST    R0,RPLAREA                                            R4 72234000
         LH    R0,$BFSZSNA              AREALEN = $BFSZSNA           R4 72235000
         ST    R0,RPLBUFL                                            R4 72236000
         MVI   RPLVTFL2,RPLSCHED+RPLEX     POST = SCHED              R4C72237000
                                        RESPOND = (EX,NFME,NRRN)     R4 72238000
         MVI   RPLCNTDF,RPLDATA         CONTROL = DATA               R4 72239000
         MVI   RPLOBSQ,RPLOSET           OBSQAC = SET                R4 72240000
         MVI   RPLIBSQ,RPLISET           IBSQAC = SET                R4 72241000
         MVI   RPLOPT2,RPLKEY             OPTCD = CA                 R4 72242000
         MVI   RPLOPT5,RPLNODE                  = RELEASE            R4 72243000
         MVI   RPLOPT6,RPLCOND                  = COND               R4 72244000
         MVI   RPLOPT7,RPLCNALL+RPLQOPT         = CONALL             R4C72245000
                                                = Q                  R4 72246000
         MVI   RPLOPT8,RPLODACP                 = ACCEPT             R4 72247000
         MVI   RPLOPT11,RPLSTART                = START              R4 72248000
         MVI   RPLOPT12,RPLNIBTK                = NIBTK              R4C72249000
                                                = NFMHDR             R4 72250000
         SPACE 1                                                     R4 72251000
         BR    LINK                RETURN TO CALLER                  R4 72252000
         SPACE 1                                                     R4 72254000
         DROP  R1,R15              RELEASE ADDRESSABILITY            R4 72255000
         SPACE 3                                                     R4 72256000
         LTORG                                                       R4 72257000
         TITLE 'HASP CELL CONTROL AND LOCK SERVICES'                    72258000
*********************************************************************** 72259000
*                                                                     * 72260000
*        $GETCELL - SUBROUTINE TO GET A COMMON SERVICE AREA CELL      * 72261000
*                                                                     * 72262000
* REGISTERS -                                                         * 72263000
*                                                                     * 72264000
*        R0    = ADDRESS OF SJB                                       * 72265000
*        R1    = ADDRESS OF TCB OR ZERO (ADDRESS OF CELL)             * 72266000
*        R4    = LENGTH OF CELL                                       * 72267000
*        R11   = ADDRESS OF HCT (BASE1) - SSVT                        * 72268000
*        R14   = RETURN                                               * 72269000
*        R15   = ENTRY BASE                                           * 72270000
*                                                                     * 72271000
*********************************************************************** 72272000
         SPACE 1                                                     R4 72273000
         USING CCEDSECT,R7                                              72274000
         USING $GETCELR,BASE3      PROVIDE $GETCELR ADDRESSABILITY   R4 72275000
         SPACE 1                                                     R4 72276000
$GETCELR STM   R0,R15,$CSAVREG     SAVE CALLER'S REGISTERS           R4 72277000
         LR    BASE3,R15           SET BASE                             72278000
         LR    R10,BASE1           COPY BASE 1                          72279000
         L     R11,$SSVT           POINT TO SSVT                        72280000
         USING HASP,R10                                                 72281000
         USING SSVT,R11                                                 72282000
         L     R15,$SVGCELL        POINT TO GET CELL                    72283000
         BALR  R14,R15             GET CELL                             72284000
         B     GCGM                IF NO CELL GET MORE      +0          72285000
GCEND    ST    R1,$CSAVREG+R1*4    SET ANSWER               +4          72286000
         LM    R0,R15,$CSAVREG     RETURN REGISTERS                     72287000
         LTR   R1,R1               SET CONDITION CODE                   72288000
         BR    R14                 EXIT                                 72289000
         SPACE 1                                                     R4 72290000
GCGM     L     R15,$SVGCMNS        POINT TO GET MAIN                    72291000
         LA    R0,1                SET CLAIM CODE -- R4 = (B-1)/256  R4 72292000
         BALR  R14,R15             ENTER ROUTINE                        72293000
         LTR   R1,R1               TEST FOR GOTTEN                      72294000
         BZ    GCEND               EXIT SO CALLER CAN REACT             72295000
         LM    R0,R1,$CSAVREG      PICK UP CALLER ID REGS               72296000
         STM   R0,R1,CCESJB+CCETCB-CCETCB SET USERS ID INTO CCE         72297000
         L     R1,CCECLOC-1        POINT TO CELL                        72298000
         LA    R1,0(0,R1)          PURIFY                               72299000
         B     GCEND               RETURN                               72300000
         SPACE 1                                                     R4 72301000
         USING HASP,BASE1                                               72302000
         DROP  BASE3                                                    72303000
         DROP  R10                                                      72304000
         EJECT                                                          72305000
*********************************************************************** 72306000
*                                                                     * 72307000
*        $FRECEL - SUBROUTINE TO FREE A CELL                          * 72308000
*                                                                     * 72309000
* REGISTERS -                                                         * 72310000
*                                                                     * 72311000
*        R0    = RESERVED                                             * 72312000
*        R1    = ADDRESS OF STORAGE CELL TO FREE. CELL POINTS TO CCE  * 72313000
*        R11   = ADDRESS OF HCT (BASE1) - SSVT                        * 72314000
*        R14   = RETURN                                               * 72315000
*        R15   = ENTRY BASE                                           * 72316000
*                                                                     * 72317000
*********************************************************************** 72318000
         SPACE 1                                                     R4 72319000
         USING $FRECELR,R15        PROVIDE $FRECELR ADDRESSABILITY   R4 72320000
         SPACE 1                                                     R4 72321000
$FRECELR STM   R0,R15,$CSAVREG     SAVE CALLER'S REGISTERS           R4 72322000
         LR    R10,BASE1                                                72323000
         L     R11,$SSVT           POINT TO SSVT                        72324000
         USING HASP,R10                                                 72325000
         USING SSVT,R11                                                 72326000
         L     R15,$SVFCELL        POINT TO FREE CELL ROUTINE           72327000
         BALR  R14,R15             ENTER IT                             72328000
         LM    R0,R15,$CSAVREG     RESTORE REGISTERS                    72329000
         BR    R14                 RETURN                               72330000
         SPACE 1                                                     R4 72331000
         USING HASP,BASE1                                               72332000
         DROP  R10                                                      72333000
         DROP  R15                                                      72334000
         EJECT                                                          72335000
*********************************************************************** 72336000
*                                                                     * 72337000
*        $GETLOK - SUBROUTINE TO GET THE CMS LOCK                     * 72338000
*                                                                     * 72339000
*********************************************************************** 72340000
         SPACE 1                                                     R4 72341000
         USING $GETLOKR,BASE3      PROVIDE $GETLOKR ADDRESSABILITY   R4 72342000
         SPACE 1                                                     R4 72343000
$GETLOKR STM   R0,R15,$CSAVREG     SAVE CALLER'S REGISTERS           R4 72344000
         LR    BASE3,R15           COPY BASE                            72345000
         LR    WA,BASE1            SAVE BASE1                           72346000
         MODESET EXTKEY=ZERO       GET KEY 0                            72347000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=($GETLOK,*-*,$FRC72348000
               ELOKR)                                                   72349000
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,RELATED=($GETLOK,*-*,$FRELC72350000
               OKR)                                                     72351000
         MODESET EXTKEY=HASP       GET KEY 1                            72352000
         LM    R0,R15,$CSAVREG-HASP(WA) RESTORE REGISTERS               72353000
         BR    R14                 RETURN                               72354000
         SPACE 1                                                     R4 72355000
         DROP  BASE3                                                    72356000
         EJECT                                                       R4 72357000
*********************************************************************** 72358000
*                                                                     * 72359000
*        $FRELOK - SUBROUTINE TO FREE THE LOCK                        * 72360000
*                                                                     * 72361000
*********************************************************************** 72362000
         SPACE 1                                                     R4 72363000
         USING $FRELOKR,BASE3      PROVIDE $FRELOKR ADDRESSABILITY   R4 72364000
         SPACE 1                                                     R4 72365000
$FRELOKR STM   R0,R15,$CSAVREG     SAVE CALLER'S REGISTERS           R4 72366000
         LR    BASE3,R15           COPY BASE                            72367000
         LR    WA,BASE1            SAVE BASE1                           72368000
         MODESET EXTKEY=ZERO       GET KEY 0                            72369000
         SETLOCK RELEASE,TYPE=CMS,RELATED=($FRELOK,*-*,$GETLOKR)        72370000
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=($FRELOK,*-*,$GETLOKR)      72371000
         MODESET EXTKEY=HASP       GET KEY 1                            72372000
         LM    R0,R15,$CSAVREG-HASP(WA) RESTORE REGISTERS               72373000
         BR    R14                 RETURN                               72374000
         SPACE 1                                                     R4 72375000
         DROP  BASE3                                                    72376000
         DROP  R7                                                       72377000
         TITLE 'HASP INPUT/OUTPUT SUPERVISOR APPENDAGES'                72378000
*********************************************************************** 72379000
*                                                                     * 72380000
*        HASPATTN - UNSOLICITED DEVICE END INTERRUPT HANDLER          * 72381000
*                                                                     * 72382000
*        THIS ROUTINE RUNS UNDER CONTROL OF AN SRB SCHEDULED          * 72383000
*        DUE TO UNSOLICITED DEVICE ENDS ON HASP UNIT RECORD DEVICES.  * 72384000
*        IT RESETS THE DCTHOLD AND DCTPAUSE BITS OF THE DCT           * 72385000
*        CORRESPONDING TO THE ATTENTION DEVICE AND SIMULATES A        * 72386000
*        $$POST FOR UNIT. THE ADDRESS OF THIS ROUTINE IS MADE KNOWN   * 72387000
*        TO THE SYSTEM BY ROUTINES IN HASPINIT.                       * 72388000
*                                                                     * 72389000
*********************************************************************** 72390000
         SPACE 1                                                     R4 72391000
         USING UCBDSECT,R2         ESTABLISH UCB ADDRESSABILITY      R4 72392000
         USING DCTDSECT,R3         ESTABLISH DCT ADDRESSABILITY         72393000
         USING $SVDSECT,R4         ESTABLISH SSVT ADDRESSABILITY        72394000
         USING HASPATTN,R15        ESTABLISH LOCAL ADDRESSABILITY       72395000
         SPACE 1                                                     R4 72396000
         CNOP  4,8                                                   R4 72397000
HASPATTN STM   R0,R15,0(R13)       SAVE ALL REGISTERS                R4 72398000
         L     BASE1,EASYBASE      SET UP STANDARD BASE1                72399000
         L     R2,IOSUCB-IOSB(,R1) GET ADDRESS OF UCB FROM IOSB         72400000
         ICM   R3,15,$DCTPOOL      POINT TO 1ST DCT                  R4 72401000
         BZ    ARETURN             RETURN IF NONE                    R4 72402000
         SPACE 1                                                        72403000
ATESTDEV TM    DCTSTAT,DCTATTN     TEST DEVICE STATUS                   72404000
         BZ    ANEXTDCT            BR IF NOT SET FOR ATTN PROCESSING    72405000
         L     R4,DCTDCB           GET ADDRESS OF DCB                   72406000
         L     R4,DCBDEBAD-DCBDSECT(,R4)  GET ADDRESS OF DEB            72407000
         CLM   R2,3,DEBSUCBA+2-DEBDSECT(R4)  COMP UCB ADDRESSES         72408000
         BNE   ANEXTDCT            BRANCH IF UCB ADDRESSES DO NOT MATCH 72409000
         NI    DCTSTAT,255-DCTPAUSE  RESET PAUSE FLAG                   72410000
         CLI   DCTDEVTP,DCTRDR     TEST DEVICE TYPE                     72411000
         BNE   *+8                 BRANCH IF NOT READER                 72412000
         NI    DCTSTAT,255-DCTHOLD  RESET HOLD FLAG                     72413000
         TM    DCTSTAT,DCTINUSE+DCTDRAIN+DCTHOLD  TEST                  72414000
         BZ    APOSTDEV            BRANCH IF DEVICE IS AVAILABLE        72415000
         SPACE 1                                                        72416000
ANEXTDCT ICM   R3,7,DCTCHAIN+1     GET ADDRESS OF NEXT DCT              72417000
         BNZ   ATESTDEV            BRANCH IF NOT END OF DCT CHAIN       72418000
         B     ARETURN             AVAILABLE DEVICE NOT FOUND, RETURN   72419000
         EJECT                                                          72420000
APOSTDEV LA    R0,$EWFUNIT*((255-$EWBUNIT)/255*255+1)  SET UNIT FLAGS   72421000
         L     R4,$SSVT            GET ADDRESS OF SSVT                  72422000
         L     R1,$SVECF           PICK UP OLD $$POST ECF VALUE         72423000
         OR    R0,R1               COMBINE FLAGS                        72424000
         CS    R1,R0,$SVECF        SET NEW FLAGS                        72425000
         BNE   *-6                 TRY AGAIN IF NOT SET                 72426000
         L     R10,EPOSTM          GET POST COMPLETION CODE             72427000
         L     R12,$HASPECB        GET ADDRESS  OF HASP ECB          R4 72428000
         MVI   $SVPOSTW(R12),X'FF' $$POST HASP DISPATCHER            R4 72429000
         L     R1,0(,R12)          GET CONTENTS OF HASP ECB          R4 72430000
         SPACE 1                                                     R4 72431000
APOSTEST LTR   R1,R1               TEST ECB                             72432000
         BM    APOSTECB            BRANCH IF HASP IS WAITING            72433000
         CS    R1,R10,0(R12)       TRY FAST POST                     R4 72434000
         BNE   APOSTEST            BRANCH IF FAST POST NOT SUCCESSFUL   72435000
         B     ARETURN             FAST POST SUCCESSFUL, RETURN         72436000
         SPACE 1                                                        72437000
APOSTECB L     R12,$HASPTCB        GET ADDRESS OF HASP TCB              72438000
         L     R11,$HASPECB        GET ADDRESS OF HASP ECB           R4 72439000
         L     R15,CVTPTR          GET ADDRESS OF CVT                   72440000
         L     R15,CVT0PT01-CVTDSECT(,R15)  GET ADDRESS OF POST         72441000
         BALR  R14,R15             TAKE BRANCH ENTRY TO POST            72442000
         SPACE 1                                                        72443000
ARETURN  LM    R0,R15,0(R13)       RESTORE REGISTERS                    72444000
         BR    R14                  AND RETURN                          72445000
         SPACE 1                                                     R4 72446000
         DROP  R2,R3,R4,R15        DROP ADDRESSABILITY                  72447000
         EJECT                                                          72448000
*********************************************************************** 72449000
*                                                                     * 72450000
*        $IOAPPEN - INPUT/OUTPUT APPENDAGE VECTOR TABLE               * 72451000
*                                                                     * 72452000
*********************************************************************** 72453000
         SPACE 3                                                        72454000
$IOAPPEN DC    A(ERETURN)          END OF EXTENT                        72455000
         DC    A(ERETURN)          SIO / PGFIX                       R4 72456000
         DC    A(EPCI)             PCI                               R4 72457000
         DC    A(ECHANEND)         CHANNEL END                          72458000
         DC    A(EABCHEND)         ABNORMAL CHANNEL END                 72459000
         SPACE 3                                                     R4 72460000
ERETURN  BR    R14                 RETURN TO IOS                     R4 72461000
         SPACE 5                                                     R4 72462000
*********************************************************************** 72463000
*                                                                     * 72464000
*        HASP INPUT/OUTPUT SUPERVISOR APPENDAGES                      * 72465000
*                                                                     * 72466000
* INPUT  R1    = ADDRESS OF RQE                                       * 72467000
*        R2    = ADDRSSS OF IOB                                       * 72468000
*        R3    = ADDRSSS OF DEB                                       * 72469000
*        R4    = ADDRESS OF DCB                                       * 72470000
*        R7    = ADDRESS OF UCB                                       * 72471000
*        R13   = ADDRESS OF 16 FULLWORD SAVE AREA                     * 72472000
*        R14   = RETURN ADDRESS                                       * 72473000
*        R15   = ENTRY ADDRESS                                        * 72474000
*                                                                     * 72475000
*********************************************************************** 72476000
         SPACE 2                                                     R4 72477000
         USING BUFDSECT,R2         PROVIDE IOB/BUFFER ADDRESSABILITY R4 72478000
         USING DCBDSECT,R4         PROVIDE DCB ADDRESSABILITY        R4 72479000
         USING UCBDSECT,R7         PROVIDE UCB ADDRESSABILITY        R4 72480000
         EJECT                                                       R4 72481000
*********************************************************************** 72482000
*                                                                     * 72483000
*        ***  ABNORMAL CHANNEL END APPENDAGE  ***                     * 72484000
*                                                                     * 72485000
*********************************************************************** 72486000
         SPACE 1                                                     R4 72487000
         USING EABCHEND,R15        PROVIDE LOCAL ADDRESSABILITY      R4 72488000
         SPACE 1                                                     R4 72489000
EABCHEND TM    IOBFLAG1,X'01'      SHOULD WE BYPASS APPENDAGE...     R4 72490000
         BNZR  R14                 RETURN IF YES                     R4 72491000
         TM    IOBSENS0,X'40'      INTERVENTION REQ...         @OZ29138 72491100
         BNO   EABCHRET            BR IF NO                    @OZ29138 72491110
         CLC   UCBTBYT3(2),EUCB1403  IS THIS A 1403...         @OZ29138 72491120
         BE    EINTREQ               BR IF YES                 @OZ29138 72491130
         CLC   UCBTBYT3(2),EUCB3211  IS THIS A 3211...         @OZ29138 72491140
         BE    EINTREQ               BR IF YES                 @OZ29138 72491150
         CLC   UCBTBYT3(2),EUCB3800  IS THIS A 3800...         @OZ29138 72491160
         BNE   EABCHRET              BR IF NO                  @OZ29138 72491170
EINTREQ  L     R12,28(,R1)         GET ADDRESS OF SRB FROM RQE @OZ29138 72491180
         USING SRBDSECT,R12        ESTAB. SRB ADDRESSABILITY   @OZ29138 72491190
         L     R12,SRBPARM         GET ADDRESS OF IOSB FROM SRB@OZ29138 72491200
         USING IOSB,R12            ESTAB. IOSB ADDRESSABILITY  @OZ29138 72491210
         TM    IOSFLA,IOSERR       IS THIS THE FIRST ENTRY...  @OZ29138 72491220
         BNZ   EABCHRET            BR IF NO, CSW ALREADY STORED@OZ29138 72491230
         L     R12,BUFDCT          GET DCT POINTER             @OZ29138 72491240
         USING DCTDSECT,R12        ESTAB. DCT ADDRESSABILITY   @OZ29138 72491250
         CLC   DCTCSW,=F'0'        2ND INTERVENTION REQUIRED...@OZ29138 72491260
         BNE   EABCHRET            BR IF YES                   @OZ29138 72491270
         MVC   DCTCSW+1(3),IOBCSW  SAVE CSW IN DCT             @OZ29138 72491280
         DROP  R12                                             @OZ29138 72491310
EABCHRET DS    0H                                              @OZ29138 72491320
         TM    IOBECBCC,X'20'      TEST COMPLETION CODE                 72494000
         BCR   NZ,R14              RETURN IF NO ERROR INDICATED         72495000
         MVI   IOBFLAG2,0          RESET IOBFLAG2                       72496000
         XC    IOBERRCT,IOBERRCT    IOBERRCT                            72497000
         NI    DCBIFLGS,X'3F'        AND DCBIFLGS                       72498000
         SPACE 1                                                     R4 72499000
*********************************************************************** 72500000
*                                                                     * 72501000
*        HANDLE 3800 DATA-LOST CONDITION (PAPER JAM)                  * 72502000
*                                                                     * 72503000
*********************************************************************** 72504000
         SPACE 1                                                     R4 72505000
         USING DCTDSECT,R13        PROVIDE DCT                       R4 72506000
         L     R13,BUFDCT           ADDRESSABILITY                   R4 72507000
         SPACE 1                                                     R4 72508000
         CLC   UCBTBYT3(2),EUCB3800  TEST FOR 3800 PRINTER           R4 72509000
         BNE   ETST3211            BR IF NOT                         R4 72510000
         SPACE 1                                                     R4 72511000
         LA    R11,X'10'           3800 CANCEL KEY STATUS BIT        R4 72512000
         L     R12,28(,R1)         ADDR OF SRB FROM RQE              R4 72513000
         USING SRBDSECT,R12        ESTABLISH SRB ADDRESSABILITY      R4 72514000
         L     R12,SRBPARM         ADDR OF IOSB                      R4 72515000
         USING IOSB,R12            ESTABLISH IOSB ADDRESSABILITY     R4 72516000
         L     R12,IOSERP          ADDR OF ERP WORK AREA             R4 72517000
         USING EWADSECT,R12        ESTABLISH EWA ADDRESSABILITY      R4 72518000
         SPACE 1                                                     R4 72519000
         TM    EWASNS+3,X'08'      TEST FOR SYS RESTART BIT          R4 72520000
         BZ    ECANKEY             BR IF NOT                         R4 72521000
         OI    DCTPPSW2,DCTNIJAM   INDICATE DATA LOST CONDITION      R4 72522000
         MVC   DCTJAMCT,EWASNS+20  OBTAIN PAGES-LOST COUNT           R4 72523000
         OI    EWAFLG3,EWAJAM      BYPASS INERVENTION REQ MSG        R4 72524000
         B     ECANKEY             GO TEST FOR CANCEL KEY            R4 72525000
         SPACE 1                                                     R4 72526000
ETST3211 B     EABCONT             *** NOP FOR 3211 CANCEL SUPPORT ***  72527000
         CLC   UCBTBYT3(2),EUCB3211  TEST FOR 3211 PRINTER           R4 72528000
         BNE   EABCONT             BR IF NOT 3211 OR 3800 PRINTER    R4 72529000
         LA    R11,X'02'           3211 CANCEL KEY STATUS BIT        R4 72530000
         EJECT                                                       R4 72531000
*********************************************************************** 72532000
*                                                                     * 72533000
*        IF 3211/3800 CANCEL KEY -- SIMULATE FWD-SPACE DATA SET       * 72534000
*                                                                     * 72535000
*********************************************************************** 72536000
         SPACE 1                                                     R4 72537000
ECANKEY  TM    IOBSENS0,X'10'      UNIT EXCEPTION...                 R4 72538000
         BZ    EABCONT             BR IF NO                          R4 72539000
         EX    R11,ECANTEST        CANCEL KEY SENSE BIT...           R4 72540000
         BZ    EABCONT             BR IF NO                          R4 72541000
         SPACE 1                                                     R4 72542000
         OI    DCTFLAGS,DCTBKSP          SIMULATE                    R4 72543000
         L     R12,DCTPCE                 FORWARD                    R4 72544000
         L     R11,EALLFFS                 SPACE                     R4 72545000
         ST    R11,PDDBSKIP-PCEDSECT(,R12)  DATA SET                 R4 72546000
         B     EABCONT             CONTINUE                          R4 72547000
         SPACE 2                                                     R4 72548000
         DROP  R12,R13             SUSPEND EWA/DCT ADDRESSABILITY    R4 72549000
         SPACE 2                                                     R4 72550000
EALLFFS  DC    F'-1'               FWD-SPACE DSET CONSTANT           R4 72551000
ECANTEST TM    IOBSENS1,*-*        *** EXECUTE ONLY ***              R4 72552000
         SPACE 1                                                     R4 72553000
EUCB3800 DC    AL1(UCB3UREC,UCB3800)  3800 PRINTER UCB TYPE          R4 72554000
EUCB3211 DC    AL1(UCB3UREC,UCB3211)  3211 PRINTER UCB TYPE          R4 72555000
EUCB1403 DC    AL1(UCB3UREC,UCB1403)  1403 PRINTER UCB TYPE    @OZ29138 72555100
         EJECT                                                       R4 72556000
*********************************************************************** 72557000
*                                                                     * 72558000
*        ***  PROGRAM CONTROLLED INTERRUPT APPENDAGE  ***             * 72559000
*                                                                     * 72560000
*********************************************************************** 72561000
         SPACE 1                                                     R4 72562000
         USING EPCI,R15            ESTABLISH LOCAL ADDRESSABILITY    R4 72563000
         USING PCIDSECT,R13        ESTABLISH PCIE ADDRESSABILITY     R4 72564000
         SPACE 1                                                     R4 72565000
EPCI     STM   R0,R15,0(R13)       SAVE REGISTERS                    R4 72566000
         LR    R9,R13              MOVE SAVE AREA ADDR TO R9         R4 72569000
         L     R13,PPBPCIE         LOCATE ACTIVE PCIE                R4 72570000
         L     R5,IOBCSW-1         COMPUTE ADDRESS             @OZ29106 72570050
         SH    R5,EBACKUP8           OF LAST CCW               @OZ29106 72570100
         SLR   R5,R2               COMPUTE OFFSET INTO IOB     @OZ29106 72570150
         SRL   R5,3                DIVIDE BY 8                 @OZ29106 72570200
         CH    R5,PPBDISPL         PCI OCCURRED IN HIGH HALF.  @OZ29106 72570250
         BNL   EPCIHIGH            YES, BRANCH                 @OZ29106 72570300
         CLI   PPBFLAG1,C'L'           LOW, WAS LAST LOW...    @OZ29106 72570350
         MVI   PPBFLAG1,C'L'       SET LOW                     @OZ29106 72570400
         BE    EPCIRET             LAST WAS LOW, RETURN        @OZ29106 72570450
         B     EPCIDONE            CONTINUE                    @OZ29106 72570500
EPCIHIGH CLI   PPBFLAG1,C'H'       HIGH, WAS LAST HIGH...      @OZ29106 72570550
         MVI   PPBFLAG1,C'H'       SET HIGH                    @OZ29106 72570600
         BE    EPCIRET             LAST WAS HIGH, RETURN       @OZ29106 72570650
EPCIDONE DS    0H                  CONTINUE                    @OZ29106 72570700
         TM    PCISGNAL,PCIBUSY    TEST FOR PREVIOUS ENTRY           R4 72571000
         BZ    EPCIRET             RETURN IF YES                     R4 72572000
         NI    PCISGNAL,255-PCIBUSY  ELSE, SHOW PCIE NO LONGER BUSY  R4 72573000
         STCM  R2,7,PCIBUFAD       SET IOB ADDR IN PCIE FOR $ASYNC   R4 72574000
         TM    PCI1FLGS,X'40'      TEST IF NEXT CCW AREA IS READY    R4 72575000
         BZ    EPCIASYN            BRANCH IF COMMAND-CHAIN NOT ON    R4 72576000
         L     R12,PPBCCWNX        ELSE, UPDATE IOBSTART             R4 72578000
         ST    R12,IOBSTART         TO NEW CCW AREA, AND             R4 72579000
         NI    4(R12),255-X'08'      RESET PCI BIT IN CASE OF RETRY  R4 72580000
         EJECT                                                       R4 72581000
*********************************************************************** 72582000
*                                                                     * 72583000
*        ALERT MISSING INTERRUPT HANDLER (MIH) OF CHANNEL PROGRESS    * 72584000
*                                                                     * 72585000
*********************************************************************** 72586000
         SPACE 1                                                     R4 72587000
EPCIASYN NI    UCBFLC,255-UCBTICBT SHOW CHANNEL PGM PROGRESS TO MIH  R4 72588000
         L     BASE1,EASYBASE      PROVIDE HCT ADDRESSABILITY        R4 72589000
         L     R12,$ASYPCIQ        PICK UP OLD PCIE QUEUE CHAIN      R4 72590000
         SPACE 1                                                     R4 72591000
EPCINOK  STCM  R12,7,PCICHAIN      PUT PREVIOUS ON BEHIND            R4 72592000
         CS    R12,R13,$ASYPCIQ    QUEUE IT                          R4 72593000
         BNE   EPCINOK             TRY AGAIN UNTIL QUEUED            R4 72594000
         SPACE 1                                                     R4 72595000
         L     R13,$HASCB          SET ASCB ADDRESS                  R4 72596000
         MVI   $ASYNCP,X'FF'       SET ASYNC POST INDICATION         R4 72597000
         L     R10,EPOSTM          GET POST COMPLETION CODE          R4 72598000
         L     R11,$HASPECB        GET ADDRESS  OF HASP ECB          R4 72599000
         L     R12,0(,R11)         GET CONTENTS OF HASP ECB          R4 72600000
         MVI   $SVPOSTW(R11),X'FF' $$POST HASP DISPATCHER            R4 72601000
         SPACE 1                                                     R4 72602000
EPOSTEST LTR   R12,R12             TEST HASP ECB                     R4 72603000
         BM    EPCIPOST            BR IF HASP WAITING                R4 72604000
         CS    R12,R10,0(R11)      TRY QUICK POST                    R4 72605000
         BNE   EPOSTEST            BR IF POST NOT SUCCESSFUL         R4 72606000
         B     EPCIRET             GO RETURN                         R4 72607000
         SPACE 1                                                     R4 72608000
EPCIPOST ICM   R11,B'1000',EPCIX80 SET HI-BIT FOR XMPOST             R4 72609000
         L     R10,EPOSTM          SET POST CODE                     R4 72610000
         L     R12,CVTPTR          POINT TO BR 14                    R4 72611000
         LA    R12,CVTBRET-CVTDSECT(,R12)  IN CVT                    R4 72612000
         ICM   R12,B'1000',EPCIX80 SET HI-BIT FOR XMPOST             R4 72613000
         L     R15,CVTPTR          GET ADDRESS OF                    R4 72614000
         L     R15,CVT0PT01-CVT(,R15)  POST ROUTINE FROM CVT         R4 72615000
         BALR  R14,R15             GO POST                           R4 72616000
         SPACE 1                                                     R4 72617000
EPCIRET  LM    R0,R15,0(R9)        RESTORE REGISTERS                 R4 72618000
         BR    R14                  AND RETURN TO IOS                R4 72619000
         SPACE 1                                                     R4 72620000
EPCIX80  DC    X'80'               MASK FOR HI-ORDER BYTE            R4 72621000
         SPACE 1                                                     R4 72622000
         DROP  R13,R15             KILL PCIE, LOCAL ADDRESSABILITY   R4 72623000
         EJECT                                                       R4 72624000
*********************************************************************** 72625000
*                                                                     * 72626000
*        ***  NORMAL CHANNEL END APPENDAGE  ***                       * 72627000
*                                                                     * 72628000
*********************************************************************** 72629000
         SPACE 1                                                     R4 72630000
         USING ECHANEND,R15        PROVIDE LOCAL ADDRESSABILITY      R4 72631000
ECHANEND TM    IOBFLAG1,X'04'+X'01' IS ERROR RTN IN CONTROL OR       R4C72632000
                                     IS BYPASS APPENDAGE SW ON...    R4 72633000
         BCR   NZ,R14              RETURN IF YES                        72634000
         SPACE 1                                                     R4 72635000
         L     R13,BUFDCT          ADDR OF DCT                       R4 72636000
         TM    DCTDEVTP-DCTDSECT(R13),DCTPRPU  TEST FOR PRINT/PUNCH  R4 72637000
         BZ    EABCONT             BR IF NOT                         R4 72638000
         L     R12,IOBCSW-1        ADDR OF ACTUAL PCIE NOP+8         R4 72639000
         SH    R12,EBACKUP8        ADDR OF ACTUAL PCIE               R4 72640000
         L     R13,PPBPCIE         ADDR OF EXPECTED PCIE             R4 72641000
         L     R10,PCI1FLGS-PCIDSECT(,R12) GET CCW FLAGS ETC   @OZ20015 72641200
ECCTSTLP L     R11,ECCBIT          ISOLATE COMMAND CHAIN       @OZ20015 72641400
         NR    R11,R10                FLAG IN R11              @OZ20015 72641600
         BNZ   EREDRIVE                  AND REDRIVE IF SET    @OZ20015 72641800
         LR    R11,R10             COPY REGISTER               @OZ20015 72642000
         N     R11,ENOTBUSY        RESET BUSY FLAG             @OZ20015 72642200
         CS    R10,R11,PCI1FLGS-PCIDSECT(R12) CHK IF CHANGED   @OZ20015 72642400
         BNE   ECCTSTLP            IT CHANGED TEST AGAIN       @OZ20015 72642600
         NI    PCISGNAL-PCIDSECT(R13),255-PCIBUSY  SHOW NOT BUSY     R4 72643000
EABCONT  BALR  R15,0               ESTABLISH                            72644000
         USING *,R15                NEW LOCAL ADDRESSABILITY            72645000
         L     BASE1,EASYBASE      SET UP STANDARD BASE1                72646000
         L     R10,$SSVT           POINT TO SSVT                        72647000
         USING SSVT,R10                                                 72648000
         LA    R2,0(0,R2)          CLEAR HIGH ORDER BYTE OF BUFREG   R4 72649000
         TM    BUFTYPE,BUFTP       CHECK BUFFER TYPE                 R4 72650000
         BO    ECHENDTP            BRANCH IF TP BUFFER               R4 72651000
         L     R12,$ASYNCQ         PICK UP OLD CHAIN                    72652000
ENOK     ST    R12,BUFCHAIN        PUT PREVIOUS BUFFERS ON BEHIND       72653000
         CS    R12,R2,$ASYNCQ      QUEUE IT                             72654000
         BNE   ENOK                IF NOT QUEUED TRY AGAIN              72655000
         MVI   $ASYNCP,X'FF'       SET ASYNC POST INDICATION         R4 72656000
         B     EPOSTJES            BRANCH TO POST JES                R4 72657000
ECHENDTP L     R12,$RJECHEQ        PICK UP OLD CHAIN                 R4 72658000
         ST    R12,BUFCHAIN        PUT PREVIOUS BUFFER ON BEHIND     R4 72659000
         CS    R12,R2,$RJECHEQ     ATTEMPT TO QUEUE IT               R4 72660000
         BNE   ECHENDTP+4          RETRY IF UNSUCCESSFUL             R4 72661000
         MVI   $SVMLLM,X'FF'       SHOW LINE MANAGER POST REQ        R4 72662000
EPOSTJES L     R13,EPOSTM          PICK UP POST MASK                 R4 72663000
         L     R10,$HASPECB        GET ADDRESS  OF HASP ECB          R4 72664000
         L     R12,0(,R10)         GET CONTENTS OF HASP ECB          R4 72665000
         MVI   $SVPOSTW(R10),X'FF' $$POST HASP DISPATCHER            R4 72666000
EPNOK    LTR   R12,R12             TEST FOR WAITING                     72667000
         BCR   M,R14               LET IOS POST IF WAITING              72668000
         CS    R12,R13,0(R10)      TRY QUICK POST                    R4 72669000
         BNE   EPNOK               IF NOT SAME TRY AGAIN                72670000
         B     4(0,R14)            TELL IOS TO SKIP POST                72671000
         SPACE 2                                               @OZ20015 72671075
EREDRIVE DS    0H    RESTART CHAINED NOP **BASE NOT NEEDED**   @OZ20015 72671150
         LA    R12,0(,R12)         ZERO BYTE THE FIRST         @OZ20015 72671225
         ST    R12,IOBSTART        TELL IOS TO START HERE      @OZ20015 72671300
         MVI   IOBFLAG1,X'42'      UNRELATED+CHAINING          @OZ20015 72671375
         MVI   IOBFLAG2,0          CLEAR IOB FIELDS            @OZ20015 72671450
         MVI   IOBSENS0,0             IN ORDER TO              @OZ20015 72671525
         MVI   IOBSENS1,0                REDRIVE I/O           @OZ20015 72671600
         XR    R12,R12             CLEAR TWO REGS              @OZ20015 72671675
         LR    R13,R12               TO ZERO                   @OZ20015 72671750
         STM   R12,R13,IOBCSW-1    RESET IOB CSW               @OZ20015 72671825
         B     8(,R14)             GO RESTART THE I/O          @OZ20015 72671900
         SPACE 1                                                     R4 72672000
EPOSTM   DC    A(X'40000000')      POST MASK FOR QUICK POSTS            72673000
ECCBIT   EQU   EPOSTM              COMMAND CHAINING BIT        @OZ20015 72673300
ENOTBUSY DC    AL1(255,255,255,255-PCIBUSY) BUSY FLAG OFF MASK @OZ20015 72673600
EASYBASE DC    A(HASP)             STANDARD BASE1 ADDRESS               72674000
EBACKUP8 DC    H'8'                USED IN CSW ADJUSTMENT            R4 72675000
         SPACE 1                                                     R4 72676000
         DROP  R2,R4,R7,R10,R15                                         72677000
         TITLE 'HASP ASYNCHRONOUS INPUT/OUTPUT PROCESSOR'               72678000
*********************************************************************** 72679000
*                                                                     * 72680000
*        $ASYNC - ASYNCHRONOUS INPUT/OUTPUT PROCESSOR                 * 72681000
*                                                                     * 72682000
* FUNCTION                                                            * 72683000
*                                                                     * 72684000
*    THE PRIMARY FUNCTION OF THIS PROCESSOR IS TO SYNCHRONIZE         * 72685000
*    EVENTS DUE TO CHANNEL ENDS FOR I/O REQUESTED BY PROCESSORS       * 72686000
*    WITHIN THE MAIN HASP TASK. SECONDARY FUNCTIONS INCLUDE           * 72687000
*    FREEING OF UNUSED COMMON STORAGE AREA CELLS IN A MANNER SO AS    * 72688000
*    TO GRADUALLY REDUCE THE UNUSED STORAGE COMMITMENT, GET NEW       * 72689000
*    STORAGE CELLS ON DEMAND, AND REQUEUE CMBS QUEUED TO THE          * 72690000
*    $DOMQUEA TO THE $DOMQUE FOR THE HASP COMMUNICATIONS DAUGHTER     * 72691000
*    TASK.                                                            * 72692000
*                                                                     * 72693000
* INPUT REGISTERS                                                     * 72694000
*                                                                     * 72695000
*        R11   = HCT ADDRESS (BASE1)                                  * 72696000
*        R12   = BASE ADDRESS (BASE2)                                 * 72697000
*        R13   = PCE ADDRESS (SAVE)                                   * 72698000
*                                                                     * 72699000
*********************************************************************** 72700000
         SPACE 3                                                     R4 72701000
         USING PCEDSECT,SAVE       PROVIDE PCE ADDRESSABILITY        R4 72702000
         USING SSVT,R10            PROVIDE SSVT ADDRESSABILITY       R4 72703000
         USING CCEDSECT,R7         PROVIDE CCE ADDRESSABILITY        R4 72704000
         USING CCADSECT,BASE3      PROVIDE CCA ADDRESSABILITY        R4 72705000
         SPACE 3                                                     R4 72706000
$ASYNC  $ENTRY BASE=BASE2          PROVIDE PROCESSOR ENTRY POINT     R4 72707000
         SPACE 1                                                     R4 72708000
         L     R10,$SSVT           POINT TO SSVT                     R4 72709000
         L     BASE3,$CCAREA       POINT TO CCA                      R4 72710000
         EJECT                                                          72711000
*********************************************************************** 72712000
*                                                                     * 72713000
*        FREE UNUSED COMMON STORAGE AREA CELLS                        * 72714000
*                                                                     * 72715000
* REGISTERS                                                           * 72716000
*                                                                     * 72717000
*        R0    = WORK, PRIMARY CLAIM CODE                             * 72718000
*        R1    = WORK                                                 * 72719000
*        R2    = PRIMARY CLAIM CODE                                   * 72720000
*        R3    = SECONDARY CLAIM CODE, WORK                           * 72721000
*        R5    = LOCAL LINKAGE                                        * 72722000
*        R6    = WORK, CCE ADDRESS                                    * 72723000
*        R7    = CCE ADDRESS                                          * 72724000
*        R8    = CCA ADDRESS                                          * 72725000
*        R10   = SSVT ADDRESS                                         * 72726000
*                                                                     * 72727000
*********************************************************************** 72728000
         SPACE 1                                                     R4 72729000
ALOOP    L     R0,$SVASYNC         GET ASYNC POST ELEMENT      @OZ19496 72730000
         LR    R1,R0               SET REGISTER FOR SWAP       @OZ19496 72730100
         LA    R1,0(,R1)           CLEAR HIGH ORDER BYTE       @OZ19496 72730200
HFRESET  CS    R0,R1,$SVASYNC      RESET POST FLAG             @OZ19496 72730300
         BNE   HFRESET             LOOP UNTILL RESET           @OZ19496 72730400
         SPACE 1                                               @OZ19496 72730500
         STCK  CCACURT             STORE CLOCK                          72731000
         BZ    HFCCKT              CHECK TIME                           72732000
         SPACE 1                                                     R4 72733000
HFCVAR   CLI   $SVVARF,X'0'        ANY VARIABLE FREE                    72734000
         BE    HFNCELL             EXIT IF NOT                          72735000
         SPACE 1                                                     R4 72736000
* VARIABLE FREE REQUIRED                                                72737000
         SPACE 1                                                     R4 72738000
         LA    R7,$SVCELLS-(CCECCE-CCEDSECT) POINT TO HEADER            72739000
         SPACE 1                                                     R4 72740000
HFCELL   L     R7,CCECCE           POINT TO NEXT                        72741000
         LTR   R7,R7               CHECK FOR END                        72742000
         BZ    HFNCELL             EXIT IF END                          72743000
         CLI   CCECSIZ,(512-1)/256 CHECK FOR IN RANGE                   72744000
         BNH   HFCELL              LOOP                                 72745000
         SPACE 1                                                     R4 72746000
* WITHIN RANGE                                                          72747000
         SPACE 1                                                     R4 72748000
HFCVARGO MVI   $SVVARF,X'0'        FORCE FLAG ZERO                      72749000
         SPACE 1                                                     R4 72750000
HFCELVN  LM    R2,R3,CCESJB+CCETCB-CCETCB PICK UP ALLOCATION CELLS      72751000
         LTR   R2,R2               CLAIMED                              72752000
         BZ    HFCELC              EXIT IF FREEABLE                     72753000
         SPACE 1                                                     R4 72754000
HFCELVC  L     R7,CCECCE           POINT TO NEXT                        72755000
         LTR   R7,R7               CHECK FOR END                        72756000
         BNZ   HFCELVN             LOOP                                 72757000
         B     HFNCELL             EXIT ON END                          72758000
         SPACE 1                                                     R4 72759000
HFCELC   BAL   R5,HFCFREE          FREE CELL                            72760000
         B     HFCELVC             CONTINUE                             72761000
         SPACE 1                                                     R4 72762000
HFCCE    SLR   R6,R6               SET NOT FOUND                        72763000
         EJECT                                                       R4 72764000
HFCCEL   L     R7,CCECCE           POINT TO NEXT CCE                    72765000
         LTR   R7,R7               CHECK FOR END                        72766000
         BZ    HFCCELH             EXIT IF END                          72767000
         CLM   R0,1,CCECSIZ        CHECK CELL SIZE                      72768000
         BH    HFCCEL              LOOP                                 72769000
         BL    HFCCELH             EXIT IF CCE HIGH                     72770000
         LM    R2,R3,CCESJB+CCETCB-CCETCB PICK UP ALLOCATION WORDS      72771000
         LTR   R2,R2               TEST FOR FREE                        72772000
         BNZ   HFCCEL              LOOP                                 72773000
         LR    R6,R7               COPY LOCATION                        72774000
         B     HFCCEL              LOOP                                 72775000
         SPACE 1                                                     R4 72776000
HFCCELH  LTR   R6,R6               DID WE GET ANY                       72777000
         BZR   R5                  EXIT                                 72778000
         LR    R7,R6               POINT TO ONE TO FREE                 72779000
         SLR   R2,R2               ZERO SJB POINTER                     72780000
         SPACE 1                                                        72781000
* CLAIM AND FREE CELL SUBROUTINE                                        72782000
         SPACE 1                                                        72783000
HFCFREE  LA    R0,1                SET CLAIM CODE                       72784000
         L     R3,CCETCB           PICK UP TCB FIELD                    72785000
         CDS   R2,R0,CCESJB        CLAIM                                72786000
         BNZR  R5                  RETURN IF NOT CLAIMED                72787000
         SLR   R3,R3               ZERO WORK                            72788000
         IC    R3,CCECSIZ          PICK UP SIZE INDICATOR               72789000
         LA    R0,1(0,R3)          (B-1)/256+1=SIZE IN 256B BLOCKS      72790000
         SLA   R0,8                SIZE OF BLOCK                        72791000
         ICM   R0,8,=AL1(231)      SET SUBPOOL                          72792000
         ICM   R1,7,CCECLOC        PICK UP LOCATION                     72793000
         FREEMAIN R,LV=(0),A=(1)   FREE STORAGE                         72794000
         L     R2,=X'FF000000'     GET FREE FLAG                        72795000
         ST    R2,CCESJB           FREE IT FOR A GET MAIN TASK          72796000
         BR    R5                  RETURN                               72797000
         SPACE 1                                                     R4 72798000
HFCCKT   CLC   CCAPROJT,CCACURT    CHECK HIGH PART EXPIRED              72799000
         BH    HFCVAR              CHECK FOR VARIABLE FREE              72800000
         L     R0,CCACURT          PICK UP HIGH PART                    72801000
         AL    R0,CCADELT          SET NEXT FREE TIME                   72802000
         ST    R0,CCAPROJT         INTO PROJECTED                       72803000
         LA    R7,$SVCELLS-(CCECCE-CCEDSECT) POINT TO QUEUE HEAD        72804000
         LA    R0,(256-1)/256      SET SIZE ID                          72805000
         BAL   R5,HFCCE            CHECK CCES                           72806000
         LTR   R7,R7               TEST FOR END                         72807000
         BZ    HFNCELL             EXIT IF YES                          72808000
         LA    R0,(512-1)/256      SET SIZE ID                          72809000
         BAL   R5,HFCCE            CHECK CCES                           72810000
         LTR   R7,R7               TEST FOR END                         72811000
         BZ    HFNCELL             EXIT IF YES                          72812000
         CLI   $SVVARF,X'0'        ARE THERE ANY VARIABLE TO FREE       72813000
         BNE   HFCVARGO            DO THEM                              72814000
         SPACE 1                                                     R4 72815000
HFNCELL  DS    0H                                                       72816000
         EJECT                                                          72817000
*********************************************************************** 72818000
*                                                                     * 72819000
*        GET CELLS FOR WAITING USERS                                  * 72820000
*                                                                     * 72821000
* REGISTERS                                                           * 72822000
*                                                                     * 72823000
*        R0    = PRIMARY CLAIM CODE, WORK                             * 72824000
*        R1    = WORK                                                 * 72825000
*        R2    = PRIMARY CLAIM CODE, WORK                             * 72826000
*        R4    = CELL SIZE INDICATOR                                  * 72827000
*        R8    = CCA ADDRESS                                          * 72828000
*        R10   = SSVT ADDRESS                                         * 72829000
*        R11   = HCT/SSVT ADDRESS                                     * 72830000
*        R15   = WORK,ENTRY ADDRESS TO SUBROUTINES                    * 72831000
*        R14   = LINKAGE                                              * 72832000
*                                                                     * 72833000
*********************************************************************** 72834000
         SPACE 1                                                     R4 72835000
         CLI   $SVCPOST,X'FF'      DOES SOME ONE WANT CELL              72836000
         BE    HCNOCEL             EXIT IF NO CELLS DESIRED             72837000
         $GETLOK ,                 LOCK                                 72838000
         MVC   CCAPOST(CCACPL),$SVCPOST COPY REQUEST                    72839000
         MVI   $SVCPOST,X'FF'      SET SWITCH FOR NEXT TIME             72840000
         $FRELOK ,                 UNLOCK                               72841000
         L     R4,CCACPREQ         GET SIZE INFORMATION                 72842000
         LR    R11,R10             SET SSVT BASE                        72843000
         L     R15,$SVGCMNS        POINT TO GET MAIN FOR CELLS          72844000
         LA    R0,1                SET CLAIM CODE                       72845000
         BALR  R14,R15             LINK TO GET MAIN                     72846000
         L     BASE1,=A(HASP)      RESTORE BASE1                     R4 72847000
         LTR   R1,R1               DID WE GET IT                        72848000
         LA    R0,1                SET ABNORMAL POST CODE               72849000
         BZ    HCPOST              IF NOT POST ABNORMAL                 72850000
         SLR   R2,R2               FREE CELL INDICATOR                  72851000
         ST    R2,CCESJB-CCEDSECT(,R7) FREE THE CELL                    72852000
         SLR   R0,R0               ZERO POST CODE                       72853000
         SPACE 1                                                     R4 72854000
HCPOST   POST  ,(0),MF=(E,CCAPOST) POST USER                            72855000
         DROP  R7                                                       72856000
         DROP  R10                                                      72857000
         SPACE 1                                                     R4 72858000
HCNOCEL  DS    0H                                                       72859000
         EJECT                                                          72860000
*********************************************************************** 72861000
*                                                                     * 72862000
*        REQUEUE CMBS FROM $DOMQUEA TO $DOMQUE                        * 72863000
*                                                                     * 72864000
* REGISTERS                                                           * 72865000
*                                                                     * 72866000
*        R0    = WORK                                                 * 72867000
*        R1    = WORK, CMB ADDRESS                                    * 72868000
*        R2    = CMB ADDRESS                                          * 72869000
*        R4    = DOMID ( WHEN $DOM HAS ALREADY BEEN ISSUED )          * 72870000
*        R8    = CCA ADDRESS                                          * 72871000
*        R14   = LINKAGE                                              * 72872000
*        R15   = WORK, CMB ADDRESS                                    * 72873000
*                                                                     * 72874000
*********************************************************************** 72875000
         SPACE 1                                                     R4 72876000
         USING CMBDSECT,R2                                              72877000
         SPACE 1                                                     R4 72878000
HWNXTCMB L     R2,$DOMQUEA         PICK UP DOM QUEUE (ACTIVE)           72879000
         SPACE 1                                                     R4 72880000
HWL      LTR   R2,R2               TEST FOR EMPTY                       72881000
         BZ    HWNOCMB             EXIT IF EMPTY                        72882000
         L     R1,CMBCMB           POINT TO NEXT                     R4 72883000
         CS    R2,R1,$DOMQUEA      REMOVE FIRST IN CHAIN                72884000
         BNZ   HWL                 LOOP IF NOT QUEUED                   72885000
         TM    CMBLEVEL,$DOMACT    IS ACTION STILL ON                R4 72886000
         BZ    HWFCMB              IF NOT DO FREE                       72887000
         LA    R1,$DOMQUE-(CMBCMB-CMB) POINT TO QUEUE HEAD           R4 72888000
         SPACE 1                                                     R4 72889000
HWLCMB   LR    R15,R1              SAVE PREVIOUS                        72890000
         ICM   R1,7,CMBCMB+1-CMB(R1)  POINT TO NEXT CMB              R4 72891000
         BZ    HWQCMB              IF END QUEUE CMB                     72892000
         CLC   CMBDOMID,CMBDOMID-CMB(R1) CHECK FOR ORDER             R4 72893000
         BH    HWLCMB              LOOP                                 72894000
         SPACE 1                                                     R4 72895000
HWQCMB   ST    R1,CMBCMB           PUT HIGH ON END                   R4 72896000
         ST    R2,CMBCMB-CMB(,R15) PUT CURRENT ON                    R4 72897000
         B     HWNXTCMB            LOOP                                 72898000
         SPACE 1                                                     R4 72899000
HWFCMB   ICM   R4,15,CMBDOMID      PICK UP DOMID                     R4 72900000
         $FRECMB CMB=(R2)          FREE CMB                             72901000
         LR    R1,R4               SET DOM ID                           72902000
         DOM   MSG=(1)             DELETE MESSAGE                       72903000
         B     HWNXTCMB            LOOP                                 72904000
         SPACE 1                                                     R4 72905000
HWNOCMB  DS    0H                                                       72906000
         SPACE 1                                                     R4 72907000
         DROP  R2                                                       72908000
         EJECT                                                       R4 72909000
*********************************************************************** 72910000
*                                                                     * 72911000
*        HANDLE PROGRAM CONTROLLED INTERRUPTS                         * 72912000
*                                                                     * 72913000
* REGISTERS                                                           * 72914000
*                                                                     * 72915000
*        R0    = WORK                                                 * 72916000
*        R1    = PCIE ADDRESS                                         * 72917000
*              = BUFFER ADDRESS                                       * 72918000
*        R2    = WORK                                                 * 72919000
*        R3    = WORK                                                 * 72920000
*        R8    = CCA ADDRESS                                          * 72921000
*        R10   = SSVT ADDRESS                                         * 72922000
*        R11   = HCT ADDRESS                                          * 72923000
*        R12   = $ASYNC PROCESSOR BASE (BASE2)                        * 72924000
*        R15   = WORK                                                 * 72925000
*                                                                     * 72926000
*********************************************************************** 72927000
         SPACE 1                                                     R4 72928000
         L     R1,$ASYPCIQ         GET PCIE QUEUE ENTRY              R4 72929000
         LTR   R1,R1               TEST QUEUE HEAD                   R4 72930000
         BZ    APCIEOQ             BR IF END OF QUEUE                R4 72931000
         SPACE 1                                                     R4 72932000
         USING PCIDSECT,R1         R1 = QUEUED PCIE                  R4 72933000
         SPACE 1                                                     R4 72934000
APCINOK  L     WA,PCICHAIN-1       POINT TO NEXT PCIE                R4 72935000
         LA    WA,0(,WA)           CLEAR HI-ORDER BYTE               R4 72936000
         CS    R1,WA,$ASYPCIQ      ATTEMPT TO DE-QUEUE THE PCIE      R4 72937000
         BNZ   APCINOK             LOOP UNTIL SUCCESSFUL             R4 72938000
         XC    PCICHAIN(3),PCICHAIN  CLEAR PCICHAIN FIELD      @OZ31088 72938500
         L     R1,PCIBUFAD-1       PICK UP BUFFER ADDRESS FROM PCIE  R4 72939000
         SPACE 1                                                     R4 72940000
         USING BUFDSECT,R1         R1 = QUEUED BUFFER                R4 72941000
         SPACE 1                                                     R4 72942000
         L     WA,BUFEWF           GET USER EWF                      R4 72943000
        $TRACE                                                       R4 72944000
        $POST  (WA),IO             POST FOR I/O EVENT                R4 72945000
         B     ALOOP               LOOP                              R4 72946000
         SPACE 1                                                     R4 72947000
         DROP  R1                  SUSPEND BUFFER ADDRESSABILITY     R4 72948000
         SPACE 1                                                     R4 72949000
APCIEOQ  DS    0H                                                    R4 72950000
         EJECT                                                       R4 72951000
*********************************************************************** 72952000
*                                                                     * 72953000
*        HANDLE CHANNEL END COMPLETIONS                               * 72954000
*                                                                     * 72955000
* REGISTERS                                                           * 72956000
*                                                                     * 72957000
*        R0    = WORK                                                 * 72958000
*        R1    = BUFFER ADDRESS                                       * 72959000
*        R2    = WORK                                                 * 72960000
*        R3    = WORK                                                 * 72961000
*        R8    = CCA ADDRESS                                          * 72962000
*        R10   = SSVT ADDRESS                                         * 72963000
*        R12   = PROCESSOR BASE (BASE2)                               * 72964000
*              = SYNCHRONIZED PROCESSOR APPENDAGE BASE (BASE2)        * 72965000
*        R15   = WORK                                                 * 72966000
*                                                                     * 72967000
*********************************************************************** 72968000
         SPACE 1                                                     R4 72969000
         L     R1,$ASYNCQ          GET QUEUE ENTRY                      72970000
         LTR   R1,R1               ANYTHING IN QUEUE                    72971000
         BZ    AEOQ                BR IF NO                             72972000
         SPACE 1                                                     R4 72973000
         USING BUFDSECT,R1         PROVIDE BUFFER ADDRESSABILITY     R4 72974000
         SPACE 1                                                     R4 72975000
ANOK     L     WA,BUFCHAIN         POINT TO NEXT BUFFER                 72976000
         CS    R1,WA,$ASYNCQ       PULL BUFFER OFF THE QUEUE            72977000
         BNZ   ANOK                LOOP IF NOT OFF                      72978000
         LH    WA,$EXCPCT          DECREMENT                            72979000
         S     WA,AFONE             MASTER I/O COUNT                    72980000
         BM    E01                 ERROR IF NEGATIVE                    72981000
         STH   WA,$EXCPCT          UPDATE MASTER I/O COUNT              72982000
         EJECT                                                       R4 72983000
         MVC   BUFECBCC,IOBECBCC   SAVE CC FOR USER                  R4 72984000
         L     WA,BUFDCT           WA = DCT ASSOCIATED WITH BUFFER      72985000
         USING DCTDSECT,WA         ESTABLISH DCT ADDRESSABILITY         72986000
         SR    WB,WB               ZERO WB                              72987000
         IC    WB,DCTBUFCT         WB = DCT BUFFER COUNT                72988000
         S     WB,AFONE            DECREMENT BY ONE                     72989000
         BM    A01                 COUNT SHOULD NEVER GO MINUS          72990000
         STC   WB,DCTBUFCT         SET NEW BUFFER COUNT                 72991000
         L     WB,DCTPCE           USER PCE ADDRESS                     72992000
         CLI   DCTDEVTP,PCEDAWR    TEST FOR DIRECT ACCESS DCT           72993000
         BH    *+12                BR IF NO                             72994000
         LA    WB,PCEDADCT-PCEDSECT  GET DCT OFFSET WITHIN PCE          72995000
         SLR   WA,WB               GET PCE ADDRESS IN WA                72996000
         LR    WB,WA               THEN TRANSFER TO WB                  72997000
         DROP  WA                  KILL DCT ADDRESSABILITY              72998000
         L     WA,BUFEWF           GET USER EWF                         72999000
         LTR   WA,WA               *                                    73000000
         BM    AENTER              MINUS = ASYNC. EXIT                  73001000
         BZ    AFREE               ZERO  = NO ACTION                    73002000
        $TRACE                                                          73003000
         $POST (WA),IO             POST FOR I/O COMPLETION              73004000
         B     ALOOP               LOOP                                 73005000
         SPACE 1                                                     R4 73006000
AENTER   NULL                      REQ. FOR ASYNC. ENTRY                73007000
        $TRACE                                                          73008000
         DROP  BASE2               TO PREVENT LATER ERRORS              73009000
         L     BASE2,PCEBASE2-PCEDSECT(WB)   ESTABLISH USER ADDR        73010000
         BALR  R15,WA              ENTER USER                           73011000
         USING *,R15               ESTABLISH TEMPORARY ADDRESSABILITY   73012000
         L     BASE2,AA$ASYNC      RESET BASE2 FOR $ASYNC               73013000
         DROP  R15                 DROP TEMPORARY ADDRESSABILITY        73014000
         USING $ASYNC,BASE2        RE-ESTABLISH $ASYNC ADDRESSABILITY   73015000
         B     $ASYNC              AND GO AGAIN                         73016000
         EJECT                                                       R4 73017000
AFREE    NULL                                                           73018000
        $TRACE                                                          73019000
         CLI   BUFECBCC,X'7F'      TEST I/O COMPLETION CODE             73020000
         BE    AFREE1              BRANCH IF NO ERROR                   73021000
        $IOERROR (R1)              ERROR DETECTED                       73022000
         SPACE 1                                                     R4 73023000
AFREE1  $FREEBUF (R1)              FREE BUFFER                          73024000
         B     ALOOP               LOOP                                 73025000
         SPACE 1                                                     R4 73026000
AEOQ     NULL                      END OF CHAIN REACHED                 73027000
        $WAIT  WORK                WAIT                                 73028000
         B     ALOOP               LOOP                                 73029000
         SPACE 1                                                     R4 73030000
A01     $ERROR                     NEGATIVE DCT BUFFER COUNT DISCOVERED 73031000
         SPACE 1                                                     R4 73032000
E01     $ERROR                     NEGATIVE MASTER I/O COJNT            73033000
         SPACE 1                                                     R4 73034000
AFONE    DC    F'1'                CONSTANT                             73035000
AA$ASYNC DC    A($ASYNC)           ADDRESSABILITY CONSTANT              73036000
         SPACE 1                                                     R4 73037000
         DROP  R1                  KILL BUFFER ADDRESSABILITY           73038000
         DROP  BASE3               KILL CCA ADDRESSABILITY           R4 73039000
         SPACE 1                                                     R4 73040000
         LTORG                                                       R4 73041000
         TITLE 'HASP $TIMER PROCESSOR'                                  73042000
*********************************************************************** 73043000
*                                                                     * 73044000
* PROCESSOR NAME -- $TIMER                                            * 73045000
*                                                                     * 73046000
* DESCRIPTIVE NAME -- JES2 INTERVAL TIMER RESET PROCESSOR             * 73047000
*                                                                     * 73048000
* FUNCTION -- RESET THE INTERVAL TIMER AFTER A TIMER INTERRUPT        * 73049000
*                                                                     * 73050000
*********************************************************************** 73051000
         SPACE 5                                                        73052000
$TIMER  $ENTRY BASE=BASE2          PROVIDE PROCESSOR ENTRY POINT     R4 73053000
         SPACE 1                                                     R4 73054000
         L     WC,$SSVT            POINT TO SSVT               @OZ20010 73055000
         SPACE 1                                                     R4 73056000
TIMERL   MVI   $SVTIMER-SSVT(WC),0 RESET POST FLAGS            @OZ20010 73057000
         BAL   WA,IADJUST          POST COMPLETED STQE(S)               73058000
         BAL   WA,ISETINT          SET NEXT INTERVAL                    73059000
        $WAIT  WORK                WAIT FOR NEXT INTERVAL               73060000
         B     TIMERL              LOOP                        @OZ20010 73060100
         SPACE 2                                               @OZ20010 73060200
         DROP  BASE2               DROP PROCESSOR BASE REG     @OZ20010 73061000
*                                  THIS CARD DELETED BY APAR   @OZ20010 73062000
         TITLE 'HASP INTERVAL TIMER MANAGER'                   @OZ20010 73062100
***************************************************************@OZ20010 73062200
*                                                              @OZ20010 73062300
*        $STIMER - SET INTERVAL TIMER                          @OZ20010 73062400
*                                                              @OZ20010 73062500
*        R0    = WORK, UNPREDICTABLE ON EXIT                   @OZ20010 73062600
*        R1    = STQE ADDRESS, UNPREDICTABLE ON EXIT           @OZ20010 73062700
*        R11   = HCT ADDRESS (BASE1)                           @OZ20010 73062800
*        R14   = RETURN ADDRESS (LINK)                         @OZ20010 73062900
*                                  THIS CARD DELETED BY APAR   @OZ20010 73063000
*        R15   = WORK, UNPREDICTABLE ON EXIT                   @OZ20010 73064000
*                                                              @OZ20010 73064100
***************************************************************@OZ20010 73064200
         SPACE 1                                               @OZ20010 73064300
         USING $STIMER,WD          PROVIDE LOCAL ADDRESSABILITY@OZ20010 73064400
         ENTRY $STIMER             ENTRY POINT FOR $STIMER     @OZ20010 73064500
         CNOP  4,8                                             @OZ20010 73064600
$STIMER $TRACE                                                 @OZ20010 73064700
         ST    LINK,ITSAVE         SAVE                        @OZ20010 73064800
         STM   WA,WD,ITSAVE1        REGISTERS                  @OZ20010 73064900
         L     WD,$STIMERA         LOAD BASE ADDRESS           @OZ20010 73065000
         LA    WC,0(,R1)           SAVE PURIFIED STQE ADDRESS  @OZ20010 73065100
         LA    WB,ITCHAIN-ICHAIN   PREPARE TO SCAN STQE CHAIN  @OZ20010 73065200
         SPACE 1                                               @OZ20010 73065300
INXTTQE  LR    WA,WB               RELOAD STQE ADDRESS         @OZ20010 73065400
         L     WB,ICHAIN(,WB)      GET NEXT STQE               @OZ20010 73065500
         LTR   WB,WB               END OF STQE CHAIN...        @OZ20010 73065600
         BZ    ISETTQE             BR IF YES                   @OZ20010 73065700
         CR    WB,WC               IS THIS STQE OURS...        @OZ20010 73065800
         BNE   INXTTQE             BR IF NO                    @OZ20010 73065900
         MVC   ICHAIN(4,WA),ICHAIN(WB) DEQUEUE OUR STQE        @OZ20010 73066000
         SPACE 1                                               @OZ20010 73066100
ISETTQE  MVI   IPOST(R1),0         ZERO POST BIT               @OZ20010 73066200
         L     WB,ITIME(,R1)       GET REQD TIME IN SECOND     @OZ20010 73066300
         LCR   WB,WB               COMPLEMENT AND TEST         @OZ20010 73066400
         BP    *+8                 NO CONVERSION IF ORIGINALLY @OZ20010 73066500
         MH    WB,=H'-100'         CONVERT TO 100THS OF SECOND @OZ20010 73066600
         ST    WB,ITIME(,R1)       AND OVER STORE              @OZ20010 73066700
         LR    WC,R1               SAVE USERS TQE ADDRESS      @OZ20010 73066800
         BAL   WA,IADJUST          POST ANY EXPIRED STQE'S     @OZ20010 73066900
         L     R0,ITIME(,WC)       REQUESTED INTERVAL          @OZ20010 73067000
         LA    WA,ITCHAIN-ICHAIN   FAKE 1ST CHAIN              @OZ20010 73067100
         SPACE 1                                               @OZ20010 73067200
INEXT    L     R1,ICHAIN(,WA)      GET NEXT STQE               @OZ20010 73067300
         LTR   R1,R1               IS THIS END                 @OZ20010 73067400
         BZ    INSERT              BRANCH IF YES TO INSERT     @OZ20010 73067500
         CL    R0,ITIME(,R1)       IS REQUESTED INTERVAL LESS..@OZ20010 73067600
         BL    INSERT              THAN THIS... BRANCH IF YES  @OZ20010 73067700
         LR    WA,R1               NO... TO NEXT STQE          @OZ20010 73067800
         B     INEXT               FOR CHECK                   @OZ20010 73067900
         EJECT                                                 @OZ20010 73068000
         CNOP  0,8                                             @OZ20010 73068100
INSERT   ST    WC,ICHAIN(,WA)      INSERT INTO CHAIN           @OZ20010 73068200
         ST    R1,ICHAIN(,WC)      CONTINUE CHAIN              @OZ20010 73068300
         BAL   WA,ISETINT          GO START TIMER              @OZ20010 73068400
         SPACE 1                                               @OZ20010 73068500
IRETURN  L     LINK,ITSAVE         RESTORE                     @OZ20010 73068600
         LM    WA,WD,ITSAVE1        REGISTERS                  @OZ20010 73068700
         BR    LINK                  AND RETURN                @OZ20010 73068800
         EJECT                                                 @OZ20010 73068900
***************************************************************@OZ20010 73069000
*                                                              @OZ20010 73069100
*        $TTIMER - RETURN TIME REMAINING AND OPTIONALLY CANCEL @OZ20010 73069200
*                                                              @OZ20010 73069300
*        R0    = TIME REMAINING (IN SECONDS) ON EXIT           @OZ20010 73069400
*        R1    = STQE ADDRESS (COMPLEMENTED IF CANCEL REQD)    @OZ20010 73069500
*        R11   = HCT ADDRESS (BASE1)                           @OZ20010 73069600
*        R14   = RETURN ADDRESS (LINK)                         @OZ20010 73069700
*        R15   = WORK, UNPREDICTABLE ON EXIT                   @OZ20010 73069800
*                                                              @OZ20010 73069900
***************************************************************@OZ20010 73070000
         SPACE 1                                               @OZ20010 73070100
         ENTRY $TTIMER             ENTER POINT FOR $TTIMER     @OZ20010 73070200
         CNOP  2,8                                             @OZ20010 73070300
$TTIMER $TRACE                                                 @OZ20010 73070400
         ST    LINK,ITSAVE         SAVE                        @OZ20010 73070500
         STM   WA,WD,ITSAVE1        REGISTERS                  @OZ20010 73070600
         L     WD,$STIMERA         LOAD COMMON TIMER BASE ADDR @OZ20010 73070700
         LR    WC,R1               SAVE INPUT ADDRESS          @OZ20010 73070800
         L     WA,ITCHAIN          START OF CHAIN              @OZ20010 73070900
         LTR   R0,WA               IS IT ZERO                  @OZ20010 73071000
         BZ    IRETURN             YES... RETURN WITH NO TIME  @OZ20010 73071100
         BAL   WA,IADJUST          ADJUST INTERVALS            @OZ20010 73071200
         LPR   R1,WC               GET ADDRESS OF STQE         @OZ20010 73071300
         LA    WA,ITCHAIN-ICHAIN   FAKE STQE                   @OZ20010 73071400
         SPACE 1                                               @OZ20010 73071500
INEXT2   L     WB,ICHAIN(,WA)      GET NEXT                    @OZ20010 73071600
         LTR   R0,WB               IS THIS END                 @OZ20010 73071700
         BZ    IRET1               YES... RESTART AND RETURN   @OZ20010 73071800
         CR    WB,R1               NO... IS THIS RQSTED STQE   @OZ20010 73071900
         BE    IHERE               BRANCH IF YES               @OZ20010 73072000
         LR    WA,WB               UPDATE CHAIN                @OZ20010 73072100
         B     INEXT2              AND KEEP LOOKING            @OZ20010 73072200
         SPACE 1                                               @OZ20010 73072300
         CNOP  0,8                                             @OZ20010 73072400
IHERE    L     R0,ITIME(,WB)       GET TIME REMAINING          @OZ20010 73072500
         LTR   WC,WC               WAS CANCEL REQUESTED        @OZ20010 73072600
         BP    IRET1               BRA IF NO                   @OZ20010 73072700
         MVC   ICHAIN(4,WA),ICHAIN(WB)  YES... UNCHAIN         @OZ20010 73072800
         SPACE 1                                               @OZ20010 73072900
IRET1    LR    WC,R0               SAVE  R0                    @OZ20010 73073000
         BAL   WA,ISETINT          GO RESET TIMER              @OZ20010 73073100
         SR    WA,WA               CLEAR FOR DIVIDE            @OZ20010 73073200
         LR    WB,WC               TIME IN TIMER UNITS         @OZ20010 73073300
         LA    WC,100              CONVERSION FACTOR FOR SECS  @OZ20010 73073400
         DR    WA,WC               CONVERT                     @OZ20010 73073500
         SRL   WC,1                HALVE                       @OZ20010 73073600
         CR    WA,WC               CHECK FOR REMAINDER         @OZ20010 73073700
         LR    R0,WB               FOR USER                    @OZ20010 73073800
         BL    *+8                 BR IF REMAINDER LT 1/2 SEC  @OZ20010 73073900
         LA    R0,1(,WB)           OTHERWISE ROUND             @OZ20010 73074000
         B     IRETURN             AND EXIT                    @OZ20010 73074100
         SPACE 1                                               @OZ20010 73074200
         TITLE 'HASP INTERVAL TIMER MANAGER -- SUBROUTINES'    @OZ20010 73074300
*                                                              @OZ20010 73074400
*        SUBROUTINE TO SET SYSTEM TIMER TO LOWEST INTERVAL     @OZ20010 73074500
*                                                              @OZ20010 73074600
         SPACE 1                                               @OZ20010 73074700
         CNOP  0,8                                             @OZ20010 73074800
ISETINT  L     WD,$STIMERA         LOAD COMMON BASE            @OZ20010 73074900
         L     WB,ITCHAIN          GET FIRST STQE              @OZ20010 73075000
         CL    WB,ISTQE            TEST                        @OZ20010 73075100
         BER   WA                  RETURN IF ALREADY ACTIVE    @OZ20010 73075200
         ST    WB,ISTQE            SAVE ADDRESS OF ACTIVE STQE @OZ20010 73075300
         LTR   WB,WB               TEST AGAIN                  @OZ20010 73075400
         BZR   WA                  RETURN IF NO STQE           @OZ20010 73075500
         STIMER REAL,ITIMEUP,BINTVL=ITIME(,WB)  SET TIMER      @OZ20010 73075600
         BR    WA                  AND RETURN                  @OZ20010 73075700
         EJECT                                                 @OZ20010 73075800
*                                                              @OZ20010 73075900
*        SUBROUTINE TO POST PROCESSORS WHOSE TIME HAS EXPIRED  @OZ20010 73076000
*                                                              @OZ20010 73076100
         SPACE 1                                               @OZ20010 73076200
         CNOP  4,8                                             @OZ20010 73076300
IADJUST  L     WD,$STIMERA         RELOAD COMMON BASE          @OZ20010 73076400
         LM    R0,R1,ICLOCK        GET PREVIOUS CLOCK VALUE    @OZ20010 73076500
         STCK  ICLOCK              STORE CURRENT CLOCK         @OZ20010 73076600
         BCR   7,WA                RETURN IF CLOCK INVALID     @OZ20010 73076700
         LM    R14,R15,ICLOCK      GET CURRENT CLOCK           @OZ20010 73076800
         SLR   R14,R0              SUBTRACT                    @OZ20010 73076900
         SLR   R15,R1               PREVIOUS CLOCK             @OZ20010 73077000
         BNM   *+6                   TO GET                    @OZ20010 73077100
         BCTR  R14,0                  ELAPSED INTERVAL         @OZ20010 73077200
         LA    R14,0(,R14)         PREVENT DIVIDE CHECK        @OZ20010 73077300
         D     R14,=F'40960000'    CONVERT TO 100THS OF SECOND @OZ20010 73077400
         LA    WB,ITCHAIN-ICHAIN   FAKE 1ST STQE               @OZ20010 73077500
         SPACE 1                                               @OZ20010 73077600
IPOSTIT  L     WB,ICHAIN(,WB)      GET FIRST STQE              @OZ20010 73077700
         LTR   WB,WB               TEST                        @OZ20010 73077800
         BZR   WA                  RETURN IF DONE              @OZ20010 73077900
         L     R1,ITIME(,WB)       GET TIME                    @OZ20010 73078000
         SR    R1,R15              COMPUTE TIME INTERVAL       @OZ20010 73078100
         ST    R1,ITIME(,WB)       STORE TIME INTERVAL         @OZ20010 73078200
         BP    IPOSTIT             LOOP IF TIME NOT EXPIRED    @OZ20010 73078300
         SPACE 1                                               @OZ20010 73078400
         L     R1,IPOST(,WB)       OTHERWISE GET ADDR OF PCE   @OZ20010 73078500
         $POST (R1),WORK           AND POST IT                 @OZ20010 73078600
         MVI   IPOST(WB),X'80'     SHOW TIMER POST             @OZ20010 73078700
         MVC   ITCHAIN+1(3),ICHAIN+1(WB)     UPDATE STQE CHAIN @OZ20010 73078800
         B     IPOSTIT             AND CHECK NEXT...           @OZ20010 73078900
         SPACE 1                                               @OZ20010 73079000
*                                                              @OZ20010 73079100
*                        $STIMER STORAGE AND CONSTANTS         @OZ20010 73079200
*                                                              @OZ20010 73079300
         SPACE 1                                               @OZ20010 73079400
ICLOCK   DC    D'0'                LAST CLOCK VALUE            @OZ20010 73079500
ITSAVE   EQU   $CSAVREG,4          LINK REGISTER SAVE AREA     @OZ20010 73079600
ITSAVE1  EQU   $CSAVREG+4,16       REGISTERS WA-WD             @OZ20010 73079700
ITCHAIN  EQU   $TQEQUE                                         @OZ20010 73079800
         SPACE 2                                               @OZ20010 73079900
         DROP  WD                  DROP COMMON TIMER RTN BASE  @OZ20010 73080000
         TITLE 'HASP ASYNCHRONOUS TIMER INTERRUPT EXIT'        @OZ20010 73080100
*                                                              @OZ20010 73080200
*                        ASYNCHRONOUS TIMER EXIT ROUTINE       @OZ20010 73080300
*                                                              @OZ20010 73080400
         SPACE 1                                               @OZ20010 73080500
         CNOP  0,8                                             @OZ20010 73080600
ITIMEUP  NULL                                                  @OZ20010 73080700
         USING *,R15               SYSTEM PROVIDED BASE        @OZ20010 73080800
         STM   BASE1,R2,ISAVE      SAVE REGISTERS              @OZ20010 73080900
         L     BASE1,=A(HASP)      SWITCH                      @OZ20010 73081000
         LR    BASE2,R15            TO                         @OZ20010 73081100
         DROP  R15                   STANDARD                  @OZ20010 73081200
         USING ITIMEUP,BASE2          ADDRESSABILITY           @OZ20010 73081300
         XC    ISTQE,ISTQE         INDICATE NO ACTIVE TQE      @OZ20010 73081400
       $$POST   ELMT=$SVTIMER,R11=HCT $$POST TIMER PCE         @OZ20010 73081500
         LM    BASE1,R2,ISAVE      RESTORE REGISTERS           @OZ20010 73081600
         BR    R14                  AND RETURN                 @OZ20010 73081700
         SPACE 1                                               @OZ20010 73081800
         DROP  BASE2               DROP ADDRESSABLITY                   73081825
         SPACE 1                                                        73081875
ISAVE    DS    8F                  REGISTERS BASE1-R2          @OZ20010 73081900
ISTQE    DC    A(*-*)              ADDRESS OF ACTIVE STQE      @OZ20010 73082000
         SPACE 1                                               @OZ20010 73082100
         LTORG ,                   GENERATE LITERAL POOL       @OZ20010 73082200
   TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE BUILD ROUTINE' @OZ20010 73082300
***************************************************************@OZ20010 73082400
*                                                              @OZ20010 73082500
*        $#BLD - CONSTRUCT JOB OUTPUT ELEMENT (JOE)            @OZ20010 73082600
*                                                              @OZ20010 73082700
* INPUT  R0    - ADDRESS OF PERIPHERAL DATA DEFINITION BLOCK   @OZ20010 73082800
*        R1    - ADDRESS OF WORK AREA IN WHICH TO BUILD 2 JOES @OZ20010 73082900
*        R11   - HCT ADDRESS (BASE1)                           @OZ20010 73083000
*        R13   - PCE ADDRESS                                   @OZ20010 73083100
*        R14   - RETURN ADDRESS                                @OZ20010 73083200
*        R15   - JQE OFFSET IN BYTES                           @OZ20010 73083300
*                                                              @OZ20010 73083400
***************************************************************@OZ20010 73083500
         SPACE 1                                               @OZ20010 73083600
         ENTRY $#BLD               ENTRY FOR $#BLD ROUTINE     @OZ20010 73083700
         USING PDBDSECT,WA         PDDB ADDRESSABILITY         @OZ20010 73083800
         USING JOEDSECT,R1         JOE ADDRESSABILITY          @OZ20010 73083900
         USING $#BLD,R15           $#BLD ADDRESSABILITY        @OZ20010 73084000
         SPACE 1                                               @OZ20010 73084100
         CNOP  0,8                                             @OZ20010 73084200
$#BLD   $TRACE                                                 @OZ20010 73084300
         STM   WA,WD,PCEWA         SAVE WORK REGISTERS         @OZ20010 73084400
         LR    WA,R0               MAKE PDDB ADDRESSABLE       @OZ20010 73084500
         LR    WB,R15              SAVE JQE OFFSET             @OZ20010 73084600
         L     R15,$JOEBLD         LOAD $#BLD ADDRESSABILITY        R41 73085000
         XC    0(2*JOESIZE,R1),0(R1)  CLEAR JOE WORK AREA            R4 73089000
         SRL   WB,2                CONVERT JQE OFFSET TO WORD OFFSET R4 73090000
         STH   WB,JOEJQE           STORE JQE WORD OFFSET             R4 73091000
         TM    $PRTOPTS,$DMNDSET   IF DEMAND-SETUP                   R4 73092000
         BZ    BLD10                OPTION CHOSEN,                  R41 73093000
         OI    JOEFLAG2,$JOEDMND     THEN FLAG WORK-JOE              R4 73094000
         SPACE 1                                                    R41 73094500
BLD10    TM    PDBFLAG2,PDB2TCEL   SET TRACK-CELL'ED                R41 73095000
         BZ    BLD20                STATUS IF PDDB WAS              R41 73096000
         OI    JOEFLAG2,$JOETCEL     OF A TRACK-CELLED CLASS         R4 73097000
         SPACE 1                                                    R41 73097500
BLD20    MVC   JOESEC,PDBSEC       SET SECURITY ID                  R41 73098000
         IC    R0,PDBCLASS         GET OUTPUT CLASS FROM PDDB        R4 73099000
         STC   R0,JOEPDBCL         SET OUTPUT CLASS IN JOE 'CURRENT' R4 73100000
         STC   R0,JOECURCL          AND 'ORIGINAL' OUTPUT CLASS      R4 73101000
         LH    R0,PDBDEST          GET ROUTE CODE FROM PDDB          R4 73102000
         STH   R0,JOEROUT          SET ROUTE CODE IN JOE 'CURRENT'   R4 73103000
         STH   R0,JOEDEST           AND 'ORIGINAL' ROUTE FIELDS      R4 73104000
         LTR   R0,R0               TEST FOR EXPLICIT ROUTING         R4 73105000
         BNZ   BLDCPUID            BR IF YES                         R4 73106000
         EJECT                                                       R4 73107000
*********************************************************************** 73108000
*                                                                     * 73109000
*        ROUTING NOT SPECIFIED -- USE JOB ROUTING                     * 73110000
*                                                                     * 73111000
*********************************************************************** 73112000
         SPACE 1                                                     R4 73113000
         N     WB,=A(X'FFFF')      DEVELOP                           R4 73114000
         SLL   WB,2                 FULL JQE                         R4 73115000
         AL    WB,$JOBQPTR           ADDRESS                         R4 73116000
         L     R0,QUEPRTRT(,WB)    GET PRINT AND PUNCH ROUTE CODES   R4 73117000
         SLR   WB,WB               DEVELOP ADDRESS                   R4 73118000
         IC    WB,PDBCLASS          OF SCAT ENTRY                    R4 73119000
         AL    WB,$SSVT              FOR OUTPUT CLASS                R4 73120000
         TM    $SVSCAT-SSVT(WB),SCATPNCH  TEST FOR PUNCH CLASS       R4 73121000
         BO    SKIP100             BR IF YES                         R4 73122000
         SRL   R0,16                ELSE SHIFT OUT PUNCH ROUTE CODE  R4 73123000
SKIP100  STH   R0,JOEROUT          RESET JOE 'CURRENT' ROUTE FIELD   R4 73124000
         N     R0,=A(X'FFFF')      TEST 'CURRENT' ROUTE CODE         R4 73125000
         BNZ   BLDCPUID            BR IF NON-ZERO                    R4 73126000
         MVC   JOEROUT(1),$OWNSYS  SET 'CURRENT' ROUTE TO 'LOCAL'    R4 73130000
         SPACE 1                                                     R4 73132000
BLDCPUID MVC   JOECPU,PDBCPU       SET CPU ID                        R4 73133000
         SLR   R0,R0               CLEAR WORK REGISTER              R41 73133500
         SLR   WC,WC               CLEAR COPY-GROUPS SUM            R41 73133600
         LA    WD,8                SET MAX COPY-GROUPS              R41 73133700
         SPACE 1                                                    R41 73133800
BLDLOOP  IC    R0,PDBCOPYG-1(WD)   COMPUTE TOTAL                    R41 73133900
         ALR   WC,R0                COPY COUNT OF                   R41 73134000
         BCT   WD,BLDLOOP            3800 COPY-GROUPS               R41 73134100
         CLM   WC,1,PDBCOPYS       USE NORMAL                       R41 73134200
         BNL   BLDRECCT             COPY COUNT                      R41 73134300
         IC    WC,PDBCOPYS           IF LARGER                      R41 73134400
         SPACE 1                                                    R41 73134500
BLDRECCT L     WD,PDBRECCT         SET TOTAL                        R41 73134600
         MR    WC,WC                LINES/CARDS                     R41 73134700
         ST    WD,JOERECCT           IN WORK-JOE                    R41 73134800
         SPACE 1                                                    R41 73134900
         LA    R1,JOESIZE(,R1)     POINT TO CHARACTERISTICS JOE      R4 73135000
         MVC   JOEFORM(20),PDBFORMS  SET FORMS, FCB, UCS AND WTR IDS R4 73135100
         MVC   JOEFLASH,PDBFLASH   SET FLASH FRAME ID                R4 73136000
         TM    PDBFLAG2,PDB2BRST   SET                               R4 73137000
         BZ    BLDEXIT              BURST                           R41 73138000
         OI    JOECFLAG,$JOEBRST     CHARACTERISTIC                  R4 73139000
         SPACE 1                                                    R41 73139500
BLDEXIT  LM    WA,WD,PCEWA         RESTORE WORK REGISTERS           R41 73140000
         BR    LINK                 AND RETURN                       R4 73141000
         SPACE 1                                                     R4 73142000
         DROP  R1,WA,R15           KILL $#BLD ADDRESSABILITY         R4 73143000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE ADD ROUTINE'   R4 73144000
*********************************************************************** 73145000
*                                                                     * 73146000
*        $#ADD -- ADD JOE TO JOT                                      * 73147000
*                                                                     * 73148000
* INPUT  R0    - ADDRESS OF PROTOTYPE WORK JOE                        * 73149000
*        R1    - ADDRESS OF PROTOTYPE CHARACTERISTICS JOE             * 73150000
*        R11   - HCT ADDRESS (BASE1)                                  * 73151000
*        R13   - PCE ADDRESS                                          * 73152000
*        R14   - RETURN ADDRESS                                       * 73153000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 73154000
*                                                                     * 73155000
* OUTPUT       - CC     ZERO -- $#ADD SUCCESSFUL                      * 73156000
*              - CC NON-ZERO -- $#ADD UNSUCCESSFUL                    * 73157000
*                                                                     * 73158000
*********************************************************************** 73159000
         SPACE 1                                                     R4 73160000
JOE      EQU   WE                  JOE ADDRESS REGISTER              R4 73161000
JOT      EQU   WG                  JOT ADDRESS REGISTER              R4 73162000
         SPACE 1                                                     R4 73163000
         ENTRY $#ADD               PROVIDE ENTRY FOR $#ADD ROUTINE   R4 73164000
         USING JOEDSECT,JOE        PROVIDE JOE ADDRESSABILITY        R4 73165000
         USING JOTDSECT,JOT        PROVIDE JOT ADDRESSABILITY        R4 73166000
         USING $#ADD,BASE2         SET JOT SERVICES ADDRESSABILITY   R4 73167000
         SPACE 1                                                     R4 73168000
         CNOP  0,8                                                   R4 73169000
$#ADD    STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 73170000
        $QSUSE SAVE=NO             REQUEST ACCESS TO CHECKPOINT DATA R4 73171000
         L     JOT,$JOTABLE        LOAD JOB OUTPUT TABLE ADDRESS     R4 73172000
         L     BASE2,$JOEADD       LOAD JOT SERVICES ADDRESSABILITY  R4 73173000
         EJECT                                                       R4 73174000
*********************************************************************** 73175000
*                                                                     * 73176000
*        ENSURE SUFFICIENT JOES TO PROCESS REQUEST                    * 73177000
*                                                                     * 73178000
*********************************************************************** 73179000
         SPACE 1                                                     R4 73180000
         LH    R2,JOTFREC          NUMBER OF AVAILABLE JOE'S         R4 73181000
         BCTR  R2,R0               JOE FOR A CHAR-JOE                R4 73182000
         BCTR  R2,R0               JOE FOR A WORK-JOE                R4 73183000
         CH    R2,$MINJOES         BELOW MINIMUM FREE LIMIT...       R4 73184000
         BNL   ADDOK               BRANCH IF NO                      R4 73186000
         LM    WA,R12,PCEWA        RELOAD CALLER'S REGISTERS         R4 73190000
         BR    LINK                RETURN TO CALLER WITH NON-ZERO CC R4 73191000
         SPACE 1                                                     R4 73210000
*********************************************************************** 73211000
*                                                                     * 73212000
*        SCAN CHARACTERISTICS QUEUE FOR A MATCH WITH THIS REQUEST     * 73213000
*                                                                     * 73214000
*********************************************************************** 73215000
         SPACE 1                                                     R4 73216000
         CNOP  4,8                                                   R4 73217000
ADDOK    LH    JOE,JOTCHRQ         CHARACTERISTICS QUEUE 1ST DISPL   R4 73218000
         SPACE 1                                                     R4 73219000
ADCHQSCN N     JOE,=F'65535'       CLEAR LEFT HALFWORD               R4 73220000
         BZ    ADBLDC              BRANCH IF END OF QUEUE            R4 73221000
         SLL   JOE,2               EXPAND TO BYTE OFFSET             R4 73222000
         ALR   JOE,JOT             ADDRESS CHAR-JOE                  R4 73223000
         CLC   JOEFORM(JOEACTPR-JOEFORM),JOEFORM-JOEDSECT(R1)        R4 73224000
         BNE   ADCHQNXT            BR IF CHAR-JOE'S NOT MATCHING     R4 73225000
         TM    JOECFLAG-JOEDSECT(R1),$JOEBRST  VERIFY                R4 73226000
         BO    ADCHQBRS                         STACKER              R4 73227000
         TM    JOECFLAG,$JOEBRST                 SELECTION           R4 73228000
         BO    ADCHQNXT                           MATCHING           R4 73229000
         B     ADCHEHIT                            ON                R4 73230000
ADCHQBRS TM    JOECFLAG,$JOEBRST                    BOTH             R4 73231000
         BO    ADCHEHIT                              CHAR-JOE'S      R4 73232000
         SPACE 1                                                     R4 73233000
ADCHQNXT LH    JOE,JOENEXT         GET NEXT ELEMENT DISPL            R4 73234000
         B     ADCHQSCN            LOOP THROUGH CHAR QUEUE           R4 73235000
         EJECT                                                       R4 73236000
*********************************************************************** 73237000
*                                                                     * 73238000
*        GET A JOE IN WHICH TO BUILD A NEW CHAR-JOE                   * 73239000
*                                                                     * 73240000
*********************************************************************** 73241000
         SPACE 1                                                     R4 73242000
         CNOP  6,8                                                   R4 73243000
ADBLDC   BAL   WF,GETJOE           GET AN AVAILABLE JOE              R4 73244000
         LR    JOE,R3              RELOAD JOE ADDRESS                R4 73245000
         SPACE 1                                                     R4 73246000
*********************************************************************** 73247000
*                                                                     * 73248000
*        INITIALIZE NEW CHARACTERISTICS JOE WITH CALLER'S DATA        * 73249000
*                                                                     * 73250000
*********************************************************************** 73251000
         SPACE 1                                                     R4 73252000
         SLR   R3,R3               CLEAR REGISTER                    R4 73253000
         STH   R3,JOEUSE           CLEAR USE COUNT                   R4 73254000
         MVC   JOEFORM(JOEACTPR-JOEFORM),JOEFORM-JOEDSECT(R1)        R4 73255000
         MVI   JOECFLAG,0          CLEAR CHARACTERISTICS FLAG        R4 73256000
         TM    JOECFLAG-JOEDSECT(R1),$JOEBRST  SET FOR               R4 73257000
         BZ    SKIP120                          CONT. FORMS OR       R4 73258000
         OI    JOECFLAG,$JOEBRST                 BURSTED FORMS       R4 73259000
SKIP120  STH   R3,JOEACTPR         CLEAR ACTIVE DEVICE COUNTERS      R4 73260000
         LA    R2,JOTCHRQ-(JOENEXT-JOEDSECT)  PREPARE TO SCAN CHAR Q R4 73261000
         SPACE 1                                                     R4 73262000
ADCHSCN  LH    R3,JOENEXT-JOEDSECT(,R2)  DISPL OF NEXT CHAR-JOE      R4 73263000
         N     R3,=F'65535'        CLEAR LEFT HALFWORD               R4 73264000
         BZ    ADCHINS             BRANCH IF END OF QUEUE            R4 73265000
         SLL   R3,2                EXPAND TO BYTE OFFSET             R4 73266000
         ALR   R3,JOT              ADDRESS OF NEXT CHAR-JOE          R4 73267000
         CLC   JOEFORM(JOEACTPR-1-JOEFORM),JOEFORM-JOEDSECT(R3)      R4 73268000
         BL    ADCHINS             BRANCH IF SHOULD INSERT HERE      R4 73269000
         LR    R2,R3               STEP TO NEXT CHAR-QUEUE ENTRY     R4 73270000
         B     ADCHSCN             CONTINUE CHAR-QUEUE SCAN          R4 73271000
         SPACE 1                                                     R4 73272000
         CNOP  0,8                                                   R4 73273000
ADCHINS  LH    R4,JOENEXT-JOEDSECT(,R2)  GET OLD NEXT ENTRY          R4 73274000
         STH   R4,JOENEXT          STORE INTO NEW ELEMENT            R4 73275000
         LR    R4,JOE              COPY NEW ELEMENT ADDR             R4 73276000
         SLR   R4,JOT              OFFSET OF NEW ELEMENT             R4 73277000
         SRL   R4,2                REDUCE TO FULLWORD OFFSET         R4 73278000
         STH   R4,JOENEXT-JOEDSECT(,R2)  RECONNECT CHAR-JOE CHAIN    R4 73279000
         BAL   WF,CKPTJOEA         CKPT PREVIOUS CHAR-JOE            R4 73280000
         EJECT                                                       R4 73281000
*********************************************************************** 73282000
*                                                                     * 73283000
*        HAVE A CHARACTERISTICS JOE -- CHECKPOINT IT                  * 73284000
*                                                                     * 73285000
*********************************************************************** 73286000
         SPACE 1                                                     R4 73287000
ADCHEHIT LH    R2,JOEUSE           INCREMENT                         R4 73288000
         LA    R2,1(,R2)            CHAR-JOE                         R4 73289000
         STH   R2,JOEUSE             USE COUNT                       R4 73290000
         LR    R2,JOE              COPY CHAR-JOE ADDRESS             R4 73291000
         BAL   WF,CKPTJOEA         CKPT CHAR-JOE                     R4 73292000
         SPACE 1                                                     R4 73293000
*********************************************************************** 73294000
*                                                                     * 73295000
*        OBTAIN AND INITIALIZE NEW WORK-JOE                           * 73296000
*                                                                     * 73297000
*********************************************************************** 73298000
         SPACE 1                                                     R4 73299000
         BAL   WF,GETJOE           GET NEXT FREE JOE                 R4 73300000
         LR    JOE,R3              RELOAD JOE ADDRESS                R4 73301000
         LR    R3,R0               COPY WORK-JOE DATA ADDRESS        R4 73302000
         MVC   JOEDSECT(JOESIZE),0(R3)  USER SPECS TO WORK JOE       R4 73303000
         L     R14,$SSVT           POINT REG 14 TO PRIORITY         R41 73303100
         LA    R14,$SVXPRI-4-SSVT(,R14) CONVERSION TABLE IN SSVT    R41 73303200
         LA    R0,10               SET LOOP COUNTER (10 ENTRIES)    R41 73303300
         SPACE 1                                                    R41 73303400
ADPRILP  LA    R14,4(,R14)         BUMP TABLE POINTER               R41 73303500
         L     R15,0(,R14)         PICK UP PRTY/LINECOUNT,          R41 73303600
         LA    R15,0(,R15)           DELETE PRTY BYTE FOR COMP      R41 73303700
         CL    R15,JOERECCT        SEE IF RIGHT PRTY SLOT,          R41 73303800
         BNL   ADPRIGOT              EXIT LOOP IF SO                R41 73303900
         BCT   R0,ADPRILP          LOOP BACK                        R41 73304000
         SPACE 1                                                    R41 73304100
ADPRIGOT MVC   JOEPRIO,0(R14)      MOVE PRIORITY TO JOE             R41 73304200
         SRL   R2,2                REDUCE TO FULLWORD OFFSET         R4 73304300
         STH   R2,JOECHAR          SAVE CHAR-JOE POINTER             R4 73305000
         NI    JOEFLAG,$JOESPIN+$JOEHOLD  RESET ALL BUT SPIN, HOLD   R4 73306000
         SLR   R3,R3               CLEAR R3                          R4 73307000
         STH   R3,JOECKPT          CLEAR CHECKPOINT AREA POINTER     R4 73308000
         SPACE 1                                                     R4 73321000
ADCLS    IC    R3,JOECURCL         PICK UP CURRENT SYSOUT CLASS      R4 73322000
         IC    R3,CNVCLS-C'A'(R3)  LOAD CLASS QUEUE OFFSET           R4 73323000
         LA    R3,JOTCLSQ(R3)      POINT TO PROPER CLASS QUEUE       R4 73324000
         SPACE 1                                                     R4 73325000
*********************************************************************** 73326000
*                                                                     * 73327000
*        ADD WORK-JOE TO SELECTED QUEUE                               * 73328000
*                                                                     * 73329000
*********************************************************************** 73330000
         SPACE 1                                                     R4 73331000
ADADD    LH    R2,0(,R3)           FIRST QUEUE ENTRY                 R4 73332000
         STH   R2,JOENEXT          MAKE NEW JOE 1ST                  R4 73333000
         SLR   JOE,JOT             OFFSET OF WORK-JOE IN JOT         R4 73334000
         SRL   JOE,2               REDUCE TO FULLWORD OFFSET         R4 73335000
         STH   JOE,0(,R3)          ADD WORK-JOE TO HEAD OF QUEUE     R4 73336000
         EJECT                                                       R4 73337000
*********************************************************************** 73338000
*                                                                     * 73339000
*        INCREMENT JOE COUNTER IN HASP JOB QUEUE ELEMENT              * 73340000
*                                                                     * 73341000
*********************************************************************** 73342000
         SPACE 1                                                     R4 73343000
         USING JQEDSECT,R1         PROVIDE JQE ADDRESSABILITY        R4 73344000
         SPACE 1                                                     R4 73345000
         SLL   JOE,2               EXPAND TO BYTE OFFSET             R4 73346000
         LH    R1,JOEJQE(JOT)      JOB QUEUE ELEMENT OFFSET          R4 73347000
         N     R1,=F'65535'        CLEAR LEFT HALFWORD               R4 73348000
         SLL   R1,2                EXPAND TO FULL ADDRESS OFFSET     R4 73349000
         AL    R1,$JOBQPTR         ADD JOB QUEUE ORIGIN              R4 73350000
         LH    R3,JQEJOECT         INCREMENT                         R4 73351000
         LA    R3,1(,R3)            JOE COUNT                        R4 73352000
         STH   R3,JQEJOECT           FOR JOB                         R4 73353000
         LM    WA,WB,PCEWA         RESTORE REGS USED BY $QCKPT       R4 73354000
        $QCKPT (R1)                CKPT THE JOB QUEUE ELEMENT        R4 73355000
         SPACE 1                                                     R4 73356000
*********************************************************************** 73357000
*                                                                     * 73358000
*        POST PRINT/PUNCH ROUTINES WAITING FOR JOT SERVICE            * 73359000
*                                                                     * 73360000
*********************************************************************** 73361000
         SPACE 1                                                     R4 73362000
$#EXIT  $POST  $HASPECF,JOT        POST JOT SERVICES AVAILABLE       R4 73363000
         OI    $AQSE,QSEPJOT       INDICATE CROSS-SYSTEM $POST       R4 73364000
         LM    LINK,R12,PCELINK    RELOAD CALLER'S REGISTERS         R4 73365000
         CLI   $WTRWTCT,0          ANY EXTERNAL WRITERS WAITING...   R4 73366000
         BER   LINK                RETURN IF NO WITH CC = 0          R4 73367000
         BALR  R15,0                ELSE FIRST POST                  R4 73368000
         B     $#WTR-*(,R15)         WAITING WRITERS                 R4 73369000
         SPACE 1                                                     R4 73370000
         DROP  R1,JOE              KILL JQE, JOE ADDRESSABILITY      R4 73371000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE GET ROUTINE'   R4 73372000
*********************************************************************** 73373000
*                                                                     * 73374000
*        $#GET -- GET JOE FROM JOT                                    * 73375000
*                                                                     * 73376000
* INPUT  R1    - DCT ADDRESS                                          * 73377000
*        R11   - HCT ADDRESS (BASE1)                                  * 73378000
*        R13   - PCE ADDRESS                                          * 73379000
*        R14   - RETURN ADDRESS                                       * 73380000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 73381000
*                                                                     * 73382000
* OUTPUT R0    - CHARACTERISTICS JOE ADDRESS                          * 73383000
*        R1    - JOB QUEUE ELEMENT ADDRESS                            * 73384000
*        R15   - WORK JOE ADDRESS                                     * 73385000
*              - CC NON-ZERO -- $#GET SUCCESSFUL                      * 73386000
*              - CC     ZERO -- $#GET UNSUCCESSFUL                    * 73387000
*                                                                     * 73388000
* NOTES        - IF HIGH-ORDER BIT OF R1 ON AT ENTRY, ONLY CC VALID   * 73389000
*                ON EXIT (I.E. JOE NOT OBTAINED, IF PRESENT)          * 73390000
*                                                                     * 73391000
*********************************************************************** 73392000
         SPACE 1                                                     R4 73393000
         ENTRY $#GET               PROVIDE ENTRY FOR $#GET ROUTINE   R4 73394000
         USING JOEDSECT,JOE        PROVIDE JOE ADDRESSABILITY        R4 73395000
         USING $#GET,R15           PROVIDE LOCAL ADDRESSABILITY      R4 73396000
         SPACE 1                                                     R4 73397000
         CNOP  0,8                                                   R4 73398000
$#GET    STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 73399000
         LTR   R1,R1               GET IN HAVE = NO MODE...         R41 73400000
         BM    GTCKPT              BRANCH IF YES               @OZ20010 73401000
                                   PRINT OFF - SECTION DELETED @OZ20010 73401100
*                                  THIS CARD DELETED BY APAR   @OZ20010 73401200
*                                  THIS CARD DELETED BY APAR   @OZ20010 73401300
*                                  THIS CARD DELETED BY APAR   @OZ20010 73401400
*                                  THIS CARD DELETED BY APAR   @OZ20010 73401500
                                   PRINT ON  - SECTION DELETED @OZ20010 73401600
        $QSUSE SAVE=NO             REQUEST ACCESS TO CKPT DATA @OZ20010 73402000
         SPACE 1                                                     R4 73403000
GTCKPT   L     JOT,$JOTABLE        LOAD JOB OUTPUT TABLE ADDRESS     R4 73404000
         SPACE 1                                                     R4 73405000
         L     BASE2,$JOEADD       ESTABLISH ADDRESSABILITY TO       R4 73406000
         DROP  R15                  ALL JOT MANAGEMENT ROUTINES      R4 73407000
         EJECT                                                       R4 73408000
*********************************************************************** 73409000
*                                                                     * 73410000
*        RETURN IF HASP SYSTEM IS DRAINING ($P OR $PHASP)             * 73411000
*                                                                     * 73412000
*********************************************************************** 73413000
         SPACE 1                                                     R4 73414000
         TM    $STATUS,$DRAINED    IS HASP SYSTEM DRAINING...        R4 73415000
         BO    GTNOT               BRANCH IF YES                     R4 73416000
         SPACE 1                                                     R4 73417000
*********************************************************************** 73418000
*                                                                     * 73419000
*        ARE THERE ENOUGH AVAILABLE JOES TO COMPLETE THIS REQUEST...  * 73420000
*                                                                     * 73421000
*********************************************************************** 73422000
         SPACE 1                                                     R4 73423000
         LH    R2,JOTFREC          NUMBER OF AVAILABLE JOES          R4 73424000
         BCTR  R2,R0               JOE FOR A CHECKPOINT ELEMENT      R4 73425000
         LTR   R2,R2               IS FREE JOE QUEUE VOID...         R4 73426000
         BP    GETOK               BRANCH IF NO                      R4 73427000
         SPACE 1                                                     R4 73428000
*********************************************************************** 73429000
*                                                                     * 73430000
*        REQUEST MUST BE RETRYED LATER                                * 73431000
*                                                                     * 73432000
*********************************************************************** 73433000
         SPACE 1                                                     R4 73434000
GTNOT    LM    LINK,R12,PCELINK    RELOAD CALLER'S REGISTERS         R4 73435000
         SR    R15,R15             SET NON-PROCESS INDICATION        R4 73436000
         BR    LINK                RETURN TO CALLER                  R4 73437000
         EJECT                                                       R4 73438000
*********************************************************************** 73439000
*                                                                     * 73440000
*        SCAN WORK QUEUE(S) FOR PIECE OF WORK                         * 73441000
*                                                                     * 73442000
*********************************************************************** 73443000
         SPACE 1                                                     R4 73444000
         USING DCTDSECT,R5         PROVIDE DCT ADDRESSABILITY        R4 73445000
         SPACE 1                                                     R4 73446000
         CNOP  0,8                                                   R4 73447000
GETOK    LR    R5,R1               COPY DCT ADDRESS                  R4 73448000
         LA    R1,DCTCLASS         CLASS MASK ADDRESS                R4 73449000
         XC    PCER1,PCER1         CLEAR BEST CHOICE SLOT            R4 73450000
         MVI   PCER0,36            SET CLASS ORDER PRIORITY TO 36    R4 73451000
         SPACE 1                                                     R4 73464000
GTCLASS  CLI   0(R1),C' '          END OF CLASS MASK...              R4 73465000
         BE    GTCMEND             BRANCH IF YES                     R4 73466000
         SPACE 1                                                     R4 73467000
*********************************************************************** 73468000
*                                                                     * 73469000
*        CONVERT CLASS QUEUE ID TO CLASS QUEUE ADDRESS                * 73470000
*                                                                     * 73471000
*********************************************************************** 73472000
         SPACE 1                                                     R4 73473000
         SLR   R3,R3               CLEAR REGISTER                    R4 73474000
         IC    R3,0(,R1)           GET A CLASS ID FROM THE MASK      R4 73475000
         IC    R3,CNVCLS-C'A'(R3)  GET CLASS QUEUE OFFSET            R4 73476000
         LA    R3,JOTCLSQ-(JOENEXT-JOEDSECT)(R3)  CLASS QUEUE ADDR   R4 73477000
         LR    JOE,R3              COPY QUEUE ADDRESS TO JOE         R4 73478000
         SPACE 1                                                     R4 73479000
*********************************************************************** 73480000
*                                                                     * 73481000
*        SELECT A WORK-JOE FROM THE QUEUE                             * 73482000
*                                                                     * 73483000
*********************************************************************** 73484000
         SPACE 1                                                     R4 73485000
GTWKJOE  NI    PCER0,X'3F'         CLEAR PRIORITY BITS               R4 73486000
         LH    JOE,JOENEXT         SELECT NEXT WORK-JOE              R4 73487000
         N     JOE,=F'65535'       CLEAR LEFT HALFWORD               R4 73488000
         BNZ   GTJOEA              BRANCH IF NOT END OF QUEUE        R4 73489000
         LA    R1,1(,R1)           ADVANCE CLASS MASK POINTER        R4 73494000
         IC    JOE,PCER0           DECREMENT                         R4 73495000
         BCTR  JOE,0                CLASS ORDER                      R4 73496000
         STC   JOE,PCER0             PRIORITY                        R4 73497000
         B     GTCLASS             CONTINUE TO NEXT CLASS QUEUE      R4 73498000
         EJECT                                                       R4 73499000
*********************************************************************** 73500000
*                                                                     * 73501000
*        TRY TO DISQUALIFY THIS JOE FROM SELECTION                    * 73502000
*                                                                     * 73503000
*********************************************************************** 73504000
         SPACE 1                                                     R4 73505000
         CNOP  0,8                                                   R4 73506000
GTJOEA   STH   JOE,PCER0+2         SAVE WORK-JOE DISPL               R4 73507000
         SLL   JOE,2               EXPAND TO BYTE OFFSET             R4 73508000
         ALR   JOE,JOT             ADD JOB OUTPUT TABLE ORIGIN       R4 73509000
         TM    JOEFLAG,$JOEBUSY    IS THIS WORK-JOE BUSY...          R4 73510000
         BNZ   GTWKJOE             BRANCH IF YES - REJECT            R4 73511000
         LH    R2,JOEJQE           JOB QUEUE ELEMENT OFFSET          R4 73512000
         N     R2,=F'65535'        CLEAR LEFT HALFWORD               R4 73513000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 73514000
         AL    R2,$JOBQPTR         ADD JOB QUEUE ORIGIN              R4 73515000
         SPACE 1                                                     R4 73516000
         USING JQEDSECT,R2         PROVIDE JQE ADDRESSABILITY        R4 73517000
         SPACE 1                                                     R4 73518000
         TM    JQEFLAGS,QUEHOLDA+QUEHOLD1  IS JOB HELD...            R4 73519000
         BNZ   GTWKJOE             BRANCH IF YES - REJECT            R4 73520000
         MVI   PCER0+1,X'FF'       PRESET MAX PRIORITY              R41 73521000
*              THIS LINE DELETED BY APAR NUMBER                @OZ27490 73521100
*              THIS LINE DELETED BY APAR NUMBER                @OZ27490 73521200
         SLR   R14,R14             LOAD PRIORITY                    R41 73521300
         IC    R14,JOEPRIO           FROM JOE                       R41 73521400
         LA    R15,1*16            USE '1' FOR                      R41 73521500
         CLI   JQETYPE,$HARDCPY      JQE PRIORITY                   R41 73521600
         BNE   GTJOEP1             IF JOB STILL EXECUTING      @OZ25785 73521700
         TM    JQEPRIO,X'F0'       TEST FOR JQE PRIORITY = 15, @OZ27490 73521720
         BO    GTJOEP2               BRANCH AROUND IF SO       @OZ27490 73521740
         IC    R15,JQEPRIO         LOAD PRIORITY FROM JQE           R41 73521800
         SPACE 1                                                    R41 73521900
GTJOEP1  ALR   R14,R15             ADD JQE AND JOE PRIORITIES,      R41 73522000
         SRL   R14,1                 MAKE SURE SUM FITS IN 1 BYTE,  R41 73522100
         STC   R14,PCER0+1           SAVE RESULT                    R41 73522200
         SPACE 1                                                    R41 73522300
GTJOEP2  DS    0H                  END OF PRIORITY COMPUTATION      R41 73522400
         SPACE 1                                                     R4 73522500
*********************************************************************** 73523000
*                                                                     * 73524000
*        CHECK ROUTE, CPU ID, SECURITY                                * 73525000
*                                                                     * 73526000
*********************************************************************** 73527000
         SPACE 1                                                     R4 73528000
         CLC   DCTNO,JOEROUT       DOES DS ROUTE MATCH DEVICE...     R4 73548000
         BNE   GTWKJOE             BRANCH IF NO                      R4 73550000
         LH    R15,JOECHAR         CHAR-JOE DISPL                    R4 73551000
         N     R15,=F'65535'       CLEAR LEFT HALFWORD               R4 73552000
         SLL   R15,2               EXPAND TO BYTE OFFSET             R4 73553000
         ALR   R15,JOT             ADD JOB OUTPUT TABLE ORIGIN       R4 73554000
         SPACE 1                                                     R4 73555000
         DROP  R2                  KILL JQE ADDRESSABILITY           R4 73556000
         EJECT                                                       R4 73557000
*********************************************************************** 73558000
*                                                                     * 73559000
*        CHECK EXTERNAL WRITER NAME                                   * 73560000
*                                                                     * 73561000
*********************************************************************** 73562000
         SPACE 1                                                     R4 73563000
         USING JOEDSECT,R15        PROVIDE TEMP JOE ADDRESSABILITY   R4 73564000
         SPACE 1                                                     R4 73565000
GTNEXT   CLI   JOEWTRID,X'40'      EXTERNAL WRITER NAME...           R4 73566000
         BNE   GTWKJOE             BRANCH IF YES                     R4 73567000
         SPACE 1                                                     R4 73568000
*********************************************************************** 73569000
*                                                                     * 73570000
*        CHECK FORMS ID                                               * 73571000
*                                                                     * 73572000
*********************************************************************** 73573000
         SPACE 1                                                     R4 73574000
         CLC   DCTFORMS,JOEFORM    FORMS MATCH...                    R4 73575000
         BNE   GTNOMCH             BRANCH IF NO                      R4 73576000
         SPACE 1                                                     R4 73577000
         TM    DCTPPSW2,DCTNIPRT   CHECK FOR NON-IMPACT PRINTER      R4 73578000
         BO    GTNIPRT             BRANCH IF YES                     R4 73579000
         SPACE 1                                               @OZ25970 73579200
         TM    DCTDEVTP,DCTPUN     IS DEVICE A PUNCH...        @OZ25970 73579400
         BO    GTMATCH             BR. YES, NO UCS/FCB CHECK.  @OZ25970 73579600
         SPACE 1                                                     R4 73580000
*********************************************************************** 73581000
*                                                                     * 73582000
*        CHECK FCB ID, UCS ID -- FOR IMPACT PRINTERS                  * 73583000
*                                                                     * 73584000
*********************************************************************** 73585000
         SPACE 1                                                     R4 73586000
         CLC   DCTFCB,JOEFCB       FCB MATCH...                      R4 73587000
         BE    GTUCS               BRANCH IF YES                     R4 73588000
         CLC   JOEFCB,=C'****'     STANDARD FCB...                   R4 73589000
         BNE   GTNOMCH             BRANCH IF NO                      R4 73590000
         TM    DCTPPSW,DCTPPSWB    IS DEVICE FCB STANDARD...         R4 73591000
         BO    GTNOMCH             BRANCH IF NO                      R4 73592000
         SPACE 1                                                     R4 73593000
GTUCS    CLC   DCTUCS,JOEUCS       UCS MATCH...                      R4 73594000
         BE    GTMATCH             BRANCH IF YES                     R4 73595000
         CLC   JOEUCS,=C'****'     STANDARD UCS...                   R4 73596000
         BNE   GTNOMCH             BRANCH IF NO                      R4 73597000
         TM    DCTPPSW,DCTPPSWU    IS DEVICE UCS STANDARD...         R4 73598000
         BO    GTNOMCH             BRANCH IF NO                      R4 73599000
         SPACE 1                                                     R4 73600000
GTMATCH  OI    PCER0,X'80'         SET MATCH PRIORITY BIT            R4 73601000
         B     GTPRIO              GO COMPARE PRIORITIES             R4 73602000
         EJECT                                                       R4 73603000
*********************************************************************** 73604000
*                                                                     * 73605000
*        CHECK FLASH FRAME ID, BURSTING -- FOR NON-IMPACT PRINTERS    * 73606000
*                                                                     * 73607000
*********************************************************************** 73608000
         SPACE 1                                                     R4 73609000
GTNIPRT  CLC   DCTFLASH,JOEFLASH   FLASH MATCH...                    R4 73610000
         BNE   GTNOMCH             BR IF NO                          R4 73611000
         TM    JOECFLAG,$JOEBRST   CHECK                             R4 73612000
         BZ    SKIP130              BURST                            R4 73613000
         TM    DCTPPSW2,DCTNIBRS     SPECIFICATION                   R4 73614000
         BZ    GTNOMCH                AGAINST                        R4 73615000
         B     GTNIPMCH                CURRENT                       R4 73616000
SKIP130  TM    DCTPPSW2,DCTNIBRS        BURSTER                      R4 73617000
         BO    GTNOMCH                   STATUS                      R4 73618000
         SPACE 1                                                     R4 73619000
GTNIPMCH OI    PCER0,X'80'         SET MATCH PRIORITY BIT            R4 73620000
         CLC   DCTFCB,JOEFCB       ADDITIONALLY, FCB MATCH...        R4 73621000
         BNE   GTPRIO              BRANCH IF NO                      R4 73622000
         OI    PCER0,X'40'         SET HI-PRIORITY MATCH BIT         R4 73623000
         B     GTPRIO              GO COMPARE PRIORITIES             R4 73624000
         SPACE 1                                                     R4 73625000
*********************************************************************** 73626000
*                                                                     * 73627000
*        NO MATCH FOUND -- CHECK FOR AUTOMATIC MODE                   * 73628000
*                                                                     * 73629000
*********************************************************************** 73630000
         SPACE 1                                                     R4 73631000
         CNOP  0,8                                                   R4 73632000
GTNOMCH  TM    DCTPPSW,DCTPPSWF    IS DEVICE IN AUTO MODE...         R4 73633000
         BO    GTWKJOE             BRANCH IF NO - REJECT             R4 73634000
         TM    DCTDEVTP,DCTLNE     IS REQUESTOR REMOTE...            R4 73635000
         BO    GTPRIO              BRANCH IF YES                     R4 73636000
         LA    R3,JOEACTPR         ASSUME PRINTER                    R4 73637000
         TM    DCTDEVTP,DCTPUN     IS REQUEST FOR A PUNCH...         R4 73638000
         BNO   SKIP140             BRANCH IF NO                      R4 73639000
         LA    R3,JOEACTPU         SET PUNCH                         R4 73640000
SKIP140  CLI   0(R3),X'00'         IS ANY DEVICE ACTIVE...           R4 73641000
         BNE   SKIP150             BRANCH IF YES                     R4 73642000
         OI    PCER0,X'40'         SET NOT IN USE PRIORITY BIT       R4 73643000
SKIP150  CLC   $STDFORM,JOEFORM    IS THIS STANDARD                  R4 73644000
         BE    GTPRIO              BRANCH IF YES                     R4 73645000
         TM    PCER0,X'40'         NON-STD IN USE...                 R4 73646000
         BZ    GTWKJOE             BRANCH IF YES - REJECT            R4 73647000
         SPACE 1                                                     R4 73648000
         DROP  R15                 KILL TEMP JOE ADDRESSABILITY      R4 73649000
         EJECT                                                       R4 73650000
*********************************************************************** 73651000
*                                                                     * 73652000
*        IS CURRENT PRIORITY GE PREVIOUS BEST CHOICE...               * 73653000
*                                                                     * 73654000
*********************************************************************** 73655000
         SPACE 1                                                     R4 73656000
GTPRIO   LR    R3,R1               PUT CLASS POINTER IN R3           R4 73657000
         SPACE 1                                                     R4 73658000
GTNPRIO  CLC   PCER0(2),PCER1      IS CURRENT A BETTER CHOICE...     R4 73659000
         BL    GTWKJOE             BRANCH IF NO - REJECT             R4 73660000
         L     R3,PCER0            TAKE CURRENT WORK-JOE             R4 73661000
         ST    R3,PCER1            AS NEW BEST CHOICE                R4 73662000
         B     GTWKJOE             CONTINUE SCAN OF CLASS QUEUES     R4 73663000
         SPACE 1                                                     R4 73664000
*********************************************************************** 73665000
*                                                                     * 73666000
*        END OF QUEUE SCANNING - HAVE WE SELECTED NEW WORK...         * 73667000
*                                                                     * 73668000
*********************************************************************** 73669000
         SPACE 1                                                     R4 73670000
         CNOP  0,8                                                   R4 73671000
GTCMEND  OC    PCER1,PCER1         IS BEST CHOICE CELL ZERO...       R4 73672000
         BZ    GTNOT               BRANCH IF YES - NO WORK           R4 73673000
         LH    JOE,PCER1+2         GET BEST CHOICE JOE DISPL         R4 73674000
         N     JOE,=F'65535'       CLEAR LEFT HALFWORD               R4 73675000
         SLL   JOE,2               EXPAND TO BYTE OFFSET             R4 73676000
         ALR   JOE,JOT             ADD JOB OUTPUT TABLE ORIGIN       R4 73677000
         LH    R2,JOECHAR          CHAR-JOE DISPL                    R4 73678000
         N     R2,=F'65535'        CLEAR LEFT HALFWORD               R4 73679000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 73680000
         LA    R0,0(R2,JOT)        CHAR-JOE ADDR TO RETURN REG       R4 73681000
         LH    R1,JOEJQE           RETURN                            R4 73682000
         N     R1,=F'65535'         JQE                              R4 73683000
         SLL   R1,2                  ADDRESS                         R4 73684000
         AL    R1,$JOBQPTR            IN R1                          R4 73685000
         LTR   R5,R5               TEST FOR HAVE = NO MODE           R4 73686000
         BM    GTEST               BR IF YES TO JUST TEST FOR JOE    R4 73687000
         ST    R1,PCEJQE            ELSE STORE JQE ADDR IN PCE @OZ32566 73687100
         TM    DCTDEVTP,DCTLNE     IS REQUESTOR REMOTE...            R4 73689000
         BNZ   GTRMT               BRANCH IF YES                     R4 73694000
         NI    JOEFLAG,255-$JOEPRT-$JOEPUN  RESET TYPE FLAGS         R4 73695000
         OI    JOEFLAG,$JOEPRT     SET PRINT TYPE                    R4 73696000
         LA    R4,JOEACTPR-JOEDSECT(R2,JOT)  ASSUME PRINTER          R4 73697000
         TM    DCTDEVTP,DCTPUN     IS REQUEST FOR A PUNCH...         R4 73698000
         BNO   GTPRT               BRANCH IF NO                      R4 73699000
         NI    JOEFLAG,255-$JOEPRT-$JOEPUN   RESET TYPE FLAGS        R4 73700000
         OI    JOEFLAG,$JOEPUN     SET PUNCH TYPE                    R4 73701000
         LA    R4,JOEACTPU-JOEDSECT(R2,JOT)  SET PUNCH               R4 73702000
         SPACE 1                                                     R4 73703000
GTPRT    SLR   R3,R3               CLEAR REGISTER                    R4 73704000
         IC    R3,0(,R4)           INCREMENT                         R4 73705000
         LA    R3,1(,R3)            ACTIVE DEVICE                    R4 73706000
         STC   R3,0(,R4)             COUNT                           R4 73707000
         BAL   WF,CKPTJOE          CKPT CHAR-JOE                     R4 73708000
         EJECT                                                       R4 73709000
GTRMT    MVC   JOEDEVID,DCTDEVID   MOVE DEVICE ID TO WORK-JOE        R4 73710000
         OC    JOEFLAG,$SIDBUSY    SET WORK JOE BUSY/SYSTEM ID       R4 73711000
         LR    R2,JOE              RELOAD WORK-JOE ADDRESS           R4 73712000
         BAL   WF,CKPTJOEA         CKPT WORK-JOE                     R4 73713000
         CLC   JOECKPT,=H'0'       IS CKPT-JOE PTR ZERO...           R4 73714000
         BNZ   GTHOT               BRANCH IF NO                      R4 73715000
         BAL   WF,GETJOE           GET A FREE JOE                    R4 73716000
         SLR   R3,JOT              REDUCE TO BYTE OFFSET             R4 73717000
         SRL   R3,2                REDUCE TO FULLWORD OFFSET         R4 73718000
         STH   R3,JOECKPT          ASSIGN CKPT-JOE                   R4 73719000
         SPACE 1                                                     R4 73720000
*********************************************************************** 73721000
*                                                                     * 73722000
*        INVOKE CHECKPOINT OF JOB OUTPUT TABLE                        * 73723000
*                                                                     * 73724000
*********************************************************************** 73725000
         SPACE 1                                                     R4 73726000
GTHOT   $POST  $HASPECF,CKPW       $POST CHECKPOINT WRITER           R4 73727000
         SPACE 1                                                     R4 73728000
GTEST    LTR   R15,JOE             RELOAD WORK JOE ADDR, SET CC      R4 73729000
         L     LINK,PCELINK        RESTORE RETURN REGISTER           R4 73730000
         LM    WA,R12,PCEWA        RELOAD CALLER'S REGISTERS         R4 73731000
         BR    LINK                RETURN TO CALLER                  R4 73732000
         SPACE 1                                                     R4 73733000
         DROP  R5,JOE              KILL DCT, JOE ADDRESSABILITY      R4 73734000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE PUT ROUTINE'   R4 73735000
*********************************************************************** 73736000
*                                                                     * 73737000
*        $#PUT -- RETURN JOE TO JOT                                   * 73738000
*                                                                     * 73739000
* INPUT  R0    - CHECKPOINT JOE ADDRESS OR ZERO                       * 73740000
*        R1    - WORK JOE ADDRESS                                     * 73741000
*        R11   - HCT ADDRESS (BASE1)                                  * 73742000
*        R13   - PCE ADDRESS                                          * 73743000
*        R14   - RETURN ADDRESS                                       * 73744000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 73745000
*                                                                     * 73746000
*********************************************************************** 73747000
         SPACE 1                                                     R4 73748000
         ENTRY $#PUT               PROVIDE ENTRY FOR $#PUT ROUTINE   R4 73749000
         USING JOEDSECT,R1         PROVIDE JOE ADDRESSABILITY        R4 73750000
         SPACE 1                                                     R4 73751000
         CNOP  0,8                                                   R4 73752000
$#PUT    STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 73753000
        $QSUSE SAVE=NO             REQUEST ACCESS TO CHECKPOINT DATA R4 73754000
         L     JOT,$JOTABLE        LOAD JOB OUTPUT TABLE ADDRESS     R4 73755000
         L     BASE2,$JOEADD       LOAD JOT SERVICES ADDRESSABILITY  R4 73756000
         SPACE 1                                                     R4 73757000
*********************************************************************** 73758000
*                                                                     * 73759000
*        DECREMENT ACTIVE DEVICE COUNTER FOR THIS CHAR-JOE            * 73760000
*                                                                     * 73761000
*********************************************************************** 73762000
         SPACE 1                                                     R4 73763000
         LR    R2,R1               RELOAD WORK-JOE ADDRESS           R4 73764000
         BAL   WF,CKPTJOEA         CKPT WORK-JOE                     R4 73765000
        $POST  $HASPECF,CKPW       $POST CHECKPOINT WRITER           R4 73766000
         TM    PCEID,PCELCLID      IS REQUEST FOR A REMOTE DEVICE... R4 73767000
         BNO   PTRMT               BRANCH IF YES                     R4 73768000
         LH    R2,JOECHAR          CHAR-JOE DISPL                    R4 73769000
         N     R2,=F'65535'        CLEAR LEFT HALFWORD               R4 73770000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 73771000
         LA    R4,JOEACTPR-JOEDSECT(R2,JOT)  ASSUME PRINTER          R4 73772000
         TM    PCEID,PCEPRSID      IS REQUESTOR A PRINTER...         R4 73773000
         BO    SKIP160             BRANCH IF YES                     R4 73774000
         LA    R4,JOEACTPU-JOEDSECT(R2,JOT)  SET PUNCH               R4 73775000
SKIP160  SLR   R3,R3               CLEAR REGISTER                    R4 73776000
         IC    R3,0(,R4)           DECREMENT                         R4 73777000
         BCTR  R3,R0                ACTIVE DEVICE                    R4 73778000
         STC   R3,0(,R4)             COUNT                           R4 73779000
         EJECT                                                       R4 73780000
*********************************************************************** 73781000
*                                                                     * 73782000
*        CHECKPOINT THE CHARACTERISTICS JOE                           * 73783000
*                                                                     * 73784000
*********************************************************************** 73785000
         SPACE 1                                                     R4 73786000
         BAL   WF,CKPTJOE          CKPT CHAR-JOE                     R4 73787000
         SPACE 1                                                     R4 73788000
*********************************************************************** 73789000
*                                                                     * 73790000
*        RESET CKPT-JOE VALID FLAG AND FREE CKPT-JOE IF PRC ABSENT    * 73791000
*                                                                     * 73792000
*********************************************************************** 73793000
         SPACE 1                                                     R4 73794000
PTRMT    NI    JOEFLAG,255-$JOEBUSY  RESET WORK-JOE BUSY FLAG        R4 73795000
         LTR   R2,R0               WAS CKPT-JOE SPECIFIED...         R4 73796000
         BNZ   PTPRC               BRANCH IF YES                     R4 73797000
         NI    JOEFLAG,255-$JOECKV RESET CKPT-JOE VALID FLAG         R4 73798000
         LH    R2,JOECKPT          DISPL OF CKPT-JOE                 R4 73799000
         N     R2,=F'65535'        CLEAR LEFT HALFWORD               R4 73800000
         BZ    $#EXIT              EXIT IF NO CKPT-JOE               R4 73801000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 73802000
         BAL   WF,FREEJOE          ADD JOE TO FREE QUEUE             R4 73803000
         XC    JOECKPT,JOECKPT     CLEAR POINTER                     R4 73804000
         B     $#EXIT              BR TO ALERT WAITING PROCESSORS    R4 73805000
         SPACE 1                                                    R41 73805100
         USING JOEDSECT,R2         ALTER JOE ADDRESSABILITY         R41 73805200
         SPACE 1                                                     R4 73806000
         CNOP  0,8                                                   R4 73807000
PTPRC    SLR   WF,WF               CLEAR JOE                        R41 73808000
         ST    WF,JOETLNC           LINE AND                        R41 73808500
         ST    WF,JOETPCT            PAGE COUNTS                    R41 73809000
         MVI   JOETNDS,0           CLEAR JOE DATA SET COUNT         R41 73809500
         BAL   WF,CKPTJOEA         CKPT CKPT-JOE                     R4 73810000
         ALR   R2,JOT              RESTORE CKPT JOE ADDRESS    @OZ27207 73810050
         L     R4,JOECRECN         GET NO. RECORDS PROCESSED        R41 73810100
         LR    R2,R1               ADDRESS WORK-JOE AGAIN           R41 73810200
         L     R3,JOERECCT         COMPUTE NO. RECORDS STILL        R41 73810300
         SR    R3,R4                TO BE PRINTED/PUNCHED           R41 73810400
         BM    $#EXIT              IGNORE IF NEGATIVE               R41 73810500
         L     R14,$SSVT           POINT TO OUTPUT                  R41 73810600
         LA    R14,$SVXPRI-SSVT-4(,R14)  PRIORITY TABLE             R41 73810700
         LA    R0,10               SET LOOP COUNTER                 R41 73810800
         SPACE 1                                                    R41 73810900
PTLOOP   LA    R14,4(,R14)         BUMP TABLE POINTER               R41 73811000
         L     R15,0(,R14)         PICK UP TABLE ENTRY              R41 73811100
         LA    R15,0(,R15)         DELETE PRIORITY BYTE             R41 73811200
         CLR   R15,R3              CHECK FOR CORRECT SLOT           R41 73811300
         BNL   PTPRIO              BR IF YES                        R41 73811400
         BCT   R0,PTLOOP            ELSE LOOP                       R41 73811500
         SPACE 1                                                    R41 73811600
PTPRIO   MVC   JOEPRIO,0(R14)      MOVE PRIORITY TO JOE             R41 73811700
         B     $#EXIT              BR TO ALERT WAITING PROCESSORS    R4 73811800
         SPACE 1                                                     R4 73812000
         DROP  R1,R2               KILL JOE ADDRESSABILITYT         R41 73813000
        TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE REMOVE ROUTINE' R4 73897000
*********************************************************************** 73898000
*                                                                     * 73899000
*        $#REM -- REMOVE A JOE FROM THE JOT                           * 73900000
*                                                                     * 73901000
*        R0    - WORK, UNPREDICTABLE ON EXIT                          * 73902000
*        R1    - WORK JOE ADDRESS, UNPREDICTABLE ON EXIT              * 73903000
*        R11   - HCT ADDRESS (BASE1)                                  * 73904000
*        R13   - PCE ADDRESS                                          * 73905000
*        R14   - RETURN ADDRESS                                       * 73906000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 73907000
*                                                                     * 73908000
*********************************************************************** 73909000
         SPACE 1                                                     R4 73910000
         ENTRY $#REM               PROVIDE ENTRY FOR $#REM ROUTINE   R4 73911000
         USING JOEDSECT,JOE        PROVIDE JOE ADDRESSABILITY        R4 73912000
         SPACE 1                                                     R4 73913000
         CNOP  0,8                                                   R4 73914000
$#REM    STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 73915000
        $QSUSE SAVE=NO             REQUEST ACCESS TO CHECKPOINT DATA R4 73916000
         L     JOT,$JOTABLE        LOAD JOB OUTPUT TABLE ADDRESS     R4 73917000
         L     BASE2,$JOEADD       LOAD JOT SERVICES ADDRESSABILITY  R4 73918000
         LR    JOE,R1              RELOAD WORK-JOE ADDRESS           R4 73919000
         SPACE 1                                                     R4 73920000
*********************************************************************** 73921000
*                                                                     * 73922000
*        LOCATE HEAD OF WORK QUEUE FOR WORK-JOE                       * 73923000
*                                                                     * 73924000
*********************************************************************** 73925000
         SPACE 1                                                     R4 73926000
         SLR   R3,R3               CLEAR FOR INSERT                  R4 73936000
         IC    R3,JOECURCL         GET CURRENT SYSOUT CLASS          R4 73937000
         IC    R3,CNVCLS-C'A'(R3)  GET CLASS QUEUE OFFSET            R4 73938000
         LA    R3,JOTCLSQ(R3)      ADD CLASS QUEUE ORIGIN            R4 73939000
         EJECT                                                       R4 73940000
*********************************************************************** 73941000
*                                                                     * 73942000
*        LOCATE ADDRESS OF PRECEEDING WORK-JOE                        * 73943000
*                                                                     * 73944000
*********************************************************************** 73945000
         SPACE 1                                                     R4 73946000
RMWORKB  LA    R2,0(,JOE)          OFFSET OF                         R4 73947000
         SLR   R2,JOT               WORK-JOE IN JOT                  R4 73948000
         SLR   R3,JOT              OFFSET OF QUEUE IN JOT            R4 73949000
         LH    R4,0(R3,JOT)        DISPL OF 1ST JOE IN QUEUE         R4 73950000
         SPACE 1                                                     R4 73951000
         CNOP  0,8                                                   R4 73952000
RMWQSCN  N     R4,=F'65535'        CLEAR LEFT HALFWORD               R4 73953000
         SLL   R4,2                EXPAND TO BYTE OFFSET             R4 73954000
         CLR   R2,R4               IS NEXT JOE TO BE FREED...        R4 73955000
         BE    RMWKEL              BRANCH IF YES                     R4 73956000
         LR    R3,R4               MAKE NEXT PREVIOUS                R4 73957000
         LH    R4,JOENEXT-JOEDSECT(R4,JOT)  GET NEXT JOE ON QUEUE    R4 73958000
         B     RMWQSCN             CONTINUE SCAN OF QUEUE            R4 73959000
         SPACE 1                                                     R4 73960000
*********************************************************************** 73961000
*                                                                     * 73962000
*        REMOVE WORK-JOE FROM THE WORK QUEUE                          * 73963000
*                                                                     * 73964000
*********************************************************************** 73965000
         SPACE 1                                                     R4 73966000
         CNOP  0,8                                                   R4 73967000
RMWKEL   LA    R4,0(R3,JOT)        POINT TO PRECEEDING JOE           R4 73968000
*                                  THIS CARD DELETED BY APAR   @OZ20010 73969000
         BAL   WD,REMWORK          REMOVE WORK-JOE FROM WORK QUEUE   R4 73970000
         LTR   BASE2,BASE2         TEST JOT POST REQ'T FLAG    @OZ20010 73971000
         BM    $#EXIT              BRANCH IF POST REQUIRED     @OZ20010 73972000
         LM    LINK,R12,PCELINK    RESTORE CALLER'S REGISTERS        R4 73973000
         BR    LINK                 AND RETURN                       R4 73974000
         SPACE 1                                                     R4 73975000
         DROP  JOE                 KILL JOE ADDRESSABILITY           R4 73976000
        TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE CANCEL ROUTINE' R4 73977000
*********************************************************************** 73978000
*                                                                     * 73979000
*        $#CAN -- CANCEL ALL NON-BUSY JOES FOR JOB                    * 73980000
*                                                                     * 73981000
* INPUT  R0    - WORK, UNPREDICTABLE ON EXIT                          * 73982000
*        R1    - JOB QUEUE ELEMENT ADDRESS                            * 73983000
*        R11   - HCT ADDRESS (BASE1)                                  * 73984000
*        R13   - PCE ADDRESS                                          * 73985000
*        R14   - RETURN ADDRESS                                       * 73986000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 73987000
*                                                                     * 73988000
*********************************************************************** 73989000
         SPACE 1                                                     R4 73990000
         ENTRY $#CAN               PROVIDE ENTRY FOR $#CAN ROUTINE   R4 73991000
         USING JOEDSECT,JOE        PROVIDE JOE ADDRESSABILITY        R4 73992000
         SPACE 1                                                     R4 73993000
         CNOP  0,8                                                   R4 73994000
$#CAN    STM   LINK,R12,PCELINK    SAVE CALLER'S REGISTERS           R4 73995000
        $QSUSE SAVE=NO             REQUEST ACCESS TO CHECKPOINT DATA R4 73996000
         L     JOT,$JOTABLE        LOAD JOB OUTPUT TABLE ADDRESS     R4 73997000
         L     BASE2,$JOEADD       LOAD JOT SERVICES ADDRESSABILITY  R4 73998000
         EJECT                                                       R4 73999000
         SL    R1,$JOBQPTR         REDUCE TO RELATIVE BYTE OFFSET    R4 74000000
         SLL   R1,14               REDUCE TO RELATIVE WORD OFFSET    R4 74001000
         SRA   R1,16                ALLOWING FOR HI-ORDER BIT        R4 74002000
         LA    R10,L'JOTRDYWQ      INDEX TO WORK QUEUES              R4 74003000
*                                  THIS CARD DELETED BY APAR   @OZ20010 74004000
         SPACE 1                                                     R4 74005000
*********************************************************************** 74006000
*                                                                     * 74007000
*        SCAN QUEUE FOR WORK-JOE BELONGING TO THIS JOB                * 74008000
*                                                                     * 74009000
*********************************************************************** 74010000
         SPACE 1                                                     R4 74011000
         CNOP  4,8                                                   R4 74012000
CNQUEUE  LA    JOE,JOTRDYWQ-2-(JOENEXT-JOEDSECT)(R10)  NEXT QUEUE    R4 74013000
         SPACE 1                                                     R4 74014000
CNJOES   LR    R4,JOE              SAVE PREVIOUS WORK-JOE ADDR       R4 74015000
         LH    JOE,JOENEXT         PICK NEXT WORK-JOE DISPL          R4 74016000
         N     JOE,=F'65535'       CLEAR LEFT HALFWORD               R4 74017000
         BZ    CNCLSX              BRANCH IF END OF QUEUE            R4 74018000
         SLL   JOE,2               EXPAND TO BYTE OFFSET             R4 74019000
         ALR   JOE,JOT             ADDRESS OF NEXT WORK-JOE          R4 74020000
         CH    R1,JOEJQE           IS WORK-JOE FOR CANCELED JOB...   R4 74021000
         BNE   CNJOES              BRANCH IF NO                      R4 74022000
         TM    JOEFLAG,$JOEBUSY    IS THIS WORK-JOE BUSY...          R4 74023000
         BNZ   CNJOES              BRANCH IF YES                     R4 74024000
         SPACE 1                                                     R4 74025000
*********************************************************************** 74026000
*                                                                     * 74027000
*        REMOVE WORK-JOE FROM THE WORK QUEUE                          * 74028000
*                                                                     * 74029000
*********************************************************************** 74030000
         SPACE 1                                                     R4 74031000
         BAL   WD,REMWORK          REMOVE WORK-JOE FROM WORK QUEUE   R4 74032000
         LH    R1,JOEJQE           RELOAD JQE OFFSET                 R4 74033000
         LR    JOE,R4              MAKE PREVIOUS WORK-JOE CURRENT    R4 74034000
         B     CNJOES              CONTINUE CLASS QUEUE SCAN         R4 74035000
         SPACE 1                                                     R4 74036000
*********************************************************************** 74037000
*                                                                     * 74038000
*        STEP TO THE NEXT WORK QUEUE                                  * 74039000
*                                                                     * 74040000
*********************************************************************** 74041000
         SPACE 1                                                     R4 74042000
         CNOP  0,8                                                   R4 74043000
CNCLSX   BCTR  R10,0               DECREMENT QUEUE INDEX BY ONE      R4 74044000
         BCT   R10,CNQUEUE         BRANCH IF NOT AT QUEUE END        R4 74045000
         SPACE 1                                                     R4 74046000
         LTR   BASE2,BASE2         TEST JOT POST REQ'T FLAG    @OZ20010 74047000
         BM    $#EXIT              BRANCH IF POST REQUIRED     @OZ20010 74048000
         LM    LINK,R12,PCELINK    RESTORE CALLER'S REGISTERS        R4 74049000
         BR    LINK                 AND RETURN                       R4 74050000
         SPACE 1                                                     R4 74051000
         DROP  JOE                 KILL JOE ADDRESSABILITY           R4 74052000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- COMMON ROUTINES'   R4 74053000
*********************************************************************** 74054000
*                                                                     * 74055000
*        REMWORK -- ROUTINE TO REMOVE WORK JOE FROM JOT               * 74056000
*                                                                     * 74057000
* INPUT  R0    - WORK                                                 * 74058000
*        R1    - WORK                                                 * 74059000
*        R2    - WORK                                                 * 74060000
*        R3    - WORK                                                 * 74061000
*        R4    - ADDRESS OF JOE PRECEEDING WORK JOE TO BE REMOVED     * 74062000
*        WD    - RETURN ADDRESS                                       * 74063000
*        WF    - WORK/LINK REGISTER                                   * 74064000
*        JOE   - ADDRESS OF JOE TO BE REMOVED                         * 74065000
*                                                                     * 74066000
*********************************************************************** 74067000
         SPACE 1                                                     R4 74068000
         USING JOEDSECT,JOE        PROVIDE JOE ADDRESSABILITY        R4 74069000
         SPACE 1                                                     R4 74070000
*********************************************************************** 74071000
*                                                                     * 74072000
*        FREE CHECKPOINT JOE IF ONE WAS ALLOCATED                     * 74073000
*                                                                     * 74074000
*********************************************************************** 74075000
         SPACE 1                                                     R4 74076000
         CNOP  0,8                                                   R4 74077000
REMWORK  LH    R2,JOECKPT          DISPL OF CHECKPOINT ELEMENT       R4 74078000
         N     R2,=F'65535'        CLEAR LEFT HALFWORD               R4 74079000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 74080000
         BZ    SKIP170             BRANCH IF ELEMENT NOT ALLOCATED   R4 74081000
         BAL   WF,FREEJOE          RETURN CKPT-JOE TO FREE QUEUE     R4 74082000
SKIP170  LH    R2,JOECHAR          CHAR-JOE DISPLACEMENT             R4 74083000
         N     R2,=F'65535'        CLEAR LEFT HALFWORD               R4 74084000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 74085000
         TM    JOEFLAG,$JOEBUSY    WAS THIS JOE SELECTED...          R4 74086000
         BZ    RMRMT               BRANCH IF NO                      R4 74087000
         TM    PCEID,PCELCLID      IS REQUEST FOR A REMOTE DEVICE... R4 74088000
         BNO   RMRMT               BRANCH IF YES                     R4 74089000
         SPACE 1                                                     R4 74090000
*********************************************************************** 74091000
*                                                                     * 74092000
*        DECREMENT ACTIVE DEVICE COUNTER FOR THIS CHAR-JOE            * 74093000
*                                                                     * 74094000
*********************************************************************** 74095000
         SPACE 1                                                     R4 74096000
         LA    R3,JOEACTPR-JOEDSECT(R2,JOT)  ASSUME PRINTER          R4 74097000
         TM    PCEID,PCEPRSID      IS REQUESTOR A PRINTER...         R4 74098000
         BO    SKIP180             BRANCH IF YES                     R4 74099000
         LA    R3,JOEACTPU-JOEDSECT(R2,JOT)  SET PUNCH               R4 74100000
SKIP180  SLR   WF,WF               CLEAR REGISTER                    R4 74101000
         IC    WF,0(,R3)           DECREMENT                         R4 74102000
         BCTR  WF,R0                ACTIVE DEVICE                    R4 74103000
         STC   WF,0(,R3)             COUNT                           R4 74104000
         EJECT                                                       R4 74105000
*********************************************************************** 74106000
*                                                                     * 74107000
*        DECREMENT CHARACTERISTICS JOE USE COUNT                      * 74108000
*                                                                     * 74109000
*********************************************************************** 74110000
         SPACE 1                                                     R4 74111000
RMRMT    LH    R3,JOEUSE-JOEDSECT(R2,JOT)  DECREMENT                 R4 74112000
         BCTR  R3,R0                        CHAR-JOE                 R4 74113000
         STH   R3,JOEUSE-JOEDSECT(R2,JOT)    USE COUNT               R4 74114000
         BAL   WF,CKPTJOE          CKPT CHAR-JOE                     R4 74115000
         LTR   R3,R3               IS NUMBER OF USERS ZERO...        R4 74116000
         BNZ   RMWORK              BRANCH IF NO                      R4 74117000
         SPACE 1                                                     R4 74118000
*********************************************************************** 74119000
*                                                                     * 74120000
*        REMOVE CHARACTERISTICS-JOE FROM THE CHAR-QUEUE               * 74121000
*                                                                     * 74122000
*********************************************************************** 74123000
         SPACE 1                                                     R4 74124000
         LA    R3,JOTCHRQ          ADDRESS OF CHAR-QUEUE             R4 74125000
         SLR   R3,JOT              OFFSET OF CHAR QUEUE IN JOT       R4 74126000
         LH    WF,JOTCHRQ          DISPL OF 1ST JOE IN CHAR QUEUE    R4 74127000
         SPACE 1                                                     R4 74128000
         CNOP  0,8                                                   R4 74129000
RMCQSCN  N     WF,=F'65535'        CLEAR LEFT HALFWORD               R4 74130000
         SLL   WF,2                EXPAND TO BYTE OFFSET             R4 74131000
         CLR   R2,WF               IS NEXT JOE TO BE FREED...        R4 74132000
         BE    RMCHEL              BRANCH IF YES                     R4 74133000
         LR    R3,WF               MAKE NEXT PREVIOUS                R4 74134000
         LH    WF,JOENEXT-JOEDSECT(WF,JOT)  GET NEW NEXT JOE         R4 74135000
         B     RMCQSCN             CONTINUE CHAR SCAN                R4 74136000
         SPACE 1                                                     R4 74137000
         CNOP  0,8                                                   R4 74138000
RMCHEL   BAL   WF,REMJOE           DEQUEUE AND FREE CHAR-JOE         R4 74139000
         SPACE 1                                                     R4 74140000
*********************************************************************** 74141000
*                                                                     * 74142000
*        REMOVE WORK-JOE FROM THE WORK QUEUE                          * 74143000
*                                                                     * 74144000
*********************************************************************** 74145000
         SPACE 1                                                     R4 74146000
RMWORK   LR    R2,JOE              COPY WORK-JOE ADDRESS             R4 74147000
         SLR   R2,JOT              REDUCE TO BYTE OFFSET             R4 74148000
         LR    R3,R4               COPY ADDRESS OF PREVIOUS WORK-JOE R4 74149000
         SLR   R3,JOT              REDUCE TO BYTE OFFSET             R4 74150000
         BAL   WF,REMJOE           DEQUEUE AND FREE WORK-JOE         R4 74151000
         EJECT                                                       R4 74152000
*********************************************************************** 74153000
*                                                                     * 74154000
*        DECREMENT PENDING JOE COUNTER IN HASP JOB QUEUE ELEMENT      * 74155000
*                                                                     * 74156000
*********************************************************************** 74157000
         SPACE 1                                                     R4 74158000
         LH    R1,JOEJQE           JOB QUEUE ELEMENT OFFSET          R4 74159000
         N     R1,=F'65535'        CLEAR LEFT HALFWORD               R4 74160000
         SLL   R1,2                EXPAND TO BYTE OFFSET             R4 74161000
         AL    R1,$JOBQPTR         ADD JOB QUEUE ORIGIN              R4 74162000
         SPACE 1                                                     R4 74163000
         USING JQEDSECT,R1         PROVIDE JQE ADDRESSABILITY        R4 74164000
         SPACE 1                                                     R4 74165000
         LH    WF,JQEJOECT         DECREMENT                         R4 74166000
         BCTR  WF,0                 JOE COUNT                        R4 74167000
         STH   WF,JQEJOECT           FOR JOB                         R4 74168000
         LM    WA,WB,PCEWA         RESTORE REGS USED BY $QCKPT       R4 74169000
        $QCKPT (R1)                CKPT THE JOB QUEUE ELEMENT        R4 74170000
         SPACE 1                                                     R4 74171000
*********************************************************************** 74172000
*                                                                     * 74173000
*        MOVE JOB TO $PURGE IF PENDING JOE COUNT WAS ZERO             * 74174000
*                                                                     * 74175000
*********************************************************************** 74176000
         SPACE 1                                                     R4 74177000
         AH    WF,JQEHLDCT         TEST JOE/HOLD COUNT               R4 74178000
         BNZR  WD                  RETURN IF NON-ZERO                R4 74179000
         CLI   JQETYPE,$HARDCPY    IS JOB IN $HARDCPY QUEUE...       R4 74180000
         BNER  WD                  RETURN IF NO                      R4 74181000
        $QPUT  (R1),$PURGE          ELSE RE-QUEUE JOB FOR PURGE      R4 74182000
         BR    WD                  THEN RETURN                       R4 74183000
         SPACE 1                                                     R4 74184000
         DROP  R1,JOE              KILL JQE, JOE ADDRESSABILITY      R4 74185000
         EJECT                                                       R4 74186000
*********************************************************************** 74187000
*                                                                     * 74188000
*        GETJOE -- ROUTINE TO GET A JOE FROM THE FREE QUEUE           * 74189000
*                                                                     * 74190000
*                                                                     * 74191000
* INPUT  WF    - RETURN ADDRESS                                       * 74192000
*                                                                     * 74193000
* OUTPUT R3    - JOE ADDRESS                                          * 74194000
*                                                                     * 74195000
*********************************************************************** 74196000
         SPACE 1                                                     R4 74197000
         CNOP  0,8                                                   R4 74198000
GETJOE   LH    R3,JOTFREC          DECREMENT                         R4 74199000
         BCTR  R3,R0                FREE JOE                         R4 74200000
         STH   R3,JOTFREC            COUNT                           R4 74201000
         LH    R3,JOTFREQ          DISPL OF 1ST FREE JOE             R4 74202000
         N     R3,=F'65535'        CLEAR LEFT HALFWORD               R4 74203000
         SLL   R3,2                EXPAND TO BYTE OFFSET             R4 74204000
        $#CKPT JOE=0(,R3),HEAD=YES CKPT JOE BEING GOTTEN + HEADER    R4 74205000
         ALR   R3,JOT              ADDRESS OF 1ST FREE JOE           R4 74206000
         MVC   JOTFREQ,JOENEXT-JOEDSECT(R3) REATTACH REMAINING QUEUE R4 74207000
         BR    WF                  RETURN TO CALLER                  R4 74208000
         EJECT                                                       R4 74209000
*********************************************************************** 74210000
*                                                                     * 74211000
*        REMJOE -- REMOVE JOE FROM CURRENT QUEUE                      * 74212000
*                                                                     * 74213000
* INPUT  R0    - WORK                                                 * 74214000
*        R2    - BYTE OFFSET OF JOE TO BE REMOVED                     * 74215000
*        R3    - BYTE OFFSET OF JOE PRECEEDING JOE TO BE REMOVED      * 74216000
*        WF    - RETURN ADDRESS                                       * 74217000
*                                                                     * 74218000
* NOTES        - THE BYTE AT $CSAVREG+8 IS SET TO NON-ZERO BY THIS    * 74219000
*                ROUTINE IF THE RESULTING FREE JOE COUNT INDICATES    * 74220000
*                THAT THERE MAY BE PROCESSORS WAITING FOR FREE JOES   * 74221000
*                                                                     * 74222000
*              - THIS ROUTINE EXITS TO THE FREEJOE ROUTINE TO         * 74223000
*                RETURN REMOVED JOE TO THE FREE QUEUE                 * 74224000
*                                                                     * 74225000
*********************************************************************** 74226000
         SPACE 1                                                     R4 74227000
         CNOP  0,8                                                   R4 74228000
REMJOE   LH    R0,JOENEXT-JOEDSECT(R2,JOT)  GET OFFSET OF NEXT JOE   R4 74229000
         STH   R0,JOENEXT-JOEDSECT(R3,JOT)  REMOVE JOE FROM QUEUE    R4 74230000
        $#CKPT JOE=0(,R3)          CHECKPOINT THE PREVIOUS JOE       R4 74231000
         LH    R0,JOTFREC          GET FREE JOE COUNT                R4 74232000
         SH    R0,$MINJOES         MINUS THE MINIMUM FREE LIMIT      R4 74233000
         SH    R0,=H'4'            MINUS 4 FOR POSSIBLE WAITING      R4 74234000
         BNM   FREEJOE             BR IF NOBODY WAITING              R4 74235000
         ICM   BASE2,8,*           INDICATE JOT POST REQUIRED  @OZ20010 74236000
         EJECT                                                       R4 74237000
*********************************************************************** 74238000
*                                                                     * 74239000
*        FREEJOE -- ROUTINE TO RETURN A JOE TO THE FREE QUEUE         * 74240000
*                                                                     * 74241000
* INPUT  R0    - WORK                                                 * 74242000
*        R2    - BYTE OFFSET OF JOE TO BE RETURNED                    * 74243000
*        R3    - WORK REGISTER                                        * 74244000
*        WF    - RETURN ADDRESS                                       * 74245000
*                                                                     * 74246000
*        NOTE  - THIS ROUTINE EXITS TO THE CKPTJOEA ROUTINE TO        * 74247000
*                CHECKPOINT THE FREE JOE AFTER WHICH THE REMOVED      * 74248000
*                JOE IS INSERTED.                                     * 74249000
*                                                                     * 74250000
*********************************************************************** 74251000
         SPACE 1                                                     R4 74252000
         USING JOEDSECT,R3         PROVIDE JOE ADDRESSABILITY        R4 74253000
         SPACE 1                                                     R4 74254000
FREEJOE  LH    R3,JOTFREC          INCREMENT                         R4 74255000
         LA    R3,1(,R3)            FREE JOE                         R4 74256000
         STH   R3,JOTFREC            COUNT                           R4 74257000
        $#CKPT JOE=0(,R2),HEAD=YES CKPT JOE BEING FREED + HEADER     R4 74258000
         SRL   R2,2                REDUCE TO FULLWORD OFFSET         R4 74259000
         LA    R3,JOTFREQ-(JOENEXT-JOEDSECT)  PREPARE TO SCAN FREE Q R4 74260000
         SPACE 1                                                     R4 74261000
         CNOP  0,8                                                   R4 74262000
FRESCN   CLM   R2,3,JOENEXT        IS JOE OFFSET LESS THAN NEXT...   R4 74263000
         BL    FREHIT              BRANCH IF YES                     R4 74264000
         LH    R0,JOENEXT          DISPL OF NEXT FREE JOE            R4 74265000
         N     R0,=F'65535'        CLEAR HIGH HALF WORD              R4 74266000
         BZ    FREHIT              BRANCH IF END OF FREE QUEUE       R4 74267000
         LR    R3,R0               RELOAD FREE JOE DISPL             R4 74268000
         SLL   R3,2                EXPAND TO BYTE OFFSET             R4 74269000
         ALR   R3,JOT              ADDRESS OF NEXT FREE JOE          R4 74270000
         B     FRESCN              CONTINUE SEARCH                   R4 74271000
         SPACE 1                                                     R4 74272000
         CNOP  0,8                                                   R4 74273000
FREHIT   LH    R0,JOENEXT          GET OLD NEXT FREE JOE DISPL       R4 74274000
         STH   R2,JOENEXT          STORE NEW DISPL AS NEXT FREE      R4 74275000
         N     R2,=F'65535'        CLEAR HIGH HALF WORD              R4 74276000
         SLL   R2,2                EXPAND TO BYTE OFFSET             R4 74277000
         STH   R0,JOENEXT-JOEDSECT(R2,JOT)  RE-CONNECT CHAIN         R4 74278000
         LR    R2,R3               RELOAD ADDR OF PREVIOUS FREE JOE  R4 74279000
         SPACE 1                                                     R4 74280000
         DROP  R3                  KILL JOE ADDRESSABILITY           R4 74281000
         EJECT                                                       R4 74282000
*********************************************************************** 74283000
*                                                                     * 74284000
*        CKPTJOEA/CKPTJOE -- ROUTINE TO CHECKPOINT A JOE              * 74285000
*                                                                     * 74286000
* INPUT  R2    - ADDRESS OF JOE (JOECKPTA)                            * 74287000
*              - BYTE OFFSET OF JOE (JOECKPT)                         * 74288000
*        WF    - RETURN ADDRESS                                       * 74289000
*                                                                     * 74290000
*********************************************************************** 74291000
         SPACE 1                                                     R4 74292000
CKPTJOEA SLR   R2,JOT              REDUCE TO BYTE OFFSET             R4 74293000
         SPACE 1                                                     R4 74294000
CKPTJOE $#CKPT JOE=0(,R2)          CHECKPOINT THE JOE                R4 74295000
         BR    WF                  RETURN TO CALLER                  R4 74296000
         SPACE 1                                                     R4 74297000
         DROP  JOT                 KILL JOT ADDRESSABILITY           R4 74298000
         DROP  BASE2               KILL LOCAL ADDRESSABILITY         R4 74299000
   TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JOE CKPT ROUTINE'  @OZ20010 74299100
***************************************************************@OZ20010 74299200
*              $JOECKPT -- SCHEDULE CHECKPOINT FOR ALTERED JOE @OZ20010 74299300
*                                                              @OZ20010 74299400
*              REG    ENTRY VALUE               EXIT VALUE     @OZ20010 74299500
*                                                              @OZ20010 74299600
*              R0     N/A                       UNCHANGED      @OZ20010 74299700
*              R1     JOE ADDR IF ENTERED AT                   @OZ20010 74299800
*                     $JOECKPT. ELSE JOE OFFSET                @OZ20010 74299900
*              R2-R10 N/A                       UNCHANGED      @OZ20010 74300000
*              R11    HCT ADDRESS               UNCHANGED      @OZ20010 74300100
*              R12    N/A                       UNCHANGED      @OZ20010 74300200
*              R13    PCE ADDRESS               UNCHANGED      @OZ20010 74300300
*              R14    RETURN ADDR (HI ORDER     UNCHANGED      @OZ20010 74300400
*                     BIT ON IF HEAD=YES)                      @OZ20010 74300500
*              R15    ENTRY ADDRESS             UNCHANGED      @OZ20010 74300600
*                                                              @OZ20010 74300700
* THIS ROUTINE INSURES A CHECKPOINT FOR AN ALTERED JOE EVEN    @OZ20010 74300800
* IF IT CROSSES PAGE BOUNDRIES.                                @OZ20010 74300900
*                                                              @OZ20010 74301000
***************************************************************@OZ20010 74301100
         SPACE 1                                               @OZ20010 74301200
         ENTRY $JOECKPT            PROVIDE $JOECKPT ENTRY      @OZ20010 74301300
         SPACE 1                                               @OZ20010 74301500
$JOECKPT LA    R1,0(,R1)           PURIFY JOE ADDRESS          @OZ20010 74301700
         SL    R1,$JOTABLE         GET THE OFFSET              @OZ20010 74301800
         SPACE 1                                               @OZ20010 74301900
         ENTRY $JOEOFF             PROVIDE $JOEOFF ENTRY       @OZ20010 74302000
         SPACE 1                                               @OZ20010 74302100
$JOEOFF  LR    R0,R1               SAVE JOE OFFSET             @OZ20010 74302300
         SRL   R1,12               DIVIDE BY LENGTH OF PAGE    @OZ20010 74302400
         AL    R1,$JOTCTLB         POINT TO CHECKPOINT CONTROL @OZ20010 74302500
         MVC   0(1,R1),$SIDAFF     TURN ON CKPT INDICATOR      @OZ20010 74302600
         LR    R1,R0               RELOAD JOE OFFSET           @OZ20010 74302700
         LA    R1,JOESIZE-1(,R1)   LOCATE THE END OF THIS JOE  @OZ20010 74302800
         SRL   R1,12               DIVIDE BY PAGE LENGTH       @OZ20010 74302900
         AL    R1,$JOTCTLB         POINT TO CHECKPOINT CONTROL @OZ20010 74303000
         MVC   0(1,R1),$SIDAFF     TURN ON CKPT INDICATOR      @OZ20010 74303100
         LTR   R14,R14             TEST FOR HEAD=YES           @OZ20010 74303200
         BPR   R14                 RETURN IF NO                @OZ20010 74303300
         L     R1,$JOTCTLB         GET CKPT CONTROL BYTE       @OZ20010 74303400
         MVC   0(1,R1),$SIDAFF     TURN ON CKPT INDICATOR      @OZ20010 74303500
         BR    R14                 RETURN                      @OZ20010 74303700
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- EXTERNAL WRITER POST C74304000
               ROUTINE'                                        @OZ20010 74304100
***************************************************************@OZ20010 74304200
*                                                              @OZ20010 74304300
*        $#WTR -- POST EXTERNAL WRITERS WAITING ON JOT         @OZ20010 74304400
*                                                                     * 74305000
*        R11   - HCT ADDRESS (BASE1)                                  * 74306000
*        R14   - RETURN ADDRESS                                       * 74307000
*                                                                     * 74308000
*********************************************************************** 74309000
         SPACE 1                                                     R4 74310000
         ENTRY $#WTR               PROVIDE ENTRY FOR $#WTR ROUTINE   R4 74311000
         USING SJBDSECT,R1         PROVIDE SJB ADDRESSABILITY        R4 74312000
         USING $SVDSECT,WB         PROVIDE SSVT ADDRESSABILITY       R4 74313000
         SPACE 1                                                     R4 74314000
         CNOP  2,8                                                   R4 74315000
$#WTR    STM   LINK,WB,$CSAVREG    SAVE CALLER'S REGISTERS           R4 74316000
         L     WB,$SSVT            GET SSVT ADDRESS                  R4 74317000
         SPACE 1                                                     R4 74318000
         BALR  WA,0                RE-ESTABLISH                      R4 74319000
         USING *,WA                 LOCAL ADDRESSABILITY             R4 74320000
         SPACE 1                                                     R4 74321000
*********************************************************************** 74322000
*                                                                     * 74323000
*        SCAN EXECUTING STARTED TASKS FOR EXTERNAL WRITERS            * 74324000
*                                                                     * 74325000
*********************************************************************** 74326000
         SPACE 1                                                     R4 74327000
WTRLOOP  LA    R1,$SVJXNUM-(SJBXQCHN-SJBDSECT)  PREPARE TO SCAN SJBS R4 74328000
         SPACE 1                                                     R4 74329000
WTRNEXT  L     R1,SJBXQCHN         GET ADDRESS OF NEXT SJB           R4 74330000
         LTR   R1,R1               TEST FOR END OF CHAIN             R4 74331000
         BZ    WTRDONE             BRANCH IF YES                     R4 74332000
         TM    SJBPSOP,X'80'       TEST FOR EXTERNAL WRITER JOT WAIT R4 74333000
         BZ    WTRNEXT             BRANCH IF NO                      R4 74334000
         NI    SJBPSOP,255-X'80'   TURN OFF WAIT BIT                 R4 74335000
         L     R1,SJBPSOP          ADDRESS PSO                       R4 74336000
         SPACE 1                                                     R4 74337000
         USING PSODSECT,R1         PROVIDE PSO ADDRESSABILITY        R4 74338000
         SPACE 1                                                     R4 74339000
        $XMPOST PSOECBP            POST A WAITING EXTERNAL WRITER    R4 74340000
         IC    R0,$WTRWTCT         DECREMENT NUMBER                  R4 74341000
         BCTR  R0,0                 OF EXTERNAL WRITERS              R4 74342000
         STC   R0,$WTRWTCT         WAITING ON JOT POST               R4 74343000
         B     WTRLOOP             CONTINUE                          R4 74344000
         SPACE 1                                                     R4 74345000
WTRDONE  LM    LINK,WB,$CSAVREG    RESTORE CALLER'S REGISTERS        R4 74346000
         BR    LINK                RETURN TO CALLER                  R4 74347000
         SPACE 1                                                     R4 74348000
         DROP  R1,WA,WB            KILL ADDRESSABILITY               R4 74349000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- DATA AREAS'        R4 74350000
*********************************************************************** 74351000
*                                                                     * 74352000
*        SYSOUT CLASS ID TO CLASS QUEUE ADDRESS CONVERSION            * 74353000
*                                                                     * 74354000
*********************************************************************** 74355000
         SPACE 1                                                     R4 74356000
CNVCLS   DC    AL1(0,2,4,6,8,10,12,14,16),7AL1(0)      A-I           R4 74357000
         DC    AL1(18,20,22,24,26,28,30,32,34),8AL1(0) J-R           R4 74358000
         DC    AL1(36,38,40,42,44,46,48,50),6AL1(0)    S-Z           R4 74359000
         DC    AL1(52,54,56,58,60,62,64,66,68,70)      0-9           R4 74360000
         SPACE 5                                                     R4 74361000
         LTORG                                                       R4 74362000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JCT READ ROUTINE'  R4 74363000
*********************************************************************** 74364000
*                                                                     * 74365000
*        PROVIDE JCT IN BUFFER FOR PRINT/PUNCH/EXTERNAL WRITER JOB    * 74366000
*                                                                     * 74367000
* INPUT  R0    - WORK, UNPREDICTABLE ON EXIT                          * 74368000
*        R1    - WORK, UNPREDICTABLE ON EXIT                          * 74369000
*        R10   - JQE ADDRESS                                          * 74370000
*        R14   - RETURN ADDRESS                                       * 74371000
*        R15   - ENTRY POINT ADDRESS                                  * 74372000
*                                                                     * 74373000
* OUTPUT R10   - JCT ADDRESS OR ZERO                                  * 74374000
*              - CC NON-ZERO -- JCT READ SUCCESSFUL                   * 74375000
*              - CC     ZERO -- JCT READ UNSUCCESSFUL                 * 74376000
*                                                                     * 74377000
* NOTE   -     BECAUSE OF $WAITS IN THIS ROUTINE, THE PCE AND FIXED   * 74378000
*              SAVE AREAS ARE INELLIGIBLE FOR USE.  THEREFORE, R15    * 74379000
*              MUST BE USED AS A BASE REGISTER, BEING RESTORED AFTER  * 74380000
*              EACH USE BY ANOTHER SERVICE ROUTINE.                   * 74381000
*                                                                     * 74382000
*********************************************************************** 74383000
         SPACE 1                                                     R4 74384000
         ENTRY $#JCTRDR            PROVIDE ENTRY FOR $#JCTRDR RTN    R4 74385000
         USING $#JCTRDR,R15        PROVIDE LOCAL ADDRESSABILITY      R4 74386000
         EJECT                                                       R4 74387000
*********************************************************************** 74388000
*                                                                     * 74389000
*        SEARCH RESIDENT JCT QUEUE FOR REQUESTED JCT                  * 74390000
*                                                                     * 74391000
*********************************************************************** 74392000
         SPACE 1                                                     R4 74393000
         USING JQEDSECT,JCT        PROVIDE JQE ADDRESSABILITY        R4 74394000
         SPACE 1                                                     R4 74395000
         CNOP  4,8                                                   R4 74396000
$#JCTRDR ST    LINK,PCESAVEA       SAVE RETURN ADDRESS               R4 74397000
         MVC   PCESEEK,JQETRAK     JCT TRACK ADDRESS TO DA DCT       R4 74398000
         SPACE 1                                                     R4 74399000
         DROP  JCT                 KILL JQE ADDRESSABILITY           R4 74400000
         SPACE 1                                                     R4 74401000
         LH    R0,$#JCTQCT         ENTRIES IN RESIDENT JCT QUEUE     R4 74402000
         L     R1,$#JCTQ           POINT TO 1ST QUEUE ENTRY          R4 74403000
         SLR   R14,R14             CLEAR FIRST FREE POINTER          R4 74404000
         SPACE 1                                                     R4 74405000
RDFIND   CLM   JCT,7,5(R1)         DOES THIS JQE MATCH REQUEST...    R4 74406000
         BE    RDHIT               BRANCH IF YES                     R4 74407000
         CLI   0(R1),X'00'         IS THIS ENTRY FREE...             R4 74408000
         BNE   RDNEXT              BRANCH IF NO                      R4 74409000
         LTR   R14,R14             HAS FIRST FREE BEEN FOUND...      R4 74410000
         BNZ   RDNEXT              BRANCH IF YES                     R4 74411000
         LR    R14,R1              SAVE FIRST FREE ELEMENT ADDRESS   R4 74412000
         SPACE 1                                                     R4 74413000
*********************************************************************** 74414000
*                                                                     * 74415000
*        STEP TO NEXT JCT QUEUE ENTRY - CONTINUE SEARCH               * 74416000
*                                                                     * 74417000
*********************************************************************** 74418000
         SPACE 1                                                     R4 74419000
RDNEXT   LA    R1,8(,R1)           ADDRESS NEXT JCT QUEUE ENTRY      R4 74420000
         BCT   R0,RDFIND           BRANCH IF NOT AT END OF QUEUE     R4 74421000
         SPACE 1                                                     R4 74422000
*********************************************************************** 74423000
*                                                                     * 74424000
*        REQUESTED JCT NOT FOUND - SETUP NEW QUEUE ENTRY              * 74425000
*                                                                     * 74426000
*********************************************************************** 74427000
         SPACE 1                                                     R4 74428000
         LR    R1,R14              USE FIRST FREE ELEMENT            R4 74429000
         STCM  JCT,7,5(R1)         STORE JQE ADDRESS                 R4 74430000
         EJECT                                                       R4 74431000
*********************************************************************** 74432000
*                                                                     * 74433000
*        REQUESTED JCT FOUND - INCREMENT USE COUNT                    * 74434000
*                                                                     * 74435000
*********************************************************************** 74436000
         SPACE 1                                                     R4 74437000
RDHIT    L     JCT,0(,R1)          AL1(USE COUNT),AL3(JCT BUFFER)    R4 74438000
         AL    JCT,=X'01000000'    INCREMENT USE COUNTER             R4 74439000
         ST    JCT,0(,R1)          REPLACE ENTRY IN JCT QUEUE        R4 74440000
         LR    JCT,R1              HOLD JCT QUEUE ELEMENT ADDRESS    R4 74441000
         SPACE 1                                                     R4 74442000
*********************************************************************** 74443000
*                                                                     * 74444000
*        LOCK ELEMENT FOR JCT READ - OR WAIT FOR LOCK                 * 74445000
*                                                                     * 74446000
*********************************************************************** 74447000
         SPACE 1                                                     R4 74448000
RDLOCK   TM    4(JCT),X'80'        IS ELEMENT LOCKED...              R4 74449000
         BZ    RDJQE               BRANCH IF NO                      R4 74450000
        $WAIT  ABIT                WAIT FOR LOCK TO FREE             R4 74451000
         L     R15,$JCTRDR         RESTORE BASE                      R4 74452000
         B     RDLOCK              TRY LOCK AGAIN                    R4 74453000
         SPACE 1                                                     R4 74454000
*********************************************************************** 74455000
*                                                                     * 74456000
*        SET JCT QUEUE ELEMENT LOCK, GET A BUFFER                     * 74457000
*                                                                     * 74458000
*********************************************************************** 74459000
         SPACE 1                                                     R4 74460000
         CNOP  0,8                                                   R4 74461000
RDJQE    OI    4(JCT),X'80'        SET JCT ELEMENT LOCK              R4 74462000
         ICM   R1,7,1(JCT)         TEST BUFFER ADDRESS               R4 74463000
         BZ    RDGETB              BR IF NOT IN POOL                R41 74463200
         TM    PCESAVEA,X'80'      TEST FOR REFRESH=YES             R41 74463300
         BZ    RDJCTOK             BR IF NOT                        R41 74463400
         EJECT                                                      R41 74463500
*********************************************************************** 74463600
*                                                                     * 74463700
*        REFRESH=YES -- RE-READ JCT INTO NEW BUFFER                   * 74463800
*                                                                     * 74463900
*********************************************************************** 74464000
         SPACE 1                                                    R41 74464100
        $GETBUF WAIT=YES           GET NEW BUFFER                   R41 74464200
         L     R15,$JCTRDR         RESTORE BASE                     R41 74464300
         STCM  R1,7,PCEBUFAD+1     BUFFER ADDR TO DA DCT            R41 74464400
         MVI   PCEDEVTP,PCEDARD    SETUP FOR DA READ                R41 74464500
         LA    R1,PCEDADCT         ADDRESS DA DCT                   R41 74464600
        $EXCP  (R1),WAIT=YES       RE-READ LATEST COPY OF JCT       R41 74464700
         L     R15,$JCTRDR         RESTORE BASE                     R41 74464800
         NI    4(JCT),X'7F'        RELEASE JCT ELEMENT LOCK         R41 74464900
         MVC   0(8,R1),0(JCT)      COPY JCT Q ELEMENT               R41 74465000
         MVI   0(R1),1             SHOW 1 USER                      R41 74465100
         LR    JCT,R1              USE COPY OF Q ELEMENT            R41 74465200
         TM    BUFECBCC-BUFDSECT(R1),X'7F'  TEST I/O COMPLETION     R41 74465300
         BM    RDBADX              BR IF I/O ERROR                  R41 74465400
         B     RDJCTOK             ELSE GO REFRESH JCT BUFFER       R41 74465500
         SPACE 2                                                    R41 74465600
RDGETB  $GETBUF WAIT=YES           GET BUFFER FOR JCT               R41 74465700
         L     R15,$JCTRDR         RESTORE BASE                      R4 74466000
         SPACE 1                                                    R41 74467000
*********************************************************************** 74468000
*                                                                     * 74469000
*        JCT NOT IN POOL -- READ IT IN FROM SPOOL                     * 74470000
*                                                                     * 74471000
*********************************************************************** 74472000
         SPACE 1                                                     R4 74473000
         STCM  R1,7,1(JCT)         BUFFER ADDRESS TO JCT ELEMENT     R4 74474000
         STCM  R1,7,PCEBUFAD+1     BUFFER ADDRESS TO DA DCT          R4 74475000
         MVI   PCEDEVTP,PCEDARD    SET DA DCT TO READ                R4 74476000
         LA    R1,PCEDADCT         ADDRESS DA DCT                    R4 74477000
        $EXCP  (R1),WAIT=YES       READ JCT INTO BUFFER              R4 74478000
         L     R15,$JCTRDR         RESTORE BASE                      R4 74479000
         BM    RDBADX              BR IF I/O ERROR                   R4 74480000
         EJECT                                                      R41 74481000
*********************************************************************** 74482000
*                                                                     * 74483000
*        VALIDITY CHECK - JCT MUST CONTAIN JQE OFFSET                 * 74484000
*                                                                     * 74485000
*********************************************************************** 74486000
         SPACE 1                                                     R4 74487000
RDJCTOK  SLR   R0,R0               CLEAR REGISTER                    R4 74488000
         ICM   R0,7,5(JCT)         ADDRESS JQE                       R4 74489000
         SL    R0,$JOBQPTR         CONVERT TO JQE OFFSET             R4 74490000
         SPACE 1                                                     R4 74491000
         USING JCTDSECT,R1         PROVIDE JCT ADDRESSABILITY        R4 74492000
         SPACE 1                                                     R4 74493000
         CL    R0,JCTJQE           IS JCT VALID...                   R4 74494000
         BNE   RDBADX              BRANCH IF NO                      R4 74495000
         SPACE 1                                                    R41 74495100
         CLR   R1,JCT              REFRESH=YES...                   R41 74495200
         BNE   RDRESET             BR IF NOT                        R41 74495300
         LA    R0,JCTSTART         ADDRESS NEW JCT COPY             R41 74495400
         LH    R1,$BUFSIZE         LENGTH OF JCT                    R41 74495500
         L     R14,0(JCT)          ADDRESS ORIGINAL                 R41 74495600
         LA    R14,JCTSTART-JCTDSECT(,R14)  JCT BUFFER              R41 74495700
         LR    R15,R1              LENGTH OF JCT                    R41 74495800
         MVCL  R14,R0              REFRESH JCT BUFFER               R41 74495900
         L     R15,$JCTRDR         RESTORE BASE                     R41 74496000
         L     JCT,0(,JCT)         GET ADDRESS OF JCT BUFFER        R41 74496100
         LA    JCT,0(,JCT)         PURIFY                           R41 74496200
        $FREEBUF PCEBUFAD          FREE THE UNUSED JCT BUFFER       R41 74496300
         L     R15,$JCTRDR         RESTORE BASE                     R41 74496400
         B     RDEXIT               AND BR TO EXIT                  R41 74496500
         SPACE 1                                                     R4 74496600
         DROP  R1                  KILL JCT ADDRESSABILITY           R4 74497000
         SPACE 1                                                     R4 74498000
RDRESET  NI    4(JCT),X'7F'        RELEASE JCT ELEMENT LOCK         R41 74499000
         LR    JCT,R1              SET JCT BUFFER ADDRESS            R4 74500000
         SPACE 1                                                     R4 74501000
RDEXIT   L     LINK,PCESAVEA       RESTORE RETURN ADDRESS            R4 74502000
         LTR   JCT,JCT             SET CALLER RETURN CODE            R4 74503000
         BR    LINK                RETURN TO CALLER                  R4 74504000
         EJECT                                                       R4 74505000
*********************************************************************** 74506000
*                                                                     * 74507000
*        READ ERROR INDICATED BY ECB COMPLETION CODE                  * 74508000
*                                                                     * 74509000
*********************************************************************** 74510000
         SPACE 1                                                     R4 74511000
RDBADX   MVC   PCESEEK,PCESAVEA    SAVE RETURN ADDRESS               R4 74512000
         SPACE 1                                                     R4 74513000
$#JCTRER $DISTERR                  INDICATE CONTROL BLOCK ERROR      R4 74514000
         MVC   PCESAVEA,PCESEEK    RESTORE RETURN ADDRESS            R4 74515000
         L     R15,$JCTRDR         RESTORE BASE                      R4 74516000
         SLR   R1,R1               CLEAR REGISTER                    R4 74517000
         IC    R1,0(,JCT)          GET ELEMENT USE COUNT             R4 74518000
         BCT   R1,RDNFREE          LOWER COUNT AND FREE IF ZERO      R4 74519000
         XC    0(8,JCT),0(JCT)     CLEAR JCT QUEUE ELEMENT           R4 74520000
        $FREEBUF PCEBUFAD          FREE HASP BUFFER                  R4 74521000
         L     R15,$JCTRDR         RESTORE BASE                      R4 74522000
         B     RDCLR               GO CLEAR JCT POINTER              R4 74523000
         SPACE 1                                                     R4 74524000
RDNFREE  STC   R1,0(,JCT)          SAVE RESIDUAL USE COUNT           R4 74525000
         NI    4(JCT),X'7F'        RESET ELEMENT BUSY FLAG           R4 74526000
         SPACE 1                                                     R4 74527000
RDCLR    SLR   JCT,JCT             SET NO JCT INDICATION             R4 74528000
         B     RDEXIT              TAKE EXIT TO CALLER               R4 74529000
         SPACE 1                                                     R4 74530000
         DROP  R15                 KILL LOCAL ADDRESSABILITY         R4 74531000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JCT WRITE ROUTINE' R4 74532000
*********************************************************************** 74533000
*                                                                     * 74534000
*        $#JCTWTR -- COPY RESIDENT JCT TO ITS PLACE ON SPOOL VOLUME   * 74535000
*                                                                     * 74536000
* INPUT  R0    - WORK, UNPREDICTABLE ON EXIT                          * 74537000
*        R1    - WORK, UNPREDICTABLE ON EXIT                          * 74538000
*        R10   - JCT ADDRESS                                          * 74539000
*        R14   - RETURN ADDRESS                                       * 74540000
*        R15   - ENTRY POINT ADDRESS                                  * 74541000
*                                                                     * 74542000
* NOTE   -     BECAUSE OF $WAITS IN THIS ROUTINE, THE PCE AND FIXED   * 74543000
*              SAVE AREAS ARE INELLIGIBLE FOR USE.  THEREFORE, R15    * 74544000
*              MUST BE USED AS A BASE REGISTER, BEING RESTORED AFTER  * 74545000
*              EACH USE BY ANOTHER SERVICE ROUTINE.                   * 74546000
*                                                                     * 74547000
*********************************************************************** 74548000
         SPACE 1                                                     R4 74549000
         ENTRY $#JCTWTR            PROVIDE ENTRY FOR $#JCTWTR RTN    R4 74550000
         USING JCTDSECT,JCT        PROVIDE JCT ADDRESSABILITY        R4 74551000
         USING $#JCTWTR,R15        PROVIDE LOCAL ADDRESSABILITY      R4 74552000
         SPACE 1                                                     R4 74553000
         CNOP  0,8                                                   R4 74554000
$#JCTWTR ST    LINK,PCESAVEA       SAVE RETURN ADDRESS               R4 74555000
         ST    JCT,PCEBUFAD        JCT BUFFER ADDRESS TO DA DCT      R4 74556000
         LH    R0,$#JCTQCT         ENTRIES IN RESIDENT JCT QUEUE     R4 74557000
         L     R1,$#JCTQ           POINT TO 1ST QUEUE ENTRY          R4 74558000
         EJECT                                                       R4 74559000
*********************************************************************** 74560000
*                                                                     * 74561000
*        SEARCH RESIDENT JCT QUEUE FOR THE JCT BEING WRITTEN          * 74562000
*                                                                     * 74563000
*********************************************************************** 74564000
         SPACE 1                                                     R4 74565000
WRSRCH   CLM   JCT,7,1(R1)         IS THIS ENTRY FOR THE JCT...      R4 74566000
         BE    WRLOCK              BRANCH IF YES                     R4 74567000
         LA    R1,8(,R1)           STEP TO NEXT ENTRY                R4 74568000
         BCT   R0,WRSRCH           BRANCH IF NOT AT END OF QUEUE     R4 74569000
         MVC   PCESEEK,PCESAVEA    SAVE RETURN ADDRESS               R4 74570000
         B     $#JCTWER            JCT NOT FOUND - ERROR             R4 74571000
         SPACE 1                                                     R4 74572000
*********************************************************************** 74573000
*                                                                     * 74574000
*        QUEUE ENTRY FOR THIS JCT FOUND - WAIT IF LOCKED              * 74575000
*                                                                     * 74576000
*********************************************************************** 74577000
         SPACE 1                                                     R4 74578000
         CNOP  0,8                                                   R4 74579000
WRLOCK   TM    4(R1),X'80'         IS ELEMENT LOCKED...              R4 74580000
         BZ    WRJQE               BRANCH IF NO                      R4 74581000
        $WAIT  ABIT                WAIT FOR ELEMENT LOCK             R4 74582000
         L     R15,$JCTWTR         RESTORE BASE                      R4 74583000
         B     WRLOCK              TRY AGAIN                         R4 74584000
         SPACE 1                                                     R4 74585000
*********************************************************************** 74586000
*                                                                     * 74587000
*        SET ELEMENT LOCK AND WRITE JCT TO SPOOL                      * 74588000
*                                                                     * 74589000
*********************************************************************** 74590000
         SPACE 1                                                     R4 74591000
         CNOP  0,8                                                   R4 74592000
WRJQE    OI    4(R1),X'80'         SET ELEMENT LOCK                  R4 74593000
         LR    JCT,R1              HOLD JCT QUEUE ELEMENT ADDRESS    R4 74594000
         L     R1,4(,JCT)          ADDRESS JQE FOR THIS JCT          R4 74595000
         SPACE 1                                                     R4 74596000
         USING JQEDSECT,R1         PROVIDE JQE ADDRESSABILITY        R4 74597000
         SPACE 1                                                     R4 74598000
         MVC   PCESEEK,JQETRAK     JCT TRACK ADDRESS TO DA DCT       R4 74599000
         SPACE 1                                                     R4 74600000
         DROP  R1                  KILL JQE ADDRESSABILITY           R4 74601000
         SPACE 1                                                     R4 74602000
         MVI   PCEDEVTP,PCEDAWR    SET DA DCT TO WRITE               R4 74603000
         LA    R1,PCEDADCT         ADDRESS DA DCT                    R4 74604000
        $EXCP  (R1),WAIT=YES       WRITE JCT TO SPOOL                R4 74605000
         L     R15,$JCTWTR         RESTORE BASE                      R4 74606000
         EJECT                                                       R4 74607000
*********************************************************************** 74608000
*                                                                     * 74609000
*        CHECK STATUS OF JCT WRITE                                    * 74610000
*                                                                     * 74611000
*********************************************************************** 74612000
         SPACE 1                                                     R4 74613000
         BO    WRJCTOK             BRANCH IF COMPLETE AND GOOD       R4 74614000
         SPACE 1                                                     R4 74615000
*********************************************************************** 74616000
*                                                                     * 74617000
*        WRITE ERROR INDICATED BY ECB COMPLETION CODE                 * 74618000
*                                                                     * 74619000
*********************************************************************** 74620000
         SPACE 1                                                     R4 74621000
         MVC   PCESEEK,PCESAVEA    SAVE RETURN ADDRESS               R4 74622000
         SPACE 1                                                     R4 74623000
$#JCTWER $DISTERR                  INDICATE CONTROL BLOCK ERROR      R4 74624000
         MVC   PCESAVEA,PCESEEK    RESTORE RETURN ADDRESS            R4 74625000
         L     R15,$JCTWTR         RESTORE BASE                      R4 74626000
         SPACE 1                                                     R4 74627000
WRJCTOK  NI    4(JCT),X'7F'        RESET ELEMENT LOCK FLAG           R4 74628000
         L     JCT,PCEBUFAD        ADDRESS JCT BUFFER                R4 74629000
         L     LINK,PCESAVEA       RESTORE RETURN ADDRESS            R4 74630000
         BR    LINK                RETURN TO CALLER                  R4 74631000
         SPACE 1                                                     R4 74632000
         DROP  JCT,R15             KILL JCT, LOCAL ADDRESSABILITY    R4 74633000
         TITLE 'HASP JOB OUTPUT TABLE SERVICES -- JCT FREE ROUTINE'  R4 74634000
*********************************************************************** 74635000
*                                                                     * 74636000
*        $#JCTFRE -- RELEASE OWNERSHIP OF RESIDENT JCT                * 74637000
*                                                                     * 74638000
* INPUT  R0    - WORK, UNPREDICTABLE ON EXIT                          * 74639000
*        R1    - WORK, UNPREDICTABLE ON EXIT                          * 74640000
*        R10   - JCT ADDRESS                                          * 74641000
*        R14   - RETURN ADDRESS                                       * 74642000
*        R15   - ENTRY POINT ADDRESS                                  * 74643000
*                                                                     * 74644000
* NOTE   -     BECAUSE OF $WAITS IN THIS ROUTINE, THE PCE AND FIXED   * 74645000
*              SAVE AREAS ARE INELLIGIBLE FOR USE.  THEREFORE, R15    * 74646000
*              MUST BE USED AS A BASE REGISTER, BEING RESTORED AFTER  * 74647000
*              EACH USE BY ANOTHER SERVICE ROUTINE.                   * 74648000
*                                                                     * 74649000
*********************************************************************** 74650000
         SPACE 1                                                     R4 74651000
         ENTRY $#JCTFRE            PROVIDE ENTRY FOR $#JCTFRE RTN    R4 74652000
         USING JCTDSECT,JCT        PROVIDE JCT ADDRESSABILITY        R4 74653000
         USING $#JCTFRE,R15        PROVIDE LOCAL ADDRESSABILITY      R4 74654000
         SPACE 1                                                     R4 74655000
         CNOP  0,8                                                   R4 74656000
$#JCTFRE LTR   JCT,JCT             IS BUFFER BASE ZERO...            R4 74657000
         BZR   LINK                RETURN TO CALLER IF YES           R4 74658000
         ST    LINK,PCESAVEA       SAVE RETURN ADDRESS               R4 74659000
         LH    R0,$#JCTQCT         ENTRIES IN RESIDENT JCT QUEUE     R4 74660000
         L     R1,$#JCTQ           POINT TO 1ST QUEUE ENTRY          R4 74661000
         SPACE 1                                                     R4 74662000
*********************************************************************** 74663000
*                                                                     * 74664000
*        SEARCH RESIDENT JCT QUEUE FOR THE JCT BEING FREED            * 74665000
*                                                                     * 74666000
*********************************************************************** 74667000
         SPACE 1                                                     R4 74668000
FRSRCH   CLM   JCT,7,1(R1)         IS THIS ENTRY FOR THE JCT...      R4 74669000
         BE    FRFIND              BRANCH IF YES                     R4 74670000
         LA    R1,8(,R1)           STEP TO NEXT ENTRY                R4 74671000
         BCT   R0,FRSRCH           BRANCH IF NOT AT END OF QUEUE     R4 74672000
         L     JCT,PCESAVEA        SAVE RETURN ADDRESS               R4 74673000
         SPACE 1                                                     R4 74674000
$#JCTFER $DISTERR                  INDICATE CONTROL BLOCK ERROR      R4 74675000
         ST    JCT,PCESAVEA        RESTORE RETURN ADDRESS            R4 74676000
         L     LINK,PCESAVEA       RESTORE RETURN ADDRESS            R4 74677000
         BR    LINK                RETURN TO CALLER                  R4 74678000
         EJECT                                                       R4 74679000
*********************************************************************** 74680000
*                                                                     * 74681000
*        QUEUE ENTRY FOR THIS JCT FOUND - DECREMENT USE COUNT         * 74682000
*                                                                     * 74683000
*********************************************************************** 74684000
         SPACE 1                                                     R4 74685000
         CNOP  0,8                                                   R4 74686000
FRFIND   SLR   R0,R0               CLEAR REGISTER                    R4 74687000
         IC    R0,0(,R1)           GET USE COUNT                     R4 74688000
         BCT   R0,FRNZ             DECREMENT AND BRANCH IF NOT ZERO  R4 74689000
         SPACE 1                                                     R4 74690000
*********************************************************************** 74691000
*                                                                     * 74692000
*        RESULTANT USE COUNT IS ZERO - FREE BUFFER AND QUEUE ENTRY    * 74693000
*                                                                     * 74694000
*********************************************************************** 74695000
         SPACE 1                                                     R4 74696000
         XC    0(8,R1),0(R1)       FREE QUEUE ENTRY                  R4 74697000
        $FREEBUF (JCT)             FREE BUFFER CONTAINING JCT        R4 74698000
         L     LINK,PCESAVEA       RESTORE RETURN ADDRESS            R4 74699000
         BR    LINK                RETURN TO CALLER                  R4 74700000
         SPACE 1                                                     R4 74701000
*********************************************************************** 74702000
*                                                                     * 74703000
*        RESULTANT USE COUNT IS NOT ZERO - STORE NEW VALUE            * 74704000
*                                                                     * 74705000
*********************************************************************** 74706000
         SPACE 1                                                     R4 74707000
         CNOP  0,8                                                   R4 74708000
FRNZ     STC   R0,0(,R1)           STORE UPDATED USE COUNT           R4 74709000
         L     LINK,PCESAVEA       RESTORE RETURN ADDRESS            R4 74710000
         BR    LINK                RETURN TO CALLER                  R4 74711000
         SPACE 1                                                     R4 74712000
         DROP  JCT,R15             KILL JCT, LOCAL ADDRESSABILITY    R4 74713000
         TITLE 'HASP $$WTO/$$WTOR PROCESSING ROUTINE'                R4 74714000
*********************************************************************** 74715000
*                                                                     * 74716000
*        $$WTO - ISSUE DIRECT WTO/WTOR TO OPERATOR                    * 74717000
*                                                                     * 74718000
*        R1    - ADDRESS OF WTO/WTOR MESSAGE                          * 74719000
*        R13   - SAVE AREA ADDRESS                                    * 74720000
*        R14   - RETURN ADDRESS                                       * 74721000
*        R15   - ENTRY POINT ADDRESS                                  * 74722000
*                                                                     * 74723000
* NOTES                                                               * 74724000
*                                                                     * 74725000
*        THE MESSAGE TEXT MAY BE ALTERED BY THIS ROUTINE              * 74726000
*                                                                     * 74727000
*********************************************************************** 74728000
         SPACE 1                                                     R4 74729000
         USING $$WTOR,R15          PROVIDE LOCAL ADDRESSABILITY      R4 74730000
         ENTRY $$WTOR              ENTRY TO $$WTO/$$WTOR ROUTINE     R4 74731000
         SPACE 1                                                     R4 74732000
$$WTOR   STM   R14,R2,12(R13)      SAVE WORK REGISTERS               R4 74733000
         SPACE 1                                                     R4 74734000
         DROP  R15                 RE-ESTABLISH                      R4 74735000
         BALR  R2,0                 LOCAL                            R4 74736000
         USING *,R2                  ADDRESSABILITY                  R4 74737000
         SPACE 1                                                     R4 74738000
         LR    R14,R1              SAVE MESSAGE ADDRESS              R4 74739000
         CLI   0(R1),0             TEST FOR WTO                      R4 74740000
         BE    SKIP190             BR IF YES                         R4 74741000
         LA    R1,8(,R1)            ELSE STEP OVER WTOR INFO         R4 74742000
SKIP190  MVC   4(1,R1),$CCOMCHR    SET MESSAGE ID CHARACTER          R4 74743000
         TM    $RUNOPTS,$MSGID     TEST MESSAGE ID OPTION            R4 74744000
         BO    WTOWTO              BR IF CURRENTLY SELECTED          R4 74745000
         LA    R0,13               ASSUME MLWTO OR NO FLAGS    @OZ30033 74745200
         TM    3(R1),X'40'         TEST FOR MLWTO              @OZ30033 74745400
         BO    *+16                BR IF YES                   @OZ30033 74745600
         TM    2(R1),X'80'         TEST FOR ROUTCDE/DESC FLAGS @OZ30033 74745800
         BZ    *+8                 BR IF NO                    @OZ30033 74746000
         LA    R0,9                OVERLAY                     @OZ30033 74746200
         LH    R15,0(,R1)            HASPNNN                         R4 74747000
         SLR   R15,R0                 MESSAGE                        R4 74748000
         EX    R15,WTOOLAY             ID                            R4 74749000
         TM    3(R1),X'40'         TEST FOR MLWTO                    R4 74750000
         BO    WTOMLWTO            BR IF YES                         R4 74751000
         LH    R15,0(,R1)           ELSE                       @OZ30033 74752000
         SH    R15,=H'7'             UPDATE                    @OZ30033 74752500
         STH   R15,0(,R1)             MSG LENGTH               @OZ30033 74753000
         B     WTOWTO              BR TO ISSUE MESSAGE               R4 74754000
         SPACE 1                                                     R4 74755000
WTOOLAY  MVC   5(*-*,R1),12(R1)    *** EXECUTE ONLY ***              R4 74756000
         EJECT                                                       R4 74757000
WTOMLWTO ALR   R15,R1              PAD END OF 1ST LINE OF MLWTO      R4 74758000
         MVC   6(7,R15),=CL7' '     WITH BLANKS                      R4 74759000
         SPACE 1                                                     R4 74760000
WTOWTO   SLR   R0,R0               GET                               R4 74761000
         L     R15,CVTPTR           UCM                              R4 74762000
         L     R15,CVTCUCB-CVT(,R15) ID                              R4 74763000
         SL    R15,=F'4'              OF                             R4 74764000
         L     R15,0(,R15)             CURRENT                       R4 74765000
         L     R15,0(,R15)              MASTER                       R4 74766000
         IC    R0,UCMID-UCMLIST(,R15)    CONSOLE                     R4 74767000
         LR    R1,R14              RELOAD MESSAGE ADDRESS            R4 74768000
         WTO   MF=(E,(1))          ISSUE WTO/WTOR                    R4 74769000
         LM    R14,R2,12(R13)      RESTORE WORK REGISTERS            R4 74770000
         BR    R14                  AND RETURN                       R4 74771000
         SPACE 1                                                     R4 74772000
         DROP  R2                  KILL LOCAL ADDRESSABILITY         R4 74773000
         SPACE 1                                                     R4 74774000
         LTORG                                                       R4 74775000
         TITLE 'HASP ALLOCATE/UNALLOCATE UNIT ROUTINE'               R4 74776000
*********************************************************************** 74777000
*                                                                     * 74778000
*        $DYN  - DYNAMICALLY ALLOCATE OR UNALLOCATE DEVICES           * 74779000
*                                                                     * 74780000
*                                                                     * 74781000
* FUNCTION/OPERATION-                                                 * 74782000
*                                                                     * 74783000
*        $DYN DYNAMICALLY ALLOCATES OR UNALLOCATES A UCB TO HASP      * 74784000
*        BASED UPON THE SETTING OF THE DCTUNAL BIT OF DCTSTAT.        * 74785000
*        $DYN ALSO SETS OR RESETS THE ATTENTION INDEX IN THE UCB      * 74786000
*        IF THE DCTATTN BIT IS ON IN DCTSTAT. IF THE DEVICE IS        * 74787000
*        A 3211 PRINTER, $DYN GETS/FREES AN ERROR LOG AREA            * 74788000
*                                                                     * 74789000
* INPUT - ADDRESS OF DCT IN R1                                        * 74790000
*                                                                     * 74791000
* OUTPUT - CC=1 IF $DYN WAS SUCCESSFUL AND ALTERED DCTUNAL BIT IN     * 74792000
*               DCTSTAT                                               * 74793000
*          CC=0 IF AN ERROR WAS DETECTED IN DCT BIT SETTINGS          * 74794000
*               OR BY SVC 99                                          * 74795000
*                                                                     * 74796000
* REGISTERS -                                                         * 74797000
*                                                                     * 74798000
*        R1    = ADDRESS OF DCT                                       * 74799000
*        WA    = UCB ADDRESS                                          * 74800000
*        WB    = ALLOCATE PARAMETER ADDRESS                           * 74801000
*        WC    = BASE ADDRESS                                         * 74802000
*        WD    = DCT ADDRESS                                          * 74803000
*        R14   = RETURN                                               * 74804000
*                                                                     * 74805000
*********************************************************************** 74806000
         SPACE 1                                                     R4 74807000
         USING DCTDSECT,WD         PROVIDE DCT ADDRESSABILITY        R4 74808000
         USING $DYN,WC             PROVIDE $DYN ADDRESSABILITY       R4 74809000
         SPACE 1                                                     R4 74810000
         CNOP  0,8                                                   R4 74811000
$DYN     STM   LINK,WE,$CSAVREG    SAVE WORK REGISTERS         @OZ20685 74812000
         LR    WC,R15              $DYN BASE                         R4 74813000
         LR    WD,R1               DCT ADDRESSABILITY                R4 74814000
         TM    DCTSTAT,DCTUNAL+DCTDRAIN  TEST DCT STATUS             R4 74815000
         BNM   DYNRTN              BR IF SHOULD TAKE NO ACTION       R4 74816000
         CLI   DCTDEVTP,DCTLNE     IS DEVICE A LINE...               R4 74817000
         BE    DYNGTUCB            BR IF YES                         R4 74818000
         TM    DCTDEVTP,DCTRJE+DCTINT  TEST DEVICE TYPE              R4 74820000
         BNZ   DYNRTN              BRANCH IF REMOTE OR INTERNAL      R4 74824000
         SPACE 1                                                     R4 74825000
DYNGTUCB L     WA,DCTDCB           GET DCB ADDRESS                   R4 74826000
         L     WA,DCBDEBAD-DCBDSECT(,WA) GET DEB ADDRESS FROM DCB    R4 74827000
         ICM   WA,7,DEBSUCBB-DEBDSECT(WA)  GET UCB ADDR FROM DEB     R4 74828000
         BNZ   DYNGTWRK            BR IF VALID UCB ADDRESS     @OZ20685 74829000
         SR    WE,WE               CLEAR REGISTER FOR RETURN   @OZ20685 74829100
         TM    DCTSTAT,DCTUNAL     ALLOCATE OR UNALLOCATE...         R4 74830000
         BO    DYNUNORM            ALLOCATE IS ABNORMAL RETURN       R4 74831000
         B     DYNSTRTN            BR TO UNALLOCATE AND RETURN       R4 74832000
         SPACE 2                                               @OZ20685 74832100
*        GET A BUFFER FOR DYNAMIC ALLOCATION WORK AREA         @OZ20685 74832200
         SPACE 1                                               @OZ20685 74832300
DYNGTWRK DS    0H                                              @OZ20685 74832400
         GETMAIN R,LV=DYNLEN       GET AN ALLOCATION WORK AREA @OZ20685 74832500
         LR    WE,R1               SET REGISTER FOR WORK AREA  @OZ20685 74832700
         SPACE 1                                               @OZ20685 74832710
         USING DYNDSECT,WE         SET WORK AREA ADDRESSABILITY@OZ20685 74832800
         MVC   DYNRSAV,$CSAVREG    SAVE REGS 14-6              @OZ20685 74832850
         SPACE 1                                               @OZ20685 74832900
*        INITIALIZE DYNAMIC ALLOCATION REQUEST BLOCK POINTER   @OZ20685 74833000
         SPACE 1                                               @OZ20685 74833100
         LA    R1,4(,WE)           POINT TO SVC99 REQUEST BLK  @OZ20685 74833300
         ST    R1,DYN99PTR         SAVE REQUEST BLOCK ADDRESS  @OZ20685 74833310
         OI    DYN99PTR,X'80'      SET HIGH ORDER BIT ON       @OZ20685 74833400
         SPACE 2                                               @OZ20685 74833410
*        INITIALIZE TEXT UNIT POINTERS                         @OZ20685 74833420
         SPACE 1                                               @OZ20685 74833430
         LA    R1,DYNUCBTX         GET UCB TEXT ADDRESS        @OZ20685 74833500
         ST    R1,DYNUCBTP          AND SAVE IN TEXT POINTER   @OZ20685 74833600
         LA    R1,DYNDDNTX         GET DDNAME TEXT ADDRESS     @OZ20685 74833700
         ST    R1,DYNDDNTP          AND SAVE IN TEXT POINTER   @OZ20685 74833800
         OI    DYNLASTP,X'80'      SET ON HIGH ORDER BIT IN    @OZ20685X74833810
                                    LAST TEXT UNIT             @OZ20685 74833820
         SPACE 2                                               @OZ20685 74833830
&IECIHDR SETB  1                   TURN OFF IOSGEN DOC.        @OZ20685 74833840
&IECITP  SETB  1                   TURN OFF IOSGEN DOC.        @OZ20685 74833850
         USING UCBDSECT,WA         PICK UP UCB ADDRESSABILIY   @OZ20685 74833860
         SPACE 1                                               @OZ20685 74833870
*        INITIALIZE TEXT UNITS                                 @OZ20685 74833880
         SPACE 1                                               @OZ20685 74833890
         MVC   DYNTXT,DYNTEXT      MOVE IN TEXT UNIT TEMPLATE  @OZ20685 74833900
         MVC   DYNDDNNM,DCTDEVN    STORE DDNAME IN TEXT UNIT   @OZ20685 74833910
         TM    DCTSTAT,DCTUNAL     ALLOCATE OR UNALLOCATE...   @OZ20685 74833920
         BNO   DYN99RB             BR IF UNALLOCATE            @OZ20685 74834000
         MVC   DYNUCBNM,UCBNAME    SAVE UCB UNIT NAME          @OZ20685 74834100
         SPACE 1                                               @OZ20685 74834200
*        INITIALIZE SVC 99 REQUEST BLOCK                       @OZ20685 74834300
         SPACE 1                                               @OZ20685 74834400
         USING S99RB,WB            PICK UP SVC99 ADDRESSABILITY@OZ20685 74834500
         SPACE 1                                               @OZ20685 74834510
DYN99RB  LA    WB,DYNRB            GET REQUEST BLOCK ADRESS    @OZ20685 74834600
         MVI   S99RB,20            SET SIZE OF REQUEST BLOCK   @OZ20685 74834700
         XC    S99VERB(S99RBEND-S99VERB),S99VERB CLEAR AREA    @OZ20685 74834800
         TM    DCTSTAT,DCTUNAL     ALLOCATE OR UNALLOCATE...   @OZ20685 74834900
         BO    DYNAL               BR IF ALLOCATE              @OZ20685 74835000
         LA    R1,DYNDDNTP         GET DDNAME TEXT POINTER     @OZ20685 74835100
         ST    R1,S99TXTPP         STORE TEXT POINTER IN RB    @OZ20685 74835200
         OI    S99VERB,S99VRBUN    SET UNALLOC VERB ON IN RB   @OZ20685 74835300
         B     DYNSET              GO CHECK FOR INITIALIZATION @OZ20685 74835400
DYNAL    TM    UCBSTAT,UCBALOC     DEVICE ALREADY ALLOCATED... @OZ20685 74835500
         BO    DYNUNORM            BR TO ERROR RETURN IF YES   @OZ20685 74835600
         TM    UCBSTAT,UCBONLI+UCBCHGS DEVICE ONLINE...        @OZ20685 74835700
         BNM   DYNUNORM            BR TO ERROR RETURN IF YES   @OZ20685 74835800
         LA    R1,DYNUCBTP         GET UCB TEXT POINTER        @OZ20685 74835900
         ST    R1,S99TXTPP         STORE TEXT POINTER IN RB    @OZ20685 74835910
         OI    S99VERB,S99VRBAL    SET ALLOCATE VERB IN RB     @OZ20685 74836000
         SPACE 1                                               @OZ20685 74837000
DYNSET   CLC   $DYNTCBA,=F'0'      IS THIS INITIALIZATION...   @OZ20685 74838000
         BE    DYNDYN              BR IF YES, NO SUBTASK       @OZ20685 74839000
         SPACE 1                                               @OZ20685 74840000
DYNWAITA TM    $DYNECB,X'40'       IS ALLOC TASK BUSY...       @OZ20685 74841000
         BNO   DYNDYNA             BR IF NO                    @OZ20685 74842000
         $WAIT ALOC                WAIT FOR ALLOC TASK $$POST  @OZ20685 74843000
         B     DYNWAITA            TRY AGAIN                   @OZ20685 74844000
         SPACE 1                                               @OZ20685 74845000
         SPACE 1                                               @OZ20685 74846000
DYNDYNA  LR    R1,WE               GET RB ADDRESS              @OZ20685 74847000
         POST  $DYNECB,(R1)        POST WITH DCT ADDRESS       @OZ20685 74848000
DYNWAITB $WAIT ALOC                WAIT FOR ALLOC TASK $$POST  @OZ20685 74849000
         MVC   $CSAVREG(L'DYNRSAV),DYNRSAV RESTORE REGS 14-6   @OZ20685 74849500
         TM    DYN99PTR,X'7F'      CHECK FOR GOOD RETURN       @OZ20685 74850000
         BZ    DYNWAITB            BR IF NOT COMPLETE          @OZ20685 74850500
         BO    DYNCKATN            BR IF OK                    @OZ20685 74851000
         B     DYNUNORM            RETURN IF NOT               @OZ20685 74852000
*        THIS LINE DELETED BY APAR NUMBER                      @OZ20685 74853000
*        THIS LINE DELETED BY APAR NUMBER                      @OZ20685 74854000
*        THIS LINE DELETED BY APAR NUMBER                      @OZ20685 74855000
*        THIS LINE DELETED BY APAR NUMBER                      @OZ20685 74856000
         SPACE 1                                                     R4 74857000
DYNDYN   DS    0H                                              @OZ20685 74858000
         LA    R1,DYN99PTR         GET REQUEST BLOCK POINTER   @OZ20685 74859000
         DYNALLOC                  CALL DYNAMIC ALLOCATE/UNALOCATE   R4 74860000
         LTR   R15,R15             NORMAL RETURN...                  R4 74861000
         BZ    DYNCKATN            BR IF YES                         R4 74862000
         SPACE 1                                                     R4 74863000
DYNUNORM LTR   WE,WE               DOES A WORK AREA EXIST...   @OZ20685 74864000
         BZ    DYNUNRET            BR IF NO                    @OZ20685 74864100
         FREEMAIN R,LV=DYNLEN,A=(WE) FREE WORK AREA            @OZ20685 74864300
DYNUNRET LM    LINK,WE,$CSAVREG    RESTORE REGISTERS           @OZ20685 74864400
         SR    R15,R15             CC=0 FOR ERROR RETURN             R4 74865000
         BR    LINK                RETURN                            R4 74866000
         SPACE 1                                                     R4 74867000
DYNCKATN DS    0H                  GOOD ALLOCATION RESUMES     @OZ20685 74868000
         FREEMAIN R,LV=DYNLEN,A=(WE) FREE WORK AREA            @OZ20685 74868100
         TM    DCTSTAT,DCTATTN     SHOULD ATTN INDEX BE SET..  @OZ20685 74868200
         BZ    DYNCKPRT            BR IF NO TO CONTINUE              R4 74869000
         SLR   WB,WB               CLEAR WB                          R4 74870000
         TM    DCTSTAT,DCTUNAL     WAS REQUEST ALLOCATE...           R4 74871000
         BZ    DYNATTN             BR IF NO TO REMOVE ATT'N INDEX    R4 74872000
         LA    WB,IECITMOD         SET ATTENTION INDEX TO HASP       R4 74873000
         EJECT                                                       R4 74874000
DYNATTN  LR    LINK,WA             UCB ADDRESS                       R4 74875000
         MODESET EXTKEY=ZERO       SET ZERO PROTECT KEY              R4 74876000
         IOSGEN TP,UCB=(LINK),VAR=ATNMOD,TABLE=(WB) SET ATTN INDEX   R4 74877000
         MODESET EXTKEY=HASP       RESET HASP PROTECT KEY            R4 74878000
         SPACE 1                                                     R4 74879000
DYNCKPRT CLI   DCTDEVTP,DCTPRT     IS DEVICE A LOCAL PRINTER...      R4 74880000
         BNE   DYNSTRTN            BR IF NO                          R4 74881000
         CLI   UCBTBYT4,UCB3211    IS DEVICE A 3211...               R4 74882000
         BE    DYNPRNTR            BR IF YES                         R4 74883000
         CLI   UCBTBYT4,UCB3800    TEST FOR 3800 PRINTER             R4 74884000
         BE    DYNNIPRT            BRANCH IF YES                     R4 74885000
         SPACE 1                                                     R4 74886000
DYNSTRTN XI    DCTSTAT,DCTUNAL     ALLOCATE OR UNALLOCATE DCT        R4 74887000
         SPACE 1                                                     R4 74888000
DYNRTN   LM    LINK,WE,$CSAVREG    RESTORE REGISTERS           @OZ20685 74889000
         OI    $CSAVREG,1          CC=1 FOR NORMAL RETURN            R4 74890000
         BR    LINK                RETURN                            R4 74891000
         SPACE 1                                                     R4 74892000
DYNPRNTR L     WA,UCBXTADR         ADDRESS UCB EXTENSION             R4 74893000
         SPACE 1                                                     R4 74894000
         USING UCBUCS,WA           UCB EXTENSION ADDRESSABILITY      R4 74895000
         SPACE 1                                                     R4 74896000
         MVC   $CSAVREG+36(4),UCBERADR  SAVE UCBERADR                R4 74897000
         LA    WA,UCBERADR         SET ERR LOG ADDR (3211)           R4 74898000
         B     DYNCOM              BRANCH TO COMMON                  R4 74899000
         SPACE 1                                                     R4 74900000
         USING UCBDSECT,WA         RESTORE UCB ADDRESSABILITY        R4 74901000
         SPACE 1                                                     R4 74902000
DYNNIPRT L     WA,UCBXTADR         GET UCB EXT ADDRESS               R4 74903000
         SPACE 1                                                     R4 74904000
         USING UCB3800X,WA         SET UCB EXT ADDRESSABILITY        R4 74905000
         SPACE 1                                                     R4 74906000
         MVC   $CSAVREG+36(4),UCBMDRBF  SAVE UCBMDRBF                R4 74907000
         LA    WA,UCBMDRBF         SET ADDR FOR 3800 PROCESSING      R4 74908000
         ICM   WA,8,=X'FF'         SET SWITCH FOR 3800               R4 74909000
         OI    DCTPPSW2,DCTNINIT   SHOW 3800 NEEDS INITIALIZATION    R4 74910000
         SPACE 1                                                     R4 74911000
         DROP  WA                  KILL ADDRESSABILITY               R4 74912000
         EJECT                                                       R4 74913000
DYNCOM   TM    DCTSTAT,DCTUNAL     ALLOCATE OR UNALLOCATE...         R4 74914000
         BO    DYNPRTAL            BR IF ALLOCATE                    R4 74915000
         CLI   $CSAVREG+36,X'00'   IS OPEN DCB COUNT ZERO...         R4 74916000
         BZ    DYNSTRTN            BRANCH IF ZERO                    R4 74917000
         MVI   $CSAVREG+36,0       CLEAR OPEN DCB COUNT              R4 74918000
         ICM   LINK,15,$CSAVREG+36 GET LOG AREA ADDRESS              R4 74919000
         BZ    DYNSTERA            BRANCH IF NO LOG AREA ADDR.       R4 74920000
         LTR   WA,WA               FREEMAIN FOR 3800...              R4 74921000
         BM    DYNF3800            BR IF YES                         R4 74922000
         SPACE 1                                                     R4 74923000
DYNF3211 FREEMAIN R,LV=DYNL3211,A=(LINK),SP=255 FREE LOG AREA       R41 74924000
         B     DYNFCOM             BRANCH TO COMMON                  R4 74925000
         SPACE 1                                                     R4 74926000
DYNF3800 FREEMAIN R,LV=DYNL3800,A=(LINK),SP=245 FREE MDR AREA       R41 74927000
         SPACE 1                                                     R4 74928000
DYNFCOM  SLR   LINK,LINK           ZERO LINK                         R4 74929000
         ST    LINK,$CSAVREG+36    CLEAR UCB LOG AREA ADDRESS        R4 74930000
         B     DYNSTERA            GO UPDATE UCBERADR                R4 74931000
         SPACE 1                                                     R4 74932000
DYNPRTAL MVI   $CSAVREG+36,1       SET OPEN DCB COUNT                R4 74933000
         LA    LINK,DYNGETMN       GETMAIN RETURN ADDRESS            R4 74934000
         LTR   WA,WA               GETMAIN FOR 3800...               R4 74935000
         BM    DYNG3800            BR IF YES                         R4 74936000
         EJECT                                                       R4 74937000
DYNG3211 GETMAIN EC,LV=DYNL3211,A=(LINK),SP=255 GET LOG AREA        R41 74938000
         B     DYNGCOM             BRANCH TO COMMON                  R4 74939000
         SPACE 1                                                     R4 74940000
DYNG3800 GETMAIN EC,LV=DYNL3800,A=(LINK),SP=245 GET MDR AREA        R41 74941000
         SPACE 1                                                     R4 74942000
DYNGCOM  MVC   $CSAVREG+37(3),DYNGETMN+1 SAVE GETMAIN AREA ADDR.     R4 74943000
         LTR   R15,R15             TEST GETMAIN                      R4 74944000
         BZ    DYNSTERA            BR IF NORMAL RETURN               R4 74945000
         XC    $CSAVREG+36(4),$CSAVREG+36 PRETEND NO AREA GOTTEN     R4 74946000
         SPACE 1                                                     R4 74947000
DYNSTERA MODESET EXTKEY=ZERO       SET ZERO PROTECT KEY              R4 74948000
         MVC   0(4,WA),$CSAVREG+36 SET UCB ERR LOG ADDRESS           R4 74949000
         MODESET EXTKEY=HASP       RESET HASP PROTECT KEY            R4 74950000
         B     DYNSTRTN            RETURN                            R4 74951000
         SPACE 1                                                     R4 74952000
DYNGETMN EQU   $CSAVREG+60,4       GETMAIN ADDRESS AREA              R4 74953000
DYNL3211 EQU   570                 SIZE OF 3211 LOG AREA       @OZ20685 74953100
DYNL3800 EQU   164                 SIZE OF 3800 MDR AREA       @OZ20685 74953200
DYNRQST  DS    0F                  DYNAMIC ALLOCATION PARM LIST      R4 74954000
DYNTEXT  DC    X'001500010003'     UNIT NAME TEXT LIST         @OZ20685 74955000
         DS    CL3                 SPACE FOR UCB NAME          @OZ20685 74956000
         DC    X'000100010008'     DDNAME TEXT LIST            @OZ20685 74957000
         SPACE 2                                               @OZ20685 74957100
DYNDSECT DSECT                     ALLOCATION REQUEST BLOCK    @OZ20685 74957200
         SPACE 2                                               @OZ20685 74957300
*        SVC 99 REQUEST BLOCK POINTER                          @OZ20685 74957400
         SPACE 1                                               @OZ20685 74957500
DYN99PTR DS    F                   ADDRESS OF SVC99 RQST BLOCK @OZ20685 74957600
         SPACE 2                                               @OZ20685 74957700
*        SVC 99 REQUEST BLOCK                                  @OZ20685 74957800
         SPACE 1                                               @OZ20685 74957900
DYNRB    DS    CL(S99RBEND-S99RB)  ALLOCATION REQUEST BLOCK    @OZ20685 74958000
*              ALLOCATION TEXT UNIT POINTERS                   @OZ20685 74958100
DYNTXTP  DS    0CL8                FIRST TEST UNIT POINTER     @OZ20685 74959000
DYNUCBTP DS    F                   TEXT PTR FOR UCB            @OZ20685 74959100
DYNDDNTP DS    F                   TEXT PTR FOR DDNAME         @OZ20685 74959200
DYNLASTP EQU   *-4,4               LAST TEXT UNIT POINTER      @OZ20685 74959300
*              ALLOCATION TEXT UNIT                            @OZ20685 74959400
DYNTXT   DS    0CL23               DYNAMIC ALLOCATE TEXT UNITS @OZ20685 74960000
DYNUCBTX DS    XL6                 UNIT NAME TEXT LIST         @OZ20685 74961000
DYNUCBNM DS    XL3                 UCB NAME                    @OZ20685 74962000
DYNDDNTX DS    XL6                 DDNAME TEXT LIST            @OZ20685 74963000
DYNDDNNM DS    XL8                 DDNAME FROM DCT             @OZ20685 74964000
         DS    0F                  ALIGN TO WORD BOUNDARY      @OZ20685 74964025
DYNRSAV  DS    CL(4*9)             SAVE AREA FOR 9 REGISTERS   @OZ20685 74964050
         SPACE 1                                               @OZ20685 74964100
DYNLEN   EQU   *-DYNDSECT          LENGTH OF WORK AREA         @OZ20685 74964200
         SPACE 1                                               @OZ20685 74964300
HASPNUC  CSECT                                                 @OZ20685 74965000
*              THIS LINE DELETED BY APAR NUMBER                @OZ20685 74965500
*              THIS LINE DELETED BY APAR NUMBER                @OZ20685 74965600
         SPACE 1                                                     R4 74966000
         DROP  WB,WC,WD                                              R4 74967000
         TITLE 'HASP DISASTROUS ERROR ROUTINE'                       R4 74968000
*********************************************************************** 74969000
*                                                                     * 74970000
*        $DISTERR - DISPLAY THE HASP DISASTROUS ERROR MESSAGE         * 74971000
*                                                                     * 74972000
*        R0    - WORK, UNPREDICTABLE ON EXIT                          * 74973000
*        R1    - WORK, UNPREDICTABLE ON EXIT                          * 74974000
*        R11   - HCT ADDRESS (BASE1)                                  * 74975000
*        R13   - PCE ADDRESS                                          * 74976000
*        R14   - RETURN ADDRESS                                       * 74977000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 74978000
*                                                                     * 74979000
* NOTES                                                               * 74980000
*                                                                     * 74981000
*        THIS ROUTINE IS USED TO INDICATE TO THE OPERATOR SERIOUS     * 74983000
*        UNRECOVERABLE ERRORS HAVE OCCURRED.                          * 74984000
*                                                                     * 74985000
*********************************************************************** 74986000
         SPACE 1                                                     R4 74987000
         USING $DSTERR,R15         PROVIDE LOCAL ADDRESSABILITY      R4 74988000
         ENTRY $DSTERR             ENTRY TO DISASTROUS ERROR RTN     R4 74989000
         SPACE 1                                                     R4 74990000
$DSTERR  STM   LINK,R1,PCELINK     SAVE WORK REGISTERS              R41 74991000
        $GETCMB NUMCMB=1           GET A CMB                        R41 74991200
         L     R15,$DISTERR        RESTORE BASE REGISTER            R41 74991400
         BNZ   DSTCMB              BR IF GOT A CMB                  R41 74991600
         LM    LINK,R1,PCELINK      ELSE RESTORE REGISTERS          R41 74991800
        $WAIT  CMB                   AND WAIT FOR A CMB             R41 74992000
         L     R15,$DISTERR        RESTORE ORIGINAL BASE            R41 74992200
         BR    R15                  AND TRY AGAIN                   R41 74992400
         SPACE 1                                                    R41 74992600
DSTCMB   L     LINK,PCELINK        RESTORE LINK                     R41 74992800
         LA    R1,CMBJOBN-CMB(,R1)  GET CMB MSG TEXT ADDRESS        R41 74993000
         MVC   0(DISASTRL,R1),DISASTER  MOVE TEXT TO CMB            R41 74993200
         MVC   DISASSYM-DISASTER(,R1),0(LINK)  SET SYMBOL NAME      R41 74993400
         MVC   DISASMOD-DISASTER(,R1),8(LINK)  SET MODULE NAME      R41 74993600
         SL    R1,=A(CMBJOBN-CMB)  RESTORE CMB ADDRESS              R41 74994000
        $WTO   (R1),DISASTRL,JOB=NO,CMB=YES,  ISSUE ERROR MSG       R41C74994200
               ROUTE=$ERR+$LOG,CLASS=$ALWAYS,PRI=$HI                 R4 74995000
         LM    LINK,R1,PCELINK     RESTORE REGISTERS                R41 74996000
         B     16(,LINK)            AND RETURN TO CALLER             R4 75000000
         SPACE 1                                                     R4 75002000
         DROP  R15                 KILL LOCAL ADDRESSABILITY         R4 75003000
         SPACE 2                                                     R4 75004000
DSTOFFST DC    A(CMBJOBN-CMB)      OFFSET OF MSG TEXT IN CMB        R41 75004500
DISASTER $MSG  096,'DISASTROUS ERROR AT SYMBOL '                     R4 75005000
DISASSYM DC    CL8'ERRORSYM',C' IN MODULE '                          R4 75006000
DISASMOD DC    CL8'ERRORMOD'                                         R4 75007000
DISASTRL EQU   *-DISASTER          LENGTH OF MESSAGE                 R4 75008000
         TITLE 'HASP INPUT/OUTPUT ERROR ROUTINE'                     R4 75009000
*********************************************************************** 75010000
*                                                                     * 75011000
*        $IOERROR - FORMAT AND DISPLAY HASP I/O ERROR MESSAGE         * 75012000
*                                                                     * 75013000
*        R0    - WORK, UNPREDICTABLE ON EXIT                          * 75014000
*        R1    - BUFFER ADDRESS (IOB FOR EXCP / RPL FOR VTAM)         * 75016000
*        R11   - HCT ADDRESS (BASE1)                                  * 75021000
*        R13   - PCE ADDRESS                                          * 75022000
*        R14   - RETURN ADDRESS                                       * 75023000
*        R15   - ENTRY POINT ADDRESS, UNPREDICTABLE ON EXIT           * 75024000
*                                                                     * 75025000
*********************************************************************** 75026000
         SPACE 1                                                     R4 75027000
         USING BUFDSECT,R1         PROVIDE BUFFER ADDRESSABILITY     R4 75028000
         USING $IOERRTN,WA         PROVIDE LOCAL ADDRESSABILITY      R4 75029000
         ENTRY $IOERRTN            ENTRY TO I/O ERROR ROUTINE        R4 75030000
         SPACE 1                                                     R4 75031000
$IOERRTN STM   LINK,WA,PCELINK     SAVE WORK REGISTERS               R4 75032000
         LR    WA,R15              RELOAD BASE                       R4 75033000
        $GETCMB NUMCMB=1           GET A CMB                        R41 75033100
         BNZ   ERRCMB              BR IF GOT A CMB                  R41 75033200
         LM    LINK,R1,PCELINK     RESTORE REGISTERS                R41 75033300
         CLI   PCEID+1,PCEASYID    TEST PROCESSOR TYPE              R41 75033400
         BE    ERREXIT             EXIT IF $ASYNC PROCESSOR         R41 75033500
         CLI   PCEID+1,PCEMLMID    TEST PROCESSOR TYPE              R41 75033600
         BE    ERREXIT             EXIT IF LINE MANAGER             R41 75033700
         CLI   PCEID+1,PCECONID    TEST PROCESSOR TYPE              R41 75033800
         BE    ERREXIT             EXIT IF COMMAND PROCESSOR        R41 75033900
         L     WA,PCEWA             ELSE RESTORE WA                 R41 75034000
        $WAIT  CMB                   AND WAIT FOR A CMB             R41 75034100
         L     R15,$IOERROR        RESTORE ORIGINAL BASE            R41 75034200
         BR    R15                  AND TRY AGAIN                   R41 75034300
         EJECT                                                      R41 75034400
         USING ERRMSG,LINK         SET MSG TEXT ADDRESSABILITY      R41 75034500
         SPACE 1                                                    R41 75034600
ERRCMB   LA    LINK,CMBJOBN-CMB(,R1) POINT TO MESSAGE AREA          R41 75034700
         MVI   ERRMSG,C' '                BLANK OUT                 R41 75034800
         MVC   ERRMSG+1(ERRMSGL-1),ERRMSG  ENTIRE MESSAGE AREA      R41 75034900
         MVC   ERRMSG(L'ERRMSGNO),ERRMSGNO  MOVE IN MSG TEXT        R41 75035000
         L     R1,PCER1            RESTORE BUFFER ADDRESS           R41 75035100
         TM    BUFTYPE,BUFRPL      CHECK BUFFER TYPE                 R4 75035300
         BO    ERRRPLBF            BRANCH IF VTAM BUFFER            R41 75036000
         LA    R0,ERRMUL           SET UNIT RECORD MESSAGE LENGTH    R4 75038000
         L     R15,BUFDCT          R15 = DCT ADDRESS                 R4 75039000
         USING DCTDSECT,R15        ESTABLISH DCT ADDRESSABILITY      R4 75040000
         MVC   ERRDEVN,DCTDEVN     SET UP HASP DEVICE NAME           R4 75041000
         L     R15,IOBDCBPT        R15 = DCB ADDRESS                 R4 75042000
         USING DCBDSECT,R15        ESTABLISH DCB ADDRESSABILITY      R4 75043000
         L     R15,DCBDEBAD        R15 = DEB ADDRESS                 R4 75044000
         USING DEBDSECT,R15        ESTABLISH DEB ADDRESSABILITY      R4 75045000
         XC    PCER1,PCER1         CLEAR WORK AREA                  R41 75046000
         MVO   PCER1+2(2),IOBXTENT GET 16 * EXTENT NUMBER           R41 75046500
         AL    R15,PCER1           ADJUST ADDRESS FOR EXTENT        R41 75047000
         ST    R1,PCER1            RESTORE IOB ADDRESS IN PCER1     R41 75047500
         L     R15,DEBSUCBA        R15 = UCB ADDRESS                 R4 75048000
         USING UCBDSECT,R15        ESTABLISH UCB ADDRESSABILITY      R4 75049000
         TM    UCBTBYT3,UCB3DACC   TEST DEVICE TYPE                  R4 75050000
         BZ    ERRNOTDA            BRANCH IF NOT DIRECT ACCESS       R4 75051000
         MVC   ERRVOLID,SRTEVOLI   SET UP VOLUME SERIAL              R4 75052000
         MVC   ERRVOLID+6(2),=C'  '  BLANK OUT REST OF FIELD        R41 75053000
         LA    R0,ERRML            SET LENGTH OF MESSAGE             R4 75054000
         SPACE 1                                                     R4 75055000
ERRNOTDA MVC   ERRNAME,UCBNAME     SET UP UNIT ADDRESS               R4 75056000
         MVI   ERRNAME+L'ERRNAME,C',' INSERT COMMA                  R41 75056500
         DROP  R15                 KILL UCB ADDRESSABILITY           R4 75057000
         L     R15,IOBCSW-1        R15 = ADDRESS OF                  R4 75058000
         LA    R15,0(,R15)          LAST                             R4 75059000
         S     R15,=F'8'              COMMAND                       R41 75060000
         BM    ERRNOIO             USE IOBSTART IF NEGATIVE          R4 75061000
         TM    BUFTYPE,BUFTP       TEST BUFFER TYPE                  R4 75062000
         BO    ERRRJE              BRANCH IF RJE ERROR               R4 75063000
         TM    IOBECBCC,X'01'      TEST COMPLETION CODE              R4 75064000
         BZ    ERRNOIO             BRANCH IF NO I/O HAS OCCURRED     R4 75065000
         SPACE 1                                                     R4 75066000
ERRRJE   TM    IOBSIOCC,X'10'      TEST SIO COMPLETION               R4 75067000
         BZ    ERRSIOOK            BRANCH IF SUCCESSFUL SIO          R4 75068000
         SPACE 1                                                     R4 75069000
ERRNOIO  L     R15,IOBSTART        GET FIRST COMMAND ADDRESS         R4 75070000
         EJECT                                                       R4 75071000
ERRSIOOK UNPK  ERRCOM,0(2,R15)     SET UP COMMAND CODE               R4 75072000
         UNPK  ERRSTAT,IOBCSW+3(3) SET UP STATUS BYTES               R4 75073000
         UNPK  ERRSENS,IOBSENS0(3) SET UP SENSE BYTES                R4 75074000
         UNPK  ERRSEEK,IOBSEEK(8)  SET UP SEEK ADDRESS               R4 75075000
         TM    BUFTYPE,BUFTP       TEST FOR TP ERROR                 R4 75076000
         BNO   ERRNOTTP            BRANCH IF NOT TP ERROR            R4 75077000
         UNPK  ERRTPCDE,5(2,R15)   SET UP TP COMMAND SEQUENCE TYPE   R4 75078000
         UNPK  ERRTPCDE+2,LCBACK(2)     SET UP CURRENT BSC ACK       R4 75079000
         LA    R0,ERRMBSCL         GET BSC TP ERROR MSG LENGTH       R4 75080000
         B     ERRNOTTP            BRANCH FOR FURTHER MSG SETUP      R4 75082000
         SPACE 1                                                     R4 75083000
         USING RPLDSECT,R1         PROVIDE RPL ADDRESSABILITY        R4 75084000
ERRRPLBF L     R15,RPLICE          GET ICE ADDRESS                  R41 75084100
         LTR   R15,R15             TEST ICE ADDRESS                 R41 75084200
         BZ    ERRRPL              IF NO ICE GO USE DEVICE DCT      R41 75084300
         L     R15,ICERDCT-ICEDSECT(,R15) GET REMOTE DCT            R41 75084400
         LTR   R15,R15             TEST REMOTE DCT                  R41 75084500
         BNZ   ERRDNAME            IF THERE, USE REMOTE DCT         R41 75084600
ERRRPL   L     R15,RPLDCT          GET ADDR OF LOGON/LINE DCT        R4 75085000
         USING DCTDSECT,R15        TEMPORARY DCT ADDRESSABILITY      R4 75086000
ERRDNAME MVC   ERRDEVN,DCTDEVN     MOVE DEVICE NAME TO MSG          R41 75087000
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 75088000
         MVC   ERRNAME(L'ERRNAME+1),=C'SNA,' USE 'SNA' AS ADDR      R41 75089000
         UNPK  ERRCOM,RPLREQ(2)    SET UP RPL REQUEST CODE           R4 75090000
         UNPK  ERRSTAT,RPLRLEN+2(3)    SET R.U. LENGTH               R4 75091000
         UNPK  ERRSENS,RPLSSNSI(3) SET UP SYSTEM SENSE INFORMATION   R4 75092000
         UNPK  ERRTPCD1,RPLSEQTP(5)  COPY SEQTTYPE, & RTNCD/FDBK2   R41 75093000
         TM    RPLOPT12,RPLFMHDR   TEST FOR FM HEADER PRESENT       R41 75093100
         BZ    ERRRPL1             BR IF NO, SKIP FMH PROCESSING    R41 75093200
         UNPK  ERRTPCD2,RPLBUFST+FMHBYTE1-FMHDSECT(2) COPY FMH TYPE R41 75093300
ERRRPL1  UNPK  ERRTPCD3,RPLRH3(5)  COPY BRAKET, CHAIN & SRTYPE      R41 75093400
         BZ    ERRRPL2             BRACNH IF NOT FM HEADER          R41 75093500
         CLI   RPLBUFST+FMHBYTE1-FMHDSECT,FMHTYPE1  TEST FMH TYPE   R41 75093600
         BNE   ERRRPL2             BRANCH IF NOT TYPE 1             R41 75093700
         UNPK  ERRTPCD4,RPLBUFST+FMHPROPS-FMHDSECT(2) COPY TYPE1    R41C75093800
                                                    ATTRIBUTES      R41 75093900
ERRRPL2  UNPK  ERRTPCD5,RPLVTFL2(5)  COPY VTAM FLAGS & DFC BITS     R41 75094000
         LA    R0,ERRMSNAL         GET SNA TP ERROR MSG LENGTH       R4 75095000
         SPACE 1                                                     R4 75097000
ERRNOTTP TR    ERRINFO,$HEXTRAN    TRANS INFORMATION TO EBCDIC @OZ32566 75098000
         MVI   ERRCOM+2,C','       INSERT                            R4 75099000
         MVI   ERRSTAT+4,C','       SEPARATION                       R4 75100000
         MVI   ERRSENS+4,C','        COMMAS                          R4 75101000
         SL    LINK,=A(CMBJOBN-CMB)  RESTORE CMB ADDRESS            R41 75101500
        $WTO   (LINK),(R0),JOB=NO,CMB=YES,  ISSUE ERROR MESSAGE     R41C75102000
               ROUTE=$LOG+$ERR+$TP,CLASS=$ALWAYS,PRI=$HI             R4 75103000
         LM    LINK,R1,PCELINK     RESTORE REGISTERS                 R4 75104000
         EJECT                                                      R41 75115000
ERREXIT  L     WA,PCEWA            RESTORE WA                        R4 75116000
         USING BUFDSECT,R1         ESTABLISH BUFFER ADDRESSABILITY   R4 75118000
         TM    BUFECBCC,X'7F'      RESET I/O CONDITION CODE          R4 75120000
         BR    LINK                 AND RETURN                       R4 75121000
         SPACE 1                                                     R4 75122000
         DROP  WA                  KILL LOCAL ADDRESSABILITY         R4 75123000
         DROP  R1                  KILL BUFFER ADDRESSABILITY        R4 75124000
         DROP  LINK                KILL MSG TEXT ADDRESSABILITY     R41 75124500
         SPACE 2                                                    R41 75125000
ERRMSGNO $MSG  094,'I/O ERROR ON ' ERROR MESSAGE                    R41 75126000
         SPACE 2                                                    R41 75127000
ERRMSG   DSECT                                                      R41 75128000
ERRPRFIX DC    CL(L'ERRMSGNO)' '   ERROR MESSAGE HEADER             R41 75128500
ERRVOLID DC    0CL6' '             VOLUME SERIAL (DA ONLY)           R4 75129000
ERRDEVN  DC    CL8' ',C' '         HASP DEVICE NAME (NON-DA)         R4 75130000
ERRNAME  DC    CL3' ',C','         UNIT ADDRESS                      R4 75131000
ERRCOM   DC    CL3' '              COMMAND CODE                      R4 75133000
ERRSTAT  DC    CL5' '              ERROR STATUS                      R4 75134000
ERRSENS  DC    CL5' '              SENSE INFORMATION                 R4 75135000
ERRMUL   EQU   *-ERRMSG-1                                            R4 75136000
ERRMBSCL EQU   *-ERRMSG+4                                            R4 75137000
ERRML    EQU   *-ERRMSG+14                                           R4 75138000
ERRSEEK  DC    0CL15' '            SEEK ADDRESS (DA ONLY)            R4 75139000
ERRTPCDE DC    0CL3' '             BSC                              R41 75140000
ERRTPCD1 DC    0CL9' '              AND                             R41 75140100
         DC    CL6' '                SNA                            R41 75140200
ERRTPCD2 DC    0CL3' '                EXTENDED                      R41 75140300
         DC    CL2' '                  REMOTE                       R41 75140400
ERRTPCD3 DC    0CL9' '                  JOB                         R41 75140500
         DC    CL6' '                    ENTRY                      R41 75140600
ERRTPCD4 DC    0CL3' '                    TELEPROCESSING            R41 75140700
         DC    CL2' '                      IAGNOSIC               R41 75140800
ERRTPCD5 DC    CL9' '                        INFORMATION            R41 75140900
         SPACE 2                                                    R41 75141000
ERRINFO  EQU   ERRCOM,*-ERRCOM     BYTES REQUIRING HEX XLATE        R41 75141100
ERRMSNAL EQU   *-ERRMSG-1                                            R4 75144000
ERRMSGL  EQU   *-ERRMSG            MAXIMUM MESSAGE LENGTH           R41 75144100
HASPNUC  CSECT                                                      R41 75144200
         SPACE 2                                                    R41 75144300
         LTORG                                                 @OZ32566 75145000
         TITLE 'HASP CATASTROPHIC ERROR SERVICES'              @OZ32566 75145100
****************************************************************OZ32566 75145200
*                                                              *OZ32566 75145300
*        $ERROR - JES2 CATASTROPHIC ERROR ROUTINE              *OZ32566 75145400
*                                                              *OZ32566 75145500
*        R0    - ADDRESS OF 4-BYTE ERROR CODE                  *OZ32566 75145600
*                (POINTS TO 1ST BYTE FOLLOWING CALLING SEQ)    *OZ32566 75145700
*        BASE1 - ENTRY POINT ADDRESS                           *OZ32566 75145800
*                                                              *OZ32566 75145900
* NOTE   - THIS ROUTINE IS ENTERED BY THE JES2 MAIN TASK VIA   *OZ32566 75146000
*          THE $ERROR MACRO WHEN A CATASTROPHE IS DETECTED     *OZ32566 75146100
*                                                              *OZ32566 75146200
****************************************************************OZ32566 75146300
         SPACE 1                                               @OZ32566 75146400
         ENTRY $ERRORTN            PROVIDE $ERRORTN ENTRY      @OZ32566 75146500
         USING $ERRORTN,BASE1      PROVIDE LOCAL ADDRESSABILITY@OZ32566 75146600
         SPACE 1                                               @OZ32566 75146700
$ERRORTN STM   R0,R15,ERRORSAV     SAVE REGISTERS              @OZ32566 75146800
         LA    BASE2,$ABEND        LOAD BASE REGISTER          @OZ32566 75146900
         LR    WA,R0               SAVE ADDR OF ERROR CODE     @OZ32566 75147000
         LA    WA,0(,WA)           PURIFY                      @OZ32566 75147100
         MVI   HEXITFLG,HEXJES2    SHOW $ERROR                 @OZ32566 75147200
         B     EROUTINE             AND BR TO CONTINUE         @OZ32566 75147300
         SPACE 1                                               @OZ32566 75147400
         USING HASP,BASE1          RESTORE HCT ADDRESSABILITY  @OZ32566 75147500
         SPACE 2                                               @OZ32566 75147600
****************************************************************OZ32566 75147700
*                                                              *OZ32566 75147800
*        $ABEND - JES2 ABEND PROCESSING  (ESTAE EXIT)          *OZ32566 75147900
*                                                              *OZ32566 75148000
*        R1    - ADDRESS OF SDWA         IF R0 NOT = 12        *OZ32566 75148100
*              - ABEND CODE (NO SDWA)    IF R0     = 12        *OZ32566 75148200
*        R14   - RETURN ADDRESS (TO MVS)                       *OZ32566 75148300
*        R15   - ENTRY POINT ADDRESS                           *OZ32566 75148400
*                                                              *OZ32566 75148500
* NOTE - THIS ROUTINE IS ENTERED BY THE OPERATING SYSTEM WHEN A*OZ32566 75148600
*        JES2 ABEND OCCURS                                     *OZ32566 75148700
*                                                              *OZ32566 75148800
****************************************************************OZ32566 75148900
         SPACE 1                                               @OZ32566 75149000
         USING $ABEND,R15          PROVIDE LOCAL ADDRESSABILITY@OZ32566 75149200
         SPACE 1                                               @OZ32566 75149300
$ABEND   STM   R0,R15,ERRORSAV     SAVE REGISTERS              @OZ32566 75149400
         LR    BASE2,R15           LOAD BASE REGISTER          @OZ32566 75149500
         MVI   HEXITFLG,HEXSYS     SHOW SYSTEM ABEND           @OZ32566 75149600
         SPACE 1                                               @OZ32566 75149700
         DROP  R15                 RE-ESTABLISH                @OZ32566 75149800
         USING $ABEND,BASE2,R10     $ABEND ADDRESSABILITY      @OZ32566 75149900
         EJECT                                                 @OZ32566 75150000
         USING SDWA,WF             PROVIDE SDWA ADDRESSABILITY @OZ32566 75150100
         USING EELDSECT,WG         PROVIDE EEL  ADDRESSABILITY @OZ32566 75150200
         SPACE 1                                               @OZ32566 75150300
****************************************************************OZ32566 75150400
*                                                              *OZ32566 75150500
*        OBTAIN AND INITIALIZE JES2 ESTAE ELEMENT (EEL)        *OZ32566 75150600
*                                                              *OZ32566 75150700
****************************************************************OZ32566 75150800
         SPACE 1                                               @OZ32566 75150900
EROUTINE LA    R10,2048(,BASE2)    LOAD SECOND                 @OZ32566 75151000
         LA    R10,2048(,R10)       BASE REGISTER              @OZ32566 75151100
         SPACE 1                                               @OZ32566 75151200
         L     BASE1,MAPNUCA       ENSURE HCT ADDRESSABILITY   @OZ32566 75151300
         LA    R13,ERRXSAVE        PROVIDE EXTERNAL SAVE AREA  @OZ32566 75151400
         SPACE 1                                               @OZ32566 75151700
         SLR   WF,WF               CLEAR SDWA ADDRESS          @OZ32566 75151800
         LA    WG,EEL              LOAD EEL ADDRESS            @OZ32566 75152000
         LR    R0,WG               CLEAR                       @OZ32566 75152200
         LA    R1,EELSIZE           ESTAE                      @OZ32566 75152400
         MVCL  R0,R14                ELEMENT                   @OZ32566 75152600
         TM    HEXITFLG,HEXJES2    JES2 ABEND ($ERROR)...      @OZ32566 75152800
         BZ    ERRSYS              BR IF NO                    @OZ32566 75152900
         OI    EELFLAGS,EELJESAB    ELSE SHOW VOLUNTARY CRUMP  @OZ32566 75153000
         MVC   EELCODE+1(3),0(WA)  SET JES2 ERROR CODE         @OZ32566 75153100
         MVI   EELCODE,C'$'        INSERT $ TO SHOW VOL CRUMP  @OZ32566 75153150
         ST    BASE1,ERRORSAV+BASE1*4  ENSURE BASE1 IS HCT ADDR@OZ32566 75153200
         MVC   EELREGS,ERRORSAV    SET REGISTERS AT $ERROR TIME@OZ32566 75153300
         OI    EELFLAGS,EELREGSA   SHOW REGS AVAILABLE         @OZ32566 75153400
         SH    WA,ERRMACL          SET FAILURE                 @OZ32566 75153500
         ST    WA,EELFADDR          ADDRESS                    @OZ32566 75153600
         B     ERRCHPCE              AND BR TO CONTINUE        @OZ32566 75153700
         SPACE 1                                               @OZ32566 75153800
ERR     $ERROR                     DUMMY $ERROR EXPANSION      @OZ32566 75153900
ERRMACL  DC    AL2(*-ERR-4)        LENGTH OF $ERROR EXPANSION  @OZ32566 75154000
         EJECT                                                 @OZ32566 75154100
ERRSYS   OI    EELFLAGS,EELSYSAB   SHOW SYSTEM ABEND           @OZ32566 75154200
         CLI   ERRORSAV+R0*4+3,12  IS SDWA AVAILABLE...        @OZ32566 75154300
         BNE   ERRSYSDW            BR IF YES                   @OZ32566 75154400
         UNPK  EELCODE+1(3),ERRORSAV+R1*4+1(2)  SET ABEND CODE @OZ32566 75154500
         B     ERRSYSC              AND BR TO CONTINUE         @OZ32566 75154600
         SPACE 1                                               @OZ32566 75154700
ERRSYSDW L     WF,ERRORSAV+R1*4    ADDRESS OF SDWA             @OZ32566 75154800
         UNPK  EELCODE+1(3),SDWACMPC(2)  SET ABEND CODE        @OZ32566 75154900
         MVC   EELREGS,SDWAGRSV    SET REGISTERS AT ABEND TIME @OZ32566 75155000
         OI    EELFLAGS,EELREGSA   SHOW REGS AVAILABLE         @OZ32566 75155100
         SLR   WB,WB               GET LENGTH OF FAILING       @OZ32566 75155200
         IC    WB,SDWAILC1          INSTRUCTION (IN BYTES)     @OZ32566 75155300
         STC   WB,EELILC           SET ILC                     @OZ32566 75155400
         MVC   EELPSW(8),SDWAEC1   SET PSW                     @OZ32566 75155500
         L     WA,EELPSW+4         SET                         @OZ32566 75155600
         SLR   WA,WB                FAILURE                    @OZ32566 75155700
         ST    WA,EELFADDR           ADDRESS                   @OZ32566 75155800
         SPACE 1                                               @OZ32566 75155900
ERRSYSC  LA    WA,EELCODE          EDIT                        @OZ32566 75156000
         OI    3(WA),X'F0'          ABEND                      @OZ32566 75156100
         TR    1(3,WA),$HEXTRAN      CODE                      @OZ32566 75156200
         MVI   0(WA),C'S'          INSERT 'S' FOR SYSTEM ABEND @OZ32566 75156300
         SPACE 1                                               @OZ32566 75156400
         DROP  WF                  KILL SDWA ADDRESSABILITY    @OZ32566 75156500
         SPACE 1                                               @OZ32566 75156600
****************************************************************OZ32566 75156700
*                                                              *OZ32566 75156800
*        VERIFY THAT R13 WAS A PCE ADDRESS                     *OZ32566 75156900
*                                                              *OZ32566 75157000
****************************************************************OZ32566 75157100
         SPACE 1                                               @OZ32566 75157200
         DROP  R13                 PROVIDE LOCAL               @OZ32566 75157300
         USING PCEDSECT,R1          PCE ADDRESSABILITY         @OZ32566 75157400
         SPACE 1                                               @OZ32566 75157500
ERRCHPCE L     R1,EELREGS+R13*4    GET R13 AT ABEND-TIME       @OZ32566 75157600
         LTR   R1,R1               ZERO...                     @OZ32566 75157700
         BZ    ERRSVT              BR IF YES                   @OZ32566 75157800
         ST    R1,EELPCE            ELSE SAVE PCE ADDRESS      @OZ32566 75158000
         SPACE 1                                               @OZ32566 75158200
         DROP  R1                  RESTORE STANDARD            @OZ32566 75158300
         USING PCEDSECT,R13         PCE ADDRESSABILITY         @OZ32566 75158400
         EJECT                                                 @OZ32566 75158500
****************************************************************OZ32566 75158600
*                                                              *OZ32566 75158700
*        SIGNAL ALL PROCESSORS THAT JES2 IS GOING DOWN         *OZ32566 75158800
*                                                              *OZ32566 75158900
****************************************************************OZ32566 75159000
         SPACE 1                                               @OZ32566 75159100
ERRSVT   L     R1,$SSVT            SET                         @OZ32566 75159200
         SLR   R0,R0                COMPLETION                 @OZ32566 75159300
         BCTR  R0,0                  CODE INTO                 @OZ32566 75159400
         ST    R0,$SVHASP-SSVT(,R1)   SSVT                     @OZ32566 75159500
         SPACE 3                                               @OZ32566 75159600
****************************************************************OZ32566 75159700
*                                                              *OZ32566 75159800
*        ISSUE 'JES2 CATASTROPHIC ERROR' MSG WITH ABEND/$ERROR *OZ32566 75159900
*        CODE                                                  *OZ32566 75159950
*                                                              *OZ32566 75160000
****************************************************************OZ32566 75160100
         SPACE 1                                               @OZ32566 75160200
         MVC   ERRORMCD,EELCODE    MOVE CODE TO MESSAGE        @OZ32566 75160300
         MVC   ERMSGWRK(ERRORMSL),ERRORMSG MOVE MSG TO WORK    @OZ32566 75160400
         BAL   WE,ERRWTO           TYPE CATASTROPHIC ERROR MSG @OZ32566 75160500
         SPACE 3                                               @OZ32566 75160600
****************************************************************OZ32566 75160700
*                                                              *OZ32566 75160800
*        PRODUCE JES2 ABEND ANALYSIS ON CONSOLE                *OZ32566 75160900
*                                                              *OZ32566 75161000
****************************************************************OZ32566 75161100
         SPACE 1                                               @OZ32566 75161200
         BAL   LINK,ERRATOP        PRODUCE JES2 ABEND ANALYSIS @OZ32566 75161300
         EJECT                                                 @OZ32566 75161400
****************************************************************OZ32566 75161500
*                                                              *OZ32566 75161600
*        ASK FOR JES2 TERMINATION OPTION                       *OZ32566 75161700
*                                                              *OZ32566 75161800
****************************************************************OZ32566 75161900
         SPACE 1                                               @OZ32566 75162000
ERRWTOR  MVI   ERRDWORK,0          INITIALIZE ECB              @OZ32566 75162100
         MVC   EROPTION,$BLANKS     AND CLEAR                  @OZ32566 75162200
         MVI   ERDUMPT,C' '                 REPLY              @OZ32566 75162300
         MVC   ERDUMPT+1(L'ERDUMPT-1),ERDUMPT  AREA            @OZ32566 75162400
         MVC   ERMSGWRK(ERTERMSL),ERTERMSG MOVE MSG TO WORK    @OZ32566 75162500
       $$WTOR  ERMSGWRK            ASK OPERATOR FOR OPTIONS    @OZ32566 75162550
         WAIT  ECB=ERRDWORK        WAIT FOR OPERATOR REPLY     @OZ32566 75162600
         MVC   ERRDWORK(4),EROPTION  SAVE OPTION               @OZ32566 75162700
         OC    ERRDWORK(4),$BLANKS    IN UPPER-CASE            @OZ32566 75162800
         SPACE 1                                               @OZ32566 75162900
****************************************************************OZ32566 75163000
*                                                              *OZ32566 75163100
*        SCAN OPTION TABLE AND GIVE CONTROL TO PROCESSING      *OZ32566 75163200
*        ROUTINE                                               *OZ32566 75163250
*                                                              *OZ32566 75163300
****************************************************************OZ32566 75163400
         SPACE 1                                               @OZ32566 75163500
         LA    WA,8                GET OPTION TABLE ENTRY SIZE @OZ32566 75163600
         LA    WB,EROPTABB         GET ADDR OF LAST  ENTRY     @OZ32566 75163700
         LA    R1,EROPTAB          GET ADDR OF FIRST ENTRY     @OZ32566 75163800
         SPACE 1                                               @OZ32566 75163900
EROPTLUP L     LINK,4(,R1)         SAVE ADDR OF OPTION HANDLER @OZ32566 75164000
         CLC   0(4,R1),ERRDWORK    IS THIS THE OPTION...       @OZ32566 75164100
         BNE   EROPTBLX            BR IF NO                    @OZ32566 75164200
         BALR  LINK,LINK            ELSE ENTER OPTION HANDLER  @OZ32566 75164300
         B     ERRWTOR               AND THEN BR TO ASK AGAIN  @OZ32566 75164400
         SPACE 1                                               @OZ32566 75164500
EROPTBLX BXLE  R1,WA,EROPTLUP      INDEX TO NEXT TABLE ENTRY   @OZ32566 75164600
         B     ERRWTOR             TRY AGAIN IF UNKNOWN OPTION @OZ32566 75164700
         SPACE 3                                               @OZ32566 75164800
EROPTAB  DS    0F                  TABLE OF ABEND OPTIONS      @OZ32566 75164900
         SPACE 1                                               @OZ32566 75165000
         DC    CL4'DUMP',A(ERRORDMW)  PRODUCE SYSTEM DUMP      @OZ32566 75165100
         DC    CL4'EXIT',A(ERRORRET)  QUICK EXIT               @OZ32566 75165200
         DC    CL4'PURG',A($HEXIT)    CLEAN                    @OZ32566 75165300
         DC    CL4'SNAP',A(ERRATOP)   PRODUCE ABEND ANALYSIS   @OZ32566 75165400
         SPACE 1                                               @OZ32566 75165500
EROPTABB EQU   *-8                 LAST TABLE ENTRY            @OZ32566 75165600
         EJECT                                                 @OZ32566 75165700
****************************************************************OZ32566 75165800
*                                                              *OZ32566 75165900
*        'DUMP' - PRODUCE SYSTEM DUMP WITH TITLE               *OZ32566 75166000
*                                                              *OZ32566 75166100
****************************************************************OZ32566 75166200
         SPACE 1                                               @OZ32566 75166300
ERRORDMW ST    LINK,ERRLINK        SAVE RETURN ADDRESS         @OZ32566 75166400
         MVC   ERMSGWRK(ERDMPNGL),ERDMPING MOVE MSG TO WORK    @OZ32566 75166500
         BAL   WE,ERRWTO           TELL OPER WE'RE TAKING DUMP @OZ32566 75166600
         L     LINK,ERRLINK        RESTORE RETURN ADDRESS      @OZ32566 75166700
         SPACE 1                                               @OZ32566 75166800
         CLC   ERDUMPT(8),$BLANKS  WAS A TITLE PROVIDED...     @OZ32566 75167000
         BNE   ERDSDUMP            BR IF YES                   @OZ32566 75167100
         LTR   WG,WG               DOES ESTAE ELEMENT EXIST... @OZ32566 75167200
         BNZ   ERDTITLE            BR IF YES                   @OZ32566 75167300
         MVC   ERDUMPT(L'ERRORMS1),ERRORMS1  ELSE SET DEFAULT  @OZ32566 75167400
         B     ERDSDUMP                       AND BR TO DUMP   @OZ32566 75167500
         SPACE 1                                               @OZ32566 75167600
ERDTITLE MVC   ERDUMPT1,ERANLAB0   SET ABEND CODE AND LOCATION @OZ32566 75167700
         CLI   ERANLDS1,C' '       ERROR DESCRIPT AVAILABLE... @OZ32566 75167800
         BE    *+10                BR IF NO                    @OZ32566 75167900
         MVC   ERDUMPT2,ERANLDS1    ELSE SET DESCRIPTION       @OZ32566 75168000
         MVC   ERDUMPT3,ERANLSY0   SET SUSBSYS IDENTIFICATION  @OZ32566 75168100
         SPACE 1                                               @OZ32566 75168200
ERDSDUMP MVI   ERDUMPT-1,L'ERDUMPT SET TITLE LENGTH            @OZ32566 75168300
         SDUMP HDRAD=ERDUMPT-1,    TAKE A SYSTEM DUMP          @OZ32566C75168400
               SDATA=(PSA,NUC,RGN,TRT,SQA,CSA,LPA,SWA)         @OZ32566 75168500
         LTR   R15,R15             DUMP SUCCESSFUL...          @OZ32566 75168600
         BZR   LINK                RETURN IF YES               @OZ32566 75168700
         MVC   ERMSGWRK(ERDUMPNL),ERDUMPNG ELSE NOTIFY         @OZ32566 75168800
         BAL   WE,ERRWTO                    OPERATOR           @OZ32566 75168900
         L     LINK,ERRLINK                  AND               @OZ32566 75169000
         BR    LINK                           RETURN           @OZ32566 75169100
         EJECT                                                 @OZ32566 75169200
****************************************************************OZ32566 75169300
*                                                              *OZ32566 75169400
*        'SNAP' - PROVIDE JES2 ABEND ANALYSIS                  *OZ32566 75169500
*                                                              *OZ32566 75169600
****************************************************************OZ32566 75169700
         SPACE 1                                               @OZ32566 75169800
         USING PSADSECT,R0         PROVIDE PSA ADDRESSABILITY  @OZ32566 75169900
         SPACE 1                                               @OZ32566 75170000
ERRATOP  ST    LINK,ERRLINK        SAVE RETURN ADDRESS         @OZ32566 75170200
         MVC   ERMSGWRK(ERANTOPL),ERANLTOP TYPE HEADING LINE   @OZ32566 75170400
         BAL   WE,ERRWTO                                       @OZ32566 75170600
         SPACE 1                                               @OZ32566 75171000
****************************************************************OZ32566 75171100
*                                                              *OZ32566 75171200
*        SUBSYSTEM ID, VERSION, MODULE NAME                    *OZ32566 75171300
*                                                              *OZ32566 75171400
****************************************************************OZ32566 75171500
         SPACE 1                                               @OZ32566 75171600
         L     R1,PSATOLD          GET TCB ADDRESS             @OZ32566 75171700
         SPACE 1                                               @OZ32566 75171800
         USING TCBDSECT,R1         PROVIDE TCB ADDRESSABILITY  @OZ32566 75171900
         L     WA,TCBJPQ           SAVE CDE ADDRESS            @OZ32566 75172000
         L     R1,TCBTIO           GET TIOT ADDRESS            @OZ32566 75172100
         SPACE 1                                               @OZ32566 75172200
         USING TIOT,R1             PROVIDE TIOT ADDRESSABILITY @OZ32566 75172300
         MVC   ERANLSY1,TIOCNJOB   SET SUBSYSTEM ID            @OZ32566 75172400
         DROP  R1                  KILL TIOT ADDRESSABILITY    @OZ32566 75172500
         SPACE 1                                               @OZ32566 75172600
         MVC   ERANLSY3,8(WA)      SET MODULE NAME FROM CDE    @OZ32566 75172700
         MVC   ERANLSY2,ERANLVER   SET JES2 VERS ID (&VERSION) @OZ32566 75172800
         CLC   =C'JES',ERANLSY2    &VERSION DUPLICATE 'JES'... @OZ32566 75172900
         BNE   ERRASIDL            BR IF NO                    @OZ32566 75173000
         MVC   ERANLSY2(4),=C'REL '     ELSE BUILD             @OZ32566 75173100
         MVC   ERANLSY2+4(3),ERANLVER+5  RELEASE               @OZ32566 75173200
         MVI   ERANLSY2+7,C' '            IDENTIFICATION       @OZ32566 75173300
         SPACE 1                                               @OZ32566 75173400
ERRASIDL MVC   ERMSGWRK(ERANSYSL),ERANLSYS TYPE SYSTEM-ID      @OZ32566 75173500
         BAL   WE,ERRWTO                    LINE               @OZ32566 75173600
         EJECT                                                 @OZ32566 75173700
****************************************************************OZ32566 75173800
*                                                              *OZ32566 75173900
*        CURRENT DATE, TIME                                    *OZ32566 75174000
*                                                              *OZ32566 75174100
****************************************************************OZ32566 75174200
         SPACE 1                                               @OZ32566 75174300
         TIME  DEC                 GET CURRENT TIME AND DATE   @OZ32566 75174400
         STM   R0,R1,ERRDWORK      SAVE TIME AND DATE          @OZ32566 75174500
         MVC   ERANLDT1-1(7),ERANLMD     EDIT                  @OZ32566 75174600
         ED    ERANLDT1-1(7),ERRDWORK+5   DATE                 @OZ32566 75174700
         MVC   ERANLDT2-1(9),ERANLMT       AND                 @OZ32566 75174800
         ED    ERANLDT2-1(9),ERRDWORK       TIME               @OZ32566 75174900
         SPACE 1                                               @OZ32566 75175000
         MVC   ERMSGWRK(ERANLDTL),ERANLDT TYPE DATE AND        @OZ32566 75175100
         BAL   WE,ERRWTO                   TIME LINE           @OZ32566 75175200
         SPACE 1                                               @OZ32566 75175300
****************************************************************OZ32566 75175400
*                                                              *OZ32566 75175500
*        ABEND DESCRIPTION                                     *OZ32566 75175600
*                                                              *OZ32566 75175700
****************************************************************OZ32566 75175800
         SPACE 1                                               @OZ32566 75175900
         MVI   ERANLDS1,C' '                  CLEAR DESCRIPTION@OZ32566 75176000
         MVC   ERANLDS1+1(L'ERANLDS1-1),ERANLDS1  AREA         @OZ32566 75176100
         LA    R1,$ERCODET         ADDRESS OF ERROR CODE TABLE @OZ32566 75176200
         SLR   WA,WA               CLEAR TEXT LENGTH           @OZ32566 75176300
         SLR   WD,WD               CLEAR INFO-EXIT ADDRESS     @OZ32566 75176400
         SPACE 1                                               @OZ32566 75176500
ERRADLUP IC    WA,8(,R1)           GET LENGTH OF TEXT          @OZ32566 75176600
         CLC   EELCODE,0(R1)       DOES ERROR CODE MATCH...    @OZ32566 75176700
         BE    ERRATDES            BR IF YES                   @OZ32566 75176800
         LA    R1,4+4+1(WA,R1)      ELSE INCR TO NEXT ENTRY    @OZ32566 75176900
         CLI   0(R1),FF            LAST ENTRY...               @OZ32566 75177000
         BNE   ERRADLUP            LOOP IF NO                  @OZ32566 75177100
         B     ERRABND              ELSE SKIP DESCRIPTION      @OZ32566 75177200
         SPACE 1                                               @OZ32566 75177300
ERRADMOV MVC   ERANLDS1(*-*),4+4+1(R1)  *** EXECUTE ONLY ***   @OZ32566 75177400
         SPACE 1                                               @OZ32566 75177500
ERRATDES BCTR  WA,0                GET MACHINE LENGTH OF TEXT  @OZ32566 75177600
         EX    WA,ERRADMOV         MOVE ERROR TEXT TO MSG      @OZ32566 75177700
         L     WD,4(,R1)           OBTAIN INFO-EXIT ADDRESS    @OZ32566 75177800
         MVC   ERMSGWRK(ERANDESL),ERANLDES TYPE ABEND          @OZ32566 75177900
         BAL   WE,ERRWTO                    DESCRIPTION LINE   @OZ32566 75178000
         EJECT                                                 @OZ32566 75178100
****************************************************************OZ32566 75178200
*                                                              *OZ32566 75178300
*        ABEND CODE, FAILING MODULE (BASE + OFFSET)            *OZ32566 75178400
*                                                              *OZ32566 75178500
****************************************************************OZ32566 75178600
         SPACE 1                                               @OZ32566 75178700
ERRABND  MVC   ERANLAB0(6),=C'ABEND '   SET 'ABEND' PREFIX     @OZ32566 75178800
         TM    EELFLAGS,EELSYSAB        WAS IT SYSTEM ABEND... @OZ32566 75178900
         BO    *+10                     BR IF YES              @OZ32566 75179000
         MVC   ERANLAB0(5),=C'ERROR'    ELSE SET 'ERROR' PREFIX@OZ32566 75179100
         MVC   ERANLAB1,EELCODE         SET ABEND OR $ERROR    @OZ32566 75179200
         MVC   ERANLAB3,ERANLAB3-1 CLEAR LOCATION TEXT         @OZ32566 75179300
         L     R1,EELFADDR         GET FAILING ADDRESS         @OZ32566 75179400
         LTR   R1,R1               CAN WE DETERMINE...         @OZ32566 75179500
         BNZ   ERRABMAP            BR IF YES                   @OZ32566 75179600
         MVC   ERANLAB2(21),=C'AT (UNKNOWN LOCATION)' SET TEXT @OZ32566 75179700
         B     ERRABT               AND BR TO TELL OPERATOR    @OZ32566 75179800
         SPACE 1                                               @OZ32566 75179900
ERRABMAP BAL   WE,ERMODMAP         FIND MODULE MAP ENTRY       @OZ32566 75180000
         MVC   ERANLAB2(14),=C'IN LOW-STORAGE'   LOW-STORAGE...@OZ32566 75180100
         BL    ERRABT                             BR IF YES    @OZ32566 75180200
         MVC   ERANLAB2(15),=C'IN HIGH-STORAGE'  HIGH-STORAGE..@OZ32566 75180300
         BH    ERRABT                             BR IF YES    @OZ32566 75180400
         MVC   ERANLAB2,=C'AT'      ELSE FORMAT                @OZ32566 75180500
         LA    WA,ERANLAB3           ASSEMBLY NAME,            @OZ32566 75180600
         BAL   WE,ERBASOFF            BASE, AND OFFSET         @OZ32566 75180700
         SPACE 1                                               @OZ32566 75180800
ERRABT   MVC   ERMSGWRK(ERANLABL),ERANLAB TYPE ERROR CODE      @OZ32566 75180900
         BAL   WE,ERRWTO                   AND LOCATION LINE   @OZ32566 75181000
         EJECT                                                 @OZ32566 75181100
****************************************************************OZ32566 75181200
*                                                              *OZ32566 75181300
*        CALLING SEQUENCE                                      *OZ32566 75181400
*                                                              *OZ32566 75181500
****************************************************************OZ32566 75181600
         SPACE 1                                               @OZ32566 75181700
         L     WB,EELPCE           GET ADDR OF FAILING PCE     @OZ32566 75181800
         LTR   WB,WB               VALID PCE ADDRESS...        @OZ32566 75181900
         BNZ   ERRAFIST            BR IF YES                   @OZ32566 75182000
         MVC   ERMSGWRK(ERANR13L),ERANLR13 ELSE TELL OF        @OZ32566 75182100
         BAL   WE,ERRWTO                    INVALID R13        @OZ32566 75182200
         B     ERRAFIST                      BR TO CONTINUE    @OZ32566 75182300
         SPACE 1                                               @OZ32566 75182400
         DROP  R13                 PROVIDE LOCAL               @OZ32566 75182900
         USING PCEDSECT,WB          PCE ADDRESSABILITY         @OZ32566 75183000
         SPACE 1                                               @OZ32566 75183100
*              THIS LINE DELETED BY APAR NUMBER                @OZ32566 75184000
*              THIS LINE DELETED BY APAR NUMBER                @OZ32566 75185000
****************************************************************OZ32566 75186000
*                                                              *OZ32566 75186400
*        FAILING INSTRUCTION                                   *OZ32566 75186500
*                                                              *OZ32566 75186600
****************************************************************OZ32566 75186700
         SPACE 1                                               @OZ32566 75186800
ERRAFIST TM    EELFLAGS,EELSYSAB   SYSTEM ABEND...             @OZ32566 75186900
         BZ    ERRAPCE             BR IF NO ($ERROR)           @OZ32566 75187000
         L     R1,EELFADDR         ADDRESS OF FAILURE          @OZ32566 75187100
         LTR   R1,R1               VALID ADDRESS...            @OZ32566 75187200
         BZ    ERRAPSW             BR IF NO                    @OZ32566 75187300
         UNPK  ERANLIN1(13),0(7,R1)  ELSE FORMAT               @OZ32566 75187400
         TR    ERANLIN1,$HEXTRAN      FAILING                  @OZ32566 75187500
         MVI   ERANLIN1+12,C' '        INSTRUCTION             @OZ32566 75187600
         SLR   R1,R1               USE                         @OZ32566 75187700
         IC    R1,EELILC            ILC FOR                    @OZ32566 75187800
         ALR   R1,R1                 LENGTH OF                 @OZ32566 75187900
         LA    R1,ERANLIN1(R1)        INSTRUCTION              @OZ32566 75188000
         MVC   0(8,R1),$BLANKS         DISPLAY                 @OZ32566 75188100
         MVC   ERMSGWRK(ERANINSL),ERANLINS TYPE FAILING        @OZ32566 75188200
         BAL   WE,ERRWTO                    INSTRUCTION LINE   @OZ32566 75188300
         SPACE 1                                               @OZ32566 75188400
****************************************************************OZ32566 75188500
*                                                              *OZ32566 75188600
*        PSW, ILC                                              *OZ32566 75188700
*                                                              *OZ32566 75188800
****************************************************************OZ32566 75188900
         SPACE 1                                               @OZ32566 75189000
ERRAPSW  OC    EELPSW(8),EELPSW    PSW VALID...                @OZ32566 75189100
         BZ    EELPCE              BR IF NO                    @OZ32566 75189200
         UNPK  ERANLPS1(9),EELPSW(5)   FORMAT                  @OZ32566 75189300
         UNPK  ERANLPS2(9),EELPSW+4(5)  LEFT AND               @OZ32566 75189400
         TR    ERANLPS1,$HEXTRAN         RIGHT                 @OZ32566 75189500
         TR    ERANLPS2,$HEXTRAN          HALVES OF            @OZ32566 75189600
         MVI   ERANLPS1+L'ERANLPS1,C' '    PSW AT TIME         @OZ32566 75189700
         MVI   ERANLPS2+L'ERANLPS2,C' '     OF ABEND           @OZ32566 75189800
         MVC   ERANLPS3,EELILC     FORMAT                      @OZ32566 75189900
         OI    ERANLPS3,X'F0'       ILC                        @OZ32566 75190000
         MVC   ERMSGWRK(ERANPSWL),ERANLPSW TYPE PSW AND        @OZ32566 75190100
         BAL   WE,ERRWTO                    ILC LINE           @OZ32566 75190200
         EJECT                                                 @OZ32566 75190300
****************************************************************OZ32566 75190400
*                                                              *OZ32566 75190500
*        PCE NAME, PCE ADDRESS, JOB NAME, JOB NUMBER           *OZ32566 75190600
*                                                              *OZ32566 75190700
****************************************************************OZ32566 75190800
         SPACE 1                                               @OZ32566 75190900
ERRAPCE  L     WD,EELPCE           FAILING PCE ADDRESS         @OZ32566 75191000
         LTR   WD,WD               PCE ADDRESS VALID...        @OZ32566 75191100
         BZ    ERRAREGS            BR IF NO                    @OZ32566 75191200
         MVC   ERANLPC6,ERANLPC6-1 CLEAR JOB-PORTION OF MESSAGE@OZ32566 75191300
         LA    WA,=CL8'INVALID'    POINT TO ERROR NAME         @OZ32566 75191400
         SLR   R1,R1               GET UNIQUE                  @OZ32566 75191500
         IC    R1,PCEID+1           PCE ID                     @OZ32566 75191600
         SLL   R1,3                 ELSE GET PCE               @OZ32566 75191900
         LA    R1,$PCENAMT(R1)       NAME TABLE ENTRY          @OZ32566 75192000
         CLI   0(R1),C' '          VALID ENTRY...              @OZ32566 75192100
         BE    ERRAPNAM            BR IF NO                    @OZ32566 75192200
         LR    WA,R1               POINT TO PCE NAME ENTRY     @OZ32566 75192300
         CLI   0(R1),C'*'          DEVICE PCE...               @OZ32566 75192400
         BNE   ERRAPNAM            BR IF NO                    @OZ32566 75192500
         USING DCTDSECT,R1         PROVIDE DCT ADDRESSABLITY   @OZ32566 75192700
         SPACE 1                                               @OZ32566 75192800
         L     R1,PCEDCT           ADDR OF PCE'S DCT           @OZ32566 75192900
         LA    WA,DCTDEVN          POINTER TO DEVICE NAME      @OZ32566 75193000
         SPACE 1                                               @OZ32566 75193100
ERRAPNAM MVC   ERANLPC1,0(WA)      SET PCE NAME OR 'INVALID'   @OZ32566 75193200
         UNPK  ERANLPC2(7),EELPCE+1(4)  FORMAT                 @OZ32566 75193300
         TR    ERANLPC2,$HEXTRAN         PCE                   @OZ32566 75193400
         MVI   ERANLPC2+6,C')'            ADDRESS              @OZ32566 75193500
         SPACE 1                                               @OZ32566 75193600
         USING JQEDSECT,R1         PROVIDE JQE ADDRESSABILITY  @OZ32566 75193700
         SPACE 1                                               @OZ32566 75193800
         L     R1,PCEJQE           GET CURRENT JQE ADDRESS     @OZ32566 75193900
         LTR   R1,R1               ANY JQE AVAILABLE...        @OZ32566 75194000
         BZ    ERRAPTYP            BR IF NO                    @OZ32566 75194100
         MVC   ERANLPC5,JQEJNAME   SET JOB NAME                @OZ32566 75194200
         LH    R1,JQEJOBNO         GET INTERNAL JOB NUMBER     @OZ32566 75194300
         SPACE 1                                               @OZ32566 75194400
         DROP  R1,WB               KILL JQE/PCE ADDRESSABILITY @OZ32566 75194500
         EJECT                                                 @OZ32566 75194600
         USING PCEDSECT,R13        RESTORE PCE ADDRESSABILITY  @OZ32566 75194700
         SPACE 1                                               @OZ32566 75194800
         MVC   ERANLPC3,=C'JOB'    ASSUME                      @OZ32566 75194900
         CH    R1,=H'10000'         BATCH JOB                  @OZ32566 75195000
         BL    ERRAPJNO            BR IF CORRECT               @OZ32566 75195100
         MVC   ERANLPC3,=C'TSU'     ELSE ASSUME                @OZ32566 75195200
         SH    R1,=H'20000'          TSU JOB                   @OZ32566 75195300
         BNM   ERRAPJNO            BR IF CORRECT               @OZ32566 75195400
         MVC   ERANLPC3,=C'STC'     ELSE IT'S AN               @OZ32566 75195500
         AH    R1,=H'10000'          STC JOB                   @OZ32566 75195600
         SPACE 1                                               @OZ32566 75195700
ERRAPJNO CVD   R1,ERRDWORK            FORMAT                   @OZ32566 75195800
         UNPK  ERANLPC4,ERRDWORK+5(3)  JOB                     @OZ32566 75195900
         OI    ERANLPC4+3,X'F0'         NUMBER                 @OZ32566 75196000
         SPACE 1                                               @OZ32566 75196100
ERRAPTYP MVC   ERMSGWRK(ERANPCEL),ERANLPCE TYPE PCE AND        @OZ32566 75196200
         BAL   WE,ERRWTO                    JOB LINE           @OZ32566 75196300
         SPACE 1                                               @OZ32566 75196400
****************************************************************OZ32566 75196500
*                                                              *OZ32566 75196600
*        REGISTERS AT TIME OF ABEND                            *OZ32566 75196700
*                                                              *OZ32566 75196800
****************************************************************OZ32566 75196900
         SPACE 1                                               @OZ32566 75197000
ERRAREGS TM    EELFLAGS,EELREGSA   REGISTERS AVAILABLE         @OZ32566 75197100
         BZ    ERRABOT             BR IF NO                    @OZ32566 75197200
         LA    WB,EELREGS          POINT TO REGISTERS          @OZ32566 75197300
         LA    WC,4                TYPE 4 LINES                @OZ32566 75197400
         SPACE 1                                               @OZ32566 75197500
ERRARG1  LA    WD,ERANLRG2         POINT TO MESSAGE AREA       @OZ32566 75197600
         LA    WE,4                TYPE 4 PER LINE             @OZ32566 75197700
         LA    R1,0(WC,WC)         INSERT                      @OZ32566 75197800
         LA    R1,ERANLRNO-2(R1)    REGISTER                   @OZ32566 75197900
         MVC   ERANLRG1,0(R1)        NUMBER                    @OZ32566 75198000
         SPACE 1                                               @OZ32566 75198100
ERRARG2  UNPK  0(9,WD),0(5,WB)     EDIT                        @OZ32566 75198200
         MVI   8(WD),C' '           NEXT                       @OZ32566 75198300
         TR    0(8,WD),$HEXTRAN      REGISTER                  @OZ32566 75198400
         LA    WB,4(,WB)           INCR SOURCE POINTER         @OZ32566 75198500
         LA    WD,9(,WD)           INCR TARGET POINTER         @OZ32566 75198600
         BCT   WE,ERRARG2          LOOP FOR THIS LINE          @OZ32566 75198700
         SPACE 1                                               @OZ32566 75198800
         MVC   ERMSGWRK(ERANREGL),ERANLREG TYPE REGISTER       @OZ32566 75198900
         BAL   WE,ERRWTO                    LINE               @OZ32566 75199000
         BCT   WC,ERRARG1          LOOP FOR ALL 4 LINES        @OZ32566 75199100
         SPACE 2                                               @OZ32566 75199200
ERRABOT  MVC   ERMSGWRK(ERANBOTL),ERANLBOT TYPE BOTTOM LINE    @OZ32566 75199300
         BAL   WE,ERRWTO                    LINE               @OZ32566 75199400
         SPACE 1                                               @OZ32566 75199500
ERRARET  L     LINK,ERRLINK        RESTORE RETURN ADDRESS      @OZ32566 75199600
         BR    LINK                 AND RETURN TO CALLER       @OZ32566 75199700
         EJECT                                                 @OZ32566 75199800
****************************************************************OZ32566 75199900
*                                                              *OZ32566 75200000
*        ERMODMAP - SUBROUTINE TO LOCATE JES2 MODULE MAP ENTRY *OZ32566 75200100
*                                                              *OZ32566 75200200
*        R1    - ADDRESS TO LOCATE                             *OZ32566 75200300
*        WE    - RETURN ADDRESS                                *OZ32566 75200400
*                                                              *OZ32566 75200500
* EXIT   CC    - LOW  - ADDRESS IS BELOW JES2 TASK (LOW-STOR)  *OZ32566 75200600
*              - HIGH - ADDRESS IS ABOVE JES2 TASK (HIGH-STOR) *OZ32566 75200700
*              - ZERO - R1 = MODULE MAP ENTRY                  *OZ32566 75200800
*                       R0 = DISPLACEMENT WITHIN ASSEMBLY      *OZ32566 75200900
*        WA-WC,WF - UNPREDICTABLE                              *OZ32566 75201000
*                                                              *OZ32566 75201100
****************************************************************OZ32566 75201200
         SPACE 1                                               @OZ32566 75201300
         USING PSADSECT,R0         PROVIDE PSA ADDRESSABILITY  @OZ32566 75201400
         USING TCBDSECT,WA         PROVIDE TCB ADDRESSABILITY  @OZ32566 75201500
         SPACE 1                                               @OZ32566 75201600
ERMODMAP L     WA,PSATOLD          ADDRESS OF TCB              @OZ32566 75201700
         L     WA,TCBJPQ           ADDRESS OF CDE              @OZ32566 75201800
         SPACE 1                                               @OZ32566 75201900
         DROP  WA                  KILL TCB ADDRESSABILITY     @OZ32566 75202000
         SPACE 1                                               @OZ32566 75202100
         L     WA,20(,WA)          ADDR OF EXTENTS LIST (XTLST)@OZ32566 75202200
         L     WC,12(,WA)          WC = START OF JES2 MODULE   @OZ32566 75202300
         L     WF,8(,WA)           WF = END OF                 @OZ32566 75202400
         LA    WF,0(WC,WF)               JES2 MODULE           @OZ32566 75202500
         CLR   R1,WC               LOW STORAGE...              @OZ32566 75202600
         BLR   WE                  RETURN IF YES               @OZ32566 75202700
         CLR   R1,WF               HIGH STORAGE...             @OZ32566 75202800
         BHR   WE                  RETURN IF YES               @OZ32566 75202900
         LR    WA,R1               SAVE DESIRED ADDRESS        @OZ32566 75203000
         L     R1,$HASPMAP         ADDRESS OF JES2 MODULE MAP  @OZ32566 75203100
         LA    R1,MAPENTL(,R1)      AFTER HASPABS ENTRY        @OZ32566 75203200
         LA    WB,MAPMODS-1        COUNT OF ENTRIES (- HASPABS)@OZ32566 75203300
         MVI   ERRDWORK,FF         INITIALIZE OFFSET AND    +0 @OZ32566 75203400
         MVC   ERRDWORK+4(4),$ZEROS  MODMAP-ADDRESS ENTRIES +4 @OZ32566 75203500
         EJECT                                                 @OZ32566 75203600
ERMODLUP CLI   MAPNAME+4(R1),C'S'  SKIP SUBSYSTEM-             @OZ32566 75203700
         BE    ERMODINC             INTERFACE ENTRIES          @OZ32566 75203800
         CLC   MAPDISPL(,R1),$ZEROS  SKIP SECONDARY            @OZ32566 75203900
         BNE   ERMODINC               ENTRY POINTS             @OZ32566 75204000
         LR    R0,WA               COMPUTE OFFSET              @OZ32566 75204100
         S     R0,MAPADDR(,R1)      WITHIN THIS ASSEMBLY       @OZ32566 75204200
         BM    ERMODINC            SKIP IF BEFORE THIS ASSEMBLY@OZ32566 75204300
         CL    R0,ERRDWORK         LESS THAN PREVIOUS OFFSET...@OZ32566 75204400
         BH    ERMODINC            SKIP IF NO                  @OZ32566 75204500
         STM   R0,R1,ERRDWORK       ELSE SAVE NEW-BEST-CHOICE  @OZ32566 75204600
         SPACE 1                                               @OZ32566 75204700
ERMODINC LA    R1,MAPENTL(,R1)     INCR TO NEXT MODMAP ENTRY   @OZ32566 75204800
         BCT   WB,ERMODLUP         LOOP THRU ALL ENTRIES       @OZ32566 75204900
         SPACE 1                                               @OZ32566 75205000
         LM    R0,R1,ERRDWORK      GET OFFSET AND MODMAP ENTRY @OZ32566 75205100
         CLI   ERRDWORK,00         WAS ASSEMBLY FOUND...       @OZ32566 75205200
         BER   WE                  RETURN IF YES (CC=ZERO)     @OZ32566 75205300
         CLI   *,FF                 ELSE RETURN                @OZ32566 75205400
         BR    WE                    WITH CC=LOW               @OZ32566 75205500
         SPACE 1                                               @OZ32566 75205600
         DROP  R0                  KILL PSA ADDRESSABILITY     @OZ32566 75205700
         EJECT                                                 @OZ32566 75205800
****************************************************************OZ32566 75205900
*                                                              *OZ32566 75206000
*        ERBASOFF - SUBROUTINE TO FORMAT ASSEMBLY BASE AND     *OZ32566 75206100
*                   OFFSET                                     *OZ32566 75206200
*        R0    - ASSEMBLY OFFSET                               *OZ32566 75206300
*        R1    - ADDR OF JES2 MODULE MAP ENTRY                 *OZ32566 75206400
*        WE    - RETURN ADDRESS                                *OZ32566 75206500
*        WA    - ADDR OF AREA FOR FORMATTED OUTPUT AS FOLLOWS..*OZ32566 75206600
*                                                              *OZ32566 75206700
* EXAMPLE      - HASPRTAM (0974E0) + X'2E20'    (27 CHARS)     *OZ32566 75206800
*                ---------------------------                   *OZ32566 75206900
*                                                              *OZ32566 75207000
****************************************************************OZ32566 75207100
         SPACE 1                                               @OZ32566 75207200
ERBASOFF ST    R0,ERRDWORK         STORE ASSEMBLY OFFSET       @OZ32566 75207300
         MVC   00(8,WA),MAPNAME(R1)  SET ASSEMBLE NAME         @OZ32566 75207400
         MVC   08(2,WA),=C' ('        SET                      @OZ32566 75207500
         UNPK  10(7,WA),MAPADDR+1(,R1) ASSEMBLY                @OZ32566 75207600
         TR    10(6,WA),$HEXTRAN        BASE                   @OZ32566 75207700
         MVC   16(6,WA),=C') + X'''      ADDRESS               @OZ32566 75207800
         UNPK  22(5,WA),ERRDWORK+2(3)     AND OFFSET           @OZ32566 75207900
         TR    22(4,WA),$HEXTRAN           WITHIN              @OZ32566 75208000
         MVI   26(WA),C''''                 ASSEMBLY           @OZ32566 75208100
         BR    WE                  RETURN TO CALLER            @OZ32566 75208200
         SPACE 2                                               @OZ32566 75208300
****************************************************************OZ32566 75208400
*                                                              *OZ32566 75208500
*        ERRWTO - ISSUE MESSAGE TO OPERATOR VIA $$WTOR         *OZ32566 75208600
*                                                              *OZ32566 75208700
*        R1    - ADDRESS OF LIST-FORM WTO                      *OZ32566 75208800
*        WE    - RETURN ADDRESS                                *OZ32566 75208900
*                                                              *OZ32566 75209000
****************************************************************OZ32566 75209100
         SPACE 1                                               @OZ32566 75209200
ERRWTO $$WTO   ERMSGWRK            ISSUE MESSAGE TO OPERATOR   @OZ32566 75209300
         BR    WE                  RETURN TO CALLER            @OZ32566 75209400
         EJECT                                                 @OZ32566 75209500
         PUSH  PRINT               SAVE ASM PRINT STATUS       @OZ32566 75209600
         SPACE 1                                               @OZ32566 75209700
         AIF   ('&PRINT' NE 'OFF').ERPR                        @OZ32566 75209800
         PRINT NOGEN               SUPPRESS MACRO EXPANSIONS   @OZ32566 75209900
.ERPR    ANOP                                                  @OZ32566 75210000
         SPACE 1                                               @OZ32566 75210100
        $MID   088                 SET MESSAGE ID              @OZ32566 75210200
ERANLTOP WTO   '&MID.---------  JES2 ABEND ANALYSIS  ----------',      C75210300
               MF=L                                            @OZ32566 75210400
ERANTOPL EQU   *-ERANLTOP          LENGTH OF MSG               @OZ32566 75210450
         SPACE 1                                               @OZ32566 75210500
ERANLSYS WTO   '&MID.SUBSYS = **** ********   MODULE = ********',      C75210600
               MF=L                                            @OZ32566 75210700
ERANLSY0 EQU   *-33,4+1+8          SUBSYSTEM ID + VERSION ID   @OZ32566 75210800
ERANLSY1 EQU   *-33,4              SUBSYSTEM ID                @OZ32566 75210900
ERANLSY2 EQU   *-28,8              VERSION ID                  @OZ32566 75211000
ERANLSY3 EQU   *-8,8               MODULE NAME                 @OZ32566 75211100
ERANLVER DC    CL8'&VERSION'       &VERSION ID                 @OZ32566 75211200
ERANSYSL EQU   *-ERANLSYS          LENGTH OF MSG               @OZ32566 75211250
         SPACE 1                                               @OZ32566 75211300
ERANLDT  WTO   '&MID.DATE   = **.***          TIME   = **.**.**',      C75211400
               MF=L                                            @OZ32566 75211500
ERANLDT1 EQU   *-33,5              DATE OF ABEND               @OZ32566 75211600
ERANLDT2 EQU   *-8,8               TIME OF ABEND               @OZ32566 75211700
ERANLMD  DC    X'4021204B202020'      MASK FOR DATE - YY.DDD   @OZ32566 75211800
ERANLMT  DC    X'4020214B20204B2020'  MASK FOR TIME - HH.MM.SS @OZ32566 75211900
ERANLDTL EQU   *-ERANLDT           LENGTH OF MSG               @OZ32566 75211950
         SPACE 1                                               @OZ32566 75212000
ERANLDES WTO   '&MID.DESC = ***********************************',      C75212100
               MF=L                                            @OZ32566 75212200
ERANLDS1 EQU   *-35,35             ERROR DESCRIPTION           @OZ32566 75212300
ERANDESL EQU   *-ERANLDES          LENGTH OF MSG               @OZ32566 75212350
         SPACE 1                                               @OZ32566 75212400
ERANLAB  WTO   '&MID.ABEND S*** AT ******** (******) + X/****/',       C75212500
               MF=L                                            @OZ32566 75212600
ERANLAB0 EQU   *-41,41             ENTIRE MSG TEXT             @OZ32566 75212700
ERANLAB1 EQU   *-35,4              ABEND CODE                  @OZ32566 75212800
ERANLAB2 EQU   *-30,2              'AT' OR 'IN'                @OZ32566 75212900
ERANLAB3 EQU   *-27,27             JES2 ASSEMBLY ID            @OZ32566 75213000
ERANLABL EQU   *-ERANLAB           LENGTH OF MSG               @OZ32566 75213050
         SPACE 1                                               @OZ32566 75213100
ERANLCAL WTO   '&MID.--- CALLED BY ******** (******) + X/****/',       C75213200
               MF=L                                            @OZ32566 75213300
ERANLCL1 EQU   *-27,27             CALLING ASSEMBLY ID         @OZ32566 75213400
         SPACE 1                                               @OZ32566 75213500
ERANLINS WTO   '&MID.FAILING INSTR WAS ************        ',  @OZ32566C75213600
               MF=L                                            @OZ32566 75213650
ERANLIN1 EQU   *-20,12             FAILING INSTRUCTION         @OZ32566 75213700
ERANINSL EQU   *-ERANLINS          LENGTH OF MSG               @OZ32566 75213750
         SPACE 1                                               @OZ32566 75213800
ERANLPSW WTO   '&MID.PSW  = ******** ********          ILC = *',       C75213900
               MF=L                                            @OZ32566 75214000
ERANLPS1 EQU   *-34,8              ABEND PSW   (LEFT HALF)     @OZ32566 75214100
ERANLPS2 EQU   *-25,8              ABEND PSW   (RIGHT HALF)    @OZ32566 75214200
ERANLPS3 EQU   *-1,1               LENG ABNDING INST IN H-WRDS @OZ32566 75214300
ERANPSWL EQU   *-ERANLPSW          LENGTH OF MSG               @OZ32566 75214350
         EJECT                                                 @OZ32566 75214400
ERANLPCE WTO   '&MID.PCE  = ******** (******) JOB **** ********',      C75214500
               MF=L                                            @OZ32566 75214600
ERANLPC1 EQU   *-35,8              PCE NAME                    @OZ32566 75214700
ERANLPC2 EQU   *-25,6              PCE ADDRESS                 @OZ32566 75214800
ERANLPC3 EQU   *-17,3              'JOB', 'STC', 'TSU'         @OZ32566 75214900
ERANLPC4 EQU   *-13,4              JOB NUMBER                  @OZ32566 75215000
ERANLPC5 EQU   *-8,8               JOB NAME                    @OZ32566 75215100
ERANLPC6 EQU   ERANLPC3,*-ERANLPC3 ENTIRE JOB TEXT             @OZ32566 75215200
ERANPCEL EQU   *-ERANLPCE          LENGTH OF MSG               @OZ32566 75215250
         SPACE 1                                               @OZ32566 75215300
ERANLREG WTO   '&MID.R**  = ******** ******** ******** ******** ',     C75215400
               MF=L                                            @OZ32566 75215500
ERANLRG1 EQU   *-(4*9)-6,2         STARTING REG NO. ON THIS LNE@OZ32566 75215600
ERANLRG2 EQU   *-(4*9),4*9         REGISTER CONTENTS           @OZ32566 75215700
ERANLRNO DC    C'128 4 0 '         REGISTER NUMBERS            @OZ32566 75215800
ERANREGL EQU   *-ERANLREG          LENGTH OF MSG               @OZ32566 75215850
         SPACE 1                                               @OZ32566 75215900
ERANLBOT WTO   '&MID.------------------------------------------',      C75216000
               MF=L                                            @OZ32566 75216100
ERANBOTL EQU   *-ERANLBOT           LENGTH OF MSG              @OZ32566 75216150
        $MID   080                                             @OZ32566 75216200
ERDMPING WTO   '&MID.JES2 SYSTEM DUMP IN PROGRESS',MF=L        @OZ32566 75216300
ERDMPNGL EQU   *-ERDMPING           LENGTH OF MSG              @OZ32566 75216350
         SPACE 1                                               @OZ32566 75216400
        $MID   081                                             @OZ32566 75216500
ERDUMPNG WTO   '&MID.JES2 SYSTEM DUMP UNSUCCESSFUL',MF=L       @OZ32566 75216600
ERDUMPNL EQU   *-ERDUMPNG           LENGTH OF MSG              @OZ32566 75216650
         SPACE 1                                               @OZ32566 75217000
ERANLR13 WTO   '&MID.R13 NOT A VALID PCE ADDRESS',MF=L         @OZ32566 75217200
ERANR13L EQU   *-ERANLR13           LENGTH OF MSG              @OZ32566 75217250
         SPACE 1                                               @OZ32566 75217300
        $MID   084                                             @OZ32566 75217400
ERANLSVE WTO   '&MID.INVALID SAVE AREA CHAIN',MF=L             @OZ32566 75217500
         SPACE 1                                               @OZ32566 75217600
        $MID   095                                             @OZ32566 75217700
ERRORMSG WTO   '&MID.JES2 CATASTROPHIC ERROR.  CODE = ****  ', @OZ32566C75217800
               MF=L                                            @OZ32566 75217820
ERRORME  EQU   *                                               @OZ32566 75217850
ERRORMS1 EQU   *-39,39             DEFAULT DUMP TITLE          @OZ32566 75217900
ERRORMCD EQU   *-6,4               ABEND CODE                  @OZ32566 75218000
ERRORMSL EQU   *-ERRORMSG          LENGTH OF MSG               @OZ32566 75218100
         SPACE 1                                               @OZ32566 75218200
        $MID   098                                             @OZ32566 75218300
ERTERMSG WTOR  '&MID.ENTER TERMINATION OPTION',  ASK OPERATOR  @OZ32566C75218400
               EROPTION,L'EROPTION+L'ERDUMPT,ERRDWORK,MF=L     @OZ32566 75218500
ERTERMSL EQU   *-ERTERMSG          LENGTH OF MSG               @OZ32566 75218550
EROPTION DS    CL4                 TERMINATION OPTION          @OZ32566 75218600
ERDUMPT  DS    0CL100              DUMP TITLE (MAX 100 BYTES ) @OZ32566 75218700
ERDUMPT1 DS    CL(L'ERANLAB0)           ABEND AND LOCATION     @OZ32566 75219000
         DS    CL4                                             @OZ32566 75220000
ERDUMPT2 DS    CL(L'ERANLDS1)           ABEND DESCRIPTION      @OZ32566 75221000
         DS    CL2                                             @OZ32566 75222000
ERDUMPT3 DS    CL(L'ERANLSY0)           SUBSYS IDENTIFICATION  @OZ32566 75223000
         ORG   ERDUMPT+100              PAD OUT FOR 100 BYTES  @OZ32566 75223100
ERMSGWRK DS    0F                  ALIGN MSG WORK AREA FULLWRD @OZ32566 75223200
         DS    CL100               $$WTO MSG WORK AREA         @OZ32566 75223300
EEL      DS    XL(EELSIZE)         ESTAE ELEMENT               @OZ32566 75223400
         SPACE 1                                               @OZ32566 75224000
         POP   PRINT               RESTORE ASM PRINT STATUS    @OZ32566 75224100
         EJECT                                                 @OZ32566 75224200
EXITSAVE DS    18F                 SAVE AREA FOR EXIT RTNS     @OZ32566 75224300
$ERRORSA DS    0D                                              @OZ32566 75224400
         DC    CL8'ERRORSAV'       EYE-CATCHER FOR DUMP        @OZ32566 75224500
ERRORSAV DC    16A(*-*)            REGISTERS AT ENTRY          @OZ32566 75224600
ERRXSAVE DC    18A(*-*)            SAVE AREA FOR XTERN ROUTINES@OZ32566 75224700
ERRLINK  DC    01A(*-*)            LINKAGE REGISTER SAVE AREA  @OZ32566 75225000
ERRDWORK DS    D                   DOUBLE WORD SAVE AREA       @OZ32566 75226000
         EJECT                                                 @OZ32566 75227000
*********************************************************************** 75228000
*                                                                     * 75229000
*        $HEXIT - ENTRY FROM COMMAND PROCESSOR TO WITHDRAW            * 75230000
*                                                                     * 75231000
*********************************************************************** 75232000
         SPACE 1                                                     R4 75233000
$HEXIT   BALR  R13,0               RE-ESTABLISH                      R4 75234000
         USING *,R13                EXIT                             R4 75235000
         TM    HEXITFLG,HEXJES2+HEXSYS ENTERED VIA $PJES2...   @OZ32566 75235200
         BNZ   *+8                 BR IF NO TO SKIP NEXT INST  @OZ32566 75235400
         OI    HEXITFLG,HEXPJES2    SHOW ENTERED VIA $PJES2    @OZ32566 75235600
         L     R13,=A(EXITSAVE)      ROUTINE                         R4 75236000
         USING EXITSAVE,R13           ADDRESSABILITY                 R4 75237000
         SPACE 1                                                     R4 75238000
         OI    $STATUS,$SYSEXIT    TELL DAUGHTERS WE ARE GOING DOWN  R4 75239000
         L     R10,$SSVT           POINT TO SSVT                     R4 75241000
         USING SSVT,R10                                              R4 75242000
         USING SJBDSECT,WA                                           R4 75243000
         SPACE 1                                                     R4 75244000
*********************************************************************** 75245000
*                                                                     * 75246000
*        REMOVE THE ATTENTION INDEXES FROM OUR UCBS.                  * 75247000
*        FOR 3211 OR 3800 PRINTERS, CLEAR THE ERROR LOG AREA POINTER  * 75248000
*        AND RESET THE OPEN DCB COUNT TO ZERO. NOTE THAT THE 3211     * 75249000
*        ERROR LOG AREAS WILL BE FREED AUTOMATICALLY BY THE SYSTEM    * 75250000
*        (SUBPOOL 255).                                               * 75251000
*                                                                     * 75252000
*********************************************************************** 75253000
         SPACE 1                                                     R4 75254000
         SPACE 1                                                     R4 75255000
IECITMOD EQU   X'18'               HASP ATTENTION INDEX              R4 75256000
         SPACE 1                                                     R4 75257000
*              THIS LINE DELETED BY APAR NUMBER                @OZ18608 75258000
*              THIS LINE DELETED BY APAR NUMBER                @OZ18608 75259000
         SLR   WC,WC               SET NEW INDEX                     R4 75260000
         L     WE,PSAAOLD-PSA      ADDRESS OF OUR ASCB         @OZ18608 75260100
         LH    WE,ASCBASID-ASCB(WE) OUR ASID                   @OZ18608 75260200
         L     WA,CVTPTR           POINT TO CVT                      R4 75261000
         L     WA,CVTILK2-CVT(,WA) POINT TO UCB LOOK-UP TABLE        R4 75262000
         MODESET EXTKEY=ZERO       GET KEY ZERO                      R4 75263000
         SPACE 1                                                     R4 75264000
         USING UCBDSECT,R14        PROVIDE UCB ADDRESSABILITY  @OZ18608 75265000
         SPACE 1                                                     R4 75266000
HEXATTNL SR    R14,R14             CLEAR REG FOR UCB INSERT    @OZ18608 75267000
         ICM   R14,3,0(WA)         INSERT UCB ADDRESS          @OZ18608 75268000
         LA    WA,2(,WA)           UP TO NEXT ENTRY JUST IN CASE     R4 75269000
*              THIS LINE DELETED BY APAR NUMBER                @OZ18608 75270000
         BZ    HEXATTNL            LOOP IF DUMMY                     R4 75271000
         CLM   R14,3,=H'-1'        TEST FOR LAST UCB           @OZ18608 75272000
         BE    HEXATTNE            EXIT IF END                       R4 75273000
         L     WB,UCBEXTPT         POINT TO UCB EXTENSION            R4 75274000
         TM    $SVSTUS,$SVSTUSP    WE ARE THE PRIMARY SUBSYS   @OZ18608 75274050
         BO    HEXPRIM             SKIP ALLOC TASK IF YES      @OZ18608 75274100
         EJECT                                                 @OZ18608 75274150
         CLI   UCBTBYT3,UCB3UREC   LOOP IF NOT                 @OZ18608 75274200
         BNE   HEXATTNL             UNIT RECORD                @OZ18608 75274250
         TM    UCBSTAT,UCBALOC     LOOP IF                     @OZ18608 75274300
         BNO   HEXATTNL             DEVICE IS NOT ALLOCATED    @OZ18608 75274350
         CH    WE,UCBASID-UCBCMEXT(WB) LOOP IF DEVICE IS       @OZ18608 75274400
         BNE   HEXATTNL                 ALLOC TO SOMEONE ELSE  @OZ18608 75274450
         B     HEXEREP             SKIP ATTENTION INDEX TEST   @OZ18608 75274500
HEXPRIM  DS    0H                                              @OZ18608 75274550
         CLI   UCBATI-UCBCMEXT(WB),IECITMOD IS THE ATTENTION OURS    R4 75275000
         BNE   HEXATTNL            LOOP IF NOT                       R4 75276000
         SPACE 1                                               @OZ18608 75277000
HEXEREP  DS    0H                                              @OZ18608 75277100
         L     WB,UCBXTADR              ASSUME                       R4 75278000
         LA    WD,UCBERADR-UCBUCS(,WB)  3211 PRINTER UCB             R4 75279000
         CLI   UCBTBYT4,UCB3211    TEST ASSUMPTION                   R4 75280000
         BE    HEXRERAD            BR IF TRULY 3211                  R4 75281000
         LA    WD,UCBMDRBF-UCB3800X(,WB)  ELSE, ASSUME 3800          R4 75282000
         CLI   UCBTBYT4,UCB3800    TEST ASSUMPTION                   R4 75283000
         BNE   HEXREATI            BR IF NOT 3211 OR 3800            R4 75284000
         L     WB,0(,WD)           GET 3800 MDR AREA ADDR            R4 75285000
         FREEMAIN R,LV=DYNL3800,A=(WB),SP=245 FREE 3800 MDR AREA    R41 75286000
HEXRERAD XC    0(4,WD),0(WD)       RESET LOG AREA & OPEN DCB COUNT   R4 75287000
         SPACE 1                                                     R4 75288000
HEXREATI TM    $SVSTUS,$SVSTUSP    LOOP IF WE ARE NOT          @OZ18608 75289000
         BNO   HEXATTNL             THE PRIMARY SUB SYS        @OZ18608 75289100
         IOSGEN TP,UCB=(R14),VAR=ATNMOD,TABLE=(WC) RESET ATTN  @OZ18608 75289200
         B     HEXATTNL            LOOP                              R4 75290000
         SPACE 1                                                     R4 75291000
         DROP R14                  SUSPEND UCB ADDRESSABILITY  @OZ18608 75292000
         EJECT                                                       R4 75293000
HEXATTNE MODESET EXTKEY=HASP       GET KEY 1                         R4 75294000
         SPACE 1                                                     R4 75295000
HEXCSML  $GETLOK ,                 SERIALIZE WITH DEQUEUERS          R4 75296000
         LM    WA,WB,$SVTSCS       PICK UP CANCEL/STATUS QUEUE       R4 75297000
         SPACE 1                                                     R4 75298000
HEXSCL   LTR   WA,WA               TEST FOR EMPTY                    R4 75299000
         BZ    HEXSCQE             STATUS CANCEL QUEUE EMPTY         R4 75300000
         L     R0,SJBTCHN          PICK UP CHAIN                     R4 75301000
         LR    R1,WB               COPY HASH                         R4 75302000
         CDS   WA,R0,$SVTSCS       DEQUEUE ELEMENT                   R4 75303000
         BNE   HEXSCL              LOOP                              R4 75304000
         $FRELOK ,                 RELEASE LOCK                      R4 75305000
         POST  ,1,MF=(E,SJBECBP)   POST ABNORMAL COMPLETION          R4 75306000
         B     HEXCSML             LOOP                              R4 75307000
         SPACE 1                                                     R4 75308000
HEXPSML  $GETLOK ,                 SERIALIZE WITH DEQUEUERS          R4 75309000
         SPACE 1                                                     R4 75310000
HEXSCQE  LM    WA,WB,$SVPSOQ       PICK UP PROCESS SYSOUT            R4 75311000
         EJECT                                                       R4 75312000
HEXPSOL  LTR   WA,WA               TEST FOR EMPTY                    R4 75313000
         BZ    HEXPSOE             PSO QUEUE EMPTY                   R4 75314000
         L     R0,SJBTCHN          PICK UP CHAIN                     R4 75315000
         LR    R1,WB               COPY HASP                         R4 75316000
         CDS   WA,R0,$SVPSOQ       DEQUEUE ELEMENT                   R4 75317000
         BNE   HEXPSOL             LOOP                              R4 75318000
         $FRELOK ,                 RELEASE LOCK                      R4 75319000
         POST  ,1,MF=(E,SJBECBP)   POST ABNORMAL COMPLETION          R4 75320000
         B     HEXPSML             LOOP                              R4 75321000
         SPACE 1                                                     R4 75322000
HEXPSOE  CLI   $SVCPOST,X'FF'      ANY TASK WANT A CELL              R4 75323000
         BE    HEXNOCEL            BRANCH IF NOT                     R4 75324000
         L     WA,$CCAREA          POINT TO CCA                      R4 75325000
         USING CCADSECT,WA                                           R4 75326000
         MVC   CCAPOST(CCACPL),$SVCPOST COPY REQUEST                 R4 75327000
         MVI   $SVCPOST,X'FF'      SET SWITCH                        R4 75328000
         $FRELOK ,                 RELEASE LOCK                      R4 75329000
         LA    R0,1                SET ABNORMAL POST CODE            R4 75330000
         POST  ,(0),MF=(E,CCAPOST) POST USER                         R4 75331000
         B     HEXNCEL             SKIP NEXT                         R4 75332000
         SPACE 1                                                     R4 75333000
HEXNOCEL $FRELOK ,                 RELEASE LOCK                      R4 75334000
         DROP  WA                                                    R4 75335000
         EJECT                                                       R4 75336000
HEXNCEL  CLI   $NUMSMFB,2          TEST SMF BUFFER COUNT             R4 75337000
         BL    HEXDTACH            BR IF SMF NOT SUPPORTED           R4 75338000
* WRITE STOP HASP SMF RECORD TYPE 45                                 R4 75339000
         USING SMFDSECT,R1         ACCESS SMF BUFFER                 R4 75340000
         LA    R1,HSMFBUF          POINT TO EXIT SMF 'BUFFER'        R4 75341000
         MVI   SMFHDRTY,SMFPSSTP   STOP HASP RECORD TYPE             R4 75342000
         MVI   SMFRDW+1,SMF45END-SMFRDW      SIZE OF SMF RECORD      R4 75343000
         MVI   SMFSSID+1,SMFHSPID  HASP SUBSYSTEM ID                 R4 75344000
         MVI   SMFSSLEN+1,SMF45END-SMF45IND  LENGTH OF SECTION       R4 75345000
         TM    HEXITFLG,HEXSYS     IS THIS A NORMAL RETURN...  @OZ32566 75346000
         BNO   HNORML              BR, YES THIS IS NORMAL RET  @OZ32566 75347000
         OI    SMF45IND,SMF45ABN   NO                                R4 75348000
         XR    LINK,LINK           CLEAR LINK                        R4 75349000
         ICM   LINK,7,ERRORSAV+5   GET SDWA ADDR. OR ABEND CODE      R4 75350000
         LA    WA,12               IS THERE A SDWA                   R4 75351000
         C     WA,ERRORSAV         SDWA TEST                         R4 75352000
         BNE   HSDWA               YES                               R4 75353000
         SRL   LINK,12             SHIFT COMPLETION CODE             R4 75354000
         STH   LINK,SMF45CC        PUT COMPLETION CODE INTO SMF      R4 75355000
         B     HNORML              WRITE STOP HASP RECORD            R4 75356000
         SPACE 1                                                     R4 75357000
HSDWA    ICM   WA,7,5(LINK)        GET ABEND CODE FROM SDWA          R4 75358000
         SRL   WA,12               SHIFT COMPLETION CODE             R4 75359000
         STH   WA,SMF45CC          SAVE ABEND CODE FROM SDWA         R4 75360000
         SPACE 1                                                     R4 75361000
HNORML   NULL                      WRITE TYPE 45 RECORD              R4 75362000
        $QUESMFB                   QUEUE TYPE 45 TO BE WRITTEN       R4 75363000
         DROP  R1                                                    R4 75364000
         SPACE 1                                                     R4 75365000
* DETACH DAUGHTER TASKS                                              R4 75366000
         SPACE 1                                                     R4 75367000
HEXDTACH LA    WA,$DAWTER          POINT TO 1ST DAUGHTER ELEMENT     R4 75368000
         USING DTEDSECT,WA         PROVIDE DTE ADDRESSABILITY        R4 75369000
         LA    WB,$DAWTERS         SET NUMBER OF ELEMENTS            R4 75370000
         EJECT                                                       R4 75371000
HEXDETL  OC    DTETCB,DTETCB       IS TCB ACTIVE                     R4 75372000
         BZ    HNOTSK              NO, SKIP DETACH                   R4 75373000
         LA    R1,DTEWECB          POINT TO WORK ECB                 R4 75374000
         POST  (1)                 POST DAUGHTER                     R4 75375000
         LA    R1,DTETECB          POINT TO TERMINATION ECB          R4 75376000
         WAIT  ECB=(1)             WAIT                              R4 75377000
         LA    R1,DTETCB           POINT TO TCB ADDRESS POINTER      R4 75378000
         DETACH (1)                REMOVE TCB                        R4 75379000
         SPACE 1                                                     R4 75380000
HNOTSK   LA    WA,$DAWTRLN(,WA)    POINT TO NEXT ELEMENT             R4 75381000
         BCT   WB,HEXDETL          LOOP                              R4 75382000
         EJECT                                                 @OZ26939 75382100
*        DETACH 3800 IMAGE-LOADER DAUGHTER TASKS               @OZ26939 75382150
         SPACE 1                                               @OZ26939 75382200
         USING DCTDSECT,WB         PROVIDE DCT ADDRESSABILITY  @OZ26939 75382250
         SPACE 1                                               @OZ26939 75382300
         LA    WB,$PRTDCT-(DCTCHAIN-DCTDSECT) LOCAL PRINTERS   @OZ26939 75382350
         SPACE 1                                               @OZ26939 75382400
ERRNIDET ICM   WB,7,DCTCHAIN+1     ADDR OF NEXT DCT            @OZ26939 75382450
         BZ    ERRORRET            BR IF NONE LEFT             @OZ26939 75382500
         CLI   DCTDEVTP,DCTPRT     LOCAL PRINTER...            @OZ26939 75382550
         BNE   ERRORRET            DONE IF NOT                 @OZ26939 75382600
         TM    DCTPPSW2,DCTNIPRT   3800...                     @OZ26939 75382650
         BZ    ERRNIDET            BR IF NOT                   @OZ26939 75382700
         L     WA,DCTPCE           ADDR OF PCE                 @OZ26939 75382750
         ICM   WA,7,PRIMGDTE-PCEDSECT+1(WA)  DTE EXIST...      @OZ26939 75382800
         BZ    ERRNIDET            BR IF NO                    @OZ26939 75382850
         OC    DTETCB,DTETCB       SUBTASK ACTIVE...           @OZ26939 75382900
         BZ    ERRNIDET            BR IF NO                    @OZ26939 75382950
         LA    R1,DTEWECB          ADDR OF WORK-ECB            @OZ26939 75383000
         POST (1)                  POST HASPIMAG FOR SHUTDOWN  @OZ26939 75383050
         LA    R1,DTETECB          ADDR OF TERMINATION-ECB     @OZ26939 75383100
         WAIT  ECB=(1)             WAIT FOR SHUTDOWN COMPLETE  @OZ26939 75383150
         LA    R1,DTETCB           ADDR OF TCB POINTER         @OZ26939 75383200
         DETACH (1)                REMOVE DAUGHTER TASK        @OZ26939 75383250
         B     ERRNIDET            LOOP                        @OZ26939 75383300
         EJECT                                                 @OZ26939 75383350
ERRORRET L     R10,$SSVT           POINT TO SSVT                     R4 75384000
         OI    $SVSTUS,$SVSTUST    SET TERMINATION COMPLETE          R4 75385000
         L     R1,$SVHECBA         ADDR OF ECB AND $$POST WORK FLAG  R4 75386000
         MVI   $SVPOSTW(R1),X'FF'  SET FLAGS FOR POSSIBLE RESTART    R4 75387000
         MVC   ERMSGWRK(HEXITMSL),HEXITMSG MOVE MSG TO WORK    @OZ32566 75388000
       $$WTO   ERMSGWRK            SHOW TERMINATION COMPLETE   @OZ32566 75388200
         SLR   R15,R15             SET ZERO RETURN CODE        @OZ32566 75388400
         TM    HEXITFLG,HEXPJES2   $PJES2...                   @OZ32566 75388600
         BO    ERRORXIT             EXIT IF YES                @OZ32566 75388800
         LA    R15,24                ELSE SET RC               @OZ32566 75389000
         SPACE 1                                               @OZ32566 75389200
ERRORXIT SVC   3                   EXIT                        @OZ32566 75389400
         SPACE 2                                               @OZ32566 75389600
HEXITFLG DC    X'00'               EXIT FLAGS                  @OZ32566 75389800
HEXJES2  EQU   B'10000000'         JES2 ABEND ($ERROR)         @OZ32566 75390000
HEXSYS   EQU   B'01000000'         SYSTEM ABEND                @OZ32566 75390200
HEXPJES2 EQU   B'00100000'         $PJES2 ABEND                @OZ32566 75390400
         SPACE 2                                               @OZ32566 75390600
        $MID   085                                             @OZ32566 75390800
HEXITMSG WTO   '&MID.JES2 TERMINATION COMPLETE',MF=L           @OZ32566 75391000
HEXITMSL EQU   *-HEXITMSG          LENGTH OF MSG               @OZ32566 75391100
         SPACE 1                                               @OZ32566 75391200
         DROP  WA,WB,R10,BASE2     KILL ADDRESSABILITY         @OZ32566 75391400
         EJECT                                                 @OZ32566 75391600
         LTORG                                                 @OZ32566 75391800
         SPACE 1                                               @OZ32566 75392000
HSMFBUF  DC    XL36'00'            EXIT SMF 'BUFFER'           @OZ32566 75392200
         TITLE 'HASP ABEND / $ERROR CODE TABLE'                @OZ32566 75392400
****************************************************************OZ32566 75392600
*                                                              *OZ32566 75392800
*        $ERCODET - HASP ERROR CODE TABLE                      *OZ32566 75393000
*                                                              *OZ32566 75393200
* FORMAT - CL4'CODE'      - ABEND CODE (S***) OR               *OZ32566 75393400
*                           $ERROR CODE ($***)                 *OZ32566 75393500
*          AL4(ROUTINE)   - ADDRESS OF ROUTINE TO PROVIDE      *OZ32566 75393600
*                           ADDITIONAL INFORMATION             *OZ32566 75393700
*          AL1(LEN)       - LENGTH OF ERROR DESCRIPTION TEXT   *OZ32566 75393800
*          C'TEXT'        - DESCRIPTION TEXT                   *OZ32566 75394000
*                                                              *OZ32566 75394200
* NOTE   - MAXIMUM LENGTH OF TEXT IS 35 BYTES                  *OZ32566 75394400
*                                                              *OZ32566 75394600
****************************************************************OZ32566 75394800
         SPACE 1                                               @OZ32566 75395000
         ENTRY $ERCODET            PROVIDE $ERCODET ENTRY      @OZ32566 75395200
         SPACE 1                                               @OZ32566 75395400
$ERCODET DS    0H                                              @OZ32566 75395600
         SPACE 1                                               @OZ32566 75395800
 DC C'S0C1',AL4(*-*),AL1(15),C'INVALID OP-CODE'                @OZ32566 75396000
 DC C'S0C2',AL4(*-*),AL1(13),C'PRIVILEGED-OP'                  @OZ32566 75396200
 DC C'S0C3',AL4(*-*),AL1(18),C'EXECUTE OF EXECUTE'             @OZ32566 75396400
 DC C'S0C4',AL4(*-*),AL1(20),C'PROTECTION EXCEPTION'           @OZ32566 75396600
 DC C'S0C5',AL4(*-*),AL1(20),C'ADDRESSING EXCEPTION'           @OZ32566 75396800
 DC C'S0C6',AL4(*-*),AL1(23),C'SPECIFICATION EXCEPTION'        @OZ32566 75397000
 DC C'S0C7',AL4(*-*),AL1(14),C'DATA EXCEPTION'                 @OZ32566 75397200
 DC C'S0C9',AL4(*-*),AL1(16),C'DIVISION BY ZERO'               @OZ32566 75397400
 DC C'$A01',AL4(*-*),AL1(32),C'TOO MANY CHANNEL-ENDS FOR DEVICE'        75397600
 DC C'$B01',AL4(*-*),AL1(33),C'$FREEBUF - BUFFER ADDRESS INVALID'       75397800
 DC C'$B02',AL4(*-*),AL1(26),C'$GETBUF - BPMMAP NOT VALID'     @OZ32566 75398000
 DC C'$E01',AL4(*-*),AL1(34),C'$EXCP-COUNT LESS THAN CHANNEL-ENDS'      75398200
 DC C'$H01',AL4(*-*),AL1(30),C'GETMAIN FOR BUFFER POOL FAILED' @OZ32566 75398400
 DC C'$K01',AL4(*-*),AL1(34),C'CKPT BUFFER ALTERED WITHOUT $QSUSE'      75399000
 DC C'$K02',AL4(*-*),AL1(34),C'PERMANENT ERROR READING CHECKPOINT'      75399200
 DC C'$K03',AL4(*-*),AL1(34),C'DUPL SYS IDS, OR RSRVE/RLSE FAILED'      75399400
 DC C'$K04',AL4(*-*),AL1(34),C'PERMANENT ERROR WRITING CHECKPOINT'      75399600
 DC C'$K05',AL4(*-*),AL1(32),C'CKPT UPDATE NOT FLAGGED FOR CKPT'        75399800
 DC C'$M01',AL4(*-*),AL1(33),C'TOO MANY CHANNEL-ENDS ON RJE LINE'       75400000
 DC C'$M02',AL4(*-*),AL1(31),C'ATTEMPT TO OVERLAP RJE LINE I/O'         75400200
 DC C'$M03',AL4(*-*),AL1(28),C'SNA/RJE INTERNAL LOGIC ERROR'   @OZ32566 75400400
 DC C'$Q01',AL4(*-*),AL1(35),C'JQE SERVICES INVLD ARG OR NO $QSUSE'     75401000
 DC C'$Q02',AL4(*-*),AL1(22),C'INVALID JOB QUEUE TYPE'         @OZ32566 75401400
 DC C'$R01',AL4(*-*),AL1(22),C'SNA/RJE RPL PROCESSING'         @OZ32566 75401600
 DC C'$V02',AL4(*-*),AL1(30),C'PURGE PROCESSOR GETMAIN FAILED'          75402000
         SPACE 1                                               @OZ32566 75402400
 DC X'FF'                            ** END OF TABLE **        @OZ32566 75402600
         TITLE 'HASP PCE NAME TABLE'                           @OZ32566 75402800
****************************************************************OZ32566 75403000
*                                                              *OZ32566 75403200
*        $PCENAMT - HASP PCE NAME TABLE - BASED ON PCEID+1     *OZ32566 75403400
*                                                              *OZ32566 75403600
* NOTE - PCEMAXID IS THE MAXIMUM PCE ID                        *OZ32566 75403800
*      - POINTED TO BY $PCENAMS IN HCT                         *OZ32566 75404000
*      - 1ST BYTE OF NAME ENTRY = C' ' - INVALID ID (RESERVED) *OZ32566 75404200
*                               = C'*' - DEVICE PROCESSOR      *OZ32566 75404400
*                                      - NAME IN ASSOCIATED DCT*OZ32566 75404600
*                                                              *OZ32566 75404800
****************************************************************OZ32566 75405000
         SPACE 1                                               @OZ32566 75405200
         ENTRY $PCENAMT            PROVIDE $PCENAMT ENTRY      @OZ32566 75405400
         SPACE 1                                               @OZ32566 75405600
$PCENAMT DS    0C                PCEID  (SECOND BYTE)          @OZ32566 75405800
         DC    CL8'$ASYNC  '       00 - ASYNCH I/O PROCESSOR   @OZ32566 75406000
         DC    CL8'*READER '   *   01 - READER PROCESSORS      @OZ32566 75406200
         DC    CL8'$SETUP  '       02 - SETUP PROCESSOR        @OZ32566 75406400
         DC    CL8'HASPCNVT'       03 - JCL CONVERS PROCESSOR  @OZ32566 75406600
         DC    CL8'HASPEXEC'       04 - EXECUTION PROCESSOR    @OZ32566 75407000
         DC    CL8'HASPPSO '       05 - PROCESS SYSOUT PROCESS @OZ32566 75407100
         DC    CL8'HASPHOPE'       06 - OUTPUT PROCESSOR       @OZ32566 75407200
         DC    CL8'*PRINTER'   *   07 - PRINTER PROCESSORS     @OZ32566 75407300
         DC    CL8'*PUNCH  '   *   08 - PUNCH PROCESSORS       @OZ32566 75407400
         DC    CL8'HASPVPRG'       09 - PURGE PROCESSOR        @OZ32566 75408000
         DC    CL8'HASPCOMM'       10 - COMMAND PROCESSOR      @OZ32566 75409000
         DC    CL8'HASPMLLM'       11 - LINE MANAGER PROCESSOR @OZ32566 75410000
         DC    CL8'$TIMER  '       12 - TIMER PROCESSOR        @OZ32566 75411000
         DC    CL8'HASPCKPT'       13 - CHECKPOINT PROCESSOR   @OZ32566 75412000
         DC    CL8'HASPGPRC'       14 - PRIORITY AGING PROCESS @OZ32566 75413000
         DC    CL8'HASPWARM'       15 - WARM START PROCESSOR   @OZ32566 75417000
         TITLE 'HASP INITIAL ENTRY POINT PROCESSING ROUTINE'         R4 75418000
*********************************************************************** 75419000
*                                                                     * 75420000
*        HASPINGO -- HASP INITIAL ENTRY POINT PROCESSING ROUTINE      * 75421000
*                                                                     * 75422000
*        THIS ROUTINE CALLS HASPINIT TO PERFORM HASP INITIALIZATION   * 75423000
*        PROCESSING.  ON RETURN FROM HASPINIT, IT CLEANS UP ANY       * 75424000
*        REMAINING INITIALIZATION PROCESSING AND EXITS TO THE ASYNCH  * 75425000
*        PROCESSOR.  CONTROL THEN, SHORTLY AFTER, PASSES TO THE HASP  * 75426000
*        WARM START PROCESSOR TO CONCLUDE HASP PREPARATORY PROCES-    * 75427000
*        SING.                                                        * 75428000
*                                                                     * 75429000
*********************************************************************** 75430000
         SPACE 1                                                     R4 75431000
         ENTRY HASPINGO            PROVIDE ENTRY POINT               R4 75432000
         USING HASPINGO,BASE2      PROVIDE LOCAL ADDRESSABILITY      R4 75433000
         SPACE 1                                                     R4 75434000
HASPINGO STM   R14,R12,12(R13)     SAVE SYSTEM'S REGISTERS           R4 75435000
         LR    BASE2,R15           ESTABLISH BASE                    R4 75436000
         L     R15,=A(EXITSAVE)    POINT TO SAVE AREA                R4 75437000
         ST    R15,8(,R13)         STORE FORWARD POINTER             R4 75438000
         ST    R13,4(,R15)         STORE BACKWARD POINTER            R4 75439000
         LR    R13,R15             SWITCH TO NEW SAVE AREA           R4 75440000
         LR    WB,R1               SAVE ORIGINAL R1                  R4 75441000
         SPACE 1                                                     R4 75442000
         L     BASE1,MAPNUCA       ESTABLISH HCT BASE                R4 75443000
         SPACE 1                                                     R4 75444000
*********************************************************************** 75445000
*                                                                     * 75446000
*        OBTAIN SUPERVISOR STATE, SET HASP PROTECT KEY                * 75447000
*                                                                     * 75448000
*********************************************************************** 75449000
         SPACE 1                                                     R4 75450000
         MODESET MODE=SUP          OBTAIN SUPERVISOR STATE           R4 75451000
         MODESET EXTKEY=HASP       SET HASP PROTECT KEY              R4 75452000
         EJECT                                                       R4 75453000
         ICM   WC,15,MAPINITA      IS HASPINIT ALREADY LOADED...     R4 75454000
         BNZ   CALLINIT            BR IF YES                         R4 75455000
         SPACE 1                                                     R4 75456000
*********************************************************************** 75457000
*                                                                     * 75458000
*        HASPINIT NOT LOADED -- LOAD IT NOW                           * 75459000
*                                                                     * 75460000
*********************************************************************** 75461000
         SPACE 1                                                     R4 75462000
         LOAD  EPLOC=MAPINIT,ERRET=LOADERR  LOAD HASPINIT            R4 75463000
         ST    R0,MAPINITA         SET POINTER TO HASPINIT           R4 75464000
         SPACE 1                                                     R4 75465000
*********************************************************************** 75466000
*                                                                     * 75467000
*        CALL HASPINIT TO CONTINUE INITIALIZATION PROCESSING          * 75468000
*                                                                     * 75469000
*********************************************************************** 75470000
         SPACE 1                                                     R4 75471000
CALLINIT LR    R1,WB               RESTORE ORIGINAL R1               R4 75472000
         L     R15,MAPINITA        POINT TO HASPINIT                 R4 75473000
         CALL  (15)                CALL HASPINIT                     R4 75474000
         LTR   WC,WC               WAS HASPINIT LOADED...            R4 75475000
         BNZ   CLEANUP             BR IF PART OF LOAD MODULE         R4 75476000
         DELETE EPLOC=MAPINIT       ELSE DELETE HASPINIT             R4 75477000
         ST    WC,MAPINITA         DELETE HASPINIT REP TABLE ENTRY   R4 75478000
         EJECT                                                       R4 75479000
*********************************************************************** 75480000
*                                                                     * 75481000
*        CLEAN UP INITIALIZATION PROCESSING                           * 75482000
*                                                                     * 75483000
*********************************************************************** 75484000
         SPACE 1                                                     R4 75485000
CLEANUP  L     R1,=A($QGETAFF)     SET MASK FOR 'TM'                 R4 75486000
         MVC   1(1,R1),$SIDAFF      OPERATION IN $QGET ROUTINE       R4 75487000
         SPACE 1                                                     R4 75488000
*********************************************************************** 75489000
*                                                                     * 75490000
*        END OF BASIC INITIALIZATION -- ENTER ASYNCH PROCESSOR        * 75491000
*                                                                     * 75492000
*********************************************************************** 75493000
         SPACE 1                                                     R4 75494000
         L     R14,4(,SAVE)        GET ADDRESS OF SYSTEM SAVE AREA   R4 75495000
         L     SAVE,$ASYNCP        GET ASYNCH PROCESSOR PCE ADDRESS  R4 75496000
         ST    R14,4(,SAVE)        SET BACKWARD CHAIN                R4 75497000
         ST    SAVE,8(,R14)        SET FORWARD CHAIN                 R4 75498000
         LM    LINK,R12,12(SAVE)   LOAD PCE REGISTERS                R4 75499000
         BR    R15                  AND ENTER ASYNCH PROCESSOR       R4 75500000
         SPACE 1                                                     R4 75501000
*********************************************************************** 75502000
*                                                                     * 75503000
*        UNABLE TO LOAD HASPINIT -- INFORM OPERATOR AND QUIT          * 75504000
*                                                                     * 75505000
*********************************************************************** 75506000
         SPACE 1                                                     R4 75507000
LOADERR $$WTO  LOADMSG             ISSUE ERROR MESSAGE TO OPERATOR   R4 75508000
        $$WTO  QUITMSG             ISSUE QUIT MESSAGE TO OPERATOR    R4 75509000
         L     R13,4(,R13)         POINT TO SYSTEM SAVE AREA         R4 75510000
         LM    R14,R12,12(R13)     RESTORE SYSTEM REGISTERS          R4 75511000
         LA    R15,20              SET RETURN CODE                   R4 75512000
         BR    R14                  AND RETURN                       R4 75513000
         EJECT                                                       R4 75514000
        $MID   428                 SET MESSAGE ID                    R4 75515000
QUITMSG  WTO   '&MID.CORRECT THE ABOVE PROBLEMS AND RESTART JES2',MF=L  75516000
         SPACE 1                                                     R4 75517000
        $MID   448                 SET MESSAGE ID                    R4 75518000
LOADMSG  WTO   '&MID.UNABLE TO LOAD MODULE HASPINIT',MF=L            R4 75519000
         SPACE 2                                                     R4 75520000
         LTORG                                                       R4 75521000
         SPACE 5                                                     R4 75522000
         ORG   HASPNUC+(*-HASPNUC+31)/32*32  32-BYTE ALIGNMENT       R4 75523000
         SPACE 2                                                     R4 75524000
        $MODMAP DSECT=NO           GENERATE HASP MODULE MAP          R4 75525000
         SPACE 1                                                     R4 75526000
         DROP  ,                   SUSPEND ADDRESABILITY       @OZ20685 75526010
         TITLE 'HASP ALLOC/UNALLOC SERVICE -- ALLOCATION TASK' @OZ20685 75526110
         SPACE 1                                               @OZ20685 75526120
*************************************************************  @OZ20685 75526130
*                                                              @OZ20685 75526140
*        HASP DYNAMIC ALLOCATION/UNALLOCATION SUBTASK          @OZ20685 75526150
*                                                              @OZ20685 75526160
*************************************************************  @OZ20685 75526170
         SPACE 1                                               @OZ20685 75526180
HOSALLOC $ENTRY BASE=R15           ALLOCATION MAIN ENTRY       @OZ20685 75526190
         DROP  R15                 SUSPEND LOCAL ADDRESSABILITY@OZ20685 75526200
         SAVE  (14,12)             SAVE CALLER'S REGISTERS     @OZ20685 75526210
         LR    BASE2,R15           ESTABLISH BASE REGISTER     @OZ20685 75526220
         USING HOSALLOC,BASE2      LOCAL ADDRESSABILITY        @OZ20685 75526230
         LR    BASE1,R1            RELOAD HCT ADDRESS          @OZ20685 75526240
         USING HASP,BASE1          HCT ADDRESSABILITY          @OZ20685 75526250
         ST    R13,ALLOCSAV+4      STORE BACKWARD POINTER      @OZ20685 75526260
         LR    R4,R13              HOLD CALLER'S SAVE ADDRESS  @OZ20685 75526270
         LA    R13,ALLOCSAV        ADDRESS MY SAVE AREA        @OZ20685 75526280
         ST    R13,8(,R4)          STORE FWD POINTER           @OZ20685 75526290
         SPACE 1                                               @OZ20685 75526300
*        SIGNAL ATTACHOR THAT DYNAMIC ALLOCATE SUBTASK IS UP.  @OZ20685 75526310
         SPACE 1                                               @OZ20685 75526320
         POST  $PDYNECB            POST ATTACHOR               @OZ20685 75526330
         SPACE 1                                               @OZ20685 75526340
*        WAIT FOR WORK POST OR $PJES2 POST                     @OZ20685 75526350
         SPACE 1                                               @OZ20685 75526360
ALWAIT   DS    0H                                              @OZ20685 75526370
         WAIT  ECB=$DYNECB         WAIT FOR WORK OR $PJES2 PST @OZ20685 75526380
         SLR   R1,R1               CLEAR R1                    @OZ20685 75526390
         ICM   R1,7,$DYNECB+1      IS WORK ECB POSTED          @OZ20685 75526400
         MVI   $DYNECB,0           RESET ECB FOR NEXT USER     @OZ20685 75526405
         BZ    ALTERM              BRANCH IF NO, SHUTDOWN      @OZ20685 75526410
         SPACE 1                                               @OZ20685 75526420
*        DYNAMIC ALLOCATION                                    @OZ20685 75526430
         SPACE 1                                               @OZ20685 75526440
         LR    WD,R1               GET WORK AREA ADDRESS       @OZ20685 75526460
         DYNALLOC                  CALL DYN ALLOC/UNALLOC      @OZ20685 75526500
         LR    R1,WD               GET WORK AREA ADDRES AGAIN  @OZ20685 75526660
         LTR   R15,R15             NORMAL RETURN...            @OZ20685 75526670
         BZ    ALLOK               BR IF YES                   @OZ20685 75526680
         MVI   0(R1),X'41'         SET RETURN CODE             @OZ20685 75526690
         B     *+8                 GO POST JES2                @OZ20685 75526700
ALLOK    MVI   0(R1),X'7F'         SET RETURN CODE             @OZ20685 75526710
       $$POST  TYPE=ALOC,R11=HCT   POST JES2                   @OZ20685 75526720
         B     ALWAIT              WAIT FOR POST               @OZ20685 75526730
         SPACE 1                                               @OZ20685 75526740
*        SHUTDOWN ASSUMED -- $PJES2 POST                       @OZ20685 75526750
         SPACE 1                                               @OZ20685 75526760
ALTERM   DS    0H                                              @OZ20685 75526770
         L     R13,ALLOCSAV+4      RESTORE CALLERS  R13        @OZ20685 75526780
         RETURN (14,12),RC=0       RETURN WITH ZERO COMP CODE  @OZ20685 75526790
         SPACE 1                                               @OZ20685 75526800
ALLOCSAV DS    18F                 ALLOCATION SAVE AREA        @OZ20685 75526810
         SPACE 1                                               @OZ20685 75526820
         LTORG                     ALLOC TASK LITERAL POOL     @OZ20685 75526840
         SPACE 5                                               @OZ20685 75526850
$NUCLEN $DLENGTH                   COMPUTE CONTROL SECTION LENGTH    R4 75527000
         SPACE 5                                                     R4 75528000
APARNUM  DC    CL5'33184'          APAR NUMBER                          75528998
         END   HASP                ENTRY POINT FOR HASP SYSTEM       R4 75529000
