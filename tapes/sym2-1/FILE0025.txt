./  ADD  SSI=61410549,NAME=IGE0011E
         TITLE '1419 ERROR RECOVERY ROUTINE'                            00200002
IGE0011E CSECT                                                          00400002
         SPACE                                                          00400402
*********************************************************************** 00400802
*                                                                     * 00401202
* MODULE NAME - IGE0011E                                              * 00401602
*                                                                     * 00402002
* DESCRIPTIVE NAME - 1419 ERROR RECOVERY ROUTINE                      * 00600002
*                                                                     * 00800002
* COPYRIGHT - NONE                                                    * 00800402
*                                                                     * 00800802
* CHANGE LEVEL - AS FOLLOWS:                                          * 00801202
*                                                                     * 00801602
*          VS2 RELEASE 04 CHANGES                                       00801703
*C712000                                                       @ZA07621 00801803
*A298100,454100-454200    *                                    @ZA05597 00801903
*                                                                       00802003
*          VS2 RELEASE 02 DELETIONS                                   * 00802103
*D096000-166000,174000-180000,192000-194000,202000-266000,       Y02072 00802402
*D272000-278000,286000-290000,294000-296000,304000-306000,       Y02072 00802502
*D384000-398000,412000,424000-444000,706000,710000               Y02072 00802602
*                                                                     * 00802802
*                                                                     * 00803202
* STATUS - VS2 RELEASE 2 LEVEL 0                                      * 01000002
*                                                                     * 01200002
*                                                                     * 01200402
* FUNCTION - ANALYZE STATUS AND SENSE DATA FROM BOTH THE PCU AND THE  * 01400002
*            SCU.  MAINTAIN CURRENT ERROR STATISTIC AND SET A FLAG    * 01600002
*            FOR RECORDING OF ERRORS THAT OCCUR IN THE 1419 AND IN    * 01800002
*            THE CONTROL UNITS.  ALSO SET A FLAG FOR THE PROPER       * 02000002
*            MESSAGE TO THE OPERATOR.                                 * 02200002
*                                                                     * 02400002
* OPERATION - THIS ROUTINE CHECKS THE STATUS AND SENSE BYTES STORED   * 02400402
*             IN THE IOSB AND TAKES THE NECESSARY ACTION.  STATISTICS * 02400802
*             ARE KEPT AS TO THE KIND AND FREQUENCY OF ERRORS.  THESE * 02401202
*             STATISTICS ARE USED BY THE CE TO RECOGNIZE, ANALYZE,    * 02401602
*             AND ISOLATE ERRORS.                                     * 02402002
*             A COMMON INTERPRETER ROUTINE IS USED TO CHECK BOTH      * 02402402
*             STATUS AND SENSE.  ON RETURN FROM THE INTERPRETER, THE  * 02402802
*             PROPER FLAGS ARE SET AND A MESSAGE IS WRITTEN TO THE    * 02403202
*             OPERATOR.                                               * 02403602
*                                                                     * 02404002
*                                                                     * 02800002
* ENTRY POINT - ER1419 FROM THE SCHEDULER                             * 03000002
*                                                                     * 03200002
*                                                                     * 03200402
* INPUT - REGISTER 1 - ADDRESS OF THE IOSB                            * 03400002
*                                                                     * 03600002
*                                                                     * 03600402
* OUTPUT - ERROR LOGOUTS AND MESSAGES TO THE OPERATOR.  CONSOLE       * 03800002
*          MESSAGES TO INDICATE ERROR CONDITIONS ARE:                 * 03800402
*             1. I/O PERMANENT ERROR                                  * 03800802
*             2. INTERVENTION REQUIRED                                * 03801202
*                                                                     * 04000002
*                                                                     * 04000402
* EXTERNAL ROUTINES - NONE                                            * 04200002
*                                                                     * 04400002
*                                                                     * 04400402
* EXITS-NORMAL - XCTL TO THE WRITE TO OPERATOR ROUTINE.  RETURN WILL  * 04600002
*                BE MADE FROM THIS ROUTINES TO THE SUPERVISOR VIA AN  * 04800002
*                SVC 3.                                               * 05000002
*                                                                     * 05200002
* EXITS-ERROR - NONE                                                  * 05400002
*                                                                     * 05600002
*                                                                     * 06400002
* TABLES/WORK AREAS - ERP WORK AREA                                   * 07400002
*                                                                     * 07400402
*                                                                     * 07400802
* MACROS-ACTION - NONE                                                * 07401202
*                                                                     * 07401602
* MACROS-MAPPING - IECDERWA, IECDIOSB, IEFUCBOB                       * 07402002
*                                                                     * 07402402
*                                                                     * 07402802
* ATTRIBUTES - REENTRANT, ENABLED                                     * 07403202
*                                                                     * 07403602
*                                                                     * 07404002
* NOTES - IOSB EXCEPTION AND IOSB ERROR FLAGS ARE INTERPRETED AS      * 07404402
*         FOLLOWS:                                                    * 07404802
*            IOSEX ON AND IOSERR ON  - ERROR ROUTINE IN CONTROL       * 07405202
*            IOSEX ON AND IOSERR OFF - PERMANENT ERROR                * 07405602
*                                                                     * 07600002
*********************************************************************** 07600402
         EJECT                                                          07600802
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 16800000
*     REGISTER DEFINITION                                               17000000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 17200000
RPARM    EQU   1                        ADDR OF IOSB AT ENTRY    Y02072 17600002
REWA     EQU   4                        ERP WORK AREA ADDRESS    Y02072 18200002
UCBREG   EQU   7                        UCB ADDRESS REG                 18400000
COMREG   EQU   8                        COMMUNICATION TABLE REG         18600000
SAVREG   EQU   9                        SAVE REG                        18800002
RIOSB    EQU   10                       IOSB ADDRESS REG         Y02072 19000002
ERREG1   EQU   13                       WORK REG 1                      19600000
ERRETR   EQU   14                       RETURN REG                      19800000
BASREG   EQU   15                       BASE REG                        20000000
         SPACE 2                                                        26602002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 26604002
*      MISC.  DEFINITIONS                                               26800000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 26802002
ONE      EQU   1                                                        27000000
LOC016   EQU   16                       COMMUNICATION VECTOR TABLE      28000000
VECTXL   EQU   44                       VECTOR TO XCTL ROUTINE          28200000
VECT68   EQU   68                       INTERPRETER ROUTINE POINTER     28400000
WTORTN   EQU   253                      NAME OF WTO ROUTINE             29200000
UCBPCU   EQU   X'1D'                    PCU TEST BYTE            Y02072 29800002
UCB1275  EQU   X'1F'                    PCU 1275               @ZA05597 29900003
UCBSCU   EQU   X'1E'                    SCU TEST BYTE            Y02072 30000002
WKBIT1   EQU   X'01'                                                    30200000
PCUMSK   EQU   X'2E'                    MASK FOR PCU SNS BITS   SA44107 30800002
SCUMSK   EQU   X'A6'                    MASK FOR SCU SNS BITS   SA44107 31000002
SWITCH   EQU   X'FF'                                                    31200000
         EJECT                                                          31202002
         USING ER1419,15                                                31400000
ER1419   LR    RIOSB,RPARM              GET IOSB ADDRESS         Y02072 31600002
         USING IOSB,RIOSB               EST IOSB BASE REGISTER   Y02072 31602002
         L     REWA,IOSERP              GET ERP WORK AREA ADDR   Y02072 31604002
         USING EWA,REWA                 EST ERP WORK AREA BASE   Y02072 31606002
         L     UCBREG,IOSUCB            GET UCB ADDRESS          Y02072 31800002
         USING UCB,UCBREG               EST UCB BASE REGISTER    Y02072 31802002
         L     COMREG,LOC016            LOAD ADD OF COMMUNICATION TABLE 32000002
         OI    IOSFLA,IOSERR+IOSEX      SET EX AND ERROR FLAG    Y02072 32200002
         SPACE 2                                                        32202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 32400000
*        LINK TO THE COMMON INTERPRETER ROUTINE. THE BYTES FOLLOWING    32600000
*        THE BALR INDICATE IN WHAT ORDER THE BITS ARE TO BE TEST (BIT 3 32800000
*        ON OF CODE BYTE INDICATES STATUS) FOLLOWED BY AN INDEX VALUE   33000000
*        THE INTERPRETER USES TO RETURN TO THIS ROUTINE                 33200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 33400000
ERR010   LR    SAVREG,BASREG            SAVE BASE REGISTER              33600000
         L     BASREG,VECT68(COMREG)    GET ADDR.TO INTERP.ROUTINE      33800000
ERR020   BALR  ERRETR,BASREG            LINK TO INTERPRETER RTN  Y02072 34000002
         DC    X'1D'                    CHANNEL CONTROL CHECK           34200000
         DC    AL1(ERR025-ERR020-2)     BRANCH TO CHECK ERPIB TABLE     34400000
         DC    X'1E'                    INTERFACE CONTROL CHECK         34600000
         DC    AL1(ERR025-ERR020-4)     BRANCH TO CHECK ERPIB TABLE     34800000
         DC    X'1C'                    CHANNEL DATA CHECK              35000000
         DC    AL1(ERR028-ERR020-6)     BRANCH TO SET CDC SWITCH        35200000
         DC    X'10'                    SHOULD NOT OCCUR-INVALID STATUS 35400000
         DC    AL1(ERR070-ERR020-8)     BRANCH TO SET LOGOUT FLAG       35600000
         DC    X'11'                    SHOULD NOT OCCUR INVALID STATUS 35800000
         DC    AL1(ERR070-ERR020-10)    BRANCH TO SET LOGOUT FLAG       36000000
         DC    X'12'                    SHOULD NOT OCCUR INVALID STATUS 36200000
         DC    AL1(ERR070-ERR020-12)    BRANCH TO SET LOGOUT FLAG       36400000
         DC    X'16'                    UNIT CHECK                      36600000
         DC    AL1(ERR029-ERR020-14)    BRANCH TO STAT TABLE UPDATE     36800000
         DC    X'2F'                    END OF LIST                     37000000
         DC    AL1(ERR068-ERR020-16)    CHECK ADDITIONAL STATUS BITS    37200000
         SPACE 2                                                        37202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 37400000
*              FRONT END SUPPORT FOR CHANNEL CONTROL CHECK              37600000
*              AND FOR INTERFACE CONTROL CHECK                          37800000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 38000000
ERR025   EQU   *                                                 Y02072 38200002
         XC    EWAERPIB,EWAERPIB        CLEAR ERPIB TABLE        Y02072 40000002
         B     ERR070                   BRANCH TO SET LOGOUT FLAG       40200000
         SPACE 2                                                        40202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 40400000
*        CHANNEL DATA CHECK                                             40600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 40800000
ERR028   MVI   EWAFLG3,SWITCH           SET CDC SWITCH           Y02072 41000002
         SPACE 2                                                        41202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 41400000
*        STATISTIC UPDATE ROUTINE TO LOAD SENSE DATA INTO ERP WORK AREA 41600002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 42000000
ERR029   EQU   *                                                 Y02072 42200002
         TM    EWAFLG3,SWITCH           TEST FOR CHAN DATA CHK   Y02072 44600002
         BO    ER029C                   YES-OR BIT REP CTR NO 16        44800000
         OC    EWASTUP(ONE),IOSSNS      LD SENSE BYTE 0 INTO EWA Y02072 45000002
         CLI   UCBTBYT4,UCBPCU          TEST FOR PCU             Y02072 45200002
         BE    ER029D                   YES, BRANCH                     45400000
         CLI   UCBTBYT4,UCB1275         TEST FOR 1275 PCU      @ZA05597 45600003
         BE    ER029D                   YES BRANCH             @ZA05597 45660003
R        CLI   UCBTBYT4,UCBSCU          TEST FOR SCU             Y02072 45720003
         BE    ER029E                   YES, CLEAR SCU BITS      Y02072 45800002
         SPACE 2                                                        45802002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 46000000
*             CHANNEL DATA  CHECK                                       46200002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 46202002
ER029C   XC    EWAFLG3,EWAFLG3          CLEAR CDC SWITCH         Y02072 46400002
         OI    EWASTUP+1,WKBIT1         LOAD BIT FOR CTR NO 16   Y02072 46600002
*                                       INTO EWA                 Y02072 46800002
         B     ERR070                   BRANCH TO SET LOGOUT FLAG       47000000
         SPACE 2                                                        47002002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 47200000
*                MASK UNWANTED BITS FOR PCU                             47400000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 47402002
ER029D   NI    EWASTUP,PCUMSK           MASK BITS EXCEPT DATA    Y02072 47600002
*                                       CHK, CDC, BUS OUT, AUTO  Y02072 47800002
*                                       SELECT, AND DATA OVERRUN Y02072 48000002
         B     ERR050                   BRANCH TO CK PCU SENSE          48200000
         SPACE 2                                                        48202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 48400000
*                 MASK UNWANTED BITS FOR SCU                            48600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 48602002
ER029E   NI    EWASTUP,SCUMSK           MASK BITS EXCEPT AUTO    Y02072 48800002
*                                       SELECT, BUS OUT, LSS,    Y02072 49000002
*                                       CR, AND CDC              Y02072 49002002
         B     ERR060                   BRANCH TO CK SCU SENSE          49200000
         SPACE 2                                                        49202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 49400000
*        LINK TO THE COMMON INTERPRETER ROUTINE. THE BYTES FOLLOWING    49600000
*        THE BALR INDICATE IN WHAT ORDER THE BITS ARE TO BE TEST (BIT 3 49800000
*        ON OF CODE BYTE INDICATES STATUS) FOLLOWED BY AN INDEX VALUE   50000000
*        THE INTERPRETER USES TO RETURN TO THIS ROUTINE                 50200000
*             CHECK PCU SENSE BITS                                      50400000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 50600000
ERR050   LR    SAVREG,BASREG            SAVE BASE REGISTER              50800000
         L     BASREG,VECT68(COMREG)    GET ADDR.TO INTERPRETER ROUTINE 51000000
ERR051   BALR  ERRETR,BASREG            LINK TO INTERPRETER RTN  Y02072 51200002
         DC    X'02'                    BUS OUT CHECK                   51400000
         DC    AL1(ERR070-ERR051-2)     BRANCH TO SET LOGOUT FLAG       51600000
         DC    X'03'                    SHOULD NOT OCCUR                51800000
         DC    AL1(ERR070-ERR051-4)     BRANCH TO SET LOGOUT FLAG       52000000
         DC    X'07'                    SHOULD NOT OCCUR                52200000
         DC    AL1(ERR070-ERR051-6)     BRANCH TO SET LOGOUT FLAG       52400000
         DC    X'01'                    INTERVENTION REQUIRED           52600000
         DC    AL1(ERR077-ERR051-8)     BRANCH TO SET MESSAGE FLAG      52800000
         DC    X'00'                    COMMAND REJECT                  53000000
         DC    AL1(ERR075-ERR051-10)    BRANCH TO SET PERM ERR FLAG     53200000
         DC    X'04'                    DATA CHECK                      53400000
         DC    AL1(ERR070-ERR051-12)    BRANCH TO SET LOGOUT FLAG       53600000
         DC    X'05'                    DATA OVERRUN                    53800000
         DC    AL1(ERR070-ERR051-14)    BRANCH TO SET LOGOUT FLAG       54000000
         DC    X'06'                    AUTO SELECT                     54200000
         DC    AL1(ERR070-ERR051-16)    BRANCH TO SET LOGOUT FLAG       54400000
         DC    X'2F'                    END OF LIST                     54600000
         DC    AL1(ERR068-ERR051-18)    BRANCH TO CK REMAINING STATUS   54800000
         SPACE 2                                                        54802002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 55000000
*        LINK TO THE COMMON INTERPRETER ROUTINE. THE BYTES FOLLOWING    55200000
*        THE BALR INDICATE IN WHAT ORDER THE BITS ARE TO BE TEST (BIT 3 55400000
*        ON OF CODE BYTE INDICATES STATUS) FOLLOWED BY AN INDEX VALUE   55600000
*        THE INTERPRETER USES TO RETURN TO THIS ROUTINE                 55800000
*                CHECK SENSE BITS FOR SCU                               56000000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 56200000
ERR060   LR    SAVREG,BASREG            SAVE BASE REGISTER              56400000
         L     BASREG,VECT68(COMREG)    GET ADDR. OF INTERPRETER ROUT.  56600000
ERR061   BALR  ERRETR,BASREG            LINK TO INTERPRETER RTN  Y02072 56800002
         DC    X'02'                    BUS OUT CHECK                   57000000
         DC    AL1(ERR070-ERR061-2)     BRANCH TO SET LOGOUT FLAG       57200000
         DC    X'04'                    SHOULD NOT OCCUR                57400000
         DC    AL1(ERR070-ERR061-4)     BRANCH TO SET LOGOUT FLAG       57600000
         DC    X'03'                    SHOULD NOT OCCUR                57800000
         DC    AL1(ERR070-ERR061-6)     BRANCH TO SET LOGOUT FLAG       58000000
         DC    X'01'                    INTERVENTION REQUIRED           58200000
         DC    AL1(ERR077-ERR061-8)     BRANCH TO SET MESSAGE FLAG      58400000
         DC    X'07'                    OPERATOR ATTENTION              58600000
         DC    AL1(ERR077-ERR061-10)    BRANCH TO SET MESSAGE FLAG      58800000
         DC    X'00'                    COMMAND REJECT SCU              59000000
         DC    AL1(ERR070-ERR061-12)    BR TO SET LOGOUT FLAG   SA44107 59200002
         DC    X'05'                    LATE STACKER SELECT             59400000
         DC    AL1(ERR070-ERR061-14)    BRANCH TO SET LOGOUT FLAG       59600000
         DC    X'06'                    AUTO SELECT                     59800000
         DC    AL1(ERR070-ERR061-16)    BRANCH TO SET LOGOUT FLAG       60000000
         DC    X'2F'                    END OF LIST                     60200000
         DC    AL1(ERR068-ERR061-18)    BRANCH TO CK REMAINING STATUS   60400000
         SPACE 2                                                        60402002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 62200000
*        LINK TO THE COMMON INTERPRETER ROUTINE. THE BYTES FOLLOWING    62400000
*        THE BALR INDICATE IN WHAT ORDER THE BITS ARE TO BE TEST (BIT 3 62600000
*        ON OF CODE BYTE INDICATES STATUS) FOLLOWED BY AN INDEX VALUE   62800000
*        THE INTERPRETER USES TO RETURN TO THIS ROUTINE                 63000000
*               CHECK REMAINING STATUS BITS                             63200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 63400000
ERR068   LR    SAVREG,BASREG            SAVE BASE REGISTER              63600000
         L     BASREG,VECT68(COMREG)    GET ADDR. OF INTERPRETER ROUT.  63800000
ERR069   BALR  ERRETR,BASREG            LINK TO INTERPRETER RTN  Y02072 64000002
         DC    X'1F'                    CHAINING CHECK                  64200000
         DC    AL1(ERR070-ERR069-2)     BRANCH TO SET LOGOUT FLAG       64400000
         DC    X'1A'                    PROGRAM CHECK                   64600000
         DC    AL1(ER070A-ERR069-4)     BRANCH TO ECB CODE ROUTINE      64800000
         DC    X'1B'                    PROTECTION CHECK                65000000
         DC    AL1(ER070A-ERR069-6)     BRANCH TO ECB CODE ROUTINE      65200000
         DC    X'19'                    INCORRECT LENGTH                65400000
         DC    AL1(ER070A-ERR069-8)     BRANCH TO ECB CODE ROUTINE      65600000
         DC    X'2F'                    END OF LIST                     65800000
         DC    AL1(ERR075-ERR069-10)    BRANCH TO SET MESSAGE FLAG P ER 66000000
         SPACE 2                                                        66002002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 66200000
*      SET LOGOUT OUT FLAG BIT 7 OF IOBFLG3                             66400000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 66600000
ERR070   OI    IOSFLB,IOSLOG            SET LOGOUT FLAG          Y02072 66800002
*                                                                       67000000
ER070A   OI    IOSCOD,IOSERRC           SET PERMANENT ERROR FLAG Y02072 67200002
*                                                                       67400000
ERR075   OI    IOSFLB,IOSMSG            SET PERM ERROR MSG FLG   Y02072 67600002
         B     ERR078                   BR TO RESET PERM ERROR FLAG     67800002
         SPACE 2                                                        67802002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 68000000
*      SET MESSAGE FLAG FOR OPERATOR ATTN. OR INTERVENTION REQUIRED     68200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 68400000
ERR077   NI    IOSFLB,X'FF'-IOSMSG      IND INTERVENTION REQ'D   Y02072 68600002
*                                       OR OP. ATTN FLAG         Y02072 68800002
ERR078   NI    IOSFLA,X'FF'-IOSERR      RESET PERM ERROR FLAG    Y02072 69000002
         SPACE 2                                                        69002002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 69200000
*                   WTO ROUTINE                                       * 69400000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 69600000
         L     ERRETR,LOC016            GET ADDRESS OF CVT              69800000
         L     ERRETR,VECTXL(ERRETR)    GET ADDRESS OF XCTL             70000000
         LA    ERREG1,WTORTN            LOAD NAME OF WTO                70200000
         BR    ERRETR                   GO TO XCTL                      70400002
*                                                                       70800002
         DC    C'IGE0011E'                   SIGHT IDENTIFIER  @ZA07621 71200003
         DC    CL8'&SYSDATE'                 SIGHT IDENTIFIER  @ZA07621 71200103
         DC    C'Z07621'                     SIGHT IDENTIFIER  @ZA07621 71200203
PATCH    DC    XL20'0',D'0'              PATCH AREA            @ZA07621 71200303
MODLEN   EQU   *                        LENGTH OF THIS MODULE    Y02072 71200402
         EJECT                                                          71202002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 71204002
*        CONTROL BLOCK DEFINITIONS                                    * 71206002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 71208002
         IECDERWA NONE                                           Y02072 71210002
         EJECT                                                          71212002
         IECDIOSB                                                Y02072 71214002
         EJECT                                                          71216002
UCB      DSECT                                                   Y02072 71218002
         IEFUCBOB                                                Y02072 71220002
         END                                                            71400000
./  ADD  SSI=61410550,NAME=IGG019V1
 TITLE   'IGG019V1 - 1419 AND 1275 READ ROUTINE'                        00500000
IGG019V1 CSECT                                                          01000000
*                                                                       01500000
*                                                                       02000000
*STATUS - CHANGE LVL 000   VERSION LVL 000   MODIFICATION LVL 000       02500000
*                                      XA05401 YA04503 SA71344 @ZA00741 02550003
*       RELEASE  21.8 CHANGES          XA05401 YA04503 SA71344 @ZA00741 02600003
*                                      XA05401 YA04503 SA71344 @ZA00741 02650003
*D820000                               XA05401 YA04503 SA71344 @ZA00741 02700003
*A835500                               XA05401 YA04503 SA71344 @ZA00741 02750003
*                                      XA05131 SA71441 YA04502 @ZA01356 02800003
*      VS1 RELEASE 3.1 CHANGES         XA05131 SA71441 YA04502 @ZA01356 02850003
*A645500                               XA05131 SA71441 YA04502 @ZA01356 02900003
*     VS2 REL 3.0 CHANGES                                               02950003
*A170500                               XA06885/SA72880/YA07184 @ZA02230 02960003
*C545000,665000                        XA06885/SA72880/YA07184 @ZA02230 02970003
*                                                              @ZA07621 02977003
*     VS2 REL 04.0 CHANGES                                     @ZA07621 02984003
*C940000                                                       @ZA07621 02991003
*FUNCTION - READ ROUTINE FOR 1419 AND 1275.                             03000000
*        1- SET THE DATA AREA OF THE LAST BUFFER PROCESSED TO BINARY    03500000
*           ZEROES.                                                     04000000
*        2- SET THE ECB IN THE MICB CORRESPONDING TO THE ABOVE BUFFER   04500000
*           TO ZERO.                                                    05000000
*        3- DETERMINE IF THE DEVICE IS ENGAGED, IF IT IS NOT ENGAGED    05500000
*           BRANCH TO THE EOB ROUTINE TO ENGAGE THE DEVICE.             06000000
*        4- SET NO-OP BIT IN THE MICB SEVEN BEFORE THE CURRENT ONE.     06500000
*        5- SET DISENGAGE BIT IN THE MICB SIX BEFORE THE CURRENT ONE.   07000000
*        6- PUT THE IOB ADDRESS IN THE DECB.                            07500000
*        7- PUT THE ADDRESS OF THE BUFFER TO BE PROCESSED IN THE DECB.  08000000
*                                                                       08500000
*ENTRY POINT - IGG019V1 FROM THE READ MACRO EXPANSION                   09000000
*              LA 1,DECB                                                09500003
*              LA 14,DCB                                                10000000
*              L  15,48(14)                                             10500000
*              BALR 14,15                                               11000000
*INPUT- DECB                                                            11500000
*        DECB+8 = DCB ADDRESS                                           12000000
*       DCB                                                             12500000
*        DCBIOBA = ADDRESS OF CURRENT MICB.                             13000000
*        DCBBUFL - BUFFER LENGTH                                        13500000
*        DCBMRFLG = X'10' - USER REQUESTED DISENGAGE                    14000000
*        DCBEOBR = ADDRESS OF EOB ROUTINE                               14500000
*        DCBIOBAD = ADDRESS OF IOB FOR THE PCU                          15000000
*       MICB                                                            15500000
*        MICBNM1 = ADDRESS OF MICB JUST PRIOR TO THE CURRENT ONE.       16000000
*        MICBDATA = ADDRESS OF THE BUFFER TO BE PROCESSED               16500000
*        MICBFLAG = X'80'  ENGAGE NECESSARY                             17000000
*        MICBFLAG = X'04'  UNIT EXCEPTION                      @ZA02230 17050003
*        MICBNM7 = ADDRESS OF MICB SEVEN BEFORE THE CURRENT ONE.        17500000
*       BUFFER                                                          18000000
*        BYTE 0 - X'10' - UNIT EXCEPTION                                18500000
*                                                                       19000000
*OUTPUT-DECB                                                            19500000
*        DECB+16 - ADDRESS OF IOB FOR THE PCU                           20000000
*        DECB+12 - ADDRESS OF THE BUFFER TO BE PROCESSED                20500000
*       MICB                                                            21000000
*        MICBFLAG - BIT 2 IS SET TO ZERO IN THE MICB SEVEN BEFORE       21500000
*                   THE CURRENT ONE.                                    22000000
*                   BIT 2 IS SET TO ONE IN THE MICB SIX BEFORE          22500000
*                   THE CURRENT ONE.                                    23000000
*        MICBECB - SET TO ZERO                                          23500000
*       BUFFER                                                          24000000
*        THE DATA AREA IN THE BUFFER BEFORE THE CURRENT ONE IS          24500000
*        SET TO BINARY ZEROES                                           25000000
*       RETURN CODES                                                    25500000
*        X'00' - EOB NOT ENTERED (ENGAGE NOT NECESSARY)                 26000000
*        X'04' - EOB ENTERED (ENGAGE NECESSARY)                         26500000
*                                                                       27000000
*EXTERNAL ROUTINES - IGG019V1 (EOB FOR 1419)                            27500000
*                                                                       28000000
*EXITS NORMAL - RETURN TO CALLER ON REG 14 AFTER ENGAGING THE DEVICE    28500000
*               OR AFTER MAKING SURE BUFFER IS READY FOR PROCESSING.    29000000
*                                                                       29500000
*EXITS ERROR -  NONE                                                    30000000
*                                                                       30500000
*TABLES/WORKAREAS - CALLERS SAVE AREA                                   31000000
*                                                                       31500000
*ATTRIBUTES - REENTERABLE                                               32000000
*                                                                       32500000
*NOTES - NONE                                                           33000000
*                                                                       33500000
*                                                                       34000000
*                                                                       34500000
*              SYMBOLIC DEFINITIONS OF REGISTERS                        35000000
*                                                                       35500000
RZERO    EQU   0                                                        36000000
DECBR    EQU   1                       DECB ADDRESS UPON ENTRY          36500000
DCBR     EQU   2                       DCB ADDRESS                      37000000
MICBR    EQU   3                       MICB ADDRESS                     37500000
RFOUR    EQU   4                       WORK REG                         38000000
RFIVE    EQU   5                       WORK REG                         38500000
RSIX     EQU   6                       WORK REG                         39000000
RSEVEN   EQU   7                       WORK REG                         39500000
REIGHT   EQU   8                       WORK REG                         40000000
RNINE    EQU   9                       WORK REG                         40500000
RTEN     EQU   10                      WORK REG                         41000000
RELEVEN  EQU   11                      WORK REG                         41500000
BASER    EQU   12                       BASE REGISTER                   42000000
SAVER    EQU   13                                                       42500000
RETRNR   EQU   14                                                       43000000
ENTRYR   EQU   15                                                       43500000
*                                                                       44000000
*              SYMBOLIC DEFINITIONS FOR DISPLACEMENTS                   44500000
*                                                                       45000000
DECBBUFF EQU   12                      DISP TO BUFFER ADDR IN DECB      45500000
DECBDCB  EQU   8                       DISP TO DCB ADDR IN DECB         46000000
DECBIOB  EQU   16                      DISP TO IOB ADDR IN DECB         46500000
DSPZERO  EQU   0                       ZERO DISPLACEMENT                47000000
ECBDSP   EQU   4                       DISP TO ECB IN MICB              47500000
IOBADDR  EQU   8                       DISP TO IOB FROM IOB PREFIX      48000000
LSTBUFF  EQU   24                      DISP TO ADDR OF BUFFER IN MICB   48500000
MICBFLG1 EQU   8                       DISP TO MICB FLAG (NOP-DSNGAGE)  49000000
RTNSVE   EQU   16                      DISP TO REG 15 IN SAVE AREA      49500000
SVEDSP   EQU   12                      DISP TO SAVE AREA                50000000
*                                                                       50500000
*              MISC DEFINITIONS                                         51000000
*                                                                       51500000
DSENFLG  EQU   X'40'                   DISENGAGE FLAG                   52000000
ENGAGE   EQU   X'80'                   ENGAGE NECESSARY                 52500003
FOUR     EQU   4                       TEST RETURN CODE                 53000000
NOP      EQU   X'BF'                   NO-OP FLAG                       53500000
ONE      EQU   1                                                        54000000
UNITEXCP EQU   X'04'                   UNIT EXCEPTION POSTED   @ZA02230 54050003
USERDSEN EQU   X'20'                   USER REQUESTED DISENGAGE         55000000
ZERO     EQU   X'00'                                                    55500000
*                                                                       56000000
*                                                                       56500000
         USING IGG019V1,BASER                                           57000000
         USING IHADCB,DCBR                                              57500000
         USING MICBENTR,MICBR                                           58000000
         STM   RETRNR,BASER,SVEDSP(SAVER)  SAVE THE USER'S REGISTERS    58500000
         LR    BASER,ENTRYR            ESTABLISH A BASE REGISTER        59000000
         L     DCBR,DECBDCB(DECBR)     ESTABLISH DCB ADDRESS            59500000
         L     MICBR,DCBIOBA           ESTABLISH MICB ADDRESS           60000000
         L     RFOUR,MICBNM1           PICK UP ADDRESS OF LAST MICB     60500000
         L     RFIVE,LSTBUFF(RFOUR)    PICK UP ADDRESS OF LAST BUFFER   61000000
         LH    RSIX,DCBBUFL            PICK UP LENGTH OF DATA AREA      61500000
         BCTR  RSIX,ZERO               DECREMENT TO CLEAR BUFFER        62000000
         BCTR  RSIX,ZERO               DITTO                            62500000
         MVI   DSPZERO(RFIVE),ZERO     ZERO FIRST BYTE OF DATA AREA     63000000
         EX    RSIX,LSTBUF             ZERO DATA AREA IN LAST BUFFER    63500000
         SR    RSIX,RSIX               ZERO REG TO CLEAR ECB            64000000
         ST    RSIX,ECBDSP(RFOUR)      ZERO ECB IN LAST MICB            64500000
*********************************************************************** 64510003
*                                                              @ZA01356 64520003
*     THE FOLLOWING INSTRUCTION WILL CLEAR THE SENSE BYTES SO THAT IF * 64530003
*      NO SENSE BYTES ARE TRANSFERED BY THE DEVICE NONE WILL APPEAR   * 64540003
*      IN THE MICB.                                            @ZA01356 64542003
*                                                              @ZA01356 64544003
*********************************************************************** 64546003
*                                                              @ZA01356 64548003
         XC    MICBSENS-MICBENTR(3,RFOUR),MICBSENS-MICBENTR(4) @ZA01356 64550003
         TM    MICBFLAG,ENGAGE         READ ISSUED ON THIS BUFF BEFORE  65000000
         BO    READ010                 YES, BRANCH                      65500000
         L     RSIX,MICBDATA           LOAD ADDRESS OF BUFFER           66000000
         TM    MICBFLAG,UNITEXCP       UNIT EXCEPTION          @ZA02230 66050003
         BZ    READ020                 NO, BRANCH                       67000000
         TM    DCBMRFLG,USERDSEN       YES, WHO REQUESTED DISENGAGE     67500000
         BO    READ020            DONT GO TO EOB                        68000000
*                                                                       68500000
READ010  EQU   *                                                        69000000
*                                                                       69500000
         L     ENTRYR,DCBEOBR          PICK UP EOB ENTRY POINT          70000000
         ST    DECBR,RTNSVE(SAVER)     SAVE DECB ADDR                   70500000
         BALR  RETRNR,ENTRYR           BRANCH TO EOB ROUTINE TO ENGAGE  71000000
         L     DECBR,RTNSVE(SAVER)     LOAD DECB ADDR                   71500000
         LA    ENTRYR,FOUR             LOAD RETURN CODE                 72000000
         ST    ENTRYR,RTNSVE(SAVER)    SET RETURN CODE                  72500000
         B     READ020                 BRANCH AROUND MOVE               73000000
*                                                                       73500000
*                                                                       74000000
* THIS INSTRUCTION IS TO ZERO THE LAST BUFFER                           74500000
*                                                                       75000000
LSTBUF   MVC   ONE(ZERO,RFIVE),ZERO(RFIVE)   ZERO BUFF N-1              75500000
*                                                                       76000000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 76500000
*                                                                     * 77000000
* THE NEXT FOUR INSTRUCTIONS PREVENT THE REFILLING OF BUFFERS         * 77500000
* THAT HAVE NOT BEEN PROCESSED YET.                                   * 78000000
*                                                                     * 78500000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 79000000
*                                                                       79500000
READ020  EQU   *                                                        80000000
*                                                                       80500000
         L     RFOUR,MICBNM7           PICK UP ADDRESS OF MICB SEVEN    81000000
*                                      BEFORE THE CURRENT MICB          81500000
         L     RFIVE,DSPZERO(RFOUR)    PICK UP ADDRESS OF MICB SIX      82500000
*                                      BEFORE THE CURRENT MICB          83000000
         OI    MICBFLG1(RFIVE),DSENFLG SET FLAG TO INDICATE DISENGAGE   83500000
         NI    MICBFLG1(RFOUR),NOP     SET FLAG TO IND NO-OP   @SA71344 83550003
         LA    RFOUR,FOUR              PICK UP EOB RETURN CODE          84000000
         CR    RFOUR,ENTRYR            BEEN TO EOB                      84500000
         BE    READ030                 YES, BRANCH                      85000000
         SR    ENTRYR,ENTRYR           SET RETURN CODE                  85500000
         ST    ENTRYR,RTNSVE(SAVER)    STORE RETURN CODE IN SAVE AREA   86000000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 86500000
*                                                                     * 87000000
* PUT ADDRESS OF IOB AND ADDRESS OF BUFFER TO BE PROCESSED IN THE     * 87500000
* DECB BEFORE EXITING THIS ROUTINE.                                   * 88000000
*                                                                     * 88500000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 89000000
*                                                                       89500000
READ030  EQU   *                                                        90000000
*                                                                       90500000
         L     RFOUR,DCBIOBAD          PICK UP IOB PREFIX ADDR          91000000
         LA    RFOUR,IOBADDR(RFOUR)    COMPUTE IOB ADDR                 91500000
         ST    RFOUR,DECBIOB(DECBR)    UPDATE IOB ADDR IN DECB          92000000
         MVC   DECBBUFF(FOUR,DECBR),MICBDATA  MOVE BUFFER ADDR TO DECB  92500000
         LM    RETRNR,BASER,SVEDSP(SAVER)  LOAD THE USER'S REGISTERS    93000000
         BR    RETRNR                  RETURN TO USER                   93500000
         DC    C'IGG019V1'                  SIGHT INDICATOR *  @ZA07621 94000003
         DC    CL8'&SYSDATE'                SIGHT INDICATOR *  @ZA07621 94060003
         DC    C'Z07621'                    SIGHT INDICATOR *  @ZA07621 94120003
PATCH    DC    XL20'00',D'0'                PATCH AREA         @ZA07621 94200003
         DCBD  DSORG=BS,DEVD=MR                                         94500000
*        MICBD - DUMMY SECTION FOR THE MICB                             94590000
MICBENTR DSECT                                                          94680000
MICBNEXT DS    A                                                        94770000
MICBECB  DS    A                                                        94860000
MICBFLAG DS    AL1                                                      94950000
MICBSENS DS    AL3                                                      95040000
MICBECBA DS    A                                                        95130000
MICBNM7  DS    A                                                        95220000
MICBNM1  DS    A                                                        95310000
MICBDATA DS    A                                                        95400000
         END                                                            95500000
./  ADD  SSI=73630124,NAME=IGG019V2
* /* START OF SPECIFICATIONS ****                                       00100003
*                                                                       00150003
*01* MODULE-TYPE = MODULE                                               00200003
*                                                                       00250003
*02* PROCESSOR = ASSEMBLER                                              00260003
*                                                                       00270003
**** END OF SPECIFICATIONS ***/                                         00280003
 TITLE   'IGG019V2 - 1419 AND 1275 END-OF-BLOCK ROUTINE'                00300000
IGG019V2 CSECT                                                          00600000
*                                                                       00900000
*                                                                       01200000
*STATUS - CHANGE LVL 000   VERSION LVL 000   MODIFICATION LVL 000       01500000
*                                                                       01800000
*        VS2 RELEASE 04.0 CHANGES                              @ZA07621 01803037
*C813000                                                       @ZA07621 01806037
*A414200,447500,771500-772000                                  @ZA27072 01807037
*A615300-617100                                                @ZA28962 01808037
*        VS2 RELEASE 03.0 CHANGES                                       01810037
*C510000         FOR  ALL RELEASES     XA08158/YA06791/SA72885 @ZA02240 01820037
*A584610-584640                                                @ZA07988 01830037
*        RELEASE 21.8 CHANGES                                           01850003
*A582500-584600  FOR  ALL RELEASES     XA05468/YA04572/SA71601 @ZA00970 01900003
*                                                                       01950003
*        VS2 RELEASE 1.8   PLUS CHANGES                                 02000003
*A210500,414500                        SA72880/XA06885/YA07184 @ZA02230 02050003
*C663000                               SA72880/XA06885/YA07184 @ZA02230 02060003
*                                                                       02070003
*                                                                       02080003
*                                                                       02090003
*                                                                       02092003
*                                                                       02094003
*                                                                       02096003
*                                                                       02098003
*                                                                       02098403
*                                                                       02098803
*                                                                       02099203
*                                                                       02099603
*                                                                       02099703
*                                                                       02099803
*                                                                       02099903
*FUNCTION- END-OF-BLOCK ROUTINE FOR 1419 AND 1275.                      02100000
*                                                                       02400000
*           1-DETERMINE IF THE DEVICE IS ON-LINE.  IF NOT ON-LINE EXIT  02700000
*           2-DETERMINE IF A WTO MESSAGE NEEDS DELETING--IF ONE DOES    03000000
*             DELETE IT USING THE DOM MACRO                             03300000
*           3-UPDATE MICB POINTERS (READ AND PCI) SO THEY POINT         03600000
*             TO THE SAME MICB.                                         03900000
*           4-PUT THE ADDRESS OF THE SCU SENSE BYTE IN THE MSENSE CCW.  04200000
*             AND SET THE COMMAND CHAIN ON.                             04500000
*           5-PUT THE ADDRESS OF THE PCU SENSE BYTES IN THE MSENSE      04800000
*             COMMANDS FOR THE PCU CCW STRING.  ALSO THE DATA ADDRESS   05100000
*             IN THE MREAD COMMANDS.                                    05400000
*           6-SET THE FIRST COMMAND CODE IN THE PCU CCW STRING TO       05700000
*             ENGAGE.                                                   06000000
*           7-ISSUE AN EXCP (SVC 00) FOR THE PCU AND THE SCU.           06300000
*           8-RETURN TO READ ROUTINE                                    06600000
*                                                                       06900000
*ENTRY POINT - IGG019V2 FROM THE READ ROUTINE                           07200000
*                L 15,DCBEOBR          PICK UP ADDR OF EOB MODULE       07500000
*                BALR  14,15           BRANCH TO EOB MODULE             07800000
*                                                                       08100000
*INPUT - DCB (ADDRESS OF DCB IS PASSED FROM READ IN REGISTER 2)         08400000
*         DCBIOBAD-ADDRESS OF PCU IOB                                   08700000
*         DCBIOBA -ADDRESS OF MICB                                      09000000
*         DCBWTOID-BEFORE FIRST ENGAGE CONTAINS WTO ID NUMBER           09300000
*         DCBDEBAD- ADDR OF DEB                                         09600000
*         DCBMRIND-X'08'-CONTROL ROUTINE HAS BEEN ENTERED               09900000
*         DCBMRFLG-X'20'-SUPPORT OR USER REQUESTED DISENGAGE BIT        10200000
*                  X'88'-USED BY PCI APPENDAGE                          10500000
*                  X'02'-WTO MESSAGE PRESENT                            10800000
*         DCBBUFL-LENGTH OF EACH BUFFER                                 11100000
*        IOB (SCU)                                                      11400000
*         IOB+16-ADDRESS OF CCW STRING FOR SCU                          11700000
*        IOB (PCU)                                                      12000000
*         IOB+16-ADDRESS OF CCW STRING FOR PCU                          12300000
*        MICB                                                           12600000
*         MICBSENS-SCU SENSE BYTE                                       12900000
*         MICBSENS+1-PCU SENSE BYTES (2)                                13200000
*         MICBFLAG-X'20' FOLLOW-UP DOCUMENTS PROCESSED                  13500000
*                  X'10' FIRST MICB AFTER ENGAGE                        13800000
*         MICBDATA-ADDRESS OF DATA AREA                                 14100000
*         MICBNEXT-ADDRESS OF NEXT MICB                                 14400000
*        DEB                                                            14700000
*         DEBUCBAD- ADDR OF UCB                                         15000000
*        UCB                                                            15300000
*         UCBFL1-X'40'-DEVICE READY                                     15600000
*                                                                       15900000
*OUTPUT- DCB                                                            16200000
*         DCBAPPIN - SET TO ZERO                                        16500000
*         DCBMRIND-X'08'- CONTROL ROUTINE BIT SET TO ZERO               16800000
*         DCBMRFLG-X'10'-DISENGAGE BIT SET TO OFF                       17100000
*                  X'20'-USER REQUESTED DISENGAGE BIT SET OFF.          17400000
*                  X'88'-SET TO ZERO FOR PCI APPENDAGE                  17700000
*                  X'04'-SET TO ONE FOR PCI APPENDAGE                   18000000
*                  X'02'-WTO MESSAGE BIT SET TO ZERO                    18300000
*         DCBWTOID-AFTER FIRST ENGAGE CONTAINS MICB (PCI) ADDR          18600000
*        IOB (PCU)                                                      18900000
*         IOB+4-ECB IS SET TO ZEROES                                    19200000
*        IOB (SCU)                                                      19500000
*         IOB+4-ECB IS SET TO ZEROES                                    19800000
*        MICB-                                                          20100000
*         MICBECB - ECB IN CURRENT MICB SET TO ZEROES                   20400000
*         MICBFLAG-X'20'-ENGAGE THIS BUFFER BIT SET OFF                 20700000
*                  X'10'-FIRST MICB AFTER ENGAGE SET ON                 21000000
*                  X'04'-UNIT EXCEPTION ON THIS BUFFER SET OFF @ZA02230 21050003
*        CHANNEL PROGRAM                                                21300000
*          MSENSE CCW (FOR SCU)-COMMAND CHAIN BIT SET ON                21600000
*                     ADDRESS OF SENSE BYTE IN MICB PLACED IN DATA      21900000
*                       ADDRESS OF CCW.                                 22200000
*          MSENSE CCW (FOR PCU)-ADDRESS OF PCU SENSE BYTES IN MICB      22500000
*                       PLACED IN DATA ADDRESS PORTION OF CCW'S         22800000
*          MREAD-DATA ADDRESS PLACED IN ADDRESS PORTION OF CCW'S        23100000
*          FIRST CCW SET TO ENGAGE                                      23400000
*          FOURTH CCW SET TO NO-OP                                      23700000
*          SEVENTH CCW SET TO NO-OP                                     24000000
*        BUFFERS                                                        24300000
*         THE BUFFER CORRESPONDING TO THE CURRENT MICB IS SET TO ZEROES 24600000
*         INTERVENTION REQUIRED BIT-X'08'-SET ON IF DEVICE NOT READY    24900000
*        WRITE DELAY BUFFER - SET TO ONES                               25200000
*                                                                       25500000
*EXTERNAL ROUTINES - SVC 00 (EXCP) FOR PCU AND SCU.                     25800000
*                                                                       26100000
*EXITS NORMAL - RETURN TO READ MODULE                                   26400000
*                                                                       26700000
*EXITS ERROR - NONE                                                     27000000
*                                                                       27300000
*TABLES/WORKAREAS - NONE                                                27600000
*                                                                       27900000
*ATTRIBUTES - REENTERABLE                                               28200000
*                                                                       28500000
*NOTES - NONE                                                           28800000
*                                                                       29100000
*                                                                       29400000
*                                                                       29700000
*                                                                       30000000
*        SYMBOLIC DEFINITIONS OF REGISTERS                              30300000
PARMREG  EQU   1                                                        30600000
R1       EQU   PARMREG                                                  30700000
DCBREG   EQU   2                       BASE REGISTER FOR DCB            30900000
MICBREG  EQU   4                       BASE REGISTER FOR MICB           31200000
PCUIOBR  EQU   5                       CONTAINS PCU IOB ADDRESS         31500000
SCUIOBR  EQU   6                       CONTAINS SCU IOB ADDRESS         31800000
WRKREG7  EQU   7                                                        32100000
CCWPNTR  EQU   8                       CCW STRING POINTER               32400000
WRKREG9  EQU   9                                                        32700000
WRKREG10 EQU   10                                                       33000000
BASEREG  EQU   11                      BASE REGISTER FOR THIS ROUTINE   33300000
RTNREG   EQU   14                      CONTAINS RETURN ADDRESS          33600000
ENTRYREG EQU   15                      ENTRY POINT REGISTER             33900000
*                                                                       34200000
*              SYMBOLIC DEFINITIONS FOR DISPLACEMENTS                   34500000
*                                                                       34800000
CCWADDR  EQU   24                      DISP TO CCW ADDR IN IOB          35100000
COMNDCHN EQU   4                       DISP TO COMMAND CHAIN BIT IN CCW 35400000
DEBUCBAD EQU   36                      DISP TO SCU UCB ADDR IN DEB      35700000
ECBDISP  EQU   4                       DISP TO ECB IN IOB               36000000
IOBDISP  EQU   8                       DISP TO IOB FROM IOB PREFIX      36300000
NXTCCW   EQU   8                       DISP TO NEXT CCW IN STRING       36600000
NXTSENS  EQU   24                      DISP TO NEXT MSENSE CCW          36900000
RITEDLAY EQU   152                     DISP TO WRITE DELAY BUFF         37200000
SCUCCW   EQU   80                      DISP TO SCU CCW FROM PCU CCW     37500000
SCUIOB   EQU   48                      DISP TO SCU IOB FROM PCU IOB     37800000
UCBFL1   EQU   6                       DISP TO UCB DEVICE STATUS BYTE   38100000
ZERODISP EQU   0                       DISP OF ZERO                     38400000
NOPDIS   EQU   16                 DISP TO NOP IN SCU CCW CHAIN          38500000
*                                                                       38700000
*              MISC DEFINITIONS                                         39000000
*                                                                       39300000
CCOFF    EQU   X'BF'                   SET COMMAND CHAIN BIT OFF        39600000
CMNDCHN  EQU   X'40'                   USED TO SET COMMAND CHAIN ON     39900000
CNTR     EQU   1                       COUNTER                          40200000
CONTROL  EQU   X'08'                   CONTROL ROUTINE BEEN ENTERED     40500000
DVICERDY EQU   X'40'                   DEVICE READY FOR PROCESSING      40800000
ENDCNT   EQU   3                       MAXIMUM TIMES THRU COUNTED LOOP  41100000
ENGAGE   EQU   X'7F'                   ENGAGE FOR THIS BUFFER BIT       41400000
ERPOFF   EQU   3                       TO RESET ERP IND        @ZA27072 41420037
UNITEX   EQU   X'04'                   UNIT EXCEPT ON THIS BUFF@ZA02230 41450003
ENGAGECC EQU   X'EF'                   ENGAGE COMMAND CODE              41700000
FOUR     EQU   4                                                        42000000
EIGHT    EQU   8                    LEN TO CLEAR SNS AND FLAG  @ZA00970 42050003
FRSTBUF  EQU   X'10'                   SET FIRST BUFFER AFTER ENGAGE    42300000
INITBITS EQU   X'67'                   REINITIALIZE DCBMRFLG            42600000
INTVRQD  EQU   X'08'                   BUFFER INTERVENTIN REQ BIT       42900000
MREADCC  EQU   X'4C'                   MODIFIED READ COMMAND CODE       43200000
MSENSECC EQU   X'24'                   MSENSE COMMAND CODE              43500000
NOPCC    EQU   X'03'                   NO-OP COMMAND CODE               43800000
ONE      EQU   1                                                        44100000
ONES     EQU   X'FF'                   SET WRITE DELAY BUFERR TO ONES   44400000
ONE27    EQU   127                     LENGTH OF WRITE DELAY BUFFER     44700000
PFOFF    EQU   X'C0'                   TO RESET POST FLAGS     @ZA27072 44750037
PSTCMPLT EQU   X'7F'                   POST EVENT COMPLETE              45000000
SETBITON EQU   X'04'                   SET ON BIT IN DCB- REINITIALIZE  45300000
SETZERO  EQU   0                                                        45600000
WTOID    EQU   X'02'                                                    45900000
ZERO     EQU   0                                                        46200000
*                                                                       46500000
*                                                                       46800000
         USING IGG019V2,BASEREG                                         47100000
         USING IHADCB,DCBREG                                            47400000
         USING MICBENTR,MICBREG                                         47700000
         LR    BASEREG,ENTRYREG        ESTABLISH BASE REGISTER          48000000
         L     MICBREG,DCBIOBA         ESTABLISH BASE REG. FOR MICB     48300000
         L     WRKREG10,MICBDATA       PICK UP ADDR OF CURRENT BUFFER   48600000
         L     WRKREG9,DCBDEBAD        LOAD ADDR OF DEB                 48900000
         L     WRKREG9,DEBUCBAD(WRKREG9)   LOAD ADDR OF UCB             49200000
         TM    UCBFL1(WRKREG9),DVICERDY    IS THE DEVICE READY          49500000
         BZ    EOB010                  YES, BRANCH                      49800000
         TM    DCBMRIND,CONTROL        CONTROL ROUTINE CAUSE NOT-READY  50100000
         BZ    EOB010                  NO, BRANCH                       50400000
         XI    DCBMRIND,CONTROL        SET OFF CONTROL RTN BIT          50700000
         MVI   ZERODISP(WRKREG10),INTVRQD  SET ON INT REQ ONLY @ZA02240 51000037
         MVI   MICBECB,PSTCMPLT        POST AS COMPLETE                 51300000
         B     EOB050                  BRANCH AND EXIT EOB              51600000
*                                                                       51900000
EOB010   EQU   *                                                        52200000
*                                                                       52500000
         TM    DCBMRFLG,WTOID          IS THERE A WTO MESSAGE           52800000
         BZ    EOB020                  NO MESSAGE - BRANCH              53100000
         L     PARMREG,DCBWTOID        LOAD WTO ID FOR DOM MACRO        53400000
         LA    PARMREG,ZERODISP(PARMREG)    CLEAR OUT GARBAGE           53500000
         DOM   MSG=(R1)                ISSUE DOM MACRO                  53600000
         XC    DCBWTOID(FOUR),DCBWTOID   ZERO THE WTO ID WORD IN DCB    53700000
         XI    DCBMRFLG,WTOID          SET THE WTO BIT TO ZERO          54000000
*                                                                       54300000
EOB020   EQU   *                                                        54600000
*                                                                       54900000
         ST    MICBREG,DCBWTOID        UPDATE MICB ADDRESS FOR PCI      55200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 55500000
*                                                                     * 55800000
* SET ECB'S IN SCUIOB AND PCUIOB AND CURRENT BUFFER TO ZERO BEFORE    * 56100000
* ISSUING AN ENGAGE.                                                  * 56400000
*                                                                     * 56700000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 57000000
         LH    WRKREG9,DCBBUFL         LOAD LENGTH OF BUFF N. (CURRENT) 57300000
         BCTR  WRKREG9,ZERO            DECREMENT LENGTH TO ZERO BUFF N  57600000
         EX    WRKREG9,CRNTBUFF        ZERO THE CURRENT BUFFER          57900000
         MVI   MICBECB,SETZERO         ZERO CURRENT MICB ECB            58200000
         L     WRKREG7,MICBNEXT        POINT TO NEXT MICB      @ZA00970 58250003
         XC    FOUR(EIGHT,WRKREG7),FOUR(WRKREG7)  CLR FLG SNS  @ZA00970 58300003
         L     WRKREG10,MICBDATA-MICBENTR(0,WRKREG7)  GET PTR  @ZA00970 58400003
         EX    WRKREG9,CRNTBUFF        CLEAR THE NEXT BUFFER   @ZA00970 58460003
         L     WRKREG7,MICBNM1         POINT TO PRIOR MICB     @ZA07988 58468037
         XC    FOUR(EIGHT,WRKREG7),FOUR(WRKREG7)  CLR FLG SNS  @ZA07988 58476037
         L     WRKREG10,MICBDATA-MICBENTR(0,WRKREG7)  GET PTR  @ZA07988 58484037
         EX    WRKREG9,CRNTBUFF        CLEAR THE PRIOR BUFFER  @ZA07988 58492037
         L     PCUIOBR,DCBIOBAD        PICK UP THE PCU IOB ADDRESS      58500000
         XC    ECBDISP(FOUR,PCUIOBR),ECBDISP(PCUIOBR)  ZERO PCU IOB ECB 58800000
         LA    SCUIOBR,SCUIOB(PCUIOBR) COMPUTE ADDRESS OF SCUIOB        59100000
         XC    ECBDISP(FOUR,SCUIOBR),ECBDISP(SCUIOBR)  ZERO SCU IOB ECB 59400000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 59700000
*                                                                     * 60000000
* THE FOLLOWING INSTRUCTIONS UPDATE THE CCW'S IN THE STRING FOR       * 60300000
* THE SCU SO AN ENGAGE CAN BE ISSUED TO START THE DEVICE.             * 60600000
*                                                                     * 60900000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 61200000
         L     CCWPNTR,CCWADDR(PCUIOBR)  PICK UP ADDR OF PCU CCW STRING 61500000
         L     PARMREG,DCBDEBAD          DEB POINTER           @ZA28962 61530037
         ST    PARMREG,0(CCWPNTR)        STORE DEB ADDRESS     @ZA28962 61560037
         MVI   0(CCWPNTR),X'A0'          STORE PURGE OPTIONS   @ZA28962 61590037
         LA    PARMREG,0(CCWPNTR)        CLEAR HI BYTE         @ZA28962 61620037
         PURGE (1)                       ISSUE PURGE           @ZA28962 61650037
         XC    0(5,CCWPNTR),0(CCWPNTR)   CLEAR PARM LIST       @ZA28962 61680037
         MVI   4(CCWPNTR),X'60'          RESTORE CCW FLAG      @ZA28962 61710037
         LA    CCWPNTR,SCUCCW(CCWPNTR) COMPUTE ADDR OF SCU CCW STRING   61800000
         ST    CCWPNTR,CCWADDR(SCUIOBR)  STORE SCU CCW ADDR IN SCU IOB  62100000
         LA    WRKREG9,MICBSENS        PICK UP ADDR OF SCU SENSE BYTE   62400000
         ST    WRKREG9,ZERODISP(CCWPNTR)  UPDTE ADDR IN MSENSE CCW      62700000
         MVI   ZERODISP(CCWPNTR),MSENSECC  RESTORE  MSENSE COMMAND CODE 63000000
         MVI   NOPDIS(CCWPNTR),MREADCC  SET FOR COMMAND REJECT          63100000
         OI    COMNDCHN(CCWPNTR),CMNDCHN  SET COMMAND CHAIN  ON         63300000
         ST    WRKREG9,NXTSENS(CCWPNTR)    PUT SENSE ADDR IN MSENSE CCW 63600000
         MVI   NXTSENS(CCWPNTR),MSENSECC   RESTORE COMMAND CODE         63900000
         NI    NXTSENS+COMNDCHN(CCWPNTR),CCOFF   TURN OFF COMMAND CHAIN 64200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 64500000
*                                                                     * 64800000
* THE FOLLOWING INSTRUCTIONS UPDATE THE CCW'S IN THE STRING FOR       * 65100000
* THE PCU SO AN ENGAGE CAN BE ISSUED TO START THE DEVICE.             * 65400000
*                                                                     * 65700000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 66000000
         NI    MICBFLAG,ENGAGE-UNITEX CLEAR ENGAGE-UNITEX     @ZA02230  66050037
         OI    MICBFLAG,FRSTBUF        SET FIRST BFR AFTER ENGAGE BIT   66600000
         L     CCWPNTR,CCWADDR(PCUIOBR)    PICK UP PCU CCW ADDR         66900000
         MVI   ZERODISP(CCWPNTR),ENGAGECC  SET COMMAND CODE TO ENGAGE   67200000
         LA    WRKREG10,CNTR           ESTABLISH LOOP COUNTER           67500000
         LA    WRKREG7,ENDCNT          ESTABLISH MAXIMUM TIME THRU LOOP 67800000
*                                                                       68100000
EOB030   EQU   *                                                        68400000
*                                                                       68700000
         LA    CCWPNTR,NXTCCW(CCWPNTR) INCREMENT CCW POINTER            69000000
         L     WRKREG9,MICBDATA        PICK UP ADDRESS OF BUFFER        69300000
         AH    WRKREG9,DCBBUFL         ADD BFR LNG TO POINT TO LAST     69600000
         BCTR  WRKREG9,ZERO            BYTE FOR READ BACKWARDS.         69900000
         ST    WRKREG9,ZERODISP(CCWPNTR)   PUT DATA ADDR IN MREAD CCW   70200000
         MVI   ZERODISP(CCWPNTR),MREADCC   RESTORE MREAD COMMAND CODE   70500000
         LA    CCWPNTR,NXTCCW(CCWPNTR) INCREMENT CCW POINTER            70800000
         LA    WRKREG9,MICBSENS+ONE    PICK UP ADDR OF PCU SENSE BYTES  71100000
         ST    WRKREG9,ZERODISP(CCWPNTR)   STORE ADDR IN MSENSE CCW     71400000
         MVI   ZERODISP(CCWPNTR),MSENSECC  RESTORE MSENSE COMMAND CODE  71700000
         CR    WRKREG10,WRKREG7        PROCESSED ALL CCW'S              72000000
         BE    EOB040                  YES, BRANCH                      72300000
         LA    CCWPNTR,NXTCCW(CCWPNTR) INCREMENT CCW POINTER            72600000
         MVI   ZERODISP(CCWPNTR),NOPCC SET COMMAND CODE TO NO-OP        72900000
         L     MICBREG,MICBNEXT        PICK UP ADDR OF NEXT MICB        73200000
         LA    WRKREG10,CNTR(WRKREG10) INCREMENT LOOP COUNTER           73500000
         B     EOB030                  BRANCH TO UPDATE NEXT 3 CCWS.    73800000
*                                                                       74100000
EOB040   EQU   *                                                        74400000
*                                                                       74700000
         L     CCWPNTR,CCWADDR(PCUIOBR)  LOAD PCU CCW ADDR              75000000
         LA    CCWPNTR,RITEDLAY(CCWPNTR)  COMPUTE ADDR OF WRITE BUFFER  75300000
         MVI   ZERO(CCWPNTR),ONES             *  SET THE WRITE DELAY  * 75600000
         MVC   ONE(ONE27,CCWPNTR),ZERO(CCWPNTR)   *  BUFFER TO ONES *   75900000
         LA    WRKREG9,IOBDISP         LOAD DISP TO IOB FROM PREFIX     76200000
         AR    PCUIOBR,WRKREG9         COMPUTE PCU IOB ADDR             76500000
         AR    SCUIOBR,WRKREG9         COMPUTE SCU IOB ADDR             76800000
         MVI   DCBAPPIN,SETZERO        SET DCBAPPIN TO ZEROES           77100000
         NI    DCBMRFG,ONES-PFOFF      RESET POST FLAGS        @ZA27072 77150037
         NI    DCBMRIND,ONES-ERPOFF    RESET ERP INDICATORS    @ZA27072 77200037
         NI    DCBMRFLG,INITBITS       RE-INITIALIZE BITS IN THE DCB    77400000
         OI    DCBMRFLG,SETBITON       RE-INITIALIZE BITS IN THE DCB    77700000
         EXCP  (5)                     ISSUE EXCP FOR PCU               78000000
         EXCP  (6)                     ISSUE EXCP FOR SCU               78300000
*                                                                       78600000
EOB050   EQU   *                                                        78900000
*                                                                       79200000
         BR    RTNREG                  RETURN TO READ MODULE            79500000
*                                                                       79800000
*                                                                       80100000
* THE FOLLOWING INSTRUCTION IS USED TO ZERO THE CURRENT BUFFER          80400000
CRNTBUFF XC    ZERO(ZERO,WRKREG10),ZERO(WRKREG10)                       80700000
*                                                                       81000000
         DC    C'IGG019V2'                                     @ZA07621 81300037
         DC    CL8'&SYSDATE'                                   @ZA07621 81320037
         DC    C'Z28962'                                       @ZA07621 81340037
         DC    XL2'0'                                          @ZA07621 81360037
         DC    D'0'                                            @ZA07621 81400037
         DCBD  DSORG=BS,DEVD=MR                                         81600000
*        MICBD - DUMMY SECTION FOR THE MICB                             81650000
MICBENTR DSECT                                                          81700000
MICBNEXT DS    A                                                        81750000
MICBECB  DS    A                                                        81800000
MICBFLAG DS    AL1                                                      81850000
MICBSENS DS    AL3                                                      81900000
MICBECBA DS    A                                                        81950000
MICBNM7  DS    A                                                        82000000
MICBNM1  DS    A                                                        82050000
MICBDATA DS    A                                                        82100000
         END                                                            82200000
./  ADD  SSI=81590227,NAME=IGG019V3
 TITLE   'IGG019V3 - 1419 AND 1275 CHECK ROUTINE'                       00300000
IGG019V3 CSECT                                                          00600000
*                                                                       00900000
*                                                                       01200000
*STATUS - CHANGE LVL 000   VERSION LVL 000   MODIFICATION LVL 000       01500000
*                                                                       01800000
*       CHANGES SINCE VS2-3.7                                  @ZA07621 01900037
*C894000                                                       @ZA07621 01950037
*A861500-863500,A894000                                        @ZA32068 02000037
*FUNCTION - CHECK ROUTINE FOR 1419 AND 1275.                            02100000
*            1-ZERO OUT ECB IN DECB'S.                                  02400000
*            2-DETERMINE IF AN I/O OPERATION HAS BEEN POSTED COMPLETE   02700000
*              FOR ANY OF THE CHAINED DECB'S.                           03000000
*            3-IF NONE ARE POSTED-CONSTRUCT A PARAMETER LIST OF ECB     03300000
*              ADDRESSES TO BE PASSED TO WAIT.                          03600000
*            4-WAIT FOR AN I/O OPERATION TO BE POSTED.                  03900000
*            5-DETERMINE WHICH DECB IT WAS POSTED FOR.                  04200000
*            6-DETERMINE IF THE OPERATION COMPLETED WITHOUT AN ERROR    04500000
*            7-IF AN I/O ERROR OCCURRED THEN:                           04800000
*               A-DETERMINE IF IT WAS ON THE PCU OR SCU.                05100000
*               B-IF NO SYNAD IS PRESENT CALL EOV (SVC 55) TO ABEND     05400000
*               C-BRANCH TO USER'S SYNAD ROUTINE                        05700000
*               D-ZERO MICBECB SO COMPLETE BIT WILL BE OFF              06000000
*            8-IF THE I/O OPERATION COMPLETED SUCCESSFULLY THEN         06300000
*              UPDATE THE MICB(READ) POINTER.                           06600000
*                                                                       06900000
*ENTRY POINT - IGG019V3 FROM THE CHECK MACRO EXPANSION                  07200000
*              AN EXAMPLE OF THE EXPANSION IS:                          07500000
*                LA  1,DECB       LOAD ADDR OF DECB                     07800000
*                L   14,8(15)     PICK UP DCB ADDR                      08100000
*                L  15,52(14)     PICK UP MODULE ADDR                   08400000
*                BALR 14,15       BRANCH TO MODULE                      08700000
*                                                                       09000000
*INPUT - PARAMETER LIST OF DECB ADDRESSES                               09300000
*        DECB                                                           09600000
*         DECB+4 - POINTER TO NEXT DECB                                 09900000
*         DECB+8 - DCB ADDRESS                                          10200000
*        DCB                                                            10500000
*         DCBECBLT - ADDRESS OF ECB LIST AREA                           10800000
*         DCBIOBA - ADDRESS OF MICB                                     11100000
*         DCBIOBAD - ADDRESS OF IOB                                     11400000
*         DCBSYNAD - ADDRESS OF USER'S SYNAD ROUTINE                    11700000
*        MICB                                                           12000000
*         MICBNEXT - ADDRESS OF NEXT MICB                               12300000
*         MICBECB  - X'7F' - SUCCESSFUL I/O OPERATION                   12600000
*                    X'40' - ERROR ON THE I/O OPERATION                 12900000
*         MICBECB+3- X'01'  ERROR POSTED IS ON SCU                      13200000
*        BUFFER                                                         13500000
*         BYTE 0 - X'18' - UNIT EXCEPTION OR INTERVENTION REQUIRED      13800000
*                                                                       14100000
*OUTPUT - DECB                                                          14400000
*          DECB+0 - ECB POSTED                                          14700000
*         DCB                                                           15000000
*          DCBIOBA - ADDRESS OF MICB (UPDATED TO NEXT MICB)             15300000
*         MICB                                                          15600000
*          MICBECB - X'7F' SUCCESSFUL  I/O OPERATION (COMPLETION CODE)  15900000
*                    X'40' ERROR ON THE I/O OPERATION (COMPLETION CODE) 16200000
*                    X'01' LOW ORDER BIT IN ECB - ERROR ON SCU          16500000
*          MICBFLAG - X'80' ENGAGE NECESSARY FOR THIS BUFFER BIT SET ON 16800000
*                     X'10' - FIRST BUFFER AFTER ENGAGE BIT SET OFF     17100000
*         RETURN CODES                                                  17400000
*          X'00' - I/O OPERATION COMPLETED SUCCESSFULLY                 17700000
*          X'04' - ERROR ON I/O OPERATION                               18000000
*                                                                       18300000
*EXTERNAL ROUTINES - SVC 55 (EOV)                                       18600000
*                    SVC 01 (WAIT)                                      18900000
*                    USER'S SYNAD ROUTINE                               19200000
*                                                                       19500000
*EXITS NORMAL - RETURN TO USER.                                         19800000
*                                                                       20100000
*EXITS ERROR - ABEND 001 IF THE USER FAILS TO SPECIFY A SYNAD ROUTINE.  20400000
*                                                                       20700000
*TABLES/WORKAREAS - NONE                                                21000000
*                                                                       21300000
*ATTRIBUTES - REENTERABLE                                               21600000
*                                                                       21900000
*NOTES - THE USER CAN ONLY HAVE A MAXIMUM OF 16 DEVICES CONNECTED TO    22200000
*        ONE CPU.  HENCE IF MORE THAN 16 DECB'S ARE PRESENT ONLY THE    22500000
*        FIRST 16 WILL BE PROCESSED.                                    22800000
*                                                                       23100000
*                                                                       23400000
*                                                                       23700000
*              SYMBOLIC DEFINITIONS OF REGISTERS                        24000000
*                                                                       24300000
REGZERO  EQU   0                                                        24600000
PARMR    EQU   1                       CONTAINS ADDR OF FIRST DECB      24900000
DCBR     EQU   2                       DCB ADDRESS                      25200000
ECBR     EQU   3                       ADDRESS OF ECB PARAMETER LIST    25500000
BASER    EQU   4                       BASE REGISTER                    25800000
DECBR    EQU   5                       DECB ADDRESS                     26100000
INDEXR   EQU   6                       INDEX REGISTER                   26400000
MICBR    EQU   7                       MICB ADDRESS                     26700000
REG8     EQU   8                                                        27000000
REG9     EQU   9                                                        27300000
REG10    EQU   10                                                       27600000
SAVER    EQU   13                      ADDRESS OF SAVE AREA             27900000
RETURNR  EQU   14                      RETURN ADDRESS                   28200000
ENTRYR   EQU   15                      ENTRY POINT ADDR & RETURN CODES  28500000
*                                                                       28800000
*              SYMBOLIC DEFINITIONS FOR DISPLACEMENTS                   29100000
*                                                                       29400000
DECBADR  EQU   4                       DISP TO ADDR OF NEXT DECB        29700000
DECBDCB  EQU   8                       DISP TO DCB ADDR IN DECB         30000000
DECBIOB  EQU   16                      DISP TO IOB ADDR IN DECB         30300000
IOBSENS  EQU   20                      DISP TO CSW SENSE INFO IN IOB    30600000
REG1DSP  EQU   24                      DISP TO SAVE AREA OF REG 1       30900000
RTNDSP   EQU   16                      DISP TO SET RETURN CODE          31200000
SAVEDISP EQU   12                      DISP TO SAVE AREA                31500000
SCUIOB   EQU   48                      DISP OF SCU IOB FROM PCU IOB     31800000
SIXTY4   EQU   64                      DISP TO SAVE DECBR AND BASER     32100000
SVEPRMS  EQU   20                      DISP TO SAVE SVC PARAMETERS      32400000
TWNTY8   EQU   28                      DISP TO USER REGS FOR SYNAD      32700000
ZEROD    EQU   0                       ZERO DISPLACEMENT                33000000
*                                                                       33300000
*              MISC DEFINITIONS                                         33600000
*                                                                       33900000
BUFFMPTY EQU   X'18'                   UNIT EXCPTN OR INTRVNTN REQ      34200000
DCBALTER EQU   X'10'                   DCB ALTERED--SET ON FOR CLOSE    34500000
FOUR     EQU   4                                                        34800000
FRSTENG  EQU   X'EF'                   SET OFF FRST BUFF AFTER ENGAGE   35100000
IOERROR  EQU   X'41'                                                    35400000
INDXINCR EQU   4                       INDES REGISTER INCREMENT         35700000
LISTEND  EQU   X'80'                   END OF PARAMETER LIST            36000000
MAXDEVCE EQU   16                      MAXIMUM DEVICES SUPPORTED        36300000
NOSYNAD  EQU   X'01'                   ABEND COMPLETION CODE - NO SYNAD 36600000
PSTDCMPL EQU   X'40'                   ECB COMPLETE BIT ON              36900000
SCUERROR EQU   X'01'                   ECB - ERROR ON SCU               37200000
SETON    EQU   X'80'                   ENGAGE NECESSARY ON THIS BUFFER  37500000
SHIFT12  EQU   12                      SHIFT ABEND COMPLETION CODE      37800000
SIX4     EQU   64                                                       38100000
SYNDRTN  EQU   X'01'                                                    38400000
THREE    EQU   3                                                        38700000
UNITEXCP EQU   X'FE'                   UNIT EXCEPTION BIT TO 0 FOR EOV  39000000
X7FPSTD  EQU   X'7F'                   ECB - SUCCESSFUL COMPLETION      39300000
ZERO     EQU   0                                                        39600000
OFFREQ   EQU   X'DF'              TURN OFF USER REQUEST FLAG            39700000
*                                                                       39900000
*                                                                       40200000
         USING IGG019V3,BASER                                           40500000
         USING IHADCB,DCBR                                              40800000
         USING MICBENTR,MICBR                                           41100000
         STM   RETURNR,REG10,SAVEDISP(SAVER)  SAVE USER'S REGISTERS     41400000
         LR    BASER,ENTRYR            ESTABLISH BASE REGISTER          41700000
         SR    INDEXR,INDEXR           INITALIZE INDEX REGISTER         42000000
         LR    DECBR,PARMR             LOAD THE DECB ADDR               42300000
         LR    REG10,DECBR             SAVE THE ADDR OF THE FIRST DECB  42600000
         L     DCBR,DECBDCB(DECBR)     PICK UP ADDR OF DCB FROM DECB    42900000
         L     ECBR,DCBMRIND           PICK UP ADDR OF ECB LIST AREA    43200000
         XC    ZERO(SIX4,ECBR),ZERO(ECBR)   ZERO ECB LIST AREA          43500000
         SR    PARMR,PARMR             INITALIZE REGISTER               43800000
         LA    REG9,MAXDEVCE           MAXIMUM MICR DEVICES SUPPORTED   44100000
*                                                                       44400000
CHCK010  EQU   *                                                        44700000
*                                                                       45000000
         ST    PARMR,ZEROD(DECBR)      ZERO OUT ECB IN THE DECB         45300000
         L     MICBR,DCBIOBA           PICK UP ADDRESS OF MICB          45600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 45900000
*                                                                     * 46200000
* IF THE ECB IS NOT POSTED COMPLETE FOR THE MICB - PUT ITS ADDRESS    * 46500000
* IN THE ECB PARAMETER LIST AND WAIT FOR THE EVENT TO COMPLETE        * 46800000
*                                                                     * 47100000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 47400000
         TM    MICBECB,PSTDCMPL        EVENT POSTED COMPLETE            47700000
         BO    CHCK040                 YES, BRANCH                      48000000
         LA    REG8,MICBECB            NO, PICK UP MICB ECB ADDR        48300000
         ST    REG8,ZEROD(INDEXR,ECBR) PUT THIS ADDR IN ECB ADDR LIST   48600000
         C     PARMR,DECBADR(DECBR)    IS THIS THE LAST DECB            48900000
         BE    CHCK020                 YES,BRANCH                       49200000
         LA    INDEXR,INDXINCR(INDEXR) NO, UPDATE INDX FOR NEXT DECB    49500000
         L     DECBR,DECBADR(DECBR)    PICK UP ADDR OF NEXT DECB        49800000
         L     DCBR,DECBDCB(DECBR)     PICK UP DCB ADDR FROM DECB       50100000
         BCT   REG9,CHCK010            MORE THAN 16 DEVICES NO, BRANCH  50400000
*                                                                       50700000
CHCK020  EQU   *                                                        51000000
*                                                                       51300000
         AR    INDEXR,ECBR             COMPUTE ADDR OF LAST ECB ADDR    51600000
         MVI   ZEROD(INDEXR),LISTEND   SET HIGH-ORDER BIT TO ONE        51900000
         LR    PARMR,ECBR              PUT ECB PARMLIST ADDR IN REG 1   52200000
         WAIT  1,ECBLIST=(1)           WAIT FOR ONE EVENT TO COMPLETE   52500000
         SR    INDEXR,INDEXR           INITALIZE INDEX REGISTER         52800000
         LR    DECBR,REG10             LOAD ADDR OF FIRST DECB          53100000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 53400000
*                                                                     * 53700000
* DETERMINE WHICH ECB WAS POSTED COMPLETE                             * 54000000
*                                                                     * 54300000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 54600000
*                                                                       54900000
CHCK030  EQU   *                                                        55200000
*                                                                       55500000
         L     REG8,ZEROD(INDEXR,ECBR) PICK UP MICB ECB ADDR            55800000
         TM    ZEROD(REG8),PSTDCMPL    IS THIS ECB POSTED COMPLETE      56100000
         BO    CHCK040                 YES, BRANCH                      56400000
         LA    INDEXR,INDXINCR(INDEXR) NO, INCREMENT INDEX REGISTER AND 56700000
         L     DECBR,DECBADR(DECBR)    PICK UP ADDR OF NEXT DECB        57000000
         B     CHCK030                 BRANCH TO LOOK AT NEXT ECB       57300000
*                                                                       57600000
CHCK040  EQU   *                                                        57900000
*                                                                       58200000
         L     DCBR,DECBDCB(DECBR)     PICK UP DCB ADDR FROM DECB       58500000
         L     MICBR,DCBIOBA           PICK UP MICB ADDR                58800000
         NI    MICBFLAG,FRSTENG        SET OFF FIRST BUFF AFTER ENGAGE  59100000
         MVC   ZEROD(FOUR,DECBR),MICBECB  MOVE ECB TO DECB FROM MICB    59400000
         CLI   MICBECB,X7FPSTD         SUCCESSFULL COMPLETION POSTED    59700000
         BNE   CHCK050                 NO, BRANCH                       60000000
         L     REG9,MICBDATA           LOAD ADDR OF CURRENT BUFFER      60300000
         TM    ZEROD(REG9),BUFFMPTY    UNIT EXCEP OR INTERVENTION REQ   60600000
         BZ    CHCK041                 NO, BRANCH                       60900000
         NI    DCBMRFLG,OFFREQ    TURN OFF FLAG FOR USER DISEN REQUEST  61000000
         OI    MICBFLAG,SETON          SET ENGAGE NECESSARY BIT ON      61200000
         XC    MICBECB(FOUR),MICBECB   ZERO ECB IN MICB                 61500000
         B     CHCK042                 BRANCH TO SET RETURN CODE        61800000
*                                                                       62100000
CHCK041  EQU   *                                                        62400000
*                                                                       62700000
         L     REG8,MICBNEXT           PICK UP ADDR OF NEXT MICB        63000000
         ST    REG8,DCBIOBA            STORE IT IN THE DCB              63300000
*                                                                       63600000
CHCK042  EQU   *                                                        63900000
*                                                                       64200000
         SR    ENTRYR,ENTRYR                                            64500000
         ST    ENTRYR,RTNDSP(SAVER)    SET RETURN CODE - SUCCESSFUL     64800000
         B     CHCK090                 BRANCH TO LOAD THE REGS AND EXIT 65100000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 65400000
*                                                                     * 65700000
*  DETERMINE IF I/O ERROR WAS ON PCU OR SCU.  IF IT WAS ON THE SCU    * 66000000
*  CHANGE DCB AND DECB TO SCU IOB PREFIX ADDR AND SCU IOB ADDR.       * 66300000
*                                                                     * 66600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 66900000
*                                                                       67200000
CHCK050  EQU   *                                                        67500000
*                                                                       67800000
         OI    MICBFLAG,SETON          SET ENGAGE NECESSARY BIT ON      68100000
         LR    PARMR,DCBR              SET UP DCB PARAMETER FOR SVC     68400000
         L     REG8,DCBIOBAD           PICK UP PCU IOB ADDR             68700000
         CLI   MICBECB+THREE,SCUERROR  ERROR ON SCU                     69000000
         BNE   CHCK060                 NO, BRANCH ERROR IS ON PCU       69300000
         LA    REG8,SCUIOB(REG8)       COMPUTE SCU IOB PREFIX ADDR      69600000
         ST    REG8,DCBIOBAD           STORE SCU IOB PREFIX ADDR IN DCB 69900000
         L     REG9,DECBIOB(DECBR)     LOAD PCU IOB ADDR FROM DECB      70200000
         LA    REG9,SCUIOB(REG9)       COMPUTE SCU IOB ADDR             70500000
         ST    REG9,DECBIOB(DECBR)     STORE SCU IOB ADDR IN DECB       70800000
         OI    DCBMRIND,DCBALTER       SET BIT ON TO SHOW DCB ALTERED   71100000
*                                                                       71400000
CHCK060  EQU   *                                                        71700000
*                                                                       72000000
         CLI   DCBSYNAD+THREE,SYNDRTN  SYNAD ROUTINE PRESENT            72300000
         BNE   CHCK070                 YES, BRANCH                      72600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 72900000
*                                                                     * 73200000
*  IF NO SYNAD ROUTINE IS SPECIFIED GO TO EOV (SVC 55) TO ABNORMALLY  * 73500000
*  TERMINATE THE JOB.                                                 * 73800000
*                                                                     * 74100000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 74400000
         LA    REGZERO,NOSYNAD         SET UP REG FOR ABEND - NO SYNAD  74600000
         SLL   REGZERO,SHIFT12         SHIFT ABEND CODE 12 BITS FOR EOV 74800000
         NI    IOBSENS(REG8),UNITEXCP  SET UNIT EXCEPTION BIT OFF       75000000
         EOV   (1)                                                      75300000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 75600000
*                                                                     * 75900000
*  IF THE SYNAD IS SPECIFIED--SET UP PARAMTERS AND REGISTERS BEFORE   * 76200000
*  BRANCHING TO THE SYNAD ROUTINE.  RESTORE IF USER RETURNS CONTROL.  * 76500000
*                                                                     * 76800000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 77100000
*                                                                       77400000
CHCK070  EQU   *                                                        77700000
*                                                                       78000000
         MVI   FOUR(REG8),IOERROR      POST IOB ECB FOR SYNAD           78300000
         LR    REGZERO,DECBR           DECB ADDR IN REG 0 FOR SYNAD     78600000
         L     REG9,INPUTBIT           PICK UP FLAG FOR PARM REG        78900000
         LR    PARMR,DCBR              DCB ADDR IN REG 1 FOR SYNAD      79200000
         LA    PARMR,ZEROD(PARMR)      CLEAR HIGH ORDER BYTE IN REG 1   79500000
         AR    PARMR,REG9              SET FLAGS ON IN HIGH ORDER BYTE  79800000
         STM   BASER,DECBR,SIXTY4(SAVER)   SAVE DECB ADDR AND BASE REG  80100000
         L     ENTRYR,DCBSYNAD         PICK UP ADDR OF SYNAD RTN        80400000
         LM    DCBR,REG10,TWNTY8(SAVER)   LOAD USER REGS                80700000
         BALR  RETURNR,ENTRYR          BRANCH TO USER SYNAD RTN         81000000
         STM   DCBR,REG10,TWNTY8(SAVER)    SAVE USER REGS               81300000
         LM    BASER,DECBR,SIXTY4(SAVER)   LOAD DECB ADDR AND BASE REG  81600000
         L     DCBR,DECBDCB(DECBR)     LOAD DCB ADDR FROM DECB          81900000
         TM    DCBMRIND,DCBALTER       ERROR ON SCU                     82200000
         BZ    CHCK080                 NO, BRANCH                       82500000
         L     REG8,DCBIOBAD           LOAD IOB PREFIX ADDR FRO  DCB    82800000
         LA    REG9,SCUIOB             LOAD DISP FROM PCU TO SCU IOB    83100000
         SR    REG8,REG9               COMPUTE ADDR OF PCU IOB          83400000
         ST    REG8,DCBIOBAD           STORE PCU IOB PREFIX ADDR IN DCB 83700000
         L     REG8,DECBIOB(DECBR)     LOAD IOB ADDR FROM DECB          84000000
         SR    REG8,REG9               COMPUTE IOB ADDR FOR DECB        84300000
         ST    REG8,DECBIOB(DECBR)     STORE PCU IOB ADDR IN DECB       84600000
         XI    DCBMRIND,DCBALTER       SET BIT OFF TO SHOW DCB RESTORED 84900000
*                                                                       85200000
CHCK080  EQU   *                                                        85500000
*                                                                       85800000
         L     MICBR,DCBIOBA           LOAD ADDRESS OF MICB             85900000
         XC    MICBECB(FOUR),MICBECB   ZERO ECB IN MICB                 86100000
         L     REG8,MICBDATA           BUFFER ADDRESS          @ZA32068 86150037
         CLC   0(6,REG8),ZEROES        BUFFER STATUS=ZERO?     @ZA32068 86200037
         BNE   HAVESTAT                NO-GO AROUND            @ZA32068 86250037
         OI    0(REG8),X'04'           INDICATE MISSED PCI     @ZA32068 86300037
HAVESTAT EQU   *                                               @ZA32068 86350037
         LA    ENTRYR,FOUR             LOAD RETURN CODE                 86400000
         ST    ENTRYR,RTNDSP(SAVER)    SET RETURN CODE                  86700000
*                                                                       87000000
CHCK090  EQU   *                                                        87300000
*                                                                       87600000
         ST    DECBR,REG1DSP(SAVER)    PUT DECB ADDR IN REG 1 SAVE AREA 87900000
         LM    RETURNR,REG10,SAVEDISP(SAVER)  LOAD THE USER'S REGS      88200000
         BR    RETURNR                 RETURN TO USER                   88500000
         DS    0F                                                       88800000
INPUTBIT DC    X'80000000'             INPUT ERROR BIT SET ON IN 1      89100000
ZEROES   DC    D'0'                    ZEROES FOR COMPARE      @ZA32068 89400037
         DC    C'IGG019V3 OZ07621 03/05/76'  SIGHT INDICATOR   @ZA07621 89420037
         DC    CL8'&SYSDATE'                 SIGHT INDICATOR   @ZA07621 89440037
         DC    C'Z32068'                     SIGHT INDICATOR   @ZA07621 89460037
PATCH    DC    XL30'00',D'0'                 PATCH AREA        @ZA07621 89500037
         DCBD  DSORG=BS,DEVD=MR                                         89700000
*        MICBD - DUMMY SECTION FOR THE MICB                             89750000
MICBENTR DSECT                                                          89800000
MICBNEXT DS    A                                                        89850000
MICBECB  DS    A                                                        89900000
MICBFLAG DS    AL1                                                      89950000
MICBSENS DS    AL3                                                      90000000
MICBECBA DS    A                                                        90050000
MICBNM7  DS    A                                                        90100000
MICBNM1  DS    A                                                        90150000
MICBDATA DS    A                                                        90200000
         END                                                            90300000
./  ADD  SSI=61420003,NAME=IGG019V4
 TITLE   'IGG019V4 - 1419 AND 1275 CONTROL ROUTINE'                     00300000
IGG019V4 CSECT                                                          00600000
*                                                                       00900000
*                                                                       01200000
*STATUS  CHANGE LVL 000,  VERSION LVL 000,  MODIFICATION LVL 000        01500000
*                                                                       01800000
*        RELEASE 04.0 CHANGES                                  @ZA07621 01870003
*C933000                                                       @ZA07621 01940003
*                                                              @ZA07621 02010003
*FUNCTION - DISENGAGE AND POCKET LITE ROUTINES FOR 1419 AND 1275.       02100000
*        1- IF DISENGAGE IS REQUESTED THE ROUTINE SETS FLAGS IN THE     02400000
*           DCB SO THE PCI APPENDAGE CAN DISENGAGE THE DEVICE.          02700000
*        2- IF LITE IS REQUESTED THE ROUTINE:                           03000000
*           A- DETERMINES IF THE DEVICE IS DISENGAGED                   03300000
*           B- CHECKS THE TWO BYTE POCKET LITE BUCKET AREA TO           03600000
*              DETERMINE WHICH LIGHTS TO TURN ON                        03900000
*           C- STARTS THE CHANNEL PROGAM TO TURN THE LIGHTS ON.         04200000
*           D- CHECKS TO SEE THE CCW STRING EXECUTED SUCCESSFULLY.      04500000
*           E- IF AN ERROR OCCURRED BRANCH TO THE USER'S SYNAD          04800000
*              ROUTINE.  (IF NO SYNAD IS AVAILABLE AN ABEND IS ISSUED)  05100000
*ENTRY POINT - IGG019V4 FROM THE MACRO EXPANSION.                       05400000
*              AN EXAMPLE OF THE EXPANSION IS:                          05700000
*                BAL 1,*+12          LOAD ADDRESS OF PARAMETER LIST     06000000
*                DC  A(DCB)          DCB ADDRESS                        06300000
*                DC  A(LITE-BUCKET)  LITE-BUCKET ADDRESS                06600000
*                L  14,0(1,0)        LOAD DCB ADDRESS                   06900000
*                L  15,84(14,0)      LOAD ROUTINE ADDRESS               07200000
*                BALR 14,15 FOR LITE (BAL 14,4(15) FOR DESENGAGE)       07500000
*                                                                       07800000
*INPUT - DCB                                                            08100000
*         DCBMRIND - X'08' CONTROL ROUTINE ENTERED BIT SET ON           08400000
*         DCBIOBAD - PCU IOB ADDRESS                                    08700000
*         DCBSYNAD - SYNAD ROUTINE ADDRESS                              09000000
*        SCU IOB                                                        09300000
*         16(SCUIOBR) - SCU CCW STRING ADDRESS                          09600000
*         4(SCUIOBR) - SCU ECB ADDRESS                                  09900000
*        POCKET LITE BUCKET-                                            10200000
*         TWO BYTES SUPPLIED BY USER.  (CONTAINS BITS INDICATING        10500000
*         WHICH LITES ARE TO BE TURNED ON)                              10800000
*                                                                       11100000
*OUTPUT -DCB                                                            11400000
*         DCBMRFLG-X'30' - DISENGAGE REQUESTED BY USER                  11700000
*        POCKET LITE BUCKET-                                            12000000
*         BYTE 2, BIT 7 IS SET ON IF THE DEVICE IS NOT DISENGAGED       12300000
*         WHEN THE USER REQUESTS POCKET LIGHTS TO BE TURNED OR          12600000
*         IF AN ERROR OCCURRED IN THE CCW STRING TO TURN ON THE         12900000
*         LIGHTS.                                                       13200000
*        RETURN CODES                                                   13500000
*         X'00' - NORMAL COMPLETION-NO I/O ERRORS                       13800000
*         X'04' - I/O ERROR-SYNAD RETURNED TO CHECK                     14100000
*                                                                       14400000
*        LITE CCW STRING                                                14700000
*         THE COMMAND CODE CORRESPONDING TO THE POCKET LITE TO          15000000
*         BE TURNED ON IS OUTPUT FROM THE ROUTINE                       15300000
*                                                                       15600000
*EXTERNAL ROUTINES - EXCP (SVC 00)                                      15900000
*                    WAIT (SVC 01)                                      16200000
*                    EOV (SVC 55)                                       16500000
*                    USER'S SYNAD ROUTINE                               16800000
*                                                                       17100000
*EXITS NORMAL - RETURN TO USER VIA REGISTER 14                          17400000
*                                                                       17700000
*EXITS ERROR -  ABEND DUMP IF NO SYNAD ROUTINE IS SPECIFIED             18000000
*                                                                       18300000
*TABLES/WORK AREAS-- CALLERS SAVE AREA                                  18600000
*                  - POCKET LITE BUCKET (TWO BYTES)                     18900000
*                                                                       19200000
*ATTRIBUTES - REENTERABLE                                               19500000
*                                                                       19800000
*NOTES -  NONE                                                          20100000
*                                                                       20400000
*                                                                       20700000
*                                                                       21000000
*                                                                       21300000
*              SYMBOLIC DEFINITIONS OF REGISTERS                        21600000
*                                                                       21900000
ZEROR    EQU   0                                                        22200000
REG1     EQU   1                       WORK REGISTER                    22500000
PARMR    EQU   1                                                        22800000
DCBR     EQU   2                       DCB ADDRESS                      23100000
BCKETR   EQU   3                       POCKET LITE BUCKET ADDRESS       23400000
BASER    EQU   4                       BASE REGISTER                    23700000
PCKTR    EQU   5                       CONTAINS POCKET COMMAND CODE     24000000
EVENR    EQU   6                       REGS 6 & 7 ARE USED IN DETER-    24300000
ODDR     EQU   7                       MINING WHICH POCKET LITE         24600000
SAVER    EQU   13                      ADDRESS OF SAVE AREA             24900000
RETURNR  EQU   14                      RETURN ADDRESS                   25200000
SCUIOBR  EQU   14                      SCU IOB ADDRESS                  25500000
REG15    EQU   15                      WORK REGISTER                    25800000
ENTRYR   EQU   15                      ENTRY POINT ADDR AND RETRUN CODE 26100000
*                                                                       26400000
*              SYMBOLIC DEFINITIONS FOR DISPLACEMENTS                   26700000
*                                                                       27000000
BCKTADDR EQU   4                       DISP TO PCKT LITE BCKT ADDR      27300000
BCKTBYT1 EQU   1                       DISP TO PCKT LITE BYTE 1         27600000
CCWADDR  EQU   24                      DISP TO CCW ADDR IN IOB          27900000
DISP12   EQU   12                      DISP TO REG 14 SAVE AREA         28200000
DISP20   EQU   20                                                       28500000
DISP28   EQU   28                                                       28800000
DISP56   EQU   56                                                       29100000
IOBDISP  EQU   8                       DISP TO IOB FROM IOB PREFIX      29400000
IOBECB   EQU   4                       DISP TO ECB IN IOB               29700000
IOBECBAD EQU   12                      DISP TO ECB ADDR IN IOB          30000000
LITECC   EQU   8                       DISP TO CCW FOR LITE COMMAND CDE 30300000
LITECCW  EQU   136                     DISP FROM PCU CCW TO LITE CCW    30600000
RTNCDSP  EQU   16                      DISP TO STORE RETURN CODE        30900000
SCUIOB   EQU   48                      DISP FROM PCU IOB TO SCU IOB     31200000
UNITEXCP EQU   20                      DISP TO CSW IN IOB               31500000
ZEROD    EQU   0                       ZERO DISPLACEMENT                31800000
*                                                                       32100000
*              MISC DEFINITIONS                                         32400000
*                                                                       32700000
BITSAB   EQU   2                       SHIFT TO PROC BITS A & B LAST    33000000
DCBALTER EQU   X'10'                   DCB ALTERED--SET ON FOR CLOSE    33300000
ERBITOFF EQU   X'FE'                   SET ERROR BIT OFF                33600000
ERBITON  EQU   X'01'                   SET ERROR BIT ON                 33900000
EXCPISUD EQU   X'20'                                                    34200000
FOUR     EQU   4                                                        34500000
FRST6BTS EQU   X'04'                   FIRST 6 LITES PROCESSED          34800000
INITEXCP EQU   X'CF'                                                    35100000
LASTEXCP EQU   X'10'                   LAST EXCP INDICATOR              35400000
LFTJSTFY EQU   24                      SHIFT TO LEFT JUSTIFY            35700000
LST6BTS  EQU   6                       SHIFT FOR LAST SIX BITS          36000000
NOSYNAD  EQU   X'01'                   SYNAD ROUTINE PRESENT            36300000
SETLITE  EQU   X'F7'                   SET CC TO LITE COMMAND CODE      36600000
SETOFF   EQU   X'FE'                                                    36900000
SETON    EQU   X'0C'                   CONTROL RTN-LITES PRCSD BITS     37200000
SHFTOFF  EQU   4                       SHIFT OFF LOW-ORDER BITS         37500000
SHIFT12  EQU   12                      SHIFT ABEND COMPLETION CODE      37800000
TESTBIT  EQU   1                       TEST THIS BIT                    38100000
THREE    EQU   3                                                        38400000
USERDISN EQU   X'20'                   USER DISENGAGE BIT               38700000
X7FPSTD  EQU   X'7F'                   EVENT POSTED-SUCCESSFUL COMPLETE 39000000
*                                                                       39300000
*                                                                       39600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 39900000
*                                                                     * 40200000
* THIS BRANCH IS TAKEN WHEN LITE IS SPECIFIED IN THE MACRO EXPANSION  * 40500000
*                                                                     * 40800000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 41100000
         USING *,ENTRYR                ESTABLISH BASE REGISTER          41400000
         B     CNTL010                 BRANCH TO LITE ROUTINE           41700000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 42000000
*                                                                     * 42300000
* THE DISENGAGE ROUTINE SETS BITS IN THE DCBMRFLG SO THE PCI APPENDAGE* 42600000
* CAN ENGAGE THE DEVICE                                               * 42900000
*                                                                     * 43200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 43500000
         USING IHADCB,PARMR            ESTABLISH BASE REGISTER FOR DCB  43800000
         OI    DCBMRFLG,USERDISN       SET ON DISENGAGE BIT (USER)      44100000
         BR    RETURNR                 RETURN CONTROL TO USER           44400000
*                                                                       44700000
CNTL010  EQU   *                                                        45000000
*                                                                       45300000
         DROP  ENTRYR                                                   45600000
         DROP  PARMR                                                    45900000
         USING IHADCB,DCBR                                              46200000
         USING IGG019V4,BASER                                           46500000
         ST    RETURNR,DISP12(SAVER)   SAVE RETURN ADDR                 46800000
         STM   DCBR,ODDR,DISP28(SAVER)   SAVE USER REGS                 47100000
         LR    BASER,ENTRYR            ESTABLISH BASE REGISTER          47400000
         L     DCBR,ZEROD(PARMR)       ESTABLISH BASE REGISTER FOR DCB  47700000
         L     BCKETR,BCKTADDR(PARMR)  PICK UP POCKET LITE BUCKET ADDR  48000000
         NI    BCKTBYT1(BCKETR),ERBITOFF   SET POCKET ERROR BIT TO ZERO 48300000
         NI    DCBMRFG,INITEXCP        INITIALIZE EXCP INDICATOR BITS   48600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 48900000
*                                                                     * 49200000
* IF THE DEVICE HAS BEEN DISENGAGED EACH BIT CORRESPONDING TO A POCKET* 49500000
* IS TESTED TO DETERMINE IF THE POCKET LIGHT IS TO BE TURNED ON       * 49800000
*                                                                     * 50100000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 50400000
         OI    DCBMRIND,SETON          SET CNTRL RTN-LITE PRCSD BTS ON  50700000
         LH    PCKTR,PCKTCC            LOAD REG WITH PCKT COMMAND CODE  51000000
         SR    EVENR,EVENR             ZERO REGISTER                    51300000
         SR    ODDR,ODDR               ZERO REGISTER                    51600000
         IC    ODDR,ZEROD(BCKETR)      PICK UP 1ST BYTE OF LITE BUCKET  51900000
         IC    EVENR,BCKTBYT1(BCKETR)  PICK UP 2ND BYTE OF LITE BUCKET  52200000
         SRL   EVENR,SHFTOFF           SHIFT OFF LOW ORDER BITS-BYTE 2  52500000
         SLL   ODDR,LFTJSTFY           LEFT-JUSTIFY BYTE 1              52800000
         SLDL  EVENR,BITSAB            PUT POCKET LITE BITS A&B IN EVEN 53100000
*                                                                       53400000
CNTL020  EQU   *                                                        53700000
*                                                                       54000000
         LTR   ODDR,ODDR               IS THIS BIT ONE (ON)             54300000
         BM    CNTL060                 YES, BRANCH TO TURN ON LIGHT     54600000
*                                                                       54900000
CNTL030  EQU   *                                                        55200000
*                                                                       55500000
         TM    DCBMRIND,FRST6BTS       FIRST 6 LITE BITS PROCESSED      55800000
         BO    CNTL040                 NO, BRANCH                       56100000
         L     REG1,SCNDTST            LOAD TEST REG FOR LAST 6 BITS    56400000
         B     CNTL050                 BRANCH TO SHIFT FOR NEXT BIT     56700000
*                                                                       57000000
CNTL040  EQU   *                                                        57300000
*                                                                       57600000
         LH    REG1,FIRSTST            LOAD TEST REG FOR FIRST 6 BITS   57900000
*                                                                       58200000
CNTL050  EQU   *                                                        58500000
*                                                                       58800000
         TM    DCBMRFG,EXCPISUD        EXCP BEEN ISSUED                 59100000
         BZ    CNTL051                 NO, BRANCH TO SHIFT NEXT BIT     59400000
         XI    DCBMRFG,EXCPISUD        YES, SET OFF INDICATOR           59700000
         B     CNTL052                 SKIP THE SHIFT                   60000000
*                                                                       60300000
CNTL051  EQU   *                                                        60600000
*                                                                       60900000
         SLL   ODDR,TESTBIT            SHIFT TO TEST THE NEXT BIT       61200000
*                                                                       61500000
CNTL052  EQU   *                                                        61800000
*                                                                       62100000
         AH    PCKTR,NXTPCKT           UPDATE COMMAND CODE REGISTER     62400000
         CR    PCKTR,REG1              FIRST 6 BITS TESTED              62700000
         BNE   CNTL020                 NO, BRANCH TO TEST ANOTHER ONE   63000000
         CL    REG1,SCNDTST            HAVE ALL LIGHT BITS BEEN PROCD   63300000
         BE    CNTL080                 YES, BRANCH TO EXIT THIS ROUTINE 63600000
         XI    DCBMRIND,FRST6BTS       SET OFF FIRST 6 BITS INDICATOR   63900000
         SRDL  EVENR,LST6BTS           LAST 6 BITS IN ODD REG TO PROC   64200000
         B     CNTL020                 BRANCH TO TEST LAST 6 BITS       64500000
*                                                                       64800000
CNTL060  EQU   *                                                        65100000
*                                                                       65400000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 65700000
*                                                                     * 66000000
* THE FOLLOWING INSTRUCTIONS CAUSE THE LIGHTS TO BE TURNED ON         * 66300000
*                                                                     * 66600000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 66900000
         XI    DCBMRFG,EXCPISUD        SET ON EXCP ISSUED BIT           67200000
         SLL   ODDR,TESTBIT            SHIFT TO TEST THE NEXT BIT       67500000
         LTR   ODDR,ODDR               ANY MORE POCKET LITES TO LITE    67800000
         BC    7,CNTL061               YES, BRANCH                      68100000
         LTR   EVENR,EVENR             ANY MORE POCKET LITES TO LITE    68400000
         BC    7,CNTL061               YES, BRANCH                      68700000
         XI    DCBMRFG,LASTEXCP        NO, SET LAST EXCP INDICATOR      69000000
*                                                                       69300000
CNTL061  EQU   *                                                        69600000
*                                                                       69900000
         L     SCUIOBR,DCBIOBAD        PICK UP PCU IOB PREFIX ADDRESS   70200000
         L     REG15,CCWADDR(SCUIOBR)  PICK UP PCU CCW STRING ADDR      70500000
         LA    REG15,LITECCW(REG15)    COMPUTE LITE CCW STRING ADDR     70800000
         LA    SCUIOBR,SCUIOB(SCUIOBR) COMPUTE SCU IOB PREFIX ADDRESS   71100000
         ST    REG15,CCWADDR(SCUIOBR)  PUT CCW ADDR IN SCU IOB          71400000
         STC   PCKTR,LITECC(REG15)     PUT COMMAND CODE IN CCW STRING   71700000
         NI    LITECC(REG15),SETLITE   SET OFF BATCH NUMBER UPDATE BIT  72000000
         XC    IOBECB(FOUR,SCUIOBR),IOBECB(SCUIOBR)  ZERO SCU IOB ECB   72300000
         LA    PARMR,IOBDISP(SCUIOBR)  COMPUTE SCU IOB ADDRESS          72600000
         EXCP  (1)                                                      72900000
         L     SCUIOBR,DCBIOBAD        PICK UP PCU IOB ADDRESS          73200000
         LA    SCUIOBR,SCUIOB(SCUIOBR) COMPUTE SCU IOB ADDRESS          73500000
         L     PARMR,IOBECBAD(SCUIOBR) LOAD ECB ADDR                    73800000
         WAIT  1,ECB=(1)                                                74100000
         L     SCUIOBR,DCBIOBAD        LOAD SCUIOB PREFIX ADDR          74400000
         LA    SCUIOBR,SCUIOB(SCUIOBR)   COMPUTE SCU IOB ADDR           74700000
         CLI   IOBECB(SCUIOBR),X7FPSTD EVENT SUCCESSFULLY COMPLETED     75000000
         BE    CNTL030                 YES, TEST THE NEXT BIT           75300000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 75600000
*                                                                     * 75900000
* IF AN ERROR OCCURS IN THE I/O OPERATION TO CAUSE THE LIGHT TO BE    * 76200000
* TURNED ON THE USER'S SYNAD ROUTINE IS BRANCHED TO.  IF THERE IS     * 76500000
* NO SYNAD ROUTINE THE JOB IS TERMINATED VIA EOV (SVC 55).            * 76800000
*                                                                     * 77100000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 77400000
         OI    BCKTBYT1(BCKETR),ERBITON    NO, SET ERROR BIT ON         77700000
         TM    DCBSYNAD+THREE,NOSYNAD  SYNAD ROUTINE PRESENT            78000000
         BZ    CNTL070                 YES, BRANCH                      78300000
         LA    ZEROR,NOSYNAD           SET UP REG FOR ABEND - NO SYNAD  78500000
         SLL   ZEROR,SHIFT12           SHIFT ABEND CODE 12 BITS FOR EOV 78700000
         NI    UNITEXCP(SCUIOBR),SETOFF   SET OFF UNIT EXCEPTION BIT    78900000
         EOV   (2)                                                      79200000
*                                                                       79500000
CNTL070  EQU   *                                                        79800000
*                                                                       80100000
         OI    DCBMRIND,DCBALTER       SET BIT ON TO SHOW DCB ALTERED   80400000
         ST    SCUIOBR,DCBIOBAD        STORE SCUIOB PREFIX ADDR IN DCB  80700000
         LR    PARMR,DCBR              SET UP PARAMETERS                81000000
         SR    ZEROR,ZEROR             FOR SYNAD                        81300000
         L     REG15,CNTRLBIT          LOAD CONTROL BIT FOR REG 1       81600000
         LA    PARMR,ZEROD(PARMR)      CLEAR HIGH-ORDER BYTE            81900000
         AR    PARMR,REG15             SET ON CONTROL BIT FOR SYNAD     82200000
         L     ENTRYR,DCBSYNAD         PICK UP SYNAD ADDRESS            82500000
         STM   DCBR,BCKETR,DISP20(SAVER)   SAVE REGS 2-3                82800000
         STM   BASER,ODDR,DISP56(SAVER)    SAVE REGS 4-7                83100000
         LM    DCBR,ODDR,DISP28(SAVER)     LOAD USER REGS               83400000
         BALR  RETURNR,ENTRYR          BRANC TO SYNAD ROUTINE           83700000
         STM   DCBR,ODDR,DISP28(SAVER)     SAVE USER REGS               84000000
         LM    DCBR,BCKETR,DISP20(SAVER)   LOAD REGS 2-3                84300000
         LM    BASER,ODDR,DISP56(SAVER)    LOAD REGS 4-7                84600000
         NI    BCKTBYT1(BCKETR),ERBITOFF   SET POCKET ERROR BIT TO ZERO 84900000
         LA    REG1,SCUIOB             LOAD DISP FROM PCU TO SCU IOB    85200000
         L     SCUIOBR,DCBIOBAD        LOAD SCU IOB PREFIX ADDR         85500000
         SR    SCUIOBR,REG1            COMPUTE PCU IOB PREFIX ADDR      85800000
         ST    SCUIOBR,DCBIOBAD        RESTORE DCB PCU IOB PREFIX ADDR  86100000
         XI    DCBMRIND,DCBALTER       SET BIT OFF TO SHOW DCB RESTORED 86400000
         LA    REG15,FOUR              LOAD RETURN CODE                 86700000
         ST    REG15,RTNCDSP(SAVER)    SET RETURN CODE                  87000000
         B     CNTL030                 BRANCH TO TEST THE NEXT BIT      87300000
*                                                                       87600000
CNTL080  EQU   *                                                        87900000
*                                                                       88200000
         LA    ENTRYR,FOUR             LOAD I/O ERROR RETURN CODE       88500000
         CL    ENTRYR,RTNCDSP(SAVER)   RETURN CODE POSTED               88800000
         BE    CNTL090                 YES, BRANCH                      89100000
         SR    ENTRYR,ENTRYR                                            89400000
         ST    ENTRYR,RTNCDSP(SAVER)   SET RETURN CODE                  89700000
*                                                                       90000000
CNTL090  EQU   *                                                        90300000
*                                                                       90600000
         LM    RETURNR,ODDR,DISP12(SAVER)   LOAD USER REGS              90900000
         BR    RETURNR                 RETURN TO USER                   91200000
         DS    0F                                                       91500000
CNTRLBIT DC    X'20000000'             SET THIS BIT IN REG 1 FOR SYNAD  91800000
SCNDTST  DC    XL4'000000CF'           USED TO FIND LAST BIT TO PROC    92100000
FIRSTST  DC    XL2'006F'               FIRST 6 BITS PROCESSED           92400000
PCKTCC   DC    XL2'000F'               INITIAL POCKET COMMAND CODE      92700000
NXTPCKT  DC    XL2'0010'               NEXT POCKET LITE COMMAND CODE    93000000
         DC    C'IGG019V4 ZA07621 02/20/76/'  SIGHT INDICATOR  @ZA07621 93300003
         DC    CL8'&SYSDATE'                  SIGHT INDICATOR  @ZA07621 94300003
         DC    C'Z07621'                      SIGHT INDICATOR  @ZA07621 95300003
PATCH    DC    XL30'00',D'0'                  PATCH AREA       @ZA07621 96300003
         DCBD  DSORG=BS,DEVD=MR                                         97300003
         END                                                            98300003
./  ADD  SSI=81990251,NAME=IGG019V5
         TITLE 'IGG019V5 - 1419 APPENDAGES'                             00060002
IGG019V5 CSECT                                                          00060402
         SPACE                                                          00060802
*********************************************************************** 00100021
*                                                                     * 00180002
* MODULE NAME - IGG019V5                                              * 00180402
*                                                              @ZA06120 00180537
* ALIAS - IGG019V7                                             @ZA06120 00180637
*                                                                     * 00180802
* DESCRIPTIVE NAME - 1419 APPENDAGES                                  * 00181202
*                                                                     * 00181602
* COPYRIGHT - NONE                                                    * 00182002
*                                                                     * 00182402
* CHANGE ACTIVITY - AS FOLLOWS:                                       * 00182802
*                                                                     * 00183202
*          RELEASE 21 DELETIONS                                       * 00183602
*1022                                                            A46398 00184002
*1022                                                            A46625 00184402
*1022                                                            A41426 00184802
*1022                                                            A43711 00185202
*1022253200                                                      A43224 00185602
*1022001200                                                      A42476 00186002
*A525700                                                         A33935 00186402
*A829800                                                         A39662 00186802
*C717000                                                         A39662 00187202
*A270100-270400,525200-526000,528040-529120,845500-845800        A33924 00187602
*C913200                                                         A33924 00188002
*D525600,528600                                                  A33924 00188402
*                                                               SA60294 00188502
*                                                                     * 00188702
*          VS1 RELEASE 03 DELETIONS                                   * 00188802
*                                                       SA58043/OX01515 00188902
*                                                                     * 00189002
*          VS2 RELEASE 02 DELETIONS                                   * 00189202
*D065400-067200,072600-074400,076800-077400,079200,092400-093000,Y02072 00189302
*D126600-127800,177600-183600,186000-186600,201600-243000,249000-Y02072 00189402
*D249600,251400,254400-255000,256200,259800-261400,280200-283200,Y02072 00189502
*D284400-285900,288000,289800,291600,304800,313200,316800,318000-Y02072 00189602
*D320400,321600-324000,373800,375000-376200,377400,383400-384000,Y02072 00189702
*D386400,423600-426000,427200,431400-432000,433200,454200,457800,Y02072 00189802
*D473400,474600,475410,492580-492588,492596,498000-499200,500400,Y02072 00189902
*D502800-503400,520800,522600,533400-534600,535800,540600,546600,Y02072 00190002
*D550800,573600,574800-576000,580200,592800,601800,606600-609000,Y02072 00190102
*D622800,624600,672600-673800,675000,676200,679800,681400,697200-Y02072 00190202
*D699600,700800,734400-736800,756600-757800,758400,765110-889200,Y02072 00190302
*D901200,904200-912000,915600,916800-931200                      Y02072 00190402
*                                                                     * 00191202
*                                                                     * 00191602
* STATUS - VS2 RELEASE 2 LEVEL 0                                      * 00192002
*        VS2 REL 3.0 CHANGES                                            00192202
* A491300,856100                                               @ZA02230 00192302
*A765232-765312                                                @ZA07205 00202337
*                                                                     * 00216202
*        VS2 REL 3.7 CHANGES                                   @ZA07621 00218237
*C912840                                                       @ZA07621 00220237
*C770486-770492,771900-772100,773300-773600,773900-774900      @ZA07621 00222237
*C775200                                                       @ZA07621 00223237
*A913841-913870                                                @ZA07621 00224237
*A289257-289260                                                @ZA09994 00225237
*C636940                                                       @ZA09994 00226237
*A289257-289260                                                @ZA09992 00227137
*C901830                                                        ZA11089 00227637
*C773400                                                       @ZA14595 00228137
*C729000,C913110                                               @ZA14706 00233137
*C726450,A076275,A726000-726420                                @ZA26121 00236137
*C523676,A523340-523656                                        @ZA33065 00237137
*C342500,A342000-342300                                        @ZA33842 00238137
* FUNCTION/OPERATION -                                                * 00240002
*              THE APPENDAGES CONTAINED HEREIN MONITOR THE I/O        * 00300002
*              OPERATIONS OF THE 1419 MAGNETIC INK CHARACTER READER.  * 00360002
*              THE MAIN FUNCTION OF EACH APPENDAGE IS AS FOLLOWS:     * 00420002
*                                                                     * 00480002
***************************************************************@ZA06120 00488037
*                                                              @ZA06120 00496037
* NOTE  ***   THE PCI APPENDAGE IS NOW LOADED BY THE ALIAS OF  @ZA06120 00504037
*             IGG019V7 TO SEIALIAZE WHEN IN AN MP ENVIRONMENT  @ZA06120 00512037
*                                                              @ZA06120 00520037
*                                                              @ZA06120 00528037
*              1. PCI APPENDAGE-                                      * 00540002
*                                                                     * 00600002
*                   THIS ROUTINE HANDLES NORMAL POSTING OF BUFFERS    * 00660002
*                   AND THE UPDATING OF DATA ADDRESSES IN BOTH THE    * 00720002
*                   PCU AND SCU CCW STRINGS.  IT LINKS TO (OR SCHED-  * 00780002
*                   ULES THE USERS STACKER SELECT ROUTINE AND PLUGS   * 00840002
*                   THE RETURNED COMMAND INTO THE SCU CCW STRING.     * 00900002
*                                                                     * 00960002
*              2. ABNORMAL END APPENDAGE-                             * 01020002
*                                                                     * 01080002
*                   THIS ROUTINE HANDLES UNIT CHECK CONDITIONS        * 01140002
*                   OCCURING ON EITHER THE PCU OR SCU.  IT SETS       * 01200002
*                   ERROR INDICATIONS IN THE BUFFERS AND POSTS        * 01260002
*                   I/O  OPERATIONS IN THE MICB ECB.                  * 01320002
*                                                                     * 01380002
*              3. CHANNEL END APPENDAGE-                              * 01440002
*                                                                     * 01500002
*                   THIS ROUTINE HANDLES CHANNEL END CONDITIONS       * 01560002
*                   ON THE SCU  AND CHANNEL END OR UNIT EXCEPTION     * 01620002
*                   ON THE PCU.  BUFFER STATUS INDICATORS ARE SET     * 01680002
*                   AND POSTING IS DONE IN THE MICB ECBS.             * 01740002
*                                                                     * 01800002
*                                                                     * 01860002
* ENTRY POINTS - THE FOLLOWING FOUR ENTRY POINTS ARE USED:            * 01980002
*                                                                     * 02040002
*              1. PCIAPEN-                                            * 02220002
*                                                                     * 02280002
*                   THIS IS THE ENTRY POINT FOR THE PCI APPENDAGE.    * 02340002
*                   IT IS LINKED TO FROM IOS WHEN A PROGRAM CONTROLED * 02400002
*                   INTERRUPT OCCURS ON THE SCU CHANNEL PROGRAM.      * 02460002
*                                                                     * 02520002
*              2. ABNEND-                                             * 02580002
*                                                                     * 02640002
*                   THIS IS THE ENTRY POINT FOR THE ABNORMAL END      * 02700002
*                   APPENDAGE.  IT IS LINKED TO FROM IOS WHEN UNIT    * 02760002
*                   CHECK OR CHANNEL ERRORS OCCUR ON THE PCU OR SCU   * 02820002
*                                                                     * 02880002
*              3. CHANEND-                                            * 02940002
*                                                                     * 03000002
*                   THIS IS THE ENTRY POINT FOR THE CHANNEL END       * 03060002
*                   APPENDAGE.  IT IS LINKED TO FROM IOS WHEN         * 03120002
*                   CHANNEL END OR UNIT EXCEPTION OCCUR.              * 03180002
*                                                                     * 03600002
*                                                                     * 03660002
* INPUT -                                                             * 03780002
*                                                                     * 03840002
*              FOLLOWING IS THE INPUT TO THE APPENDAGES:              * 03900002
*                                                                     * 03960002
*                   GR1 CONTAINS THE ADDR OF THE REQUEST ELEMENT      * 04020002
*                   GR2 CONTAINS THE ADDR OF THE IOB                  * 04080002
*                   GR3 CONTAINS THE ADDR OF THE DEB                  * 04140002
*                   GR4 CONTAINS THE ADDR OF THE DCB                  * 04200002
*                   GR7 CONTAINS THE ADDR OF THE UCB                  * 04260002
*                   GR14 CONTAINS THE RETURN ADDR OF IOS              * 04320002
*                   GR15 CONTAINS THE ENTRY POINT ADDR                * 04380002
*                                                                     * 04800002
*                                                                     * 04860002
* OUTPUT -                                                            * 04980002
*              BUFFER STATUS INDICATORS ARE SET AND I/O OPERATIONS    * 05040002
*              ARE POSTED IN THE MICB ECBS.                           * 05100002
*                                                                     * 05160002
*                                                                     * 05220002
* EXTERNAL ROUTINES - THE USERS SS ROUTINE.                           * 05340002
*                                                                     * 05400002
*                                                                     * 05460002
* EXITS-NORMAL - RETURNS TO EXCP VIA A BR 14                          * 05640002
*                                                                     * 05700002
* EXITS-ERROR - NONE                                                  * 05760002
*                                                                     * 05820002
*                                                                     * 05820402
* TABLES/WORK AREAS - NONE                                            * 05820802
*                                                                     * 05821202
*                                                                     * 05821602
* MACROS-ACTION - MODESET, SETLOCK, PCIPOST, IOSGEN                   * 05822002
*                                                                     * 05822402
* MACROS-MAPPING - IHAASVT, CVT, DCBD, IEZIOB, IECDIOCM, IECDIOSB,    * 05822802
*                  IECDRQE, IHASRB, IEFUCBOB                          * 05823037
*                                                                     * 05823402
*                                                                     * 05823602
* ATTRIBUTES - SERIALLY REUSABLE, SUPERVISOR STATE, NORMALLY RUNS IN  * 05824002
*              THE USER'S KEY.                                        * 05824102
*                                                                     * 05824402
*********************************************************************** 05880000
         EJECT                                                          05940000
*********************************************************************** 06060002
*   REGISTER EQUATES                                                    06120002
*********************************************************************** 06180002
*                                                                       06180402
R0       EQU   0                       REGISTER 0                Y02072 06182002
ZERO     EQU   R0                      PARM REG                         06184002
PARM1    EQU   1                       PARM REG                         06186002
RQEREG   EQU   PARM1                   ADDR OF RQE                      06300002
PARM2    EQU   2                       PARM REG                         06302002
IOBREG   EQU   PARM2                   ADDR OF IOB                      06360002
DEBREG   EQU   3                       ADDR OF DEB                      06420002
DCBREG   EQU   4                       ADDR OF DCB                      06480002
GR5      EQU   5                       WORK REGISTER                    06780002
RWRK1    EQU   GR5                     WORK REGISTER             Y02072 06782002
RMICB    EQU   RWRK1                   PTR TO MICB CONTAINING    Y02072 06784002
*                                      ECB TO BE POSTED          Y02072 06786002
GR6      EQU   6                       WORK REGISTER                    06840002
GR7      EQU   7                       WORK REGISTER                    06900002
RUCB     EQU   GR7                     UCB ADDRESS               Y02072 06900402
CMICB    EQU   RUCB                    ADDR CURRENT MICB                06902002
GR8      EQU   8                       WORK REGISTER                    06960002
RTCB     EQU   GR8                     TCB ADDRESS               Y02072 06962002
CCWREG   EQU   RTCB                    ADDR CCW STRING                  06964002
GR9      EQU   9                       WORK REG                         07020002
GR10     EQU   10                      WORK REG                         07080002
CCREG    EQU   GR10                    COMPLETION CODE REGISTER         07140002
ECBADR   EQU   11                      ADDR ECB TO BE POSTED            07200002
BAS3     EQU   ECBADR                  BASE FOR SCHEDULED ROUTINE       07500002
GR12     EQU   12                      TCB ADDR FOR POST                07502002
BA12     EQU   GR12                    BASE REG                         07504002
R13      EQU   13                      WORK REGISTER             Y02072 07504402
SAVREG   EQU   R13                     ADDR SAVE AREA                   07506002
RTRNREG  EQU   14                      RETURN REGISTER                  07508002
R15      EQU   15                      REGISTER 15               Y02072 07510002
BASE     EQU   R15                     BASE REGISTER                    07512002
BRANREG  EQU   BASE                    BRANCH REGISTER                  07560002
         EJECT                                                          07561002
*********************************************************************** 07562002
*   MASKS, DISPLACEMENTS, AND OTHER EQUATES                             07563002
*********************************************************************** 07564002
*                                                                       07565002
*   FOLLOWING ARE EQUATES FOR MASKS AND IMMEDIATE DATA                  07567002
*                                                                       07568002
LITEL    EQU   X'10'                   TO SEE IF ITS LAST LITE          07569002
OFFLITE  EQU   X'EF'                   TO TURN OFF LIGHT SW             07570002
UCHKCHND EQU   X'0A'                   MASK FOR TESTING UNIT CHECK AND  07571002
*                                      CHANNEL  END                     07572002
ALL      EQU   X'FF'                                                    07572537
XFF      EQU   X'FF'                                                    07573002
REJOFF   EQU   X'7F'                   TO TURN OFF COMMAND REJECT       07575002
BADCOMI  EQU   X'08'                   TO INDICATE USER HAS ISSUED      07576002
*                                      REJECT COMMAND                   07577002
BADOFF   EQU   X'F7'                   TO TURN OFF BADCOMI              07578002
CHANER   EQU   X'0F'                   MASK FOR TESTING CHANNEL ERRORS  07579002
SIT0     EQU   X'0F'                   MASK FOR TESTING WHATS           07580002
*                                      HAPPENING IN THE APPENDAGES      07581002
NOP      EQU   X'03'                   NO-OP COMMAND                    07582002
ST2OR3   EQU   X'08'                   TEST FOR STRING 2 OR 3 ON PCU    07583002
ST1      EQU   X'04'                   FOR TESTING STRING 1 BIT         07584002
MSENS    EQU   X'24'                   MOD SENSE COMMAND CODE           07585002
OVERRUN  EQU   X'40'                   FOR TESTING IF BUFFER OVERRUN    07586002
*                                      IS IMMINENT                      07587002
DISENG   EQU   X'DF'                   DISENGAGE COMMAND                07588002
CHAINOFF EQU   X'BF'                   TO TURN OFF COMMAND CHAINING     07589002
CHAINON  EQU   X'40'                   TO TURN ON COMMAND CHAINING      07590002
INITIAL  EQU   X'10'                   TO SEE IF ENGAGE JUST ISSUED     07591002
LATESS   EQU   X'04'                   FOR CHECKING LATE  SS            07592002
COMRLTSS EQU   X'84'                   COMMAND REJECT - LATE SS  A39662 07593002
SETLTSS  EQU   X'20'                   FOR SETTING LATE SS IN BUFFER    07594002
X02      EQU   X'02'                   TO INDICATE ERP IS EXECUTING     07595002
X01      EQU   X'01'                   TO INDICATE SCU ERP EXECUTING    07596002
PCURR    EQU   X'80'                   TO INDICATE POST CURRENT         07598002
PCURRP1  EQU   X'40'                   TO INDICATE POST CURR+1          07599002
XFD      EQU   X'FD'                   TO TURN OFF X02                  07600002
X7F      EQU   X'7F'                   TO TURN OFF PCURR                07601002
XBF      EQU   X'BF'                   TO TURN OFF PCURRP1              07602002
XFE      EQU   X'FE'                   TO TURN OFF X01                  07603002
AUTSEL   EQU   X'02'                   FOR CHECKING AUTO SELECT BIT     07604002
SETAUTS  EQU   X'80'                   FOR SETTING AUTO SEL IN BUFFER   07605002
WAIT     EQU   X'80'                   TO CHECK WAIT BIT IN ECB         07606002
ZBIT2    EQU   X'DF'                   FOR ZEROING DOC UNDER READ       07607002
OFFERR   EQU   X'DF'                   TO TURN OFF UNRECOV              07607202
*                                      HEAD BIT                         07608002
ONBIT4   EQU   X'08'                   FOR TURNING ON BIT4 OF DCBMRFLG  07609002
OFFBIT5  EQU   X'FB'                   FOR TURNING OFF BIT5             07610002
ONBIT5   EQU   X'04'                   TO TURN ON BIT5                  07611002
OFFBIT4  EQU   X'F7'                   TO TURN OFF BIT4                 07612002
BATCH    EQU   X'80'                   TO TEST FOR BATCH NO. UPDATE     07613002
PCUABEND EQU   X'AB'                   TO TEST 'WHICH'  SWITCH          07615002
SSC0     EQU   X'0B'                   SS IND FOR POCKET 0 2ND   A33924 07616002
*                                      GROUP                     A33924 07617002
CSS0     EQU   X'DB'                   SS CMD FOR POCKET 0 2ND   A33924 07618002
*                                      GROUP                     A33924 07619002
UC       EQU   X'02'                   MASK FOR UNIT CHECK       A33924 07620002
PCIINCTL EQU   X'01'                   TO SET  'WHICH'  SWITCH          07622002
SETO5    EQU   X'A0'                   TO SET BUFFER COUNTER            07623002
INVALC   EQU   X'FF'                   TO FORCE COMMAND REJECT          07624002
MREAD    EQU   X'4C'                   MREAD BACKWARDS COMMAND          07625002
CMRJBOC  EQU   X'A1'                   TO TEST COM REJ,BOC,AND OP ATT   07626002
UNRECOV  EQU   X'20'                   TO SET UNRECOV I/O ERROR         07627002
INTREQ   EQU   X'40'                   INTERVENTION REQUIRED   @ZA26121 07627537
INTVR    EQU   X'41'                   MASK TO TEST INTVR REQ/OPR ATTN  07628002
OPATTN   EQU   X'01'                   MASK TO TEST SENS FOR OPR ATTN   07629002
SCUAB    EQU   X'BB'                   TO SAY SCU ABEND GOING           07630002
IR       EQU   X'08'                   TO SET INTV REQ BIT IN BUFFER    07631002
XF0      EQU   X'F0'                   FOR TESTING IF SCU HAS BROKEN    07632002
SITF     EQU   X'0F'                   FOR SETTING SITUATION F          07633002
SIT2     EQU   X'02'                   FOR SETTING SITUATION 2          07634002
CC3      EQU   X'70'                   FOR CHECKING CC=3                07635002
UEX      EQU   X'10'                   FOR SETTING UNIT EXCEPTION BIT   07636002
UNITEX   EQU   X'04'                    UNIT EX IN MICB        @ZA02230 07636102
UNITE    EQU   X'01'                   UNIT EXCEPTION IN CSW            07636402
SIT3     EQU   X'03'                   FOR SETTING SITUATION 3          07637002
PCUCE    EQU   X'F0'                   TO SAY PCU C.E. APPEN IS EXCTNG  07638002
SCUCE    EQU   X'F1'                   TO SAY SCU C.E. APPEN IS EXCTNG  07638437
NVAL     EQU   X'F7'                   FOR REMOVING BIT4 IN SS COMM     07639002
PCIMISD  EQU   X'04'                   TO INDICATE PCI MISSED           07640002
BDTCE    EQU   X'40'                   TO SAY BROKEN DUE TO CHAN END    07642002
COMREJ   EQU   X'80'                   FOR TESTING COMMAND REJ ON SCU   07643002
LLS      EQU   X'04'                   MASK TO SET ON LATE SS SENSE     07644002
CPCHECK  EQU   X'20'                   TO TEST CSW FOR PROGRAM CHECK    07645002
TURNOFF  EQU   X'EF'                   TO TURN OFF INITIAL BIT          07646002
XREJCOM  EQU   X'CF'                   REJECT POCKET                    07647002
BDTUC    EQU   X'20'                   USED TO INDICATE IN DCBAPPIN     07648002
*                                      THAT THE SCU HAS BROKEN DUE      07649002
*                                      TO UNIT CHECK.                   07650002
BDTLTPCI EQU   X'80'                   USED TO SET DCBAPPIN TO          07651002
*                                      INDICATE THE SCU HAS             07652002
*                                      BROKEN DUE TO LATE PCI.          07653002
PCIENTRY EQU   X'01'                                              41426 07654002
SIOENTRY EQU   X'02'                   SIGNAL FOR START I/O ENTRY 41426 07655002
IPPCCIC  EQU   X'7F'                   TO TEST ERRORS IN CSW            07657102
ASC      EQU   X'E0'                   TO TEST ATTENTION,S MOD,CU END   07657302
SIT5     EQU   X'05'                   SITUATION 5 INDICATOR            07657402
TIC      EQU   X'08'                   TIC COMMAND CODE                 07657602
WRDELAY  EQU   X'E1'                   WRITE DELAY COMMAND CODE SA60294 07657702
OFF      EQU   X'FF'                   USED TO TURN OFF BITS     Y02072 07657802
EXIT     EQU   3                       SVC NO. FOR LEAVING SS ROUTINE   07657902
*                                                                       07663837
*                                                                       07666037
*   DISPLACEMENT EQUATES                                                07668237
*                                                                       07670437
*     FOR MICB -                                                        07672637
*                                                                       07674837
MICBNEXT EQU   0                       ADDR  OF NEXT MICB               07677037
MICBECB  EQU   4                       EMBEDDED EVENT CONTROL BLOCK     07679237
MICBFLAG EQU   8                       FLAG  BITS                       07681437
MICBSENS EQU   9                       SENSE INFORMATION                07683637
MICBECBA EQU   12                      ADDR OF ECB                      07685837
MICBNM1  EQU   20                      ADDR OF CURRENT - 1              07688037
MICBDATA EQU   24                      ADDR OF BUFFER                   07690237
*                                                                       07692437
*                                                                       07694637
*      FOR DEB -                                                        07696837
*                                                                       07699037
DEBTCBAD EQU   0                       ADDR OF TCB                      07701237
DEBUCBAD EQU   32                      DISP TO UCB ADDR                 07703437
DEBSSAD  EQU   44                      ADDR OF THE USER'S SS RTN Y02072 07705637
*                                                                       07707837
*                                                                       07710037
*   FOLLOWING ARE EQUATES FOR VARIOUS DISPLACEMENTS AND LENGTHS         07712237
*                                                                       07714437
ONE      EQU   1                       DISP OF 1                        07716637
FOUR     EQU   4                       BRANCH DISPLACEMENT              07718837
INDLEN   EQU   10                      LENGTH OF BUFFER STATUS          07721037
SEVEN    EQU   15                      FOR LENGTH IN MOVE               07723237
EIGHT    EQU   8                       DISP OF 8                        07725437
TWEN4    EQU   24                      DISP OF 24                       07727637
FORTY    EQU   40                      DISP OF 40                       07729837
SIX4     EQU   64                      DISP OF 64                       07732037
FIVE     EQU   5                       DISP OF 5                        07734237
TWEN8    EQU   28                      DISP OF 28                       07736437
THREE    EQU   3                       DISP OF 3                        07738637
FOUR8    EQU   48                      DISP OF 48                A46625 07740837
TWO      EQU   2                       DISP OF 2                        07743037
SIXTEEN  EQU   16                      DISP OF  16                      07745237
THIR2    EQU   32                      DISP OF 32                       07747437
SS1DIS   EQU   16                      DISP TO FIRST SS COMMAND IN THE  07749637
*                                      SCU CHAIN                        07751837
SS2DIS   EQU   40                      DISP TO  2ND  SS COMMAND         07754037
CCWD     EQU   24                      DISP OF CCW ADDR IN IOB          07756237
IOBLN    EQU   48                      LENGTH OF PCU OR SCU IOB         07758437
XPCLEN   EQU   80                      LEN OF PCU CHAIN                 07760637
ZER0     EQU   0                                                        07762837
SCUSTRNG EQU   24                      DISP OF CCW ADDR IN IOB          07765037
STRNGLEN EQU   24                      LENGTH OF EACH PCU STRING        07767237
MSDIS    EQU   16                      DISP TO MSENS IN EACH STRING     07769437
MRDIS    EQU   8                       DISP TO MREAD IN EACH STRING     07771637
NOPDIS   EQU   0                       DISP TO NOP IN   EACH STRING     07773837
OFFREG1  EQU   4                       OFFSET TO REG 1 IN SA     Y02072 07776037
OFFREG12 EQU   48                      OFFSET TO REG 12 IN SA    Y02072 07778237
OFFREG13 EQU   52                      OFFSET TO REG 13 IN SA    Y02072 07780437
OFFREG14 EQU   56                      OFFSET TO REG 14 IN SA    Y02072 07782637
TABLE    EQU   8                       TABLE OFFSET FROM INDEX    41426 07784837
WORKA    EQU   7                                                  41426 07787037
TRCEDSP  EQU   168                     OFFSET OF TRACE TBL FR IOB 41426 07789237
TTPTR    EQU   6                                                  41426 07791437
WORKB    EQU   10                                                 41426 07793637
TRACRET  EQU   11                                                 41426 07795837
         EJECT                                                          07798002
CHANEND  B     CHANDIS(BASE)           GO TO CHANNEL END HANDLER        07800002
ABNEND   B     ABNDIS(BASE)            GO TO ABNORMAL END HANDLER       07860002
SIOENTER B     SIODIS(BASE)            START I/O APPENDAGE        41426 07950002
*                                                                       07952002
PCIAPEN  EQU   *                       START OF PCI INTERRUPT HANDLER   07980002
         USING *,BA12                  ESTABLISH ADDRESSABILITY         08042037
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 08052037
         USING IHADCB,DCBREG           ESTABLISH DCB BASE REG    Y02072 08062037
         USING IOBSTDRD,IOBREG         ESTABLISH IOB BASE REG    Y02072 08072037
*                                                                       08100000
*********************************************************************** 08160000
*   THE PCI APPENDAGE IS ENTERED WHENEVER A PROGRAM CONTROLLED          08220002
*   INTERRUPT OCCURS ON THE SCU COMMAND CHAIN.  THE PCI BIT IS ON IN    08280002
*   BOTH WRITE DELAY COMMANDS IN THE SCU CHAIN.  WHEN FUNCTIONING       08340002
*   NORMALLY, A PCI INTERRUPT SHOULD OCCUR SHORTLY AFTER THE CHANNEL    08400002
*   STARTS EXECUTING A WRITE DELAY COMMAND.  THE APPENDAGE GETS CONTROL 08460002
*   AND PERFORMS NECESSARY HOUSEKEEPING THEN LINKS TO THE USER'S        08520002
*   STACKER SELECT ROUTINE SO THAT A POCKET MAY BE DETERMINED FOR THE   08580002
*   DOCUMENT JUST READ.  THE USER LINKS BACK TO THE APPENDAGE WHICH     08640002
*   THEN PLUGS THE CHOSEN SS COMMAND CODE INTO THE NOP COMMAND          08700002
*   IMMEDIATELY FOLLOWING THE WRITE DELAY WHICH CAUSED THE INTERRUPT.   08760002
*   THE DOCUMENT WILL THEN BE SELECTED INTO THE POCKET CHOSEN BY THE    08820002
*   USER.                                                               08880002
*********************************************************************** 09060000
*                                                                       09062002
         LR    BA12,BASE                                                09120037
         STM   ZERO,BASE,KRESAV        SAVE REGISTERS                   09170037
         MVI   WHAT,PCIENTRY           SET SWITCH FOR TRACE      Y02072 09220037
         MVI   WHICH,PCIINCTL          IND PCI APPEN EXECUTING @ZA07621 09240037
         BAL   TRACRET,TRACE           ENTER TRACE               Y02072 09270037
*                                                                       09320037
         L     GR8,IOBCMDA-1           GET COMMAND ADDRESS       Y02072 09370037
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDRESS@ZA06142 09420037
         CLI   ZERO(GR8),MREAD         READ COMMAND, QQ                 09480002
         BNE   WRNGCOM                 NO, PCI ON WRONG COMMAND         09540002
         MVI   ZERO(GR8),NOP           NOP INVALID COMMAND              09600002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 09602002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 09902002
         L     CCWREG,IOBSTART         GET ADDR SCU CCW CHAIN    Y02072 09960002
         L     GR6,DCBIOBAD            GET PCU IOB ADDR                 10080002
         L     GR5,CCWD(GR6)           GET ADDR PCU CCW CHAIN           10140002
         LR    GR10,GR5                SAVE ADDR PCU CHAIN              10200002
         TM    DCBMRFLG,ST2OR3         ARE WE IN STRING 2 OR 3,QQ       10260002
         BZ    ST1005                  NO, DONT BUMP POINTER            10320002
         TM    DCBMRFLG,ST1            IS IT STRING 3                   10380002
         BZ    ST2001                  NO, GO BUMP TO STRING2           10440002
         LA    GR5,STRNGLEN(0,GR5)     BUMP TO NEXT STRING              10500002
*                                                                       10502002
ST2001   LA    GR5,STRNGLEN(0,GR5)     DITTO                            10560002
*                                                                       10562002
ST1005   L     CMICB,DCBWTOID          PICK UP ADDR CURRENT MICB        10620002
         TM    MICBFLAG(CMICB),INITIAL FIRST AFTER AN ENGAGE, QQ        10680002
         BZ    NFIRST                  NOT FIRST BUF                    10740002
         MVI   ZERO(GR10),NOP          SET ENGAGE TO NOP                10800002
         B     DONST006                CONTINUE PROCESSING              10860002
*                                                                       10862002
NFIRST   EQU   *                                                        10920000
         L     GR9,MICBNM1(0,CMICB)    GET ADDR OF ZEROS                10980000
         L     GR9,MICBECBA(GR9)       SET BUFFER                       11040000
         MVI   ZERO(GR9),XFF           TO                               11100000
         MVC   ONE(SEVEN,GR9),ZERO(GR9)  ONES                           11160000
*                                                                       11162002
DONST006 LA    GR9,EIGHT(CCWREG)       POINT AT FIRST WD COMMAND        11220000
         TM    DCBMRFLG,DCBMRSCC       IS THIS 2ND SCU STRING    Y02072 11280002
         BZ    DBMPT007                NO, DON'T BUMP POINTER           11340002
         LA    GR9,TWEN4(0,GR9)        POINT AT SECOND WD COMMAND       11400000
*                                                                       11402002
DBMPT007 L     GR9,ZERO(0,GR9)         GET ADDR WD BUFFER               11460000
         LA    GR8,FOUR8(ZERO,GR9)     LIMITING BUF ADDR         A46625 11510002
         LA    GR9,SIX4(0,GR9)         POINT AT BUFFER END              11520000
         SH    GR9,IOBCSW+5            SUBTRACT RESIDUAL COUNT   Y02072 11580002
         CR    GR9,GR8                 IS CALC BUF ADDR PAST     A46625 11630002
*                                      LIMIT                     A46625 11632002
         BNH   USEGR9                  WITHIN 16 BYTES OF BUF    A46625 11634002
         LR    GR9,GR8                 USE LIMITING ADDR         A46625 11638002
*                                                                       11638102
USEGR9   EQU   *                                                 A46625 11638421
         MVI   ZERO(GR9),ZERO          SET UP WD BUFFER                 11640000
         MVC   ONE(SEVEN,GR9),ZERO(GR9)  TO ZEROS                       11700000
         ST    GR9,MICBECBA(0,CMICB)   SAVE ADDR OF ZEROS               11760000
*                                                                       11762002
WRNGCOM  EQU   *                                                        11820000
         TM    IOBCSW+3,UCHKCHND       UNIT CHECK/CHANNEL END,QQ Y02072 11880002
         BNZ   EXCPEXT2                YES, RETURN TO EXCP AND   Y02072 11940002
*                                      LET CHANNEL END OR ABNORMAL END  12000002
*                                      APPENDAGE HANDLE THE SITUATION   12060002
*                                                                       12120000
         TM    IOBCSW+4,CHANER         ANY OTHER ERRORS,QQ       Y02072 12180002
         BNZ   EXCPEXT2                YES, GO TO RETURN TO EXCP Y02072 12240002
*                                                                       12300000
         CLC   MICBSENS+1(TWO,CMICB),ZEROS   ANY SENSE FOR PCU @ZA07206 12350037
         BE    EXCPEXT2                NO RETRUN TO EXCP       @ZA04944 12355037
         L     GR8,IOBCMDA-1           GET COMMAND ADDR          Y02072 12360002
         CLI   ZERO(GR8),NOP           HAS WRITE BEEN NOPPED            12420000
         BNE   EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 12480002
         TM    DCBAPPIN,SIT0           HAS THE PCU CHAIN STOPPED,QQ     12540002
         BNZ   EXCPEXT2                YES, GO TO RETURN TO EXCP Y02072 12600002
*                                                                       12840002
         L     GR8,MICBNEXT(0,CMICB)   GET ADDR CURRENT+1               12900002
         L     GR8,MICBNEXT(0,GR8)     GET ADDR CURRENT+2               12960002
         L     GR8,MICBNEXT(0,GR8)     GET ADDR CURRENT+3               13020002
         LA    GR6,MICBSENS+ONE(0,GR8) POINT AT PCU SENSE AREA          13080000
         ST    GR6,MSDIS(0,GR5)        PUT ADDR IN MSENSE COMMAND       13140002
         MVI   MSDIS(GR5),MSENS        PUT COMMAND BACK                 13200002
         L     GR6,MICBDATA(0,GR8)     LOAD DATA ADDR                   13260002
         AH    GR6,DCBBUFL             POINT AT BUFFER END              13320002
         BCTR  GR6,0                   DECREMENT BY ONE                 13380000
         ST    GR6,MRDIS(0,GR5)        PUT ADDR IN MODIFIED READ        13440002
         MVI   MRDIS(GR5),MREAD        RESTORE COMMAND                  13500000
         TM    DCBMRFLG,DCBMRDR        HAS DISENGAGE BEEN ISSUED Y02072 13560002
         BZ    SEIFSHUD                NO, SEE IF IT SHOULD BE          13620000
         SR    GR6,GR6                 CLEAR 6                          13680000
         IC    GR6,DCBMRIND            PICK UP BUFFER COU TER           13740000
         SH    GR6,H32CON              DECREMENT IT BY ONE              13800000
         STC   GR6,DCBMRIND            REPLACE IT.                      13860000
         SRA   GR6,FIVE                SHIFT OUT NOISE                  13920000
         BNZ   NODIS010                NOT ZERO, ALL IS WELL            13980000
         MVI   NOPDIS(GR5),INVALC      SET NOP TO AN INVALID            14040000
*                                      COMMAND, THUS FORCING A          14100000
*                                      COMMAND REJECT IF THE            14160000
*                                      DISENGAGE WAS LOST.              14220000
         B     NODIS010                DONT TEST FOR DISENGAGE          14280000
*                                                                       14282002
SEIFSHUD EQU   *                                                        14340000
         TM    MICBFLAG(GR8),OVERRUN   IS BUFFER OVERRUN IMMINENT       14520002
         BO    DISEN008                YES, GO SET FOR DISENGAGE        14580002
*                                                                       14640000
         TM    DCBMRFLG,DCBMRDRU       DID USER REQUEST DISNGAGE Y02072 14700002
         BZ    NODIS010                NO, DONT SET FOR STOP.           14760002
*                                                                       14820000
DISEN008 MVI   NOPDIS(GR10),DISENG     DITTO                            14880000
         MVI   STRNGLEN(GR10),DISENG   DITTO                            14940002
         MVI   STRNGLEN+STRNGLEN(GR10),DISENG  DITTO                    15000002
         OI    DCBMRFLG,DCBMRDR        INDICATE DISENGAGE SET    Y02072 15060002
         OI    DCBMRIND,SETO5          SET BUFFER COUNTER SO WE CAN     15120000
*                                      FORCE COMMAND REJECT IF          15180000
*                                      DISENGAGE COMMAND IS LOST.       15240000
*                                                                       15300000
*                                                                       15360000
NODIS010 L     GR5,MICBNEXT(0,CMICB)   GET ADDR CURRENT+1 MICB          15420002
         ST    GR5,DCBWTOID            BUMP CURRENT POINTER             15480002
         LA    GR5,MICBSENS(0,GR5)     POINT AT SENSE LOCATION          15540002
         L     CCWREG,IOBSTART         GET ADDR SCU CCW CHAIN    Y02072 15600002
         TM    DCBMRFLG,DCBMRSCC       ARE WE IN 2ND SCU STRING  Y02072 15660002
         BO    SCSTR015                YES, GO UPDATE FIRST STRING      15720002
         ST    GR5,ZERO(0,CCWREG)      PUT SENSE ADDR IN COMMAND        15780000
         MVI   ZERO(CCWREG),MSENS      PUT COMMAND CODE BACK            15840000
         MVI   FORTY(CCWREG),MREAD     SET UP REJECT COMMAND IN CASE    15900000
*                                      OF MISSED PCI                    15960000
         NI    FOUR(CCWREG),CHAINOFF   TURN CHAIN BIT OFF               16020000
         OI    TWEN8(CCWREG),CHAINON   TURN CHAIN BIT ON IN THIS STRNG  16080000
         B     SETSS020                GO SET SS INFO IN BUFFER         16140002
*                                                                       16200000
*                                                                       16260000
SCSTR015 ST    GR5,TWEN4(0,CCWREG)     PUT SENS ADDR IN COMMAND         16320000
         MVI   TWEN4(CCWREG),MSENS     PUT COMMAND CODE BACK            16380000
         MVI   SIXTEEN(CCWREG),MREAD   SET UP REJECT COMMAND IN CASE    16440000
*                                      OF MISSED PCI                    16500000
         NI    TWEN8(CCWREG),CHAINOFF  TURN CHAIN BIT OFF               16560000
         OI    FOUR(CCWREG),CHAINON    TURN CHAIN BIT ON IN THIS STRNG  16620000
*                                                                       16740000
*                                                                       16800000
SETSS020 TM    MICBFLAG(CMICB),INITIAL  FIRST BUFFER AFTER ENGAGE       16860002
         BO    SETRD040                YES, DONT SET SS INFO            16920002
         L     GR5,MICBNM1(0,CMICB)    GET ADDR CURRENT-1 MICB          17040002
         L     GR8,MICBDATA(0,GR5)     GET ADDR BUFFER                  17100002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT,QQ           17160002
         BZ    TSTAT025                NO, TEST AUTO SELECT             17220002
         OI    THREE(GR8),SETLTSS      INDICATE LATE SS IN BUFFER       17280000
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              17340000
*                                                                       17342002
TSTAT025 TM    MICBSENS(GR5),AUTSEL    WAS DOCUMENT AUTO SELECTED       17400002
         BZ    SETRD040                NO, GO SET READ STATUS    Y02072 17460002
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              17520000
         OI    TWO(GR8),SETAUTS        INDICATE AUTO SELECT             17580000
*                                                                       17640000
*                                                                       17700000
SETRD040 L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR                  18840002
         MVC   TWO(TWO,GR5),MICBSENS+ONE(CMICB)  SET READ STATUS        18900000
         NI    THREE(GR5),ZBIT2        ZERO BIT 2                       18960000
         XI    DCBMRFLG,DCBMRSCC       UPDATE STRING IND FOR SCU Y02072 19020002
         TM    DCBMRFLG,ST2OR3         STRING 2 OR 3, QQ                19080002
         BO    WHICH045                GO SEE WHICH ONE                 19140002
         NI    DCBMRFLG,OFFBIT5        TURN OFF BIT5                    19200002
         OI    DCBMRFLG,ONBIT4         TURN ON BIT 4                    19260000
         B     TSTAT055                GO TEST FOR AUTO SELECT          19320002
*                                                                       19380000
*                                                                       19440000
WHICH045 TM    DCBMRFLG,ONBIT5         STRING 3, QQ                     19500002
         BZ    SETB5050                NO, GO TURN ON BIT5              19560002
         NI    DCBMRFLG,OFFBIT4        TURN OFF BIT4                    19620002
*                                                                       19622002
SETB5050 OI    DCBMRFLG,ONBIT5         TURN ON BIT5                     19680002
*                                                                       19740000
*                                                                       19800000
TSTAT055 TM    TWO(GR5),AUTSEL         WAS DOCUMENT AUTO SELECTED       19860000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE FIVE           19920000
         LA    BAS3,STPRM085+TWO       SET UP NEW BASE                  19980002
         BO    EXIT0120                YES, DONT DO STACKER SELECT      20040002
         EJECT                                                          24420002
*********************************************************************** 24480000
*  FOLLOWING IS THE ENTRY POINT TO THE STACKER SELECT ROUTINE.          24540002
*********************************************************************** 24720000
*                                                                       24780000
STPRM085 BALR  BAS3,0                  BASE                             25020000
         USING *,BAS3                  REGISTERS                        25080002
         L     PARM2,DCBIMAGE          GET IMAGE ADDR ADDR IN REG2      25200002
         L     PARM1,DCBWTOID          GET ADDR CURRENT MICB            25260002
         CLI   DCBAPPIN,SIT3           IS IT SIT. 3-BAD READ     A43224 25270002
         BNE   BACK                    NO, BACK UP CURR. PTR.    A43224 25280002
         XI    DCBMRFLG,DCBMRSCC       UPDATE SCU STRING INDR    Y02072 25290002
         B     NOBACK                  DONT BACK UP PTR.         A43224 25300002
*                                                                       25302002
BACK     L     PARM1,MICBNM1(0,PARM1)  GET ADDR PREV. MICB       A43224 25310002
*                                                                       25312002
NOBACK   EQU   *                                                 A43224 25320021
         L     PARM1,MICBDATA(0,PARM1) POINT AT BUFFER                  25380002
         L     SAVREG,DCBIOBAD         GET ADDR PCU IOB          Y02072 26400002
         LA    SAVREG,IOBLN+IOBLN(0,SAVREG)  POINT AT SAVE AREA         26460002
*                                                                       26520000
         L     BRANREG,DEBSSAD(,DEBREG)  GET ADDR OF SS ROUTINE  Y02072 26580002
         LR    DEBREG,DCBREG           PUT DCB ADDR IN 3                26640000
         BALR  RTRNREG,BRANREG         GO TO  USER                      26700002
*                                                                       26760000
         L     PARM2,DCBIOBAD          GET ADDR PCU IOB                 26820002
         L     PARM2,IOBLN+SCUSTRNG(0,PARM2)  GET ADDR SCU CCW STRING   26880002
         IC    GR7,FOUR(0,PARM1)       PICK UP USERS SS CODE            26940000
         STC   GR7,FIVE(0,PARM1)       PUT COMMAND IN BYTE 5            27000000
         CLI   FOUR(PARM1),SSC0        IS SS INDICATOR A X'0B'   A33924 27010020
         BNE   TESTBNU                 NO/GO TEST FOR BNU        A33924 27020020
         LA    GR7,CSS0                LOAD COMMAND CODE FOR 0   A33924 27030020
*                                                                       27032002
TESTBNU  EQU   *                                                 A33924 27040020
         TM    ONE(PARM1),BATCH        BATCH NO. UPDATE SPECIFIED       27060000
         BO    DNTOR100                YES,LEAVE BIT 4 IN COMMAND       27120000
         LA    GR8,NVAL                GET X'F7'                        27180000
         NR    GR7,GR8                 REMOVE BIT4                      27240000
*                                                                       27300000
DNTOR100 LA    GR8,MREAD               GET READ OP CODE                 27360000
         CR    GR7,GR8                 IS USER PLUGGING A READ          27420000
         BNE   SWCHAN                  NO,  CHECK WHICH CHAIN           27480000
         L     GR8,DCBWTOID            GET CURRENT MICB ADDR            27540000
         OI    MICBFLAG(GR8),BADCOMI   INDICATE USER HAS ISSUED READ    27600000
*                                                                       27602002
SWCHAN   TM    DCBMRFLG,DCBMRSCC       IS CHAIN2 INDICATED, QQ   Y02072 27660002
         BO    SET10105                YES, PUT COMMAND IN CHAIN1       27720002
         STC   GR7,SS2DIS(0,PARM2)     PUT COMMAND IN CHAIN2            27780002
         B     EXIT0120                GET READY TO GET OUT             27840002
*                                                                       27900000
SET10105 STC   GR7,SS1DIS(0,PARM2)     PUT COMMAND IN CHAIN 1           27960002
*                                                                       28680002
EXIT0120 EQU   *                                                 Y02072 28682002
         L     RTRNREG,KRESAV+OFFREG14  RESTORE RETURN ADDRESS   Y02072 28684002
         CLI   WHICH,PCUABEND          ARE WE IN ABNORMAL END APPENDAGE 28740002
         BE    TSTXERR                 YES, SEE WHY                     28860000
*                                                                       28920000
         CLI   WHICH,PCIINCTL          IS PCI APPEND IN CONTROL  Y02072 28922002
         BNE   SSRETRN1                GO RETURN TO EXCP IF NOT  Y02072 28924002
         L     RWRK1,DCBWTOID          GET ADDR CURRENT+1 MICB @ZA06708 28924437
         L     RWRK1,MICBNM1(,RWRK1)   GET ADDR CURRENT MICB   @ZA06708 28925437
         TM    MICBFLAG(RWRK1),INITIAL FIRST BUFF AFTER ENGAGE @ZA09992 28925737
         BO    SSRETRN1                YES DONT POST           @ZA09992 28926037
         L     RWRK1,MICBNM1(,RWRK1)   GET ADDR CURRENT-1 MICB @ZA06708 28926437
         LA    RWRK1,MICBECB(,RWRK1)   GET ADDR CURRENT-1 ECB    Y02072 28928002
         OI    0(RWRK1),ZERO           PROG CHK IF NOT USER CORE Y02072 28930002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 28932002
         L     RQEREG,KRESAV+OFFREG1   RESTORE RQE ADDRESS       Y02072 28932402
         L     SAVREG,KRESAV+OFFREG13     RESTORE EXCP'S SA PTR  Y02072 28934002
         L     GR10,KCODCON            GET COMPLETION CODE       Y02072 28934402
         PCIPOST ECB=(RWRK1),SVAREA=(SAVREG),RQE=(1),CODE=(10)   Y02072X28936002
                                       POST ECB COMPLETE         Y02072 28938002
         B     SSRETRN2                GO TO RETURN TO EXCP      Y02072 29040002
*                                                                       29042002
TSTXERR  TM    ZERSAV,UNRECOV          CALL ERP, QQ                     29100002
         BNZ   CALLERP                 YES, GO IND ERP TO EXEC   Y02072 29220002
         LA    RTRNREG,4(,RTRNREG)     INCR TO 2ND EXCP RTRN PT  Y02072 29222002
         B     SSRETRN1                GO TO RETURN TO EXCP      Y02072 29224002
*                                                                       29226002
CALLERP  EQU   *                                                 Y02072 29228002
         OI    DCBMRIND,X02            INDICATE ERP IS EXECUTING        29280002
*                                                                       29282002
SSRETRN1 EQU   *                       NOT IN KEY 0              Y02072 29284002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 29286002
*                                                                       29288002
SSRETRN2 EQU   *                       ALREADY IN KEY 0          Y02072 29290002
         ST    RTRNREG,KRESAV+OFFREG14  UPDATE EXCP RETURN ADDR  Y02072 29290402
         MVI   WHICH,ZERO              ZERO SWITCH                      29292037
         LM    R0,R15,KRESAV           RESTORE EXCP'S REGISTERS  Y02072 29312037
         BR    RTRNREG                 RETURN TO EXCP                   29352037
         DROP  BAS3                    DROP BASE REGISTER               29392037
         EJECT                                                          29460002
*********************************************************************** 29520000
*   FOLLOWING IS THE ABNORMAL END APPENDAGE.  IT IS LINKED TO FROM      29580002
*   IOS WHENEVER UNIT CHECK OR CHANNEL ERRORS OCCUR ON THE CCW CHAINS.  29640002
*   THE APPENDAGE THEN SETS ERROR INFORMATION IN THE BUFFERS AND POSTS  29700002
*   THEM COMPLETE.  IF THE ERROR WAS ANYTHING OTHER THAN INTERVENTION   29760002
*   REQUIRED, THIS APPENDAGE SPECIFIES THAT THE ERP SHOULD BE SCHEDULED 29820002
*   WHEN IT RETURNS TO IOS.                                             29880002
*********************************************************************** 29940000
*                                                                       29942002
AEAPEN   EQU   *                                                        30000000
         USING PCIAPEN,BA12                                             30060000
         USING RQE,RQEREG              ESTABLISH RQE BASE REG   Y02072  30062002
         LA    BA12,PCIAPEN-ABNEND(0,BASE)  SET UP BASE                 30120002
         L     GR10,DCBIOBAD           GET ADDR PCU IOB                 30180002
         LA    GR10,EIGHT(0,GR10)      BUMP OVER PREFIX                 30240002
         LA    IOBREG,ZERO(0,IOBREG)   CLEAR OUT GARBAGE                30300002
         STM   ZERO,BASE,KRESAV        SAVE IOS REGS             Y02072 30302002
         CR    GR10,IOBREG             PCU ABNORMAL END, QQ             30360002
         BNE   SCUAB800                NO GO HANDLE SCU ABNEND          30420002
         MVI   WHICH,PCUABEND          IND PCU ABEND GOING     @ZA07621 30460037
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 30500002
*                                      CHAIN                      41426 30520002
         TM    DCBMRIND,X02            ERP JUST FINISHED, QQ            30540000
         BZ    GTCOM005                NO, GO GET COMMAND ADDR          30600000
         NI    DCBMRIND,XFD            TURN OFF ERP GOING BIT           30660000
         TM    DCBMRIND,X01            IS SCU ERP EXECUTING             30720000
         BO    EXCPEXT1                YES, LET IT POST BUFFER   Y02072 30780002
*                                                                       30840000
         TM    DCBMRFG,PCURR           CURRENT NEED POSTING             30900000
         BO    NPCURR                  YES, GO POST IT                  30960000
         TM    DCBMRFG,PCURRP1         CURR+1 NEEDS POSTING, QQ         31020000
         BO    NPCURRP1                YES, GO POST IT                  31080000
*                                                                       31140000
*   NOTHING NEEDS POSTING, GET OUT                                      31200000
*                                                                       31260000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 31380002
*                                                                       31440000
NPCURR   NI    DCBMRFG,X7F             TURN OFF POST CURRENT FLAG       31500000
         L     GR5,DCBWTOID            GET ADDR CURRENT                 31560000
*                                                                       31562002
DIDEW    EQU   *                                                 Y02072 31620002
         L     CCREG,KPCUER            INIT CC TO ERROR ON PCU   Y02072 31740002
         CLI   IOBSIOCC,CC3            IS CONDITION CODE 3       Y02072 31742002
         BNE   CHKWAIT                 POST ECB IN ERROR IF NOT  Y01072 31744002
         L     CCREG,KCODCON           CHANGE CC TO IND SUCCESS  Y02072 31746002
*                                                                       31748002
CHKWAIT  EQU   *                                                 Y02072 31748402
         TM    MICBECB(GR5),WAIT       DID USER WAIT             Y02072 31748802
         BNZ   POSTECB                 YES, GO TO POST ROUTINE   Y02072 31749202
         ST    CCREG,MICBECB(,GR5)     POST ECB                  Y02072 31749602
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 31749702
*                                                                       31749802
POSTECB  EQU   *                                                 Y02072 31750002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 32100002
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 32460002
*                                                                       32520000
NPCURRP1 NI    DCBMRFG,XBF             TURN OFF POST FLAG               32580000
         L     GR5,DCBWTOID            GET ADDR OF CURRENT MICB         32640000
         L     GR5,MICBNEXT(GR5)       GET ADDR CURRENT+1               32700000
         B     DIDEW                   GO POST CURR+1                   32760000
*                                                                       32820000
GTCOM005 EQU   *                                                 Y02072 32822002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 32824002
*                                      APPENDAGE IS EXECUTING           32940002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 32942002
         CLI   IOBSIOCC,CC3            DEVICE NOT OPERATIONAL, @ZA06142 33240037
         L     CMICB,DCBWTOID          GET ADDR OF CURR MICB   @ZA06142 33300037
         BNE   XCHKCOM                 NO, SEE WHERE WE BLEW            33360037
         B     CURR020                 GO HANDLE BLOW UP ON CURRENT     33420002
*                                                                       33422002
XCHKCOM  EQU   *                                                        33480000
         L     GR5,IOBCMDA-1           PICK UP COMMAND ADDR      Y02072 33540002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               33600002
         LTR   GR5,GR5                 CSW ZERO                @ZA01359 33650002
         BZ    CURR020                 YES USE CURRENT BUFFER  @ZA01359 33652002
         SH    GR5,KEIGHT              POINT AT COMMAND THAT BLEW       33660002
         CLI   ZERO(GR5),MREAD         IS IT A MOD READ                 33720000
         BNE   SEEIF010                NO, CHECK  MSENSE                33780002
*                                                                       33840000
         LA    GR5,EIGHT(0,GR5)        POINT AT MSENSE                  33900000
         B     GSENS015                GO PICK OUT SENSE ADDR           33960002
*                                                                       34020000
SEEIF010 CLI   ZERO(GR5),MSENS         IS IT A MOD SENSE                34080000
         BE    GSENS015                YES, GO GET SENSE ADDR           34140002
         CLI   ZERO(GR5),TIC           IS IT A TIC?            @ZA33842 34200037
         BNE   ENGDIS                  NO - BRANCH AROUND      @ZA33842 34210037
         SH    GR5,KEIGHT              YES-BACK UP TO MSENSE   @ZA33842 34220037
         B     GSENS015                GO GET SENSE ADDR       @ZA33842 34230037
*                                                                       34240037
ENGDIS   LA    GR5,SIXTEEN(0,GR5)      MUST BE ENG OR DISENG   @ZA33842 34250037
*                                      BUMP BY 16 TO POINT AT MSENS     34320002
GSENS015 L     GR5,ZERO(0,GR5)         GET SENSE ADDR FROM COMMAND      34380000
         LA    GR5,ZERO(0,GR5)         GET RID OF GARBAGE               34440000
         SH    GR5,KTEN                GR5 NOW POINTS AT THE MICB       34500002
*                                      WHICH CORRESPONDS TO THE         34560002
*                                      COMMAND CHAIN THAT BLEW UP       34620002
         L     CMICB,DCBWTOID          GET ADDR OF CURRENT MICB         34680002
         LA    CMICB,0(0,CMICB)        GET RID OF GARBAGE               34740002
         CR    GR5,CMICB               DID WE BLOW UP ON CURRENT STRNG  34800002
         BE    CURR020                 YES,GO PROCESS ERROR             34860002
         L     GR5,MICBNM1(0,GR5)      POINT AT CURRENT-1               34920002
         CR    GR5,CMICB               DID WE BLOW UP ON CURRENT+1      34980002
         BE    CURP1065                YES, GO  PROCESS ERROR           35040002
*                                                                       35100000
         B     CURP2                   MUST HAVE BLOWN UP ON CURRENT+2  35160002
*                                                                       35220000
CURR020  TM    MICBFLAG(CMICB),INITIAL FIRST BUFF ATER AN ENGAGE        35280002
         BZ    SCUBR035                NO, GO SEE IF SCU STILL GOING    35340002
*                                                                       35400000
         L     GR5,MICBDATA(0,CMICB)   GET ADDR BUFFER                  35460002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             35520000
*                                                                       35580000
         TM    DCBAPPIN,XF0            HAS SCU CHAIN BROKEN             35640002
         BNZ   CHKWT050                YES,GO SEE IF USER WAITED        35700002
         MVI   DCBAPPIN,SITF           INDICATE  SITUATION F.           35760002
*                                      THIS INDICATES  TO THE SCU       35820002
*                                      APPENDAGES THAT ONLY THE         35880002
*                                      CURRENT BUFFER NEEDS TO BE       35940002
*                                      POSTED                           36000002
*                                                                       36060000
         B     TSTIR060                GO CHECK FOR INTV REQUIRED       36120002
*                                                                       36180000
SCUBR035 TM    DCBAPPIN,XF0            HAS SCU CHAIN BEEN BROKEN        36240002
         BNZ   SETER040                YES, SET ERROR INFO IN BUFFER    36300002
         MVI   DCBAPPIN,SIT2           INDICATE SITUATION 2 SO THAT     36360002
*                                      SCU APPENDAGES KNOW THAT         36420002
*                                      CURRENT-1  BUFFER MUST STILL     36480002
*                                      BE SET FOR SS AND POSTED.        36540002
*                                                                       36542002
SETER040 L     GR5,MICBDATA(0,CMICB)   GET ADDR BUFFER                  36600002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             36660000
*                                                                       36720000
CHKWT050 TM    ZERSAV,UNRECOV          GOING TO ERP                     36780002
         BNZ   REDPOST                 YES GO INDICATE WE ARE READY TO  36840002
*                                      POST UPON COMPLETION OF ERP      36900002
         TM    DCBMRIND,X01            IS SCU ERP EXECUTING             36960002
         BO    REDPOST                 YES,INDICATE WE ARE READY        37020002
*                                      ANYTIME YOU ARE.                 37080002
         TM    MICBECB(CMICB),WAIT     DID USER WAIT FOR BUFFER         37140002
         BZ    IPOST055                NO I WILL POST IT                37200002
*                                                                       37260000
         L     CCREG,KCODCON           LOAD NORMAL COMPLETION CODE      37320002
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 37440002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 37680002
*                                                                       37800000
*                                                                       37860000
IPOST055 MVC   MICBECB(FOUR,CMICB),KCODCON  POST COMPLETE               37920000
         B     TSTIR060                GO LEAVE                         37980002
*                                                                       37982002
REDPOST  OI    DCBMRFG,PCURR           SAY CURRENT MUST BE POSTED       38040002
*                                                                       38042002
TSTIR060 TM    ZERSAV,UNRECOV          ERRORS BESIDES I.R.              38100002
         BNZ   GO2ERP                  SET FOR ERP                      38160002
         CLI   IOBSIOCC,CC3            DEVICE NOT READY, QQ             38220002
         BNE   EXCPEXT1                RETURN TO EXCP IF NOT     Y02072 38280002
*                                                                       38460000
GO2ERP   OI    DCBMRIND,X02            INDICATE ERP IS EXECUTING FOR    38520002
*                                      PCU                              38580002
         B     EXCPEXT2                LET EXCP SCHEDULE ERP     Y02072 38700002
*                                                                       38702002
*                                                                       38760000
*********************************************************************** 38820000
*   THE FOLLOWING CODE HANDLES THE SITUATION WHEN THE PCU CHAIN         38880002
*   BLOWS UP ON THE CURRENT+1 BUFFER.                                   38940002
*********************************************************************** 39000000
*                                                                       39002002
CURP2    L     GR5,MICBNEXT(0,GR5)     POINT AT C+2 MICB                39060000
         L     GR5,MICBDATA(0,GR5)     POINT AT C+2 BUFFER              39120000
         LH    GR6,DCBBUFL             GET BUFFER LEN                   39180000
         BCTR  GR6,ZERO                DECREMENT FOR EXECUTE            39240000
         EX    GR6,CLR                 CLEAR C+2 BUFFER                 39300000
*                                                                       39360000
         B     CURP1065                GO HANDLE BLOW UP AS IF IT       39420000
*                                      OCCURRED ON C+1.                 39480000
*                                                                       39540000
CURP1065 TM    DCBAPPIN,XF0            HAS SCU CHAIN BROKEN             39600002
         BZ    SETSS090                GO SET STACKER INFO IN C-1       39660002
*                                                                       39720000
         CLI   WHICH,PCUABEND          ARE WE IN CHAN END APPENDAGE     39780002
         BNE   CLRBUF75                YES, GO CLEAR C+1  BUFFER        39840002
*                                                                       39900000
         L     GR5,MICBDATA(0,CMICB)   GET ADDR CURRENT BUFFER          39960000
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             40020000
*                                                                       40080000
CLRBUF75 L     GR5,MICBNEXT(0,CMICB)   GET ADDR C+1 MICB                40140002
         L     GR5,MICBDATA(0,GR5)     GET ADDR C+1 BUFFER              40200002
         LH    GR6,DCBBUFL             GET BUFFER LENGTH                40260002
         BCTR  GR6,ZERO                DECREMENT FOR EXECUTE            40320002
         EX    GR6,CLR                 CLEAR C+1 BUFFER                 40380002
*                                                                       40440000
*                                                                       40500000
         B     CHKWT050                GO POST AND EXIT                 40560002
*                                                                       40800000
*                                                                       40860000
*********************************************************************** 40920000
*   IF THE PCU CHAIN BLEW UP ON THE CURRENT+1 BUFFER AND THE SCU CHAIN  41040002
*   HAS NOT YET BROKEN, THE FOLLOWING CODE IS EXECUTED.                 41100002
*********************************************************************** 41160000
*                                                                       41280000
SETSS090 TM    MICBFLAG(CMICB),INITIAL  FIRST AFTER AN ENGAGE           41340000
         BO    SWHCH105                GO SEE TO C+1                    41400000
         L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                41460000
         L     GR6,MICBDATA(0,GR5)     GET C-1 BUFFER ADDR              41520002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT,QQ           41580002
         BZ    TSTAT095                NO, TEST AUTO SELECT             41640002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              41700000
         OI    THREE(GR6),SETLTSS      SET LATE STACKER BIT             41820000
*                                                                       41822002
TSTAT095 TM    MICBSENS(GR5),AUTSEL    WAS DOCUMENT AUTO SELECTED       41880002
         BZ    DPOST095                                                 41940000
         OI    TWO(GR6),SETAUTS        INDICATE AUTO SELECT             42000000
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              42060000
*                                                                       42120000
DPOST095 TM    MICBECB(GR5),WAIT       DID USER WAIT                    42180002
         BZ    MPST100                 NO, POST MYSELF                  42240002
         L     CCREG,KCODCON           LOAD COMPLETION CODE             42300000
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 42660002
         B     SWHCH105                GO SEE WHICH APPENDAGE WERE IN   42780002
*                                                                       42840000
*                                                                       42900000
MPST100  MVC   MICBECB(FOUR,GR5),KCODCON  POST C-1 COMPLETE             42960000
*                                                                       42962002
SWHCH105 L     GR6,MICBNEXT(,CMICB)    GET ADDR OF C+1 MICB      Y02072 43020002
         L     GR5,MICBDATA(,GR6)      GET ADDR OF C+1 BUFF      Y02072 43080002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             43260000
         TM    ZERSAV,UNRECOV          GOING TO ERP,QQ                  43380002
         BNZ   RPOST                   YES, INDICATE READY FOR POST     43440002
         TM    DCBMRIND,X01            IS SCU EXECUTING                 43500002
         BO    RPOST                   YES, INDICATE READY FOR POST     43560002
         MVC   MICBECB(FOUR,GR6),KCODCON  POST NORMAL COMPLETION Y02072 43620002
         B     LEVALON                 GET READY FOR SS                 43680002
*                                                                       43682002
RPOST    OI    DCBMRFG,PCURRP1         CURRENT+1 MUST BE POSTED         43740002
*                                                                       43742002
LEVALON  EQU   *                                                        43800000
         L     GR5,MICBDATA(0,CMICB)   PICK UP BUFFER ADDRESS           43920002
         MVC   TWO(TWO,GR5),MICBSENS+ONE(CMICB)  SET READ STATUS        43980000
         NI    THREE(GR5),ZBIT2        ZERO BIT 2                       44040000
         MVI   DCBAPPIN,SIT3           SET SITUATION INDICATOR FOR      44160002
*                                      SCU APPENDAGES.                  44220002
         B     TSTAT055                GO AND PREPARE  FOR EXIT TO      44280002
*                                      USERS  SS  ROUTINE.              44340002
*                                                                       44400000
*********************************************************************** 44460002
*   THE FOLLOWING SUBROUTINE SETS BUFFER STATUS INDICATORS              44520002
*********************************************************************** 44522002
*                                                                       44580000
SESTAT   EQU   *                                                 Y02072 44640002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 44642002
         ST    CMICB,CSAV              SAVE CURRENT MICB                44700002
         ST    RTRNREG,RTRNSAVE        SAVE SUBROUTINE RETRN REG Y02072 44700402
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 44702002
         TM    IOBCSW+3,ASC            ATTN, S MOD, OR CU END    Y02072 44704002
         BZ    OTHERR                  NO, SEE IF OTHER ERRORS          44760002
         OI    ZERO(GR5),UNRECOV       SET IO ERROR BIT                 44820002
*                                                                       44822002
OTHERR   TM    IOBCSW+4,IPPCCIC        OTHER ERRORS IN STATUS    Y02072 44880002
         BZ    TSNS                    NO, TEST SENSE                   44940002
         OI    ZERO(GR5),UNRECOV       SET IO ERROR BIT                 45000002
*                                                                       45002002
TSNS     TM    IOBSENS0,CMRJBOC        CMD REJECT OR BUS OUT CHK Y02072 45060002
         BZ    CHKIRQ                  NO, CHECK I.R.                   45120002
         OI    ZERO(GR5),UNRECOV       SET IO ERROR BIT                 45180002
*                                                                       45182002
CHKIRQ   TM    IOBSENS0,INTVR          IS I.R. BIT ON            Y02072 45240002
         BNZ   SETIR                   YES GO SET I.R.         @ZA02234 45300002
         TM    IOBSENS0,XFF-INTVR-AUTSEL    ANY VALID SENSE    @ZA02234 45350002
         BZ    SETIR                   NO SET I.R. BIT ON      @ZA04946 45352037
         CLC   IOBSENS0(TWO),DUMSENS   DUMMY SENSE FROM IOS    @ZA04946 45352537
         BNE    SAVE0                  NO USE NORMAL SENSE     @ZA04946 45353037
         OI    ZERO(GR5),UNRECOV       SET I/O ERROR           @ZA04946 45353537
SETIR    EQU   *                                               @ZA02234 45354002
         OI    ZERO(GR5),IR            SET ON I.R. BIT                  45360002
         NI    0(GR5),OFF-UEX          TURN OFF UNIT EXCEPTION  OX01515 45362002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 45480002
         BAL   RTRNREG,DEVNREDY        GO TO SET PCU NOT READY   Y02072 45540002
         CLI   WHICH,PCUABEND          PCU ABEND, QQ                    45600002
         BE    SAVE0                   YES, DON'T SET SCU NOT    Y02072 45660002
*                                      READY                     Y02072 45720002
         L     RUCB,DEBUCBAD+4(,DEBREG)  GET ADDR OF SCU UCB     Y02072 45840002
         BAL   RTRNREG,DEVNREDY        GO TO SET SCU NOT READY   Y02072 45900002
*                                                                       45900402
SAVE0    EQU   *                                                 Y02072 45902002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 45904002
         MVC   ZERSAV(ONE),ZERO(GR5)   SAVE BYTE ZERO                   45960002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 45962002
         L     CMICB,CSAV              RESTORE MICB POINTER             46020002
         L     RTRNREG,RTRNSAVE        RESTORE RETURN ADDRESS    Y02072 46022002
         BR    RTRNREG                 RETURN                           46080002
         DROP  RQEREG                  DROP RQE BASE REGISTER    Y02072 46082002
         EJECT                                                          46500000
*********************************************************************** 46560000
*   THE FOLLOWING IS THE CHANNEL END APPENDAGE.  IT IS ENTERED WHEN     46680002
*   CHANNEL END OCCURS ON THE PCU OR SCU CCW CHAINS.                    46740002
*********************************************************************** 46800000
*                                                                       46920000
CEAPEN   EQU   *                                                        46980000
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 46982002
         LA    BA12,PCIAPEN-CHANEND(0,BASE)  SET BASE  REGISTER         47040002
         L     GR10,DCBIOBAD           GET ADDR PCU IOB                 47100002
         LA    GR10,EIGHT(GR10)        BUMP OVER PREFIX                 47160002
         LA    IOBREG,0(IOBREG)        CLEAR OUT GARBAGE                47220002
         STM   R0,R15,KRESAV           SAVE EXCP'S REGISTERS     Y02072 47250037
         CR    GR10,IOBREG             PCU CHANNEL END. QQ              47280002
         BNE   SCUCE005                NO, GO HANDLE SCU CHAN END       47400002
         MVI   WHICH,PCUCE             INDICATE PCU CHAN END     Y02072 47402002
*                                      APPEN IS BEING EXECUTED   Y02072 47404002
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 47420002
*                                      CHAIN                      41426 47440002
         LA    GR5,IOBLN(GR10)         POINT TO SCU IOB                 47524002
         TM    TWO(GR5),OPATTN         TEST IF OP ATTN LAST TIME        47528002
         BZ    CECONT                  NO, CONT CHANNEL END PROCESSING  47534002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 47548002
         BAL   RTRNREG,DEVNREDY        SET PCU UCB TO NOT READY  Y02072 47555002
*                                      TO SYNC PCU WITH SCU      Y02072 47562002
CECONT   EQU   *                                                        47569000
         L     CMICB,DCBWTOID          PICK UP ADDR CURRENT MICB        47580002
*                                                                       47640000
         TM    DCBAPPIN,XF0-UEX        HAS SCU STOPPED           Y02072 47700002
         BNZ   GETGONX                 YES, POST AND LEAVE              47760000
*                                                                       47820000
         L     GR5,IOBCMDA-1           PICKUP COMMAND ADDR       Y02072 47880002
         L     GR5,ZERO(0,GR5)         GET SENSE ADDR                   47940000
         LA    GR5,ZERO(0,GR5)         GET RID OF GARBAGE               48000000
         SH    GR5,KTEN                GR5 NOW POINTS AT THE MICB WHICH 48060000
*                                      CORRESPONDS TO THE COMAND STRING 48120002
*                                      THAT TERMINATED DUE TO UNIT EX.  48180000
         LA    CMICB,0(0,CMICB)        GET RID OF GARBAGE               48240000
         CR    GR5,CMICB               TERMINATE ON CURRENT             48300000
         BE    UEONC                   YES, GO HANDLE AS NORMAL         48360000
*                                                                       48362002
*                                                                       48420000
*********************************************************************** 48422002
*   UNIT EXCEPTION ON THE PCU HAS OCCURRED ON THE CURRENT+1 BUFFER.     48480002
*   THIS MEANS THAT I/O ON THE SCU WAS NOT STARTED IN TIME TO PREVENT   48540002
*   THE PCU FROM TERMINATING. THIS SITUATION WILL BE TREATED AS A       48600002
*   LATE PCI.                                                           48660002
*********************************************************************** 48662002
*                                                                       48720000
         NI    DCBAPPIN,UEX            TURN OFF ALL BUT SCU CE @ZA05562 48770037
         OI    DCBAPPIN,SIT5           INDICATE SITUATION 5    @ZA05562 48800037
         B     EXCPEXT3                GO TO RETURN TO EXCP      Y02072 48840002
*                                                                       48900000
UEONC    EQU   *                                                        48960000
         L     GR5,MICBDATA(0,CMICB)   GET ADDR C BUFFER                49020000
         OI    ZERO(GR5),UEX           TURN ON UNIT EXCEPTION           49080000
         OI    MICBFLAG(CMICB),UNITEX  SET UNIT EX IN MICB     @ZA02230 49130002
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED ON THIS   A46398 49250002
         BZ    LVTME009                                          A46398 49254021
         L     CCREG,KCODCON           PUT COMP. CODE INTO R10   A46398 49256002
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 49259202
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 49259702
*                                                                       49259802
LVTME009 MVC   MICBECB(FOUR,CMICB),KCODCON  POST MICB COMPLETE   A46398 49259902
         NI    DCBAPPIN,UEX            TURN OFF ALL BUT SCU    @ZA05562 49300037
*                                      CHAN END DELAYED BIT    @ZA05562 49305037
         OI    DCBAPPIN,SIT2           INDICATE C-1 MUST STILL @ZA05562 49310037
*                                      SET FOR SS AND POSTED            49320000
         B     EXCPEXT3                GO TO RETURN TO EXCP      Y02072 49380002
*                                                                       49382002
GETGONX  EQU   *                                                        49440000
         TM    DCBMRIND,X01            IS SCU EXECUTING                 49500002
         BNZ   RPOST2                  YES INDICATED POST NEEDED        49560002
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED ON THIS BUFFER   49620002
         BZ    LVTME010                NO, DONT LINK TO POST ROUTINE    49680002
         L     CCREG,KSCUER            SET UP COMP CODE FOR POST Y02072 49740002
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 49980002
         BAL   RTRNREG,POSTRTN         LINK TO  POST ROUTINE     Y02072 50100002
*                                                                       50160002
LVTME010 MVC   MICBECB(FOUR,CMICB),KSCUER  POST COMPLETE WITH ERROR     50220000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 50400002
*                                                                       50402002
RPOST2   OI    DCBMRFG,PCURR           CURRENT NEEDS POSTING            50460002
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 50520002
         EJECT                                                          50760000
*********************************************************************** 50820000
*   THE FOLLOWING CODE HANDLES CHANNEL END CONDITIONS ON THE            50880002
*   SCU CCW CHAIN.                                                      50940002
*********************************************************************** 51000000
*                                                                       51060000
SCUCE005 EQU   *                                                 Y02072 51300002
         MVI   WHICH,SCUCE             IND SCU CHAN END        @ZA06136 51310037
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 51320002
*                                      CHAIN                      41426 51340002
         L     GR5,IOBSTART            GET COMMAND CHAIN ADDR    Y02072 51342002
         L     GR6,DCBIOBAD            GET ADDR PCU IOB                 51360002
         L     GR6,CCWD(0,GR6)         GET ADDR OF PCU CCW STRING       51420002
         LA    GR6,XPCLEN(0,GR6)       POINT AT SCU STRING              51480002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               51540002
         CR    GR5,GR6                 DID THE CE  OCCUR ON THE         51600002
*                                      POCKET LIGHT CHAIN               51660002
         BE    WHPCU005                NO, GO HANDLE THE INTRPT  Y02072 51720002
         TM    DCBMRFG,LITEL           LAST LIT COMMAND, QQ             51780002
         BZ    EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 51840002
         NI    DCBMRFG,OFFLITE         TURN OFF LIGHT SWITCH            51900002
*                                                                       51960000
         BAL   RTRNREG,DEVNREDY        GO TO SET SCU NOT READY   Y02072 52020002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 52140002
         BAL   RTRNREG,DEVNREDY        GO TO SET PCU NOT READY   Y02072 52200002
         B     EXCPEXT2                GO TO RETURN TO EXCP      Y02072 52320002
WHPCU005 EQU   *                                                 Y02072 52322002
         TM    DCBAPPIN,SITF           ANY PCU STATUS?           Y02072 52324002
         BNZ   WHPCU010                YES PCU CE OCCURRED FIRST Y02072 52326002
         TM    IOBCSW+3,UNITE          UNIT EXCEPTION ON?        Y02072 52326402
         BO    SETUE                   GO SET FLAG               Y02072 52326802
         L     GR5,IOBCMDA-1           LOAD ADDR OF NEXT CMND    Y02072 52328002
         CLI   0(GR5),WRDELAY          SPECIAL MS CONDITION?     Y02072 52330002
         BE    MSBREAK                 YES - GO HANDLE           Y02072 52332002
SETUE    EQU   *                                                 Y02072 52332402
         OI    DCBAPPIN,UEX            SET FLAG FOR PCU CE       Y02072 52332802
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDR   @ZA33065 52334037
         TM    MICBFLAG(CMICB),INITIAL FIRST BUFFER AFTER ENG? @ZA33065 52334137
         BO    EXCPEXT1                YES-DONT SET SS INFO    @ZA33065 52334237
         L     GR5,MICBNM1(0,CMICB)    GET CURRENT-1 BUFFER    @ZA33065 52334937
         L     GR8,MICBDATA(0,GR5)     GET ADDR BUFFER         @ZA33065 52335037
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT?    @ZA33065 52335137
         BZ    TSTSC025                NO-TEST AUTO SELECT     @ZA33065 52335237
         OI    THREE(GR8),SETLTSS      INDICATE LATE SS IN BFR @ZA33065 52335337
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5     @ZA33065 52335437
TSTSC025 TM    MICBSENS(GR5),AUTSEL    WAS DOC AUTO SELECTED?  @ZA33065 52335537
         BZ    TSTMORE                 NO-GO DO MORE TESTS     @ZA33065 52335637
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5     @ZA33065 52337637
         OI    TWO(GR8),SETAUTS        INDICATE AUTO SELECT    @ZA33065 52339637
TSTMORE  TM    MICBSENS(GR5),ALL       ANY ERRORS?             @ZA33065 52341637
         BNZ   HAVERR                  YES-GO GET POST CODE    @ZA33065 52343637
         L     CCREG,KCODCON           COMPLETION CODE 7F      @ZA33065 52345637
         B     TSTWAIT                 GO SEE IF WAITING       @ZA33065 52347637
HAVERR   L     CCREG,KSCUER            COMPLETION CODE 41      @ZA33065 52349637
TSTWAIT  TM    MICBECB(GR5),WAIT       DID USER WAIT?          @ZA33065 52351637
         BZ    POSTIT                  NO-GO POST MYSELF       @ZA33065 52353637
         BAL   RTRNREG,POSTRTN         YES-GO TO POST ROUTINE  @ZA33065 52354637
POSTIT   TM    MICBSENS(GR5),ALL       ANY ERRORS?             @ZA33065 52355637
         BNZ   POSTERR                 YES-POST SCU IN ERROR   @ZA33065 52359637
         MVC   MICBECB(4,GR5),KCODCON  POST ECB WITH 7F        @ZA33065 52361637
         B     EXCPEXT1                RETURN TO EXCP          @ZA33065 52363637
POSTERR  MVC   MICBECB(4,GR5),KSCUER   POST ECB WITH 41        @ZA33065 52365637
         B     EXCPEXT1                RETURN TO EXCP - SCU CE   Y02072 52367637
*                                      WILL BE HANDLED AFTER PCU Y02072 52369637
WHPCU010 OI    DCBAPPIN,BDTCE          INDICATE BROKEN DUE TO CHAN END  52380002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 52382002
         MVN   CHECKARE(1),DCBAPPIN    MOVE SITUATION INDICATOR         52440002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 52442002
         CLI   CHECKARE,SIT5           LATE PCI, QQ                     52500002
         BNE   NEXTSIT                 NO/GO TEST NEXT SIT       A33924 52510002
         L     GR5,IOBCMDA-1           LOAD ADDR OF FAILING CMND Y02072 52520002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE        A33924 52530020
         CLI   0(GR5),WRDELAY          IS THIS CCW WRITE DELAY  SA60294 52532002
         BE    MSBREAK                 IF SO, PREV CCW IS MS    SA60294 52534002
         OI    DCBAPPIN,BDTUC          INDICATE BROKEN DUE TO UC A33935 52550020
         B     HNDLLPCI                GO HANDLE LATE PCI        A33924 52570020
*                                                                       52572002
NEXTSIT  EQU   *                                                 A33924 52590020
         CLI   CHECKARE,SITF           HAS SITUATION F BEEN INDICATED   52620002
         BE    GETIT2                  YES, CURRENT MUST BE POSTED      52680000
         CLI   CHECKARE,SIT2           SITUATION 2                      52740002
         BE    CHKFZ020                GO POST C-1                      52800002
         CLI   CHECKARE,ZERO           IS IT SITUATION ZERO      A33924 52804020
         BNE   SIT3035                 NO/ASSUME SITUATION 3     A33924 52808020
*                                                                A33924 52812020
*                                                                       52814002
*********************************************************************** 52814402
*   SITUATION 0 CAN OCCUR AT THIS POINT IN TIME ONLY IF THE PRECEEDING  52816002
*   PCI CAME IN SO LATE THAT THE APPENDAGE DID NOT HAVE ADEQUATE TIME   52820002
*   TO UPDATE THE FOLLOWING MS COMMAND BEFORE THE CHANNEL FETCHES IT.   52824002
*   CONSEQUENTLY, THE SCU CHAIN BROKE AT THE MS COMMAND WITH CHANNEL    52828002
*   END AND DEVICE END ONLY.  THIS SITUATION WILL BE HANDLED AS A       52832002
*   MISSED PCI.                                                         52836002
*********************************************************************** 52838002
*                                                                       52838402
MSBREAK  EQU   *                                                SA60294 52838802
         L     GR5,IOBCMDA-1           LOAD ADDR OF LAST COMMAND Y02072 52840002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE        A33924 52844002
         L     GR6,IOBSTART            LOAD ADDR SCU CHAN PGM    Y02072 52848002
         LA    GR6,EIGHT(0,GR6)        POINT TO SECOND COMMAND   A33924 52852002
         CR    GR5,GR6                 ARE WE ON 1ST OR 2ND MS   A33924 52856002
         BNE   SECMS                   SECOND MS                 A33924 52860037
         LA    GR6,THIR2(0,GR6)        POINT TO ASSOC NOP/SS CCW A33924 52864002
         B     UPDTCSW                 GO MODIFY IOBCSW          A33924 52868002
*                                                                       52870002
SECMS    EQU   *                                                 A33924 52872020
         LA    GR6,EIGHT(0,GR6)        POINT TO ASSOC NOP/SS CCW A33924 52876002
*                                                                       52878002
UPDTCSW  EQU   *                                                 A33924 52880020
         MVI   0(GR6),MREAD            SET NOP/SS TO MREAD COM   A33924 52884002
         LA    GR6,EIGHT(0,GR6)        POINT PAST COMMAND        A33924 52888002
         ST    GR6,IOBCMDA-1           MODIFY LAST COMMAND ADDR  Y02072 52892002
         OI    IOBCSW+3,UC             SET UNIT CHECK IN IOB     Y02072 52896002
         OI    IOBFLAG1,IOBIOERR       SET IOB EXCEPTION FLAG ON Y02072 52900002
         MVI   DCBAPPIN,SIT5           SET SITUATION 5 IN DCB    A33924 52904002
         MVI   IOBSENS0,COMREJ         SET IOBSENS0 TO COMREJ    A33924 52908002
         B     REGCH810                GO HANDLE MISSED PCI      A33924 52912002
*                                                                       52914002
GETIT    L     GR5,DCBWTOID            GET ADDR CURRENT MICB            52920002
*                                                                       52922002
POSTT011 TM    MICBECB(GR5),WAIT       HAS USER WAITED FOR BUFFER       52980002
         BZ    IPSTT015                NO, POST MYSELF                  53040002
         L     CCREG,KCODCON           LOAD COMPLETION CODE             53160002
*                                                                       53220002
HDFRPST  EQU   *                                                 Y02072 53280002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 53520002
*                                                                       53640000
BEGON012 EQU   *                                                        53700000
         TM    DCBAPPIN,BDTLTPCI       DID UNIT CHECK OCCUR             53760000
*                                      ON SCU DUE TO MISSED PCI.        53820000
*                                      IF SO (TAKE NOTE) WE ARE         53880002
*                                      IN THE ABNORMAL END APPENDAGE    53940000
         BO    STPCI030                YES, GO INDICATE SAME            54000000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 54120002
*                                                                       54180000
GETIT2   L     GR5,DCBWTOID            GET ADDR CURRENT MICB            54240000
         L     GR6,MICBDATA(0,GR5)     GET BUFFER ADDR                  54300000
         TM    ZERO(GR6),UNRECOV       ERRORS BESIDESI.R.               54360000
         BO    NOTNORM                 YES, SEE IF POST IS NEEDED       54420000
         TM    DCBMRIND,X02            IS PCU ERP EXECUTING             54480000
         BZ    GETIT                   NO, GO POST NORMAL COMPLETION    54540000
*                                                                       54542002
GTPERR   OI    DCBMRFG,PCURR           INDICATE CURRENT NEEDS POSTING   54600000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 54720002
*                                                                       54722002
NOTNORM  TM    DCBMRIND,X02            IS PCU ERP EXECUTING, QQ         54780000
         BO    GTPERR                  YES, INDICATE CURRENT NEEDS PST  54840000
         TM    MICBECB(GR5),WAIT       HAS USER WAITED                  54900000
         BZ    HFTPERR                 NO, POST MYSELF                  54960000
         L     CCREG,KPCUER            GET COMPLETION CODE              55020000
         B     HDFRPST                 GO POST ABNORMAL COMPLETION      55140000
*                                                                       55142002
HFTPERR  MVC   MICBECB(ONE,GR5),KPCUER  POST COMPLETION                 55200000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 55260002
*                                                                       55262002
IPSTT015 MVC   MICBECB(0,GR5),KCODCON  POST COMPLETE                    55320002
         B     BEGON012                SEE  WHAT SIT WE RE  IN          55380002
*                                                                       55382002
CHKFZ020 L     CMICB,DCBWTOID          GET ADDR CURRENT MICB            55440002
         L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                55500002
         L     GR6,MICBDATA(0,GR5)     GET ADDR C-1 BUFFER              55560002
         TM    MICBFLAG(CMICB),INITIAL  FIRST BUFFER AFTER AN ENGAGE    55620000
         BO    BEGON012                YES, LEAVE.                      55680002
*                                                                       55740000
CHKSS024 TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT, QQ          55800002
         BZ    ISTAT025                NO, CHECK FOR AUTO SELECT        55860002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              55920000
         OI    THREE(GR6),SETLTSS      INDICATE LATE SS IN BUFFER       55980000
*                                                                       55982002
ISTAT025 TM    MICBSENS(GR5),AUTSEL    WAS DOCUMENT AUTO SELECTED       56040002
         BZ    POSTT011                NO, GO POST COMPLETION,          56100002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              56160000
         OI    TWO(GR6),SETAUTS        INDICATE AUTO SELECT             56220000
         B     POSTT011                GO  POST AS COMPLETE             56280002
*                                                                       56340000
*                                                                       56400000
STPCI030 L     GR5,MICBDATA(0,CMICB)   GET CURRENT BUFFER ADDR          56460002
         OI    ZERO(GR5),PCIMISD       INDICATE PCI WAS MISSED          56520000
         LA    GR5,INDLEN(0,GR5)       BUMP OVER BUFFER STATUS          56580002
         LH    GR6,DCBBUFL             GET BUFFER LENGTH                56640002
         SH    GR6,KELEVN              DECREMENT FOR EXECUTE            56700002
         EX    GR6,CLR                 CLEAR  C+1 BUFFER                56760002
*                                                                       56820000
         CLI   CHECKARE,SIT5           HAS PCU QUIT                     56880000
         BNE   RESGO                   NO, GO EXIT                      56940000
         TM    DCBAPPIN,BDTUC          ARE WE GOING TO ERP              57000002
         BO    RPOST3                  YES, SET POST READY              57060002
*                                                                       57120000
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED                  57180000
         BZ    DNGPST                  NO, POST MYSELF                  57240000
         L     CCREG,KSCUER            GET COMPLETION CODE              57300000
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 57420002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 57660002
*                                                                       57720002
DNGPST   MVC   MICBECB(FOUR,CMICB),KSCUER  POST COMPLETION              57780000
*                                                                       57782002
RESGO    TM    DCBAPPIN,BDTUC          ARE WE GOING TO ERP              57840002
         BZ    EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 57900002
         CLI   WHICH,PCUCE             ENTERED FROM PCU CH END @ZA06136 57960037
         BE    SETPRERP                YES GO IND PRI ERP      @ZA06136 57990037
         OI    DCBMRIND,X01            INDICATE SCU ERP EXEC   @ZA06136 58010037
         B     EXCPEXT2                RETRUN TO EXCP          @ZA06136 58030037
*                                                              @ZA06136 58050037
SETPRERP OI    DCBMRIND,X02            INDICATE PCU ERP EXEC   @ZA06136 58070037
         B     EXCPEXT2                GO TO RETURN TO EXCP      Y02072 58090037
*                                                                       58140000
RPOST3   OI    DCBMRFG,PCURR           CURRENT NEEDS POSTING            58200002
         B    RESGO                    GO GET OUT                       58260000
*                                                                       58320000
*                                                                       58380000
SIT3035  L     GR5,DCBWTOID            GET ADDR CURRENT                 58440002
         L     GR6,MICBDATA(0,GR5)     GET ADDR BUFFER                  58500002
         B     CHKSS024                GO SET SS INFO                   58560002
         DROP  RQEREG                  DROP RQE BASE REGISTER    Y02072 58562002
         EJECT                                                          58800000
*********************************************************************** 58920000
*   THE  FOLLOWING CODE IS  EXECUTED IF  ABNORMAL END  OCCURS  ON       58980000
*   THE SCU CCW  CHAIN.                                                 59040000
*********************************************************************** 59100000
*                                                                       59160000
SCUAB800 EQU   *                                                 Y02072 59220002
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 59220402
         MVI   WHICH,SCUAB             INDICATE SCU ABEND GOING  Y02072 59222002
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 59240002
*                                      CHAIN                      41426 59260002
         TM    DCBMRIND,X01            ERP JUST FINISH, QQ              59340000
         BZ    CHKCN805                NO, CONTINUE                     59400000
*                                                                       59460000
         NI    DCBMRIND,XFE            TURN OFF ERP GOING               59520000
         TM    DCBMRIND,X02            IS PCU ERP GOING                 59580000
         BO    EXCPEXT1                YES, LET IT POST BUFFER   Y02072 59640002
*                                                                       59700000
         TM    DCBMRFG,PCURR           CURRENT NEED POSTING, QQ         59760000
         BO    XPCURR                  YES, GO DO IT                    59820000
         TM    DCBMRFG,PCURRP1         CURR+1 NEED POSTING, QQ          59880000
         BO    XPCURRP1                YES, GO DO IT                    59940000
*                                                                       60000000
*  NOTHING NEEDS POSTING.  GET OUT                                      60060000
*                                                                       60120000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 60240002
*                                                                       60300000
XPCURR   NI    DCBMRFG,X7F             TURN OFF POST CURRENT FLAG       60360000
         L     GR5,DCBWTOID            GET ADDR CURRENT MICB            60420000
*                                                                       60422002
XDIDEW   TM    MICBECB(GR5),WAIT       DID USER WAIT, QQ                60480000
         BZ    XEYPOST                 NO, POST HERE                    60540000
         L     CCREG,KSCUER            LOAD COMPLETION CODE             60600000
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 60960002
*                                                                       61020002
XEYPOST  MVC   MICBECB(FOUR,GR5),KSCUER  POST COMPLETE                  61080000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 61140002
*                                                                       61200000
XPCURRP1 NI    DCBMRFG,XBF             TURN OFF POST FLAG               61260000
         L     GR5,DCBWTOID            GET ADDR CURRENT MICB            61320000
         L     GR5,MICBNEXT(0,GR5)     GET ADDR CURR+1                  61380000
         B     XDIDEW                  GO POST                          61440000
*                                                                       61500000
CHKCN805 L     GR5,IOBSTART            GET COMMAND CHAIN ADDRESS Y02072 61560002
         L     GR6,DCBIOBAD            GET ADDR PCU IOB                 61620002
         L     GR6,CCWD(0,GR6)         GET ADDR OF PCU CCW STRING       61680000
         LA    GR6,XPCLEN(0,GR6)       POINT AT SCU STRING              61740000
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               61800002
         CR    GR5,GR6                 ARE WE ON POCKET LIGHT CHAIN     61860002
         BE    REGCH810                NO, GO HANDLE INTERRUPT          61920002
         TM    DCBMRFG,LITEL           LAST LITE COMMAND, QQ            61980000
         BZ    EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 62040002
         NI    DCBMRFG,OFFLITE         TURN OFF LITE SW                 62100000
*                                                                       62160000
         BAL   RTRNREG,DEVNREDY        GO TO SET SCU NOT READY   Y02072 62220002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 62340002
         BAL   RTRNREG,DEVNREDY        GO TO SET PCU NOT READY   Y02072 62400002
         B     EXCPEXT2                GO TO RETURN TO EXCP      Y02072 62520002
*                                                                       62580000
*                                                                       62640000
REGCH810 OI    DCBAPPIN,BDTUC          INDICATE SCU CHAIN BROKEN DUE    62700002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 62762002
         MVN   CHECKARE(1),DCBAPPIN    ISOLATE SITUATION                62820002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 62822002
         CLI   CHECKARE,SIT5           LATE PCI, QQ                     62880000
         BE    HNDZR815                YES,GO HANDLE IT                 62940000
         CLI   CHECKARE,SITF           IS IT SITUATION  F               63000002
         BE    HNDF3820                YES, GO HANDLE IT                63060002
         CLI   CHECKARE,SIT3           IS IT SITUATION 3                63120002
         BE    HNDSIT3                 YES, HANDLE IT                   63180002
         CLI   CHECKARE,ZER0           IS IT SITUTATION 0               63240000
         BE    HNDZR815                YES HANDLE                       63300002
         CLI   CHECKARE,SIT2           SITUATION 2                      63360002
         BE    HNDST855                YES, HANDLE IT                   63420002
*                                                                       63422002
HNDZR815 L     GR5,IOBCMDA-1           PICK UP COMMAND ADDR      Y02072 63480002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               63540002
         SH    GR5,KEIGHT              POINT AT FAILING COMMAND         63600002
         BM    STPSS890                ZERO CSW USE CURR MICB  @ZA06142 63630037
*                                                                       63638037
         CLI   ZERO(GR5),WRDELAY       IS IT A WR DLY CMD      @ZA01358 63646037
         BNE   CHKREAD                 NO CHECK FOR MOD READ   @ZA03940 63654037
         TM    IOBSENS0,COMREJ         COMMAND REJECT          @ZA03940 63662037
         BNO   CHKREAD                 NO CONTINUE             @ZA04949 63670037
         LA    GR6,EIGHT(GR5)          POINT TO NOP SS         @ZA04949 63678037
         CLI   EIGHT(GR6),TIC         END OF STRING            @ZA04949 63686037
         BNE   UPDTCSW                YES HANDLE AS MISSED PCI @ZA09995 63694037
         SH    GR6,K24                BACK UP TO FIRST NOP SS  @ZA04949 63702037
         B     UPDTCSW                GO HANDLE AS MISSED PCI  @ZA04949 63710037
CHKREAD  EQU   *                                               @ZA04949 63718037
         CLI   ZERO(GR5),MREAD         IS IT A READ COMMAND             63720000
         BNE   RGUCK875                NO, GO HANDLE REGULAR UNIT CHECK 63780000
         TM    IOBSENS0,COMREJ         COMMAND REJECT, QQ        Y02072 63840002
         BZ    RGUCK875                NO, HANDLE AS REGULAR ERROR      63900000
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDR            63960000
         TM    MICBFLAG(CMICB),BADCOMI  DID USER ISSUE THIS COMMAND     64020002
         BZ    MSPCI                   NO, ITS A MISSED PCI             64080002
         NI    MICBFLAG(CMICB),BADOFF  TURN OFF BAD COMMAND BIT         64140000
         B     RGUCK875                HANDLE AS COMMAND REJECT         64200000
*                                                                       64202002
MSPCI    EQU   *                                                        64260000
         NI    IOBSENS0,REJOFF         TURN OFF COMMAND REJECT   Y02072 64320002
         OI    IOBSENS0,LLS            SET ON LATE SS SENSE      Y02072 64380002
*                                                                       64440000
*                                                                       64442002
*********************************************************************** 64444002
*   COMMAND REJECT HAS OCCURRED ON A READ COMMAND TO THE SCU.           64500002
*   THIS MEANS THAT THE PCI INTERRUPT WAS NOT ACCEPTED IN TIME TO       64560002
*   RESET THE COMMAND TO A NOP                                          64620002
*********************************************************************** 64622002
*                                                                       64680000
HNDLLPCI EQU   *                                                        64740000
         OI    DCBAPPIN,BDTLTPCI       INDICATE SCU CHAIN BROKEN DUE    64800000
*                                      TO LATE PCI.                     64860000
         CLI   EIGHT(GR5),TIC          IS IT A TIC COMMAND              64920002
         BNE   GSENS                   NO, GO PICK UP SENSE AREA ADDR   64980002
         S     GR5,FORTY8              YES, POINT TO FIRST SENSE COMND  65040002
*                                                                       65042002
GSENS    L     GR5,EIGHT(GR5)          POINT TO SENSE COMMAND           65100002
         LA    GR5,ZERO(0,GR5)         GET RID OF GARBAGE               65160000
         SH    GR5,KNINE               POINT AT ASSOCIATED MICB         65220000
         L     CMICB,DCBWTOID          GET CURRENT POINTER              65280000
         CR    GR5,CMICB               DID THE PCI INTERRUPT OCCUR      65340000
*                                      SO LATE THAT WE STILL GOT        65400000
*                                      COMMAND REJECT ON THE WRITE.     65460000
         BE    CHKFZ020                NO, GO SET PCI MISSED IN         65520000
*                                      CURRENT AND POST C-1.            65580000
         ST    GR5,DCBWTOID            YES, BACK UP CURRENT POINTER     65640000
         LR    CMICB,GR5               DITTO                            65700000
         B     STPCI030                GO SET PCI MISSED IN CURRENT     65760000
*                                                                       65820000
*                                                                       65880000
HNDF3820 L     CMICB,DCBWTOID          GET ADDR C MICB                  65940002
         L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR                  66000002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             66060000
         TM    ZERSAV,UNRECOV          UNRECOVERABLE ERROR, QQ          66120000
         BZ    NONTALL                 NO, CONTINUE                     66180000
         NI    ZERO(GR5),OFFERR        TURN OFF BIT 2                   66240000
         OI    ZERO(GR5),BIT1          TURN ON UNRECOV SS ERROR         66300000
*                                                                       66302002
NONTALL  EQU   *                                                        66360000
         TM    ZERSAV,UNRECOV          GOING TO ERP, QQ                 66780002
         BO    RPOST4                  YES, INDICATE POST NEEDED        66840000
         TM    DCBMRIND,X02            IS PCU ERP EXECUTING             66900000
         BO    RPOST4                  YES, INDICATE POST NEEDED        66960000
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED, QQ              67020002
         BZ    IPOST840                NO, POST IT MYSELF               67080002
*                                                                       67140000
         L     CCREG,KCODCON           GET NORMAL COMPLETION CODE       67200000
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 67440002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 67560002
*                                                                       67680000
*                                                                       67740000
IPOST840 MVC   MICBECB(FOUR,CMICB),KCODCON  POST COMPLETE               67800000
*                                                                       67860000
XIT0850  TM    ZERSAV,UNRECOV          ERRORS BESIDES   I.R.            67920000
         BZ    EXCPEXT1                DONT HAVE ERP SCHEDULED   Y02072 68040002
         OI    DCBMRIND,X01            INDICATE SCU ERP EXECUTING       68100000
         CLI   CHECKARE,SIT5           PCU DOWN, MISSED PCI      A43711 68110002
         BNE   EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 68120002
         OI    DCBMRFG,PCURR           CURR MICB NEEDS POSTING   A43711 68130002
         B     EXCPEXT2                HAVE ERP SCHEDULED        Y02072 68160002
*                                                                       68220000
RPOST4   OI    DCBMRFG,PCURR           CURRENT NEEDS POSTING            68280000
         B     XIT0850                 GO GET OUT                       68340000
*                                                                       68400000
HNDST855 L     CMICB,DCBWTOID          GET ADDR CURRENT MICB            68460002
         TM    MICBFLAG(CMICB),INITIAL  FIRST BUFFER AFTER AN ENGAGE    68520000
         BZ    SXTSS860                NO, SET SS INFO IN C-1           68580002
         NI    MICBFLAG(CMICB),TURNOFF  SET OFF INITIAL SWITCH          68640000
         B     HNDF3820                GO SET ERR INFO IN CURRENT       68700002
*                                                                       68760000
SXTSS860 L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                68820002
         L     GR8,MICBDATA(0,GR5)     GET ADDR BUFFER                  68880002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT, QQ          68940002
         BZ    NTSTA865                NO, TEST AUTO SELECT             69000002
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              69060000
         OI    THREE(GR8),SETLTSS      SET LATE SS BIT                  69120000
*                                                                       69122002
NTSTA865 TM    MICBSENS(GR5),AUTSEL    AUTO SELECT, QQ                  69180002
         BZ    NPSTT870                NO, GO POST COMPLETE             69240002
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              69300000
         OI    TWO(GR8),SETAUTS        SET AUTO SELECT BIT              69360000
*                                                                       69420000
NPSTT870 TM    MICBECB(GR5),WAIT       DID USER WAIT                    69480002
         BZ    NLPST872                NO, POST MYSELF                  69540002
*                                                                       69600000
         L     CCREG,KCODCON           LOAD NORMAL COMPLETION CODE      69660002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 70020002
         B     HNDF3820                GO SET ERR INFO IN CURRENT       70140002
*                                                                       70200000
NLPST872 MVC   MICBECB(0,GR5),KCODCON  POST BUFFER                      70260002
         B     HNDF3820                GO SET ERR INFO                  70320002
*                                                                       70322002
RGUCK875 L     GR6,IOBSTART            GET ADDR SCU CHAIN        Y02072 70380002
         LA    GR6,0(0,GR6)            GET RID OF GARBAGE               70440002
         CR    GR5,GR6                 BLOW IN STRING2                  70500002
         BE    BINTW880                YES, SEE IF THATS CURRENT        70560002
*                                                                       70620000
         LA    GR6,THIR2(0,GR6)        POINT AT STRING 2                70680000
         CR    GR5,GR6                 BLOW IN STRING2                  70740002
         BNL   BINTW880                YES SEE IF THATS CURRENT         70800002
*                                                                       70860000
         TM    DCBMRFLG,DCBMRSCC       IS CHAIN2 CURRENT         Y02072 70920002
         BO    BKUPT885                YES, WE BLEW IN C-1              70980002
         B     STPSS890                BLEW UP IN CURRENT               71040002
*                                                                       71042002
BINTW880 TM    DCBMRFLG,DCBMRSCC       IS CHAIN2 CURRENT         Y02072 71100002
         BO    STPSS890                YES, WE BLEW IN CURRENT          71160002
*                                                                       71220000
*                                                                       71222002
*********************************************************************** 71224002
*  BLEW UP IN C-1 CHAIN. SET SS INFORMATION AND POST C-1 THEN SET       71280002
*  ERROR INFORMATION IN CURRENT.                                        71340002
*********************************************************************** 71342002
*                                                                       71344002
BKUPT885 L     CMICB,DCBWTOID          GET ADDR C MICB                  71400000
         L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                71460000
         L     GR5,MICBDATA(0,GR5)     GET BUFFER ADDR                  71520002
         TM    IOBCSW+4,CPCHECK        PROGRAM CHECK, QQ         Y02072 71580002
         BO    MCF                     YES, SET BUFFER INFO             71640000
         TM    IOBSENS0,COMRLTSS       COMMAND REJ - LATE SS     Y02072 71700002
         BZ    NOTESA                  NO, TEST AUTO SELECT             71760000
*                                                                       71762002
MCF      EQU   *                                                        71820000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              71880000
         OI    THREE(GR5),SETLTSS      SET LATE STACKER BIT             71940000
*                                                                       71942002
NOTESA   TM    IOBSENS0,AUTSEL         WAS IT AUTO SELECTED, QQ  Y02072 72000002
         BZ    NXGO                    NO DONT SET BIT                  72060000
         OI    TWO(GR5),SETAUTS        INDICATE AUTO SELECT             72120000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              72180000
*                                                                       72240000
NXGO     L     GR5,MICBNM1(0,CMICB)    GO AND POST C-1                  72300000
         B     PSTIT900                AND SET C.                       72360000
*                                                                       72420000
*                                                                       72480000
STPSS890 L     CMICB,DCBWTOID          GET ADDR CMICB                   72540002
         TM    MICBFLAG(CMICB),INITIAL FIRST BFR AFTER ENG?    @ZA26121 72600037
         BZ    SKIPIT                  IF NO-GO AROUND         @ZA26121 72603037
         CLI   CHECKARE,SIT5           SITUATION 5?            @ZA26121 72606037
         BNE   SKIPIT                  IF NO-GO AROUND         @ZA26121 72609037
         TM    MICBSENS(CMICB),INTREQ  INTERVENTION REQUIRED?  @ZA26121 72612037
         BZ    SKIPIT                  IF NO-GO AROUND         @ZA26121 72615037
         L     GR5,MICBDATA(0,CMICB)   CURRENT BFR ADDR        @ZA26121 72618037
         OI    0(GR5),UNRECOV          SET UNRECOV ERROR       @ZA26121 72621037
         OI    DCBMRIND,DCBMRERS       SET ERP FOR SCU         @ZA26121 72624037
         TM    MICBECB(CMICB),WAIT     DID USER WAIT?          @ZA26121 72627037
         BZ    IPOST                   IF NO-GO POST IT        @ZA26121 72630037
         L     CCREG,KSCUER            LOAD POST CODE          @ZA26121 72633037
         BAL   RTRNREG,POSTRTN         TO POST ROUTINE         @ZA26121 72636037
IPOST    MVC   MICBECB(4,CMICB),KSCUER MOVE POST CODE TO MICB  @ZA26121 72639037
         B     EXCPEXT2                TO EXCP TO GO TO ERP    @ZA26121 72642037
SKIPIT   L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1            @ZA26121 72645037
         L     GR6,MICBDATA(0,CMICB)   GET BUFFER ADDR                  72660002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT,QQ           72720002
         BZ    TSTAT895                NO, TEST FOR AUTO SELECT         72780002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              72840000
         OI    THREE(GR6),SETLTSS      SET LATE SS BIT         @ZA14706 72900037
*                                                                       72902002
TSTAT895 TM    MICBSENS(GR5),AUTSEL    AUTO  SELECT,QQ                  72960002
         BZ    PSTIT900                NO , GO  POST                    73020002
         OI    TWO(GR6),SETAUTS        SET AUTO SELECT BIT              73080000
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              73140002
*                                                                       73200000
PSTIT900 TM    MICBECB(GR5),WAIT       DID USER WAIT                    73260002
         BZ    PMYSF                   NO, POST IT MYSELF               73320002
         L     CCREG,KCODCON           LOAD  NORMAL COMPLETION CODE     73380002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 73740002
*                                                                       73800002
PMYSF    MVC   MICBECB(FOUR,GR5),KCODCON  POST COMPLETE                 73860002
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDR            73980002
         L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR.                 74040002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             74100000
         TM    ZERSAV,UNRECOV          ERRORS BESIDES I.R.              74160000
         BZ    NONTALL1                NO, CONTINUE                     74220000
         NI    ZERO(GR5),OFFERR        TURN OFF BIT 2                   74280000
         OI    ZERO(GR5),BIT1          TURN ON BIT 1                    74340000
*                                                                       74342002
NONTALL1 EQU   *                                                        74400000
         B     XIT0850                                                  74460000
*                                                                       74640000
*                                                                       74700000
HNDSIT3  L     CMICB,DCBWTOID          GET ADDR C MICB                  74760000
         L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR                  74820000
         TM    IOBSENS0,LATESS         LATE STACKER SELRCT, ,QQ  Y02072 74880002
         BZ    TESATX                  NO, TEST AUTO SELECT             74940000
         OI    THREE(GR5),SETLTSS      SET LATE STACKER BIT             75000002
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              75060000
*                                                                       75120000
TESATX   TM    IOBSENS0,AUTSEL         WAS DOCUMENT AUTO SELECTD Y02072 75180002
         BZ    NOWPS                   NO, POST AS COMPLETE             75240000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              75300000
         OI    TWO(GR5),SETAUTS        INDICATE AUTO SELECT             75360000
*                                                                       75362002
NOWPS    EQU   *                                                 Y02072 75420002
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED                  75480000
         BZ    XYPOST                  NO, POST MYSELF                  75540000
         L     CCREG,KCODCON           LOAD NORMAL COMPLETION CODE      75600000
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 75810002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 75900002
*                                                                       75930002
XYPOST   MVC   MICBECB(FOUR,CMICB),KCODCON  POST COMPLETION             75960002
         L     GR5,MICBNEXT(0,CMICB)   GET ADDR C+1 MICB                76020002
         L     GR5,MICBDATA(0,GR5)     GET ADDR C+1 BUFFER              76080000
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             76140000
         TM    ZERSAV,UNRECOV          ERRORS BESIDES I.R.              76200000
         BZ    NONTALL2                NO, CONTINUE                     76260000
         NI    ZERO(GR5),OFFERR        TURN OFF BIT 2                   76320000
         OI    ZERO(GR5),BIT1          TURN ON BIT1                     76380000
*                                                                       76382002
NONTALL2 EQU   *                                                        76440000
         B     XIT0850                 GET OUT                          76500000
         DROP  RQEREG                  DROP RQE BASE REGISTER    Y02072 76500402
         EJECT                                                          76500802
*********************************************************************** 76501002
*   THE FOLLOWING SUBROUTINE PLACES ENTRIES INTO THE 1419 TRACE TABLE.  76501102
*********************************************************************** 76501202
*                                                                       76501402
SIOTRAC  EQU   *                                                  41426 76501602
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 76501837
         DROP  BA12                    FORCE USE OF BASE REG 15   41426 76502537
         USING SIOENTER,BASE           SAVE REGS BEFORE USING 12  41426 76503237
         STM   0,15,KRESAV             STORE IOS REGISTERS        41426 76504002
         DROP  BASE                    RETURN TO BASE REG 12      41426 76505002
         USING PCIAPEN,BA12            RETURN TO BASE REG 12      41426 76506002
         LA    BA12,PCIAPEN-SIOENTER(0,BASE)  EST.                41426 76507002
*                                      ADDRESSIBILITY             41426 76508002
         MVI   WHAT,SIOENTRY           SET SWITCH                 41426 76509002
         MVI   WHICH,SIOENTRY          INDICATE SIO FOR TRACE  @ZA07621 76509237
         LR    RWRK1,RUCB              SAVE UCB ADDR           @ZA01360 76509402
         L     RUCB,DEBUCBAD(,DEBREG)  GET PRI UCB ADDR        @ZA07205 76523237
         BAL   RTRNREG,NRDYTST         SEE IF PRI IS READY     @ZA07205 76524237
         L     RUCB,DEBUCBAD+4(,DEBREG) GET SEC UCB ADDR       @ZA07205 76525237
         LA    RTRNREG,TRACIT          SET RETURN ADDR         @ZA07205 76526237
         BNZ   DEVNREDY                GO SET SEC NOT READY    @ZA07205 76527237
         L     RUCB,DEBUCBAD+4(,DEBREG) GET SEC UCB ADDR       @ZA07205 76529237
         BAL   RTRNREG,DEVREDY         GO SET SCU READY        @ZA07205 76531237
TRACIT   EQU   *                                               @ZA01360 76536402
         LR    RUCB,RWRK1              RESTORE UCB ADDRESS     @ZA01360 76536502
         BAL   TRACRET,TRACE           GO TRACE START I/O        Y02072 76536602
*                                                                       76543302
*                                                                       76550002
*********************************************************************** 76570002
*   THE FOLLOWING CODE RESTORES REGISTERS AND RETURNS TO EXCP.          76590002
*********************************************************************** 76610002
*                                                                       76630002
EXCPEXT2 EQU   *                                                 Y02072 76650002
         L     RTRNREG,KRESAV+OFFREG14  RESTORE RETURN ADDRESS   Y02072 76670002
*                                                                       76690002
EXCPEXIT EQU   *                                                 Y02072 76710002
         MODESET EXTKEY=SUPR           RETURN TO KEY 0           Y02072 76730002
         ST    RTRNREG,KRESAV+OFFREG14  UPDATE EXCP RETURN ADDR  Y02072 76750002
         LM    R0,R15,KRESAV           RESTORE EXCP'S REGISTERS  Y02072 76753037
         BR    RTRNREG                 RETURN TO EXCP            Y02072 76773037
*                                                                       76810002
EXCPEXT3 EQU   *                                                 Y02072 76812002
         TM    DCBAPPIN,UEX            WAS SCU CE DELAYED?       Y02072 76814002
         BZ    EXCPEXT1                YES RETURN TO EXCP        Y02072 76816002
         NI    DCBAPPIN,X'FF'-UEX      TURN OFF FLAG             Y02072 76818002
         L     IOBREG,DCBIOBAD         POINT TO PCU IOB        @ZA05562 76818437
         LA    IOBREG,IOBLN+EIGHT(,IOBREG) POINT TO SCU IOB    @ZA05562 76819237
         B     WHPCU010                NO - GO HANDLE            Y02072 76820002
EXCPEXT1 EQU   *                                                 Y02072 76830002
         L     RTRNREG,KRESAV+OFFREG14  RESTORE RETURN ADDRESS   Y02072 76850002
         LA    RTRNREG,4(,RTRNREG)     INCR TO SECND EXCP RTN PT Y02072 76870002
         B     EXCPEXIT                GO RETURN TO EXCP         Y02072 76890002
         EJECT                                                          76910002
*                                                                       76930002
TRACE    EQU   *                                                  41426 76950002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 76970002
         L     TTPTR,DCBIOBAD      POINTER TO PCU IOB            41426  77020002
         LA    TTPTR,TRCEDSP-IOBLN(TTPTR) INCREMENT POINTER TO @ZA00738 77030002
*                                       TRACETABLE               41426  77040002
         TM    DCBMRIND,DCBMRSCU   DOES DCB POINTTO SCU IOB    @ZA00738 77042002
         BNZ   SCUPTR              YES DONT INCREASE POINTER   @ZA00738 77044002
         LA    TTPTR,IOBLN(,TTPTR) INCR PAST SCU IOB           @ZA00738 77046002
SCUPTR   EQU   *                                               @ZA00738 77048002
         USING TRACETBL,TTPTR                                  @ZA07621 77048637
         LR    GR8,TTPTR           SAVE POINTER TO START OF TT @ZA07621 77049337
         SR    WORKA,WORKA             ZERO REGISTER              41426 77050002
         IC    WORKA,0(TTPTR)          LOAD INDEX VALUE           41426 77070002
         SRA   WORKA,ONE               ALIGN AS MULIIPLE OF 8     41426 77090002
         LA    TTPTR,TABLE(WORKA,TTPTR)  POSITION POINTER,NEXT    41426 77110002
*                                      ENTRY                      41426 77130002
         CLI   WHAT,PCIENTRY           TEST ENTRY SWITCH          41426 77150037
         BNE   NOTPCI                                             41426 77170037
         MVC   TRCMD,RQEPRT              STORE PROT KEY IN TABL@ZA07621 77190037
         MVC   TRCSW,IOBCSW                STORE CSW IN THE TBL@ZA07621 77210037
         B     ADD                                                41426 77230002
*                                                                       77250002
NOTPCI   CLI   WHAT,SIOENTRY           TEST ENTRY SWITCH          41426 77270002
         BNE   NOTSIO                                             41426 77290002
         L     WORKB,IOBSTART          GET POINTER TO FIRST CCW  Y02072 77310002
         MVC   TRCMD,0(WORKB)          STORE COMMAND CODE      @ZA07621 77330037
         MVC   TRUCB,KRESAV+29         STORE UCB ADDRESS       @ZA14595 77340037
         MVC   INITMICB-TRACETBL(3,GR8),DCBWTOIA  APPEND CMICB @ZA07621 77350037
         MVC   INITBUFF-TRACETBL(3,GR8),DCBIOBA+1 USERS CMICB  @ZA07621 77360037
         B     ADD                                                41426 77370037
*                                                                       77380037
NOTSIO   MVC   TRCSW,IOBCSW            STORE CSW FROM IOB TO TB@ZA07621 77390037
         MVC   TRSNS,IOBSENS0          STORE SENSE BYTE 0 IN TB@ZA07621 77400037
*                                                                       77410037
ADD      EQU   *                                               @ZA07621 77420037
         MVC   TRMRIND,DCBMRIND  TRACE MICR INDICATORS         @ZA07621 77430037
         MVC   TRDCB0,DCBWTOID+1 TRACE CURRENT MICB ADDRESS    @ZA07621 77440037
         MVC   TRAPPIN,DCBAPPIN  TRACE APPENDAGE INDICATOR     @ZA07621 77450037
         MVC   TRMRFG,DCBMRFG    TRACE MICR FLAG               @ZA07621 77460037
         MVC   TRWHICH,WHICH     TRACE WHICH APPENDAGE IS IN   @ZA07621 77470037
         MVC   TRCKAREA,CHECKARE TRACE CHECK AREA              @ZA07621 77480037
         LA    WORKA,SIXTEEN(WORKA)    INCREMENT INDEX BY ONE  @ZA07621 77490037
         SLA   WORKA,ONE               SHIFT OUT HIGH ORDER       41426 77500037
*                                      UNWANTED BIT               41426 77510037
         STC   WORKA,0(GR8)         STORE NEW INDEX VALUE      @ZA07621 77520037
         L     WORKA,KRESAV+28         REPLACE UCB POINTER IN     41426 77590002
*                                      REGISTER                   41426 77610002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 77630002
         MVI   WHAT,ZERO               RESET SWITCH              Y02072 77650002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 77670002
TRACEND  BR    TRACRET                 GO TO IN LINE CODE         41426 77690002
         EJECT                                                          77710002
*********************************************************************** 78600002
*   THE FOLLOWING SUBROUTINE IS USED TO POST THE ECB.  INPUT TO THIS    78700002
*   ROUTINE IS AS FOLLOWS:                                              78800002
*                                                                       78900002
*        REGISTER 1  - RQE ADDRESS                                      79000002
*        REGISTER 3  - DEB ADDRESS                                      79100002
*        REGISTER 5  - ADDRESS OF MICB CONTAINING ECB TO BE POSTED      79200002
*        REGISTER 10 - COMPLETION CODE TO BE POSTED IN THE ECB          79300002
*        REGISTER 14 - RETURN ADDRESS TO MAIN LINE CODE                 79400002
*                                                                       79500002
*   FOLLOWING ARE THE REGISTERS PASED TO THE POST ROUTINE:              79600002
*                                                                       79700002
*        REGISTER 10 - COMPLETION CODE TO BE POSTED IN THE ECB          79800002
*        REGISTER 11 - ECB TO BE POSTED                                 79900002
*        REGISTER 12 - TCB ADDRESS                                      80000002
*        REGISTER 14 - RETURN ADDRESS TO THIS SUBROUTINE                80100002
*        REGISTER 15 - ENTRY ADDRESS TO POST                            80200002
*                                                                       80300002
*   REGISTERS 12 AND 14 ARE RESTORED PRIOR TO RETURNING TO MAIN LINE    80400002
*   CODE.                                                               80500002
*********************************************************************** 80600002
*                                                                       80700002
POSTRTN  EQU   *                                                 Y02072 80800002
         LA    ECBADR,MICBECB(,RMICB)  GET ADDR OF ECB TO POST   Y02072 80900002
         OI    0(ECBADR),ZERO          PROG CHK IF NOT USER CORE Y02072 81000002
         L     R15,CVTPTR              GET ADDRESS OF THE CVT    Y02072 81100002
         L     R15,CVT0PT01-CVT(,R15)  GET ADDR OF POST ROUTINE  Y02072 81200002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 81300002
         ST    RTRNREG,RTRNSAVE        SAVE RETURN ADDRESS       Y02072 81400002
         DROP  BA12                    DROP MODULE BASE REGISTER Y02072 81500002
         L     BA12,DEBTCBAD(,DEBREG)  GET TCB ADDRESS           Y02072 81600002
         BALR  RTRNREG,R15             GO TO POST ECB            Y02072 81700002
         MODESET KEYADDR=RQEPRT,WORKREG=15  CHANGE TO USER'S KEY Y02072 81800002
         BALR  BA12,0                  TEMP BASE REG LOCATION    Y02072 81900002
         USING *,BA12                  EST SUBROUTINE BASE REG   Y02072 82000002
         L     BA12,KRESAV+OFFREG12    RESTORE MODULE BASE REG   Y02072 82100002
         DROP  BA12                    DROP SUBROUTINE BASE REG  Y02072 82200002
         USING PCIAPEN,BA12            RE-ESTABLISH MODULE BASE  Y02072 82300002
         L     RTRNREG,RTRNSAVE        RESTORE RETURN ADDRESS    Y02072 82400002
         BR    RTRNREG                 RETURN TO MAINLINE CODE   Y02072 82500002
         EJECT                                                          82600002
*********************************************************************** 82700002
*   THE FOLLOWING SUBROUTINE IS USED TO SET A DEVICE TO NOT READY.      82800002
*   INPUT TO THIS ROUTINE IS AS FOLLOWS:                                82900002
*                                                                       83000002
*        REGISTER 7  - UCB ADDRESS OF DEVICE TO BE MADE NOT READY       83100002
*        REGISTER 13 - EXCP SAVE AREA ADDRESS                           83200002
*********************************************************************** 83300002
*                                                                       83400002
DEVNREDY EQU   *                       SET DEVICE TO NOT READY   Y02072 83500002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 83600002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=ON,TABLE=UCBNRY,REG=COND   Y02072 83800037
         MODESET KEYADDR=RQEPRT,WORKREG=9  RETURN TO USER'S KEY  Y02072 83900002
         BR    RTRNREG                 RETURN TO CALLER          Y02072 84000002
NRDYTST  EQU   *                                               @ZA01360 84050002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0         @ZA01360 84060002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=TEST,TABLE=UCBNRY        @ZA01360 84070002
         MODESET KEYADDR=RQEPRT,WORKREG=9  RETURN TO USER KEY  @ZA01360 84080002
         BR    RTRNREG                 RETURN TO CALLER        @ZA01360 84090002
DEVREDY  EQU   *                                               @ZA01360 84092002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0         @ZA01360 84094002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=OFF,TABLE=UCBNRY         @ZA04948 84096037
         MODESET KEYADDR=RQEPRT,WORKREG=9  RETURN TO USER KEY  @ZA01360 84098002
         BR    RTRNREG                 RETURN TO CALLER        @ZA01360 84098402
         EJECT                                                          84100002
*********************************************************************** 84200002
*   EQUATES FOR BRANCH TABLE AT BEGINNING OF THIS MODULE                84300002
*********************************************************************** 84400002
*                                                                       84500002
CHANDIS  EQU   CEAPEN-CHANEND                                           84600002
ABNDIS   EQU   AEAPEN-ABNEND                                            84700002
SIODIS   EQU   SIOTRAC-SIOENTER                                   41426 84900002
*                                                                       88924002
*                                                                       88926002
*********************************************************************** 88928002
*   THE FOLLOWING ARE CONSTANTS AND WORKAREAS USED BY THE APPENDAGES    88980002
*********************************************************************** 88982002
*                                                                       89040000
         DS    0D                      FOR ALIGNMENT                    89160002
*                                                                       89820000
CSAV     DC    F'0'                    SAVE AREA FOR CMICB              89880000
RTRNSAVE DC    F'0'                    POST RETRN ADDR SAVE AREA Y02072 89884002
KRESAV   DS    16F                     FOR SAVING SUPVS REGISTERS       89940002
*                                                                       90000000
KCODCON  DC    0F'0',X'7F000000'       SUCCESSFUL COMPLETION CDE Y02072 90060002
KPCUER   DC    0F'0',X'41000000'       ERROR COMPLETION CODE     Y02072 90062002
KSCUER   DC    0F'0',X'41000001'       SCU ERROR COMPLETION CODE Y02072 90064002
*                                                                       90180000
FORTY8   DC    F'48'                   CONSTANT OF 48                   90182002
ZEROS    DC    H'0'                    CONSTANT OF ZERO        @ZA04944 90182537
K24      DC    H'24'                   CONSTANT OF 24          @ZA03940 90183037
DUMSENS  DC    X'10FE'                 DUMMY SENSE FROM IOS    @ZA11089 90183537
KEIGHT   DC    H'8'                    CONSTANT OF 8                    90184002
KNINE    DC    H'9'                    CONSTANT NINE                    90186002
KTEN     DC    H'10'                   CONSTANT OF 10                   90188002
KELEVN   DC    H'11'                   CONSTANT 11                      90190002
H32CON   DC    H'32'                   TO DECREMENT BUFF COUNTER        90192002
*                                                                       90194002
CLR      XC    0(0,GR5),0(GR5)         EXECUTED FOR ZEROING BUFFERS     90196002
*                                                                       90198002
WHAT     DC    X'00'                   CODE, TYPE ENTRY FROM IOS  41426 90210002
WHICH    DC    X'00'                   INDICATES WHICH APPENDAGE        90240002
CHECKARE DC    X'00'                   FOR ISOLATING SITUATION          90300000
*                                      IS EXECUTING AT ANY GIVEN TIME   90360002
ZERSAV   DC    X'00'                   FOR SAVING BUFFER STATUS         91260000
SVC13    DC    X'0A0D'                 USED TO CHECK FOR SVC 13  Y02072 91262002
*                                                                       91264002
MODID    DC    C'IGG019V5'             MODULE NAME             @ZA07621 91284037
DATE     DC    CL8'&SYSDATE'           COMPILATION DATE        @ZA07621 91293037
FIX      DC    C'OZ33842'              LATEST FIX              @ZA11089 91302037
PATCH    DC    XL((*-IGG019V5)/20)'0'  5% PATCH AREA           @ZA14706 91311037
         EJECT                                                          91323302
*********************************************************************** 91324002
*   CONTROL BLOCK DEFINITIONS                                           91380002
*********************************************************************** 91382002
*                                                                       91384002
**       TRACE TABLE DSECT                                     @ZA07621 91384137
*                                                              @ZA07621 91384237
TRACETBL DSECT                                                 @ZA07621 91384337
*TRACE TABLE HEADER CONTAINS INDEX TO CURRENT ENTRY AND THE    @ZA07621 91384437
* CONTENTS OF DCB PLUS 0 AND PLUS 44 AT SIO TIME               @ZA07621 91384537
TRINDEX  DS    0BL4              FOUR BITS FOR INDEX TO CURR   @ZA07621 91384637
         DS    CL1                                             @ZA07621 91384737
INITMICB DS    CL3               CONTENTS OF DCB +0 FOR SIO    @ZA07621 91384837
         DS    CL1                                             @ZA07621 91384937
INITBUFF DS    CL3               CONTENTS OF DCB +44 FOR SIO   @ZA07621 91385037
*                                                              @ZA07621 91385137
         ORG   TRACETBL                                        @ZA07621 91385237
* THE FOLLOWING ARE THE SIXTEEN BYTE ENTRIES FOR EACH OF THE   @ZA07621 91385337
*  APPENDAGES                                                  @ZA07621 91385437
*                                                              @ZA07621 91385537
TRCMD    DS    0CL1              COMMAND CODE FOR SIO TRACE    @ZA07621 91385637
TRSNS    DS    CL1           SENSE BYTE ZERO FOR ABNORMAL END  @ZA07621 91385737
TRCSW    DS    0CL7          CSW FOR PCI ABEND AND CHAN END    @ZA07621 91385837
         DS    CL4                                             @ZA07621 91385937
TRUCB    DS    CL3               UCB ADDR OF DEV BEING STARTED @ZA07621 91386037
TRMRIND  DS    CL1               DCBMRIND                      @ZA07621 91386137
TRDCB0   DS    0CL3              CURR CONTENTS OF DCB PLUS 0   @ZA07621 91386237
TRCMICB  DS    CL3               CURENT MICB                   @ZA07621 91386337
TRAPPIN  DS    CL1               DCB APPENDAGE INDICATOR       @ZA07621 91386437
TRDCB44  DS    0CL3              CURR CONTENTS OF DCBPLUS 44   @ZA07621 91386537
TRMRFG   DS    CL1               DCB MICR FLAG                 @ZA07621 91386637
TRWHICH  DS    CL1               WHICH APPENDAGE IS IN CONTROL @ZA07621 91386737
TRCKAREA DS    CL1               BUFFER STATUS INDICATOR       @ZA07621 91386837
*                                                              @ZA07621 91386937
*                                                              @ZA07621 91387037
*                                                              @ZA07621 91387137
         IEZBITS                                                 Y02072 91387237
         IHAASVT                                                 Y02072 91387437
         EJECT                                                          91387637
         CVT   DSECT=YES                                         Y02072 91388802
         SPACE 3                                                        91390002
         DCBD  DSORG=BS,DEVD=MR                                         91440000
         EJECT                                                          91500002
         IEZIOB                                                  Y02072 91620002
         EJECT                                                          91622002
         IECDIOCM                                                Y02072 91624002
         EJECT                                                          91626002
         IECDIOSB                                                Y02072 91628002
         EJECT                                                          93182002
         IECDRQE                                                 Y02072 93192002
         EJECT                                                          93192402
         IHASRB                                                  Y02072 93192802
         EJECT                                                          93194002
UCB      DSECT                                                   Y02072 93200002
         IEFUCBOB                                                Y02072 93202002
         END                                                            93240037
./  ADD  SSI=61420007,NAME=IGG0197C
         TITLE 'IGG0197C - IOB-MICB-CCW CONSTRUCTION'                   00100000
IGG0197C CSECT                                                          01100000
         SPACE                                                          01100402
*********************************************************************** 03600000
*                                                                     * 03800000
* MODULE NAME - IGG0197C                                              * 03800402
*                                                                     * 03800802
* DESCRIPTIVE NAME - MICR PROCESSOR FOR IOB'S, MICB'S, AND CCW'S      * 03801202
*                                                                     * 03801602
* COPYRIGHT - NONE                                                    * 03802002
*                                                                     * 03802402
* CHANGE ACTIVITY - AS FOLLOWS:                                       * 03802802
*                                                                     * 03803202
*          RELEASE 21 DELETIONS                                       * 03803602
*0000384000                                                      A41426 03804002
*0000232000                                                      A48612 03804402
*                                                                     * 03804802
*          VS2 RELEASE 02 DELETIONS                                   * 03805202
*D152000-154000,168000,178000,283200,320000,346000-347000,360000,Y02072 03805602
*D383000,412000,422000,456000,660000,722000-724000,750000-768000,Y02072 03806002
*D772000-778000,806000-808000                                    Y02072 03806402
*                                                              @ZA07621 03826403
*          VS2 RELEASE 04.0 CHANGES                            @ZA07621 03846403
*C770004                                                       @ZA07621 03866403
*                                                                     * 03900002
*                                                                     * 03900402
* STATUS - VS2 RELEASE 2 LEVEL 0                                      * 03900802
*                                                                     * 03901202
*                                                                     * 03901602
* FUNCTION/OPERATION - THIS ROUTINE SUPPLEMENTS THE INITIAL OPEN      * 04000002
*      ROUTINE BY PERFORMING SPECIFIC FUNCTIONS FOR THE MAGNETIC      * 04200000
*      INK CHARACTER READER PROCESSING.                               * 04400000
*      IT DETERMINES THE AMOUNT OF SPACE REQUIRED FOR THE IOB'S AND   * 04600000
*      MAGNETIC CHARACTER READER INTERRUPT CONTROL BLOCKS (MICB) AND  * 04800000
*      ISSUES A GETMAIN FOR THE MAIN STORAGE.  THE IOB'S AND MICB'S   * 05000000
*      ARE INITIALIZED WITH AS MUCH INFORMATION AS AVAILABLE.         * 05200000
*      THE AMOUNT OF SPACE REQUIRED FOR THE CCW'S, WRITE DELAY        * 05400000
*      BUFFERS, AND AN ECB PARAMETER LIST IS DETERMINED AND A         * 05600000
*      GETMAIN ISSUED FOR THE SPACE. THESE FIELDS ARE INITIALIZED     * 05800000
*      OR BUILT WITH THEIR REQUIRED DATA.                             * 06000000
*      THE PROCESSING OF THIS ROUTINE IS REPEATED UNTIL ALL THE       * 06200000
*      DCB'S IN THE PARAMETER LIST ARE EXHAUSTED.                     * 06400002
*                                                                     * 06600000
*                                                                     * 06800000
* ENTRY POINT-  THIS ROUTINE IS ENTERED AT THE CSECT IGG0197C         * 07200002
*                                                                     * 07400000
*                                                                     * 07600000
* INPUT - REGISTER 5 - ADDRESS OF THE DCB PARAMETER LIST              * 07800002
*         REGISTER 6 - ADDRESS OF THE WHERE-TO-GO TABLE               * 08000002
*         REGISTER 7 - ADDR OF CURRENT ENTRY IN DCB PARAMETER LIST    * 08200002
*         REGISTER 8 - ADDR OF CURRENT ENTRY IN WHERE-TO-GO TABLE     * 08200402
*                                                                     * 08400000
*                                                                     * 08600000
* OUTPUT - OUTPUT IS AS FOLLOWS:                                      * 08800002
*                                                                     * 09200000
*      1. IOB'S, MICB'S, CCW'S, WRITE DELAY BUFFERS, AND ECB LIST.    * 09400000
*                                                                     * 09600000
*      2. THE BLOCKS AND FIELDS LISTED ABOVE ARE INITIALIZED.         * 09800000
*                                                                     * 10000000
*                                                                     * 10200000
* EXTERNAL ROUTINES - NONE                                            * 10400002
*                                                                     * 10400402
*                                                                     * 10600000
* EXITS-NORMAL - XTCL TO IGG0197D                                     * 10800002
*                                                                     * 11000000
* EXITS-ERROR - NONE                                                  * 11200002
*                                                                     * 11400000
*                                                                     * 11600000
* TABLES/WORK AREAS - WHERE-TO-GO TABLE AND THE OPEN WORK AREA        * 11800002
*                                                                     * 12000000
*                                                                     * 12000402
* MACROS-ACTION - MODESET, GETMAIN, GETBUF, XCTL                      * 12000802
*                                                                     * 12001202
* MACROS-MAPPING - CVT, DCBD, IECDSECT, IEFUCBOB                      * 12001602
*                                                                     * 12002002
*                                                                     * 12002402
* ATTRIBUTES - REENTRANT, REUSABLE, RUNS IN USER'S KEY OR DATA        * 12200002
*              MAMAGEMENT KEY.                                        * 12200802
*                                                                     * 12400000
*********************************************************************** 13200000
         EJECT                                                          13400000
****                                                                    13600002
****     REGISTER CONVENTIONS                                           13800002
****                                                                    14000002
R0       EQU   0         WORK/PARAMETER  REGISTER                       14200000
R1       EQU   1         WORK/PARAMETER  REGISTER                       14400000
DCBREG   EQU   2         ADDR OF DCB                                    14600000
BASEREG  EQU   3         BASE REGISTER                                  14800000
RCORE    EQU   4         WORK AREA ADDRESS                              15000000
RPAR     EQU   5         TOP OF DCB PARAMETER LIST                      15600002
RWTG     EQU   6         TOP OF WTG TABLE                               15800000
RPARC    EQU   7         CURRENT PARAMETER                              16000000
RWTGC    EQU   8         CURRENT TRANS LOAD                             16200000
R9       EQU   9         WORK REG                                       16600000
R10      EQU   10        WORK REG                                       17000000
RWRK1    EQU   R10       WORK REGISTER                           Y02072 17000402
IOBREG   EQU   11        ADDR OF IOB                                    17200000
R12      EQU   12        WORK REG                                       17400000
DEBREG   EQU   R12       ADDRESS OF THE DEB                             17400402
R13      EQU   13        WORK REG                                       17600000
R14      EQU   14        WORK REG                                       17700000
R15      EQU   15        WORK/PARAMETER REGISTER                        18000000
         SPACE 2                                                        18200002
****                                                                    18200402
****     MASKS, DISPLACEMENTS, AND OTHER EQUATES                        18200802
****                                                                    18201202
TWO      EQU   2         VALUE OF 2                                     18400000
ECBLEN   EQU   64        LENGTH OF ECB'S                                18600000
WDBUFL   EQU   64        LENGTH OF WRITE DELAY BUFFER                   18800000
POCKETL  EQU   X'F7'     POCKET LITE COMMAND                            19000000
WD       EQU   X'E1'     WRITE DELAY COMMAND                            19200000
TIC      EQU   X'08'     TIC                                            19400000
MODRD    EQU   X'4C'     MODIFIED READ COMMAND                          19600000
MODS     EQU   X'24'     MODIFIED SENSE COMMAND                         19800000
CCPCI    EQU   X'68'     CMD CHN AND PCI FLAGS                          20000000
ONE      EQU   1         FOR GENERAL USE                                20200000
CC       EQU   X'60'     COMMAND CHAIN FLAG                             20400000
SLI      EQU   X'20'     SUPPRESS WRONG LENGTH FLAG                     20600002
NOP      EQU   X'03'     NOP COMMAND                                    20800000
DELAYL   EQU   128       LENGTH OF WRITE DELAY BUFFERS                  21000000
CCWLENGS EQU   8*10+8*9  LENGTH OF CCW'S                                21200000
LENIOB   EQU   48+48     LENGTH OF PCU AND SCU IOBS                     21400002
LENTRACE EQU   136       TACE TABLE LENGTH                        41426 21500002
MICBLEN  EQU   28        LENGTH OF MICB                                 21600000
CCUNREL  EQU   X'42'     IOB FLAGS                                      22800002
DEBSUBID EQU   X'30'     DISP TO STACKER NAME                    A48612 23200002
SCUIOBXT EQU   88        EXTENT NUM FOR SCU IOB                         24000002
PIOBFLG  EQU   8         DISP TO PCU IOB FLAGS                          24500002
SIOBFLG  EQU   56        DISP TO SCU IOB FLAGS                          24800002
PIOBDCB  EQU   20        DISP TO PCU IOB DCB ADDR                       25200002
SIOBDCB  EQU   68        DISP TO SCU IOB  DCB ADDR                      25600002
PIOBLEN  EQU   40        LENGTH OF IOB                                  25800000
SIOBLEN  EQU   48        LENGTH OF SCU IOB+PREFIX                       26000002
FLAGMICB EQU   8         DISP TO MICB FLAGS                             26200000
NM1MICB  EQU   20        DISP IN MICB TO ADDR OF PREVIOUS MICB          26400002
MICBM7AD EQU   16        DISP IN MICB TO N-7 MICB                       26600002
PIOBCCW  EQU   16        DISP TO PCU CCW CHAIN ADDR IN PCU IOB          26800002
PCCWAD   EQU   17        DISP TO PCU CCW CHAIN ADDR IN PCU IOB          27000002
SIOBCCW  EQU   64        DISP TO SCU CCW CHAIN ADDR IN SCU IOB          27200002
SCCWLEN  EQU   8*9       LENGTH OF SCU CCW CHAIN                        27400000
SCCWAD   EQU   65        DISP TO SCU CCW ADDR                           27600000
SUREA    EQU   72        SAVE AREA LENGTH                               27660000
COMND    EQU   0         DISP TO COMMAND IN CCW                         27720002
CHAIN    EQU   4         DISP TO COMMAND CHAIN IN CCW                   27780002
COUNT    EQU   7         DISP TO COUNT IN CCW                           27840002
CCWL     EQU   8         CCW LENGTH                                     27900002
COUNT1   EQU   6         DISP TO COUNT IN CCW                           27960002
ADDR     EQU   1         DISP TO DATA ADDR IN CCW                       28020002
ADDRL    EQU   3         LENGTH OF ADDR IN BYTES                        28080002
XFF      EQU   X'FF'     X'FF'                                          28140000
BUFF     EQU   0         DISP TO START OF WRITE DELAY BUFFERS           28200000
IDTTR    EQU   0         DISP TO IDTTRL IN WTG RABLE                    28260002
EQ       EQU   8         BRANCH EQUAL VALUE                             28380002
ID       EQU   0         DISP TO ID IN WTG TABLE                        28440002
IDL      EQU   2         LENGTH OF ID                                   28500002
NEQ      EQU   7         BRANCH NOT EQUAL VALUE                         28560002
X00      EQU   X'00'     HEX ZERO                                       28620002
WTGID    EQU   6         DISP TO ID IN WTG TABLE                        28680002
WTGTTR   EQU   14        DISP TO TTR IN WTG                             28740002
TTRL     EQU   3         LENGTH OF TTR                                  28800002
DCBADDR  EQU   0         DISP TO DCB ADDR IN DCB LIST                   28860002
WORKADDR EQU   4         DISP TO WORK ADDR IN WTG TABLE                 28920002
SSLEN    EQU   8         NUM CHAR IN STACKER SELECT NAME                28980002
IOBSTRT  EQU   0         DISP TO START OF IOB'S                         29040002
ECBADR   EQU   4         DISP TO ECB ADDR IN IOB                        29100002
ECBADDR  EQU   12        DISP TO ECB ADDR IN IOB                        29160002
MICBSTRT EQU   0         DISP TO NEXT MICB ADDR IN A MICB               29220002
CCWLOOP  EQU   3         CCW LOOP COUNTER                               29280002
CCWSTRT  EQU   0         DISP TO START OF CCW                           29340002
WAOFF    EQU   32        OFFSET OF FIRST ENTRY IN WTG TABLE             29600002
PLOFF    EQU   4         OFFSET OF DCB ENTRIES                          29800002
WGOFF    EQU   8         OFFSET OF WTG ENTRIES                          30000002
         EJECT                                                          30200000
OPENM2   BALR  BASEREG,R0          SET BASE                             31400002
         USING *,BASEREG                                                31600000
         USING DSECT,RCORE                                              31800000
         USING IHADCB,DCBREG                                            32200000
         L     DCBREG,DCBADDR(RPARC)  LOAD DCB ADDR                     32260002
         L     RCORE,WORKADDR(RWTGC)  LOAD WORK AREA ADDR               32320002
         SPACE 2                                                        32400002
*********************************************************************** 32440000
*                                                                     * 32480000
*        GET CORE FOR 2 IOB'S.  THERE IS 1 IOB FOR THE PCU AND        * 32520000
*        1 IOB FOR THE SCU.  EACH IOB IS 48 BYTES LONG.               * 32560000
*        AN 8 BYTE PREFIX AND 40 BYTE BASIC SECTION.                  * 32600000
*                                                                     * 32640000
*        THERE IS 1 MICB FOR EACH BUFFER.  EACH MICB IS 28 BYTES LONG.* 32680000
*                                                                     * 32720000
         L     DEBREG,DCBDEBAD     LOAD DEB ADDR                        32800000
         MVC   DEBSUBID(SSLEN,DEBREG),DCBSSID PLACE STACKER S IN DEB    33000000
*        GET CORE FOR MICBS AND IOBS                                    33200000
         SR    R12,R12             LOAD NUM OF BUFFERS                  33400000
         IC    R12,DCBBUFNO                                             33600000
         LA    R13,MICBLEN         LOAD LENGTH OF MICB                  33800000
         MR    R12,R12             GET LENGTH OF MICBS                  34000000
         LA    R13,LENIOB+SUREA+LENTRACE(R13) CALC CORE REQUIRED Y02072 34200002
*                                  FOR PCU AND SCU IOB'S, SAVE   Y02072 34202002
*                                  AREA, AND TRACE TABLE         Y02072 34204002
         MVI   DCBIOBL,PIOBLEN                                          34400000
         MODESET KEYADDR=DXUKEY,WORKREG=1  CHANGE TO USER'S KEY  Y02072 34402002
         BAL   R12,GETMAIN         GET CORE FOR MICBS AND IOBS          34800000
         LR    R9,R1                                                    35000002
         XC    IOBSTRT(LENIOB,R9),IOBSTRT(R9)  ZERO IOB'S               35200002
         OI    SCUIOBXT(R1),X'01'  SET EXTENT NUMBER                    35400000
         OI    PIOBFLG(R1),CCUNREL SET COMMAND CHAIN AND UNRELATED      35600002
         OI    SIOBFLG(R1),CCUNREL SET COMMAND CHAIN AND UNRELATED      35800002
         ST    R9,IOBSTRT(R1)      PLACE PREFIX ADDR IN PREFIX          36200002
         LA    R9,ECBADR(R9)       INC TO ECB ADDR                      36400002
         ST    R9,ECBADDR(R1)      PLACE ECB ADDR IN PCU IOB            36600002
         LA    R9,ECBADR(R9)       INCR PAST PREFIX                     36800002
         LR    IOBREG,R9           LOAD IOB  REG                        37200002
         L     RWRK1,DXUDCBAD      GET ADDR OF USER'S DCB        Y02072 37202002
         ST    RWRK1,PIOBDCB(IOBREG)  PLACE DCB ADDR IN PIOB     Y02072 37400002
         ST    RWRK1,SIOBDCB(IOBREG)  PLACE DCB ADDR IN SIOB     Y02072 37600002
         LA    R9,PIOBLEN(R9)      INCR TO ADDR OF SCU IOB              37800002
         ST    R9,IOBSTRT(R9)      PLACE PREFIX ADDR IN SCU IOB PREFIX  37900002
         LA    R13,ECBADR(R9)      LOAD SCU ECB ADDR                    38000002
         ST    R13,ECBADDR(R9)     PLACE SCU ECB ADDR IN SCU IOB        38100002
         LA    R9,SIOBLEN+SUREA(R9)  INCR PAST PCU AND SCU       Y02072 38200002
*                                  IOB'S AND SAVE AREA           Y02072 38202002
         XC    0(LENTRACE,R9),0(R9)  ZERO TRACE TABLE             41426 38400002
         LA    R9,LENTRACE(R9)     INCR TO FIRST MICB             41426 38500002
         MODESET EXTKEY=DATAMGT    CHANGE TO DATA MGMNT KEY      Y02072 38500402
         ST    R1,DCBIOBAD         PLACE ADDR OF IOB IN PCU DCB  Y02072 38502002
         LR    R1,R9                                                    38600002
         USING MICBENTR,R1         ESTABLISH BASE FOR MICB       Y02072 38600402
         ST    R9,DCBIOBA          INSERT IN DCB                        38800002
         MODESET KEYADDR=DXUKEY,WORKREG=10 CHANGE TO USER'S KEY  Y02072 38802002
         SR    R13,R13                                                  39000000
         IC    R13,DCBBUFNO        LOAD COUNTER                         39200000
         LA    R12,MICBLEN-1       LOAD LENGTH OF MICB           Y02072 39400002
         EX    R12,CLEARBUF        ZERO FIRST MICB                      39600000
         OI    FLAGMICB(R9),X'80'  SET BUFFER REFERENCED                39800002
         LR    R15,R13             LOAD N-6 COUNTER                     40000000
         SH    R15,NUMMIN7                                              40200000
         LA    R15,ONE(R15)                                             40400000
CLRMICB  LA    R9,ONE(R12,R9)      INCR TO NEXT MICB             Y02072 40600002
         ST    R9,MICBNEXT         PLACE ADDR  NEXT    MICB IN PRESENT  40800002
         BCTR  R15,R0              DECR N-7 CNTR                        41000000
         BCT   R13,X               DECREMENT LOOP COUNTER               41400002
         B     XSR                 CNTR ZERO-GET OUT                    41600002
X        EQU   *                                                        41800000
         EX    R12,CLEARBUF        ZERO A MICB                          42000000
         ST    R1,NM1MICB(R9)      PLACE ADDR PREVIOUS MICB IN PRESENT  42400002
         LTR   R15,R15             IS THIS THE N-7 MICB FROM START      42600000
         BNZ   SETDISEN            NO, DO NOT SET DISEN SWITCH          42800000
         OI    FLAGMICB(R9),X'40'  SET DISEN BIT IN MICB                43000002
SETDISEN LA    R1,ONE(R12,R1)      INCR PTR TO N-1 MICB          Y02072 43200002
         B     CLRMICB             LOOP TILL ALL MICB CLEARED           43400002
XSR      EQU   *                                                        43600000
         LA    R12,ONE(R12)        INCR TO MICB LENGTH                  43800000
         SR    R9,R12              GET ADDR LAST MICB                   44000002
         L     R1,DCBIOBA          GET ADDR FIRST MICB                  44200002
         ST    R1,MICBSTRT(R9)     PLACE NEXT MICB ADDR IN LAST MICB    44400002
         ST    R9,MICBNM1          PLACE ADDR PREVIOUS MICB IN          44600002
*                                  FIRST MICB                           44602002
         EJECT                                                          44800000
*                                                                       45000000
*        PLACE ADDR OF N-7 MICB IN EACH MICB AND ZERO THE BUFFER        45200000
*                                                                       45400000
         LR    R13,R12                                                  45800000
         LH    R15,DCBBUFL         LOAD BUFFER LENGTH FOR EX            46000002
         BCTR  R15,0               GET MACHINE LENGTH                   46200002
         LR    R10,R9              PLACE ADDR LAST MICB IN REG          46400002
         MH    R13,NUMMIN7         CALC DISP TO 7TH MICB                46600000
         AR    R13,R1              GET ADDR OF 7TH MICB                 46800000
GETBUF   LR     R0,R1              SAVE REG 1                           47000002
         GETBUF (DCBREG),R9        GET A BUFFER                         47200002
         LTR   R9,R9               LAST BUFFER                          47400002
         BZ    BUFDONE             YES, GET OUT                         47600000
         LR    R1,R0               RESTORE REG 1                        47800002
         EX    R15,CLEARBUF        SET BUFFER TO ZERO                   48000002
         ST    R9,MICBDATA         PLACE BUFFER ADDR IN MICB            48200002
         ST    R1,MICBM7AD(R13)    PLACE ADDR OF  MICB  7 BACK FROM     48400000
*                                  PRESENT MICB                         48600000
         AR    R1,R12              INCR TO NEXT MICB                    48800000
         AR    R13,R12             INCR TO NEXT MICB                    49000000
         CR    R13,R10             IS THIS HIGHEST MICB                 49200000
         BH    RESETR13            YES, RESET TO FIRST MICB             49400000
         B     GETBUF              NO, PROCESS NEXT MICB                49600000
RESETR13 L     R13,MICBSTRT(R10)   LOAD ADDR FIRST MICB                 49800000
         B     GETBUF              PROCESS NEXT MICB                    50000000
         EJECT                                                          50200000
*********************************************************************** 50230000
*                                                                     * 50260000
*        GET CORE FOR PCU AND SCU CCW CHAINS.                         * 50290000
*                                                                     * 50320000
*        GET CORE FOR 2 WRITE DELAY BUFFERS.                          * 50350000
*                                                                     * 50380000
*        GET CORE FOR AN ECB LIST.                                    * 50410000
*                                                                     * 50440000
*********************************************************************** 50470000
*                                                                       50500000
BUFDONE  EQU   *                                                        50530000
         LA    R13,CCWLENGS        LOAD LENGTH OF CCW                   50600000
         LA    R13,DELAYL(R13)     ADD LENGTH OF WRITE DELAY BUFFERS    50800000
         LA    R13,ECBLEN(R13)                                          51000000
         BAL   R12,GETMAIN         GET CORE FOR CCW'S                   51200000
         LA    R15,CCWLOOP         LOAD LOOP CNTR FOR PCU CCW'S         51400000
         ST    R1,PIOBCCW(IOBREG)  PLACE ADDR CCW IN IOB                51600002
         XC    CCWSTRT(CCWLENGS,R1),CCWSTRT(R1)   ZERO CCWS             51800000
         LH    R9,DCBLRECL         LOAD RECORD SIZE                     52000002
*    BUILD NOP                                                          52200000
BUILDCCW MVI   COMND(R1),NOP       SET COMMAND                          52400000
         MVI   CHAIN(R1),CC        SET COMMAND CHAIN                    52600000
         MVI   COUNT(R1),ONE       SET COUNT                            52800000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      53000000
*       BUILD MODIFIED READ                                             53200000
         MVI   COMND(R1),MODRD     SET COMMAND                          53400000
         MVI   CHAIN(R1),CC        SET COMMAND CHAIN                    53600000
         STH   R9,COUNT1(R1)       SET CONUT                            53800002
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      54000000
*       BUILD MODIFIED SENSE                                            54200000
         MVI   COMND(R1),MODS      SET COMMAND                          54400000
         MVI   CHAIN(R1),CC        SET COMMAND CHAIN                    54600000
         MVI   COUNT(R1),TWO       SET COUNT                            54800000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      55000000
         BCT   R15,BUILDCCW        LOOP TILL DONE                       55200000
*       BUILD TIC                                                       55400000
         MVI   COMND(R1),TIC       SET COMMAND                          55600000
         MVI   COUNT(R1),ONE       SET COUNT                            55800000
         MVC   ADDR(ADDRL,R1),PCCWAD(IOBREG)  SET DATA ADDR             56000000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      56200000
*                                                                       56400000
*        PLACE SCU CCW ADDR IN IOB AND BUILD SCU CCW'S                  56600000
*                                                                       56800000
         LA    R13,TWO             LOOP COUNTER FOR SCU CCWS            57000000
         ST    R1,SIOBCCW(IOBREG)  PLACE SCU CCW ADDR IN SCU IOB        57200002
         LR    R15,R1                                                   57400000
         LA    R15,SCCWLEN(R15)    POINT TO FIRST WRITE DELAY BUFFER    57600002
*    BUILD MODIFIED SENSE                                               57800000
BUILDSCW MVI   COMND(R1),MODS      SET COMMAND                          58000000
         MVI   CHAIN(R1),CC        SET COMMAND CHAIN                    58200000
         MVI   COUNT(R1),ONE       SET COUNT                            58400000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      58600000
*       BUILD WRITE DELAY COMMAND                                       58800000
         ST    R15,COMND(R1)       SET DATA ADDR                        59000000
         MVI   COMND(R1),WD        SET COMMAND                          59200000
         MVI   CHAIN(R1),CCPCI     SET COMMAND CHAIN AND PCI FLAGS      59400000
         MVI   COUNT(R1),WDBUFL    SET COUNT                            59600000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      59800000
         LA    R15,WDBUFL(R15)     UPDATE TO SECOND WRITE DELAY BUFFER  60000000
*       BUILD NOP                                                       60200000
         MVI   COMND(R1),NOP       SET COMMAND                          60400000
         MVI   CHAIN(R1),CC        SET COMMAND CHAIN                    60600000
         MVI   COUNT(R1),ONE       SET COUNT                            60800000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      61000000
         BCT   R13,BUILDSCW        BUILD SECOND SWT OF CCW'S            61200000
*       BUILD TIC                                                       61400000
         MVI   COMND(R1),TIC       SET COMMAND                          61600000
         MVI   COUNT(R1),ONE       SET COUNT                            61800000
         MVC   ADDR(ADDRL,R1),SCCWAD(IOBREG) SET DATA ADDR              62000000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      62200000
*       BUILD POCKET LITE COMMAND                                       62400000
         MVI   COMND(R1),POCKETL   SET COMMAND                          62600000
         MVI   CHAIN(R1),CC        SET COMMAND CHAIN                    62800000
         MVI   COUNT(R1),ONE       SET COUNT                            63000000
         LA    R1,CCWL(R1)         UPDATE CCW ADDR                      63200000
*       BUILD STACKER SELECT COMMAND                                    63400000
         MVI   COUNT(R1),ONE       SET COUNT                            63600000
         MVI   CHAIN(R1),SLI       SET SUPPRESS WRONG LENGTH            63800000
         LA    R1,CCWL(R1)         UPDATE CCW ADDDR                     64000000
*       SET WRITE DELAY BUFFERS TO X'FF'                                64200000
         OI    BUFF(R1),XFF        SET X'FF'                            64400000
         MVC   BUFF+1(DELAYL-1,R1),BUFF(R1)  PROPAGATE FF'S             64600000
         LA    R1,DELAYL(R1)       UPDATE TO ECB'S                      64800000
         MODESET EXTKEY=DATAMGT    CHANGE TO DATA MGMNT KEY      Y02072 64802002
         ST    R1,DCBECBLT         PLACE ADDR OF ECB LIST IN DCB        65000000
*                                                                       65200000
*                                                                       65400000
         MVC   IDTTR(L'SOP7D,RWTGC),SOP7D  SET ID FOR NEXT LOAD  Y02072 65600002
*                                  USED BY THIS DCB              Y02072 65800002
*                                                                       66200000
*                                                                       66400000
RELOOP   EQU   *                                                        66600000
         LA    RWTGC,WGOFF(0,RWTGC)  INCR CURRENT WTG ENTRY             66800002
         LA    RPARC,PLOFF(0,RPARC)  INCR CURRENT DCB ENTRY             67000002
         CLC   ID(IDL,RWTGC),AMIDCNST  IS THIS RTN NEEDED AGAIN         67200000
         BCR   EQ,BASEREG          YES, BRANCH                          67400002
*                                                                       67600000
*                                                                       67800000
*                                                                       68000000
         CLC   ID(IDL,RWTGC),OPIDCNST  IS THIS END OF TABLE             68200002
         BC    NEQ,RELOOP          NO, BRANCH                           68400002
*                                                                       68600000
*                                                                       68800000
         LR    RPARC,RPAR          REINITIALIZE DCB LIST PTR            69000000
         LA    RWTGC,WAOFF(0,RWTG) REINITIALIZE WTG LIST PTR            69200000
*                                                                       69400000
*                                                                       69600000
RELOOP1  EQU   *                                                        69800000
         CLI   ID(RWTGC),X00       IS THIS ENTRY COMPLETE               70000000
         BC    NEQ,XCTLRTN         NO, BRANCH                           70200000
*                                                                       70400000
*                                                                       70600000
         LA    RWTGC,WGOFF(0,RWTGC) GET NEXT WTG ENTRY                  70800000
         LA    RPARC,PLOFF(0,RPARC) GET NEXT DCB ENTRY                  71000000
         B     RELOOP1             BR TO CHK NEXT ENTRY                 71200002
*                                                                       71400000
*                                                                       71600000
XCTLRTN  EQU   *                                                        71800000
         MVC   WTGID(IDL,RWTG),ID(RWTGC)  STORE ID IN WTG TABLE         72000002
*                                                                       72600000
*                                                                       72800000
         XCTL  EPLOC=(RWTG),SF=(E,DXXCTL),DCB=0  TRANSFER        Y02072X73000002
                                   CONTROL TO THE NEXT EXECUTOR  Y02072 73200002
*                                                                       73202002
*        GETMAIN SUBROUTINE                                             73204002
*                                                                       73206002
GETMAIN  GETMAIN R,LV=(R13),SP=250 GET REQUESTED AMOUNT OF CORE         73208002
         BR    R12                 RETURN TO CALLER                     73210002
         EJECT                                                          73600000
****                                                                    73602002
****     CONSTANTS                                                      73604002
****                                                                    73606002
         DS    0H                                                       73800000
NUMMIN7  DC    AL2(7)              CONSTANT OF 7                        74000002
IOBPREFX DC    AL2(8)              LENGTH OF IOB PREFIX                 74200002
CLEARBUF XC    0(0,R9),0(R9)       CLEAR BUFFER TO ZERO                 74400002
OPIDCNST DC    C'0S'               END OF TABLE ID                      74600002
AMIDCNST DC    C'7C'               CURRENT MODULE ID                    74800002
SOP7D    DC    C'7D'               ID OF NEXT EXECUTOR           Y02072 77000002
         DC    C'IGG0197C OZ07621 03/09/76'  SIGHT INDICATOR   @ZA07621 77000403
         DC    CL8'&SYSDATE'                 SIGHT INDICATOR   @ZA07621 77000603
         DC    C'Z07621'                      IGHT INDICATOR   @ZA07621 77000903
PATCH    DC    XL50'0',D'0'        PATCH AREA                  @ZA07621 77001203
MODLEN   EQU   *                   LENGTH OF THIS MODULE         Y02072 77001503
         SPACE 2                                                        77002002
****                                                                    77004002
****     CONTROL BLOCK DEFINITIONS                                      77006002
****                                                                    77008002
*        MICBD - DUMMY SECTION FOR THE MICB                             77830000
MICBENTR DSECT                                                          77860000
MICBNEXT DS    A                                                        77890000
MICBECB  DS    A                                                        77920000
MICBFLAG DS    AL1                                                      77950000
MICBSENS DS    AL3                                                      77980000
MICBECBA DS    A                                                        78010000
MICBNM7  DS    A                                                        78040000
MICBNM1  DS    A                                                        78070000
MICBDATA DS    A                                                        78100000
         SPACE 3                                                        78100402
DSECT    DSECT                                                          78200000
         IECDSECT IOB=NO                                         Y02072 78400002
         SPACE 3                                                        78600002
         CVT   DSECT=YES                                         Y02072 78602002
         SPACE 3                                                        78604002
DCB      DCBD  DSORG=BS,DEVD=MR                                         79200000
         EJECT                                                          79400002
UCB      DSECT                                                          80000000
         IEFUCBOB                                                       80200000
*                                                                       81000000
         END                                                            81200000
./  ADD  SSI=61420011,NAME=IGG0197D
         TITLE 'IGG0197D - LOAD MICR MODULES'                           01000002
IGG0197D CSECT                                                          02000000
         SPACE                                                          02000402
*********************************************************************** 03800000
*                                                                     * 04000000
* MODULE NAME - IGG0197D                                              * 04000402
*                                                                     * 04000802
* DESCRIPTIVE NAME - MICR MODULE LOADER                               * 04001202
*                                                                     * 04001602
* COPYRIGHT - NONE                                                    * 04002002
*                                                                     * 04002402
* CHANGE ACTIVITY - AS FOLLOWS:                                       * 04002802
*                                                                     * 04003202
*          RELEASE 21 DELETIONS                                       * 04003602
*0000274000,380000                                               A41426 04004002
*0000250000,706000                                               A48612 04004402
*                                                                     * 04004802
*          VS2 RELEASE 02 DELETIONS                                   * 04005202
*D180000,210000-230000,238000,246000,252000-256000,277000-286000,Y02072 04005602
*D290400,292400,294400,295200,298000,300400-301200,301600-304000,Y02072 04006002
*D310500-311000,356000,368000-370600,430000-436000,454000,460000-Y02072 04006402
*D468000,478000-496000,506000-508000,522000,534000,540000,610000-Y02072 04006802
*D614000,626000-634000,638000-651200,663000,668000,672000-686000,Y02072 04007202
*D697200,730000,746000-752000,760000,764000-766000,770000-772000 Y02072 04007602
*C471224-471240                                                @ZA00107 04007803
*A260000,372000-375000,726100-729100                           @ZA06120 04007903
*                                                              @ZA07621 04008003
*          VS2 RELEASE 04.0 CHANGES                            @ZA07621 04038003
*C744002                                                       @ZA07621 04068003
*                                                                     * 04100002
* STATUS - VS2 RELEASE 2 LEVEL 0                                      * 04100402
*                                                                     * 04100802
*                                                                     * 04101202
* FUNCTION/OPERATION - THIS ROUTINE SUPPLEMENTS THE INITIAL OPEN      * 04200002
*      ROUTINE BY PERFORMING SPECIFIC FUNCTIONS FOR THE MAGNETIC      * 04400000
*      INK CHARACTER READER.                                          * 04600000
*      THIS ROUTINE WILL LOAD ALL NECESSARY I/O MODULES.  IT WILL     * 04800002
*      PLACE THE ADDRESSES OF THE LOADED MODULES IN THE APPROPRIATE   * 05000002
*      DCB FIELDS AND PLACE THE CORRESPONDING MODULE ID'S IN THE DEB. * 05200002
*      THE USER CODED STACKER SELECT ROUTINE IS LOADED FROM SVCLIB.   * 05400002
*      IF THE STACKER SELECT ROUTINE IS NOT LOCATED IN SVCLIB, OR IF  * 06400002
*      THE USER IS NOT AUTHORIZED TO RUN THE STACKER SELECT ROUTINE,  * 06600002
*      THEN A MESSAGE WILL BE WRITTEN TO THE PROGRAMMER INDICATING    * 06800002
*      SAME AND THE TASK WILL BE ABNORMALLY TERMINATED.               * 07000002
*      THIS ROUTINE WILL ALSO LOAD THE APPENDAGES REQUIRED TO         * 07200000
*      PROCESS THE MICR DEVICES AND PLACE THEIR ADDRESSES IN THE DEB. * 07400002
*      IF THE DD STATEMENT CONTAINED A VOLUME NUMBER, A MESSAGE WILL  * 07800002
*      BE PUT OUT INSTRUCTING THE OPERATOR TO MOUNT THE REQUIRED      * 08000002
*      VOLUME ON THE SPECIFIED MICR DEVICE.                           * 08200002
*                                                                     * 08400000
*                                                                     * 08600000
* ENTRY POINT - THIS ROUTINE IS ENTERED AT THE CSECT IGG0197D VIA AN  * 08800002
*               XCTL FROM IGG0197C.                                   * 09000002
*                                                                     * 09200000
*                                                                     * 09400000
* INPUT - REGISTER 5 - ADDRESS OF THE DCB PARAMETER LIST              * 09600002
*         REGISTER 6 - ADDRESS OF THE WHERE-TO-GO TABLE               * 09800002
*         REGISTER 7 - ADDR OF CURRENT ENTRY IN DCB PARAMETER LIST    * 10000002
*         REGISTER 8 - ADDR OF CURRENT ENTRY IN WHERE-TO-GO TABLE     * 10000402
*                                                                     * 10200000
*                                                                     * 10400000
* OUTPUT - OUTPUT IS AS FOLLOWS:                                      * 10600002
*                                                                     * 10800000
*      1. UPDATED DCB'S AND DEB'S.                                    * 11000002
*                                                                     * 11200000
*      2. ALL REQUIRED I/O MODULES FOR MICR PROCESSING ARE LOADED.    * 11400002
*                                                                     * 11600000
*      3. THE USER'S STACKER SELECT ROUTINE IS LOADED.                * 11800002
*                                                                     * 12000000
*      4. IF THE STACKER SELECT ROUTINE IS NOT LOCATED IN SVCLIB, OR  * 12600402
*         IF THE USER IS NOT AUTHORIZED TO RUN IT, THEN A WRITE TO    * 12600802
*         PROGRAMMER MESSAGE WILL BE ISSUED INDICATING THE SAME.      * 12601202
*                                                                     * 12602002
*      5. A MOUNT MESSAGE IF A VOLUME ID WAS SPECIFIED ON JCL CARD.   * 12800002
*                                                                     * 13000000
*      6. THE USER'S DCB IS REFRESHED.                                * 13000402
*                                                                     * 13000802
*                                                                     * 13200000
* EXTERNAL ROUTINES - IECVGENA - RESIDENT IOSGEN SUBROUTINE USED TO   * 13400002
*                     RESET THE DEVICE NOT READY FLAGS IN THE PRIMARY * 13400802
*                     AND SECONDARY UCB'S.                            * 13401202
*                                                                     * 13600000
*                                                                     * 13800000
* EXITS-NORMAL - XCTL TO THE NEXT OPEN EXECUTOR VIA THE WTG TABLE     * 14000002
*                                                                     * 14200000
* EXITS-ERROR - SYSTEM 006 ABEND IF THE STACKER SELECT ROUTINE IS NOT * 14400002
*               LOCATED IN SVCLIB OR THE USER IS NOT AUTHORIZED TO    * 14400402
*               RUN IT.                                               * 14400802
*                                                                     * 14600000
*                                                                     * 14800000
* TABLES/WORK AREAS - WHERE-TO-GO TABLE AND THE OPEN WORK AREA        * 15000002
*                                                                     * 15200000
*                                                                     * 15400000
* MACROS-ACTION - MODESET, GETMAIN, FREEMAIN, BLDL, TESTAUTH, IOSGEN, * 15400402
*                 LOAD, DELETE, WTO, ABEND, IECRES, XCTL              * 15400802
*                                                                     * 15401202
* MACROS-MAPPING - CVT, DCBD, IECDIOCM, IGGMSG, IEFUCBOB, IECDSECS    * 15401602
*                                                                     * 15402402
*                                                                     * 15402802
* ATTRIBUTES - REENTRANT, REUSABLE, NORMALLY RUNS IN DATA MANAGEMENT  * 15600002
*              KEY.                                                   * 15600402
*                                                                     * 15800000
*********************************************************************** 16600000
         EJECT                                                          16800000
****                                                                    17000002
****     REGISTER CONVENTIONS                                           17200002
****                                                                    17400002
R0       EQU   0         WORK/PARAMETER REG                             17600000
R1       EQU   1         WORK/PARAMETER REG                             17800000
RDCB     EQU   2         DCB REG                                        18200000
RBASE    EQU   3         BASE REG                                       18400000
RCORE    EQU   4         WORK AREA REG                                  18600000
RPAR     EQU   5         TOP OF PARAMETER LIST                          18800000
RWTG     EQU   6         TOP OF WTG TABLE                               19000000
RPARC    EQU   7         CURRENT PARAMETER                              19200000
RWTGC    EQU   8         CURRENT TRANS LOAD                             19400000
RCVT     EQU   9         CVT REG                                        19600002
RUCB     EQU   10        UCB REG                                        19800000
RDEB     EQU   11        WORK REG                                       20000000
R12      EQU   12        WORK REG                                       20002002
RB       EQU   R12       WORK REG                                       20200002
RWRK1    EQU   RB        WORK REGISTER                           Y02072 20200402
RC       EQU   13        WORK REG                                       20400002
RSAVE    EQU   RC        SAVE AREA ADDR                          Y02072 20402002
RAREA    EQU   RSAVE     WORK AREA ADDRESS                       Y02072 20402402
R14      EQU   14        WORK REGISTER                           Y02072 20404002
RD       EQU   R14       WORK REG                                       20600002
RRETURN  EQU   RD        RETURN ADDR REGISTER                    Y02072 20600402
R15      EQU   15        WORK REG                                       20602002
RJ       EQU   R15       WORK REG                                       20800002
         SPACE 2                                                        20804002
****                                                                    20806002
****     MASKS, DISPLACEMENTS, AND OTHER EQUATES                        20808002
****                                                                    20810002
UNIT     EQU   14                  DISP TO UNIT IN WTO MESSAGE          23400002
DEBNMSUB EQU   0                   DISP TO NUM SUBRTN'S LOADED          24400000
DEBDCBB  EQU   25                  ADDRESS OF THE DCB            Y02072 24602002
DEBAPPAD EQU   28                  DISP TO APPENDAGE VECTOR TABLE       24800000
DEBUCBAD EQU   32                  DISP TO UCB ADDR                     24802002
DEBBINUM EQU   36                  DISP TO SCU UCB ADDR IN DEB          24804002
DEBSSAD  EQU   44                  ADDR OF USER'S STACKER SELECT Y02072 24810002
*                                  ROUTINE                       Y02072 24812002
DEBSUBID EQU   48                  DISP TO STACKER NAME          A48612 25000002
IDDEB    EQU   56                  DISP TO SUBRTN ID'S                  25002002
SIOADDR  EQU   4                   DISP TO SIO ADDR IN THE AVT    41426 25700002
PCIADDR  EQU   8                   DISP TO PCI ADDR IN THE AVT          25900002
PCIENTRY EQU   12                  DISP TO PCI ENTRY IN V7     @ZA06120 26000003
ENTRYDSP EQU   4                   LENGTH OF APPENDAGE BR TABLE ENTRIES 26200002
CEADDR   EQU   12                  DISP TO CHAN END ADDR IN AVT         26500002
ABENDAD  EQU   16                  DISP TO ABNORMAL END ADDR IN DEB     26800002
EOEADDR  EQU   0                   DISP TO END-OF-EXTENT ADDR IN DEB    27100002
SUBID    EQU   0                   DISP TO ID IN WTG TABLE              29000002
ONE      EQU   1                   FOR GENERAL USE                      29080002
VOLID    EQU   18                  DISP TO VOLUME ID IN WTO MESSAGE     29120002
WTOSIZE  EQU   X'18'               LENGTH OF WTO MESSAGE                29160002
BLANK    EQU   X'40'               EBCDIC BLANK                         29200002
DCBADDR  EQU   0                   DISP TO DCB ADDR IN DCB LIST         29280002
WORKADDR EQU   4                   DISP TO WORK AREA ADDR IN WTG TABLE  29320002
CURRID   EQU   0                   DISP TO CURRENT ID IN WTG TABLE      29360002
X00      EQU   X'00'               HEX ZERO                             29400002
ADDRL    EQU   3                   LENGTH OF AN ADDRESS IN BYTES        29480002
NEBLDL   EQU   0                   DISP TO NUM ENTRIES IN A BLDL LIST   29560002
BLDLL    EQU   58                  LENGTH OF BLDL ENTRY                 29600002
ELBLDL   EQU   2                   DISP TO BLDL LIST ENTRY LENGTH       29640002
NBLDL    EQU   4                   DISP TO BLDL LIST MODULE NAME        29680002
MLENGTH  EQU   8                   LENGTH OF MODULE NAME                29720002
MODDISP  EQU   0                   DISP TO MODULE NAME                  29760002
WTODISP  EQU   0                   DISP TO WTO MESSAGE                  29840002
UNITL    EQU   3                   LENGTH OF UNIT IN WTO MESSAGE        29880002
VOLL     EQU   6                   LENGTH OF VOLID IN WTO MESSAGE       29920002
IDL      EQU   2                   LENGTH OF ID IN WTG TABLE            29960002
WTGID    EQU   6                   DISP TO ID IN WTG TABLE              30000002
WAOFF    EQU   32                  OFFSET OF FIRST ENTRY IN WTG TABLE   30600002
PLOFF    EQU   4                   OFFSET OF DCB ENTRIES                30800002
WGOFF    EQU   8                   OFFSET OF WTG ENTRIES                31000002
DELWTO   EQU   X'02'               INDICATE A WTO WAS ISSUED            31150002
NOTAUTH  EQU   X'006'              INCORRECT AUTHORIZATION ABEND Y02072 31160002
NOTAUTHM EQU   48                  OFFSET TO AUTHORIZATION MSG   Y02072 31162002
WORKSIZE EQU   64                  SIZE OF WORK AREA             Y02072 31164002
         EJECT                                                          31200000
****                                                                    31400002
****     LOAD REGS WITH CONTROL BLOCK ADDRESSES                         31600002
****                                                                    31800002
         BALR  RBASE,0                                                  32400000
         USING *,RBASE                                                  32600000
         USING IHADCB,RDCB                                              32800000
         USING FORCORE,RCORE       EST OPEN WORK AREA BASE REG   Y02072 33000002
         USING CVT,RCVT                                                 33200002
         USING UCB,RUCB                                                 33400000
         L     RDCB,DCBADDR(RPARC) GET DCB ADDR                         33600002
         L     RDEB,DCBDEBAD       GET DEB ADDR                         33800000
         L     RCVT,CVTPTR         LOAD CVT ADDR                        34000002
         L     RCORE,WORKADDR(RWTGC)  GET WORK AREA ADDR                34200002
*                                                                       34400000
         MVI   CURRID(RWTGC),X00   ZERO CURRENT ID ENTRY                34600002
*                                                                       34630000
         MODESET EXTKEY=SUPR       CHANGE TO KEY 0               Y02072 34632002
         LA    RSAVE,DXCCW         GET ADDRESS OF SAVE AREA      Y02072 34634002
         L     RUCB,DEBUCBAD(RDEB) LOAD PCU UCB ADDR                    34660002
         BAL   RRETURN,READYDEV    SET PCU UCB TO DEVICE READY   Y02072 34690002
         L     RUCB,DEBBINUM(RDEB) LOAD SCU UCB ADDR                    34720002
         BAL   RRETURN,READYDEV    SET SCU UCB TO DEVICE READY   Y02072 34750002
         MODESET EXTKEY=DATAMGT    CHANGE TO DATA MANAGEMENT KEY Y02072 34752002
         SPACE 2                                                        34800002
****                                                                    34860002
****     LOAD THE APPENDAGES FOR MICR SUPPORT                           34920002
****                                                                    34980002
         LA    RB,IGG019V5                                              35040000
         L     RJ,CVTSVDCB         LOAD ADDR SVCLIB DCB                 35100000
         LOAD  EPLOC=(RB),DCB=(RJ) LOAD APPENDAGES                      35160002
         LR    R1,R0               SAVE ADDRESS OF APPENDAGES    Y02072 35162002
         LA    RB,APPENDID         LOAD ADDR OF APPENDAGE ID            35220000
         BAL   RC,ADDV5            INCLUDE APPENDAGE ID IN DEB          35280002
*                                                                       35400000
         L     RC,DEBAPPAD(RDEB)   LOAD ADDR OF APPENDAGE VECTO@ZA06120 35800003
         ST    R1,CEADDR(RC)       PLACE CHANNEL END ENTRY ADDR         36000000
         LA    R1,ENTRYDSP(R1)                                          36200000
         ST    R1,ABENDAD(RC)      PLACE ABEND ENTRY ADDR               36400000
         LA    R1,ENTRYDSP(R1)                                          36600000
         ST    R1,SIOADDR(RC)      PLACE START I/O ENTRY IN AVT   41426 37120002
*                                                              @ZA06120 37200003
         LA    RB,IGG019V7                                     @ZA06120 37230003
         L     RJ,CVTSVDCB         LOAD ADDR SVCLIB DCB        @ZA06120 37260003
         LOAD  EPLOC=(RB),DCB=(RJ) LOAD APPENDAGES             @ZA06120 37290003
         LR    R1,R0               SAVE ADDRESS OF APPENDAGES  @ZA06120 37320003
         LA    RB,PCIAPPID         LOAD ADDR OF PCI APPEND ID  @ZA06120 37350003
         BAL   RC,ADDV5            INCLUDE APPENDAGE ID IN DEB @ZA06120 37380003
*                                                              @ZA06120 37410003
         L     RC,DEBAPPAD(RDEB)   LOAD ADDR OF APPENDAGE VECTO@ZA06120 37440003
         LA    R1,PCIENTRY(R1)     POINT TO PCI ENTRY          @ZA06120 37470003
         ST    R1,PCIADDR(RC)      PLACE PCI ENTRY ADDR        @ZA06120 37500003
         LA    R1,CVTBRET                                               37600000
         ST    R1,EOEADDR(RC)      PLACE DUMMY E-O-E ADDR               37800000
         SPACE 2                                                        37802002
****                                                                    37804002
****     LOAD THE READ, EOB, CHECK, AND CONTROL ROUTINES.               37806002
****                                                                    37808002
         LA    RB,READID           POINT TO READ ID                     38200000
         BAL   RC,LOADMOD          LOAD READ                            38400000
         STCM  R0,B'0111',DCBREAD+1  PLACE READ RTN ADDR IN DCB  Y02072 38800002
*                                                                       39000000
*                                                                       39200000
         LA    RB,EOBID            POINT TO EOB ID                      39400000
         BAL   RC,LOADMOD          LOAD EOB                             39600000
         STCM  R0,B'0111',DCBEOBRA  PLACE EOB RTN ADDR IN DCB    Y02072 40000002
*                                                                       40200000
*                                                                       40400000
         LA    RB,CHECKID          POINT TO CHECK ID                    40600000
         BAL   RC,LOADMOD          LOAD CHECK                           40800000
         STCM  R0,B'0111',DCBCHCKA PLACE CHECK RTN ADDR IN DCB   Y02072 41200002
*                                                                       41400000
*                                                                       41600000
         LA    RB,CNTRLID          POINT TO CONTROL ID                  41800000
         BAL   RC,LOADMOD          LOAD CONTROL                         42000000
         ST    R0,DCBCNTRL         PLACE CONTROL RTN ADDR IN DCB Y02072 42400002
         SPACE 2                                                        42402002
****                                                                    42404002
****     GET CORE FOR A BLDL LIST AND A WRITE TO OPERATOR MESSAGE AREA. 42406002
****                                                                    42408002
         GETMAIN R,LV=WORKSIZE,SP=230  GET CORE FOR A WORK AREA  Y02072 42410002
         LR    RAREA,R1            SAVE ADDR OF GOTTEN CORE      Y02072 42412002
         SPACE 2                                                        42414002
****                                                                    42600002
****     ISSUE THE BLDL MACRO TO DETERMINE IF THE STACKER SELECT        42800002
****     ROUTINE IS IN SVCLIB.                                          42802002
****                                                                    42804002
         LA    RWRK1,ONE           LOAD NUM ENTRIES              Y02072 44000002
         STH   RWRK1,NEBLDL(RAREA)  PLACE IN BLDL LIST           Y02072 44200002
         LA    RWRK1,BLDLL         LOAD LENGTH OF ENTRY          Y02072 44400002
         STH   RWRK1,ELBLDL(RAREA)  PLACE IN BLDL LIST           Y02072 44600002
         MVC   NBLDL(MLENGTH,RAREA),DEBSUBID(RDEB)  PUT MODULE   Y02072 44800002
*                                  NAME IN BLDL LIST             Y02072 44802002
         L     R1,CVTSVDCB         GET ADDR OF SVCLIB DCB        Y02072 45000002
*                                                                       45002002
         BLDL  (1),(RAREA)         BUILD LIST                    Y02072 45200002
*                                                                       45204002
         LTR   R15,R15             WAS BLDL SUCCESSFUL           Y02072 45600002
         BNZ   ABENDUSR            IF NOT, ABEND THE USER        Y02072 45800002
         SPACE 2                                                        46004002
****                                                                    46006002
****     DETERMINE IF THE USER IS AUTHORIZED TO RUN THE STACKER SELECT  46008002
****     ROUTINE FOUND IN SVCLIB.                                       46010002
****                                                                    46012002
         TESTAUTH FCTN=1           CHECK AUTHORITY OF THE USER   Y02072 46014002
         LTR   R15,R15             IS USER AUTHORIZED TO RUN THE Y02072 46016002
*                                  STACKER SELECT ROUTINE        Y02072 46018002
         BZ    LOADSS              IF YES, GO TO LOAD SS ROUTINE Y02072 47000002
         SPACE 2                                                        47076002
****                                                                    47078002
****     IF THE USER'S STACKER SELECT ROUTINE IS NOT IN SVCLIB OR IF    47080002
****     THE USER IS NOT AUTHORIZED TO RUN IT, THEN WRITE A MESSAGE TO  47082002
****     THE PROGRAMMER INDICATING SAME AND ABEND THE USER.             47084002
****                                                                    47086002
ABENDUSR EQU   *                                                 Y02072 47088002
         BAL   RRETURN,FREEMAIN    FREE THE WORK AREA            Y02072 47088202
         L     RWRK1,CVTLINK       GET ADDR OF LINKLIB DCB       Y02072 47088402
         LOAD  EP=IGGMSG01,DCB=(RWRK1)  LOAD MESSAGE CSECT       Y02072 47090002
         LR    R1,R0               GET ADDR OF MESSAGE CSECT     Y02072 47092002
         USING MSGINDEX,R1         EST BASE FOR MSG INDEX TABLE  Y02072 47094002
         AH    R1,MSGINDOF+NOTAUTHM  GET OFFSET TO DESIRED MSG   Y02072 47096002
         USING MSGENTRY,R1         ESTABLISH BASE FOR MESSAGE    Y02072 47098002
         SR    RWRK1,RWRK1         CLEAR REGISTER                Y02072 47098202
         IC    RWRK1,MSGOFF        GET OFFSET TO MESSAGE TEXT    Y02072 47098402
         AR    R1,RWRK1            CALCULATE ADDR OF MSG TEXT    Y02072 47098602
*                                                                       47100002
         WTO   MF=(E,(1))          WRITE MESSAGE TO PROGRAMMER   Y02072 47102002
*                                                                       47104002
         DELETE EP=IGGMSG01        DELETE MESSAGE CSECT          Y02072 47106002
*                                                                       47108002
         ABEND NOTAUTH,DUMP,,SYSTEM  ABEND THE USER              Y02072 47110002
         SPACE 2                                                        47112002
****                                                                    47114002
****     LOAD THE USER'S STACKER SELECT ROUTINE.                        47116002
****                                                                    47118002
LOADSS   EQU   *                                                 Y02072 47120002
         L     R1,CVTSVDCB         GET ADDR OF SVCLIB DCB        Y02072 47122002
         LA    0,4(,RAREA)         POINT TO NAME               @ZA00107 47124003
         LOAD  DE=(0),DCB=(1)      LOAD STACKER SELECT ROUTIN  @ZA00107 47125003
*                                                                       47126002
         ST    R0,DCBSSAD          PUT SS RTN ADDR IN THE DCB    Y02072 47128002
         ST    R0,DEBSSAD(RDEB)    PUT SS RTN ADDR IN THE DEB    Y02072 47130002
         SPACE 2                                                        49606002
****                                                                    49608002
****     IF A VOLUME ID WAS SPECIFIED ON THE JCL, ISSUE A WRITE TO      49610002
****     OPERATOR REQUESTING THE VOLUME BE MOUNTED.                     49612002
****                                                                    49614002
RDJFCB   EQU   *                                                        49800000
         CLI   JFCBVOLS,BLANK      IS VOLID SPECIFIED                   50000000
         BE    REFRESH             BRANCH IF NOT                 Y02072 50200002
*                                                                       51000000
         MVC   WTODISP(WTOSIZE,RAREA),WTO  BUILD MESSAGE         Y02072 51200002
*                                                                       51400000
         L     RUCB,DEBUCBAD(RDEB)  LOAD ADDR OF UCB                    51600002
         MVC   UNIT(UNITL,RAREA),UCBNAME   PLACE UNIT IN MSG     Y02072 51800002
         MVC   VOLID(VOLL,RAREA),JFCBVOLS  PLACE VOLID IN MSG    Y02072 52000002
         WTO   MF=(E,(RAREA))      ISSUE MESSAGE                 Y02072 52400002
*                                                                       52600000
         OI    DCBMRFLG,DELWTO     INDICATE WTO WAS ISSUED              53000000
         ST    R1,DCBWTOID         PLACE MESSAGE ID                     53200000
         SPACE 2                                                        54002002
****                                                                    54004002
****     REFRESH THE USER'S DCB.                                        54006002
****                                                                    54008002
REFRESH  EQU   *                                                 Y02072 54010002
         BAL   RRETURN,FREEMAIN    FREE THE WORK AREA            Y02072 54011002
         USING WTG,RWTG            EST WHERE-TO-GO TBL BASE REG  Y02072 54012002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(R0,R14,WTGPREFX)        Y02072 54014002
         MVC   DEBDCBB(ADDRL,RDEB),DXUDCBAD+1  POINT THE DEB TO  Y02072 54016002
*                                  THE USER'S DCB                Y02072 54016802
         DROP  RWTG                DROP WHERE-TO-GO TBL BASE REG Y02072 54018002
         SPACE 2                                                        54200002
****                                                                    54400002
****     DETERMINE IF ANY MORE DCB'S NEED TO BE PROCESSED BY THIS       54600002
****     MODULE.                                                        54800002
****                                                                    55000002
RELOOP   EQU   *                                                        55600000
         LA    RWTGC,WGOFF(0,RWTGC) INCR CURRENT WTG ENTRY              55800000
         LA    RPARC,PLOFF(0,RPARC) INCR CURRENT DCB ENTRY              56000000
         CLC   CURRID(IDL,RWTGC),AMIDCNST THIS RTN NEEDED AGAIN         56200000
         BER   RBASE               YES, BRANCH                          56400002
*                                                                       56600000
*                                                                       56800000
         CLC   CURRID(IDL,RWTGC),OPIDCNST END OF TABLE                  57200000
         BC    7,RELOOP             NO, BRANCH                          57400000
*                                                                       57600000
*                                                                       57800000
         LR    RPARC,RPAR          REINITIALIZE DCB LIST PTR            58000000
         LA    RWTGC,WAOFF(0,RWTG) REINITIALIZE WTG LIST PTR            58200000
*                                                                       58400000
*                                                                       58600000
RELOOP1  EQU   *                                                        58800000
         CLI   CURRID(RWTGC),X00   IS THIS ENTRY COMPLETE               59000000
         BC    7,XCTLRTN           NO, BRANCH                           59200000
*                                                                       59400000
*                                                                       59600000
         LA    RWTGC,WGOFF(0,RWTGC) GET NEXT WTG ENTRY                  59800000
         LA    RPARC,PLOFF(0,RPARC) GET NEXT DCB ENTRY                  60000000
         B     RELOOP1              BR TO CHK NEXT ENTRY                60200000
*                                                                       60400000
*                                                                       60600000
XCTLRTN  EQU   *                                                        60800000
         MVC   WTGID(IDL,RWTG),CURRID(RWTGC) STORE ID IN WTG TABLE      60900000
*                                                                       61800000
         XCTL  EPLOC=(RWTG),SF=(E,DXXCTL),DCB=0  XCTL TO THE     Y02072 62000002
*                                  NEXT LOAD                     Y02072 62002002
         SPACE 2                                                        65400002
****                                                                    65600002
****     THE FOLLOWING ROUTINE IS USED TO LOAD THE READ, EOB, CHECK,    65602002
****     AND CONTROL ROUTINES AND INCLUDE THEIR ID'S IN THE DEB.        65604002
****                                                                    65606002
LOADMOD  EQU   *                                                        66400000
         MVC   WTGID(IDL,RWTG),CURRID(RB)    PLACE ID IN WTG TABLE      67000000
         L     R1,CVTLINK          GET ADDR OF LINKLIB DCB       Y02072 67002002
         LOAD  EPLOC=(RWTG),DCB=(1)  LOAD MODULE                 Y02072 69200002
*                                                                       69400000
*                                                                       69600000
ADDV5    EQU   *         ENTER HERE TO INCLUDE IGG019V5 ID IN DEB       69660000
*                                                                       69800000
         SR    RJ,RJ                                                    70000000
         IC    RJ,DEBNMSUB(RDEB)   GET NUM SUBROUTINES                  70200002
         LR    RD,RJ               GET NUM SUBROUTINES                  70400002
         SLL   RD,1                GET DISP TO ID IN DEB                70800002
         AR    RD,RDEB                                                  71000002
         MVC   IDDEB(IDL,RD),SUBID(RB)  PLACE ID IN DEB                 71200000
         LA    RJ,ONE(RJ)          INCR NUM SUBROUTINES                 71400002
         STC   RJ,DEBNMSUB(RDEB)   PLACE NEW NUM SUBRTNS                71600002
         BR    RC                  RETURN                               71800002
         SPACE 2                                                        71802002
****                                                                    71804002
****     THE FOLLOWING ROUTINE IS USED TO FREE THE WORK AREA.           71806002
****                                                                    71808002
FREEMAIN FREEMAIN R,LV=WORKSIZE,A=(RAREA),SP=230  FREE WORK AREA Y02072 71810002
         BR    RRETURN             RETURN TO THE CALLER          Y02072 71812002
         SPACE 2                                                        72000002
****                                                                    72024002
****     THE FOLLOWING ROUTINE IS USED TO TURN OFF THE DEVICE NOT       72026002
****     READY INDICATOR IN THE PRIMARY AND SECONDARY UCB'S.            72028002
****                                                                    72030002
READYDEV EQU   *                                                 Y02072 72032002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=OFF,TABLE=UCBNRY           Y02072 72034002
         BR    RRETURN             RETURN TO THE CALLER          Y02072 72036002
         EJECT                                                          72054002
****                                                                    72200002
****     CONSTANTS                                                      72400002
****                                                                    72600002
WTO      WTO   'IEC001A M UNT,VOLUME',MF=L                              72602002
AMIDCNST DC    C'7D'               CURRENT MODULE ID                    72604002
OPIDCNST DC    C'0S'               END OF TABLE ID                      72606002
         DS    0H                                                       72608002
IGG019V7 DC    C'IGG019V7'         MODULE NAME OF 1419 PCI APPE@ZA06120 72610003
PCIAPPID EQU   IGG019V7+6          ID OF PCI APPENDAGE         @ZA06120 72910003
IGG019V5 DC    C'IGG019V5'         MODULE NAME OF 1419 APPENDAG@ZA06120 73210003
APPENDID EQU   IGG019V5+6          ID OF 1419 APPENDAGES         Y02072 73600002
READID   DC    C'V1'               ID OF READ ROUTINE            Y02072 73800002
EOBID    DC    C'V2'               ID OF END OF BLOCK ROUTINE    Y02072 74000002
CHECKID  DC    C'V3'               ID OF CHECK ROUTINE           Y02072 74200002
CNTRLID  DC    C'V4'               ID OF CONTROL ROUTINE         Y02072 74400002
         DC    C'IGG0197D'                    SIGHT INDICATOR  @ZA07621 74400203
         DC    CL8'&SYSDATE'                  SIGHT INDICATOR  @ZA07621 74400303
         DC    C'Z07621'                      SIGHT INDICATOR  @ZA07621 74400403
PATCH    DC    42X'0',D'0'                  PATCH AREA         @ZA07621 74400503
MODLEN   EQU   *                   LENGTH OF THIS MODULE         Y02072 74400802
         EJECT                                                          74402002
****                                                                    75400002
****     CONTROL BLOCK DEFINITIONS                                      75600002
****                                                                    75800002
         CVT   DSECT=YES                                                76200002
         SPACE 3                                                        76202002
DCB      DCBD  DSORG=BS,DEVD=MR                                         76800000
         EJECT                                                          76802002
         IECDIOCM                                                Y02072 76804002
         EJECT                                                          76806002
         IGGMSG                                                  Y02072 76812002
         EJECT                                                          77214002
UCB      DSECT                                                          77218002
         IEFUCBOB                                                       77220002
         SPACE 3                                                        77222002
         IECDSECS (MAIN,(IOB,NO)),PREFX,WTG,EXPAND=YES           Y02072 77224002
         END                                                            77400000
./  ADD  SSI=61420013,NAME=IGG0201D
         TITLE 'IGG0201D - 1419 CLOSE EXECUTOR'                         00200002
IGG0201D CSECT                                                          00400000
         SPACE                                                          00400402
*********************************************************************** 00400802
*                                                                     * 00401202
* MODULE NAME - IGG0201D                                              * 00401603
*                                                                     * 00402002
* DESCRIPTIVE NAME - 1419 CLOSE EXECUTOR                              * 00402402
*                                                                     * 00402802
* COPYRIGHT - NONE                                                    * 00403202
*                                                                     * 00403602
* CHANGE ACTIVITY - AS FOLLOWS:                                       * 00404002
*                                                                     * 00404402
*          RELEASE 20 DELETIONS                                       * 00404802
*1022245000,246000,424000,427000-429000                          A48612 00430000
*A245000-246000,427000-429000                                    A33928 00460020
*D246000,428000                                                  A33928 00530020
*                                                                     * 00530202
*          VS1 RELEASE 2.6 DELETIONS                                  * 00530302
*D316000-324000                                                 SA60237 00530402
*D312000                                                        SA60756 00530502
*A366100-367700                        SA76228,YA09416,XA09359 @ZA07021 00530603
*A416600-417200                        SA76228,YA09416,XA09359 @ZA07021 00530703
*                                                              @ZA07021 00530803
*                                                               SA62501 00530903
*                                                                     * 00531003
*          VS2 RELEASE 02 DELETIONS                                   * 00531103
*D261320-261440,570000,574000,652000,658000-666000,678000-680000,Y02072 00531202
*D728000                                                         Y02072 00531602
*          VS2 RELEASE 03.6 CHANGES XA09359,YA09416,SA7228     @ZA07021 00531703
*A366100-367700                                                @ZA07021 00531803
*A416600-417200                                                @ZA07021 00531903
*          VS2 RELEASE 04.0 CHANGES                                     00532003
*C656040                                                       @ZA07621 00532103
*                                                                       00532203
*                                                                     * 00532303
*                                                                     * 00532402
* STATUS - VS2 RELEASE 2 LEVEL 0                                      * 00600002
*                                                                     * 00600402
*                                                                     * 00600802
* FUNCTION/OPERATION - THIS ROUTINE IS THE CLOSE EXECUTOR FOR 1419    * 00800002
*                   DATA SETS.  CLOSE FUNCTIONS WILL BE PERFORMED  ON * 01000002
*                   THOSE DCBS WHOSE DCBDSORG FIELDS SPECIFY PS AND   * 01200002
*                   WHOSE DCBDEVT FIELDS SPECIFIES MR.  FOR THOSE     * 01400003
*                   DCB'S THE FOLLOWING FUNCTIONS WILL BE PERFORMED:  * 01600002
*                                                                     * 01800002
*                   1. THE AEQ, RB, AND LOGICAL CHANNEL QUEUES ARE    * 02000002
*                      PURGED FOR BOTH THE PCU AND SCU.               * 02200002
*                                                                     * 02400002
*                   2. STORAGE FOR THE FOLLOWING ITEMS IS FREED FOR   * 02600002
*                      EACH DCB:                                      * 02800002
*                        A. CHANNEL PROGRAMS FOR THE PCU AND SCU      * 03000002
*                        B. BUFFERS FOR THE WRITE DELAY COMMAND       * 03200002
*                        C. IOB FOR THE PCU                           * 03400002
*                        D. IOB FOR THE SCU                           * 03600002
*                        E. MICB TABLE                                * 03800002
*                        F. REGISTER SAVE AREA                        * 04000002
*                        G. TRACE TABLE                               * 04000402
*                        H. ECB LIST                                  * 04200002
*                        I. BUFFER POOL IF OPEN ACQUIRED BUFFERS      * 04400002
*                                                                     * 04400402
*                   3. THE FOLLOWING VECTORS IN THE DCB ARE RESTORED  * 04600002
*                      TO THEIR PRE-OPEN VALUES:                      * 04800002
*                        A. DCBSSID  - USER STACKER SELECT NAME       * 05000002
*                        B. DCBIOBAD - ADDRESS OF IOB                 * 05200002
*                        C. DCBCHECK - ADDRESS OF CHECK MODULE        * 05400002
*                        D. DCBIOBA  - MICB READ ADDRESS              * 05600002
*                        E. DCBNCP   - NUMBER OF CHANNEL PROGRAMS     * 05800002
*                        F. DCBEOBR  - END-OF-BLOCK MODULE ADDRESS    * 06000002
*                        G. DCBCNTRL - CONTROL MODULE ADDRESS         * 06200002
*                        H. DCBMRIND - INDICATOR BYTE                 * 06400002
*                        I. DCBECBLT - ECB LIST ADDRESS               * 06600002
*                        J. DCBIOBL  - IOB LENGTH                     * 06800002
*                        K. DCBMRFLG,DCBAPPIN - INDICATOR BYTES       * 07000002
*                        L. DCBBUFCB,DCBBUFL  - IF OPEN ACQUIRED BFRS * 07200002
*                                                                     * 07200402
*                   4. THE USER'S DCB IS REFRESHED.                   * 07200802
*                                                                     * 07201202
*                   5. THE USER'S STACKER SELECT ROUTINE, LOADED BY   * 07400002
*                      OPEN, IS DELETED.                              * 07600002
*                                                                     * 07800002
*                                                                     * 07800402
* ENTRY POINT - ENTRY TO MODULE IS AT IGG0201D.  CONTROL IS RECEIVED  * 08000002
*               FROM IGG0200A OR IGG0200Z VIA AN XCTL.                * 08200002
*                                                                     * 08400002
*                                                                     * 08400402
* INPUT - REGISTER 5 - ADDRESS OF THE DCB PARAMETER LIST              * 08600002
*         REGISTER 6 - ADDRESS OF THE WHERE-TO-GO TABLE               * 08800002
*         REGISTER 7 - ADDR OF CURRENT ENTRY IN DCB PARAMETER LIST    * 08800402
*         REGISTER 8 - ADDR OF CURRENT ENTRY IN WHERE-TO-GO TABLE     * 08800802
*                                                                     * 09000002
*                                                                     * 09000402
* OUTPUT - THE USER'S DCB IS REFRESHED.                               * 09200002
*                                                                     * 09400002
*                                                                     * 09400402
* EXTERNAL ROUTINES - NONE                                            * 09600002
*                                                                     * 09800002
*                                                                     * 09800402
* EXIT-NORMAL - XCTL TO IGG0200B OR IGG0200G                          * 10000002
*                                                                     * 10200002
* EXIT-ERROR - NONE                                                   * 10400002
*                                                                     * 10600002
*                                                                     * 10600402
* TABLES/WORK AREAS - WHERE-TO-GO TABLE AND THE CLOSE WORK AREA       * 10800002
*                                                                     * 11000002
*                                                                     * 15400002
* MACROS-ACTION - MODESET, FREEMAIN, DELETE, PURGE, WAIT, IECRES, XCTL* 15400402
*                                                                     * 15400802
* MACROS-MAPPING - CVT, DCBD, IECDSECS                                * 15401202
*                                                                     * 15401602
*                                                                     * 15402002
* ATTRIBUTES - REENTRANT, REUSEABLE, NORMALLY RUNS IN DATA MANAGEMENT * 15600002
*              KEY.                                                   * 15600802
*                                                                     * 15800002
*********************************************************************** 16400000
         EJECT                                                          16600000
*********************************************************************** 16800000
*                                                                       17000000
*********                GENERAL REGISTER USAGE               ********* 17200000
*                                                                       17400000
R0       EQU   0                   WORK REGISTER                 Y02072 17402002
RPARM0   EQU   R0                  PARM LIST POINTER/WORK REGISTER      17600002
RPARM1   EQU   1                   PARM LIST POINTER/WORK REGISTER      17800000
RDCB     EQU   2                   ADDR OF DCB                          18000000
RBASE    EQU   3                   BASE REGISTER FOR CSECT              18200000
RCORE    EQU   4                   ADDR OF CLOSE WORK AREA FOR DCB      18400000
RPARM    EQU   5                   POINTER TO START OF PARM LIST        18600000
RWTG     EQU   6                   POINTER TO START OF WTG TABLE        18800000
RPARMC   EQU   7                   POINTER TO CURRENT ENTRY IN PARMLIST 19000000
RWTGC    EQU   8                   POINTER TO CURRENT ENTRY IN WTG TAB  19200000
RIOB     EQU   9                   POINTER TO PCU IOB                   19400000
RUCB     EQU   10                  UCB ADDRESS POINTER                  19600000
RDEB     EQU   11                  POINTER TO DEB                       19800000
RWRK1    EQU   12                  WORK REGISTER                        20000000
RWRK2    EQU   13                  WORK REGISTER                        20200000
R14      EQU   14                  WORK REGISTER                 Y02072 20202002
RPARME   EQU   R14                 PARM LIST POINTER/WORK REGISTER      20400002
RPARMF   EQU   15                  PARM LIST POINTER/WORK REGISTER      20600000
*                                                                       20800000
*********************************************************************** 21000000
         SPACE 2                                                        21200002
*********************************************************************** 21400000
*                                                                       21600000
*********                     CONSTANT EQUATES                ********* 21800000
*                                                                       22000000
LENTRACE EQU   136                 TRACE TABLE LENGTH            A48612 22050002
FULWRD   EQU   X'01'               BFALN MASK FOR FULL WORD      A48612 22060002
BUFCBD   EQU   6                   DISP. TO ADJUST BUFR LENGTH   A48612 22120002
SCUIOBIN EQU   X'10'               MASK TO TEST DCBMRIND FOR SCU IOB    22200000
PIOBLNGH EQU   48                  LENGTH OF PCU IOB                    22400000
SIOBLNGH EQU   48                  LENGTH OF SCU IOB                    22600000
PCHANPGM EQU   80                  LENGTH OF PCU CHANNEL PROGRAM        22800000
SCHANPGM EQU   72                  LENGTH OF SCU CHANNEL PROGRAM        23000000
MICBLNGH EQU   28                  LENGTH OF MICB TABLE ENTRY           23200000
WDBUFL   EQU   128                 LENGTH OF WRITE DELAY BUFFERS        23400000
ECBLSTLG EQU   64                  LENGTH OF ECB LIST                   23600000
EXTONE   EQU   X'01'               NUMBER OF EXTENTS FOR DEB            23800000
IOBSTRT  EQU   24                  DISP TO ADDR OF PCU CP IN IOB        24000000
SAVEAR   EQU   72                  LENGTH OF REGISTER SAVE AREA         24200000
BUFACQIN EQU   X'08'               MASK TO TEST BUFFER ACQUISTION TECH. 24400000
BUFCBL   EQU   8                   NORMAL CONTROL BLOCK LENGTH   A48612 24500000
RSTRVAL  EQU   X'01'               RESTORE VALUE FOR DCB VECTORS        24800000
RSTRBAB  EQU   X'F7'               MASK TO SET OFF BUF ACQ. BIT         25000000
NULL     EQU   X'00'               NULL MASK                            25200000
WGOFF    EQU   8                   LENGTH OF WTG TABLE ENTRY            25400000
PARMOFF  EQU   4                   LENGTH OF DCB ENTRY IN PARM LIST     25600000
WAOFF    EQU   32                  DISP TO IDTTR ENTRIES IN WTG TAB     25800000
PURGMSK  EQU   X'A0'               MASK TO SET PURGE OPTIONS            26000000
SPNUMBER EQU   250                 SUBPOOL NUMBER                       26006002
SHIFTNO  EQU   24                  NUMBER BITS TO SHIFT SP NUMBER       26012002
UNCOND   EQU   15                  MASK FOR UNCONDITIONAL BRANCH        26018000
KZERO    EQU   0                   CONSTANT OF ZERO                     26024000
DZERO    EQU   0                   DISP OF ZERO                         26030000
KWTGWK   EQU   4                   DISP TO DCB WORK AREA IN WTG ADDR    26036000
DEBUCBL  EQU   4                   LENGTH OF UCB ADDR IN DEB            26042000
DEBSUCBA EQU   36                  DISP TO SECOND UCB ADDR IN DEB       26048000
DBBUFCBL EQU   3                   LENGTH OF DCBBUFCB FIELD IN DCB      26054000
KONE     EQU   1                   CONSTANT OF ONE                      26060000
KTHREE   EQU   3                   CONSTANT OF THREE                    26066000
DBBUFLL  EQU   2                   LENGTH OF DCBBUFL FIELD IN DCB       26072000
DBSSIDL  EQU   8                   LENGTH OF DCBSSID FIELD IN DCB       26078000
DBCHECKL EQU   3                   LENGTH OF DCBCHECK FIELD IN DCB      26084000
DBECBLTL EQU   4                   LENGTH OF DCBECBLT FIELD IN DCB      26090000
ROUTIDL  EQU   2                   LENGTH OF ROUTINE ID                 26096000
EQUAL    EQU   8                   MASK FOR BRANCH EQUAL                26102000
LOW      EQU   4                   MASK FOR BRANCH LOW                  26108000
HIGH     EQU   2                   MASK FOR BRANCH HIGH                 26114000
NE       EQU   7                   MASK FOR BRANCH NOT EQUAL            26120000
DID      EQU   6                   DISP IN MOD NAME TO ID               26126000
PURGLST  EQU   12                  LENGTH OF PURGE PARM LIST            26150000
DLKFLD   EQU   8                   DISP TO LINK FIELD PURGE LIST        26156000
DECBPURG EQU   4                   DISP TO ECB PURGE LIST               26162000
ORGTTR   EQU   1000                DISP TO TTR TABLE FROM START OF MOD  26168002
         EJECT                                                          26170002
         USING IHADCB,RDCB                                              26200000
         USING IGGD0100,RBASE                                           26400000
         USING DEBD0100,RDEB                                            26600000
         USING FORCORE,RCORE                                            26800000
         BALR  RBASE,KZERO         SET UP CSECT BASE                    27000000
IGGD0100 EQU   *                                                        27200000
         L     RDCB,DZERO(RPARMC)  LOAD ADDR OF DCB TO BE CLOSED        27400000
         L     RDEB,DCBDEBAD       LOAD ADDR OF RELATED DEB             27600000
         L     RCORE,KWTGWK(RWTGC) LOAD ADDR OF DCB WORK AREA           27800000
         SPACE 2                                                        27802002
*                                                                       27804002
* THE FOLLOWING WILL TEST A BIT IN DCBMRIND TO DETERMINE IF THE ADDR    28000002
* IN DCBIOBAD POINTS TO THE PCU IOB OR TO THE SCU IOB.  IF IT POINTS    28200002
* TO THE SCU IOB, THE FIELD IS UPDATED TO POINT TO THE PCU IOB.         28400002
*                                                                       28600000
         L     RIOB,DCBIOBAD       LOAD IOB ADDRESS                     28800000
         TM    DCBMRIND,SCUIOBIN   TEST IF ADDR FOR PCU OR SCU          29000000
         BZ    IGGD0200            PCU/GO PURGE QUEUES                  29200000
         LA    RWRK1,PIOBLNGH      LOAD LENGHT OF PCU IOB               29400000
         LA    RIOB,KZERO(RIOB)    CLEAR HIGH ORDER BITS                29600000
         SR    RIOB,RWRK1          CALCULATE PCU IOB ADDR               29800000
         ST    RIOB,DCBIOBAD       UPDATE IOB ADDR IN DCB               30000000
         SPACE 2                                                        30002002
*                                                                       30200000
* THE FOLLOWING WILL PURGE THE QUEUES FOR THE PCU AND SCU VIA           30400000
* THE INTERNAL SUBROUTINE PURG0000.                                     30600002
*                                                                       30602002
IGGD0200 EQU   *                                                        30800000
         LA    RWRK2,PURG0000      LOAD ADDR OF PURGE SUBROUTINE        31000000
         BALR  RWRK1,RWRK2         GO PURGE PCU QUEUES                  31400000
         EJECT                                                          32600000
************************ FREE STORAGE ROUTINES ************************ 32800000
*                                                                       33000000
* THE FOLLOWING ROUTINE WILL FREE STORAGE FOR THE FOLLOWING:            33200000
*        1. CHANNEL PROGRAMS FOR THE PCU AND SCU                        33400002
*        2. BUFFERS FOR THE WRITE DELAY COMMAND                         33600002
* FREEMAIN IS ISSUED IN THE INTERNAL SUBROUTINE FREE0000                33800000
*                                                                       34000000
         MODESET KEYADDR=DXUKEY,WORKREG=1  CHANGE TO USER'S KEY  Y02072 34002002
         LA    RWRK2,FREE0000      LOAD ADDR OF FREE0000 SUBROUTINE     34200000
         L     RPARM1,IOBSTRT(RIOB) LOAD ADDR OF START OF PCU CP        34400000
         LA    RPARME,PCHANPGM     LOAD LENGTH OF PCU CP                34600000
         LA    RPARME,SCHANPGM(RPARME)  ADD LENGTH OF SCU CP            34800000
         LA    RPARM0,WDBUFL(RPARME)    ADD LENGTH OF WD BUFFERS        35000000
         BALR  RWRK1,RWRK2         GO FREE CP'S AND WD BUFFERS          35200000
         SPACE 2                                                        35202002
*                                                                       35400000
* THE FOLLOWING ROUTINES WILL FREE STORAGE FOR THE FOLLOWING:           35600000
*        1. IOB'S FOR PCU AND SCU                                       35800002
*        2. MICB TABLE                                                  36000002
*        3. REGISTER SAVE AREA                                          36200002
*        4. TRACE TABLE                                                 36202002
* FREEMAIN IS ISSUED IN THE INTERNAL SUBROUTINE FREE0000                36400000
*                                                                       36600000
         TM    DCBCIND2,DCBCNBFP  DID OPEN GET BUFFER POOL     @ZA07021 36610003
         BO    SKPFREE             DONT FREE BUFFS/POOL WILL BE@ZA07021 36620003
         TM    DCBBUFCB+3,DCBBIT7  HAS POOL BEEN FREED         @ZA07021 36630003
         BO    SKPFREE             YES DONT FREE BUFFERS       @ZA07021 36640003
*                                                              @ZA07021 36650003
         LR    RPARM1,RDCB         LOAD ADDR OF DCB            @ZA07021 36660003
         SR    RWRK1,RWRK1         ZERO WORK REGISTER          @ZA07021 36670003
         IC    RWRK1,DCBBUFNO      INSERT NUMBER OF BUFFERS    @ZA07021 36680003
         LTR   RWRK1,RWRK1         ALL BUFFERS FREE            @ZA07021 36690003
         BZ    SKPFREE             YES DONT FREE ANY MORE      @ZA07021 36700003
         LA    RUCB,PIOBLNGH+SIOBLNGH+LENTRACE+SAVEAR(RIOB)    @ZA09994 36710003
FRBUF    L     RPARMF,24(RUCB)    POINT TO BUFFER              @ZA09994 36720003
         FREEBUF  (1),(RPARMF)     PUT BUFFER BACK IN POOL     @ZA07021 36730003
         L     RUCB,0(,RUCB)     POINT TO NEXT BUFFER          @ZA09994 36740003
         BCT   RWRK1,FRBUF         GO FREE NEXT BUFFER         @ZA07021 36780003
SKPFREE  EQU   *                                               @ZA07021 36790003
         LR    RPARM1,RIOB         LOAD ADDR OF PCU IOB                 36800000
         SR    RPARMF,RPARMF       ZERO WORK REGISTER                   37000000
         IC    RPARMF,DCBBUFNO     INSERT NUMBER OF BUFFERS             37200000
         LA    RWRK1,MICBLNGH      LOAD LENGTH OF MICB TABLE ENTRY      37400000
         MR    RPARME,RWRK1        CALCULATE LENGTH MICB TABLE          37600000
         LA    RPARMF,PIOBLNGH(RPARMF)  ADD LENGTH OF PCU IOB           37800000
         LA    RPARMF,SIOBLNGH(RPARMF)  ADD LENGTH OF SCU IOB           38000000
         LA    RPARMF,LENTRACE(RPARMF)  ADD LEN. OF TRACE TABLE  A48612 38050021
         LA    RPARM0,SAVEAR(RPARMF)    ADD LENGTH OF REG SAVE AREA     38200000
         BALR  RWRK1,RWRK2         FREE IOBS,MICB TABLE,SAVE AREA       38400000
         SPACE 2                                                        38402002
*                                                                       38600000
* THE FOLLOWING ROUTINE WILL FREE THE ECB LIST.  FREEMAIN IS ISSUED     38800002
* IN THE INTERNAL SUBROUTINE FREE0000.                                  39000000
*                                                                       39200000
         L     RPARM1,DCBECBLT     LOAD ADDR OF ECB LIST                39400000
         LA    RPARM0,ECBLSTLG     LOAD LENGTH                          39600000
         BALR  RWRK1,RWRK2         GO FREE ECB LIST                     39800000
         EJECT                                                          40000000
************************ FREE BUFFER POOL ROUTINE ********************* 40200000
*                                                                       40400000
* THE FOLLOWING WILL FREE THE BUFFER POOL IF OPEN ACQUIRED THE BUFFERS. 40600000
* IN ADDITION, SEVERAL VECTORS IN THE DCB, DCBBUFCB AND DCBBUFL, ARE    40800002
* RESTORED TO THEIR PRE-OPEN VALUES IF OPEN ACQUIRED THE BUFFERS.       41000002
*                                                                       41200000
         TM    DCBBUFCB+3,DCBBIT7  HAS BUFF POOL BEEN FREED    @ZA07021 41260003
         BO    IGGD0300            YES  GO CLEAR VECTOR FIELDS @ZA07021 41330003
         TM    DCBCIND2,BUFACQIN   DID OPEN ACQUIRE BUFFERS             41400000
         BZ    IGGD0300            NO/GO CLEAR VECTOR FIELDS            41600000
         TM    DCBBUFCB+3,DCBBIT7  HAS BUFFER POOL BEEN FREED  @ZA07021 41660003
         BO    IGGD0300            YES/GO CLEAR VECTOR FIELDS  @ZA07021 41720003
         L     RPARM1,DCBBUFCB     LOAD ADDRESS OF BUFFER CNTRL BLK     41800000
         SR    RPARMF,RPARMF       ZERO WORK REGISTER                   42000000
         IC    RPARMF,DCBBUFNO     INSERT NUMBER OF BUFFERS             42200000
         LH    RWRK1,BUFCBD(RPARM1) LOAD ADJ. BUF. LEN.          A48612 42400000
         MR    RPARME,RWRK1        CALCULATE LENGTH BUFFER POOL         42600000
         TM    DCBBFALN,FULWRD     TEST FULL WORD NOT DOUBLE     A48612 42700002
         LA    RPARM0,BUFCBL(RPARMF) ASSUME USUAL ALIGNMENT      A48612 42760000
         BZ    BUFPOOL1            FULL WORD BIT IS OFF          A48612 42820002
         LA    RPARM0,BUFCBL+8(RPARMF)  EXTRA 8 FOR FULL WORD    A48612 42880000
BUFPOOL1 EQU   *                                                 A48612 42940000
         BALR  RWRK1,RWRK2         GO FREE BUFFER POOL                  43000000
         MODESET EXTKEY=DATAMGT    RETURN TO DATA MANAGEMENT KEY Y02072 43002002
         XC    DCBBUFCB+KONE(DBBUFCBL),DCBBUFCB+KONE  CLEAR BUFCB ADDR  43200000
         OI    DCBBUFCB+KTHREE,RSTRVAL  RESTORE TO PRE-OPEN VALUE       43400000
         XC    DCBBUFL(DBBUFLL),DCBBUFL RESTORE BUFFER LENGTH           43600000
         NI    DCBCIND2,RSTRBAB    SET BUFFER ACQUISITION BIT OFF       43800000
         EJECT                                                          44000000
************************ RESTORE DCB VECTOR ROUTINE ******************* 44200000
*                                                                       44400000
* THE FOLLOWING ROUTINE WILL RESTORE THE FOLLOWING VECTORS TO THEIR     44600000
* PRE-OPEN VALUES:                                                      44800000
*        1. DCBSSID                                                     45000002
*        2. DCBIOBAD                                                    45200002
*        3. DCBCHECK                                                    45400002
*        4. DCBIOBA                                                     45600002
*        5. DCBNCP                                                      45800002
*        6. DCBEOBR                                                     46000002
*        7. DCBCNTRL                                                    46200002
*        8. DCBMRIND                                                    46400002
*        9. DCBECBLT                                                    46600002
*       10. DCBIOBL                                                     46800002
*       11. DCBMRFLG                                                    47000002
*       12. DCBAPPIN                                                    47200002
*                                                                       47400000
IGGD0300 EQU   *                                                        47600000
         MODESET EXTKEY=DATAMGT    RETURN TO DATA MANAGEMENT KEY Y02072 47602002
         MVC   DCBSSID(DBSSIDL),DEBSSID MOVE SS ID BACK INTO DCB        47800000
         LA    RWRK1,RSTRVAL       LOAD RESTORE VALUE INTO REG          48000000
         ST    RWRK1,DCBIOBAD      RESTORE IOB ADDRESS                  48200000
         XC    DCBCHECK+KONE(DBCHECKL),DCBCHECK+KONE   CLEAR CHECK      48300000
*                                  MODULE ADDRESS                       48400002
         OI    DCBCHECK+KTHREE,RSTRVAL  RESTORE TO PRE-OPEN VALUE       48500000
         ST    RWRK1,DCBIOBA       RESTORE MICB READ ADDR               48800000
         ST    RWRK1,DCBNCP        RESTORE NCP TO ZERO                  49000000
*                                  AND EOB MODULE ADDR TO 1             49200000
         ST    RWRK1,DCBCNTRL      RESTORE CONTROL MODULE ADDR          49400000
         XC    DCBECBLT(DBECBLTL),DCBECBLT  RESTORE ECB LIST ADDR       49500000
*                                  AND DCBMRIND INDICATORS              49600002
         NI    DCBIOBL,NULL        ZERO IOB LENGTH                      49800000
         NI    DCBMRFLG,NULL       ZERO INDICATOR                       50000000
         NI    DCBAPPIN,NULL       ZERO INDICATOR                       50200000
         SPACE 2                                                        50202002
****                                                                    50204002
****     REFRESH THE USER'S DCB                                         50206002
****                                                                    50208002
         USING WTG,RWTG            EST WHERE-TO-GO TBL BASE REG  Y02072 50210002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(R0,R14,WTGPREFX)        Y02072 50212002
         DROP  RWTG                DROP WHERE-TO-GO TBL BASE REG Y02072 50214002
         SPACE 2                                                        50400002
************************ DELETE USER SS ROUTINE *********************** 50600000
*                                                                       50800000
* THE FOLLOWING WILL DELETE THE USER'S STACKER SELECT ROUTINE           51000000
*                                                                       51200000
         LA    RPARM0,DCBSSID      LOAD ADDR OF USER'S SS ID IN DCB     51400000
         DELETE EPLOC=(0)          DELETE USER'S SS ROUTINE             51600000
*                                                                       51800000
         MVI   DZERO(RWTGC),NULL   DEACTIVATE THIS ENTRY                52000000
         SPACE 2                                                        52002002
************************ WTG TABLE SEARCH ***************************** 52400000
*                                                                       52600000
* THE FOLLOWING ROUTINE WILL SEARCH THE WTG TABLE FOR THE NEXT ENTRY    52800000
* WHICH REQUIRES THIS EXECUTOR OR FOR END OF TABLE THEN EXIT VIA XCTL   53000000
*                                                                       53002002
IGGD0400 EQU   *                                                        53200000
         LA    RWTGC,WGOFF(RWTGC)  INCREMENT TO NEXT WTG TABLE ENTRY    53400000
         LA    RPARMC,PARMOFF(RPARMC) INCREMENT TO NEXT PARM ENTRY      53600000
         CLC   DZERO(ROUTIDL,RWTGC),ROUTNID  NEXT DCB REQUIRE THIS MOD  53800000
         BCR   EQUAL,RBASE         YES/RECURSE THROUGH MODULE           54000000
         CLC   DZERO(ROUTIDL,RWTGC),CLLDB    IS THIS END OF TABLE       54200000
         BC    LOW,IGGD0400        NO-GO INCREMENT TO NEXT ENTRY        54400000
         CLC   DZERO(ROUTIDL,RWTGC),CLLDG    IS THIS END OF TABLE       54600000
         BC    HIGH,IGGD0400       NO-GO INCREMENT TO NEXT ENTRY        54800000
         LR    RPARMC,RPARM        RESTORE TO START OF PARM LIST        55000000
         LA    RWTGC,WAOFF(RWTG)   POINT TO FIRST IDTTR IN WTG TABLE    55200000
IGGD0500 EQU   *                                                        55400000
         CLI   DZERO(RWTGC),NULL   IS THIS ENTRY ACTIVE                 55600000
         BC    NE,IGGD0600         YES/GO TRANSFER CONTROL              55800000
         LA    RWTGC,WGOFF(RWTGC)  INCREMENT TO NEXT ENTRY              56000000
         LA    RPARMC,PARMOFF(RPARMC) INCREMENT TO NEXT ENTRY           56200000
         B     IGGD0500            GO TEST NEXT ENTRY                   56400000
IGGD0600 EQU   *                                                        56600000
         MVC   DID(ROUTIDL,RWTG),DZERO(RWTGC)  MOVE ID INTO NAME        56800000
         XCTL  EPLOC=(RWTG),SF=(E,DXCCW12),DCB=0  TRANSFER CONTROL      57200002
         EJECT                                                          57600000
************************ PURGE ROUTINE ******************************** 57800000
*                                                                       58000000
* THE FOLLOWING ROUTINE WILL BUILD THE PURGE LIST IN THE DCB WORK AREA  58200000
* AND THEN ISSUE A PURGE MACRO TO PURGE THE QUEUES FOR THE PCU OR SCU.  58400000
* THE PURGE OPTIONS WHICH ARE SET ARE                                   58600000
*        1. PURGE ONLY THE REQUEST ELEMENTS ASSOCIATED WITH DEB         58800002
*        2. DO NOT POST THE PURGE REQUEST                               59000002
*        3. HALT THE I/O OPERATION                                      59200002
*        4. PURGE ALL REQUESTS                                          59400002
*        5. PURGE AEQ, RB, AND LOGICAL CHANNEL QUEUES                   59600002
*        6. PURGE BY DEB                                                59800002
*                                                                       60000000
PURG0000 EQU   *                                                        60200000
         XC    DXCCW6(PURGLST),DXCCW6   CLEAR AREA FOR PURGE LIST       60400000
         ST    RDEB,DXCCW6         STORE DEB ADDR IN LIST               60600000
         MVI   DXCCW6,PURGMSK      SET PURGE OPTIONS                    60800000
         LA    RPARM1,DEBUSRPG     LOAD ADDR OF USER'S LINK FIELD       61000000
         ST    RPARM1,DXCCW6+DLKFLD     STORE LINK FIELD ADDR INTO LIST 61200000
         LA    RPARM1,DXCCW6       LOAD ADDR OF PURGE LIST              61400000
         PURGE (1)                 PURGE                                61600000
         LA    RPARM1,DXCCW6+DECBPURG   LOAD ADDR ECB FOR PURGE         61800000
         WAIT  ECB=(1)             WAIT FOR PURGE                       62000000
         BCR   UNCOND,RWRK1        RETURN TO MAINLINE                   62200000
         SPACE 2                                                        62400002
************************ FREE STORAGE ROUTINE ************************* 62600000
*                                                                       62800000
* THE FOLLOWING IS AN INTERNAL SUBROUTINE WHICH WILL ISSUE A FREEMAIN   63000000
* TO FREE STORAGE.  BEFORE THIS ROUTINE IS ENTERED, REGISTER 0 MUST BE  63200002
* LOADED WITH THE LENGTH OF THE AREA TO BE FREED AND REGISTER 1 WITH    63400000
* THE STARTING ADDRESS OF THE AREA TO BE FREED.                         63600000
*                                                                       63602002
FREE0000 EQU   *                                                        63800000
         LA    RPARMF,SPNUMBER     LOAD SUBPOOL NUMBER                  63850002
         SLL   RPARMF,SHIFTNO      SHIFT SP NO TO HI ORDER BITS         63900002
         OR    RPARM0,RPARMF       PUT SUBPOOL NUMBER IN REG            63950002
         FREEMAIN R,LV=(0),A=(1)   FREE STORAGE                         64000000
         BCR   UNCOND,RWRK1        RETURN TO MAINLINE                   64200000
         EJECT                                                          64202002
*********************************************************************** 64400000
*                                                                       64600000
************************ CONSTANTS ************************************ 64800002
*                                                                       65000000
CLLDB    DC    C'0B'               ID OF MODULE IGG0200B         Y02072 65400002
CLLDG    DC    C'0G'               ID OF MODULE IGG0200G         Y02072 65600002
ROUTNID  DC    C'1D'               ID OF THIS ROUTINE                   65602002
         DC    C'IGG0201D'                    SIGHT INDICATOR  @ZA07621 65604003
         DC    CL8'&SYSDATE'                  SIGHT INDICATOR  @ZA07621 65604303
         DC    C'Z07621'                      SIGHT INDICATOR  @ZA07621 65604603
PATCH    DC    42X'0',D'0'             PATCH AREA              @ZA07621 65605003
MODLEN   EQU   *                   LENGTH OF THIS MODULE         Y02072 65606002
         SPACE 2                                                        66800002
************************ DSECT DEFINITION ***************************** 67000000
*                                                                       67200000
* THE FOLLOWING ARE DSECTS REQUIRED BY THIS EXECUTOR                    67400000
*                                                                       67600000
         CVT   DSECT=YES                                         Y02072 67602002
         SPACE 3                                                        67604002
         DCBD  DSORG=BS,DEVD=MR                                         68002002
         EJECT                                                          68004002
DEBD0100 DSECT                                                          68200000
DEBNMSUB DS    0CL1                                                     68400000
DEBTCBAD DS    CL4                                                      68600000
DEBAMLNG DS    0CL1                                                     68800000
DEBDEBAD DS    CL4                                                      69000000
DEBOFLGS DS    0CL1                                                     69200000
DEBIRBAD DS    CL4                                                      69400000
DEBOPATB DS    0CL1                                                     69600000
DEBSYSPG DS    CL4                                                      69800000
DEBNMEXT DS    0CL1                                                     70000000
DEBUSRPG DS    CL4                                                      70200000
DEBPRIOR DS    0CL1                                                     70400000
DEBECBAD DS    CL4                                                      70600000
DEBPROTG DS    0CL1                                                     70800000
DEBDEBID DS    0CL1                                                     71000000
DEBDCBAD DS    CL4                                                      71200000
DEBEXSCL DS    0CL1                                                     71400000
DEBAPPAD DS    CL4                                                      71600000
DEBDVMOD DS    0CL1                                                     71800000
DEBUCBAD DS    CL4                                                      72000000
DEBUCBA2 DS    CL4                                                      72200000
DEBSUBID DS    CL8                                              SA62501 72400002
DEBSSID  DS    CL8                                                      72600000
         SPACE 3                                                        72602002
         IECDSECS (MAIN,(IOB,NO)),PREFX,WTG,EXPAND=YES           Y02072 72604002
         END                                                            73000000
