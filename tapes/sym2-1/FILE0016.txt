./  ADD  SSI=80690099,NAME=IEHDANAL
         TITLE 'IEHDANAL DISK/DRUM ANALYSIS AND FORMAT MODULE.'         00081016
         COPY  LCGASMSW                                                 00081100
IEHDANAL CSECT                                                          00081203
*********************************************************************** 00084340
*                  FIXES THIS MODULE                                  * 00086340
*                     LATEST FIRST                                    * 00086740
*********************************************************************** 00087140
*                                                                       00087240
*C 024140                                                      @ZA27283 00087499
*D 460004,460008       ERRORFLAG EXTRA TRACK  MVS ONLY         @ZA27283 00088399
*C 24140                            @XA19389=@YA20174=@SA80138=@ZA29674 00089299
*A 719906-719908,719994             @XA19389=@YA20174=@SA80138=@ZA29674 00090199
*                                                                       00093399
*A 24020                            @YA15356=@XA16937=@SA75605=@ZA16492 00094299
*                                                                       00095199
*D 275538                                    @XA12907=@YA12933=@ZA10914 00101640
*C 24140,275307,275559                       @XA12907=@YA12933=@ZA10914 00105940
*A 275234-275254                             @XA12907=@YA12933=@ZA10914 00110240
*                                                                       00114540
*          VS/2 RELEASE 3.0 DELETIONS/CHANGES                           00118840
*                                                              @Y30LSFY 00123140
*                                                              @ZA04403 00127440
*          RELEASE 21 DELETIONS/CHANGES                                 00131703
*                                                               XM4389  00136003
* 1251136400-136560                                             A46360  00140303
*                                                                A44094 00144603
*1251878880-879040                                               A43248 00148903
*1251                                                            M0137  00153203
*304320 - 304360                                                 M0967  00157503
*        RELEASE 20 DELETIONS                                         * 00161803
*3463954400                                                      M4683  00166103
*3463                                                            A35813 00170403
*3463953600-954400                                               M3966  00174703
*3463825000                                                      M5900  00179003
*3463000820,924000,954400                                        JUDITH 00183303
*3463275320                                                      M5723  00187603
*3463275800                                                      A35837 00191903
*3463084000-084800,275800                                        S20201 00196203
*3463953600-954400                                               S20201 00200503
*                                                                M4682  00204803
*        RELEASE 18 DELETIONS                                           00209103
*1453152800,238400,240800                                        1352   00213403
*                                                                       00217703
*STATUS CHANGE LEVEL 003                                                00222003
*********************************************************************** 00226340
         EJECT                                                          00230640
*FUNCTION/OPERATION- THIS ROUTINE PERFORMS SURFACE ANALYSIS AND         00234903
*   FORMATTING OF ALL OS 360 SUPPORTED  DIRECT ACCESS DEVICES EXCEPT  * 00239203
*   THE 2321 DATA CELL. (DATA CELL ANALYSIS IS PERFORMED BY IEHDCELL) * 00243503
*   SURFACE ANALYSIS CONSISTS OF WRITING AND READING A SERIES OF BIT  * 00247803
*   PATTERNS. THREE DIFFERENT BIT PATTERNS ARE WRITTEN AND READ ON  A * 00252103
*   TRACK. FOR DISK THESE PATTERNS ARE 1) A FULL TRACK OF X'55'S,     * 00256403
*   2) A FULL TRACK OF X'00'S AND 3) A STANDARD 16 BYTE R0. FOR A     * 00260703
*   DRUM DEVICE ONLY THE FIRST PATTERN IS DIFFERENT WHICH IS X'5A'S.  * 00265003
*   THIS ROUTINE CAN ANALYZE BOTH PRE-ANALYZED AND UNANALYZED DEVICES * 00269303
*   FOR UNANALYZED DEVICES,DRUMS AND PREFLAGGED TRACK TESTING  SUP-   * 00273603
*   PRESSED THE FIRST CCW IN SURFACE ANALYSIS CHANNEL PROGRAM IS      * 00277903
*   MODIFIED FROM A SEARCH HOME ADDRESS TO A WRITE HOME ADDRESS.      * 00282203
*   THIS ROUTINE ALSO WRITES AND READ STANDARD R0 WITHOUT PERFORMING  * 00286503
*   SURFACE WHENEVER FORMAT IS REQUESTED.                             * 00290803
*                                                                     * 00295103
*ENTRY POINTS- THE ONLY ENTRY POINT IS IEHDANAL AND CONTROL IS ALWAYS * 00299403
*   RECEIVED FROM THE MONITOR (IEHDASDS).                             * 00303703
*                                                                     * 00308003
*INPUTS- UPON ENTRY REGISTER 10 POINTS TO A FUNCTION BLOCK, REGISTER  * 00312303
*   12 POINTS TO A COMMUNICATION WORKAREA,REGISTER 13 HAS A POINTER   * 00316603
*   TO A REGISTER SAVE AREA,AND REGISTER 14 HAS THE RETURN ADDRESS.   * 00320903
*                                                                     * 00325203
*EXITS-NORMAL- A SUCCESSFUL COMPLETION RESULTS IN A RETURN TO THE     * 00329503
*   MONITOR(IEHDASDS) WITH A 0 RETURN CODE AND A COMPLETE MESSAGE IN  * 00333803
*   THE MESSAGE DATA SET.                                             * 00338103
*                                                                     * 00342403
*EXITS-ERROR- ANY UNSUCCESSFUL COMPLETION RESULTS IN A RETURN TO THE  * 00346703
*   MONITOR(IEHDASDS) WITH THE APPROPRIATE MESSAGE(S) DESCRIBING THE  * 00351003
*   ERROR CONDITIONS.                                                 * 00355303
*                                                                       00359603
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS INVOKED BY THE MONITOR.    * 00363903
*   IT IN TURN INVOKES THE FOLLOWING EXTERNAL ROUTINES.               * 00368203
*        1) THE RESIDENT CONVERT ROUTINES(CVTPCNVT AND CVTPRLTV) TO   * 00372503
*           CONVERT TTR TO MBBCCHHR AND VICE VERSA.                   * 00376803
*        2) IEHDPASS TO PERFORM PASSWORD PROTECTION CHECKS.           * 00381103
*        3) IEHDCELL TO PERFORM SURFACE ANALYSIS ON THE 2321 DATA CELL* 00385403
*        4) IEHDVTOC TO FORMAT AND WRITE THE VTOC,IPL TEXT,AND TRACK  * 00389703
*           ZERO.                                                     * 00394003
*        5) IEHDMSGB TO CONSTRUCT MESSAGES IN A MESSAGE BUFFER.       * 00398303
*        6  IEHDPRNT TO WRITE MESSAGES IN A MESSAGE DATA SET          * 00402603
*        7) SVC 82 TO ASSIGN ALTERNATE TRACKS,POST UCB'S AND CONSTRUCT* 00406903
*           DEB FOR UNANALYZED DEVICES.                               * 00411203
*TABLES/WORKAREAS- REGISTER 10 AND 12 POINT TO A FUNCTION BLOCK AND A * 00415503
*   WORKAREA RESPECTIVELY.                                            * 00419803
*        1) IODEVCON- DEVICE CONSTANT TABLE,DESCRIBED BY CONSTANT     * 00424103
*           DSECT.                                                    * 00428403
*        2) FUNCTION BLOCK- DESCRIBED BY FUNCBLK DSECT                * 00432703
*        3) COPY BLOCK- DESCRIBED BY COPYBLK DSECT.                   * 00437003
*        4) COMMUNICATION VECTOR TABLE- DESCRIBED BY CVT DSECT        * 00441303
*        5) COMMUNCATION WORK AREA- DESCRIBED BY WORK DSECT.          * 00445603
*        6) IEHDANAL WORK AREA- DESCRIBED BY WORKAREA DSECT.          * 00449903
*        7) TRACK ANALYSIS BUFFER- DESCRIBED BY BUFFCORE DSECT.       * 00454203
         EJECT                                                          00458503
REG0     EQU   0                                                        00462803
REG1     EQU   1                  PARAMETER LIST POINTER REG.           00467103
REG2     EQU   2                  UCB POINTER REG.                      00471416
REG3     EQU   3                  COPY BLOCK POINTER REG.               00475716
REG4     EQU   4                  I/O DEV CON TABLE POINTER.            00480016
REG5     EQU   5                                                        00560016
REG7     EQU   7                  BUFFER CORE POINTER.                  00640016
REG8     EQU   8                  CVT POINTER.                          00720016
REG9     EQU   9                                                        00800016
REGA     EQU   10                                                       00880016
REGB     EQU   11                                                       00960016
REGC     EQU   12                 COMMON WORK AREA BASE.                01040016
REGD     EQU   13                 SAVE AREA REGISTER.                   01120016
REGE     EQU   14                 RETURN REGISTER.                      01200016
REGF     EQU   15                 ENTRY POINT REG/CONTROL BLOCK PTR.    01280016
BASEREG  EQU   6                  PROGRAM BASE REGISTER.                01360016
WORKREG  EQU   5                                                        01440016
FBLKREG  EQU   10                 FUNCTION BLOCK BASE.                  01520016
* 276000                                                           O122 01640019
         USING *,BASEREG,REG4                                  @ZA04403 01680050
         USING WORKAREA,WORKREG                                         01760016
         USING WORK1,REGC                                               01840016
         USING BUFFCORE,REG7                                            01920016
         USING FUNCBLK,FBLKREG                                          02000016
         USING CVT,REG8                                                 02080016
         USING CONSTANT,REGE                                   @Z30RSAG 02160003
         USING COPYBLK,REG3                                             02240016
         SAVE  (14,12),T,*        SAVE REGISTER FOR CALLING ROUTINE.    02320016
         LR    BASEREG,REGF       ESTABLISH PROGRAM ADDRESSABILITY.     02400016
         LA    REGB,FBLOCKS       SET UP CONTROL BLOCK BASE    @ZA16492 02402000
         LA    REG4,2048               SET UP                  @ZA04403 02410050
         B     APARNO                   BRANCH AROUND APAR NO  @ZA04403 02412003
         DC    C'ZA27283'               LAST FIX THIS MOD      @ZA27283 02414099
APARNO   LA    REG4,2048(REG4,BASEREG)    SECOND BASE.         @ZA04403 02420050
         L     REGE,PTRCFUNC      GET PTR TO CURR FUNCTION     @ZA04403 02580050
         TM    0(REGE),PROCESS    WAS FUNCT PREVIOUSLY STRTED  @Z30RSAG 02630003
         BZ    GETUCB             NO-BR AND CONTINUE INIALIZATION.      02640016
         L     REGD,SAVEPTR       YES-GET POINTER TO MY SAVE AREA.      02720016
         LM    REGE,REGC,12(REGD) RESTORE MY REGISTERS.                 02800016
         B     RETURNAD                                                 02880016
         EJECT                                                          02930003
*                                                                       02960016
**********************************************************************  03040016
*                                                                       03120016
*   THIS ROUTINE PERFORM THE FOLLOWING FUNCTIONS:                       03200016
*              1. TEST TO SEE IF THE DEVICE CAN BE ANALYZED/FORMATTED.  03280016
*              2. CONVERTS THE EXTENTS FROM UNPACKED DECIMAL TO BINARY. 03360016
*              3. GETS CORE FOR A WORK AREA.                            03440016
*                                                                       03520016
**********************************************************************  03600016
*                                                                       03680016
         USING UCBOB,REG2                                               03760016
GETUCB   EQU   *                                                        03840016
         XC    RETCODE,RETCODE          CLEAR RETURN CODE.      SA59746 03890021
         GETMAIN R,LV=SIZE                                              03920016
         LR    WORKREG,REG1       SET UP REGISTER FOR WORK AREA.        04000016
         XC    WKBUFPTR(8),WKBUFPTR  CLEAR PTR & SIZE OF COND WKAREA.   04080016
         ST    REGD,OLDSAPTR      SAVE POINTER TO OLD SAVE AREA         04160016
         LA    REGF,SAVEAREA                                            04240016
         ST    REGF,8(REGD)       SAVE POINTER TO THIS SAVE AREA        04320016
         LR    REGD,REGF          IN CALLING PROGRAM SAVE AREA.         04400016
         L     REG2,TUCBPTR       GET UCB OF DEVICE TO BE PROCESSED.    04480016
         AIF   ('&LIB' EQ 'LIB2').X227202                       XL03912 04530003
         CLI   UCBID,X'FF'        IS THIS A 2321                        04560016
         BE   NOTDCELL            NO-BYPASS MAIN UCB CALCULATION        04640016
         MVI   FUNCSW,ANALYSIS    SET ANALYZE INDICATOR ON.             04720016
         LA    REG0,SRTEUSER-UCBOB     GET SIZE OF MAIN UCB             04800016
         DROP  REG2                                                     04880016
         USING DATACELL,REG2                                            04960016
         LH    REGF,DCELBBNR      GET BIN NUMBER                        05040016
         SLL   REGF,4             GET LENGTH OF SUB UCBS                05120016
         ALR   REGF,REG0                                                05200016
         SR    REG2,REGF          GET POINTER TO MAIN UCB               05280016
         DROP  REG2                                                     05360016
         USING UCBOB,REG2                                               05440016
NOTDCELL EQU   *                                                        05520016
.X227202 ANOP                                                   XL03912 05560003
         TM    UCBTBYT3,UCB3DACC  IS THIS A DIRECT ACCESS DEVICE.       05600016
         BZ    BADEVICE           NO-PREPARE FOR ERROR RETURN.          05680016
         TM    SRTESTAT,SRTESYSR  IS THIS VOLUME SYSTEM RESIDENT.       05760016
         BO    VOLUMERR           YES-SET UP ERROR MSG.                 05840016
         TM    UCBTBYT2,UCB2OPT3   DO WE HAVE CARNY             XM4389  05850003
         BZ    CARNOT              NO                            S20201 05860020
         OI    SEQSW+D1,RPS                                     XM4389  05870003
CARNOT   EQU   *                        *                        S20201 05880020
         NI    FVTOCPTR+4,X'CF'   SET PROPER SIGN IN VTOC BEGIN.        05920016
         PACK  PRGSAVE(8),FVTOCPTR(5)  PACK INPUT VTOC RTA.             06000016
         CVB   REG0,PRGSAVE       CONVERT PACKED RTA TO BINARY          06080016
         ST    REG0,RTAVTOCS      SAVE RTA OF BEGIN OF VTOC.            06160016
         LA    REG3,1                                                   06240016
         LTR   REG0,REG0          TRACK REQUESTED FOR VTOC.             06320016
         BZ    BADTRADD           YES-SET UP ERROR CONDITION.           06400016
         AIF   ('&LIB' EQ 'LIB2').X227203                       XL03912 06440003
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               06480016
         BZ    TRAKOKAY         NO-CONTINUE PROCESSING.                 06560016
         CR    REG0,REG3        VTOC STARTING TRACK GREATER THAN ONE.   06640016
         BH    TRAKOKAY           YES-CONTINUE PROCESSING.              06720016
         CLI   UCBTBYT4,1         IS THIS A2311.                        06800016
         BE    BADTRADD           YES-SET UP ERROR CONDITION.           06880016
         CLI   UCBTBYT4,3         IS THIS A 2303.                       06960016
         BE    BADTRADD           YES-SET UP ERROR CONDITION.           07040016
TRAKOKAY EQU   *                                                        07120016
.X227203 ANOP                                                   XL03912 07160003
         BAL   REG3,CONVERT       CONVERT RTA TO CCHH.                  07200016
         L     REGE,IODEVCON           ENSURE BASE SET         @Z30RSAG 07250003
         MVC   MBBCCHH1(4),MBBCCHH2+3  SAVE BEGIN CCHH.                 07280016
         NI    FEXTENT+4,X'CF'    SIGN PROPER SIGN IN VTOC LENGTH.      07360016
         PACK  PRGSAVE(8),FEXTENT(5)  PACK INPUT VTOC LENGTH.           07440016
         CVB   REG0,PRGSAVE       CONVERT CTOC LENGTH TO BINARY.        07520016
         ST    REG0,WKBUFPTR       SAVE NUMBER OF TRACKS IN VTOC.       07600016
         LTR   REG0,REG0          ZERO NUMBER OF TRACKS IN VTOC.        07620016
         BZ    BADTRADD           YES-SET UP ERROR CONDITION.           07640016
         A     REG0,RTAVTOCS      COMPUTE ENDING RTA OF VTOC.           07680016
         BCTR  REG0,0             DECREMENT UPPER EXTENT.               07760016
         ST    REG0,RTAVTOCE      SAVE RTA OF END OF VTOC.              07840016
         LR    REG1,REG5          PASS POINTER TO WORKAREA TO IEHDVTOC. 07920016
         STM   REG9,REG2,PRGSAVE  SAVE REGS FOR CONVERT ROUTINE.        08000016
         BAL   REG3,CONVERT2      CONVERT VTOC END RTA TO CCHH.         08080016
         L     REGE,IODEVCON           ENSURE PTR SET          @ZA04403 08090050
         MVC   MBBCCHH1+4(4),MBBCCHH2+3                                 08160016
         L     REG9,LASTORIG                                            08170003
         A     REG9,CONVCYL       GET CCHH OF 1ST ALTERNATE TRACK.      08320016
         AIF   ('&LIB' EQ 'LIB2').X227204                       XL03912 08360003
         CLI   UCBTBYT4,X05            IS THIS A 2321.           S20201 08400020
         BNE   NO2321              NO                            S20201 08480020
         MVC   PRGSAVE(3),LASTORIG     SET UP LAST PRIMARY CONSTANT.    08560016
         LA    REG9,256                                                 08640016
         STC   REG9,PRGSAVE+3      SET TO START OF NEXT CYL.            08720016
         CLI   PRGSAVE+2,4        TEST FOR LAST CYLINDER ON STRIP.      08800016
         BL    ADDCONST           NO-INCREMENT TO NEXT CYL.             08880016
         STC   REG9,PRGSAVE+2      START OF NEXT STRIP.                 08960016
         SLL   REG9,8              SHIFT CONSTANT TO UP STRIP.          09040016
         CLI   PRGSAVE+1,9        TEST FOR LAST STRIP ON SUBCELL.       09120016
         BL    ADDCONST           NO- INCREMENT TO NEXT STRIP.          09200016
         STC   REG9,PRGSAVE+1     YES-SET TO START OF SUBCELL           09280016
         SLL   REG9,8             SHIFT CONSTANT TO UP SUBCELL.         09360016
ADDCONST EQU   *                                                        09440016
         A     REG9,PRGSAVE       INCREMENT PROPER FIELD IN CCHH.       09520016
NO2321   EQU   *                                                        09600016
.X227204 ANOP                                                   XL03912 09640003
         ST    REG9,PRGSAVE       SAVE CCHH FOR LATER USE IN BLDIOBLK.  09680016
         L     REGE,IODEVCON           GET PTR TO DEV. CONS.   @Z30RSAG 09730003
         ST    REG9,FALTDATA      INSERT START ALTERNATE TRACK          09840016
         MVC   FALTDATA+4(2),TOTALALT  AND TOTAL NO OF ALTERNATE TRKS.  09920016
*                                                                       10000016
         LA    REG9,WORKBUFF      GET SIZE OF WORK BUFFER               10080016
         AH    REG9,SACAP         ADD SIZE OF TRACK                     10160016
         SRL   REG9,3                                                   10240016
         SLL   REG9,3                                                   10320016
         LA    REG9,16(REG9)      ALIGN SIZE TO A DOUBLE WORD           10400016
         ST    REG9,WKBUFSI                                             10480016
         LA    REG7,FBUFFPTR      POINTER TO AREA TO STORE BUFFER ADDR  10560016
         GETMAIN EC,LV=(REG9),A=(REG7)                                  10640016
         LTR   REGF,REGF          WAS THE DESIRED CORE AVAILABLE        10720016
         BNE   NOCORIND           NO-INDICATE CORE WAS NOT AVAILABLE    10800016
         L     REG7,FBUFFPTR      GET POINTER TO BUFFER WORKAREA        10880016
         EJECT                                                          10930003
**********************************************************************  10960016
*                                                                       11040016
*    HERE WE DETERMINE IF COPIES ARE TO BE MADE.                        11120016
*                                                                       11200016
**********************************************************************  11280016
*                                                                       11360016
         L     REG3,COPYPTR       PICK UP POINTER TO THE COPY BLOCK     11440016
NEXTCOPY EQU   *                                                        11520016
         LTR   REG3,REG3      ARE THERE MORE COPIES TO BE MADE.         11600016
         BNZ   COPYES             YES- TEST FOR LIKE DEVICE TYPE.       11680016
         L     REG3,COPYPTR       POINT TO THE 1ST COPY BLOCK.          11760016
MVEBLOKS EQU   *                                                        11840016
         USING IHADCB,REGF                                              11920016
         LA    REGF,FBLOCKS       POINT TO THE FUNCTION BLOCK AREA.     12000016
         BAL   REGE,BLDIOBLK      BUILD I/O BLOCKS IN FUNCTION BLOCK.   12080016
         MVC   DCBDDNAM(8),DDNAME2     INSERT DDNAME.                   12160016
         L     REG3,COPYPTR                                             12240016
BLDCOPY  EQU   *                                                        12320016
         LTR   REG3,REG3          TEST FOR MORE COPIES.                 12400016
         BZ    LASTCOPY       NO-GO TEST FOR A NEW VOLUME.              12480016
         LA    REGF,CIOBLOCK      SET UP BASE FOR CONTROL BLOCKS.       12560016
         BAL   REGE,BLDIOBLK      BUILD I/O BLOCKS IN COPY BLOCKS.      12640016
         MVC   DCBDDNAM(8),DDNAME3     PLACE DDNAME INTO COPY DCB.      12720016
         L     REG3,CCOPYPTR      GET POINTER TO NEXT COPY BLK.         12800016
         B     BLDCOPY                                                  12880016
BLDIOBLK EQU   *                  THIS SUBR CONSTRUCTS ECB,IOB AND DCB. 12960016
         MVC   0(72,REGF),DCBCONST     RELOCATE CONTROL BLOCKS.         13040016
         MVC   SEEKADDR+3(4),PRGSAVE SET 1ST ALTERNATE TRK IN IOB.      13120016
         ST    FBLKREG,DCBIOBAD   STORE POINTER TO FBLOCK IN DCB.       13200016
         XC    WKAECB(40),WKAECB  INITIALIZE ECB/IOB.                   13280016
         MVI   WKAIOB,X'42'       SET CMND CHN UNRELATED REQ.           13360016
         LA    REG0,WKAECB                                              13440016
         ST    REG0,ECBADD        ECB POINTER INTO COPY BLK.            13520016
         ST    REGF,DCBADD        DCB POINTER INTO COPY BLK.            13600016
         TM    SEQSW+D1,RPS        IS CARN HERE                 XM4389  13608003
         BZ    NOTCARN             NO                            S20201 13616020
          LA    REG0,CCWSECON           SET UP POINTER TO SET    A46360 13624021
*                                       SECTOR                   A46360 13628021
         ST    REG0,CCWPTR         PUT IN IOB                    S20201 13632020
         B     CARNY                   CONTINUE PROCESS.         S20201 13664020
NOTCARN  EQU   *                        *                        S20201 13672020
         LA    REG0,CCW1CONS                                            13680016
         ST    REG0,CCWPTR        CCW POINTER INTO IOB.                 13760016
CARNY    EQU   *                        *                        S20201 13800020
         MVI   BLKERRCT+1,X'01'                                         13840016
         BR    REGE               RETURN.                               13920016
         EJECT                                                          13970003
*                                                                       14000016
**********************************************************************  14080016
*                                                                       14160016
COPYES   EQU   *   THIS ROUTINE IS ENTERED WHEN COPIES ARE REQUESTED,   14240016
*                  TO DETERMINE IF THE DEVICES ARE ALIKE AND USEABLE.   14320016
*                                                                       14400016
**********************************************************************  14480016
*                                                                       14560016
         L     REG9,CUCBPTR       GET COPY BLOCK UCB POINTER.           14640016
         AIF   ('&LIB' EQ 'LIB2').X227205                       XL03912 14680003
         CLI   UCBID-UCBOB(REG9),X'FF' IS THIS A DATA CELL.             14720016
         BE    NON2321            NO-CHECK FOR LIKE DEVICES             14800016
         LA    REG1,21                                                  14880016
         B     SETMSG             SET UP ERROR MSG IN OUTPUT BUFFER.    14980016
NON2321  EQU   *                                                        15200016
.X227205 ANOP                                                   XL03912 15240003
         CLC   UCBTBYT3(2),UCBTBYT3-UCBOB(REG9)  ARE DEVICES ALIKE.1352 15280018
         BNE   BADCOPY            NO-SET ERROR MSG.                     15360016
         AIF   ('&LIB' EQ 'LIB1').X227200                       XL03130 15370003
         CLI   UCBTBYT4,WIN             IS THIS A 3340?          XM3782 15372003
         BNE   NOTWIN                   NO, SKIP DEV MOD TEST.   XM3782 15374003
         CLC   ODEVMOD,CDEVMOD          ARE DEVICE MODELS SAME? XL03130 15380003
         BNE   BADCOPY                  NO, SET ERROR MSG.      XL03130 15390003
NOTWIN   EQU   *                                                 XM3782 15392003
.X227200 ANOP                                                   XL03130 15400003
         TM    SRTESTAT-UCBOB(REG9),SRTESYSR  IS THIS SYSTEM RESIDENCE. 15440016
         BO    VOLUMERC           SET UP ERROR MSG.                     15520016
LIKEDEV  EQU   *                                                        15600016
         MVC   CALTDATA(6),FALTDATA  SET UP ALTERNATE DATA IN COPYBLKS. 15680016
         L     REG3,CCOPYPTR      PICK UP POINTER TO NEXT COPY BLOCK    15760016
         B     NEXTCOPY           TEST UCB OF THE COPY FUNCTION         15840016
         EJECT                                                          15890003
*                                                                       15920016
**********************************************************************  16000016
*                                                                       16080016
*  CONSTRUCT DUMMY DEB FOR THE RESIDENT CONVERT ROUTINE (CVTPCNVT)      16160016
*        WHEN THIS ROUTINE IS ENTERED REG0 CONTAINS TT IN RIGHT HALF.   16240016
*        THIS SECTION PERFORM THE INITILIZATION BEFORE CALLING CVTPCNVT 16320016
*                                                                       16400016
**********************************************************************  16480016
*                                                                       16560016
CONVERT  STM   REG9,REG2,PRGSAVE  SAVE VOLATILE REG'S                   16640016
         LA    REG9,KDEVSIZE      PICK UP SIZE OF ENTRIES IN DEVCON TBL 16720016
         L     REGE,IODEVCON      GET PTR TO THE DEV CON TBLE  @ZA04403 16800050
         SR    REG8,REG8                                                16880016
         IC    REG8,UCBTBYT4      PICK UP INIT TYPE TO COMPUTE INDEX.   16960016
         AIF   ('&LIB' EQ 'LIB1').X227201                       XL03130 16970003
         CLI   UCBTBYT4,WIN             IS THIS A 3340?         XL03130 16980003
         BNE   GETCON                   NO, GET DEVICE CONSTANT XL03130 16990003
         IC    REG8,ODEVMOD             YES, USE DEV MOD NO.    XL03130 17000003
GETCON   EQU   *                                                XL03130 17010003
.X227201 ANOP                                                   XL03130 17020003
         BCTR  REG8,0                                                   17040016
         MR    REG8,REG8          COMPUTE THE DISPLACEMENT INDEX.       17120016
         AR    REGE,REG9               GET PROPER DEVCON ENT.  @Z30RSAG 17200003
         ST    REGE,IODEVCON      STORE PTR TO DEV CON ENTRY.  @ZA04403 17280050
CONVERT2 EQU   *                                                        17360016
         SLL   REG0,16            POSITON TT IN HIGH ORDER TWO BYTES.   17440016
         ST    REG2,DUCBPTR       SET UP UCB POINTER.                   17520016
         MVI   DEXTNTNO,1           **   EXTENT NUMBER.                 17600016
         XC    DEXTNTS(4),DEXTNTS  **  BEGIN CCHH.                      17680016
         MVC   DEXTNTE(4),LASTORIG  **   END CCHH                       17760016
         MVC   DEXTNTR(2),TOTALPRM  **   TOTAL PRIMARY TRK              17840016
         LA    REG1,DDEB            **   DUMMY DEB POINTER              17920016
         LA    REG2,MBBCCHH2        **   MBBCCHHR AREA                  18000016
         L     REG8,CVTPTR               RESTORE CVT BASE               18080016
         L     REGF,CVTPCNVT        GET ENTRY POINT.                    18160016
         BALR  REGE,REGF            CALL CONVERT                        18240016
         LM    REG9,REGE,PRGSAVE    RESTORE PART OF VOLATILE REG        18320016
         L     REGE,IODEVCON        GET PTR TO THE DEV CON TBLE@ZA04403 18370050
         LTR   REGF,REGF            IS THIS A VALID EXTENT FOR THE VTOC 18400016
         BNZ   BADTRKAD                NO-SET UP ERROR MSG.             18480016
         LM    REGF,REG2,PRGSAVE+24    RESTORE REMAINING REGS.          18560016
         BR    REG3               RETURN.                               18640016
         EJECT                                                          19410003
LASTCOPY EQU   *                                                        19440016
         TM    SEQSW+D1,MSSFLG          MSS CONVERSION?        @Y30LSFY 19490003
         BO    NUVOLUME           YES - TEST FOR VOLUME OFFLINE@Y30LSFY 19500003
         CLI   DDNAME2,X'40'      IS THIS A NEW VOLUME.                 19520016
         BE    NUVOLUME           YES-TEST FRO VOLUME OFFLINE.          19600016
         LA    REGF,FBLOCKS                                             19680016
OPEN1    EQU   *                                                        19760016
         LA    REG0,RDAREA1       GET ADDRESS OF JFCB READ IN AREA.     19840016
         ST    REG0,LIST          PLACE ADDR IN RDJFCB LIST             19920016
         MVI   LIST,X'87'         SET RDJFCB AND LAST ENTRY INDICATOR.  20000016
         LA    REGE,LIST                                                20080016
         ST    REGE,DCBEXLST      STORE EXIT LIST ADDRESS INTO DCB.     20160016
         BAL   REG8,READJFCB      READ JFCB AND OPEN VTOC.              20240016
         L     REG3,COPYPTR       GET POINTER TO COPY BLOCK             20320016
COPYOPEN EQU   *                                                        20400016
         LTR   REG3,REG3          ANOTHER COPY REQUESTED                20480016
         BZ    NOCOPIES           NO-TEST FOR 2321                      20560016
         LA    REGF,CIOBLOCK      POINT TO DCB.                         20640016
         LA    REGE,LIST          GET POINTER TO DCB EXIT LIST.         20720016
         ST    REGE,DCBEXLST      STORE EXIT LIST ADDR INTO COPY DCB.   20800016
         BAL   REG8,READJFCB      READ JFCB AND OPEN COPY VTOC.         20880016
         L     REG3,CCOPYPTR      GET NEXT COPY BLOCK POINTER           20960016
         B     COPYOPEN           LOOP UNTIL FINISH                     21040016
         EJECT                                                          21090003
*                                                                       21120016
**********************************************************************  21200016
*                                                                       21280016
READJFCB EQU   *        HERE THE JFCB'S ARE READ AND VTOC ARE OPENED.   21360016
*                                                                       21440016
**********************************************************************  21520016
*                                                                       21600016
         DROP  REGF                                                     21680016
         USING IHADCB,REG9                                              21760016
         MVI   OPENLD,X'8F'       SET UP OUTPUT INDICATOR.              21840016
         LR    REG9,REGF          SET UP TEMPORARY CONTROL BLOCKS BASE. 21920016
         RDJFCB  ((REG9)),MF=(E,OPENLD) READ JFCB INTO CORE.            22000016
         L     REGF,LIST          GET POINT TO JFCB .                   22080016
         USING JFCB,REGF                                                22160016
         OI    JFCBTSDM,X'08'     STOP JFCB REWRITE                     22240016
         MVI   JFCBDSNM,X'04'                                           22320016
         MVC   JFCBDSNM+1(43),JFCBDSNM  SET UP DATA SET NAME            22400016
         OPEN  MF=(E,OPENLD),TYPE=J    OPEN PRIMARY DCB                 22480016
         LR    REGF,REG9               RESTORE PERMANENT BASE           22560016
         TM    DCBOFLGS,X'10'          TEST FOR SUCCESSFUL OPEN         22640016
         BZ    NOTOPEN                 BR ON UNSUCCESFUL OPEN           22720016
         NI    DCBMACRF+1,X'F3'   PREVENT TTR UPDATE AND EOF WRITE      22800016
         DROP  REG9                                                     22880016
         DROP  REGF                                                     22960016
         USING IHADCB,REGF                                              23040016
         BR    REG8               RETURN.                               23120016
         EJECT                                                          23170003
*                                                                       23200016
**********************************************************************  23280016
*                                                                       23360016
NUVOLUME EQU   *        THIS ROUTINE IS ENTERED WHEN AN UNLABELED       23440016
*                       VOLUME IS TO BE PROCESSED.                      23520016
*                                                                       23600016
**********************************************************************  23680016
*                                                                       23760016
         L     REG9,TUCBPTR            POINT TO UCB.               1352 23810018
         TM    SRTESTAT-UCBOB(REG9),SRTEONLI     IS DEVICE ONLINE. 1352 23860018
         BO    ONLINERR           YES SET UP ERROR MESSAGE.             23920016
         LA    REGF,FBLOCKS       GET DCB POINTER.                      24000016
         BAL   REG8,BLDDEB        BUILD PARM LIST FOR DEB BUILDER.      24160016
         L     REG3,COPYPTR       GET POINTER TO COPY BLOCK.            24240016
COPYLOOP EQU   *                                                        24320016
         LTR   REG3,REG3          ANOTHER COPY REQUESTED.               24400016
         BZ    PASSOKAY                NO-SET UP R0 COUNT FIELD.        24480016
         LA    REGF,CIOBLOCK      GET COPY DCB POINTER.                 24560016
         L     REG9,CUCBPTR       GET COPY UCBPTR                       24640016
         TM    SRTESTAT-UCBOB(REG9),SRTEONLI  IS DEVICE ONLINE.         24720016
         BO    ONLINERC           SET UP ERROR MSG.                     24800016
         BAL   REG8,BLDDEB                                              24880016
         L     REG3,CCOPYPTR      GET NEXT COPY BLOCK POINTER.          24960016
         B     COPYLOOP           LOOP UNTIL FINISH                     25040016
         EJECT                                                          25090003
*                                                                       25120016
**********************************************************************  25200016
*                                                                       25280016
BLDDEB   EQU   *             HERE THE PARM LIST FOR DEB BUILDER IS      25360016
*                            CONSTRUCT AND A DEB IS BUILT IN PROTECTED  25440016
*                            CORE.                                      25520016
*                                                                       25600016
**********************************************************************  25680016
*                                                                       25760016
         ST    REG9,PARMUCB       STORE PROPER UCB POINTER              25840016
         ST    REGF,PARMDCB       STORE PROPER DCB POINTER              25920016
         MVI   PARMUCB,X'8F'      SET UP DEB CONSTRUCTION INDICATOR.    26000016
         MVI   PARMDCB,X'80'      SET LAST ENTRY INDICATOR.             26080016
         LA    REG1,PARMLST       GET POINTER TO PARM LIST              26160016
         SVC   82                 CONSTRUCT DEB IN PROTECTED CORE.      26240016
         LTR   REGF,REGF          WAS DEB SUCCESSFULLY BUILT.           26250016
         BCR   8,REG8             YES-CONTINUE PROCESSING.              26260016
         L     REG1,PARMDCB       PICK UP POINTER TO CURRENT DCB.       26270016
         LA    REG1,0(REG1)       CLEAR HIGH ORDER BYTE.                26280016
         LA    REG8,FBLOCKS       GET ADDRESS TO FUNCTION BLOCK DCB.    26290016
         CR    REG8,REG1          IS THIS FUNCTION BLOCK DCB.           26305016
         BE    ONLINERR           YES-SET UP AND PRINT ERROR MSG.       26310016
         B     ONLINERC           NO-SET UP AND PRINT COPY ERROR MSG.   26320016
*                                                                       26400016
**********************************************************************  26480016
*                                                                       26560016
*   TEST FOR PROTECTED AND UNEXPIRED DATA SETS HERE.                    26580003
*                                                                       26600003
**********************************************************************  26640016
NOCOPIES EQU   *                                                        26720016
         LR    REG1,REG7          SET UP POINTER TO BUFFER WORK AREA    26800016
         LINK  EP=IEHDPASS        CHECK FOR PASSWORD DATA SETS          26880016
         LA    REGD,SAVEAREA      RESTORE MY SAVEAREA POINTER.          26920016
         LTR   REGF,REGF          WAS PASSWORD CHECK OKAY               26960016
         BZ    PASSOKAY           YES-CONTINUE PROCESSING               27040016
ABNORMN  EQU   *                                                        27120016
         LR    REG2,REGF          NO-SAVE RETURN CODE                   27200016
         LA    REG8,RETRNABN      PICK UP RETURN ADDRESS.               27280016
         LA    REGB,FBLOCKS       POINT TO I/O CONT*OL BLOCKS           27360016
         B     CLOSENXT           CLOSE OPEN DCBS                       27440016
         EJECT                                                          27490003
PASSOKAY EQU   *                                                        27520016
         AIF   ('&LIB' EQ 'LIB1').X227206                       XL03145 27520803
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 27521203
         BNE   NO3340                  NO, CHECK OTHER DEVICES.  XM5465 27521303
         TM    SEQSW,PASSES            PASSES SPECIFIED?       @ZA10914 27523440
         BO    TSTFLG                  YES THEN TST IF FLAGTST @ZA10914 27525440
         MVI   PASSCNT+D1,ONE          FORCE ONE PASS ON 3340.   XM5465 27528603
TSTFLG   TM    SEQSW,FLAGTEST          IS FLAGTEST = NO?       @ZA10914 27530740
         BO    NO3330                  YES, TEST FOR PASSES.     XM5465 27532803
NO3340   EQU   *                                                 XM5465 27534903
         CLI   UCBTBYT4,D3350           MADRID ?               @VS40430 27537003
         BE    TSTONLI                  TEST ONLINE STATUS     @VS40430 27539103
         TM    FLGBYT1,EMU             EMULATION ACTIVE ?      @Z30RSAG 27541203
         BNO   NOLEM3X                 NO, NORMAL PROC         @Z30RSAG 27543303
         TM    SEQSW+D1,MSSFLG          SSI CONVERSION ?       @Y30LSFY 27545403
         BO    NO3330                  YES,DON'T BUILD VTOC NOW@Y30LSFY 27547503
         CLI   UCBTBYT4,WIN            IS DEVICE 3340          @Z30RSAG 27549603
         BE    NOLEM3X                 YES, CAN'T BE 333X      @Z30RSAG 27551703
TSTONLI  TM    SRTESTAT,SRTEONLI              IS IT ON-LINE    @ZA10914 27555940
         BZ    NO3330                  NO, OFFLINE EM.333X     @Z30RSAG 27558003
NOLEM3X  EQU   *        NOT OFF-LINE EMULATED 333X             @Z30RSAG 27560103
         TM    SEQSW+D1,MSSFLG          SSI CONVERSION ?       @X04ACFY 27562203
         BO    NO3330                  YES,DON'T BUILD VTOC NOW@X04ACFY 27564303
         CLI   UCBTBYT4,FACTPACK        UCB TYPE GREATER THAN 9 XL03145 27566403
         BL    NO3330                   NO, PASS COUNT IS OK.   XL03145 27568503
         XC    PASSCNT(2),PASSCNT       MUST HAVE PASSES EQ 0.  XL03145 27570603
         AGO   .X227207                                         XL03145 27572703
.X227206 ANOP                                                   XL03145 27574803
         CLI   UCBTBYT4,FACTPACK   IS THIS MERLIN                S20201 27576903
         BNE   NO3330                   NO CONTINUE              M5723  27579003
         XC    PASSCNT(2),PASSCNT       3330 MUST HAVE PASSES EQ M0137  27581103
*                                       0                        M0137  27583203
.X227207 ANOP                                                   XL03145 27585303
         CLI   FUNCSW,FORMAT            IS THIS A FORMAT         M5723  27587403
         BNE   BLDVTOC                  NO - QUICK DASDI         M5723  27589503
NO3330   EQU   *                                                 M5723  27591603
         TM    SEQSW,PASSES             IS PASS SPECIFIED          O122 27593703
         BZ    HERE                     IF NOT, CONTINUE           O122 27595803
         CLC   PASSCNT(2),ZERO     DOES PASSES =0                S20201 27597920
         BE    BLDVTOC                  IF YES, CREATE VTOC        O122 27600019
         EJECT                                                          27610003
HERE     EQU   *                                                   O122 27620019
*                                                              @ZA04403 27630050
*   THE FOLLOWING SECTION OF CODE WAS MOVED FROM SYMBOL        @ZA04403 27640050
*   'SETUPR0S' IN CONVERT SECTION, AND THE SYMBOL DELETED      @Z30RSAG 27660003
*   TO ELIMINATE THE LINKAGE                                   @Z30RSAG 27670003
         XC    STNDR0(WORKBUFF),STNDR0 CLEAR R0 COUNT AREAS,   @ZA04403 27680050
         L     REG0,PRGSAVE       GET CCHH OF TRK TO BE PROC   @ZA04403 27690050
         L     REGE,IODEVCON           GET DEVCON PTR          @ZA04403 27700050
         LH    REG1,SACAP         GET DATA LTH FOR SURF ANAL   @ZA04403 27710050
         STM   REG0,REG1,MAXLTHR0 SET MAXIMUM LENGTH R0 COUNT. @ZA04403 27720050
         STM   REG0,REG1,MAXR0BIT SET UP MAX CNT FOR BIT PTTRN.@ZA04403 27730050
         LA    REG1,8                                          @ZA04403 27740050
         STM   REG0,REG1,STNDR0 SET UP R0 COUNT (STANDARD).    @ZA04403 27750050
*                                                              @ZA04403 27752050
*   END OF MOVED 'SETUPR0S' SECTION.                           @ZA04403 27754050
*                                                              @ZA04403 27756050
         TM    FUNCSW,FORMAT      IS THIS A FORMAT FUNCTION    @ZA04403 27758050
         BO    BITBYPAS           YES-BYPASS BIT CONSTRUCTION  @ZA04403 27760050
         TM    SEQSW+D1,MSSFLG    NO-IS THIS MSS STAGING PACK  @ZA04403 27810050
         BO    BITBYPAS           YES-BYPASS BIT CONSTRUCTION  @ZA04403 27820050
         AIF   ('&LIB' EQ 'LIB1').X227208                       XL03912 27850003
         TM    FLGBYT1,EMU             ANY EMULATED DEVICE ?   @Z30RSAG 27850403
         BO    SETBIT                  YES, USE 3340 PATTERN   @Z30RSAG 27850803
         CLI   UCBTBYT4,D3350          IS THIS A 3350?         @VS40037 27851203
         BE    SETBIT                  NO, USE 3340 PAT        @VS40037 27851603
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 27852003
         BNE   USEFIVE                 NO, USE FIVES AS PATTERN. XM5465 27854003
SETBIT   EQU   *                                               @Z30RSAG 27854403
         MVC   BITBUFF(L8),TEST3340    GET 3340 TEST PATTERN.    XM5465 27856003
         B     PATSET                  PATTERN IS READY.         XM5465 27858003
USEFIVE  EQU   *                                                 XM5465 27858403
         MVC   BITBUFF(L8),PATTERN     FIVES USED AS PATTERN.    XM5465 27860003
PATSET   EQU   *                                                 XM5465 27862003
         XC    HALFWD,HALFWD           CLEAR ONE HALFWORD.       XM5465 27864003
         L     REGE,IODEVCON           POINT TO DEVCON         @Z30RSAG 27864403
         LH    REGF,SACAP              GET S/A TRACK CAPACITY.   XM5465 27866003
         LA    REGE,BITBUFF            POINT TO BIT PATTERN    @Z30RSAG 27866103
         LA    REG8,K9                 GET A NUMBER NINE.        XM5465 27866403
         SR    REGF,REG8               DECR LNGTH BY FIRST MOVE. XM5465 27866803
         STC   REGF,HALFWD+D1          SAVE LAST BYTE OF LENGTH. XM5465 27868003
         SRL   REGF,B8                 NUMBER OF MOVES - ONE.    XM5465 27868403
         LA    REG8,MAXBYTE            GET NUMBER FOR MAX MOVE.  XM5465 27868803
BITLOOP  EQU   *                                                 XM5465 27869203
         EX    REG8,MOVEBITS           FILL BUFFER WITH PATTERN. XM5465 27869603
         LA    REGE,MAXBYTE+D1(REGE)   INCR BUFF ADDR BY 256.    XM5465 27869703
         BCT   REGF,BITLOOP            LOOP UNTIL FINISHED.      XM5465 27869803
         LH    REG8,HALFWD             GET REMAINING LENGTH.     XM5465 27869903
         LTR   REG8,REG8               ANY LENGTH LEFT?          XM5465 27873203
         BNP   BITBYPAS                NO, BUFFER IS FULL.       XM5465 27875203
         EX    REG8,MOVEBITS           FILL REMAINING BUFFER.    XM5465 27875603
         B     BITBYPAS                START BUILDING CCWS.      XM5465 27875703
*********************************************************************** 27875903
MOVEBITS MVC   B8(NULL,REGE),BITBUFF   OBJECT OF EX INSTRUCTION. XM5465 27880703
*********************************************************************** 27881503
         EJECT                                                          27887903
BITBYPAS EQU   *                                                 XM5465 27894403
         L     REG2,TUCBPTR             PICK UP UCB POINTER     XL03912 27900803
         AGO   .X227211                                         XL03912 27907203
.X227208 ANOP                                                   XL03912 27913603
         MVI   0(REGE),X'55'      ASSUME DEVICE IS NOT 2301 OR 2321     27920016
         L     REG2,TUCBPTR       PICK UP UCB POINTER.                  28000016
         CLI   UCBID,X'FF'        IS THIS A 2321                        28080016
         BNE   SETE5              YES MODIFY BIT PATTERN TO E5          28160016
         CLI   UCBTBYT4,X'03'     IS THIS A 2301                        28240016
         BNE   BLDPATTN           NO-BUILD PATTERN FOR 55               28320016
         MVI   0(REGE),X'5A'      YES-SET PATTERN FOR 5A                28400016
BLDPATTN EQU   *                                                        28480016
         MVI   HALFWD,0           SET FIRST BYTE OF HALD WORD TO ZERO   28560016
         LH    REGF,SACAP         GET BIT PATTERN LENGTH                28640016
         STC   REGF,HALFWD+1      SAVE LENGTH OF FIELD TO BE MOVED      28720016
         BCTR  REGF,0             DECREMENT FOR PROPER EX LENGTH        28800016
         EX    REGF,MOVEBITS      MOVE PROPER NUMBER OF BYTES           28880016
         AH    REGE,HALFWD        UPDATE FIELD POINTER                  28960016
         SRL   REGF,8             GET NUMBER OF BITS TO BE MOVED        29040016
         LTR   REGF,REGF          IS BIT PATTERN COMPLETE               29120016
         BE    BITBYPAS           YES-TEST FOR 2321                     29200016
BITLOOP  EQU   *                                                        29280016
         LA    REG8,255           GET LENGTH OF NEXT MOVE               29360016
         EX    REG8,MOVEBITS      SET UP MORE BITS IN OUTPUT BUFFER     29440016
         LA    REGE,256(REGE)     UPDATE FIELD POINTER                  29520016
         BCT   REGF,BITLOOP       LOOP UNTIL FINISH                     29600016
         B     BITBYPAS                                                 29680016
MOVEBITS EQU   *                                                        29760016
         MVC   1(1,REGE),0(REGE)  *THIS IS OBJECT OF EX INSTRUCTION     29840016
SETE5    EQU   *                                                        29920016
         MVI   BITBUFF,X'E5'      SET UP BIT PATTERN FOR 2321           30000016
         B     BLDPATTN           GO COMPLETE BIT PATTERN.              30080016
BITBYPAS EQU   *                                                        30160016
         CLI   UCBID,X'FF'        IS THIS A 2321                        30240016
         BNE   IS2321             YES-SET UP LINKAGE FOR IEHDCELL       30320016
.X227211 ANOP                                                   XL03912 30360003
         LA    REGF,FBLOCKS       SET UP CONTROL BLOCK BASE.            30400016
         TM    SEQSW+D1,RPS        DO WE HAVE RPS               XM4389  30410003
         BZ    NOGOT               NO                            S20201 30420020
         MVC   CCWSECON(K136),SETSECCW YES                       S20201 30430020
         LA    REG0,CCW1CONS           SET TIC ADDR              M0967  30432021
         ST    REG0,TEMP                                         M0967  30434021
         MVC   TICSEC+D1(K3),TEMP+D1   POINT TIC                 M0967  30436021
         B     GO                      BUILD CCWS.               S20201 30440020
NOGOT    EQU   *                        *                        S20201 30450020
         MVC   CCW1CONS(120),CCWORD1   MOVE CCWS TO FUNCTION BLOCK.     30480016
GO       EQU   *                        *                        S20201 30520020
         TM    FUNCSW,FORMAT      IS THIS A FORMAT FUNCTION.            30560016
         BO    FORMATF            YES-BYPAS THE ANALYZE CCW CREATION.   30640016
         TM    SEQSW+D1,MSSFLG    NO-IS THIS MSS STAGING PACK  @ZA04403 30690050
         BO    FORMATF            YES-BYPASS ANAL CCW CREATION @ZA04403 30740050
         EJECT                                                          30790003
**********************************************************************  30800016
*                                                                       30880016
* THIS IS THE ANALYZE FUNCTION WITH NO PREVIOUSLY FLAGGED TRACK TEST.   30960016
*                                                                       31040016
**********************************************************************  31120016
         LA    REG1,FLAGREAD      HOME ADDRESS AREA PTR IN FUNCBLOCK.   31280016
         BAL   REGE,BLDACCW       BUILD CCWS FOR ANALYZE FUNCTION.      31360016
**********************************************************************  31360103
*                                                                       31360203
* THIS SECTION BUILDS THE CCWS TO CONVERT FROM 3330-3350-3330. @VS40037 31360303
*                                                                       31360403
**********************************************************************  31360503
         CLI   UCBTBYT4,D3350          IS THIS A 3350?         @VS40037 31360703
         BE    TONLIN                  NO, USE 3340 PAT        @VS40037 31360803
         TM    FLGBYT1,EMU             IS DEVICE EMULATED ?    @Z30RSAG 31410003
         BZ    NORFRM                  NO, SKIP THIS           @Z30RSAG 31420003
         CLI   UCBTBYT4,WIN            IS IT 3340              @Z30RSAG 31430003
         BE    NORFRM                  YES, SKIP THIS          @Z30RSAG 31432003
TONLIN   EQU   *                                               @VS40037 31432403
         L     REG9,TUCBPTR            POINT TO UCB            @Z30RSAG 31434003
         TM    SRTESTAT-UCBOB(REG9),SRTEONLI  IS IT ONLINE ?   @Z30RSAG 31436003
         BO    NORFRM                  YES, SKIP THIS          @Z30RSAG 31438003
         MVC   SDCCW1,CCWECONS         GET RD HA CCW           @Z30RSAG 31438403
         LA    REG0,FLAGREAD           GET ADDRESS OF HA       @Z30RSAG 31438503
         ST    REG0,SDCCW1             STORE IN RHA            @Z30RSAG 31438603
         MVI   SDCCW1,X'1A'            SET CMND                @Z30RSAG 31438703
         MVC   SDHA(5),FLAGREAD        COPY FLAGREAD           @Z30RSAG 31438803
         LA    REG0,SDSNS              GET ADDRESS/SENSE AREA  @Z30RSAG 31439203
         ST    REG0,SDCCW2             STORE IN SENSE CCW      @Z30RSAG 31439603
         MVI   SDCCW2,SENSE            CMND TO SENSE CCW       @Z30RSAG 31439703
         LA    REG0,24                 COUNT FOR SENSE         @Z30RSAG 31439803
         ST    REG0,SDCCW2+4           STORE IN CMND           @Z30RSAG 31439903
         MVI   SDCCW2+4,X'40'          CHAIN BIT ON            @Z30RSAG 31489903
         LA    REG0,SDSHA              ADDRESS/SEARCH HA       @Z30RSAG 31499903
         ST    REG0,SDTIC              STORE IN TIC CMND       @Z30RSAG 31509903
         MVI   SDTIC,X'08'             TIC CMND TO CCW         @Z30RSAG 31519903
         MVC   SDWR0(24),CCWDCONS      COPY WR R0/RD HA/RD R0  @Z30RSAG 31529903
         MVC   SDSHA(24),CCWBCONS      COPY SHA/TIC/WR0        @Z30RSAG 31531903
         LA    REG0,FLAGREAD+1         GET ADDRESS OF HA       @Z30RSAG 31532303
         ST    REG0,SDSHA              STORE IN SHA            @Z30RSAG 31532703
         MVI   SDSHA,X'39'             SET CMND                @Z30RSAG 31533103
         LA    REG0,SDSHA              GET NEW ADDRESS FOR TIC @Z30RSAG 31533903
         ST    REG0,SDTSHA             STORE IN TIC            @Z30RSAG 31535903
         MVI   SDTSHA,X'08'            RESTORE TIC CMND        @Z30RSAG 31537903
         MVC   SDWHA,CCWECONS          COPY RD HA              @Z30RSAG 31538303
         LA    REG0,SDHA               GET ADDR OF HA          @VS40037 31538403
         MVI   SDRHA+L4,X'70'           SET CCW FLGS           @ZM42054 31544003
         CLI   UCBTBYT4,D3350          3350 ?                  @XM10379 31549603
         BNE   STOR                    NO, REG ALRDY SET       @XM10379 31555203
         MVI   SDWHA+L7,L11            RESET DATA LENGTH       PTMFIX   31560803
         LA    REG0,MADSD              ELSE PT TO SD BYTES     @XM10379 31566403
STOR     EQU   *                                               @XM10379 31572003
         ST    REG0,SDWHA              SET ADDR IN WHA         @XM10379 31577603
         MVI   SDWHA,X'19'             MAKE IT WR HA           @Z30RSAG 31583203
NORFRM   EQU   *                                               @X50RSAG 31588803
         L     REG3,COPYPTR       GET ADDRESS OF THE FIRST COPY BLOCK.  31594403
**********************************************************************  31600016
*                                                                       31680016
*                  HERE WE CALL BLDACCW SUBR TO CONSTRUCT ANAL CHNL PRG 31760016
*                                                                       31840016
**********************************************************************  31920016
ACCWLOOP EQU   *                                                        32080016
         LTR   REG3,REG3          TEST FOR COPIES.                      32160016
         BZ    ENDCCWS            EXIT AFTER CHNL PRGS ARE BUILT.       32240016
         LA    REGF,CIOBLOCK      GET BASE FOR COPY BLOCK.              32320016
         TM    SEQSW+D1,RPS              DO WE HAVE RPS         XM4389  32330003
         BZ    NOGOT1                  NO-CONTINUE.              S20201 32340020
         MVC   CCWSECON(136),SETSECCW                            S20201 32350020
          LA    REG0,CCW1CONS           SET TIC                  A46360 32352021
          ST    REG0,TEMP               ADDRESS                  A46360 32354021
          MVC   TICSEC+1(K3),TEMP+D1                             A46360 32356021
         B     GO1                     CONTINUE CCWS.            S20201 32360020
NOGOT1   EQU   *                        *                        S20201 32370020
         MVC   CCW1CONS(120),CCWORD1 MOVE CCWS TO COPY BLOCK.           32400016
GO1      EQU   *                        *                        S20201 32440020
         LA    REG1,CFLGREAD      HOME ADDRESS AREA PTR IN COPYBLOCK.   32480016
         BAL   REGE,BLDACCW       CONSTRUCT A COPY CHANNEL PROGRAM.     32560016
         L     REG3,CCOPYPTR      POINT TO NEXT COPY BLOCK.             32640016
         B     ACCWLOOP           LOOP UNTIL ALL COPIES ARE COMPLETE.   32720016
         EJECT                                                          32770003
*                                                                       32800016
**********************************************************************  32880016
*                                                                       32960016
* HERE WE CALL BLDFCCW SUBR TO CONSTRUCT FORMAT CHNL PRGS.              33040016
*                                                                       33120016
**********************************************************************  33200016
*                                                                       33280016
FORMATF  EQU   *                                                        33360016
         MVI   UNASGBT,X'FF'            FORMAT DO NOT SET ALT    M4682  33400020
         LA    REG1,FLAGREAD      HOME ADDRESS AREA PTR IN FUNCBLOCK.   33440016
         BAL   REGE,BLDFCCWF      BUILD CCWS AND UPDATE CCWPTR IN IOB.  33520016
         AIF   ('&LIB' EQ 'LIB1').X227212                       XL03130 33528003
         CLI   UCBTBYT4,ZEU1            IS THIS A 2305-1?       XL03130 33536003
         BE    WRHA                     YES, SET WRITE HA CCW.  XL03130 33544003
         CLI   UCBTBYT4,ZEU2            IS THIS A 2305-2?               33552003
         BNE   CCWSOKAY                 NO, CCWS ALREADY SET.   XL03130 33560003
WRHA     EQU   *                        WRITE HA IS SET HERE.   XL03130 33568003
         AGO   .X227213                                         XL03130 33576003
.X227212 ANOP                                                   XL03130 33584003
         TM    UCBTBYT4,X'02'     IS THIS A DRUM DEVICE.                33600016
         BZ    CCWSOKAY           NO-CCWS ARE ALREADY SET PROPERLY.     33680016
.X227213 ANOP                                                   XL03130 33720003
         MVI   CCWBCONS,X'19'     SET CCW TO WRITE HOME ADDRESS.        33760016
         L     REG0,CCWBCONS                                            33840016
         BCTR  REG0,0                                                   33920016
         ST    REG0,CCWBCONS      SET UP PTR FOR READ HOMEADDR          34000016
         LA    REG0,CCWDCONS      UPDATE TIC                            34080016
         ST    REG0,CCWCCONS       UPDATE TIC ADDR .                    34160016
         MVI   CCWCCONS,X'08'     RESTORE TIC OP CODE.                  34240016
CCWSOKAY EQU   *                                                        34320016
         L     REG3,COPYPTR                                             34400016
FCCWLOOP EQU   *                                                        34480016
         LTR   REG3,REG3                                                34560016
         BZ    ENDCCWS            EXIT HERE AFTER ALL COPIES ARE BUILT. 34640016
         LA    REGF,CIOBLOCK      POINT TO COPY I/O BLOCK.              34720016
         MVC   CCWBCONS(40),CCWORDB MOVE CCWS TO COPY BLOCK.            34800016
         TM    SEQSW+D1,RPS           IS THIS RPS               XM4389  34850003
         BZ    NOGOT2                  NO                        XM6030 34860000
         MVC   CCWSECON(K16),SETSECCW  YES, MOVE SS & TIC        XM6030 34870000
NOGOT2   EQU   *                       CONTINUE                  XM6030 34872000
         AIF   ('&LIB' EQ 'LIB1').X227214                       XL03130 34872803
         CLI   UCBTBYT4,ZEU1            IS THIS A 2305-1?       XL03130 34873603
         BE    CHANGE                   YES, SET WR HA CCW.     XL03130 34874403
         CLI   UCBTBYT4,ZEU2            IS THIS A 2305-2?       XL03130 34875203
         BNE   NOCHANGE                 NO, CHECK FLAGGED TRKS. XL03130 34876003
         EJECT                                                          34876403
CHANGE   EQU   *                        CHANGE OP TO WRITE HA.  XL03130 34876803
         AGO   .X227215                                         XL03130 34877603
.X227214 ANOP                                                   XL03130 34878403
         TM    UCBTBYT4,X'02'     IS TIS A DRUM DEVICE.                 34880016
         BZ    NOCHANGE           NO-CHECK FOR PREV FLAGGED TRKS.       34960016
.X227215 ANOP                                                   XL03130 35000003
         MVI   CCWBCONS,X'19'                                           35040016
         LA    REG0,CCWDCONS                                            35120016
         ST    REG0,CCWCCONS      UPDATE TIC ADDRESS.                   35200016
         MVI   CCWCCONS,X'08'     RESTORE TIC OP CODE.                  35280016
NOCHANGE EQU   *                                                        35360016
         LA    REG1,CFLGREAD      HOME ADDRESS AREA PTR IN COPYBLOCK.   35440016
         BAL   REGE,BLDFCCWF      BUILD CCWS AND UPDATE CCWPTR IN IOB.  35520016
         CLI   CCWBCONS,X'39'     IS THIS A SEARCH COMMAND.             35600016
         BE    DONTCHNG           YES- BYPASS ADDRESS CHANGE.           35680016
         L     REG0,CCWBCONS                                            35760016
         BCTR  REG0,0                                                   35840016
         ST    REG0,CCWBCONS      SET UP PTR FOR READ HOMEADDR          35920016
DONTCHNG EQU   *                                                        36000016
         L     REG3,CCOPYPTR                                            36080016
         B     FCCWLOOP                                                 36160016
         EJECT                                                          36210003
BLDFCCWF EQU   *                                                        36240016
         TM    SEQSW+D1,RPS        DO WE HAVE CARNY             XM4389  36248003
         BZ    NOCARN              NO                            S20201 36256020
          LA    REG0,CCWSECON           SET UP SECTOR OP         A46360 36264021
         ST    REG0,CCWPTR         PUT IN IOB                    S20201 36272020
         LA    REG0,CCWBCONS       PUT TIC                       S20201 36280020
         ST    REG0,TEMP           ADDRESS                       S20201 36288020
          MVC   TICSEC+1(K3),TEMP+D1                             A46360 36296021
         B     BLDFCCW                 BUILD CCWS.               S20201 36304020
NOCARN   EQU   *                        *                        S20201 36312020
         LA    REG0,CCWBCONS                                            36320016
         ST    REG0,CCWPTR        UPDATE CCW PTR IN IOB FOR FORMAT FUNC 36400016
BLDFCCW  EQU   *                                                        36480016
         LR    REG0,REG1          GET CORRECT HOME ADDRESS AREA.        36560016
         A     REG0,CCWBCONS                                            36640016
         ST    REG0,CCWBCONS      POINT SHA TO SEARCH ARGUMENT.         36720016
         BCTR  REG0,0                                                   36800016
         ST    REG0,CCWECONS      POINT RHA TO LOC INTO WHICH HA IS RD. 36880016
         MVI   CCWECONS,X'1A'     RESTORE OP CODE TO READ HOME ADDRESS. 36960016
         LA    REG0,CCW1CONS                                            37040016
         A     REG0,CCWCCONS                                            37120016
         ST    REG0,CCWCCONS      RELOCATE TIC TO POINT TO CCWBCONS.    37200016
         LA    REG0,STNDR0                                              37280016
         A     REG0,CCWDCONS                                            37360016
         ST    REG0,CCWDCONS      POINT WRITE RO CCW TO A STANDARD R0.  37440016
         ST    REG0,CCWFCONS      RELOCATE CCW15                        37520016
         MVI   CCWFCONS,X'16'     RESTORE READ R0 OP CODE.              37600016
         BR    REGE               RETURN.                               37680016
*                                                                       37760016
         EJECT                                                          37810003
*********************************************************************** 37840016
*                                                                       37920016
* THIS SUBROUTINE CONSTRUCTS A CHANNEL PROGRAM THAT IS TO BE USED BY    38000016
* THE ANALYZE FUNCTION.                                                 38080016
* THE FIRST TEN CCWS ARE RELOCATED IN THIS SUBROUTINE .THEN BLDFCCW     38160016
* IS CALLED TO RELOCATE THE LAST FIVE.                                  38240016
*                                                                       38320016
*********************************************************************** 38400016
*                                                                       38480016
BLDACCW  EQU   *                                                        38560016
         LR    REG0,REG1          GET READ IN AREA               XM5465 38610003
         A     REG0,CCW1CONS                                            38720016
         ST    REG0,CCW1CONS      RELOCATE CCW1                         38800016
         ST    REG0,CCW6CONS      RELOCATE CCW6                         38880016
         BCTR  REG0,0                                                   38960016
         ST    REG0,CCW4CONS      SET UP PTR FOR READ HOMEADDR          39040016
         ST    REG0,CCW9CONS      RELOCATE CCW9                         39120016
         LA    REG0,CCW1CONS                                            39200016
         A     REG0,CCW2CONS                                            39280016
         ST    REG0,CCW2CONS      RELOCATE CCW2CONS.                    39360016
         MVI   CCW4CONS,X'1A'     RESTORE OP CODE IN CCW4               39440016
         MVI   CCW9CONS,X'1A'     RESTORE OP CODE IN CCW9               39520016
         LA    REG0,MAXR0BIT      GET ADDRESS OF BIT PATTERN.           39600016
         A     REG0,CCW3CONS                                            39680016
         ST    REG0,CCW3CONS      RELOCATE CCW3                         39760016
         LA    REG0,MAXLTHR0                                            39840016
         A     REG0,CCW8CONS      RELOCATE CCW8                         39920016
         ST    REG0,CCW8CONS      RELOCATE CCW8                         40000016
         ST    REG0,CCWACONS      RELOCATE CCW10                        40080016
         MVI   CCWACONS,X'16'     RESTORE OP CODE.                      40160016
         LA    REG0,CCW1CONS                                            40240016
         A     REG0,CCW7CONS                                            40320016
         ST    REG0,CCW7CONS      RELOCATE CCW7.                        40400016
         LA    REG0,8                                                   40480016
         L     REG9,IODEVCON            POINT TO DEVCON        @ZA04403 40490050
         AH    REG0,SACAP-CONSTANT(REG9)                       @ZA04403 40500050
         A     REG0,CCW3CONS+4                                          40640016
         ST    REG0,CCW3CONS+4    SET MAXIMUM R0 COUNT IN               40720016
         LH    REG0,PASSCNT       GET REQUESTED PASS COUNT.             40800016
         BCTR  REG0,0                                                   40880016
         LTR   REG0,REG0          TEST FOR MULTIPLE PASSES.             40960016
         BNP   ONEPASS            BRANCH ON SINGLE PASS REQUEST.        41040016
         NI    CCWACONS+4,X'20'   SET CMND CHAIN OFF SILI FLAG ON.      41120016
ONEPASS  EQU   *                                                        41200016
         CLI   DDNAME2,X'40'          IS THIS A NEW VOLUME.             41220016
         BE    SETWRTHA           YES-SET UP WRITE HOME ADDRESS.        41240016
         AIF   ('&LIB' EQ 'LIB1').X228000                       XL03912 41245003
         CLI   UCBTBYT4,ZEU1            IS THIS A 2305-1?       XL03130 41250003
         BE    SETWRTHA                 YES, SET WR HA CCW.     XL03130 41255003
         CLI   UCBTBYT4,ZEU2            IS THIS A 2305-2?       XL03130 41260003
         BE    SETWRTHA                 YES, SET WR HA CCW.     XL03130 41265003
         AGO   .X228001                                         XL03912 41270003
.X228000 ANOP                                                   XL03912 41275003
         TM    UCBTBYT4,X'02'     IS THIS A DRUM TYPE DEVICE.           41280016
         BO    SETWRTHA           YES-SET UP WRITE HOME ADDRESS OP      41360016
.X228001 ANOP                                                   XL03912 41400003
         TM    SEQSW,FLAGTEST     IS FLAG TEST BYPASS REQUESTED.        41440016
         BZ    BLDFCCW            NO-BUILD REMAINING CCWS.              41520016
SETWRTHA MVI   CCW1CONS,X'19'     MODIFY CCW TO WRITE HOME ADDRESS.     41600016
         LA    REG0,CCW3CONS                                            41680016
         ST    REG0,CCW2CONS                                            41760016
         MVI   CCW2CONS,X'08'     MODIFY TIC ADDRESS FOR CCW3.          41840016
         AIF   ('&LIB' EQ 'LIB1').X326000                        XM5465 41890003
         CLI   UCBTBYT4,D3350          3350 DEVICE ?           @VS40037 41890103
         BE    YEAMAD                  YES DOIT                @VS40037 41890203
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 41890403
         BNE   NOSD                    NO, SOME OTHER DEVICE.    XM5465 41890803
         EJECT                                                          41891203
*****************************************************************XM5465 41892003
*                                                                XM5465 41892403
*    THE FOLLOWING ROUTINE WILL EDIT THE ANALYZE CCWS            XM5465 41892803
*    SUCH THAT ONLY TRACKS WITH BIT SIX ON IN THE HOME           XM5465 41893203
*    ADDRESS WILL BE ANALYZED SO AS TO DETERMINE THEIR           XM5465 41893603
*    USEFULLNESS FOR POSSIBLE RECLAIMATION FROM DEFECTIVE        XM5465 41893703
*    STATUS. THIS IS APPLICABLE TO 3340 ONLY.                    XM5465 41893803
*                                                                XM5465 41893903
*****************************************************************XM5465 41902003
         SPACE                                                          41904003
YEAMAD   EQU   *                                               @VS40037 41904403
         MVC   SDCCW1,CCWORD4          GET A READ HA CCW.        XM5465 41910403
         LR    REG0,REG1               GET READ IN AREA.         XM5465 41910803
         A     REG0,SDCCW1             COMBINE ADDR AND CCW.     XM5465 41911203
         ST    REG0,SDCCW1             RD HA CMD SET.            XM5465 41911603
         LA    REG0,SDSNS              GET SENSE AREA.           XM5465 41911703
         ST    REG0,SDCCW2             SET IN SENSE CCW.         XM5465 41911803
         MVI   SDCCW2,SENSE            SET SENSE COMMAND.        XM5465 41911903
         LA    REG0,L24                LENGTH OF SENSE INFO.     XM5465 41912903
         ST    REG0,SDCCW2+D4          SET COUNT OF SENSE CCW.   XM5465 41914903
         LA    REG0,CCWBCONS           GET ADDDRESS              XM5465 41915003
         ST    REG0,SDTIC              STORE IN CCW              XM5465 41915103
         MVI   SDTIC,TICCMD            SET TO TIC                XM5465 41915203
         MVI   SDCCW2+D4,CHAIN         TURN ON CMD CNING         XM5465 41916803
         MVI   CCW1CONS+L7,L7          SET COUNT OF 7 FOR WR HA. XM5465 41920003
         MVC   CCWSHCON(L8),CCWORD6    GET A SEARCH CCW.         XM5465 41923703
         LR    REG0,REG1               GET HA POINTER.           XM5465 41925703
         A     REG0,CCWSHCON           ADDR TO SEARCH CCW.       XM5465 41927703
         ST    REG0,CCWSHCON           SEARCH CCW NOW COMPLETE.  XM5465 41929703
         LA    REG0,CCWSHCON           ADDR OF SEARCH FOR TIC.   XM5465 41931703
         ST    REG0,TICSEC             SET ADDR IN TIC.          XM5465 41932103
         MVI   TICSEC,TICCMD           SET TIC CCW.              XM5465 41932503
         LA    REG0,SDBYTES            ADDR OF 3340 HA.          XM5465 41932803
         ST    REG0,CCW1CONS           CHANGE CCW ADDRESS.       XM5465 41941203
         CLI   UCBTBYT4,D3350          3350 ?                  @VS40037 41941603
         BNE   SETOP                   YES, MODIF CCW          @VS40037 41942003
         MVI   CCW1CONS+L7,L11         RESET CCW DATA LEN      @VS40430 41942403
         LA    REG0,MADSD              PT TO MAD SD BYTES      @VS40037 41942803
         ST    REG0,CCW1CONS           CHG CCW                 @VS40037 41943203
SETOP    EQU   *                                               @VS40037 41943603
         MVI   CCW1CONS,WRITE          RESET WRITE COMMAND.      XM5465 41949603
         B     BLDFCCW                 BUILD REMAINING CCWS.     XM5465 41958003
         EJECT                                                          41960003
NOSD     EQU   *                                                 XM5465 41966403
.X326000 ANOP                                                    XM5465 41974803
         LR    REG0,REG1          GET CORRECT HOME ADDRESS AREA.        41983203
         L     REG0,CCW1CONS                                            41991603
         BCTR  REG0,0                                                   42000016
         ST    REG0,CCW1CONS      SET UP PTR FOR READ HOMEADDR          42080016
         B     BLDFCCW            CONSTRUCT REMAINING CCWS.             42160016
         SPACE                                                          42160403
UNASGZUS EQU   *                                                 M4682  42162020
         TM    UNASGBT,X'FF'            DO WE NEED TO  UNASSIGN  M4682  42164020
         BO    UNRET                    RETURN IF NOT            M4682  42166020
         L     REGB,TUCBPTR             GET UCB POINTER          M4682  42168020
         USING UCBOB,REGB                                        M4682  42170020
         CLI   UCBTBYT4,X'06'           ZEUS 1                   M4682  42172020
         BE    ZEUS1                    YES - GO PROSESS         M4682  42174020
         CLI   UCBTBYT4,X'07'           ZEUS I                   M4682  42176020
         BE    ZEUS2                    YES - GO PROCESS         M4682  42178020
         B     UNRET                    NO RETURN                M4682  42180020
ZEUS1    MVI   ZCCHH+2,X'30'            SET ZEUS 1 ALT           M4682  42182020
         DROP  REGB                                              M4682  42184020
         B     COMZ                     GO TO COMMON RTN         M4682  42186020
ZEUS2    MVI   ZCCHH+2,X'60'            ST A ZEUS 2 ALT          M4682  42188020
COMZ     EQU   *                                                 M4682  42190020
         MVC   SAVCCHHR(4),SEEKADDR+3   SAVE SEEK ADDRESS        M4682  42192020
         MVC   SAVCCWPT(4),CCWPTR       SAVE CCW POINTER         M4682  42194020
         LA    REGB,ZALTCCW             LOAD CCW CHAIN TO        M4682  42196020
*                                       U4NASSIGN                M4682  42198020
         ST    REGB,CCWPTR              STORE TEMP CCW POINTER   M4682  42200020
         MVC   SEEKADDR+3(4),ZEUSALT    SET SEEKADDR FOR ZERO    M4682  42202020
         MVI   WKAECB,0                 ZERO ECB                 M4682  42204020
         DROP  REGF                                              M4682  42206020
         USING IHADCB,REGB                                       M4682  42208020
         LR    REGB,REGF                LOAD IOBLOCKS ADDRESS    M4682  42210020
         EXCP  WKAIOB                                            M4682  42212020
         WAIT  ,ECB=WKAECB                                       M4682  42214020
         DROP  REGB                                              M4682  42216020
         USING IHADCB,REGF                                       M4682  42218020
         LR    REGF,REGB                RESET IOB PTR            M4682  42220020
         CLI   WKAECB,X'7F'             GOOD COMPLETE            M4682  42222020
         BNE   IOERROR                                           M4682  42224020
         MVC   SEEKADDR+3(4),SAVCCHHR   RESTORR SEEK ADDRESS     M4682  42226020
         MVC   CCWPTR(4),SAVCCWPT       RESTORE CCW POINTER      M4682  42228020
         B     UNRET                    RETURN                   M4682  42230020
         EJECT                                                          42232003
ENDCCWS  EQU   *                                                        42240016
         L     REGE,IODEVCON           POINT TO DEVCON         @Z30RSAG 42290003
         MVC   TRACKCTL(4),LASTALT  SET UP STOPPING TRACK COUNT.        42320016
         MVI   FLAGREAD,1         SET ALTERNATE TRACK INDICATOR.        42360016
         CLI   UCBTBYT4,D3350          3350 ?                  @VS40037 42370003
         BNE   SETFLAG                 NO, CONTINUE NRM        @VS40037 42380003
         MVI   SDHA,1                  SET HA FLAG             @VS40037 42390003
ENDOFCCW EQU   *                                                        42400016
         LA    REGF,FBLOCKS       GET I/O BLOCKS BASE.                  42480016
         L     REG3,COPYPTR       GET BASE FOR COPY BLOCK.              42560016
         L     REG1,PTRCFUNC                                            42640016
         OI    0(REG1),PROCESS    INDICATE FUNCTION IS PROCESSING.      42720016
         XC    RETRYCNT(2),RETRYCNT    INITIALIZE PRIMARY RETRY COUNT.  42800016
         MVC   SEEKADDR+3(4),PRGSAVE   SET UP SEEK ADDRESS IN IOB.      42960016
         MVC   FLAGREAD+1(4),PRGSAVE   SET UP HOME ADDR IN FUNCBLK.     43040016
         CLI   UCBTBYT4,D3350          IS THIS A 3350?         @VS40037 43040403
         BE    TONLINE                 NO, USE 3340 PAT        @VS40037 43040803
         TM    FLGBYT1,EMU             IS DEVICE EMULATED ?    @Z30RSAG 43090003
         BZ    NOEMU                   NO, SKIP THIS           @Z30RSAG 43100003
         CLI   UCBTBYT4,WIN            IS IT 3340 ?            @Z30RSAG 43110003
         BE    NOEMU                   YES, SKIP THIS          @Z30RSAG 43112003
TONLINE  EQU   *                                               @VS40037 43112403
         L     REG9,TUCBPTR            POINT TO UCB            @Z30RSAG 43114003
         TM    SRTESTAT-UCBOB(REG9),SRTEONLI  IS IT ONLINE ?   @Z30RSAG 43116003
         BO    NOEMU                   YES, SKIP THIS          @Z30RSAG 43118003
         LA    REG0,SDCCW1             POINT TO RHA/SENSE CCWS @Z30RSAG 43118403
         ST    REG0,CCWPTR             STORE PTR IN IOB        @Z30RSAG 43118803
NOEMU    EQU   *                                               @Z30RSAG 43119203
TESTALT  EQU   *                                                        43120016
         CLC   STNDR0(4),TRACKCTL IS THIS LAST ALTERNATE TRACK.         43200016
         BNH   EXCHNPRO           NO-EXECUTE CHANNEL PROGRAM.           43280016
         AIF ('&LIB' EQ 'LIB1').X328000                          XM5465 43290003
         MVI   SDCCW2+D4,NULL          UNCHAIN CCW               XM5465 43330003
         CLI   UCBTBYT4,WIN            IS IT 3340 ?            @Z30RSAG 43332003
         BE    YES                     BRANCH IF YES           @Z30RSAG 43334003
         MVI   SDCCW2+D4,X'40'         ELSE RECHAIN            @Z30RSAG 43336003
YES      EQU   *                                               @Z30RSAG 43338003
.X328000 ANOP                                                    XM5465 43340003
         XC    SEEKADDR+3(5),SEEKADDR+3  SET UP FIRST PRIMARY TRACK.    43360016
         SR    REG0,REG0                                                43440016
         ST    REG0,STNDR0        SET STANDARD R0 TO TRACK ZERO.        43520016
         ST    REG0,PRGSAVE       SET COUNT SAVE TO TRACK ZERO.         43600016
         XC    FLAGREAD(5),FLAGREAD    SET  HOME ADDRESS TO TRACK ZERO. 43680016
         MVI   SDHA,0                   RESET PRIMARY HA FLAG  @VS40430 43730003
EXCHNPRO EQU   *                                                        43760016
         MVC   SDHA+1(4),PRGSAVE        UPDATE NEW HA CCHH     @VS40430 43810003
         DROP  REGF                                                     43840016
         USING IHADCB,REGB                                              43920016
         B     UNASGZUS                 TRY TO UNASSIGN 2305 ALT M4682  43940020
         EJECT                                                          43950003
UNRET    EQU   *                                                 M4682  43960020
         LR    REGB,REGF          SET UP TEMPORARY CONTROL BLOCKS BASE. 44000016
         AIF   ('&LIB' EQ 'LIB1').X326104                        XM5465 44050003
         CLI   FUNCSW,FORMAT           IS THIS A FORMAT?         XM5465 44060003
         BE    STARTIO                 YES, START CHAN PROG.     XM5465 44070003
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 44072003
         BNE   STARTIO                 NO, START CHAN PROG.      XM5465 44074003
         LA    REG0,SDCCW1             GET DEFECT FIND CCW.      XM5465 44076003
         ST    REG0,CCWPTR             USE AS IOBSTART ADDR.     XM5465 44078003
         SPACE                                                          44080003
*****************************************************************XM5465 44088003
*     ON 3340 ONLY, THE FOLLOWING EXCP WILL SCAN THE PACK FOR    XM5465 44091603
*     TRACKS THAT ARE FLAGGED DEFECTIVE.                         XM5465 44101603
*****************************************************************XM5465 44103603
         SPACE                                                          44113603
STARTIO  EQU   *                                                 XM5465 44119203
.X326104 ANOP                                                    XM5465 44132803
         MVI   WKAECB,0           CLEAR ECB FLAGS.                      44146403
         EXCP  WKAIOB           INITIATE CHANNEL PROGRAM.               44160016
         DROP  REGB                                                     44240016
         USING IHADCB,REGF                                              44320016
         LR    REGF,REGB          RESTORE CONTROL BLOCKS BASE.          44400016
         LTR   REG3,REG3          IS THERE ANOTHER COPY OPERATION.      44480016
         BZ    CHKCONC            NO-TEST FOR CONCURRENT OPERATIONS.    44560016
         XC    CRTRYCNT(2),CRTRYCNT    INITIALIZE PRIMARY RETRY COUNT.  44640016
         MVC   CFLGREAD(1),FLAGREAD  SET PROPER INDICATION IN COPY HA.  44720016
         MVC   CFLGREAD+1(4),PRGSAVE   SET UP HOME ADDR IN COPYBLK.     44800016
         LA    REGF,CIOBLOCK      YES-BR AND INITIATE NEXT COPY.        44880016
         MVC   SEEKADDR+3(4),PRGSAVE  SET UP SEEK ADDRESS IN IOB.       44960016
         L     REG3,CCOPYPTR      GET POINTER TO NEXT COPY BLOCK.       45040016
         B     TESTALT            BR AND TEST FOR LAST ALTERNATE.       45120016
CHKCONC  EQU   *                                                        45200016
         MVI   UNASGBT,X'FF'           FINISHED COPIES SET BYTE  M4682  45240020
         TM    SW1,MULTIPLE       IS THIS ACONCURRENT OPERATION.        45280016
         BO    CONCUR             BRANCH IF YES.                        45360016
RETURNAD EQU   *                                                        45440016
         LA    REGF,FBLOCKS       RESTORE FUNCTION I/O BLOCK PTR.       45520016
         L     REG3,COPYPTR       POINT TO 1ST COPY BLOCK.              45600016
         L     REG2,TUCBPTR       GET CURRENT UCB POINTER.              45680016
         AIF   ('&LIB' EQ 'LIB2').X227216                       XL03912 45720003
         CLI   UCBID,X'FF'        WAS THIS A 2321 DATA CELL.            45760016
         BNE   LINK2321           YES-RECALL IEHDCELL.                  45840016
.X227216 ANOP                                                   XL03912 45880003
         EJECT                                                          45890003
REWAITF  EQU   *                                                        45920016
         BAL   REG8,WAITLOOP      WAIT FOR I/O COMPLETION.              46000016
         CLI   DDNAME2,BLANK           OFFLINE PROC. ?         @VS40037 46001203
         BNE   MVCFLAG                 NO, CONTIN              @VS40037 46001603
         CLI   UCBTBYT4,WIN             3340 ?                 @ZM42055 46001703
         BNE   ARNDMVC                  NO, BYPASS HA VERIFY   @ZM42055 46001803
         CLC   SEEKCCHH(L4),FLAGREAD+1  COMPARE HA TO SEEK ADR @ZM42055 46001903
         BE    ARNDMVC                  BRCH IF GOOD           @ZM42055 46018003
         MVC   SDHA+1(L4),SEEKCCHH      CORRECT HA CCHH        @ZM42055 46028003
         B     PREFLAG                  GO REWRITE HA/R0       @ZM42055 46030003
MVCFLAG  EQU   *                                               @VS40037 46050403
         MVC   SDHA,FLAGREAD           SAVE HA FOR POSSIBLE S/A. XM5465 46060003
ARNDMVC  EQU   *                                               @VS40037 46060403
         TM    FLAGREAD,X'02'     WAS THE TRACK PREFLAGGED.             46080016
         BO    PREFLAG            BRANCH IF YES.                        46160016
         LH    REGB,RETRYCNT      GET RETRY COUNT.                      46240016
         LTR   REGB,REGB          RETRY COUNT EQUAL ZERO.               46320016
         BZ    TESTWAIT           YES-BRANCH AND TEST FOR OTHER REQ'S.  46400016
         BCTR  REGB,0             NO DECREMENT RETRY COUNT.             46480016
         STH   REGB,RETRYCNT      SAVE NEW RETRY COUNT.                 46560016
RESTARTF LR    REGB,REGF          SAVE CONTROL BLOCK POINTER.           46640016
         EXCP  WKAIOB             RESTART CHANNEL PROGRAM.              46720016
         LR    REGF,REGB          RESTORE CONTROL BLOCK POINTER.        46800016
         B     REWAITF            LOOP UNTIL THERE ARE 10 SUCCESSES.    46880016
TESTWAIT EQU   *                                                        46960016
         LTR   REG3,REG3          ARE THERE OUTSTANDING REQUESTS.       47040016
         BZ    TESTPASS           NO-GO AND TEST PASSCNT.               47120016
         L     REG2,CUCBPTR            GET POINTER TO COPY UCB.         47200016
REWAITC  EQU   *                                                        47280016
         LA    REGF,CIOBLOCK      POINT TO COPY CONTROL BLOCKS.         47360016
         BAL   REG8,WAITLOOP      WAIT FOR I/O COMPLETION.              47440016
         AIF   ('&LIB' EQ 'LIB1').X327501                        XM5465 47490003
         MVC   SDHA,CFLGREAD           SAVE HA FOR POSSIBLE S/A. XM5465 47500003
.X327501 ANOP                                                    XM5465 47510003
         TM    CFLGREAD,X'02'     WAS TRACK PREFLAGGED.                 47520016
         BO    PREFLAGC           YES-ASSIGN ALTERNATE TRACK.           47600016
         LH    REGB,CRTRYCNT      GET RETRY COUNT.                      47680016
         LTR   REGB,REGB          RETRY COUNT EQUAL ZERO.               47760016
         BZ    CTSTWAIT           YES-TEST FOR OTHER OUTSTANDING REQS.  47840016
         BCTR  REGB,0             DECREMENT AND SAVE                    47920016
         STH   REGB,CRTRYCNT      RETRY COUNT.                          48000016
RESTARTC EQU   *                                                        48080016
         LR    REGB,REGF          SAVE I/O CONTROL BLOCKS REG.          48160016
         EXCP  WKAIOB             RETRY TRACK ANALYSIS.                 48240016
         LR    REGF,REGB          RESTORE I/O CONRROL BLOCKS REGS.      48320016
         B     REWAITC            LOOP  UNTIL FINISH OR BAD TRACK.      48400016
CTSTWAIT EQU   *                                                        48480016
         L     REG3,CCOPYPTR      GET POINTER TO NEXT COPY BLOCK.       48560016
         B     TESTWAIT           LOOP THROUGH UNTIL FINISH OR ERROR.   48640016
         EJECT                                                          48690003
*                                                                       48720016
**********************************************************************  48800016
*                                                                       48880016
WAITLOOP EQU   *                                                        49120016
         TM    WKAECB,COMPLETE    WAS I/O COMPLETE.                     49200016
         BO    IOCMPLTE           YES-BYPASS WAIT .                     49280016
         LR    REGB,REGF          SAVE CONTROL BLOCK REGISTERS.         49360016
         DROP  REGF                                                     49380016
         USING IHADCB,REGB                                              49400016
         WAIT  ,ECB=WKAECB        WAIT FOR I/O COMPLETION.              49440016
         LR    REGF,REGB          RESTORE CONTROL BLOCK POINTERS.       49520016
         DROP  REGB                                                     49600016
         USING IHADCB,REGF                                              49680016
IOCMPLTE EQU   *                                                        49760016
         CLI   WKAECB,X'7F'        WAS I/O SUCCESSFUL .                 49840016
         BCR   8,REG8             RETURN ON SUCCESSFUL COMPLETION.      49920016
         CLI   FUNCSW,FORMAT            IS IT A FORMAT OPERATION M4682  49925020
         BNE   IOERROR                  NO - MUST BE ERROR       M4682  49930020
         CLC   SEEKADDR+3(4),TRACKCTL   IS THIS THE LAST ALT     M4682  49935020
         BNE   IOERROR                  NO - LEGIT ERROR         M4682  49940020
         L     REGB,TUCBPTR             LOAD UCB POINTER         M4682  49945020
         MVC   STNDR0(4),ZCCHH+1        DUMMY UP HA              M4682  49950020
         MVI   ZCCHH+4,X'01'            SET BEYOND LAST 2305 HH  M4682  49955020
         MVC   FALTDATA(6),ZCCHH+1      SET NO ALTS LEFT         M4682  49960020
*                                       CONDITION                M4682  49965020
         CLI   19(REGB),X'06'           IS IT 2305-1             M4682  49970020
         BE    0(REG8)                  YES ALT ASSIGNED NO      M4682  49975020
*                                       ERROR                    M4682  49980020
         CLI   19(REGB),X'07'           IS IT 2305-2             M4682  49985020
         BE    0(REG8)                  YES ALT ASSIGNED NO      M4682  49990020
*                                       ERROR                    M4682  49995020
         EJECT                                                          49997003
IOERROR  EQU   *                                                        50000016
         LA    REGB,FBLOCKS       GET ADDRESS OF FUNCTION CONTROL BLKS. 50080016
         CR    REGF,REGB          TEST FOR PRIMARY OR COPY OPERATION.   50160016
         BNE   COPYOPER           BRANCH IF COPY OPERATION.             50240016
         TM    CSWORD+4,X'02'     WAS THERE A UNIT CHECK.               50320016
         BZ    SYNADERR           NO-I/O ERROR TERMINATE.               50400016
         TM    WKAIOB+2,X'08'     WAS ERROR A DATA CHECK.               50480016
         BZ    BADTRAKF           NO BRANCH                             50560016
RETRYF   EQU   *                                                        50640016
         CLI   RETRYCNT+1,0       IS THIS INITIAL ERROR ENTRY.          50720016
         BNE   BDTRKERF           NO-SET UP MESSAGE                     50800016
         MVI   RETRYCNT+1,10           YES-SET UP COUNT FOR 10 RETRIES  50880016
         B     RESTARTF           TRY FOR 10 SUCCESSES.                 50960016
COPYOPER EQU   *                                                        51040016
         TM    CSWORD+4,X'02'     WAS THERE A UNIT CHECK.               51120016
         BZ    SYNADERR           NO-I/O ERROR TERMINATE.               51200016
         TM    WKAIOB+2,X'08'     WAS ERROR A DATA CHECK.               51280016
         BZ    BADTRAKC           NO-BRANCH                             51360016
RETRYC   EQU   *                                                        51440016
         CLI   CRTRYCNT+1,0       IS THIS 1ST TIME IN ERROR SECTION.    51520016
         BNE   BDTRKERC           NO-PREPARE TO ASSIGN ALTERNATE        51600016
         MVI   CRTRYCNT+1,10           INITIALIZE RETRY COUNTER         51680016
         B     RESTARTC           LOOP                                  51760016
         EJECT                                                          51810003
*                                                                       51840016
**********************************************************************  51920016
*                                                                       52000016
*        THIS ROUTINE DETERMINES IF MULTIPLE SURFACE ANALYSIS PASSES    52080016
*        WERE REQUESTED,OR IF THIS WAS THE LAST PASS MODIFIES THE       52160016
*        CHANNEL PROGRAM TO WRITE STANDARD HOME ADDRESS AND R0.         52240016
*                                                                       52320016
**********************************************************************  52400016
*                                                                       52480016
TESTPASS EQU   *                                                        52560016
         LA    REG0,1                                                   52640016
         CH    REG0,PASSCNT       WERE MULTIPLE PASSES REQUESTED.       52720016
         BNL   TSTPRIME            NO-TEST FOR LAST PRIMARY TRACK.      52800016
         LH    REG0,COUNT                                               52880016
         LTR   REG0,REG0           YES-TEST FOR LAST PASS COMPLETED.    52960016
         BZ    TSTPRIME            NO-TEST FOR LAST PRINARY.            53040016
         BCTR  REG0,0              DECREMENT PASS COUNT.                53120016
         STH   REG0,COUNT          STORE UPDATED COUNT .                53200016
         LTR   REG0,REG0           IS THIS THE LAST PASS REQUESTED.     53280016
         BP    ENDOFCCW            NO-RESTART CHANNEL PROGRAM.          53360016
         LA    REGF,FBLOCKS        POINT TO PRIMARY CONTROL BLOCKS.     53440016
         L     REG3,COPYPTR        GET COPY BLOCK POINTER .             53520016
RESETCCW EQU   *                                                        53600016
         OI    CCWACONS+4,X'40'   SET COMMAND CHAIN ON.                 53680016
         LTR   REG3,REG3           IS THIS THE FINAL COPY REQUESTED.    53760016
         BZ    ENDOFCCW            YES-START ANALYSIS ON FINAL DEVICE.  53840016
         LA    REGF,CIOBLOCK       POINT TO COPY CONTROL BLOCKS.        53920016
         L     REG3,CCOPYPTR       POINT TO NEXT COPY BLOCK.            54000016
         B     RESETCCW            LOOP UNTIL ALL COPIES ARE COMPLETE.  54080016
*                                                                       54160016
**********************************************************************  54240016
         EJECT                                                          54290003
*                                                                       54320016
**********************************************************************  54400016
*                                                                       54480016
TSTPRIME EQU   *                                                        54560016
*                                                                       54640016
**********************************************************************  54720016
*                                                                       54800016
         MVC   COUNT(2),PASSCNT   RESET NUMBER OF PASSES COUNTER.       54880016
         TM    SEQSW+D1,MSSFLG     MSS ANALYZE                 @ZA04403 54890050
         BO    MSSALT              YES, CHECK FOR ALTERNATE    @ZA04403 54900050
CKPRIM   EQU   *                   CONTINUE TO CHECK PRIME     @ZA04403 54910050
         L     REG9,STNDR0         GET R0 OF LAST TRACK ANALYZED.       54960016
         L     REGE,IODEVCON           POINT TO DEVCON         @Z30RSAG 55010003
         C     REG9,LASTORIG       WAS THIS LAST PRIME TRACK.           55040016
         BE    BLDVTOC             YES-CREATE A VTOC FOR THIS VOL.      55120016
         LA    REG0,1              NO                                   55200016
         AR    REG9,REG0                                                55280016
         CLC   STNDR0+3(1),LASTORIG+3 WAS THIS LAST TRACK TRACK ON CYL. 55360016
         BL    CLRFLAGS            NO-BYPASS CYLINDER CONVERSION.       55440016
         BCTR  REG9,0                                                   55520016
         A     REG9,CONVCYL        GET TO NEXT CYLINDER.                55600016
CLRFLAGS EQU   *                                                        55680016
         ST    REG9,STNDR0        UPDATE CCHH OF STANDARD R0.           55760016
         ST    REG9,MAXLTHR0      UPDATE CCHH OF MAXIMUM LENGTH 0 R0.   55840016
         ST    REG9,PRGSAVE       SAVE CCHH TO STORED INTO IOB.         55920016
         ST    REG9,MAXR0BIT      UPDATE CCHH OF MAXIMUM LTG BIT R0.    56000016
         CLI   DDNAME2,BLANK           OFFLINE PROC. ?         @VS40037 56001203
         BNE   SETFLAG                 NO, CONTIN              @VS40037 56001603
         MVC   SDHA+1,PRGSAVE          UPDATE HA CCHH FLD      @VS40037 56002003
SETFLAG  EQU   *                                               @VS40037 56002403
         B     ENDOFCCW           LOOP AND START ANAL/FORMAT NEXT TRK.  56080016
         EJECT                                                          56082003
*                                                                       56084003
*********************************************************************** 56086003
*                                                                       56088003
MSSALT   EQU   *                  TEST FOR MSS ALTERNATE TRACK @ZA04403 56090050
*                                                                       56092003
*********************************************************************** 56094003
*                                                                       56096003
         TM    FLGBYT1,MSSMOD     MSS MODIFIED CHNPGM          @ZA04403 56110050
         BO    MSSRSET            YES, RESET TO ORIGINAL       @ZA04403 56120050
         TM    FLAGREAD,ALTRNATE  FORMER ALTERNATE             @ZA04403 56130050
         BNO   CKPRIM             NO, CONTINUE NORMALLY        @ZA04403 56140050
         TM    FLAGREAD,FLAGTEST  DEFECTIVE PRIMARY TRACK?     @ZA04403 56150050
         BO    CKPRIM             YES, CONTINUE NORMALLY       @ZA04403 56160050
         L     REG9,STNDR0        UPDATE CCHH OF STANDARD R0   @ZA04403 56162050
         L     REGE,IODEVCON      POINT TO DEVCON              @ZA04403 56164050
         C     REG9,LASTORIG      WAS THIS LAST PRIME TRACK    @ZA04403 56166050
         BH    CKPRIM             YES, CONTINUE NORMALLY       @ZA04403 56168050
         MVI   CCWBCONS,WRITE     SET SEARCH TO A WRITE HA     @ZA04403 56170050
         L     REG9,CCWBCONS      GET ADDRESS OF CCWBCONS      @ZA04403 56172050
         BCTR  REG9,0             POINT TO FLAG FIELD          @ZA04403 56174050
         ST    REG9,CCWBCONS      SAVE IT FOR CHANNEL PROGRAM  @ZA04403 56176050
         MVI   CCWBCONS+L7,L5     MOVE IN COUNT OF 5           @ZA04403 56178050
         LA    REG9,CCWDCONS      GET WRITE R0                 @ZA04403 56180050
         ST    REG9,CCWCCONS      SETUP FOR TIC                @ZA04403 56182050
         MVI   CCWCCONS,TICCMD    RESET TIC BYTE               @ZA04403 56184050
         NI    FLAGREAD,ALLBITS-ALTRNATE RESET ALTERNATE       @ZA04403 56200050
         OI    FLGBYT1,MSSMOD     INDICATE CCW MODIFIED        @ZA04403 56202050
         B     ENDOFCCW           EXECUTE CHAN PROGRAM AGAIN   @ZA04403 56204050
MSSRSET  EQU   *                  RESET THE WRITE TO READ      @ZA04403 56206050
         L     REG9,CCWBCONS      GET CCWBCONS                 @ZA04403 56208450
         LA    REG9,1(REG9)       POINT TO ADDRESS AGAIN       @ZA04403 56208850
         ST    REG9,CCWBCONS      SAVE CCWBCONS                @ZA04403 56208950
         MVI   CCWBCONS,SERHA     SET OPCODE TO SEARCH HA      @ZA04403 56209050
         MVI   CCWBCONS+L7,L4     MOVE IN COUNT OF 4           @ZA04403 56209150
         LA    REG9,CCWBCONS      GET NEW CCWBCONS ADDRESS     @ZA04403 56211150
         ST    REG9,CCWCCONS      SAVE IT FOR TIC              @ZA04403 56211550
         MVI   CCWCCONS,TICCMD    RESTORE TIC OPCODE           @ZA04403 56211950
         NI    FLGBYT1,ALLBITS-MSSMOD RESET FLAG               @ZA04403 56213150
         B     CKPRIM             CONTINUE NORMALLY            @ZA04403 56215150
         EJECT                                                          56217103
**********************************************************************  56240016
*                                                                       56320016
BLDVTOC  EQU   *                                                        56400016
*                                                                       56480016
**********************************************************************  56560016
*                                                                       56640016
         DROP  REGF                                                     56720016
         USING IHADCB,REGB                                              56800016
         LA    REGB,FBLOCKS       SET UP TEMPORARY BASE.                56880016
         SPACE                                                          56960003
*        LINK  TO BUILD VTOC.                                           57040016
         LR    REG1,REG5          PASS POINTER TO MY WORKAREA.          58160016
         LINK  EP=IEHDVTOC        CONSTRUCT VTOC FOR THIS VOLUME.       58240016
*********************************************************************** 58320016
         LA    REGD,SAVEAREA      RESTORE MY SAVEAREA POINTER.          58360016
         L     REG3,COPYPTR       GET POINTER TO COPY BLOCK.            58380002
         LTR   REGF,REGF          WAS VTOC CONSTRUCTION SUCCESSFUL.     58400016
         BNZ   MSGBUILD           NO GIVE CORRECT DIAGNOSTIC.           58480016
         LA    REG8,RETRNORM                                            58640016
         EJECT                                                          58690003
CLOSENXT EQU   *                                                        58720016
         TM    DCBOFLGS,X'10'     WAS THIS DCB OPENED.                  58800016
         BCR   8,REG8             NO  BRANCH TO FREECORE.               58880016
         CLOSE ((REGB))           CLOSE ALL OPENED DCBS.                58960016
         LR    REGF,REGB          RESTORE PERMANENT BASE.               59040016
         DROP  REGB                                                     59120016
         USING IHADCB,REGF                                              59200016
         LTR   REG3,REG3          ARE THERE MORE OPEN DCBS.             59280016
         BCR   8,REG8             RETURN TO MONITOR.                    59360016
         LA    REGB,CIOBLOCK      GET POINTER TO COPY DCB.              59440016
         L     REG3,CCOPYPTR      POINT TO NEXT COPY BLOCK.             59520016
         B     CLOSENXT                                                 59600016
         EJECT                                                          59650003
*                                                                       59680016
**********************************************************************  59760016
*                                                                       59840016
*  THIS ROUTINE IS ENTERED WHENEVER CONCURRENT OPERATION IS REQUESTED.  59920016
*                                                                       60000016
**********************************************************************  60080016
*                                                                       60160016
CONCUR   EQU   *                                                        60240016
         ST    REGD,SAVEPTR       SAVE POINTER TO MY SAVE AREA.         60320016
         STM   REGE,REGC,RETADREG SAVE MY REG ON CONCURRENT OPERATIONS. 60400016
         SR    REGF,REGF          CLEAR RETURN CODE REGS.               60480016
RELOADRG EQU   *                                                        60520016
         L     REGD,OLDSAPTR RESTORE SAVE AREA POINTER.                 60560016
         B     RETURNCO           RETURN TO MONITOR.                    60640016
NOCORIND EQU   *                                                        60720016
         L    REG1,PTRCFUNC      GET SLOT FOR CURRENT FUNCTION.         60800016
         OI    0(REG1),NOCORE+WAITING SET NOCORE/WAITING IND.           61200016
         L     REGD,OLDSAPTR           RELOAD REG 13.                   61210016
         FREEMAIN R,LV=SIZE,A=(REG5)    FREE MY WORK AREA.              61220016
         LA    REGF,4                  SET UP RETURN CODE.              61240016
         B     RETURNCO           RETURN TO MONITOR.                    61260016
RETRNABN EQU   *                                                        61287016
         L     REG1,PTRCFUNC      GET POINTER TO CURRENT FUNCTION SLOT. 61294016
         LTR   REGF,REGF          IS THIS A SUCCESSFUL COMPLETION.      61301016
         BZ    FREECORE           YES-BYPAS UNUSEABLE MSG.              61308016
         TM    0(REG1),PROCESS         WAS A WRITE OPERATION STARTED.   61315016
         BZ    FREECORE           NO-BYPASS NONUSEABLE MSG.             61322016
         LA    REG1,30                                                  61329016
         BAL   REG8,BUILDMSG      PRINT UNUSEABLE MSG.                  61336016
         MVC   0(8,REG1),DDNAME2      INSERT DDNAME INTO MSG.           61343016
         L     REG3,COPYPTR       GET POINTER TO 1ST COPYBLK.           61350016
ERRLOOP  EQU   *                                                        61357016
         BAL   REG8,PRNTLINK      PRINT MSG .                           61364016
         LTR   REG3,REG3          IS THIS END OF COPIES.                61371016
         BZ    FREECORE           YES-SET COMPLETE AND TERMINATE.       61378016
         LA    REG1,30                                                  61385016
         BAL   REG8,BUILDMSG      SET MSG FOR COPY.                     61392016
         MVC   0(8,REG1),DDNAME3      INSERT DDNAME INTO MSG.           61399016
         L     REG3,CCOPYPTR      GET ADDRESS OF NEXT COPYBLK.          61406016
         B     ERRLOOP            LOOP UNTIL ALL COPIES ARE COMPLETE.   61413016
         EJECT                                                          61415003
RETCOMP  EQU   *                                                        61420016
         L     REG1,PTRCFUNC      GET PTR TO CURRENT FUNCTION SLOT.     61427016
         MVI   0(REG1),COMPLETE   MARK CURRENT FUNCTION COMPLETE.       61440016
RETURNCO EQU   *                                                        61520016
         RETURN (14,12),T,RC=(15) RETURN TO CALLER.                     61600016
*                                                                       61680016
**********************************************************************  61760016
*                                                                       61840016
RETRNORM EQU   *                                                        61920016
         DROP  REGF                                                     62000016
         USING IHADCB,REGB                                              62080016
         LA    REGB,FBLOCKS       SET PRIMARY CONTROL BLOCKS BASE.      62160016
         L     REG2,TUCBPTR       GET PRIMARY FUNCTION UCB POINTER.     62240016
         LA    REG9,FUNCNAM1      ASSUME ANALYZE FUNCTION.              62320016
         CLI   FUNCSW,FORMAT      CHECK FOR FORMAT FUNCTION.            62400016
         BNE   FUNCOKAY           BRANCH IF ANALYZE.                    62480016
         LA    REG9,FUNCNAM2      POINT TO FORMAT FUNCTION.             62560016
FUNCOKAY EQU   *                                                        62640016
         LA    REGE,DDNAME2       POINT TO NAME IN FUNCBLK.    @ZA04403 62690050
         L     REG3,COPYPTR       POINT TO FIRST COPY BLOCK.            62800016
         EJECT                                                          62850003
POSTLOOP EQU   *                                                        62880016
         LA    REG1,6                                                   62960016
         ST    REGE,TEMP               SAVE PTR TO DDNAME      @Z30RSAG 63010003
         BAL   REG8,BUILDMSG      BUILD 'COMPLETE' MSG INTO MSG BUFFER. 63040016
         L     REGE,TEMP               RESTORE PTR TO DDNAME   @Z30RSAG 63090003
         MVC   40(6,REG1),FSERNO  ASSUME NEWVOLID WAS SPECIFIED.        63120016
         MVC   0(8,REG1),0(REGE)  INSERT DDNAME INTO MSG BUFFR @ZA04403 63170050
         MVC   MESS+9(10),0(REG9) INSERT FUNCTION INTO MSG BUFFER.      63280016
         TM    SEQSW,NEWVOLID     WAS NEWVOLID REQUESTED.               63360016
         BO    MSGCOMPL           YES-MSG IS COMPLETE IN BUFFER.        63440016
         AIF   ('&LIB' EQ 'LIB2').X227217                       XL03912 63480003
         CLI   UCBID,X'FF'        IS THIS A DATA CELL.                  63520016
         BNZ   MSG2321            YES-GET VOLID FROM SUBUCB.            63600016
.X227217 ANOP                                                   XL03912 63640003
         MVC   40(6,REG1),SRTEVOLI INSERT OLD VOLID INTO MSG BUFFER.    63680016
MSGCOMPL EQU   *                                                        63760016
         BAL   REG8,PRNTLINK      PRINT 'COMPLETE MSG FOR TODD.         63840016
         BAL   REG8,POSTUCB       POST THE UCB.                         63920016
         LTR   REG3,REG3          IS THERE ANOTHER COPY.                64000016
         BZ    POSTEND            NO-PREPARE TO EXIT.                   64080016
         LA    REGE,DDNAME3       POINT TO COPY TODD.          @Z30RSAG 64160003
         L     REG2,CUCBPTR       YES- GET PTR TO COPY UCB.             64240016
         LA    REGB,CIOBLOCK      GET POINTER TO  COPY DCB              64290016
         L     REG3,CCOPYPTR      POINT TO NEXT COPY BLOCK.             64340016
         B     POSTLOOP           LOOP UNTOL ALL UCBS ARE POSTED.       64400016
POSTUCB  EQU   *                                                        64480016
         SR    REG1,REG1          ASSUME OLD VOLID REQ'TD.              64560016
         ST    REG2,PARMUCB       STORE UCB PTR INTO PARM LIST.         64640016
         MVI   PARMUCB,X'08'      SET UP POST UCB INDICATOR.            64720016
         TM    SEQSW,NEWVOLID     WAS NEW VOLID REQUESTED.              64800016
         BZ    REG1OKAY           NO-SET REMAINER OF PARM LIST.         64880016
         LA    REG1,FSERNO        YES-GET ADDR OF NEW VOLID.            64960016
REG1OKAY EQU   *                                                        65040016
         ST    REG1,PARMCCHH      STORE VOLID PTR OR ZERO IN PARN LIST. 65120016
         MVC   SEEKADDR+3(4),VVTOCPTR  MOVE VTOC ADDRESS TO IOB SEEK.   65200016
         MVI   SEEKADDR+7,1       INSERT RECORD NO INTO  IOB.           65240016
         LA    REG1,SEEKADDR      GET PTR TO VTOC ADDRESS.              65280016
         ST    REG1,PARMALTD      STORE VTOC PTR INTO PARM LIST.        65360016
         LA    REG1,PARMALTD      ASSUME THIS IS LAST ENTRY IN LIST     65370016
         CLI   DDNAME2,X'40'      WAS THIS A NEW VOLUME REQUEST.        65380016
         BNE   POSTOKAY           NO-PARM LIST IS OKAY TO POST UCB.     65390016
         OI    PARMUCB,X'80'      YES-SET UP NEW VOLUME INDICATOR.      65400016
ONEPARM  EQU   *                                                 YM3475 65405002
         MVC   PARMDEB(4),DCBDEBAD     INSERT DEB ADDR INTO LIST.       65410016
         LA    REG1,PARMDEB       GET NEW LAST ENTRY ADDR.              65420016
POSTOKAY EQU   *                                                        65430016
         MVI   0(REG1),X'80'      INSERT LAST ENTRY INDICATOR INTO LIST 65440016
         LA    REG1,PARMLST       POINT TO PARM LIST.                   65520016
         SVC   82                 POST UCB.                             65600016
         BR    REG8               RETURN TO TEST FOR MORE UCBS.         65680016
POSTEND  EQU   *                                                        65760016
         DROP  REGB                                                     65840016
         USING IHADCB,REGF                                              65920016
         LH    REG2,RETCODE             GET COMPLETION CODE.    SA59746 66000021
         EJECT                                                          66050003
FREECORE EQU   *                                                        66080016
         L     REG9,WKBUFSI       GET SIZE OF WORKAREA TO BE FREED.     66160016
         LA    REG7,FBUFFPTR      GET ADDRESS OF AREA TO BE FREED.      66240016
         FREEMAIN E,LV=(REG9),A=(REG7)                                  66320016
FREEWKA  EQU   *                                                        66400016
         L     REGD,OLDSAPTR      GET SAVE AREA ADDRESS.                66480016
         FREEMAIN  R,LV=SIZE,A=(REG5)     FREE UNCONDITIONAL CORE.      66560016
         LR    REGF,REG2          GET PROPER RETURM CODE.               66640016
         B     RETCOMP                                                  66720016
**********************************************************************  66800016
**********************************************************************  66880016
**********************************************************************  66960016
*                                                                       67040016
BADEVICE EQU   *                                                        67120016
         LA    REG1,10            GET MESSAGE NUMBER.                   67200016
LINKAGE  EQU   *                                                        67280016
         BAL   REG8,BUILDMSG      GET DESIRED MSG.                      67360016
         MVC   0(8,REG1),DDNAME2    INSERT PROPER DDNAME                67440016
PRINTLNK EQU   *                                                        67480016
         LA    REG2,8             SET.UP REURN CODE                     67520016
         BAL   REG8,PRNTLINK          PRINT PROPER MSG.                 67680016
         LA    REG8,FREEWKA       SET UP RETURN ADRESS IN REG8.         67760016
         B     CLOSENXT           CLOSE ALL OPENED DATA SETS.           67840016
BADTRKAD EQU   *                                                        68320016
         LM    REG9,REG2,PRGSAVE  RESTORE REGS SAVED FOR CONVERT RTNE.  68400016
BADTRADD EQU   *                                                        68480016
         LA    REG1,25                                                  68560016
         L     REG3,COPYPTR       RESTORE COPY BLOCK BASE.              68640016
         B     LINKAGE                                                  68720016
         AIF   ('&LIB' EQ 'LIB2').X227218                       XL03912 68760003
IS2321   EQU   *                                                        68800016
         LOAD  EP=IEHDCELL        LOAD DCELL LOAD MODULE INTO CORE.     68820016
         ST    REG0,DCELADDR      SAVE ADDRESS OF LOAD MODULE IN FBLK.  68840016
         MVI   MAXR0BIT+4,1       SET UP R1 FOR IEHDCELL.               68880016
         LA    REG0,8                                                   68960016
         ST    REG0,MAXLTHR0+4    SET STANDARD R0 COUNT.                69040016
LINK2321 EQU   *                                                        69080016
         LA    REG1,SAVEVTOC      GET SAVEAREA PTR FOR IEHDCELL         69120016
         L     REGF,DCELADDR      GET ADDRESS OF LOAD MODULE.           69160016
         BALR  REGE,REGF          CALL IEHDCELL.                        69200016
         LA    REGD,SAVEAREA      RESTORE MY SAVEAREA POINTER.          69240016
         LTR  REGF,REGF                                                 69280016
         BNZ   ABNORMN                                                  69360016
         L     REG1,PTRCFUNC                                            69440016
         TM    0(REG1),COMPLETE   IS CURRENT COMPLETE.                  69520016
         BZ    CONCUR             NO-RETURN TO MONITOR.                 69600016
         DELETE  EP=IEHDCELL      REDUCE RESPONSIBILITY COUNT.          69640016
         B     BLDVTOC            OTHERWISE CONSTRUCT VTOC.             69680016
.X227218 ANOP                                                   XL03912 69720003
         EJECT                                                          69730003
BADTRAKF EQU   *                                                        69760016
         TM    WKAIOB+3,X'08'     WAS ER NO RCD FOUND          @ZM42054 69840003
         BO    RETRYF             YES-RETRY AND USE STANDARD ERROR REC. 69920016
         CLI   UCBTBYT4,X'08'     IS THIS A 2314.                       70000016
         BNE   SYNADERR         NO-IO ERROR TERMINATE.                  70080016
         TM    WKAIOB+3,X'02'     WAS ER MISS-ADDR-MKR         @ZM42054 70130003
         BO    RETRYF             RETRY AND USE STD ERR REC.   @ZM42054 70140003
         TM    WKAIOB+3,X'40'     IS THIS TRACK OVER RUN.               70160016
         BZ    SYNADERR           NO-SYNAD ERROR EXIT.                  70240016
PREFLAG  EQU   *                                                        70400016
         AIF   ('&LIB' EQ 'LIB1').X326202                        XM5465 70410003
         BAL   REG1,SDFLAG             CHECK FOR 3340.           XM5465 70430003
.X326202 ANOP                                                    XM5465 70440003
BDTRKERF EQU   *                                                        70450003
         LA    REG1,FALTDATA                                            70480016
         LA    REG9,DDNAME2       GET PTR TO PROPER BDNAME.             70560016
         AIF   ('&LIB' EQ 'LIB1').X227110                       XL03130 70580003
         LA    REG0,ODEVMOD             GET DEV MOD NO.         XL03130 70600003
.X227110 ANOP                                                   XL03130 70620003
         BAL   REG7,BUILDLST      BUILD LIST FOR SVC 82.                70640016
         L     REG7,FBUFFPTR      RESTORE BUFFER POINTER                70720016
         SR    REG0,REG0          SET CURRENT PASS TO LAST PASS.        70740016
         STH   REG0,COUNT                                               70760016
         B     TESTWAIT           WAIT FOR OUTSYANDING I/O REQ'S.       70800016
BADTRAKC EQU   *                                                        70880016
         TM    WKAIOB+3,X'08'     WAS ER NO RCD FOUND          @ZM42054 70960003
         BO    RETRYC             YES-RETRY AND USE STANDARD ERROR REC. 71040016
         CLI   UCBTBYT4,X'08'     IS THIS A 2314.                       71120016
         BNE   SYNADERR         NO-IO ERROR TERMINATE.                  71200016
         TM    WKAIOB+3,X'02'     WAS ER MISS-ADDR-MKR         @ZM42054 71250003
         BO    RETRYC             RETRY AND USE STD ERR REC.   @ZM42054 71260003
         TM    WKAIOB+3,X'40'     IS THIS TRACK OVER RUN.               71280016
         BZ    SYNADERR           NO-SYNAD ERROR EXIT.                  71360016
PREFLAGC EQU   *                                                        71520016
         AIF   ('&LIB' EQ 'LIB1').X326103                        XM5465 71530003
         BAL   REG1,SDFLAG             CHECK FOR 3340.           XM5465 71550003
.X326103 ANOP                                                    XM5465 71560003
BDTRKERC EQU   *                                                        71570003
         LA    REG1,CALTDATA      GET PTR TO ALTERNATE TRACK INFO.      71600016
         LA    REG9,DDNAME3       GET PTR TO PROPER DDNAME.             71680016
         AIF   ('&LIB' EQ 'LIB1').X227111                       XL03130 71700003
         LA    REG0,CDEVMOD             GET DEV MOD NO.         XL03130 71720003
.X227111 ANOP                                                   XL03130 71740003
         BAL   REG7,BUILDLST      BUILD PARAMETER LIST FOR SVC 82.      71760016
         L     REG7,FBUFFPTR      RESTORE BUFFER POINTER                71840016
         SR    REG0,REG0          SET CURRENT PASS TO LAST PASS.        71860016
         STH   REG0,COUNT                                               71880016
         B     CTSTWAIT           WAIT FOR OUTSTANDING I/O REQ'S.       71920016
         EJECT                                                          71930003
         AIF   ('&LIB' EQ 'LIB1').X326400                        XM5465 71970003
*****************************************************************XM5465 71970403
*                                                                XM5465 71970803
*    THIS ROUTINE IS ENTERED WHEN THE DEFECTIVE BIT IS FOUND     XM5465 71971203
*    TO BE ON IN THE HOME ADDRESS. IF THE FUNCTION IS ANALYZE    XM5465 71971603
*    WITH FLAGTEST=NO AND THE DEVICE IS A 3340, THE CCW          XM5465 71971703
*    POINTER IN THE IOB IS CHANGED TO POINT TO THE ANALYZE CCWS. XM5465 71971803
*    THE RETURN ADDRESS IS THEN IGNORED AND CONTROL IS PASSED    XM5465 71971903
*    TO THE ROUTINE WHICH WILL ATTEMPT TEN SUCCESSFUL  PASSES    XM5465 71976403
*    TO DETERMINE THE TRACK'S USEFULLNESS.                       XM5465 71978403
*                                                                XM5465 71980403
*****************************************************************XM5465 71980803
         SPACE                                                          71980903
SDFLAG   EQU   *                                                 XM5465 71981003
         CLI   FUNCSW,FORMAT           IS THIS A FORMAT?         XM5465 71985503
         BCR   EQ,REG1                 YES, ASSIGN ALTERNATE.    XM5465 71990003
         SPACE                                                          71990103
         CLI   UCBTBYT4,D3350          IS THIS A 3340?           XM5465 71990203
         BE    GETBACK                 TRY TO RECLAIM THE TRK  @ZM42054 71990399
         TM    FLGBYT1,EMU             IS THIS EMULATED 3330?  @ZA29674 71990699
         BO    GETBACK                 YES THEN TRY TO RECLAIM @ZA29674 71990899
         SPACE                                                          71991299
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 71992003
         BCR   NE,REG1                 NO, ASSIGN ALT.           XM5465 71994003
         SPACE                                                          71998903
GETBACK  EQU   *                                                 XM5465 71999203
         NI    SDHA,NODEFECT           REMOVE BIT 6 FROM HA.     XM5465 71999303
         NI    FLAGREAD,NODEFECT   REMOVE BIT 6 FROM FLAGREAD  @ZA29674 71999499
         LA    REG1,CCWSHCON           GET ANALYZE CCWS.         XM5465 72000499
         ST    REG1,CCWPTR             USE AS IOBSTART ADDRESS.  XM5465 72001499
         LA    REG1,FBLOCKS            ADDR OF PRIMARY BLOCKS.   XM5465 72002499
         CR    REG1,REGF               IS DEVICE A COPY?         XM5465 72003499
         BE    RETRYF                  NO, DO IT TO THE PRIMARY. XM5465 72004499
         B     RETRYC                  YES, DO IT TO A COPY.     XM5465 72005499
         EJECT                                                          72009903
.X326400 ANOP                                                    XM5465 72026603
*                                                                       72053303
**********************************************************************  72080016
*                                                                       72160016
BUILDLST EQU   *                                                        72240016
         LA    REG2,0(REG2)       CLEAR HIGH ORDER BYTE IN UCB REG.     73040016
         LR    REGB,REGF          SAVE I/O CONTROL BLOCKS PTR.          73120016
         MVC   PARMCCHH(4),SEEKADDR+3  SET UP CCHH OF BAD TRACK.        73200016
         ST    REG2,PARMUCB       SET UP PTR TO UCB IN PARMLST.         73280016
         ST    REG1,PARMALTD      SET UP PTR TO ALT DATA INFO.          73360016
         AIF   ('&LIB' EQ 'LIB1').X227112                       XL03130 73370003
         ST    REG0,PARMMOD             PUT DEV MOD PTR IN PARM.XL03130 73380003
         MVI   PARMMOD,LASTPARM         SET UP LAST PARM ENTRY  XL03130 73390003
         AGO   .X227113                                         XL03130 73400003
.X227112 ANOP                                                   XL03130 73410003
         MVI   PARMALTD,X'80'     SET UP LAST ENTRY INDICATOR.          73440016
.X227113 ANOP                                                   XL03130 73480003
         LA    REG1,31            PICK UP MESSAGE NUMBER.               73520016
         BAL   REG8,BUILDMSG      PLACE MESSAGE INTO OUTPUT BUFFER.     73600016
         MVC   0(8,REG1),0(REG9)  INSERT  DDNAME INTO MSG.              73680016
         UNPK  13(9,REG1),PARMCCHH(5)                                   73760016
         TR    13(8,REG1),TRTABLE-240  CONVERT CCHH TO PRINTABLE FORM.  73840016
         MVI   21(REG1),X'40'        BLANK OUT ZONED BYTE.              73920016
         BAL   REG8,PRNTLINK      PRINT DEFECTIVE TRACK MESSAGE.        74000016
         DROP  REGF                                                     74006016
         USING IHADCB,REGB                                              74012016
         CLC   SEEKADDR+3(4),CCWORD2+4 WAS THIS TRACK ZERO.             74012516
         BNE   NOTZERO            NO-BYPASS NOT IPLABLE MSG.            74013016
         LA    REG1,28            YES-BUILD NOT IPLABLE MSG.            74013516
         BAL   REG8,BUILDMSG                                            74014016
         MVC   0(8,REG1),0(REG9)      INSERT PROPER DDNAME INTO MSG.    74014516
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               74015016
         BO    LNKTOPRT           YES-PRINT MSG AND TERMINATE.          74015516
         BAL   REG8,PRNTLINK      NO-PRINT MSG AND CONTINUE.            74016016
NOTZERO  EQU   *                                                        74016516
         AIF   ('&LIB' EQ 'LIB2').X225900                       XL03130 74020503
         TM    UCBTBYT4,2         IS THIS A DRUM DEVICE.                74025402
         BO    DRUMMSG            YES- NO ALTERNATE ASSIGNED MSG.       74029302
OK2305   EQU   *                                                 M4682  74033202
.X225900 ANOP                                                   XL03130 74034203
         TM    DCBIOBAD,X'80'     IS THIS A BAD HA-R0                   74037102
         BZ    NOTDRUM            NO-ASSIGN ALTERNATE TRACK.            74041002
         LA    REG1,29            GET DEFECTIVE HA/R0 MSG.              74044902
         BAL   REG8,BUILDMSG      PLACE MSG INTO OUTPUT BUFFER.         74048802
         MVC   0(8,REG1),0(REG9)  INSERT DDNAME INTO MSG BUFFER.        74052702
         AIF   ('&LIB' EQ 'LIB1').X225902                       XL03130 74053403
         CLI   UCBTBYT4,K2314           3330/3340/3350 DEVICE? @ZM42054 74054103
         BH    PRTGET                   YES, PRT MSG, CALL SVC @ZM42054 74054803
.X225902 ANOP                                                   XL03130 74055503
         CLI   UCBTBYT4,K2314     IS THIS A 2314 DEVICE.        XL03912 74056603
         BNE   LNKTOPRT           NO-PRINT MSG AND TERMINATE.           74060502
PRTGET   EQU   *                                                XL03130 74061503
         BAL   REG8,PRNTLINK      PRINT DEFECTIVE HA/R0 MSG.            74064402
         B     NOTDRUM                                                  74068302
         EJECT                                                          74070303
         DROP  REGB                                                     74072202
         USING IHADCB,REGF                                              74076102
         AIF   ('&LIB' EQ 'LIB2').X225901                       XL03130 74077103
DRUMMSG  EQU   *                                                        74080016
         CLI   UCBTBYT4,X'06'           IS IT A 2305-1           M4682  74083020
         BE    OK2305                   YES - THERE IS AN        M4682  74086020
*                                       ALTERNATE                M4682  74089020
         CLI   UCBTBYT4,X'07'           IS IT A 2305-2           M4682  74092020
         BE    OK2305                   YES - THERE IS AN        M4682  74095020
*                                       ALTERNATE                M4682  74098020
         LA    REG1,23            YES-SET UP MESSAGE AND TERMINATE.     74104016
         MVI   RETCODE+1,4              SET RETURN CODE TO 4.   SA59746 74108021
ALTLINK  EQU   *                                                        74112016
         BAL   REG8,BUILDMSG      BUILD MSG IN OUTPUT BUFFER.           74120016
INSDDNM  EQU   *                                                        74128016
         MVC   0(8,REG1),0(REG9)   INSERT DDNAME INTO MESSAGE.          74136016
         B     MSGPRINT                                                 74144016
.X225901 ANOP                                                   XL03130 74148003
NOTDRUM  EQU   *                                                        74152016
         TM    SEQSW+D1,MSSFLG          MSS CONVERSION ?       @Y30LSFY 74154003
         BNO   NOTMSS                   NO, BRCH               @Y30LSFY 74154403
         MVI   PARMUCB,MSSFLG           CHG PARMLIST ID        @Y30LSFY 74154803
NOTMSS   EQU   *                                               @Y30LSFY 74155203
         LA    REG1,PARMLST       GET POINTER TO PARM LIST.             74156016
         SVC   82                 ASSIGN ALTERNARE TRACK.               74160016
         B     *+4(REGF)                                                74240016
         B     GOODRTRN      0 RETURN CODE-SUCCESSFUL COMPLETION.       74320016
         B     *            SHOULD NOT OCCUR IF SO HANG.                74400016
         B     GOODTRK                 8 RET CODE - GOOD TRK   @VS40037 74480003
         B     IOERRORF     12 RETURN CODE -I/O ERROR.                  74560016
         B     NOALTRKF     16 RETURN-NO MORE ALTERNATE TRACKS.         74640016
GOODRTRN EQU   *                                                        74720016
         L     REG0,PARMCCHH      GET CCHH OF ASSIGNED ALTERNATE TRACK. 74800016
         LTR   REG0,REG0          WAS ALTERNATE TRACK ASSIGNED.         74880016
         BZ    NOMESSGE           NO-BYPASS MESSAGE OUTPUT.             74960016
         LA    REG1,32            GET MESSAGE NUMBER.                   75040016
         BAL   REG8,BUILDMSG      PLACE MESSAGE INTO OUTPUT BUFFER.     75120016
         MVC   0(8,REG1),0(REG9)  INSERT  DDNAME INTO MSG.              75200016
         UNPK  13(9,REG1),PARMCCHH(5)                                   75280016
         TR    13(8,REG1),TRTABLE-240  CONVERT CCHH TO PRINTABLE FORM.  75360016
         MVI   21(REG1),X'40'                                           75440016
MSGPRINT EQU   *                                                        75480016
         BAL   REG8,PRNTLINK      PRINT ALTERNATE TRACK MESSAGE.        75520016
         BR    REG7               RETURN TO CALLER.                     75600016
NOMESSGE EQU   *                                                        75680016
         LA    REG1,32            GET MESSAGE NUMBER.                   75760016
         BAL   REG8,BUILDMSG      PLACE MESSAGE INTO OUTPUT BUFFER.     75840016
         MVC   0(8,REG1),0(REG9)  INSERT  DDNAME INTO MSG.              75920016
         BAL   REG8,PRNTLINK      PRINT ALTERNATE TRACK MESSAGE.        76000016
         LR    REGF,REGB          RESTORE I/O CONTROL BLOCKS BASE.      76080016
         BR    REG7                                                     76160016
MSG23    EQU   23                      GOOD TRK MSG            @VS40037 76160403
L9       EQU   9                       USED IN UNPK INSTR      @VS40037 76162003
L11      EQU   11                       3350 WHA LENGTH        @VS40430 76162403
D10      EQU   10                                              @VS40037 76164003
GOODTRK  EQU   *                                               @VS40037 76166003
         LA    REG1,MSG23              PUT MSG NO IN REG       @VS40037 76166403
         BAL   REG8,BUILDMSG           PUT MSG IN BUFF         @VS40037 76168003
         UNPK  1(L9,REG1),PARMCCHH(REG5) UNPK TRK NO           @VS40037 76172003
         TR    1(L8,REG1),TRTABLE-240  TRANSL NO.              @VS40037 76176003
         MVI   D10(REG1),BLANK         RESET ZONED BYTE        @VS40037 76178003
         BAL   REG8,PRNTLINK           GO PRT MSG              @VS40037 76180003
         BR    REG7                    EXIT TO CALLER          @VS40037 76182003
IOERRORF EQU   *                                                        76240016
         LA    REG1,13            GET I/O ERROR MSG.                    76320016
         BAL   REG8,BUILDMSG      BUILD MSG IN OUTPUT AREA.             76400016
         MVC   0(3,REG1),SVCNUMBR  INSERT SVC NO THAT HAD I/O ERROR.    76480016
         MVC   3(8,REG1),0(REG9)     INSERT DDNAME INTO MSG.            76560016
         B     LNKTOPRT      PRINT MESSAGE AND TERMINATE.               76640016
NOALTRKF EQU   *                                                        76720016
         LA    REG1,27            GET NO MORE ALT TRKS MSG.             76800016
         BAL   REG8,BUILDMSG                                            76840016
         MVC   0(8,REG1),0(REG9)       INSERT DDNAME INTO MSG.          76880016
         B     LNKTOPRT           PRINT MSG AND TERMINATE.              76920016
         EJECT                                                          76930003
*                                                                       76960016
**********************************************************************  77040016
*                                                                       77120016
SYNADERR EQU   *                                                        77200016
         LR    REG9,REGF          SAVE I/O CNTL BLKS BASE.     @Z30RSAG 77280003
         DROP  REGF                                                     77360016
         USING IHADCB,REG9                                     @Z30RSAG 77440003
         LA    REG1,13            GET I/O ERROR MSG NO.                 77520016
         BAL   REG8,BUILDMSG      PLACE MSG INTO PRINT BUFFER.          77600016
         SYNADAF  ACSMETH=EXCP,PARM1=WKAIOB                             77680016
         MVC   MESS+22(78),49(REG1)   SET UP MSG HDNG.           SM4350 77760021
         SYNADRLS                                                       77840016
         LR    REGF,REG9          RESTORE I/0 CNTL BLKS BASE.  @Z30RSAG 77920003
         DROP  REG9                                            @Z30RSAG 78000003
         USING IHADCB,REGF                                              78080016
         B     LNKTOPRT           PRINT I/O ERROR MSG.                  78160016
ONLINERR EQU   *                                                        78240016
         LA    REG1,24                                                  78320016
         BAL   REG8,BUILDMSG      GET PROPER MSG.                       78400016
         MVC   0(8,REG1),DDNAME2                                        78480016
         B     LNKTOPRT                                                 78560016
ONLINERC EQU   *                                                        78640016
         LA    REG1,24                                                  78720016
SETMSG   EQU   *                                                        78760016
         BAL   REG8,BUILDMSG                                            78800016
         B     COPYMSG                                                  78880016
VOLUMERR EQU   *                                                        78960016
         LA    REG1,14            GET MSG NUMBER.                       79040016
         BAL   REG8,BUILDMSG      MOVE MSG TO OUTPUT BUFFER.            79050016
         MVC   0(8,REG1),DDNAME2  INSERT DDNAME INTO MSG BUFFER.        79060016
SYSRESER EQU   *                                                        79070016
         MVC   MESS+9(10),FUNCNAM1     INSERT FUNCTION NAME INTO MSG.   79080016
         CLI   FUNCSW,ANALYSIS    TEST FOR CORRECT FUNCTION.            79090016
         BE    PRINTLNK           PRINT MSG IF FUNCTION IS CORRECT.     79100016
         MVC   MESS+9(10),FUNCNAM2     INSERT FORMAT FUNCTION NAME.     79130016
         B     PRINTLNK           PRINT MSG AND TERMINATE.              79160016
         EJECT                                                          79170003
VOLUMERC EQU   *                                                        79200016
         LA    REG1,14                                                  79280016
SETUPCPY EQU   *                                                        79360016
         BAL   REG8,BUILDMSG                                            79440016
         MVC   0(8,REG1),DDNAME3                                        79520016
         B     SYSRESER           COMPLETE MSG AND PRINT/TERMINATE.     79620016
BADCOPY  EQU   *                                                        79760016
         LA    REG1,21                                                  79840016
         B     SETMSG             SET UP ERROR MSG IN OUTPUT BUFFER.    79920016
NOTOPEN  EQU   *                                                        80000016
         LA    REG1,5             GET MSG NUMBER.                       80080016
         LR    REG9,REGF          SAVE CURRENT POINTER.                 80160016
         BAL   REG8,BUILDMSG      GET PROPER MSG.                       80240016
         MVC   0(8,REG1),DDNAME2  ASSUME THIS WAS THE PRIMARY FUNC.     80320016
         LA    REGF,FBLOCKS                                             80400016
         CR    REG9,REGF          TEST FOR COPY FUNCTION.               80480016
         BE    LNKTOPRT           BRANCH IF PRIMARY FUNCTION.           80560016
         LR    REGF,REG9          POINT TO  CURRENT DCB.                80640016
COPYMSG  EQU   *                                                        80720016
         MVC   0(8,REG1),DDNAME3  INSERT COPY DDNAME INTO MSG.          80800016
LNKTOPRT EQU   *                                                        80880016
         BAL   REG8,PRNTLINK      PRINT CORRECT MSG.                    80960016
         LA    REGF,8             SET ABNORMAL COMPLETION CODE.         81000016
MSGBUILD EQU   *                                                        81040016
         LR    REG2,REGF          PICK UP RETURN CODE.                  81120016
         LA    REGB,FBLOCKS       POINT TO PRIMARY CONTROL BLOCKS.      81200016
         AIF   ('&LIB' EQ 'LIB1').X227300                        YM3475 81204002
         DROP  REGF                                                     81208002
         USING IHADCB,REGB                                              81212002
         CLI   DCBDDNAM,BLANK           IS THIS OFFLINE?         YM3475 81216002
         BNE   ONLINE                   NO, LET CLOSE DO IT.     YM3475 81220002
DELREQ   EQU   *                                                 YM1377 81222002
         CLC   DCBDEBAD(4),DDNAME2+4    IS DEB REMOVED?          YM3475 81224002
         BE    RETRNABN                  YES, GO FREE CORE.      YM3475 81228002
         MVI   PARMUCB,DELDEB           SET DEB DELETE REQUEST.  YM3475 81236002
         BAL   REG8,ONEPARM             GO DELETE DEB.           YM3475 81240002
         LTR   REG3,REG3                ANY COPIES?              YM3475 81244002
         BZ    RETRNABN                 NO, GO FREE CORE.        YM3475 81248002
         LA    REGB,CIOBLOCK            YES, GET COPY CNTL BLK.  YM3475 81252002
         L     REG3,CCOPYPTR            GET NEXT COPY POINTER.   YM3475 81256002
         B     DELREQ                   GO DELETE ANOTHER DEB.   YM3475 81260002
         EJECT                                                          81262003
ONLINE   EQU   *                                                 YM3475 81264002
.X227300 ANOP                                                    YM3475 81268002
         LA    REG8,RETRNABN      PICK UP RETURN ADDRESS.               81280016
         B     CLOSENXT           CLOSE ALL OPENED DATA SETS.           81360016
BUILDMSG EQU   *                                                        81440016
         LINK  EP=IEHDMSGB                                              81520016
         BR    REG8                                                     81600016
PRNTLINK EQU   *                                                        81680016
         LINK  EP=IEHDPRNT                                              81760016
         BR    REG8                                                     81840016
         AIF   ('&LIB' EQ 'LIB2').X227219                       XL03912 81880003
         USING DATACELL,REG2                                            81920016
MSG2321  EQU   *                                                        82000016
         MVC   40(6,REG1),DCELVOLI INSERT OLD VOLID INTO MSG BUFFER.    82080016
         B     MSGCOMPL               PRINT MESSAGE.                    82160016
.X227219 ANOP                                                   XL03912 82200003
         EJECT                                                          82210003
*                                                                       82240016
*                                 CONSTANTS                             82320016
*                                                                       82400016
         SPACE                                                          82402003
FACTPACK EQU   9                                                 S20201 82407020
RPS      EQU   X'40'                    INDIC RPS DEVICE        XM4389  82409003
TWO      EQU   2                        DISPLACEMENT CONSTANT    X99204 82411002
D1       EQU   1                                                 S20201 82435020
X05      EQU   X'05'                   HEX CONSTANT.             S20201 82442020
K3       EQU   3                       DISPLACEMENT CONSTANT.    S20201 82449020
K16      EQU   16                                                XM6030 82451000
K136     EQU   136                                               S20201 82456020
K2314    EQU   X'08'                    UCB DEVICE TYPE 2314.   XL03912 82456803
RETCODE  DC    H'0'                     RETURN CODE SAVE AREA.  SA59746 82458002
         AIF   ('&LIB' EQ 'LIB1').X227220                       XL03912 82458103
ALTRNATE EQU   X'01'                    ALTERNATE TRACK FLAG   @ZA04403 82458250
READ     EQU   X'1A'                    READ COMMAND           @ZA04403 82458550
ALLBITS  EQU   X'FF'                    ALL BITS OF ONE BYTE   @ZA04403 82458650
ZEU1     EQU   X'06'                    UCB DEVICE TYEP 2305-1. XL03912 82458703
ZEU2     EQU   X'07'                    UCB DEVICE TYPE 2305-2. XL03912 82459203
WIN      EQU   X'0A'                    UCB DEVICE TYPE 3340.   XL03130 82460003
D3350    EQU   X'0B'                   3350 DEVICE TYPE        @Z30RSAG 82460103
HAR0SKIP DC    H'286'                  SKIP DISPLACEMENT.        XM5465 82460303
TEST3340 DC    X'76B3BD1FAAAAFFFF'     3340 TEST PATTERN.        XM5465 82460403
PATTERN  DC    X'5555555555555555'     OTHER DEVICE PATTERN      XM5465 82460803
TICCMD   EQU   X'08'                   TRANS IN CHANNEL CMD      XM5465 82461203
SENSE    EQU   X'04'                   SENSE COMMAND.            XM5465 82461303
MAXBYTE  EQU   255                     MAX NUMBER IN ONE BYTE.   XM5465 82461403
NULL     EQU   0                       THE EMPTY SET.            XM5465 82461503
CHAIN    EQU   X'40'                   CHAINING CCWS             XM5465 82463503
B8       EQU   8                       LENGTH OF 8 BITS.         XM5465 82465503
D4       EQU   4                       DISPLACEMENT OF FOUR.     XM5465 82467503
D16      EQU   16                      DISPLACEMENT OF SIXTEEN.  XM5465 82467903
EQ       EQU   8                       EQUQL TO.                 XM5465 82468303
NE       EQU   7                       NOT EQUAL TO.             XM5465 82468703
LOW      EQU   4                       LESS THAN.                XM5465 82469103
K9       EQU   9                       CONSTANT OF 9.            XM5465 82469503
L4       EQU   4                       LENGTH OF FOUR          @ZA04403 82469650
L5       EQU   5                       LENGTH OF FIVE          @ZA04403 82469750
L7       EQU   7                       LENGTH OF SEVEN.          XM5465 82469903
L8       EQU   8                       LENGTH OF EIGHT.          XM5465 82470603
L24      EQU   24                      LENGTH OF TWENTY FOUR.    XM5465 82471003
ONE      EQU   1                       CONSTANT OF ONE.          XM5465 82471403
NODEFECT EQU   X'FD'                   MASK FOR ALL BUT DEFECT.  XM5465 82471503
WRITE    EQU   X'19'                   WRITE COMMAND.            XM5465 82471803
WR0      EQU   X'15'                   WRITE R0 COMMAND        @ZA04403 82471950
RR0      EQU   X'16'                   READ  R0 COMMAND        @ZA04403 82473950
SERHA    EQU   X'39'                   SEARCH HA COMMAND       @ZA04403 82475950
.X227220 ANOP                                                   XL03912 82476003
F1       DC    F'1'                                              S20201 82478003
ZERO     EQU   F1                      1ST 2 BYTES OF F1 EQ 00. SA59746 82482003
         EJECT                                                          82484003
         DS    0D          ALIGN CCWS ON A DOUBLE WORD BOUNDARY.        82486003
SETSECCW EQU   *                        *                        S20201 82490020
         CCW   X'23',F1,X'40',1         SET SECTOR ZERO          M5900  82500020
TICCW    EQU   *                        *                        S20201 82510020
         DC    X'08'                                             S20201 82520020
TICADD   DC    AL3(0)                                            S20201 82530020
         DC    F'0'                                              S20201 82540020
CCWORD1  EQU   *                  SEARCH/WRITE HOME ADDRESS             82560016
         DC    X'39'                                                    82640016
         DC    AL3(1)                                                   82720016
         DC    X'60000005'                                              82800016
CCWORD2  EQU   *                                                        82880016
         DC    X'08'                                                    82960016
         DC    AL3(CCWORD1-CCWORD1)                                     83040016
         DC    F'0'                                                     83120016
CCWORD3  EQU   *                  WRITE R0MAXIMUM LENGTH                83200016
         DC    X'15'                                                    83280016
         DC    AL3(0)                                                   83360016
         DC    X'60000000'                                              83440016
CCWORD4  EQU   *                  READ HOME ADDRESS                     83520016
         DC    X'1A'                                                    83600016
         DC    AL3(0)                                                   83680016
         DC    X'60000005'                                              83760016
CCWORD5  EQU   *                  READ R0                               83840016
         DC    X'16'                                                    83920016
         DC    AL3(0)                                                   84000016
         DC    X'70000008'                                              84080016
CCWORD6  EQU   *                  SEARCH HOME ADDRESS                   84160016
         DC    X'39'                                                    84240016
         DC    AL3(1)                                                   84320016
         DC    X'60000004'                                              84400016
CCWORD7  EQU   *                  TIC TO CC6CONS                        84480016
         DC    X'08'                                                    84560016
         DC    AL3(CCWORD6-CCWORD1)                                     84640016
         DC    F'0'                                                     84720016
CCWORD8  EQU   *                  WRITE R0 MAXIMUM LENGTH.              84800016
         DC    X'15'                                                    84880016
         DC    AL3(0)                                                   84960016
         DC    X'60000010'                                              85040016
CCWORD9 EQU    *                  READ HOME ADDRESS                     85120016
         DC    X'1A'                                                    85200016
         DC    AL3(0)                                                   85280016
         DC    X'40000005'                                              85360016
CCWORDA  EQU   *                  READ R0                               85440016
         DC    X'16'                                                    85520016
         DC    AL3(0)                                                   85600016
         DC    X'60000010'                                              85680016
CCWORDB  EQU   *                  SEARCH HOME ADDRESS.                  85760016
         DC    X'39'                                                    85840016
         DC    AL3(1)                                                   85920016
         DC    X'60000004'                                              86000016
CCWORDC  EQU   *                  TIC TO CCWCONS                        86080016
         DC    X'08'                                                    86160016
         DC    AL3(CCWORDB-CCWORD1)                                     86240016
         DC    F'0'                                                     86320016
CCWORDD  EQU   *                  WRITE STANDARD R0.                    86400016
         DC    X'15'                                                    86480016
         DC    AL3(0)                                                   86560016
         DC    X'40000010'                                              86640016
CCWORDE  EQU   *                  READ HOME ADDRESS                     86720016
         DC    X'1A'                                                    86800016
         DC    AL3(0)                                                   86880016
         DC    X'60000005'                                              86960016
CCWORDF  EQU   *                  READ R0 SKIP DATA TRANSFER.           87040016
         DC    X'16'                                                    87120016
         DC    AL3(0)                                                   87200016
         DC    X'10000010'                                              87280016
ZALTCCW  CCW   X'19',ZCCHH,X'20',5      CLEAR ASSIGNED ALT       A43248 87330002
         AIF   ('&LIB' EQ 'LIB1').X227301                        YM3475 87332003
BLANK    EQU   X'40'                    OFFLINE INDICATION.      YM3475 87334003
DELDEB   EQU   X'F8'                    DEB DELETE REQUEST.      YM3475 87336003
.X227301 ANOP                                                    YM3475 87338003
FUNCNAM1 DC    C'ANALYZE OF'                                            87338403
FUNCNAM2 DC    C'FORMAT OF '                                            87338803
SVCNUMBR DC    C'82,'                                                   87339203
ZCCHH    DC    X'0200000000'                                     M4682  87339903
ZEUSALT  DC    X'0000000000'                                     M4682  87346603
TRTABLE  DC    C'0123456789ABCDEF'                                      87348603
*                                                                       87350603
         EJECT                                                          87353303
         AIF   ('&LIB' EQ 'LIB1').OSDCB                                 87420000
DASDIDCB DCB   DSORG=PS,MACRF=(E),DEVD=DA,EOEA=P8,XENDA=P9,      M5431 F87440003
               SIOA=P7,PGFX=YES                                  M5431  87490000
         AGO   .C1                                                      87500000
.OSDCB   ANOP                                                           87510000
DASDIDCB DCB   DSORG=PS,MACRF=(E),DEVD=DA,EOEA=P8,XENDA=P9              87512003
.C1      ANOP                                                           87514000
PATCH    DS    0F                  PATCH AREA                  @ZA04403 87519050
         DC    200X'00'                                        @ZA04403 87519250
DCBCONST EQU   DASDIDCB                                                 87520016
         EJECT                                                          87970003
**********************************************************************  88000016
         IEHDBLKS                                                       88080016
DCELADDR EQU   FCCWS+88                                                 88120016
         EJECT                                                          88130003
*                                                                       88160016
**********************************************************************  88240016
*                                                                       88320016
         IEHDWORK                                                       88400016
WORK1    EQU   WORK                                                     88480016
         EJECT                                                          88530003
*                                                                       88560016
**********************************************************************  88640016
CVT      DSECT                                                          88720016
         CVT   SYS=MIN                                                  88800016
         EJECT                                                          88850003
*                                                                       88880016
**********************************************************************  88960016
UCB      DSECT                                                          89040016
         IEFUCBOB                                                       89120016
         EJECT                                                          89170003
*                                                                       89200016
**********************************************************************  89280016
JFCB     DSECT                                                          89360016
         IEFJFCBN                                                       89440016
         EJECT                                                          89490003
*                                                                       89520016
**********************************************************************  89600016
         DCBD  DSORG=PS                                                 89680016
         EJECT                                                          89730003
DCBCON   EQU   IHADCB                                                   89760016
         ORG   IHADCB+72                                                89840016
WKAECB   DS    F                  ECB                                   89920016
WKAIOB   DS    F                  IOB                                   90000016
ECBADD   DS    F                  ECB POINTER.                          90080016
CSWORD   DS    F                                                        90160016
         DS    F                                                        90240016
CCWPTR   DS    F                  CHANNEL PROGRAM POINTER.              90320016
DCBADD   DS    F                  DCB POINTER.                          90400016
         DS    F                                                        90480016
BLKERRCT DS    F                  BLOCK AND ERR RETRY COUNT.            90560016
SEEKADDR DS    2F                 SEEK ADDRESS.                         90640016
SEEKCCHH EQU   SEEKADDR+3               CCHH OF SEEK ARG.      @ZM42054 90690003
         DS    F                                                        90720016
CWCONST  DS    0D                                                       90800016
CCWSECON DS    D                                                 S20201 90820020
TICSEC   DS    D                                                 S20201 90840020
CCW1CONS DS    D                                                        90880016
CCW2CONS DS    D                                                        90960016
CCW3CONS DS    D                                                        91040016
CCW4CONS DS    D                                                        91120016
CCW5CONS DS    D                                                        91200016
CCW6CONS DS    D                                                        91280016
CCW7CONS DS    D                                                        91360016
CCW8CONS DS    D                                                        91440016
CCW9CONS DS    D                                                        91520016
CCWACONS DS    D                                                        91600016
CCWBCONS DS    D                                                        91680016
CCWCCONS DS    D                                                        91760016
CCWDCONS DS    D                                                        91840016
CCWECONS DS    D                                                        91920016
CCWFCONS DS    D                                                        92000016
         AIF   ('&LIB' EQ 'LIB1').X326401                        XM5465 92050003
CCWSHCON EQU   CCWSECON                SEARCH ON 3340.           XM5465 92060003
SDCCW1   DS    D                       READ ON 3340.             XM5465 92070003
SDCCW2   DS    D                       SENSE ON 3340.            XM5465 92072003
SDTIC    DS    D                       TIC TO FMT CCW            XM5465 92072403
SDSNS    DS    CL24                    READIN AREA FOR SENSE.    XM5465 92074003
         ORG   SDSNS+22                                          XM5465 92076003
SDBYTES  DS    CL2                     SKIP DISPLACEMENT BYTES.  XM5465 92078003
SDHA     DS    CL5                     3340 HOME ADDRESS.        XM5465 92078403
SDSHA    DS    D                       SHA EM. 333X            @Z30RSAG 92078503
SDTSHA   DS    D                       TIC EM. 333X            @Z30RSAG 92078603
SDWHA    DS    D                       WHA EM. 333X            @Z30RSAG 92078703
SDWR0    DS    D                       WR0 EM. 333X            @Z30RSAG 92094903
SDRHA    DS    D                       RHA EM. 333X            @Z30RSAG 92104903
SDRR0    DS    D                       RR0 EM. 333X            @Z30RSAG 92106903
MADSD    EQU   SDSNS+18                3350 SD BYTES           @VS40430 92107303
.X326401 ANOP                                                    XM5465 92111403
         EJECT                                                          92127603
*                                                                       92143803
**********************************************************************  92160016
WORKAREA DSECT                                                          92240016
RDAREA1  EQU   *                                                        92320016
         DS    CL188                                             JUDITH 92400020
UNASGBT  DS    CL1                      UNASSIGN RTNE SWT.     @Y30LSFY 92450003
         DS    CL3                      RESERVED               @Y30LSFY 92460003
SAVEAREA  DS    0F                                                      92480016
PL1WORD  DS    F                  THIS WORD IS USED BY PL/1.            92560016
OLDSAPTR DS    F                  POINTER TO PREVIOUS SAVE AREA.        92640016
NEWSAPTR DS    F                  POINTER TO NEXT SAVE AREA.            92720016
RETADREG DS    F                  (REG14)-RETURN ADDRESS REGISTER.      92800016
ENTRYPTR DS    F                  (REG15)-ENTRY POINT REGISTER.         92880016
REG0TO12 DS    13F                REGISTERS 0 THROUGH 12.               92960016
SAVEVTOC DS    8F                                                       93040016
TEMP     DS    F                                                 S20201 93042003
SAVCCHHR DS    F                                               @Y30LSFY 93050003
SAVCCWPT DS    F                                               @Y30LSFY 93060003
         DS    0D                                                JUDITH 93080020
PRGSAVE  DS    10F                                                      93120016
RTAVTOCS DS    F                                                        93200016
RTAVTOCE DS    F                                                        93280016
         ORG   *-16                                                     93360016
DDEB     DS    0F                 FAKE DEB FOR CONVERT ROUTINE.         93440016
         ORG   *+16                                                     93520016
DEXTNTNO DS    CL1                DUMMY EXTNT NUMBER.                   93600016
MBBCCHH1 DS    CL7                SAVE AREA FOR VTOC EXTENT.            93680016
MBBCCHH2 DS    CL8                                                      93760016
DUCBPTR  DS    F                  FAKE UCB POINTER.                     93840016
HALFWD   DS    H                  HALF WORD WORK SPACE.                 93920016
DEXTNTS  DS    HL4                DUMMY STARTING CCHH(000000)           94000016
DEXTNTE  DS    HL4                DUMMY ENDING CCHH.                    94080016
DEXTNTR  DS    H                  DUMMY NO TRACKS.                      94160016
WKBUFPTR DS    F                                                        94240016
WKBUFSI  DS    F                                                        94320016
PARMLST  DS    0F                                                       94400016
PARMUCB  DS    F                                                        94480016
PARMDCB  DS    F                                                        94560016
PARMCCHH EQU   PARMDCB                                                  94640016
PARMALTD DS    F                                                        94720016
PARMDEB  DS    F                                                        94760016
         AIF   ('&LIB' EQ 'LIB1').X228303                       XL03130 94768003
LASTPARM EQU   X'80'                    END OF PARAMETER LIST.  XL03130 94776003
PARMMOD  EQU   PARMDEB                  DEV MOD PTR.            XL03130 94784003
.X228303 ANOP                                                   XL03130 94792003
OPENLD   EQU   *                                                        94800016
         RDJFCB (,(INPUT)),MF=L                                         94880016
LIST     EQU   *                                                        94960016
         DC    X'87'              JFCB EXIT LIST CODE.                  95040016
         DC    AL3(0)                                                   95200016
WKAEND   DS    0D                                                       95240016
SIZE     EQU   WKAEND-RDAREA1                                           95280016
VOLSERL  EQU   RDAREA1+108                                       M3966  95360020
VVTOCPTR EQU   RDAREA1+119                                       M4683  95440020
*                                                                       95520016
**********************************************************************  95600016
*                                                                       95680016
BUFFCORE DSECT                                                          95760016
STNDR0   DS    CL16               LOCATION OF STANDARD R0 COUNT.        95840016
MAXLTHR0 DS    CL16               LOCATION OF MAXIMUM LENGTH R0 COUNT   95920016
MAXR0BIT DS    CL16               LOCATION R0 COUNT AND BIT PATTERN.    96000016
         DC    AL3(0)             JFCB READ IN AREA.                    96080016
BITBUFF  EQU   MAXR0BIT+8                                               96160016
WORKBUFF EQU   BITBUFF-STNDR0                                           96240016
         END                                                            96320016
./  ADD  SSI=70880130,NAME=IEHDAOUT
         COPY  LCGASMSW                                          SM4351 00200021
IEHDAOUT CSECT                                                          00250021
*1240484000                                                        3605 00400018
*056000-058000,141200,194000-200000,240000,550000,560000           O122 00500019
*482000,483000                                                  A38484  00520020
*3434                                                            M4970  00550020
*STATUS CHANGE LEVEL 004                                                00650020
*                                                                     * 01000016
*FUNCTION/OPERATION- THIS ROUTINE HANDLES THE DUMP TO A SYSTEM        * 01200016
*   OUTPUT DEVICE FOR THE IEHDDUMP PORTION OF THE IEHDASDR SYSTEM     * 01400016
*   UTILITY PROGRAM. HEADER INFORMATION (TRACK ADDRESS, THE DATA      * 01600016
*   FIELD FOR RECORD ZERO, THE COUNT FIELD) WILL BE FORMATED AND      * 01800016
*   WRITTEN OUT. THE SIZE OF THE INDIVIDUAL RECORD IS COMPUTED        * 02000016
*   AND THEN DIVIDED BY THIRTY-TWO TO OBTAIN THE NUMBER               * 02200016
*   OF COMPLETE (32-BYTE) LINES, AND THE NUMBER OF BYTES IN THE       * 02400016
*   INCOMPLETE LINE IF ANY. AN EBCDIC AND GRAPHIC TRANSLATION IS      * 02600016
*   PERFORMED TO ALLOW THE USER TO EASILY LOCATE VARIOUS FIELDS       * 02800016
*   IN THE OUTPUT DATASET. ONLY THE FIRST AND LAST LINES OF           * 03000016
*   IDENTICAL RECORD DATA WILL BE PLACED IN THE OUTPUT DATASET,       * 03200016
*   SEPARATED BY THIS MESSAGE-                                        * 03400016
*              ' LINE(S) SAME AS ABOVE '                              * 03600016
*                                                                     * 03800016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDAOUT-, AND CONTROL IS     * 04000016
*   ALWAYS RECEIVED FROM THE -IEHDEXCP- ROUTINE.                      * 04200016
*                                                                     * 04400016
*INPUT- REGISTER 1 WILL POINT TO THE CURRENT TRACK ADDRESS(CCHH).     * 04500016
*       REGISTER 2 WILL CONTAIN THE ENTRY POINT FOR -IEHDPRNT-.       * 04600016
*       REGISTER 3 WILL CONTAIN A POINTER TO THE END OF THE DATA      * 04700016
*       IN THE DATA BUFFER.                                           * 04800016
*       REGISTER 10 WILL CONTAIN A POINTER TO THE CONTROL BLOCK.      * 05000016
*       REGISTER 12 WILL CONTAIN A POINTER TO THE WORK AREA.          * 05200016
*       AOUTSW (IN IEHDBLKS) WILL DESCRIBE THE REQUIRED FORMATTING O122 05220019
*              X'00' - FORMAT TRACK ADDRESS, R0 DATA AND RECORDS   O122 05240019
*              X'01' - FORMAT RECORDS ONLY                         O122 05260019
*              X'02' - DO NOT FORMAT                               O122 05280019
*       TRACKPT (IN IEHDBLKS) WILL CONTAIN A POINTER TO THE        O122 05300019
*              BEGINNING OF THE DATA                               O122 05320019
*                                                                     * 05400016
*EXITS-NORMAL- UPON COMPLETION, CONTROL IS RETURNED TO IEHDEXCP OR O122 05600019
*   IEHDRCVR.  NO RETURN CODE IS PASSED.                           O122 05800019
*                                                                     * 06000016
*EXITS-ERROR- NONE.                                                   * 06200016
*                                                                     * 06300016
*EXTERNAL ROUTINES- THE CONVERTED TRACK DATA WILL BE PLACED IN        * 06400016
*   THE OUTPUT BUFFER AND THEN WRITTEN OUT BY THE MESSAGE             * 06600016
*   WRITER ROUTINE(IEHDPRNT).                                         * 06800016
*                                                                     * 07000016
*TABLES/WORK AREAS- UPON ENTRY, REGISTERS 10 AND 12 POINT TO A        * 07200016
*   FUNCTION BLOCK AND WORK AREA RESPECTIVELY. THEY ARE DESCRIBED     * 07400016
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 07600016
*                                                                     * 07800016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE, NON-PRIVILEGED.          * 07900016
 TITLE 'IEHDAOUT-DUMP TO SYSTEM OUTPUT DEVICE FOR IEHDASDR UTILITY'     08200016
*  THE FOLLOWING ARE REGISTER ASSIGNMENTS.                              08400016
GR0      EQU   0                                                        08600016
GR1      EQU   1                                                        08800016
DATAPTR  EQU   2                       POINTER TO DATA IN DATA BUFFER.  09000016
SUMTOTAL EQU   3                       TOTAL LENGTH OF DATA.            09200016
GR4      EQU   4                                                        09400016
GR5      EQU   5                                                        09600016
GR6      EQU   6                                                        09800016
GR7      EQU   7                                                        10000016
GR8      EQU   8                                                        10200016
GR9      EQU   9                                                        10400016
GR10     EQU   10                                                       10600016
GR11     EQU   11                                                       10800016
GR12     EQU   12                                                       11000016
GR13     EQU   13                                                       11200016
GR14     EQU   14                                                       11400016
GR15     EQU   15                                                       11600016
*                                                                       11800016
         SPACE                                                          12000016
         USING FUNCBLK,10                                               12200016
         USING IEHDAOUT,11                                              12400016
         USING WORK,12                                                  12600016
         SPACE                                                          12800016
         SAVE  (14,12),T               SAVE THE REGISTERS.              13000016
         LR    GR11,GR15               LOAD THE BASE REGISTER.          13200016
         LA    GR7,OUTSAVE             SAVE AREA ADDRESS.               13400016
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      13600016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      13800016
         LR    GR13,GR7                SAVE AREA FOR CALLED ROUTINES.   14000016
         LR    GR15,DATAPTR            ENTRY PT. FOR PRNT TO LINK REG.  14060016
         L     DATAPTR,TRACKPT         POINTER TO DATA             O122 14070019
         LA    DATAPTR,0(DATAPTR)      CLEAR HIGH ORDER BYTE       O122 14080019
         LA    SUMTOTAL,0(SUMTOTAL)    CLEAR HIGH ORDER BYTE       O122 14090019
         MVI   1(SUMTOTAL),X'FF'       FLAG END OF BUFFER        A53156 14092000
         CLI   AOUTSW,FMTCNT           FORMAT COUNTS ONLY          O122 14100019
         BE    COUNTS                  YES                         O122 14110019
         BL    TRACKIN                 NO, FORMAT ENTIRE TRACK     O122 14120019
*        DO NOT FORMAT DATA  (USED WHEN IEHDRCVR PRINTS THE        O122 14130019
*        REMAINDER OF TRACK AS ONE RECORD)                         O122 14140019
         LR    GR7,SUMTOTAL            END OF DATA IN BUFFER       O122 14150019
         SR    GR7,DATAPTR             LENGTH OF DATA TO BE PRINTEDO122 14160019
         B     PRTRCORD                PRINT THE RECORD            O122 14170019
         EJECT                                                          14200016
*********************************************************************** 14400016
*                                                                     * 14600016
*        MOVE IN 'TRACK',R0 DATA', AND 'COUNT' KEYWORDS               * 14800016
*        WITH ASSOCIATED TRACK INFORMATION. COMPUTE THE NUMBER        * 15000016
*        OF COMPLETE LINES IF ANY, AND THE LENGTH OF THE              * 15200016
*        POSSIBLE INCOMPLETE LINE.                                    * 15400016
*                                                                     * 15600016
*********************************************************************** 15800016
         SPACE                                                          16000016
TRACKIN  BAL   GR9,OUTPUT              SPACE A LINE.                    16400016
         MVC   MESS(10),TRACKKEY       MOVE IN 'TRACK' KEYWORD.         16800016
         UNPK  MESS+12(9),0(5,GR1)     TRACK ADDR(CCHH) TO OUTPUT BUFF. 17200016
         MVI   MESS+20,C' '            CLEAR TRASH FROM UNPACK.         17500016
         TR    MESS+12(8),IOTAB-240    GRAPHIC TRACK ADDRESS.           17800016
         MVC   MESS+26(7),R0DATA       MOVE IN 'R0 DATA' KEYWORD.       18000016
         UNPK  MESS+35(9),0(5,DATAPTR)   UNPACK ACTUAL R0 DATA          18200016
         UNPK  MESS+43(9),4(5,DATAPTR)         TO OUTPUT BUFFER.        18400016
         MVI   MESS+51,C' '            CLEAR TRASH FROM UNPACK.         18600016
         TR    MESS+35(16),IOTAB-240                                    18800016
         LA    DATAPTR,8(DATAPTR)      POINT TO R1 COUNT FIELD.         19000016
         BAL   GR9,OUTPUT              PRINT A LINE.                    19200016
         BAL   GR9,OUTPUT              SPACE A LINE.                    19300016
COUNTS   CR    DATAPTR,SUMTOTAL        COMPLETED PRINTING.         O122 19500019
         BNL   RETURN                  YES--RETURN.                O122 19700019
COUNTIN  MVC   MESS+5(5),COUNTKEY      MOVE IN 'COUNT'KEYWORD.     O122 19900019
         UNPK  MESS+12(9),0(5,DATAPTR)   UNPACK COUNT FOR               20200016
         UNPK  MESS+20(9),4(5,DATAPTR)     PRINT OUT.                   20400016
         MVI   MESS+28,C' '            CLEAR TRASH FROM UNPACK.         20600016
         TR    MESS+12(16),IOTAB-240   GRAPHIC COUNT.                   20800016
         BAL   GR9,OUTPUT              PRINT A LINE.                    21000016
         BAL   GR9,OUTPUT              SPACE A LINE.                    21100016
         EJECT                                                          21200016
         SR    GR7,GR7                 CLEAR WORK REGISTER.             21400016
         IC    GR7,5(DATAPTR)          KEY LENGTH.                      21600016
         AH    GR7,6(DATAPTR)          PLUS DATA LENGTH.                21800016
         LA    DATAPTR,8(DATAPTR)      POINT TO R1 DATA FIELD.          22000016
PRTRCORD MVC   LOCCTR(4),ZERO          CLEAR LOCATION COUNTER.     O122 22100019
         SR    GR6,GR6                 CLEAR WORK REGISTER.             22200016
         D     GR6,THIRTY2             HOW MANY COMPLETE LINES.         22400016
         STH   GR6,INCOMPLT            SAVE LENGTH OF INCOMPL LINE.     22600016
         LTR   GR7,GR7                 ANY COMPLETE LINES.              22800016
         BP    FORMAT04                YES--GO TO PROCESS.              23000016
COUNTIN1 LH    GR7,INCOMPLT            LENGTH OF POSSIBLE INCOMPL LINE. 23200016
         LTR   GR7,GR7                 SIZE OF INCOMPLETE LINE=0.       23400016
         BP    FORMAT08                NO--GO TO PROCESS.               23600016
COUNTIN2 CR    DATAPTR,SUMTOTAL        END OF DATA THIS TRACK.          23800016
         BNL   RETURN                  YES--RETURN.                O122 23900019
         BAL   GR9,OUTPUT              SPACE A LINE.                    24100016
         ST    DATAPTR,SAVESLOT        STORE TO SEE IF DOUBLE WORD.     24200016
         TM    SAVESLOT+3,X'07'        IS PTR ON DOUBLE WORD BOUNDARY   24400016
         BC    8,COUNTIN               YES--GO TO PROCESS NXT RECORD.   24600016
         NI    SAVESLOT+3,X'F8'        NO--FORCE TO DOUBLE WORD.        24800016
         L     DATAPTR,SAVESLOT        POINTER BACK INTO REGISTER.      25000016
         LA    DATAPTR,8(DATAPTR)      ADD 8 AFTER FORCING DOUBLE.      25200016
         B     COUNTIN                 GO PROCESS NEXT RECORD.          25400016
         EJECT                                                          25600016
*********************************************************************** 25800016
*                                                                     * 26000016
*   PROCESS COMPLETE LINES HERE.                                      * 26200016
*                                                                     * 26400016
*        GR7 HAS NUMBER OF COMPLETE LINES FOR LOOP CONTROL.           * 26600016
*                                                                     * 26800016
*********************************************************************** 27000016
         SPACE                                                          27200016
FORMAT04 L     GR6,FORM5FPT            COMPARE BUFFER ADDRESS.          27400016
         L     GR5,THIRTY2             LENGTH FOR EXEC.                 27600016
         BCTR  GR5,0                   DECREMENT FOR EXEC.              27800016
         EX    GR5,MOVE                DATA TO COMPARE BUFFER.          28000016
         MVI   SAMESW,0                SET SWITCH OFF.                  28200016
         USING PRNTAREA,4                                               28400016
FORMAT05 LA    GR4,MESS                ADDRESS OF OUTPUT BUFFER.        28600016
         L     GR5,THIRTY2             LENGTH FOR EXEC.                 28800016
         BAL   GR9,GRAPHIC             CREATE ENGLISH TRANSLATION.      29200016
FORMAT06 CLI   0(GR8),X'FF'            IS THIS A DELIMITER.             29600016
         BC    8,FORMAT07              YES--LINE IS COMPLETE.           29800016
         SR    GR0,GR0                 CLEAR WORK REGISTER.             30000016
         IC    GR0,0(GR8)              GR0=DISPL FROM BEG. OF LINE.     30200016
         SR    GR5,GR5                 CLEAR WORK REGISTER.             30400016
         IC    GR5,1(GR8)              GR5=SIZE OF FIELD-1.             30600016
         AR    GR4,GR0                 ADDRESS OF FIELD W/IN A LINE.    30800016
         EX    GR5,MOVE1               MOVE FIELD TO WORK AREA.         31000016
         UNPK  DAWORK(9),DAWORK(5)                                      31200016
         TR    DAWORK(8),IOTAB-240                                      31400016
         LA    GR5,1(GR5,GR5)          GR5=SIZE OF UNPACKED FIELD.      31600016
         EX    GR5,MOVE2               MOVE UNPACKED FIELD TO BUFFER.   31800016
         LA    GR8,2(GR8)              BUMP LAYOUT FIELD PTR.           32000016
         LA    DATAPTR,4(DATAPTR)      BUMP DATA FIELD POINTER.         32200016
         B     FORMAT06                CONTINUE PROCESSING THIS LINE.   32400016
         SPACE                                                          32600016
         EJECT                                                          32800016
*********************************************************************** 33000016
*                                                                     * 33200016
*        CHECK FOR IDENTICAL LINES HERE.                              * 33400016
*                                                                     * 33600016
*********************************************************************** 33800016
         SPACE                                                          34000016
FORMAT07 BAL   GR9,OUTPUT              PRINT A LINE.                    34200016
COMPARE  L     GR5,LOCCTR              LOCATION COUNTER.                34400016
         A     GR5,THIRTY2             INCREMENT AND                    34600016
         ST    GR5,LOCCTR              STORE FOR FUTURE USE.            34800016
         CLI   SAMESW,X'F0'            LAST ENTRY.                      35000016
         BE    COUNTIN1                YES--GO TO SEE IF END OF DATA.   35200016
         L     GR6,FORM5FPT            COMPARE BUFFER ADDRESS.          35400016
         CLC   0(32,GR6),0(DATAPTR)    TWO LINES ALIKE.                 35600016
         BE    SAMELINE                YES--GO TO HANDLE.               35800016
         BCT   GR7,FORMAT04            PROCESS NEXT LINE IF ANY MORE.   36000016
         CLI   SAMESW,X'FF'            LAST LINE PRINTED A MSG.         36200016
         BNE   COUNTIN1                NO--GO SEE IF DONE WITH TRACK.   36400016
COMPARE1 MVI   SAMESW,X'F0'            SET LAST ENTRY SWITCH.           36500016
         S     GR5,THIRTY2             DECREMENT AND                    36530016
         ST    GR5,LOCCTR              STORE LOCATION COUNTER.          36560016
COMPARE2 S     DATAPTR,THIRTY2         DECREMENT DATA PTR.              36600016
         B     FORMAT05                GO TO PROCESS THIS LINE.         37000016
SAMELINE BCTR  GR7,0                   DECREMENT LINE COUNTER.          37080016
         LTR   GR7,GR7                 SEE IF LAST LINE.                37160016
         BZ    COMPARE1                YES--GO TO PROCESS AND PRINT IT. 37240016
         A     DATAPTR,THIRTY2         NO---BUMP DATA PTR.              37320016
         CLI   SAMESW,X'FF'            SAME MSG ALREADY WRITTEN.        37400016
         BE    COMPARE                 YES--NO MESSAGE THIS TIME.       37600016
         CLC   0(32,GR6),0(DATAPTR)    3 LINES IN A ROW ALIKE.          37660016
         BNE   COMPARE2                NO--GO PRINT THE LINE.           37730016
         MVI   SAMESW,X'FF'            SET SWITCH TO INDIC. MSG OUT.    37800016
         MVC   MESS+10(21),SAME        SET UP MESSAGE.                  38000016
         B     FORMAT07                GO TO WRITE THE MESSAGE.         38200016
         EJECT                                                          38400016
*********************************************************************** 38600016
*                                                                     * 38800016
*        HANDLE INCOMPLETE LINE HERE.                                 * 39000016
*                                                                     * 39200016
*********************************************************************** 39400016
         SPACE                                                          39600016
         USING PRNTAREA,4                                               39800016
FORMAT08 LA    GR4,MESS                ADDRESS OF OUTPUT BUFFER.        40000016
         LR    GR5,GR7                 LENGTH FOR EXEC.                 40200016
         BAL   GR9,GRAPHIC             GO TO TRANSLATE TO GRAPHIC.      40400016
FORMAT09 SR    GR0,GR0                 CLEAR WORK REGISTER.             40600016
         IC    GR0,0(GR8)              GR0=DISPL. FROM BEG. OF LINE.    40800016
         SR    GR5,GR5                 CLEAR WORK REGISTER.             41000016
         IC    GR5,1(GR8)              GR5=SIZE OF FIELD-1.             41200016
         AR    GR4,GR0                 ADDRESS OF FIELD WITHIN A LINE.  41400016
         LA    GR5,1(GR5)              TOTAL SIZE OF FIELD              41600016
         CR    GR7,GR5                 INCOMPLETE LINE LESS THAN 4.     41800016
         BH    FORMAT10                NO--CONTINUE.                    42000016
         LR    GR5,GR7                 LENGTH OF REMAINING DATA.        42200016
         SR    GR7,GR7                 CLEAR REGISTER.                  42400016
         B     FORMAT11                GO TO PROCESS.                   42600016
FORMAT10 SR    GR7,GR5                 DECREMENT LENGTH.                42800016
FORMAT11 BCTR  GR5,0                   DECREMENT FOR EXEC.              43100016
         EX    GR5,MOVE1               MOVE FIELD TO WORK AREA.         43400016
         AR    DATAPTR,GR5             INCREMENT                        43460016
         LA    DATAPTR,1(DATAPTR)        DATA POINTER.                  43520016
         UNPK  DAWORK(9),DAWORK(5)     PREP. FOR CHANGE TO GRAPHIC.     43600016
         TR    DAWORK(8),IOTAB-240                                      43800016
         LA    GR5,1(GR5,GR5)          GR5=SIZE OF UNPACKED FIELD.      44000016
         EX    GR5,MOVE2               MOVE UNPACKED FIELD TO BUFFER.   44200016
         LA    GR8,2(GR8)              INCREMENT LAYOUT FIELD PTR.      44400016
         LTR   GR7,GR7                 END OF INCOMPLETE LINE.          44600016
         BP    FORMAT09                NO--CONTINUE PROCESSING.         44800016
         BAL   GR9,OUTPUT              PRINT A LINE.                    45000016
         B     COUNTIN2                GO SEE IF MORE RECS. THIS TRK.   45200016
         EJECT                                                          45400016
*********************************************************************** 45600016
*                                                                     * 45800016
*        CONVERT DATA TO GRAPHICS,OR PRINTABLE ENGLISH.               * 46000016
*                                                                     * 46200016
*********************************************************************** 46400016
         SPACE                                                          46600016
         USING PRNTAREA,4                                               46800016
GRAPHIC  MVI   DELIMITA,C'*'           DELIMIT THE GRAPHIC              47000016
         MVI   DELIMITB,C'*'             FIELD IN THE OUTPUT BUFFER.    47200016
         LA    GR6,COREBLK             SET FOR EXEC.                    47400016
         BCTR  GR5,0                   DECREMENT FOR EXEC.              47600016
         EX    GR5,MOVE                STORAGE BLK TO PRINT AREA.       47800016
         LA    GR5,1(GR5)              INCREMENT LOOP CONTROL.          48000016
LOOP     CLI   0(GR6),X'C1'             CHAR MORE THAN C0       A38484  48200020
         BNL   CHECK                    YES - CHECK                     48400020
         CLI   0(GR6),C' '             IS CHAR BLANK.                   48600016
         BE    EXITOK                  YES--NO MODIFY.                  48800016
DOT      EQU   *                                                   3605 48900018
         MVI   0(GR6),C'.'             UNPRINTABLE CHAR.                49000016
EXITOK   LA    GR6,1(GR6)              INCREMENT BUFFER POINTER.        49200016
         BCT   GR5,LOOP                LOOP THRU TO END.                49400016
         LA    GR8,COREBLK+32          END OF GRAPHIC AREA.             49600016
LOOP1    CR    GR8,GR6                 A COMPLETE LINE.                 50200016
         BC    8,LOOP2                 YES--GO TO TRANSLATE.            50400016
         MVI   0(GR6),C'.'             NO--MOVE IN '.'                  50600016
         LA    GR6,1(GR6)              INCREMENT POINTER.               50800016
         B     LOOP1                   GO CHECK IF LINE COMPLETE.       51000016
LOOP2    MVC   DAWORK(3),LOCCTR+1      LOCATION CTR TO WORK AREA.       51300016
         UNPK  DAWORK(7),DAWORK(4)     UNPACK AND                       51600016
         TR    DAWORK(6),IOTAB-240       TRANSLATE TO GRAPHIC.          51800016
         MVC   CNTAREA(6),DAWORK       MOVE LOCATION CTR. TO BUFFER.    52000016
         LA    GR8,LAYOUT              LAYOUT LINE.                     52200016
         BR    GR9                     RETURN TO CALLER.                52400016
CHECK    EQU   *                                                   3605 52410018
         CLI   0(GR6),C'I'             IS IT A THRU I.             3605 52420018
         BNH   EXITOK                  YES-OKAY.                   3605 52430018
         CLI   0(GR6),C'J'             IS IT A J OR ABOVE.         3605 52440018
         BL    DOT                     NO-NONPRINTABLE CHARACTER.  3605 52450018
         CLI   0(GR6),C'R'             IS IT J THRU R.             3605 52460018
         BNH   EXITOK                  YES-OKAY.                   3605 52470018
         CLI   0(GR6),C'S'             IS IT AN S OR ABOVE.        3605 52480018
         BL    DOT                     NO-NONPRINTABLE CHARACTER.  3605 52490018
         CLI   0(GR6),C'Z'             IS IT AN S THRU Z.          3605 52500018
         BNH   EXITOK                  YES-OKAY.                   3605 52510018
         CLI   0(GR6),C'0'             IS IT GREATER THAN ZERO.    3605 52520018
         BL    DOT                     NO-NONPRINTABLE CHARACTER.  3605 52530018
         CLI   0(GR6),C'9'             IS IT 0 THRU 9.             3605 52540018
         BNH   EXITOK                  YES-OKAY.                   3605 52550018
         B     DOT                     NO-NONPRINTABLE CHARACTER.  3605 52560018
         EJECT                                                          52600016
*********************************************************************** 52800016
*                                                                     * 53000016
*       PRINT A LINE IN THE OUTPUT DATASET.                           * 53200016
*                                                                     * 53400016
*********************************************************************** 53600016
         SPACE                                                          53800016
OUTPUT   BALR  GR14,GR15               BRANCH TO -IEHDPRNT-.            54000016
         BR    GR9                     RETURN TO CALLER                 54200016
         SPACE                                                          54400016
*********************************************************************** 54600016
*                                                                     * 54800016
*        RETURN TO IEHDEXCP OR IEHDRCVR HERE.                      O122 55000019
*                                                                     * 55200016
*********************************************************************** 55400016
         SPACE                                                          55600016
RETURN   L     GR13,OUTSAVE+4          RESTORE REGISTER 13.             55800016
         RETURN (14,12),T              RETURN                      O122 56000019
         SPACE                                                          56200016
         SPACE                                                          56400016
MOVE     MVC   0(1,GR6),0(DATAPTR)       STORAGE BLK TO PRINT AREA.     56600016
         SPACE                                                          56800016
MOVE1    MVC   DAWORK(1),0(DATAPTR)      DATA TO WORK AREA.             57000016
         SPACE                                                          57200016
MOVE2    MVC   0(1,GR4),DAWORK         UNPKED DATA TO PRINT BUFFER.     57400016
         EJECT                                                          57600016
*                                                                       57800016
*        CONSTANTS USED BY THIS ROUTINE.                                58000016
*                                                                       58200016
         SPACE                                                          58400016
         DC    C'MAINTENANCE AREA'                                      58450002
MAINT    DS    50F                      MAINT AREA FOR ZAPS     XL02912 58500002
DAWORK   DS    3F                                                       58600016
OUTSAVE  DS    18F                     SAVE AREA.                       58800016
SAVESLOT DS    1F                                                       59000016
INCOMPLT DS    1H                                                       59200016
LOCCTR   DS    1F                                                       59400016
ZERO     DC    F'0'                                                     59600016
THIRTY2  DC    F'32'                                                    59800016
TRACKKEY DC    C'**** TRACK'                                            60000016
R0DATA   DC    C'R0 DATA'                                               60200016
COUNTKEY DC    C'COUNT'                                                 60400016
SAMESW   DC    XL1'00'                                                  60600016
         DS    0F                                                       60800016
         SPACE                                                          62000016
IOTAB    DC    C'0123456789ABCDEF'                                      62200016
         SPACE                                                          62400016
SAME     DC    C'LINE(S) SAME AS ABOVE'                                 62600016
         SPACE                                                          62800016
LAYOUT   DC    X'0903'                                                  63000016
         DC    X'0903'                                                  63200016
         DC    X'0903'                                                  63400016
         DC    X'0903'                                                  63600016
         DC    X'0D03'                                                  63800016
         DC    X'0903'                                                  64000016
         DC    X'0903'                                                  64200016
         DC    X'0903'                                                  64400016
         DC    X'FF'                                                    64600016
         SPACE                                                          64800016
*                                                                       65000016
*   DSECTS USED BY THIS ROUTINE.                                        65200016
*                                                                       65400016
PRNTAREA DSECT                                                          65600016
CNTAREA  DS    CL6                     LOCATION COUNTER.                65800016
BLANKA   DS    CL3                                                      66000016
EBCBLK   DS    CL74                                                     66200016
BLANKB   DS    CL3                                                      66400016
DELIMITA DS    CL1                                                      66600016
COREBLK  DS    CL32                                                     66800016
DELIMITB DS    CL1                                                      67000016
         EJECT                                                          67200016
         IEHDWORK                                                       67400016
         EJECT                                                          67600016
         IEHDBLKS                                                       67800016
         END                                                            68000016
./  ADD  SSI=70880132,NAME=IEHDASDR
         COPY  LCGASMSW                                          SM4351 00350021
IEHDASDR CSECT                                                          00400021
*                                                                     * 00600016
*0000   RE-ASSEMBLE FOR CHANGE TO IEHDWORK                     @ZA01201 00610002
*        RELEASE 23 DELETIONS                                         * 00620020
*        RELEASE 22 DELETIONS                                         * 00640020
*        RELEASE 21 DELETIONS                                         * 00660020
*        RELEASE 20 DELETIONS                                         * 00680020
*1418591000,825000                                               A32161 00700020
*1418562000,589000,590000-591000,887000                          M2680  00720020
*1418887000                                                      M2683  00750020
*1418887000                                                      S20201 00800020
*STATUS CHANGE LEVEL 003                                                00900020
*                                                                     * 01200016
*FUNCTION/OPERATION- THE ENTRY POINT FOR THE IEHDASDR SYSTEM UTILITY  * 01500016
*   PROGRAM IS THIS ROUTINE. CONTROL IS RECEIVED VIA A LINK OR        * 01800016
*   AN ATTACH MACRO ISSUED BY THE CALLING ROUTINE. -IEHDASDR- WILL    * 02100016
*   DO A GETMAIN FOR THE WORK AREA WHICH IS THEN ZEROED OUT,          * 02400016
*   PROCESSES ALL PARAMETERS POINTED TO BY REGISTER 1 (LINECNT,N,     * 02700016
*   INPUT FOR INVOCATION), AND THEN VIA THE XCTL MACRO, WILL PASS     * 03000016
*   CONTROL TO THE -IEHDASDS- ROUTINE.                                * 03300016
*                                                                     * 03600016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDASDR-.                    * 03900016
*                                                                     * 04200016
*INPUT- REGISTER ONE WILL POINT TO A THREE WORD PARAMETER LIST        * 04500016
*   CONSTRUCTED AS FOLLOWS-                                           * 04800016
*                                                                     * 05100016
*                  **************************                         * 05400016
*                  * PTR TO PARM FIELD INFO *                         * 05700016
*                  *     (IF SUPPLIED)      *                         * 06000016
*                  **************************                         * 06300016
*                  * PTR TO INVOCATION      *                         * 06600016
*                  *     PARAMETERS         *                         * 06900016
*                  **************************                         * 07200016
*                  * PTR TO INVOCATION      *                         * 07500016
*                  *     PARAMETERS         *                         * 07800016
*                  **************************                         * 08100016
*                                                                     * 08400016
*EXTIS-NORMAL- CONTROL IS PASSED TO THE -IEHDASDS- ROUTINE VIA THE    * 08700016
*   XCTL MACRO.                                                       * 09000016
*                                                                     * 09300016
*EXITS-ERROR- CONTROL WILL BE RETURNED TO THE CALLINE ROUTINE WITH    * 09600016
*   A RETURN CODE OF 16 FOR ANY ERROR DETECTED IN THE PASSED          * 09900016
*   PARAMETERS.                                                       * 10200016
*                                                                     * 10500016
*EXTERNAL ROUTINES- NONE.                                             * 10800016
*                                                                     * 11100016
*TABLES/WORK AREAS- THIS ROUTINE DOES A GETMAIN FOR THE WORK AREA,    * 11400016
*   DESCRIBED BY THE DSECT -WORK-.                                    * 11700016
*                                                                     * 12000016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE.                          * 12300016
*                                                                     * 12600016
 TITLE   'IEHDASDR --- INVOCATION AND PARM INFO HANDLER'                12900016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             13200016
GR0      EQU   0                                                        13500016
GR1      EQU   1                                                        13800016
GR2      EQU   2                                                        14100016
GR3      EQU   3                                                        14400016
GR4      EQU   4                                                        14700016
GR5      EQU   5                                                        15000016
GR6      EQU   6                                                        15300016
GR7      EQU   7                                                        15600016
GR8      EQU   8                                                        15900016
GR9      EQU   9                                                        16200016
GR10     EQU   10                                                       16500016
GR11     EQU   11                                                       16800016
GR12     EQU   12                                                       17100016
GR13     EQU   13                                                       17400016
GR14     EQU   14                                                       17700016
GR15     EQU   15                                                       18000016
ROOTBASE EQU   11                                                       18300016
WORKBASE EQU   12                                                       18600016
M39      EQU   39                      MESSAGE 839.              A32161 18630020
M47      EQU   47                      MESSAGE 847.              A32161 18660020
C16      EQU   16                      RETURN CODE.              A32161 18690020
K1       EQU   1                       DISPLACEMENT CONSTANT     A32161 18720020
K2       EQU   2                       DISPLACEMENT CONSTANT     A32161 18750020
K6       EQU   6                       DISPLACEMENT CONSTANT     A32161 18780020
NUM      EQU   X'F0'                   DDEGITAL TEST VALUE.      A32161 18810020
         SPACE 1                                                        18900016
DELIM    EQU   X'7E'                   PARM FIELD DELIMITER TEST.       19200016
         SPACE 1                                                        19500016
         USING WORK,12                 SET UP BASE FOR WORK AREA        19800016
         USING IEHROOT,ROOTBASE                                         20100016
         SPACE                                                          20400016
IEHROOT  SAVE  (14,12),T               SAVE THE REGISTERS.              20700016
         LR    ROOTBASE,GR15           LOAD THE BASE REGISTER.          21000016
         LR    GR7,GR1                 SAVE PASSED POINTER, IF ANY.     21300016
         SPACE 3                                                        21600016
*   OBTAIN CORE FOR AND ZERO OUT WORKAREA.                              21900016
         SPACE 1                                                        22200016
GETCORE  GETMAIN R,LV=0+WORKSIZE                                        22500016
         SPACE 1                                                        22800016
         LR    WORKBASE,GR1            SAVE ADDRESS OF WORKAREA.        23100016
         LA    GR3,WORKSIZE            LENGTH OF WORKAREA.              23400016
         BAL   GR14,CLEAR              CLEAR WORKAREA TO ZERO.          23700016
         EJECT                                                          24000016
*   SET DEFAULT OPTIONS HERE.                                           24300016
*   THESE OPTIONS WILL BE CHANGED BY PARM FIELD INFO, IF SUPPLIED.      24600016
         MVI   PAGENO+1,1              DEFAULT IS PAGE ONE.             24900016
         MVI   LINECNT+1,58            FIXED LINE COUNT.                25200016
         MVI   LINECNT1+1,58           CURRENT LINE COUNT.              25500016
         LA    GR4,ENDCLIST-CSIZE      END OF QUEUE POINTER.            25800016
         ST    GR4,ENDCLIST            SET UP END OF QUEUE POINTER.     26100016
         MVC   SYSINDD(8),CONSYSIN     DEFAULT DDNAME TO WORK AREA.     26400016
         MVC   SYSOUTDD(8),CONSPRIN    DEFAULT DDNAME TO WORK AREA.     26700016
         SPACE 1                                                        27000016
* THIS ROUTINE CHECKS THE PARAMETER LISTS PASSED WHEN THE PROGRAM IS    27300016
*  INVOKED.  REGISTER 1 POINTS TO A THREE FULL WORD AREA IN CORE WHICH  27600016
*  CONTAINS ADDRESSES OF THE THREE POSSIBLE PARAMETER LISTS.  THE HIGH  27900016
*  ORDER BYTE OF EACH OF THE FULL WORDS MUST BE EITHER HEX 00 OR HEX 80 28200016
*  THE 80 SIGNIFIES THAT THIS IS THE LAST PARAMETER LIST POINTER.  THE  28500016
*  FIRST POINTER IS TO THE LIST THAT EQUALS THE PARM VALUES FOUND ON    28800016
*  THE EXECUTE CARD. TWO PARM VALUES ARE POSSIBLE, A LINE COUNT         29100016
*  PARAMETER AND A POWER FACTOR WHICH CONTROLS THE NUMBER OF            29400016
*  FUNCTIONS WHICH CAN BE EXECUTING CONCURRENTLY.                       29700016
*  THE SECOND POINTER IS TO THE DDNAME LIST WHICH MUST                  30000016
*  BEGIN ON A HALF WORD BOUNDARY THAT IS ALSO NOT A FULL WORD           30300016
*  BOUNDARY.  THE TWO HIGH ORDER BYTES CONTAIN A COUNT OF THE NUMBER    30600016
*  OF BYTES IN THE REMAINDER OF THE LIST.  ALL ENTRIES IN THE LIST HAVE 30900016
*  A MAXIMUM LENGTH OF EIGHT BYTES AND ARE LEFT-JUSTIFIED AND PADDED    31200016
*  WITH BLANKS.  IF A NAME IS OMITTED WITHIN THE LIST, THE EIGHT-BYTE   31500016
*  ENTRY MUST CONTAIN BINARY ZEROES.  NAMES ARE OMITTED FROM THE END BY 31800016
*  SHORTENING THE LIST.  THE SEQUENCE OF THE ENTRIES IS AS FOLLOWS:     32100016
*                                                                       32400016
*                  ENTRY 1   00000000                                   32700016
*                        2   00000000                                   33000016
*                        3   00000000                                   33300016
*                        4   00000000                                   33600016
*                        5   SYSIN                                      33900016
*                        6   SYSPRINT                                   34200016
*                        7   00000000                                   34500016
*                        8   00000000                                   34800016
*                        9   00000000                                   35100016
*                                                                       35400016
*  THE THIRD PARAMETER LIST PERTAINS TO HEADER INFORMATION.             35700016
*  THE THIRD POINTER IS TO THE SIX BYTE LIST CONTAINING A PAGE COUNT    36000016
*  FOR THE OUTPUT DEVICE.  THE FIRST TWO BYTES OF THIS LIST CONTAIN THE 36300016
*  LENGTH IN BYTES OF THE HEADING LIST.  THE REMAINING FOUR BYTES       36600016
*  CONTAIN A PAGE NUMBER THAT THE UTILITY PROGRAM IS TO PLACE ON THE    36900016
*  FIRST PAGE OF PRINTED OUTPUT.                                        37200016
         EJECT                                                          37500016
* THIS SECTION GETS THE ADDRESS OF THE DDNAMES IF ANY ARE PROVIDED,     37800016
*  OTHERWISE STANDARD DDNAMES ARE PROVIDED                              38100016
SETOPT   LR    GR1,GR7                 RESTORE POINTER TO PARMS, IF ANY 38400016
         TM    0(GR1),X'80'            ONE PARAMETER ONLY.              38700016
         BO    TEST1                   YES-GO PROCESS.                  39000016
         TM    4(GR1),X'80'            TWO PARAMETERS ONLY.             39300016
         BO    TEST2                   YES-GO PROCESS                   39600016
         TM    8(GR1),X'80'            THREE PARAMETERS ONLY            39900016
         BZ    SETCODE                 NO--MUST BE INVOCATION ERROR.    40200016
TEST3    OC    9(3,GR1),9(GR1)         IS THE THIRD POINTER VALID.      40500016
         BZ    TEST2                   NO--GO PROCESS 2ND PARAMETER.    40800016
         L     GR2,8(GR1)              POINTER TO PAGE NUMBER.          41100016
         OC    0(2,GR2),0(GR2)         IS LENGTH ZERO.                  41400016
         BZ    TEST2                   YES-GO PROCESS 2ND PARAMETER.    41700016
*   PROCESS PASSED PAGE NUMBER HERE.                                    42000016
         MVI   PAGESW,X'FF'            INDICATE PAGE NO. PASSED.        42300016
         XC    SARG(8),SARG            CLEAR.                           42600016
         PACK  SARG+5(3),2(4,GR2)      PACK GRAPHICS.                   42900016
         CVB   GR3,SARG                CHANGE TO BINARY.                43200016
         STH   GR3,PAGENO              SET UP PAGE NUMBER.              43500016
TEST2    OC    5(3,GR1),5(GR1)         IS THE 2ND POINTER VALID.        43800016
         BZ    TEST1                   NO--GO PROCESS 1ST PARAMETER.    44100016
         L     GR2,4(GR1)              POINTER TO DDNAME LIST.          44400016
         OC    0(2,GR2),0(GR2)         IS LIST LENGTH ZERO.             44700016
         BZ    TEST1                   YES-GO PROCESS 1ST PARAMETER.    45000016
*   PROCESS DDNAME LIST HERE.                                           45300016
         CLI   1(GR2),48               DDNAME LIST LONG ENOUGH/SYSPRINT 45600016
         BNL   TESTTWO                 YES-GO PROCESS SYSPRINT/SYSIN    45900016
         CLI   1(GR2),40               DDNAME LIST LONG ENOUGH/SYSIN.   46200016
         BNL   TESTONE                 YES-GO PROCESS SYSIN ONLY.       46500016
         B     TEST1                   GO-PROCESS FIRST PARAMETER.      46800016
TESTTWO  OC    42(8,GR2),42(GR2)       CHECK FOR SYSPRINT DDNAME.       47100016
         BZ    TESTONE                 NONE-GO TEST FOR SYSIN.          47400016
         MVC   SYSOUTDD(8),42(GR2)     MOVE IN USERS NAME FOR SYSPRINT. 47700016
TESTONE  OC    34(8,GR2),34(GR2)       CHECK FOR SYSIN DDNAME.          48000016
         BZ    TEST1                   NONE-GO PROCESS 1ST PARAMETER.   48300016
         MVC   SYSINDD(8),34(GR2)      MOVE IN USERS NAME FOR SYSIN.    48600016
TEST1    OC    1(3,GR1),1(GR1)         IS FIRST PARAMETER VALID.        48900016
         BZ    HEADPRIN                NO--NO PARM OPTIONS TODAY.       49200016
         L     GR2,0(GR1)              POINTER TO PARM LIST.            49500016
         OC    0(2,GR2),0(GR2)         IS LIST LENGTH ZERO.             49800016
         BZ    HEADPRIN                YES                              50100016
         LH    GR3,0(GR2)              LENGTH OF PARAMETER LIST.        50400016
         LA    GR3,1(GR3)                                               50700016
         LA    GR5,1(GR2)              POINTER TO BYTE BEFORE OPTION.   51000016
         LA    GR2,1(GR2)              START OF FIELD TO SCAN.          51300016
         SPACE 1                                                        51600016
SEEK     BCTR  GR3,0                   MINUS ONE FROM BYTE COUNT.       51900016
         LTR   GR3,GR3                 END OF TEST.                     52200016
         BE    HEADPRIN                YES-NO MORE OPTIONS              52500016
         LA    GR5,1(GR5)              INCREMENT SCAN POINTER.          52800016
         CLI   0(GR5),DELIM            IS THIS A DELIMITER.             53100016
         BNH   TESTCNT2                YES-GO TEST FOR LINE COUNT.      53400016
         SPACE 1                                                        53700016
         LTR   GR3,GR3                 END OF TEST.                     54000016
         BNE   SEEK                    NO--LOOP UNTIL DELIMITER.        54300016
         SPACE 1                                                        54600016
TESTCNT2 CLC   1(8,GR2),LINCT          IS PARAMETER LINECOUNT.          54900016
         BE    FOUNDL                  YES-GO PROCESS.                  55200016
         SPACE 1                                                        55500016
         CLC   1(2,GR2),NEQUAL         IS PARAMETER A 'N='.             55800016
         BE    FOUNDN                  YES-GO PROCESS.                  56100016
         SPACE 1                                                        56400016
         LR    GR2,GR5                 RESET START POINTER.             56700016
TESTCNT1 LTR   GR3,GR3                 IS LIST EXAUSTED                 57000016
         BE    HEADPRIN                YES-NO MORE OPTIONS.             57300016
         B     SEEK                    NO--CONTINUE SCAN.               57600016
         SPACE 1                                                        57900016
FOUNDL   EQU   *                       HANDLE THE LINE COUNT HERE.      58200016
         BCTR  GR3,0                   ACCOUNT FOR '=' SIGN.            58500016
         CH    GR3,TWO                 AT LEAST TWO CHARACTER PARAMETER 58800016
         BL    SETCODE                  NO - INVOCATION ERROR    M2680  58900020
         TM    9(GR2),X'F0'            1ST DIGIT A DECIMAL DIGIT.       59400016
         BC    12,SETCODE              NO--INVOCATION ERROR.            59700016
         TM    10(GR2),X'F0'           2ND DIGIT A DECIMAL DIGIT.       60000016
         BC    12,SETCODE              NO--INVOCATION ERROR.            60300016
         XC    SARG(8),SARG            CLEAR.                           60600016
         PACK  SARG+6(2),9(2,GR2)      PACK GRAPHICS.                   60900016
         BCTR  GR3,0                   ACCOUNT FOR ONE DIGIT.           61200016
         LA    GR2,10(GR2)             POINT TO LAST DIGIT.             61500016
         CH    GR3,ONE                 MORE THAN 2 DIGITS LEFT IN LIST. 61800016
         BNH   CONT                    NO--PROCESS THIS LINE COUNT.     62100016
         CLI   1(GR2),DELIM            SOME DELIMITER FOLLOW 2ND DIGIT. 62400016
         BH    SETCODE                 NO--INVOCATION ERROR.            62700016
CONT     LR    GR5,GR2                 RESET POINTER.                   63000016
         CVB   GR9,SARG                CHANGE TO BINARY.                63300016
         STC   GR9,SARG                TEMPORARY STORAGE.               63600016
         CLI   SARG,0                  DOES THE LINE COUNT EQUAL ZERO.  63900016
         BNH   SETCODE                 YES-INVOCATION ERROR.            64200016
         CLI   SARG,99                 LINE COUNT MORE THAN 99.         64500016
         BH    SETCODE                 YES-INVOCATION ERROR.            64800016
         STH   GR9,LINECNT             FIXED LINE COUNT.                65100016
         STH   GR9,LINECNT1            CURRENT LINE COUNT.              65400016
         B     TESTCNT1                                                 65700016
         EJECT                                                          66000016
*   SET UP THE QUEUE SIZE HERE, IF SPECIFIED.                           66300016
FOUNDN   XC    SARG(8),SARG            ZERO.                            66600016
         BCTR  GR3,0                   ACCOUNT FOR '=' SIGN.            66900016
         CH    GR3,ONE                 MORE THAN 1 BYTE LEFT IN LIST.   67200016
         BNH   CONT1                   NO--GO PROCESS 'N'.              67500016
         CLI   2(GR5),DELIM            DELIMITER FOLLOW THE 1 DIGIT.    67800016
         BH    SETCODE                 NO--INVOCATION ERROR.            68100016
CONT1    EQU   *                                                        68400016
         LA    GR2,1(GR5)              RESET POINTER.                   68700016
         LR    GR5,GR2                 RESET POINTER -LAST DIGIT.       69000016
         CLI   0(GR2),C'0'             N GREATER THAN 0.                69300016
         BNH   SETCODE                 NO--INVOCATION ERROR.            69600016
         CLI   0(GR2),C'6'             N GREATER THAN 6.                69900016
         BH    SETCODE                 YES-INVOCATION ERROR.            70200016
         PACK  SARG+7(1),0(1,GR2)      PACK GRAPHICS.                   70500016
         CVB   GR9,SARG                'N' VALUE IN BINARY.             70800016
         SPACE 1                                                        71100016
FOUND1   SLA   GR9,2                   N TIMES BYTES/ENTRY.             71400016
         LA    GR4,PTRFUNC1-CSIZE      ADDRESS OF CONTROL LIST.         71700016
         AR    GR4,GR9                 PLUS N TIMES BYTES PER ENTRY.    72000016
         ST    GR4,ENDCLIST            POINTS TO LAST USEABLE SLOT.     72300016
         B     TESTCNT1                                                 72600016
         SPACE                                                          72900016
*********************************************************************** 73200016
*                                                                     * 73500016
*   THIS ROUTINE WILL CLEAR ANY BLOCK OF CORE TO ZERO.                * 73800016
*                                                                     * 74100016
*     REGISTER 1 MUST CONTAIN THE STARTING ADDRESS UPON ENTRY.        * 74400016
*     REGISTER 2 IS A WORK REGISTER.                                  * 74700016
*     REGISTER 3 MUST CONTAIN THE SIZE UPON ENTRY.                    * 75000016
*     REGISTER 14 IS THE RETURN REGISTER.                             * 75300016
*                                                                     * 75600016
*********************************************************************** 75900016
         SPACE                                                          76200016
CLEAR    LA    GR2,255                 SET FOR EXECUTE.                 76500016
         MVI   0(GR1),X'00'            PRIME FIRST BYTE FOR EXEC.       76800016
EXEC     CH    GR3,TWO56               WILL THIS BE THE LAST PASS.      77100016
         BNH   LASTTIME                YES-DO ONE MORE MOVE.            77400016
         EX    GR2,MVZO                CLEAR 256 BYTES.                 77700016
         LA    GR1,256(GR1)            INCREMENT ADDRESS.               78000016
         SH    GR3,TWO56               UPDATE BYTE COUNT.               78300016
         B     EXEC                    RETURN TO CHECKPOINT.            78600016
         SPACE 1                                                        78900016
LASTTIME BCTR  GR3,0                   DECREMENT FOR MVC.               79200016
         EX    GR3,MVZO                CLEAR REMAINING PORTION.         79500016
         BR    GR14                    RETURN.                          79800016
         EJECT                                                          80100016
HEADPRIN EQU   *                       PASS CONTROL TO 2ND LOAD/MONITOR 80400016
         ST    GR1,PRINT1              PASS PARM POINTER TO 2ND LOAD.   80700016
         LR    GR1,WORKBASE            PASS WORK AREA ADDRESS.          81000016
         L     GR14,12(GR13)           RESTORE REGISTER 14.             81300016
         LA    GR15,XCTL               XCTL LIST.                       81600016
         XCTL  (2,12),MF=(E,(1)),SF=(E,(15))                            81900016
         SPACE 3                                                        82200016
SETCODE  EQU   *                                                 A32161 82220020
         USING IHADCB,GR4                                        A32161 82240020
         LA    GR4,WRIT                GET DCB ADDRESS.          A32161 82260020
         ST    GR4,PRINT1              STORE IN WORK AREA.       A32161 82280020
         MVC   DCBDDNAM(8),CONSPRIN  PUT DDNAME IN DCB.          A32161 82300020
         MVC   PRNTSW,0                CLEAR SWITCH.             A32161 82320020
         LA    GR1,OPENLST             GET OPEN LST ADDR.        A32161 82340020
         OPEN  MF=(E,(1))              OPEN PRINTER DCB.         A32161 82360020
         TM    DCBOFLGS,WAITING        SUCCESSFUL OPEN.          A32161 82380020
         BZ    SETCODE                 NO-TRY AGAIN.             A32161 82400020
         BAL   GR8,WRITMSG             PRINT HEADING.            A32161 82420020
         LA    GR1,M47                 GET MESSAGE 847.          A32161 82440020
         BAL   GR8,MSGSETUP            PLACE MSG BUFFER.         A32161 82460020
         BAL   GR8,WRITMSG             PRINT MESSAGE.            A32161 82480020
         LA    GR1,M39                 GET RETURN CODE MSG.      A32161 82500020
         BAL   GR8,MSGSETUP            PLACE IN MSG BUFFER.      A32161 82520020
         LA    GR6,C16                 RETURN CODE.              A32161 82540020
         CVD   GR6,DECODE              CHANGE TO DECIMAL.        A32161 82560020
         UNPK  K1(K2,GR1),DECODE+K6(K2)                          A32161 82580020
         OI    K2(GR1),NUM                                       A32161 82600020
         BAL   GR8,WRITMSG             PRINT MESSAGE.            A32161 82620020
         LA    GR1,CLOSLST             GET ADDR OF CLOSE.        A32161 82640020
         CLOSE MF=(E,(1))              CLOSE PRINTER DCB.        A32161 82660020
         LR    GR1,WORKBASE          ADDRESS OF WORK AREA.       A32161 82680020
         FREEMAIN R,LV=0+WORKSIZE,A=(1)                                 82800016
         SPACE                                                          83100016
         LA    GR15,16                                                  83400016
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN W/PROPER CODE.    83700016
MSGSETUP EQU   *                                                 A32161 83730020
         LINK  EP=IEHDMSGB             OBTAIN PROPER MSG.        A32161 83760020
         BR    GR8                     RETURN TO CALLER.         A32161 83790020
WRITMSG  EQU   *                                                 A32161 83820020
         LINK  EP=IEHDPRNT             PRINT PROPER MSG.         A32161 83850020
         BR    GR8                     RETURN TO CALLER.         A32161 83880020
FILIN    MVC   0(0,GR1),0(GR3)         PARM INTO MSG.            A32161 83910020
         DC    C'MAINTENANCE AREA'                              XL02912 83920002
MAINT    DS    50F                                              XL02912 83930002
OPENLST  OPEN  (WRIT,(OUTPUT)),MF=L                              A32161 83940020
CLOSLST  CLOSE (WRIT),MF=L                                       A32161 83970020
         SPACE 1                                                        84000016
*ASSUMED DDNAME CONSTANTS                                               84300016
*                                                                       84600016
CONSYSIN DC    CL8'SYSIN   '                                            84900016
CONSPRIN DC    CL8'SYSPRINT'                                            85200016
         SPACE 1                                                        85500016
SARG     DS    1D                      WORK AREA.                       85800016
TWO56    DC    H'256'                  COMPARE CONSTANT.                86100016
ONE      DC    H'1'                    COMPARE CONSTANT.                86400016
TWO      DC    H'2'                    COMPARE CONSTANT.                86700016
MVZO     XC    0(1,GR1),0(GR1)         EXECUTED TO CLEAR CORE.          87000016
         SPACE                                                          87300016
XCTL     XCTL  EP=IEHDASDS,SF=L                                         87600016
         SPACE                                                          87900016
NEQUAL   DC    C'N='                   PARM FIELD KEYWORD.              88200016
LINCT    DC    C'LINECNT='             PARM FIELD KEYWORD.              88500016
ZEROES   DC    CL2'0'                  LINECNT TEST VALUE.       A32161 88550020
DECODE   DS    1D            USE FOR PACK INSTRUCTION            A32161 88600020
LIST     DC    F'0'                                              A32161 88650020
WRIT     DCB   DSORG=PS,MACRF=PM,RECFM=FBSA,BLKSIZE=121,         M2680 X88700020
               LRECL=121,DDNAME=SYSPRINT,EODAD=SETCODE           A32161 88750020
         EJECT                                                          88800016
         IEHDWORK                                                       89100016
         DCBD  DSORG=PS                                          A32161 89200020
         END                                                            89400016
./  ADD  SSI=80720110,NAME=IEHDASDS
 TITLE 'IEHDASDS --- MONITOR FOR IEHDASDR UTILITY PROGRAM'              00090802
         COPY  LCGASMSW                                          X02912 00090902
IEHDASDS CSECT                                                          00091002
*********************************************************************** 00091140
*                  FIXES THIS MODULE                                    00091240
*                     LATEST FIRST                                      00091340
*********************************************************************** 00093540
*                                                                       00095840
*C 39800,563300                     ONLY MVS                   @ZA27199 00095999
*A 563110-563120,563210,            ONLY MVS                   @ZA27199 00096099
*A 702400,880330                    ONLY MVS                   @ZA27199 00096199
*                                                                       00096299
*C 39800,768307                     ONLY MVS                   @ZA26352 00096399
*A 768303-768304                    ONLY MVS                   @ZA26352 00096499
*                                                                       00096599
*C 39800,752005,752025              ONLY MVS                   @ZA26120 00096699
*                                                                       00096799
*  DUE TO CHANGE OF MACRO IEHDBLKS  @XA16072=@YA18844=@ZA24409=@SA79773 00096899
*C 902500                           @XA16072=@YA18844=@ZA24409=@SA79773 00096999
*                                                                       00097099
*D 752180                           ONLY MVS                   @ZA11946 00098299
*C 39800,752220                     ONLY MVS                   @ZA11946 00098499
*A 752035-752100                    ONLY MVS                   @ZA11946 00098699
*                                                                       00098899
*C 39800,636240,752126              ONLY MVS                   @ZA03380 00099003
*                                                                       00101203
*C 39800,836550-836600              @SA74491=@XA10393=@YA10560=@ZA04422 00103403
*                                                                       00105603
*C 767700,768317                                               @VS40035 00107803
*A 538510,520                                                  @VS40035 00110003
*C 538600,620                                                  @Z30RSAG 00112203
*C 538788                                                      @Z30RSAG 00114403
*                                                                       00116640
*D 768387-768419,768318             @SA73428=@YA08028=@XA08859=@ZA03352 00118803
*C 39800                            @SA73428=@YA08028=@XA08859=@ZA03352 00121003
*A 768327-768351,768358,768365      @SA73428=@YA08028=@XA08859=@ZA03352 00121403
*                                                                       00121803
*C 40000,768317                     @SA73414=@XA07276=@YA07985=@ZA01705 00121903
*A 39700,39800,767720               @SA73414=@XA07276=@YA07985=@ZA01705 00122103
*                                                                       00122603
*C 768996-769000   MVS 3.0 CHANGES   16-BITS UCB SUPPORT       @30AAAG  00124003
*                                                                       00126003
*                  MVS 3.0 CHANGES   MSS SUPPORT               @Y30LSFY 00128003
*                                                                       00128403
*C 26560                                                       @ZA01214 00128803
*A 752112,752217                                               @ZA01214 00129203
*                                                                       00129603
*A768301-768302,C768812                                         YM08503 00143703
*                                       YM01130                         00143803
*                                                               STAEFIX 00143903
*                                                               OX01789 00144003
*                                                               YL02912 00144103
*                                                              YM01130  00144503
* 76500016,76590016,76680016                     SA68162=XA03918=YM5770 00145203
*STATUS CHANGE LEVEL 004                                                00146803
*                                                                       00147003
*********************************************************************** 00149040
         EJECT                                                          00149440
*FUNCTION/OPERATION- THIS ROUTINE IS THE SECOND LOAD MODULE OF THE    * 00150003
*   IEHDASDR SYSTEM UTILITY PROGRAM AND IS IN CORE FOR THE ENTIRE     * 00153003
*   EXECUTION TIME. AFTER RECEIVING CONTROL FROM THE -IEHDASDR-       * 00156003
*   ROUTINE, THIS ROUTINE WILL ATTEMPT TO OPEN THE SYSOUT AND         * 00159003
*   SYSIN DATA SETS. IF SUCCESSFUL, IT WILL LINK TO -IEHDPRNT- TO     * 00162003
*   FORMAT AND PRINT THE HEADING, AND THEN CALL -IEHDSCAN- TO         * 00165003
*   SCAN AND SYNTAX CHECK THE SYSIN DATA SET. FOR EACH VALID REQUEST  * 00168003
*   AN ENTRY IS MADE IN THE FUNCTION QUEUE(FIFO SCHEDULING), MAIN     * 00171003
*   STORAGE ACQUIRED FOR THE FUNCTION BLOCK AND COPY BLOCKS, IF ANY,  * 00174003
*   AND CONTROL IS THEN PASSED TO THE APPROPRIATE FUNCTIONAL ROUTINE. * 00177003
*   WHEN AN ERROR IS DETECTED IN THE SYSIN DATA SET, THIS ROUTINE     * 00180003
*   WILL PLACE THE APPROPRIATE DIAGNOSTIC MESSAGE IN THE MESSAGE      * 00183003
*   DATA SET, STORE A RETURN CODE OF EIGHT, AND CONTINUE THE SCAN.    * 00186003
*                                                                     * 00189003
*   THE -IEHDASDS- ROUTINE WILL ATTEMPT TO INITIATE EXECUTION OF UP   * 00192003
*   TO SIX LIKE FUNCTIONS IF DEVICES AND CORE ARE AVAILABLE. THE      * 00195003
*   INDIVIDUAL FUNCTIONAL ROUTINES, FOR CERTAIN WAITS ON I/O          * 00198003
*   OPERATIONS, WILL RETURN CONTROL TO THE MONITOR ALLOWING THIS      * 00201003
*   ROUTINE TO INITIATE ANOTHER LIKE FUNCTION-CONCURRENT PROCESSING.  * 00204003
*                                                                     * 00207003
*   WHEN A FUNCTION COMPLETES, ITS ENTRY IS REMOVED FROM THE QUEUE,   * 00210003
*   AND ALL SUBSEQUENT ENTRIES MOVED UP. UPON COMPLETION OF ALL       * 00213003
*   REQUESTS, -IEHDASDS- FREES ALL MAIN STORAGE IT OBTAINED,          * 00216003
*   CLOSES THE SYSIN, SYSOUT DATA SETS, AND RETURNS TO THE CALLER     * 00219003
*   WITH THE HIGHEST RETURN CODE ENCOUNTERED DURING EXECUTION.        * 00222003
*                                                                     * 00225003
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDASDS-, AND CONTROL IS     * 00228003
*   ALWAYS RECEIVED FROM -IEHDASDR-.                                  * 00231003
*                                                                     * 00234003
*INPUT- REGISTER 1 WILL POINT TO THE WORK AREA IN WHICH THE SYSIN     * 00237003
*   AND SYSOUT DDNAMES, LINE COUNT, AND FUNCTION QUEUE SIZE ARE       * 00240003
*   ALREADY SET UP.                                                   * 00243003
*                                                                     * 00246003
*EXITS-NORMAL- SUCCESSFUL COMPLETION OF ALL REQUESTED FUNCTIONS       * 00249003
*   RESULTS IN A RETURN TO THE CALLER WITH A RETURN CODE OF ZERO.     * 00252003
*                                                                     * 00255003
*EXITS-ERROR- ANY ERRORS ENCOUNTERED ARE DESCRIBED BY APPROPRIATE     * 00258003
*   MESSAGES IN THE MESSAGE DATA SET AND A RETURN TO THE CALLER WITH  * 00261003
*   THE HIGHEST RETURN CODE ENCOUNTERED.                              * 00264003
*                                                                     * 00267003
*EXTERNAL ROUTINES- THIS ROUTINE ALWAYS RECEIVES CONTROL FROM THE     * 00270003
*   -IEHDASDR- ROUTINE. THREE CSECTS ARE USED AS UTILITY ROUTINES.    * 00273003
*   THE HEADING AND ANY MESSAGES USSUED WILL BE WRITTEN OUT BY        * 00276003
*   -IEHDPRNT- WITH MESSAGES BEING SET UP BY -IEHDMSGB-.              * 00279003
*   THE -IEHDSCAN- ROUTINE IS USED TO READ IN AND SCAN THE SYSIN      * 00282003
*   DATA SET. ALL DEVICE DEPENDENT INFORMATION IS CONTAINED IN THE    * 00285003
*   -IEHDCONS- CSECT. A POINTER TO THIS CSECT IS PROVIDED IN EACH     * 00288003
*   FUNCTION BLOCK BUILT. THE FOLLOWING ARE THE ENTRY POINTS FOR      * 00291003
*   THE FUNCTIONAL ROUTINES, LOADED INTO CORE FOR EXECUTION AND       * 00294003
*   THEN DELETED UPON COMPLETION, WHICH RECEIVE CONTROL FROM          * 00297003
*   -IEHDASDS-                                                        * 00300003
*              IEHDREST                                               * 00303003
*              IEHDANAL                                               * 00306003
*              IEHDLABL                                               * 00309003
*              IEHDGETA                                               * 00312003
*              IEHDDUMP.                                              * 00315003
*                                                                     * 00318003
*TABLES/WORK AREAS- BEFORE PASSING CONTROL TO A FUNCTIONAL ROUTINE,   * 00321003
*   -IEHDASDS- WILL POINT TO THE FUNCTION BLOCK AND THE WORK          * 00324003
*   AREA IN REGISTERS 10 AND 12 RESPECTIVELY. THEY ARE DESCRIBED      * 00327003
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 00330003
*                                                                     * 00333003
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE.                          * 00336003
*                                                                     * 00339003
*NOTE- THE VERSION LEVEL FOR THE IEHDASDR SYSTEM UTILITY              * 00342003
*   PROGRAM IS MAINTAINED IN THE -IEHDPRNT- ROUTINE AND SHOULD BE     * 00345003
*   UPDATED AS RELEASE LEVELS AND VERSIONS CHANGE.                    * 00348003
*                                                                     * 00351003
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             00354003
GR0      EQU   0                                                        00357003
GR1      EQU   1                                                        00360016
GR2      EQU   2                                                        00450016
GR3      EQU   3                                                        00540016
GR4      EQU   4                                                        00630016
GR5      EQU   5                                                        00720016
GR6      EQU   6                                                        00810016
GR7      EQU   7                                                        00900016
GR8      EQU   8                                                        00990016
GR9      EQU   9                                                        01080016
GR10     EQU   10                                                       01170016
GR11     EQU   11                                                       01260016
GR12     EQU   12                                                       01350016
GR13     EQU   13                                                       01440016
GR14     EQU   14                                                       01530016
GR15     EQU   15                                                       01620016
SCANADR  EQU   1                                                        01710016
LENGTH   EQU   2                                                        01800016
ROOTBASE EQU   11                                                       01890016
WORKBASE EQU   12                                                       01980016
         SPACE 1                                                        02070016
         SPACE 1                                                        02160016
*   MESSAGE REFERENCES.                                                 02170016
*********************************************************************** 02180016
MESS0    EQU   0                       MESSAGE NUMBER(800).             02190016
MESS1    EQU   1                       MESSAGE NUMBER(801).             02200003
MESS2    EQU   2                       MESSAGE NUMBER(802).             02210016
MESS3    EQU   3                       MESSAGE NUMBER(803).             02220016
MESS4    EQU   4                       MESSAGE NUMBER(804).             02230016
MESS5    EQU   5                       MESSAGE NUMBER(805).             02240016
MESS12   EQU   12                      MESSAGE NUMBER(812).             02252001
MESS13   EQU   13                      MESSAGE NUMBER(813).             02260016
MESS18   EQU   18                      MESSAGE NUMBER(818).             02270016
MESS20   EQU   20                      MESSAGE NUMBER(820).     YM5582  02272001
MESS24   EQU   24                      MESSAGE NUMBER(824).             02280016
MESS26   EQU   26                      MESSAGE NUMBER(826).             02290016
MESS33   EQU   33                      MESSAGE NUMBER(833).    @Y30LSFY 02292003
MESS39   EQU   39                      MESSAGE NUMBER(839).             02295016
MESS51   EQU   51                      MESSAGE NUMBER(851).     XM7053  02297002
MESS54   EQU   54                      MESSAGE NUMBER(854).     YL02912 02299002
MESS55   EQU   55                      MESSAGE NUMBER(855).     YL02912 02299402
MESS59   EQU   59                      MESSAGE NUMBER(859).     YM01130 02299802
*********************************************************************** 02300016
         EJECT                                                          02310016
SENS     EQU   X'F1'                    SVC 82 FUNCTION BYTE    XL03130 02312003
DA2321   EQU   X'05'                   2321 DEVICE TYPE CODE.           02320016
BLANK    EQU   C' '                                                     02610016
L4       EQU   4                        LENGTH CONSTANT         YL02912 02622002
L0       EQU   0                        LENGTH CONSTANT         YL02912 02630002
ENQ      EQU   X'04'                    INDIC ENQUEUE ON UCB    YL02912 02640002
DEDEB    EQU   X'F8'                    DEB TO BE DELETED      YM01130  02642002
ENQDEQ   EQU   82                       SVC 82 NUMBER           YL02912 02652002
DEBOFF   EQU   8                        OFFSET TO TCB DEBPTR    YM01130 02654002
UCBOFF   EQU   32                       OFFSET TO DEB UCBPTR   @ZA01214 02656002
ONE      EQU   X'01'                    UCB USER COUNT          XM7053  02660002
SYSINOUT EQU   X'C0'                    SYSIN/SYSOUT UCBWGT VAL YM5582  02662001
L8       EQU   8                        DDNAME LENGTH           YM5582  02664001
K0       EQU   0                        DISPL CONSTANT          YM5582  02666001
DASDI    EQU   X'20'                    UCB BYTE 3 TYPE CODE    XM7053  02670002
COND0    EQU   8                        CONDITION ZERO           YM5770 02672002
DISP0    EQU   0                        AT THE ORIGAN            YM5770 02674002
LASTCTCB EQU   4                        LAST CURRENT TCB         YM5770 02674402
ADD1     EQU   1                        INCREMENT BY ONE         YM5770 02674802
SS1VAL   EQU   X'01'                    SS/1 ANALIZE           @Y30LSFY 02674903
ON       EQU   X'FF'                    ALL FLAGS ON           @Y30LSFY 02679003
SS1VTOC  EQU   C'2'                     SS/1 VTOC START        @Y30LSFY 02681003
SS1EXT   EQU   C'1'                     SS/1 VTOC EXTENT       @Y30LSFY 02683003
L10      EQU   10                       LENGTH CONSTANT        @Y30LSFY 02683403
         AIF  ('&LIB' EQ 'LIB1').ARONDA   THIS ASSEM FOR OS      X02912 02683603
IPLSIZE  EQU   6496                     VS IPLTXT BUFFER SIZE    X02912 02687703
         AGO   .ARONDB                  BRCH AROUND OS VALUE     X02912 02691803
.ARONDA  ANOP                           BRCH POINT FOR OS CODE   X02912 02695903
IPLSIZE  EQU   3640                    BUFFER SIZE FOR IPL PROGRAM.     02700016
.ARONDB  ANOP                           BRCH POINT FOR VS CODE   X02912 02750002
         SPACE 1                                                        02790016
         USING WORK,12                 SET UP BASE FOR WORK AREA        02880016
         USING COPYBLK,GR8                                              02970016
         USING IEHROOT,ROOTBASE                                         03060016
         USING FUNCBLK,GR10                                             03150016
         SPACE 1                                                        03240016
IEHROOT  LR    GR0,GR1                 WORKAREA ADDRESS.                03300016
         L     GR1,PRINT1-WORK(GR1)    PARM  LIST POINTER.              03360016
         SAVE  (14,12),T                                                03420016
         LR    GR12,GR0                WORKAREA ADDRESS.                03480016
         LR    ROOTBASE,GR15           LOAD THE BASE REGISTER.          03540016
         SPACE                                                          03600016
         LA    GR7,ROOTSAVE            SAVE AREA ADDRESS.               03690016
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      03780016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      03870016
         LR    GR13,GR7                SAVE AREA ADDRESS.               03960016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA01705 03970003
         DC    C'IEHDASDS OZ27199'     LAST APAR FIX THIS MOD  @ZA27199 03980099
APARNO   MVI   RETCODE,0               INSURE RETURN CODE ZERO.@ZA01705 04000003
         EJECT                                                          04550002
*********************************************************************** 04560002
*   THIS SECTION OPENS SYSIN AND SYSOUT DCBS.                         * 04570002
*     AND THEN LINKS TO THE PRINT ROUTINE TO                          * 04580002
*     WRITE OUT A HEADER RECORD.                                      * 04582002
*********************************************************************** 04584002
HEADPRIN EQU   *                                                        04590016
         USING IHADCB,GR4                                               04680016
         LA    GR4,PRINT               SYSOUT DCB ADDRESS.              04770016
         ST    GR4,PRINT1              DCB ADDRESS TO WORK AREA.        04860016
         MVC   DCBDDNAM(8),SYSOUTDD    SYSPRINT DDNAME TO DCB.          04950016
         MVI   PRNTSW,0                CLEAR EXIT ROUTINE SWITCH.       05040016
         LA    GR1,OPNLST1             ADDRESS OF OPEN LIST.            05130016
         BAL   GR9,OPENDATA            OPEN SYSPRINT.                   05220016
         TM    DCBOFLGS,X'10'          WAS OPEN SUCCESSFUL.             05310016
         BZ    SETCODE                 NO--GO SET RETURN CODE.          05400016
         BAL   GR9,ERRPRINT            GO WRITE OUT HEADER MESSAGE.     05490016
         TM    PRNTSW,X'01'            YES-IS BLOCKSIZE VALID.          05580016
         BZ    HEADP2                  YES-GO OPEN SYSIN.               05670016
         LA    GR1,38                  NO--ERROR MESSAGE NUMBER.        05760016
         BAL   GR9,BUILD               LOAD BUFFER WITH ERROR MESSAGE.  05850016
         MVC   0(8,GR1),SYSOUTDD       PLACE DDNAME INTO MESSAGE.       05940016
         BAL   GR9,ERRPRINT            WRITE OUT ERROR MESSAGE.         06030016
         MVI   RETCODE,4               SET RETURN CODE.                 06120016
         SPACE                                                          06210016
HEADP2   EQU   *                                                        06300016
         LA    GR4,READ                SYSIN DCB ADDRESS.               06390016
         ST    GR4,READ1               DCB ADDRESS TO WORK AREA.        06480016
         MVC   DCBDDNAM(8),SYSINDD     SYSIN DDNAME TO DCB.             06570016
         MVI   PRNTSW,0                CLEAR EXIT ROUTINE SWITCH.       06660016
         LA    GR1,OPNLST2             ADDRESS OF OPEN LIST.            06750016
         BAL   GR9,OPENDATA            OPEN SYSIN.                      06840016
         TM    DCBOFLGS,X'10'          WAS OPEN SUCCESSFUL.             06930016
         BZ    DCBERROR                NO--GO PRINT ERROR MESSAGE.      07020016
         TM    PRNTSW,X'01'            YES-IS BLOCKSIZE VALID.          07110016
         BZ    SCANA                   YES-BEGIN SCANNING CARDS.        07200016
         LA    GR1,38                  NO--ERROR MESSAGE NUMBER.        07290016
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         07380016
         MVC   0(8,GR1),SYSINDD        PLACE DDNAME IN MESSAGE.         07470016
         BAL   GR9,ERRPRINT            PRINT OUT THE MESSAGE.           07560016
         MVI   RETCODE,16              SET RETURN CODE.                 07650016
         B     ENDALL                  RETURN CONTROL TO CALLLER.       07740016
         EJECT                                                          07790002
*********************************************************************** 07800002
*   THIS SECTION ISSUES THE ESTAE MACRO TO EFFECT ERROR RECOVERY      * 07810002
*   IF IEHDASDR SHOULD ABEND OR BE CANCELED BEFORE TURNING OFF THE    * 07820002
*   'SPELL BINDING' BIT: UCBNALOC. THIS BIT IS TURNED ON FOR OFFLINE  * 07822002
*   PROCESSING ONLY.                                                  * 07824002
*********************************************************************** 07826002
ESTAE    EQU   *                                                        07826402
         LA    GR4,STAESIZE       GET LIST SIZE                YM01130  07828002
         GETMAIN R,LV=(GR4)                                             07828402
         USING STAELIST,GR1                                             07828802
*                                                                       07829202
         LR    GR4,GR1                  SAVE AREA ADDR          YM01130 07829302
         L     GR9,CVTPTR              ADDRESS OF COMM. VECTOR TABL).   07829602
         USING CVT,GR9                                         YM01130  07829702
         L     GR15,CVTTCBP            TCB WORD.               YM01130  07829802
         L     GR15,D4(GR15)            PICK UP TCB ADDRESS.   YM01130  07829902
         ST    GR15,STAELIST           STORE TCB ADDR          YM01130  07859902
         ST    GR12,STAEND             SAVE IEHDWORK ADDR       STAEFIX 07860302
         MVI   STAEND,ENDPL            SET END OF P.L.          STAEFIX 07861902
         ESTAE ABNDCODE,CT,PARAM=(GR4),XCTL=NO,PURGE=NONE,             *07869902
               ASYNCH=NO,ESTAR=NO,TERM=YES,RECORD=NO                    07879902
         BR    GR7                      RETURN TO CALLER        YM01130 07881902
         DROP 1,9                                                       07889902
         EJECT                                                          07890002
OPENDATA EQU   *                                                        07920016
         OPEN  MF=(E,(1))              OPEN SPECIFIED DATA SET.         08010016
         BR    GR9                     RETURN TO CALLLER.               08100016
         SPACE 2                                                        08190016
OPNLST1  OPEN  (PRINT,(OUTPUT)),MF=L                                    08280016
OPNLST2  OPEN  (READ,(INPUT)),MF=L                                      08370016
         SPACE 2                                                        08460016
DCBEXIT1 EQU   *                                                        08550016
         SR    GR0,GR0                 CLEAR TEST REGISTER.             08640016
         LH    GR1,DCBBLKSI            PICK UP BLOCKSIZE.               08730016
         LH    GR2,DCBLRECL            GET LOGICAL RECORD SIZE.         08820016
         CLR   GR0,GR1                 WAS BLOCKSIZE SPECIFIED.         08910016
         BE    DCBEX2                  NO--GO MOVE IN BLOCKSIZE.        09000016
         DR    GR0,GR2                 YES-IS BLOCKSIZE VALID.          09090016
         LTR   GR0,GR0                 ANY REMAINDER.                   09180016
         BCR   8,GR14                  A OK/RETURN TO OPEN.             09270016
         STH   GR2,DCBBLKSI            NO--OVERRIDE BLKSIZE FOR SYSPRIN 09360016
         OI    PRNTSW,X'01'            INDICATE INVALID BLKSIZE.        09450016
         BR    GR14                    RETURN TO OPEN.                  09540016
DCBEX2   STH   GR2,DCBBLKSI            PLACE LRECL IN BLOCKSIZE.        09630016
         BR    GR14                    RETURN TO OPEN.                  09720016
         DROP  GR4                                                      09810016
         EJECT                                                          09900016
SCANA    MVI   SWITCHRD,0         RESET CONTROL SWITCH                  09990016
         SR    GR10,GR10               INDICATE NO FUNCTION BLOCK BUILT 10080016
SCAN     EQU   *                        GO SCAN CARD IMAGE              10130021
         XC    GOTOBR,GOTOBR            CLEAR GO TO BRANCH VALUE        10140021
         LINK  EP=IEHDSCAN             GO SCAN A CARD IMAGE.            10170021
         SPACE 1                                                        10260016
* ADDITIONAL INSTRUCTIONS TO HANDLE THE REPACK FROM DASDS TO DSCAN      10310021
         LA    GR3,GOTAB                GET BRANCH TABLE ADDRESS        10320021
         A     GR3,GOTOBR               ADD VALUE DETERMINED BY DSCAN   10330021
         BR    GR3                      BRANCH TO LOCATION SPECIFIED    10340021
* THE SEQUENCE OF THIS TABLE ID DEPENDENT ON VALUES SET BY DSCAN        10342021
GOTAB    EQU   *                        START OF TABLE                  10344021
         B     NORM                     GO TO OLD DASDS CODE            10346021
         B     CHECK                    GO SEE IF FINISHED              10348421
         B     SCAN1                    START PROCESSING                10348821
         B     OPRLUP                   TEST COMMAND VALIDITY           10349221
         B     GETCOPY                  PROCESS TODD COPIES             10349621
         B     MSGWRT2                  GO WRITE MESSAGE                10349721
* END OF TABLE                                                          10382221
NORM     EQU   *                        END OF TABLE.RESUME NORMAL      10395021
         TM    SWITCHRD,ERROR          WAS THERE AN ERROR.              10417521
         BO    MSGPRT                  YES,GO GIVE A MESSAGE.           10440016
         SPACE 1                                                        10530016
         TM    SWITCHRD,COMD           IS THIS A COMMAND.               10620016
         BO    OPRLUP                   YES-TEST VALIDITY & PROCESS     10670021
         SPACE                                                          11070016
         TM    SWITCHRD,EOF            WAS AN EOF READ.                 11160016
         BO    CHECK                   YES-GO SEE IF FINISHED.          11250016
         SPACE                                                          11340016
SCAN2    TM    SWITCHRD,PARM           THIS A PARAMETER.                11430016
         BC    8,SCAN3                 NO--GO MAKE MORE TESTS.          11450016
         TM    SW1,DD1OK               MULTIPLE PARMS ALLOWED.          11470016
         BCR   1,GR9                   YES-PROCESS PARAMETER.           11490016
         TM    SW1,PARMXY              NO--ANY PREVIOUS PARMS.          11510016
         BO    INVALP1                 YES-THEN THIS PARAMETER INVALID. 11530016
         OI    SW1,PARMXY              REMEMBER THIS PARAMETER.         11550016
         BR    GR9                     PROCESS THIS PARAMETER.          11570016
         SPACE                                                          11610016
SCAN3    TM    SWITCHRD,BYPASS         IS THIS CARD FINISHED.           11700016
         BZ    SCAN                    NO--CONTINUE SCAN//THIS CARD.    11790016
         SPACE 1                                               @Y30LSFY 11800003
SCAN1    TM    SEQSW+L1,SS1VAL          SS/1 ANALYSIS          @Y30LSFY 11840003
         BZ    SCAN1C                   NO                     @Y30LSFY 11850003
*        SS/1 ANALYSIS REQUESTED. FORCE PASSES=1,FLAGTEST=YES, @Y30LSFY 11860003
*        VTOC=2,EXTENT=1. ADJUST I/O DEVICE CONSTANTS POINTER. @Y30LSFY 11870003
         L     GR7,IODEVCON             DEVICE CONSTANTS PTR   @Y30LSFY 11870703
         A     GR7,SS1OFFST             ADJUST FOR SS/1        @Y30LSFY 11871103
         ST    GR7,IODEVCON             SAVE NEW PTR           @Y30LSFY 11871303
         OI    SEQSW,PASSES+VTOC+EXTENT FORCE NEEDED OPTIONS   @Y30LSFY 11874003
         NI    SEQSW,ON-FLAGTEST        FLAGTEST=YES           @Y30LSFY 11876003
         MVI   PASSCNT+L1,ONE           SET PASSES             @Y30LSFY 11878003
         XC    FVTOCPTR(L10),FVTOCPTR   CLEAR VTOC, EXTENT     @Y30LSFY 11878403
         MVI   FVTOCPTR+D4,SS1VTOC      SET VTOC START         @Y30LSFY 11878803
         MVI   FEXTENT+D4,SS1EXT        SET VTOC EXTENT        @Y30LSFY 11879203
SCAN1C   EQU   *                                               @Y30LSFY 11879603
         SPACE                                                          11880016
         SR    GR7,GR7                 CLEAR.                           11970003
         IC    GR7,FUNCSW              FUNCTION CODE AS MULTIPLE OF 16. 12060016
         SRA   GR7,4                   CODE AS MULTIPLE OF 1.           12150016
         LA    GR3,KCODES              ADDRESS OF KEYWORD TABLE         12240000
         LA    GR3,0(GR7,GR3)          INDEX TO PROPER SLOT IN TABLE.   12330016
         IC    GR7,0(GR3)              PICK UP PROPER VALUE FROM TABLE. 12420016
         SR    GR8,GR8                 CLEAR.                           12510016
         IC    GR8,SEQSW               CURRENT KEYWORD SEQUENCE SWITCH. 12600016
         NR    GR8,GR7                 'AND' KEYWORD CODE INTO SEQSW.   12690016
         CR    GR8,GR7                 ARE REQUIRED KEYWORDS PRESENT.   12780016
         BNE   KEYMISS                 NO--GO GIVE A MESSAGE.           12870016
         CLI   DDNAME2,BLANK           IS THIS AN UNLABELED VOLUME.     12960016
         BC    7,CHECK2                NO--MAKE MORE CHECKS.            13050016
         TM    SEQSW,NEWVOLID          YES-WAS NEW SERIAL GIVEN.        13140016
         BZ    KEYMISS                 NO--REQUIRED KEYWORDS MISSING.   13230016
         SPACE                                                          13280021
CHECK2   CLI   FUNCSW,ANALYSIS          THIS ANALYSIS?                  13410000
         BE    CHECK2A                  YES, BRANCH.                    13460000
         CLI   FUNCSW,FORMAT            THIS FORMAT?                    13510000
         BNE   CHECK1                   NO - START PROCESSING.          13560000
CHECK2A  TM    SEQSW,IPLDD              WAS IPL TEXT REQUESTED?         13610000
         BZ    CHECK1                  NO--START PROCESSING.            13680016
         CLC   DDNAME1(8),SYSINDD      INPUT VIA SYSIN.                 13770016
         BNE   CHECK1                  NO--START PROCESSING.            13860016
         OC    WIPLPTR+1(3),WIPLPTR+1  IPLTEXT POSSIBLY IN CORE ALREADY 13890016
         BC    7,CHECK1                YES-GO SET UP THIS FUNCTION.     13920016
         OI    SW1,TEXTIN              INDICATE LOOKING FOR TEXT/SYSIN. 13950016
         B     SCAN                    GO GET IPL PROGRAM.              14040016
         SPACE                                                          14130016
CHECK    TM    SW1,TEXTIN              ARE WE LOOKING FOR IPL TEXT.     14220016
         BO    NOIPLMSG                YES-GO GIVE ERROR MESSAGE.       14310016
         CLI   QCOUNT+1,0              MORE ON QUEUE YET.               14400016
         BH    MORE                    YES-GO START  AT TOP OF QUEUE.   14490016
         B     ENDALL                  NO--GO CLOSE ALL-FREE ALL.       14580016
         EJECT                                                          14850016
*   COMMAND LOOKUP ROUTINE                                              14940016
         SPACE 1                                                        15030016
OPRLUP   LA    GR3,COMDTABL            START OF COMMAND TABLE.          15120016
         LA    GR5,COMDEND             END OF COMMAND TABLE.            15210016
         OI    SW1,COMMAND             INDICATE LOOKING FOR COMMAND.    15300016
SCANTBL  STC   LENGTH,SAVLGTH          STORE LENGTH.                    15390016
         CLI   SAVLGTH,8               IS LENGTH EIGHT OR LESS.         15480016
         BH    MSGPRT                  YES-CONTROL STATEMENT ERROR.     15570016
         LA    GR4,12                  TABLE INCREMENTING VALUE.        15660016
         MVI   WURK,C' '               CLEAR SEARCH AREA.               15750021
         MVC   WURK+1(7),WURK          CLEAR REMAINING ARGUMENT AREA.   15840021
         BCTR  LENGTH,0                DECREMENT LENGTH FOR EXECUTE.    15930016
         EX    LENGTH,OPRLUP3          MOVE PARAMETER TO STORAGE AREA.  16020016
OPRCMP   CLC   WURK(8),0(GR3)          CHK IF SEARCH ARGUMENT IN TABLE. 16110021
         BNE   OPRLUP2                 NO--CONTINUE SCAN OF TABLE.      16200016
         LA    GR3,8(GR3)              POINT TO BRANCH ADDRESS.         16290016
         NI    SW1,X'FF'-COMMAND-SPEC1   RESET INDICATORS.              16380016
         BR    GR3                     ENTER PROPER ROUTINE.            16470016
OPRLUP2  BXLE  GR3,GR4,OPRCMP          LOOP TO CONTINUE SEARCH.         16560016
         TM    SW1,COMMAND             ERROR WHILE LOOKING FOR COMMAND. 16650016
         BZ    INVALKEY                YES--INVALID KEYWORD.            16740016
         NI    SW1,X'FF'-COMMAND       RESET COMMAND INDICATOR.         16830016
         B     INVALCOM                MUST BE INVALID COMMAND.         16920016
OPRLUP3  MVC   WURK(1),0(SCANADR)      MOVE IN ARGUMENT.                17010021
         SPACE 1                                                        17100016
         EJECT                                                          17730016
*   COMMAND LOOKUP TABLE                                                17820016
         SPACE                                                          17910016
         DS    0F                                                       18000016
COMDTABL DC    C'DUMP    '             START OF COMMAND WORD TABLE.     18090016
         B     DUMPCOMD                ADDRESS OF COMMAND ANALYSIS.     18180016
         DC    C'RESTORE '                                              18270016
         B     RESTCOMD                                                 18360016
         DC    C'ANALYZE '                                              18450016
         B     ANALCOMD                                                 18540016
         DC    C'FORMAT  '                                              18630016
         B     FORMCOMD                                                 18720016
         DC    C'LABEL   '                                              18810016
         B     LABLCOMD                                                 18900016
         DC    C'IPLTXT  '                                              18990016
         B     TEXTCOMD                                                 19080016
         DC    C'PUTIPL  '                                              19110000
         B     IPLPCOMD                                                 19140000
COMDEND  DC    C'GETALT  '             END OF COMMAND WORD TABLE.       19170016
         B     GETLCOMD                                                 19260016
         SPACE 3                                                        19350016
DUMPCOMD LA    GR0,DFUNSIZE            DUMP FUNCTION BLOCK SIZE.        22230016
         LA    GR5,DUMP                DUMP FUNCTION CODE.              22320016
         B     BUILDF                  GO BUILD A FUNCTION BLOCK.       22410016
         SPACE 1                                                        22500016
RESTCOMD LA    GR0,RFUNSIZE            RESTORE FUNCTION BLOCK SIZE.     22590016
         LA    GR5,RESTORE             RESTORE FUNCTION CODE            22680016
         B     BUILDF                  GO BUILD A FUNCTION BLOCK.       22770016
         SPACE 1                                                        22860016
ANALCOMD LA    GR0,AFUNSIZE            ANALYSIS FUNCTION BLOCK SIZE.    22950016
         LA    GR5,ANALYSIS            ANALYSIS FUNCTION CODE.          23040016
         B     BUILDF                  GO BUILD A FUNCTION BLOCK.       23130016
         SPACE 1                                                        23220016
FORMCOMD LA    GR0,FFUNSIZE            FORMAT FUNCTION BLOCK SIZE.      23310016
         LA    GR5,FORMAT              FORMAT FUNCTION CODE.            23400016
         B     BUILDF                  GO BUILD A FUNCTION BLOCK.       23490016
         SPACE 1                                                        23580016
LABLCOMD LA    GR0,LFUNSIZE            LABEL FUNCTION BLOCK SIZE.       23670016
         LA    GR5,LABEL               LABEL FUNCTION CODE.             23760016
         B     BUILDF                  GO BUILD A FUNCTION BLOCK.       23850016
         SPACE 1                                                        23940016
GETLCOMD LA    GR0,GFUNSIZE            GETALT FUNCTION BLOCK SIZE.      24030016
         LA    GR5,GETALT              GETALT FUNCTION CODE             24120016
         B     BUILDF                  GO BUILD A FUNCTION BLOCK.       24210016
IPLPCOMD LA    GR0,IFUNSIZE            IPLPROG FUNCTION SIZE            24230000
         LA    GR5,IPLPROG             IPLPROG FUNCTION CODE            24250000
         B     BUILDF                  GO BUILD A FUNCTION BLOCK        24270000
         EJECT                                                          24300016
TEXTCOMD CLI   FUNCSW,ANALYSIS         THIS FOLLOW FORMAT OR ANALYZE.   24390016
         BL    INVALCOM                NO--INVALID COMMAND.             24480016
         TM    SEQSW,IPLDD             WAS THERE A DDNAME GIVEN.        24570016
         BZ    INVALCOM                NO--INVALID COMMAND.             24660016
         SPACE                                                          24750016
         CLC   DDNAME1(8),SYSINDD      THIS DDNAME SAME AS FOR SYSIN.   24840016
         BNE   INVALCOM                NO--ERROR.                       24930016
         SPACE                                                          25020016
         GETMAIN R,LV=0+IPLSIZE        GET CORE TO STORE TEXT DATA.     25110016
         LR    GR4,GR1                 SAVE BUFFER ADDRESS.             25200016
         AIF  ('&LIB' EQ 'LIB1').ARONDC  THIS ASSEM FOR OS, BRCH X02912 25250002
         L     GR3,IPLMAX               GET MAX BUFFER SIZE      X02912 25260002
         AGO   .ARONDD                  BRCH AROUND OS VALUE     X02912 25270002
.ARONDC  ANOP                           BRCH POINT FOR OS CODE   X02912 25280002
         LA    GR3,IPLSIZE             SIZE OF BUFFER.                  25290016
.ARONDD  ANOP                           BRCH POINT FOR VS CODE   X02912 25340002
         BAL   GR14,CLEAR              CLEAR BUFFER TO ZERO.            25380016
         LA    GR9,CARDBUFF            ADDRESS OF IPL PROGRAM CARDS.    25470016
         USING IPLCARD,GR9                                              25560016
         LA    GR7,READ                DCB ADDRESS.                     25650016
         USING IHADCB,GR7                                               25660016
         LA    GR2,NOIPL               RETURN IF EOF ENCOUNTERED.       25670016
         ST    GR2,DCBEODAD            SET IN QSAM DCB.                 25680016
         DROP  GR7                                                      25690016
         SR    GR2,GR2                 CLEAR BYTE COUNT REGISTER.       25740016
         LR    GR5,GR4                 BUFFER ADDRESS.                  25830016
         LA    GR4,8(GR4)              SAVE ROOM FOR COUNT FIELD.       25920016
         AIF  ('&LIB' EQ 'LIB1').ARONDE  THIS ASSEM FOR OS, BRCH X02912 25970002
         LR    GR8,GR5                  GET BUFFER ADDR          X02912 25980002
         LA    GR8,0(GR8)               CLEAR HIGH BYTE          X02912 25982002
         A     GR8,IPLMAX               ADD BUFFER SIZE          X02912 25984002
         AGO   .ARONDF                  BRCH AROUND OS VALUE     X02912 25990002
.ARONDE  ANOP                           BRCH POINT FOR OS CODE   X02912 26000002
         LA    GR8,IPLSIZE(GR5)        END OF BUFFER.                   26010016
.ARONDF  ANOP                           BRCH POINT FOR VS CODE   X02912 26060002
         EJECT                                                          26100016
REREAD   GET   (GR7),(GR9)             READ IN AN IPL PROGRAM.          26190016
         SPACE                                                          26280016
         CLC   CARDTYPE,END1           THIS AN END CARD.                26370016
         BE    THEEND                  YES-DO FINAL WIND-UP.            26460016
         CLC   CARDTYPE,TXT            THIS A TEXT CARD.                26550016
         BNE   REREAD                  NO--GET NEXT CARD.               26640016
         SPACE                                                          26730016
         IC    GR2,CARDBYTE+1          BYTES//THIS CARD.                26820016
         LR    GR3,GR2                 SAVE BYTE COUNT.                 26910016
         MVC   WURK(4),CARDADDR-1      MOVE FOR ALIGNMENT.              26920021
         L     GR4,WURK                DATA ADDRESS//THIS CARD.         26930021
         AR    GR4,GR5                 ADD TO BUFFER START.             26940016
         LA    GR4,8(GR4)              COUNT FIELD LENGTH.              26950016
         AR    GR4,GR3                 UPDATE BUFFER PTR.          5567 26960018
         CLR   GR4,GR8                 END OF BUFFER REACHED.      5567 26970018
         BH    NOIPLMSG                YES-MSG/IPLTXT NO GOOD.     5567 26980018
         SR    GR4,GR3                 DECREMENT BUFF PTR FOR MOVE.5567 26990018
         BCTR  GR2,0                   DECREMENT FOR EXECUTE.           27000016
         EX    GR2,TXTMOVE             MOVE DATA TO BUFFER AREA.        27090016
         AR    GR4,GR3                 UPDATE MOVE-TO ADDRESS.          27180016
         B     REREAD                  GO GET NEXT TXT CARD.       5567 27280018
         SPACE                                                          27540016
THEEND   ST    GR5,WIPLPTR             TEXT ADDRESS TO WORK AREA.       27630016
         ST    GR5,FIPLPTR             TEXT ADDRESS TO FUNCTION BLOCK.  27720016
         NI    SW1,X'FF'-TEXTIN        SWITCH OFF//TEXT FOUND.          27810016
         B     CHECK1                  START PROCESSING THIS FUNCTION.  27900016
         SPACE                                                          27990016
TXTMOVE  MVC   0(1,GR4),CARDTEXT       USED TO MOVE IPL TEXT TO BUFFER. 28080016
         EJECT                                                          28170016
*********************************************************************** 28260016
*                                                                     * 28350016
*   THE FOLLOWING TABLE IS A LIST OF THE REQUIRED KEYWORDS            * 28440016
*     FOR EACH FUNCTION.                                              * 28530016
*                                                                     * 28620016
*********************************************************************** 28710016
KCODES   EQU   *                                                        28800000
         DC    AL1(0)                  DUMMY                            28830000
         DC    AL1(FROMDD+TODD)        DUMP                             28860000
         DC    AL1(FROMDD+TODD)        RESTORE                          28890016
         DC    AL1(TRACK+TODD)         GETALT                           28980016
         DC    AL1(NEWVOLID+TODD)      LABEL                            29070016
         DC    AL1(TODD+EXTENT+VTOC)   ANALYZE                          29160016
         DC    AL1(TODD+EXTENT+VTOC)   FORMAT                           29250016
         DC    AL1(FROMDD+TODD)        IPLPROG                          29280000
         DC    AL1(0)                                                   29310000
         SPACE 3                                                        29340016
*********************************************************************** 29430016
*                                                                     * 29520016
*   THE FOLLOWING TABLE INDICATES THE BIT SWITCH SETTINGS FOR THE     * 29610016
*     -SEQSW-. ALL THE VARIOUS KEYWORDS ARE LISTED WITH THE           * 29700016
*     SUPPORTED FUNCTIONS.                                            * 29790016
*                                                                     * 29880016
*********************************************************************** 29970016
****                                                               **** 30060016
* (BITS) *   0    .  1 .   2    .  3  .  4  .   5   .   6    .  7     * 30150016
* DUMP   * FROMDD .TODD.CPYVOLID.BEGIN. END .       .        .        * 30240016
*        *        .    .        .     .     .       .        .        * 30330016
* RESTORE* FROMDD .TODD.CPYVOLID.     .     .       .        .        * 30420016
*        *        .    .        .     .     .       .        .        * 30510016
* GETALT * TRACK  .TODD.        .     .     .       .        .        * 30600016
*        *        .    .        .     .     .       .        .        * 30690016
* LABEL  *NEWVOLID.TODD.        .     .     .OWNERID.        .        * 30780016
*        *        .    .        .     .     .       .        .        * 30870016
* ANALYZE*NEWVOLID.TODD.EXTENT  .VTOC .IPLDD.OWNERID.FLAGTEST.PASSES  * 30960016
*        *        .    .        .     .     .       .        .        * 31050016
* FORMAT *NEWVOLID.TODD.EXTENT  .VTOC .IPLDD.OWNERID.        .        * 31140016
*        *        .    .        .     .     .       .        .        * 31230016
* IPLPROG* FROMDD .TODD.        .     .     .       .        .        * 31260000
*        *        .    .        .     .     .       .        .        * 31290000
*********************************************************************** 31320016
         EJECT                                                          31410016
         SPACE                                                          33570016
         DS    0H                       FORCE ALIGNMENT                 33620021
GETCOPY  EQU   *                       PROCESS TODD COPIES HERE.        33670016
         CLI   FUNCSW,RESTORE          THIS DUMP OR RESTORE.            33840016
         BNH   GETCOPY2                YES-COPIES ALLOWED.              33930016
         CLI   FUNCSW,ANALYSIS         THIS FORMAT OR ANALYZE.          34020016
         BL    MSGPRT                  NO--MUST BE ERROR.               34110016
GETCOPY2 LA    GR0,COPYSIZE            SIZE OF COPY BLOCK.              34200016
        LR     GR5,GR1                 SAVE POINTER TO PARAMETER.       34290016
         B     GETCOPY1                GO BUILD A COPY BLOCK.           34380016
         SPACE                                                          34470016
*   GET CORE FOR A FUNCTION BLOCK AND INITIALIZE IT TO ZERO HERE.       46800016
BUILDF   LA    GR6,PTRFUNC1            ADDRESS OF FIRST FUNCTION.       46890016
         TM    SW1,TEXTIN              WERE WE LOOKING FOR IPL TEXT.    46920016
         BO    NOIPLMSG                YES--MUST BE ERROR.              46950016
         SPACE 1                                                        46980016
BUILDF1 TM     0(GR6),ACTIVE           IS THIS SLOT AVAILABLE.          47070016
         BZ    BUILDF2                 YES-NOT ACTIVE OR WAITING.       47160016
         LA    GR6,CSIZE(GR6)          POINT TO NEXT ENTRY.             47250016
         B     BUILDF1                 GO FIND AN EMPTY SLOT.           47340016
         SPACE 1                                                        47430016
BUILDF2  LR    GR3,GR0                 FUNCTION BLOCK SIZE.             47520016
         GETMAIN R,LV=(0)                                               47610016
         LR    GR10,GR1                FUNCTION BLOCK ADDRESS.          47700016
         ST    GR1,0(GR6)              FUNCTION BLOCK ADDRESS TO LIST.  47790016
         LR    GR4,GR3                 SAVE THE FUNCTION BLOCK SIZE.    47880016
         BAL   GR14,CLEAR              CLEAR FUNCTION BLOCK TO ZERO.    47970016
         STH   GR4,FSIZE               SAVE SIZE OF FUNCTION BLOCK.     48060016
         MVI   DDNAME1,BLANK           BLANK 1ST BLANK OF DDNAME SLOTS. 48150016
         MVC   DDNAME1+1(15),DDNAME1   BLANK REMAINING PORTION.         48240016
         MVI   0(GR6),ACTIVE           SET ACTIVE STATUS THIS FUNCTION. 48330016
         SPACE 1                                                        48420016
         STC   GR5,FUNCSW              INDICATE WHICH FUNCTION THIS IS. 48510016
         L     GR5,KONSTANT            ADDRESS OF DEVICE CONSTANTS.     48600016
         ST    GR5,IODEVCON            INSERT ADDRESS IN FUNCTION BLOCK 48690016
         LH    GR5,QCOUNT              CURRENT QUEUE COUNT              48780016
         LA    GR5,1(GR5)              INCREMENT BY ONE.                48870016
         STH   GR5,QCOUNT              SAVE THIS VALUE.                 48960016
         B     SCAN3                   COMPLETE SCAN OF CARD.           49050016
         EJECT                                                          49140016
* GET CORE FOR A COPY BLOCK AND INITIALIZE IT TO ZERO                   49230016
         SPACE 1                                                        49320016
GETCOPY1 GETMAIN R,LV=(0)                                               49410016
         LR    GR8,GR1                 POINTER TO COPY BLOCK.           49500016
         LA    GR3,COPYSIZE            SIZE OF COPY BLOCK.              49590016
         LR    GR4,GR2                 SAVE CONTENTS OF GR2.            49680016
         BAL   GR14,CLEAR              CLEAR COPY BLOCK TO ZERO.        49770016
        LR     GR1,GR5                 RESTORE POINTER TO PARAMETER.    49860016
         LR    GR2,GR4                 RESTORE REGISTER.                49950016
         SPACE 1                                                        50040016
         L     GR5,COPYPTR             ADDRESS OF COPY BLOCK, IF ANY.   50130016
         LTR   GR5,GR5                 IS THERE A PREVIOUS COPY BLOCK.  50220016
         BZ    NOCOPY                  NO--THIS IS THE FIRST COPY BLOCK 50310016
TESTCOPY CLC   CDISP(4,GR5),ZERO       THIS LAST COPY BLOCK IN CHAIN.   50400016
         BE    OKCOPY                  YES-GO SET UP POINTERS.          50490016
         L     GR5,CDISP(GR5)          NO--STEP TO NEXT COPY BLOCK.     50580016
         B     TESTCOPY                REPEAT UNTIL LAST IS FOUND.      50670016
         SPACE 1                                                        50760016
OKCOPY   ST    GR8,CDISP(GR5)          ADDRESS OF NEXT COPY TO PRIOR.   50850016
         ST    GR5,CFUNPTR-COPYBLK(GR8) ADDRESS OF PRIOR TO NEXT.       50940016
OKCOPY1  OI    0(GR6),COPIES           INDICATE COPIES INVOLVED.        51030016
         MVI   DDNAME3,BLANK           BLANK 1ST BYTE DDNAME SLOT.      51120016
         MVC   DDNAME3+1(7),DDNAME3    BLANK REMAINING PORTION.         51210016
         LA    GR4,DDNAME3             DDNAME SLOT ADDRESS.             51300016
         TM    SW1,SPEC1               THIS AN SPECIAL REQUEST.         51330016
         BO    ALLSET1                 YES--MOVE IN ON OFF-SET.         51360016
         B     MOVEP                   GO MOVE IN THE DDNAME.           51390016
         SPACE                                                          51480016
NOCOPY   ST    GR8,COPYPTR             COPY ADDRESS TO FUNCTION BLOCK.  51570016
         ST    GR10,CFUNPTR            FUNCTION BLOCK ADDRESS/1ST COPY. 51660016
         B     OKCOPY1                 GO COMPLETE COPY BLOCK.          51750016
         SPACE 1                                                        51800021
ALLSET1  LA    GR4,1(GR4)               PARAMETER MOVE TO ADDRESS       51810021
MOVEP    EX    GR2,PMOVE                MOVE DDNAME TO FUNCTION BLOCK   51820021
         B     SCAN3                    CONTINUE SCAN                   51830021
         EJECT                                                          51840016
CHECK1   TM    SW1,TEXTIN              WAS REQUIRED IPL TEXT FOUND.     51930016
         BO    NOIPLMSG                NO--GO GIVE ERROR MESSAGE.       52020016
         CLI   FUNCSW,RESTORE          IS THERE A FROM DDNAME.          52110016
         BNH   TESTFROM                 YES, GET FROMDD INFORMATION     52200000
         CLI   FUNCSW,IPLPROG           IS THERE A FROMDD?              52260000
         BNE   TODEVICE                 NO- GO CHECK TODD               52320000
TESTFROM LA    GR3,DDNAME1              YES-ADDRESS OF FROM-DDNAME.     52380000
         BAL   GR14,UCBFIND            FIND THE UCB ADDRESS.            52470016
         AIF   ('&LIB' EQ 'LIB1').WIN01 BRCH IF OS ASSEM        XL03130 52480003
         BAL   GR14,DEVTST              TEST UCB DEV TYPE       XL03130 52520003
         STC   GR3,IDEVMOD              STORE WINCHESTR MOD NO. XL03130 52530003
.WIN01   ANOP                           BRCH POINT FOR OS ASSEM XL03130 52540003
         ST    GR9,FUCBPTR             SAVE IT IN THE FUNCTION BLOCK.   52560016
         SPACE                                                          52650016
TODEVICE LA    GR3,DDNAME2             ADDRESS OF TO-DDNAME.            52740016
         BAL   GR14,UCBFIND            FIND THE UCB ADDRESS.            52830016
         USING UCB,GR9                                          XL03130 52830503
         AIF   ('&LIB' EQ 'LIB1').WIN02 BRCH IF OS ASSEM        XL03130 52880003
         TM    SEQSW+L1,SS1VAL          SS/1 ANALYSIS          @Y30LSFY 52880503
         BZ    NOTSS1E                  NO                     @Y30LSFY 52881003
*        SS/1 ANALYSIS CAN ONLY BE PERFORMED ON 3330 OR        @Y30LSFY 52881503
*        3330-1.                                               @Y30LSFY 52882003
         CLI   UCBTBYT4,MERLIN          3330?                  @Y30LSFY 52882503
         BE    NOTSS1E                  YES - OK               @Y30LSFY 52883003
         CLI   UCBTBYT4,ICEBERG         3330-1?                @Y30LSFY 52883503
         BE    NOTSS1E                  YES - OK               @Y30LSFY 52884003
*        PRINT MESSAGE IEH833I.                                @Y30LSFY 52884503
         LA    GR1,MESS33               LOAD ERR NO.           @Y30LSFY 52885003
         BAL   GR9,BUILD                GO BUILD MESSAGE       @Y30LSFY 52885503
         MVC   D0(L3,GR1),DDNAME2+L1    FILL IN CUU            @Y30LSFY 52885703
         B     MSGWRT                   GO WRITE MESSAGE       @Y30LSFY 52886003
NOTSS1E  EQU   *                                               @Y30LSFY 52886503
         BAL   GR14,DEVTST              TEST UCB DEV TYPE       XL03130 52890003
         STC   GR3,ODEVMOD              STORE WINCHESTR MOD NO. XL03130 52900003
.WIN02   ANOP                           BRCH POINT FOR OS ASSEM XL03130 52910003
         ST    GR9,TUCBPTR             SAVE IT IN THE FUNCTION BLOCK.   52920016
         LA   GR3,DDNAME2               LOAD ADDR OF TODD-NAME  XL03130 52930003
         BAL   GR14,TESTUSR             TEST IF OTHER USERS     XM7053  52970002
         TM    0(GR6),COPIES           ARE THERE COPIES INVOLVED.       53010016
         BZ    TOD2                    NO--NO NEED TO LOOK UP UCB'S.    53100016
         L     GR8,COPYPTR             COPY BLOCK ADDRESS.              53190016
TOD1     LA    GR3,DDNAME3             COPY DDNAME ADDRESS.             53280016
         BAL   GR14,UCBFIND            LOCATE ADDRESS OF UCB.           53370016
         AIF   ('&LIB' EQ 'LIB1').WIN03 BRCH IF OS ASSEM        XL03130 53420003
         BAL   GR14,DEVTST              TEST UCB DEV TYPE       XL03130 53430003
         STC   GR3,CDEVMOD              STORE WINCHESTR MOD NO. XL03130 53440003
.WIN03   ANOP                           BRCH POINT FOR OS ASSEM XL03130 53450003
         ST    GR9,CUCBPTR             SAVE ADDRESS IN COPY BLOCK.      53460016
         LA    GR3,DDNAME3              COPY DDNAME ADDR        XL03130 53470003
         BAL   GR14,TESTUSR             TEST IF OTHER USERS     XM7053  53510002
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           53550016
         BZ    TOD2                    NO--GO START PROCESSING.         53640016
         L     GR8,CCOPYPTR            YES-ADDRESS OF NEXT COPY.        53730016
         B     TOD1                    REPEAT COPY UCB LOOK UP.         53820016
         AIF   ('&LIB' EQ 'LIB1').WIN04 BRCH IF OS ASSEM        XL03130 53822003
         EJECT                                                  XL03130 53830003
DEVTST   EQU   *                                                XL03130 53850003
         CLC   SYSOUTDD,D0(GR3)        SYSPRINT D/S ?          @VS40035 53851003
         BE    NOWINC                  YES, EXIT               @VS40035 53852003
         CLI   UCBTBYT4,MERLIN          CAN THIS DEV BE EMU ?  @Z30RSAG 53860003
         BL    NOWINC                   NO, ZERO ODEVMOD       @Z30RSAG 53862003
         TM    UCBFL1,UCBNRY            THIS UNIT READY?        VS06562 53862402
         BNO   ISSUSVC                  NO, ISSUE SVC 82        VS06562 53862802
         CLI   D0(GR3),BLANK            OFFLINE FUNCTION?       VS06562 53863202
         BNE   RDJOPEN                  NO, READ JFCB + OPEN    VS06562 53863602
*                                       TO FORCE MOUNT MSG.     VS06562 53863702
ISSUSVC  EQU   *                                                VS06562 53863802
         SR   GR3,GR3                   ZERO REG FOR NON-WINCH  XM3782  53864002
         LA    GR1,WURK                 LOAD SVC P.L. ADDR      XL03130 53872003
         XC    WURK,WURK                ZERO PARAM LIST         XL03130 53874003
         ST    GR9,WURK                 STORE UCB ADDR          XL03130 53876003
         MVI   WURK,SENS                SET P.L. FUNCTION TYPE  XL03130 53878403
         ST    GR10,WURK+D4            SAVE FUNCBLK ADDR       @Z30RSAG 53878803
         MVI   WURK+D4,ENDPL            SET END OF P.L.         XL03130 53879203
         SVC   82                       ISSUE SENSE FOR WINCH.  XL03130 53879403
         LTR   GR15,GR15                GOOD RETURN             XL03130 53879603
         BNZ   WINERR                   NO, PRINT SVC ERROR MSG XL03130 53879703
         L     GR3,WURK+D4              GET MODEL NO. FROM P.L. XL03130 53879803
         LA    GR3,D0(GR3)              CLEAR HIGH BYTE         XL03130 53880903
NOWINC   EQU   *                                                XL03130 53881303
         BR    GR14                     EXIT THIS RTNE.         XL03130 53882903
WINERR   EQU   *                                                XL03130 53885703
         LA    GR1,MESS13               LOAD ERR NO.            XL03130 53885803
         BAL   GR9,BUILD                GO BUILD MESSAGE        XL03130 53885903
         MVC   0(2,GR1),SVCTYP          MOVE SVC NO. TO MSG     XL03130 53888903
         B     MSGWRT                   GO WRITE MSG            XL03130 53891303
         EJECT                                                          53891702
         USING IHADCB,GR5                                       VS06562 53892202
RDJOPEN  EQU   *                                                VS06562 53893502
         LA    GR5,OUTDCB               PT TO DUMMY DCB         VS06562 53893902
         MVC   DCBDDNAM(L8),D0(GR3)     MOVE IN DDNAME          VS06562 53894002
         LA    GR4,JFCBEND-JFCB         COMPUTE JFCB LENGTH     VS06562 53894502
         GETMAIN R,LV=(GR4)                                             53895002
         LR    GR4,GR1                  SAVE BUFF PTR           VS06562 53897402
         ST    GR4,LIST                 STORE PTR TO LIST       VS06562 53897802
         MVI   LIST,X'87'               RESET FLAG              VS06562 53897902
         RDJFCB MF=(E,OPENLD)                                           53898602
         SPACE                                                          53899002
         USING JFCB,GR4                                                 53899402
         MVI   JFCBDSNM,FORMAT4         SETUP DSN FOR F4 DSCB   VS06562 53899802
         MVC   JFCBDSNM+L1(L43),JFCBDSNM MOVE 04 THRU NAME FLD VS06562  53900202
         OI    JFCBTSDM,JFCNWRIT        DONT REWRITE JFCB       VS06562 53900302
*                                                                       53900402
         OPEN  MF=(E,OPENLD),TYPE=J                             VS06562 53900602
         NI    DCBMACRF+L1,X'F3'        DONT WRITE EOF AT CLOSE VS06562 53901202
         CLOSE MF=(E,OPENLD)                                    VS06562 53901602
         LA    GR5,JFCBEND-JFCB         COMPUTE AREA SIZE       VS06562 53901902
         FREEMAIN R,LV=(GR5),A=(GR4)                            VS06562 53902002
         B     ISSUSVC                  GO ISSUE SVC 82         VS06562 53902202
         DROP  GR4,GR5                                          VS06562 53902302
         SPACE                                                          53902402
LIST     DS    0F                                                       53902502
         DC    X'87'                                                    53902602
         DC    AL3(0)                                                   53902702
         SPACE                                                          53906102
OPENLD   RDJFCB (OUTDCB,(OUTPUT)),MF=L                          VS06562 53908102
         EJECT                                                          53910102
.WIN04   ANOP                                                   XL03130 53910402
TESTUSR  EQU   *                                                XM7053  53913902
         CLI   UCBTBYT3,DASDI           IS TODD A DASD?         XM7053  53917402
         BCR   7,GR14                   NO, RETURN              XM7053  53920902
         CLC   SYSOUTDD(8),DDNAME2      TODD=SYSPRINT ?         YM01130 53924402
         BCR   8,GR14                   BRCH IF YES             YM01130 53927902
         BAL   GR7,SERIALZ              GET EXCLUSIVE CTL.      YM01130 53931402
         AIF   ('&LIB' EQ 'LIB1').OSCODE   BRCH IF OS ASSEM     XM7053  53934902
         CLI   FUNCSW,IPLPROG           THIS PUTIPL FUNCTION ?  XM0148  53938402
         BCR   8,GR14                   BRCH IF YES             XM7053  53941902
.OSCODE  ANOP                                                   XM7053  53945402
         CLI   FUNCSW,LABEL             THIS LABEL FUNCTION ?   XM7053  53948902
         BCR   8,GR14                   BRCH IF YES             XM7053  53952402
         CLC   SRTEUSER,ALLOCNT         ARE THERE OTHER SYSTEM  YM5770  53955902
*                                       USERS ON THIS PACK?     XM7053  53959402
         BCR   13,GR14                  BRCH IF NO OTHERS       XM7053  53962902
         DROP GR9                                               XM7053  53966402
MSG851   EQU   *                                                YL02912 53969902
         LA    GR1,MESS51               LOAD ERROR MSG NUMBER   XM7053  53973402
         B     BLDMSG                   GO BUILD MSG            YL02912 53976902
         EJECT                                                          53980402
**********************************************************************  53983902
*        THE FOLLOWING ROUTINE WILL CAUSE 'DASDR TO GET         YL02912 53987402
*        EXCLUSIVE CONTROL OF THE TODD= UCB.                    YL02912 53990902
**********************************************************************  53994402
SERIALZ  EQU   *                                                YL02912 53997902
         CLI   0(GR3),BLANK             OFFLINE REQUEST ?       YL02912 54001402
         BCR   8,GR7                    YES, BRCH               YM01130 54004902
         ST    GR9,WORKD8               LOAD UCB ADDR IN P.L.   YL02912 54008402
         MVI   WORKD8,ENQ               SET ONLINE P.L. FLAG    YL02912 54011902
         MVI   WORKD8+L4,ENDPL          SET END OF P.L. FLAG    YL02912 54012302
         LA    GR1,WORKD8               LOAD P.L. PTR           YL02912 54012702
         SVC   ENQDEQ                   GO ENQ ON VOLID         YL02912 54013902
         LTR   GR15,GR15                GOOD RETURN FROM ENQ ?  YL02912 54014302
         BCR   8,GR7                    YES, BRCH               YM01130 54014702
         LA    GR1,MESS54               SET 'ALREADY ENQED' MSG YL02912 54014802
         B     BLDMSG                  SOMEONE ELSE HAS DEVICE  YL02912 54022602
         EJECT                                                  YL02912 54025202
TOD2     LA    GR6,PTRFUNC1            POINT TO FIRST FUNCTION ON Q.    54142601
         SPACE                                                          54180016
START1   OI    SW1,MULTIPLE            TRY FOR CONCURRENT PROCESSING.   54270016
START2   L     GR10,0(GR6)             ADDRESS OF FUNCTION BLOCK.       54360016
         LA    GR10,0(GR10)            INSURE HIGH ORDER BYTE CLEAR.    54400016
         IC    GR5,SW1                 TEMPORARY STORAGE OF SWITCH.     54450016
         ST    GR6,PTRCFUNC            ADDRESS OF CURRENT FUNCTION.     54540016
         STC   GR5,SW1                 RESTORE SWITCH SETTING.          54630016
         SR    GR7,GR7                 CLEAR.                           54720016
         IC    GR7,FUNCSW              INDICATE LOAD MODULES            54810003
         SRA   GR7,1                   MULTIPLE OF 8.                   54900016
         LA    GR8,LINKADDR            BRANCH TABLE MINUS 8.            54990016
         LA    GR8,0(GR7,GR8)          ADDRESS OF MODULE NAME.          55080016
         CLC   0(8,GR8),LINKADDR       PREVIOUSLY LOADED?               55170016
         BNE   MUSTLOAD                NO--ROUTINE NOT IN CORE YET.     55260016
         L     GR15,LOADADDR           PICK UP ADDRESS OF ROUTINE.      55350016
         B     GOTO                    START PROCESSING OF FUNCTION.    55440016
         SPACE                                                          55530016
MUSTLOAD CLI   LINKADDR,0              NO--ANOTHER LOADED?              55620016
         BE    LOAD                    NO--GO LOAD DESIRED ROUTINE.     55710016
         SPACE                                                          55800016
         DELETE EPLOC=LINKADDR         YES-FREE THE SPACE.              55890016
LOAD     MVC   LINKADDR(8),0(GR8)      SET UP LOAD ADDRESS.             55980016
         LOAD  EPLOC=LINKADDR                                           56070016
         ST    GR0,LOADADDR            SAVE ADDRESS OF ROUTINE.         56160016
         LR    GR15,GR0                ADDRESS OF DESIRED LOAD.         56250016
GOTO     EQU   *                                                YM01130 56260002
         CLI   DDNAME2,BLANK            OFFLINE FUNCTION ?      YM01130 56300002
         BNE   NOESTAE                  NO, DONOT ISSUE ESTAE   YM01130 56310002
         TM    DONESTAE,X'FF'           ESTAE DONE?            @ZA27199 56320099
         BO    ESTAEDON                 YES, THEN DONT MORE    @ZA27199 56322099
         BAL   GR7,ESTAE                GO ISSUE ESTAE          YM01130 56324099
         MVI   DONESTAE,X'FF'           INDICATE ESTAE DONE    @ZA27199 56326099
ESTAEDON L     GR15,LOADADDR            RELOAD GR15            @ZA27199 56328099
NOESTAE  EQU   *                                                YM01130 56332002
         BALR  GR14,GR15                                                56340002
         SPACE                                                          56430016
         LTR   GR15,GR15               RETURN CODE EQUAL ZERO.          56520016
         BC    7,FERROR                NO--MUST BE SOMETHING UNUSUAL.   56610016
         SPACE                                                          56700016
         L     GR6,PTRCFUNC            POINTER TO QUEUE ENTRY.          56790016
        LA     GR6,0(GR6)              CLEAR HIGH ORDER BYTE.           56880016
         TM    0(GR6),COMPLETE         DID WE COMPLETE THIS FUNCTION.   56970016
         BZ    TESTMORE                NO--BETTER TEST FOR MORE ON Q.   57060016
         SPACE                                                          57150016
ENDFUNC1 EQU   *                                                YL02912 57200002
         SR    GR14,GR14               CLEAR.                           57240002
         IC    GR14,RETCODE            CURRENT HIGH RETURN CODE.        57330016
         CLR   GR14,GR15               IS OLD HIGHER THAN NEW.          57420016
         BNL   ENDFUNC                 YES-NO NEED TO SAVE.             57510016
         STC   GR15,RETCODE            SAVE RETURN CODE.                57600016
ENDFUNC  BAL   GR14,FREECORE           YES-FREE CORE ASSIGNED FUNCTION. 57690016
         SPACE                                                          57780016
         CLI   QCOUNT+1,0              MORE ON THE QUEUE                57870016
         BE    TESTEOF                 NO--GO TEST FOR END-OF-FILE.     57960016
         SPACE                                                          58050016
PUSHUP   CL    GR6,ENDCLIST            ARE THERE MORE ENTRIES.          58140016
         BE    TESTEOF1                NO--NO NEED TO UPDATE THE QUEUE. 58230016
         SPACE                                                          58320016
         TM    CSIZE(GR6),ACTIVE       ACTIVE FUNCTION ON NEXT SLOT.    58410016
         BZ    TESTEOF1                NO--NO NEED TO UPDATE THE QUEUE. 58500016
         MVC   0(CSIZE,GR6),CSIZE(GR6) SLIDE EVERYTHING ON THE QUEUE UP 58590016
*                                        ONE SLOT.                      58680016
         NI    0(GR6),X'FF'-NOCORE-WAITING  CLEAR ANY WAIT SWITCHES.    58770016
         LA    GR6,CSIZE(GR6)          INCREMENT TO THE NEXT ENTRY.     58860016
         B     PUSHUP                  GO TEST FOR MORE ENTRIES.        58950016
         SPACE                                                          59040016
TESTEOF  TM    SWITCHRD,EOF            PREVIOUS END-OF-FILE.            59130016
         BO    ENDALL                  YES-MUST BE ALL WOUND-UP.        59220016
         B     SCANA                   GO SCAN MORE CARDS.              59310016
         SPACE                                                          59400016
TESTMORE TM    CSIZE(GR6),ACTIVE       IS THE NEXT SLOT ACTIVE.         59490016
         BZ    CKSPACE                 NO--GO TEST FOR MORE SPACE.      59580016
         SPACE                                                          59670016
         TM    CSIZE(GR6),PROCESS      NEXT FUNCTION ALREADY IN PROCESS 59760016
         LA    GR6,CSIZE(GR6)          STEP TO NEXT QUEUE SLOT.         59850016
         BO    NEXTPROC                YES-GET READY TO CONTINUE IT.    59940016
         SPACE                                                          60030016
         TM    0(GR6),NOCORE           NEXT FUNCTION PREVIOUSLY         60120016
*                                        TERMINATED BECAUSE OF          60210016
*                                        INSUFFICIENT CORE.             60300016
         L     GR10,0(GR6)             POINTER TO NEXT FUNCTION BLOCK.  60390016
         BO    SETWAIT                 YES-DON'T TRY TO RESTART NOW.    60480016
         SPACE                                                          60570016
NOTFIRST LA    GR5,PTRFUNC1            ADDDRESS OF FIRST SLOT IN QUEUE. 60660016
REPEAT   L     GR3,0(GR5)              POINTER TO NEXT FUNCTION BLOCK.  60750016
         CLC   FUNCSW(1),FUNCSW-FUNCBLK(GR3)  NEXT FUNCTION SAME.       60840016
         BNE   SETWAIT                 NO--GO BACK TO TOP OF QUEUE.     60930016
*   CHECK FOR DEVICES BEING AVAILABLE HERE.                             61020016
*     IF YES, SET UP FOR NEXT FUNCTION AT 'NEXTPROC'.                   61110016
*     IF NOT, GO TO 'SETWAIT'.                                          61200016
         SPACE                                                          61290016
         L     GR4,FUCBPTR             NEXT 'FROM' DEVICE.              61380016
         LTR   GR4,GR4                 IS THERE ONE.                    61470016
         BZ    TESTTO                  NO--DO NOT COMPARE.              61560016
         BAL   GR14,TESTDEV            'FROM' VERSUS ALL OTHERS.        61650016
         SPACE                                                          61740016
TESTTO   L     GR4,TUCBPTR             NEXT 'TO' DEVICE                 61830016
         BAL   GR14,TESTDEV            TEST AVAILABILITY.               61920016
         SPACE                                                          62010016
         TM    0(GR6),COPIES           THIS NEXT FUNCTION HAVE COPIES.  62100016
         BZ    TESTEND1                NO--GO SEE IF ALL COMPARES DONE. 62190016
         SPACE                                                          62280016
         L     GR8,COPYPTR             ADDDRESS OF COPY BLOCK.          62370016
REPEAT1  L     GR4,CUCBPTR             'COPY' UCB ADDRESS.              62460016
         BAL   GR14,TESTDEV            GO TEST AVAILABILITY.            62550016
         L     GR8,CCOPYPTR            ADDRESS OF NEXT COPY BLOCK,      62640016
         LTR   GR8,GR8                 IS THERE A COPY.                 62730016
         BNZ   REPEAT1                 YES-REPEAT TESTS.                62820016
         SPACE                                                          62910016
TESTEND1 LA    GR5,CSIZE(GR5)          STEP TO NEXT QUEUE SLOT.         63000016
         CLR   GR5,GR6                 ALL DEVICES TESTED.              63090016
         BNE   REPEAT                  NO--REPEAT TESTS VS NEXT SLOT.   63180016
         SPACE                                                          63270016
BYTES0   EQU   10000                   BUFFER SIZES//CONTROL BLOCKS.    63280016
         GETMAIN EC,LV=BYTES0,A=ANSWER                                  63290016
         LTR   GR15,GR15               IS THERE SUFFICIENT CORE.        63300016
         BNE   SETWAIT                 NO--CANN'T START NEXT FUNCTION.  63310016
         FREEMAIN  E,LV=BYTES0,A=ANSWER                                 63320016
NEXTPROC EQU   *                       OKAY TO START NEXT FUNCTION.     63360016
         B     START1                  GO START NEXT FUNCTION.          63450016
         EJECT                                                          63460002
         SPACE                                                          63540016
DELDEB   EQU   *                                                DELEDEB 63590002
         ST    GR5,WORKD8+L4            STORE DEB ADDR IN PL    DELEDEB 63600002
         MVI   WURK,DEDEB               SET FUNC BYTE           DELEDEB 63610002
         MVI   WORKD8+L4,ENDPL          SET END OF PL           DELEDEB 63620002
         LA    GR1,WURK                 LOAD P.L. ADDR          DELEDEB 63620402
         SVC   ENQDEQ                   ISSUE SVC 82            DELEDEB 63622002
         BR    GR2                     RETURN                  @ZA03380 63624003
         SPACE                                                          63626002
FERROR   TM    0(GR6),NOCORE           INSUFFICIENT CORE FOR PREVIOUS   63630016
*                                        FUNCTION.                      63720016
         BZ    ENDFUNC1                NO--MUST HAVE ERROR CONDITION.   63810016
         LA    GR7,PTRFUNC1            ADDRESS OF FIRST QUEUE SLOT.     63990016
         CLR   GR6,GR7                 IS THIS FIRST FUNCTION OF QUEUE. 64080016
         BE    COREMSG                 YES-NO HOPE FOR THIS FUNCTION.   64170016
MORE     CLI   QCOUNT+1,1              MORE THAN ONE ON QUEUE.          64350016
         BH    STARTTOP                YES-GO START AT TOP OF QUEUE.    64440016
MORE1    NI    SW1,X'FF'-MULTIPLE      NO--ONLY ONE/TURN OFF MULTIPLE   64530016
*                                        SWITCH.                        64620016
STARTTOP LA    GR6,PTRFUNC1            TOP OF QUEUE ADDRESS.            64710016
         OC    PTRFUNC1(4),PTRFUNC1     IS THIS FUNCTION         A42499 64730021
*                                          SET TO ZERO                  64750021
         BZ    PUSHUP                   YES, GO TO PUSH UP QUEUE A42499 64770021
         B     START2                  GO START PROCESSING.             64800016
SETWAIT  OI    0(GR6),WAITING          SET EAIT FOR THIS FUNCTION.      64980016
        LA     GR7,PTRFUNC1            ADDRESS OF FIRST ENTRY ON QUEUE. 65070016
        CLR    GR6,GR7                 PREVIOUS FUNCTION THE ONLY ONE.  65160016
        BE     MORE1                   YES-CANNOT DO MORE THAN ONE NOW. 65250016
        B      MORE                 NO--GO START AT TOP OF QUEUE.       65340016
CKSPACE  L     GR7,ENDCLIST            END OF QUEUE POINTER.            65520016
         CLR   GR6,GR7                 IS THIS THE LAST SLOT.           65610016
         BE    MORE                    YES-CANNOT QUEUE UP ANY MORE.    65700016
         B     TESTEOF2                GO TEST FOR PREVIOUS END-OF-FILE 65790016
         SPACE                                                          65880016
TESTEOF1 XC    0(4,GR6),0(GR6)         INSURE THIS ENTRY CLEAR.         65970016
TESTEOF2 TM    SWITCHRD,EOF            EOF YET ON SYSIN.                66060016
         BZ    SCANA                   NO--GET NEXT CONTROL STATEMENT   66150016
*                                        AND PLACE IT ON THE QUEUE.     66240016
         B     MORE                    YES--GO FINISH THE FUNCTION WE   66330016
*                                        ARE WORKING ON.                66420016
*        TEST FOR SAME DEVICE AS PREVIOUSLY IN USE.                     66600016
TESTDEV  CL    GR4,FUCBPTR-FUNCBLK(GR3)  COMPARE 'NEW' FROM VS OLD FROM 66690016
         BE    SETWAIT                 SAME//CAN'T START FUNCTION NOW.  66780016
         CL    GR4,TUCBPTR-FUNCBLK(GR3)  COMPARE NEW VS PREVIOUS 'TO'.  66870016
         BE    SETWAIT                 SAME//CAN'T START FUNCTION NOW.  66960016
         SPACE                                                          67050016
         L     GR1,COPYPTR-FUNCBLK(GR3)  POINTER TO COPY BLOCK.         67100016
         DROP  8                                                        67150016
         USING COPYBLK,GR1                                              67200016
TESTCPYY LTR   GR1,GR1                 WAS THERE A COPY.                67250016
         BCR   8,GR14                  NO--RETURN.                      67320016
         SPACE                                                          67410016
         CL    GR4,CUCBPTR             COMPARE NEW DEVICE VS OLD COPY.  67500016
         BE    SETWAIT                 SAME//CAN'T START FUNCTION NOW.  67590016
         L     GR1,CCOPYPTR            POINTER TO NEXT COPY, IF ANY.    67630016
         DROP  1                                                        67670016
         USING COPYBLK,GR8                                              67710016
         B     TESTCPYY                REPEAT COMPARES.                 67770016
         SPACE 1                                                        67860016
ENDALL   LA    GR1,MESS39              MESSAGE NUMBER 839.              67950016
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         68040016
         SR    GR15,GR15               CLEAR.                           68130016
         IC    GR15,RETCODE            RETURN CODE.                     68220016
         CVD   GR15,WORKD8             CONVERT TO DECIMAL.              68310021
         UNPK  1(2,GR1),WORKD8+6(2)    CONVERT TO GRAPHICS AND MOVE.    68400021
         OI    2(GR1),X'F0'            RESET ZONE.                      68490016
         BAL   GR9,ERRPRINT            GO WRITE OUT THE MESSAGE.        68580016
         CLOSE (READ,,PRINT)           CLOSE INPUT AND OUTPUT DATA SETS 68670016
         LA    GR1,READ                SYSIN DCB ADDRESS.               68690016
         BAL   GR9,FREEPOOL            FREE THE SYSIN BUFFER POOLS.     68700016
         LA    GR1,PRINT               SYSOUT DCB ADDRESS.              68710016
         BAL   GR9,FREEPOOL            FREE THE SYSOUT BUFFER POOLS.    68720016
         L     GR1,WIPLPTR             POINTER TO IPL BUFFER, IF ANY.   68726016
         LTR   GR1,GR1                 IS THERE AN IPL BUFFER.          68732016
         BZ    FREEWORK                NO--                             68738016
         AIF  ('&LIB' EQ 'LIB1').ARONDG  THIS ASSEM FOR OS, BRCH X02912 68740002
         L     GR0,IPLMAX               GET MAX BUFFER SIZE      X02912 68742002
         AGO   .ARONDH                  BRCH AROUND OS VALUE     X02912 68742402
.ARONDG  ANOP                           BRCH POINT FOR OS CODE   X02912 68742802
         LA    GR0,IPLSIZE             SIZE OF BUFFER.                  68744016
.ARONDH  ANOP                           BRCH POINT FOR VS CODE   X02912 68746002
         BAL   GR9,FREEBUFF            RELEASE THE CORE.                68750016
         SPACE 1                                                        68760016
FREEWORK EQU   *                       FREE WORK AREA//EXIT HERE.       69060016
         L     GR13,ROOTSAVE+4         RESTORE REGISTER 13.             69390016
         CLI   PAGESW,X'FF'            WAS PAGE NO. PASSED TO ROUTINE.  69480016
         BNE   RETURN1                 NO--RESTORE/RETURN.              69570016
         L     GR1,24(GR13)            YES-POINTER TO PASSED PARAMETERS 69660016
         L     GR1,8(GR1)              POINTER TO PAGE NUMBER.          69750016
         LH    GR6,PAGENO              CURRENT PAGE NO.                 69840016
         CVD   GR6,WORKD8              CONVERT TO DECIMAL.              69930021
         UNPK  3(3,GR1),WORKD8+6(2)    CONVERT TO GRAPHICS AND MOVE.    70020021
         OI    5(GR1),X'F0'            RESET ZONE.                      70110016
RETURN1  EQU   *                       EXIT FROM THE PROGRAM HERE.      70130016
         CLI   LINKADDR,0              ANY MODULES LOADED        A53137 70140000
         BE    RETURN2                 NO, GO RETURN             A53137 70142000
         DELETE EPLOC=LINKADDR         DELETE LAST MODULE        A53137 70144000
         MVI   LINKADDR,0              SET 'NO MODULES LOADED'.  A59759 70146021
         XC    LOADADDR(4),LOADADDR    CLEAR LOAD ADDRESS.       A59759 70148021
RETURN2  LR    GR1,WORKBASE            ADDRESS OF WORKAREA.      A53137 70150000
         LA    GR0,WORKSIZE            SIZE OF WORKAREA.                70170016
         BAL   GR9,FREEBUFF            FREE THE WORK AREA CORE.         70190016
         SR    GR15,GR15               CLEAR.                           70210016
         IC    GR15,RETCODE            HIGHEST RETURN CODE.             70230016
         MVI   DONESTAE,X'00'          RESET DONESTAE SWITCH   @ZA27199 70240099
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN W/PROPER CODE.    70250016
         SPACE 1                                                        70290016
         EJECT                                                          70380016
*********************************************************************** 70470016
*   THIS SECTION FREES THE CORE OF THE FUNTION BLOCK AND COPY BLOCKS,   70650016
*     IF ANY, FOR THE JUST COMPLETED FUNCTION.                          70740016
*                                                                     * 70830016
*   REGISTER 6 MUST POINT TO THE PROPER CONTROL LIST FOR THIS         * 70920016
*     FUNCTION UPON ENTRY.                                            * 71010016
*   REGISTER 14 IS THE RETURN REGISTER.                               * 71100016
*********************************************************************** 71280016
FREECORE LTR   GR10,GR10               IS THERE A FUNCTION BLOCK.       71370016
         BCR   8,GR14                  NO--RETURN.                      71460016
         TM    0(GR6),COPIES           ARE THERE COPIES INVOLVED.       71550016
         BZ    FREEFUNC                NO--GO FREE THE FUNCTION BLOCK.  71640016
BEGIN1   L     GR8,COPYPTR             POINTER TO COPY BLOCK.           71820016
TESTEND  CLC   CCOPYPTR(4),ZERO        IS THERE ANOTHER COPY BLOCK.     71910016
         BNE   TESTAGIN                YES-GO FIND THE LAST IN CHAIN.   72000016
         XC    COPYPTR(4),COPYPTR      NO--CLEAR POINTER TO FIRST COPY. 72090016
         BAL   GR9,FREECOPY            RELEASE COPY BLOCK CORE.         72180016
         B     FREEFUNC                GO FREE THE FUNCTION BLOCK.      72270016
FREECOPY LR    GR1,GR8                 ADDRESS OF COPY BLOCK.           72450016
         LA    GR0,COPYSIZE            SIZE OF COPY BLOCK.              72540016
FREEBUFF FREEMAIN R,LV=(0),A=(1)       RELEASE SOME CORE.               72630016
         BR    GR9                     RETURN.                          72720016
TESTAGIN LR    GR7,GR8                 SAVE POINTER TO CURRENT COPY.    72900016
         L     GR8,CCOPYPTR            ADDRESSING FOR NEXT COPY BLOCK.  72990016
         CLC   CCOPYPTR(4),ZERO        DOES IT POINT TO ANOTHER.        73080016
         BNE   TESTAGIN                YES-GO FIND LAST IN CHAIN.       73170016
         BAL   GR9,FREECOPY            NO--GO FREE LAST IN CHAIN.       73260016
         LR    GR8,GR7                 RESTORE POINTER TO PREVIOUS.     73350016
         XC    CCOPYPTR(4),CCOPYPTR    ZERO POINTER TO RELEASED BLOCK.  73440016
         B     BEGIN1                  REPEAT UNTIL ALL COPIES RELEASED 73530016
FREEFUNC CLI   FUNCSW,ANALYSIS          THIS ANALYZE ?                  73710000
         BE    FREEB                    YES-BRANCH.                     73760000
         CLI   FUNCSW,FORMAT            THIS FORMAT?                    73810000
         BNE   FREEF                    NO - GO FREE FUNCTION BLOCK     73860000
FREEB    L     GR1,FIPLPTR              IPL BUFFER ADDRESS              73910000
         LTR   GR1,GR1                 WAS THERE AN IPL BUFFER.         73980016
         BZ    FREEF                   NO--GO FREE FUNCTIOM BLOCK.      74070016
         CLC   FIPLPTR+1(3),WIPLPTR+1  ONLY ONE IPL BUFFER.             74100016
         BE    FREEF                   YES-WE WILL FREE IT LATER.       74130016
         AIF   ('&LIB' EQ 'LIB1').ARONDI THIS ASSEM FOR OS, BRCH X02912 74140002
         L     GR0,IPLMAX               GET MAX BUFFER SIZE      X02912 74150002
         AGO   .ARONDJ                  BRCH AROUND OS VALUE     X02912 74152002
.ARONDI  ANOP                           BRCH POINT FOR OS CODE   X02912 74154002
         LA    GR0,IPLSIZE             SIZE OF BUFFER.                  74160016
.ARONDJ  ANOP                           BRCH POINT FOR VS CODE   X02912 74210002
         BAL   GR9,FREEBUFF            GO FREE THE IPL BUFFER.          74250016
FREEF    LR    GR1,GR10                FUNCTION BLOCK ADDRESS.          74340016
         LH    GR0,FSIZE               SIZE OF FUNCTION BLOCK.          74430016
         BAL   GR9,FREEBUFF            RELEASE FUNCTION BLOCK CORE.     74520016
         XC    0(4,GR6),0(GR6)         CLEAR POINTER TO FUNCTION BLOCK. 74610016
         LH    GR9,QCOUNT              CURRENT NO.ENTRIES ON QUEUE.     74700016
         BCTR  GR9,0                   DECREMENT BY ONE.                74790016
         STH   GR9,QCOUNT              RESET SAVED VALUE.               74880016
         SR    GR10,GR10               CLEAR POINTER TO FUNCTION BLOCK. 74970016
         BR    GR14                    RETURN.                          75060016
         EJECT                                                          75150016
*********************************************************************** 75160002
*   THIS SECTION RECEIVES CONTROL FROM THE ESTAE MACRO TO EFFECT      * 75170002
*   ERROR RECOVERY IF IEHDASDR SHOULD ABEND OR BE CANCELED BEFORE     * 75172002
*   TURNING OFF THE DEVICE-LOCKING' BIT: UCBNALOC.                    * 75180002
*   THIS BIT IS TURNED ON FOR OFFLINE PROCESSING ONLY.                * 75182002
*********************************************************************** 75186002
         USING STAELIST,GR1                                             75188802
ABNDCODE EQU   *                                                YM01130 75198802
         BALR  11,0                    GET CURRENT ADDR         STAEFIX 75199202
         LA    GR6,*-IEHROOT           COMPUTE RTN OFFSET      @ZA26120 75200599
         SR    GR11,GR6                RELOAD BASE REG.        @ZA26120 75201599
         LA    GR6,12                  LOAD REG6 WITH 12       @ZA11946 75203540
         CR    GR0,GR6                 CONDITION CODE 12?      @ZA11946 75204840
         BNE   SDWAOK                  NO THEN SDWA            @ZA11946 75206140
         LR    GR1,GR2                 LOAD ADDR OF PARM LIST  @ZA11946 75207440
         B     CONTABND                CONTINUE ABEND          @ZA11946 75208740
SDWAOK   L     GR1,L0(GR1)             GET STAE LIST ADDR      @ZA11946 75210040
CONTABND L     GR4,STAELIST            GET TCB ADDR            @ZA11946 75222000
         L     GR12,STAEND             RELOAD IEHDWORK ADDR     STAEFIX 75226002
         L     GR5,DEBOFF(GR4)          GET TCBDEB PTR          YM01130 75230002
LOADUCB  EQU   *                                                YM01130 75234002
         L     GR6,UCBOFF(GR5)          GET UCB ADDR            YM01130 75238002
         LA    GR6,0(GR6)              CLEAR HIGH ORDER BYTE   @ZA01214 75242002
         USING UCB,GR6                                                  75246002
         TM    UCBFL5,UCBNALOC          DID WE TURN BIT ON ?    YM01130 75250002
         BNO   LOOPBK                   NO, CHK NEXT DEB        YM01130 75254002
         BAL   GR2,DELDEB               DELETE DEB VIA SVC 82  @ZA03380 75258003
LOOPBK   EQU   *                                                YM01130 75262002
         L     GR5,L4(GR5)              GET NEXT DEB ADDR       YM01130 75266002
         LA    GR5,0(GR5)              CLEAR HIGH ORDER BYTE   @ZA01214 75270002
         LTR   GR5,GR5                  END OF DEB-CHAIN ?      YM01130 75274002
         BNZ   LOADUCB                  BRCH IF MORE DEBS       YM01130 75278002
         SR    GR15,GR15                TERMINATION IS TO       YM01130 75282002
         BR    GR14                     CONTINUE                YM01130 75286002
         DROP 6                                                YM01182  75290002
         EJECT                                                          75294002
UCBFIND  EQU   *                                                        75298002
         L     GR9,CVTPTR              ADDRESS OF COMM. VECTOR TABL).   75302002
         USING CVT,GR9                                                  75306016
         CLI   0(GR3),BLANK            THIS A LEGIT DDNAME.             75310016
         BE    NEEDUCB                 NO--SPAECIAL CASE.               75350016
         L     GR4,CVTTCBP             TCB WORKD8 WORD.          YM5770 75420002
         L     GR4,LASTCTCB(GR4)       PICK UP TCB ADDRESS.      YM5770 75510002
         USING TCB,GR4                                           YM5770 75560002
         L     GR4,TCBTIO              PICK UP TIOT ADDRESS.     YM5770 75600002
         DROP  GR4                                               YM5770 75650002
         USING TIOT1,GR4                                         YM5770 75660002
         LA    GR15,TIOELNGH           PICK UP DD ENTRY ADDRESS. YM5770 75690002
         SR    GR1,GR1                                                  75780016
FINDNAME IC    GR1,0(GR15)             LOAD DD ENTRY LENGTH.            75870016
         LTR   GR1,GR1                 TEST FOR END OF TIOT.            75960016
         BZ    BADCARD                 END OF TABLE/NO DDNAME.          76050016
         CLC   4(8,GR15),0(GR3)        CHECK DD ENTRY FOR NAME MATCH.   76140016
         LR    GR2,GR15                SAVE POINTER.                    76230016
         LA    GR15,0(GR1,GR15)        SET UP FOR NEXT ENTRY.           76320016
         BNE   FINDNAME                NO MATCH-RETURN TO CHECK MORE.   76410016
         ICM   GR9,M7,17(GR2)          GET UCBPTR              @VS40035 76770003
         USING UCB,GR9                                          YL02912 76780002
         BZ    CHKPRINT                 GO GHK SYSPRINT          YM5770 76830002
         TM    UCBJBNR,UCBVRDEV         THIS A VIRTUAL UCB ?    YM08503 76830102
         BO    ERR855                   YES, GO ISSUE ERR MSG   YM08503 76830202
         TM    UCBTBYT3,UCB3DACC        DASD DEV?              @ZA26352 76830399
         BZ    NODASD                   NO THEN DONT TST NXT   @ZA26352 76830499
         TM    UCBTBYT2,UCB2OPT4        THIS A VIRTUAL UCB ?   @Y30LSFY 76830599
         BO    ERR855                   YES, GO ISSUE ERR MSG  @Y30LSFY 76830699
NODASD   LR    GR15,GR4                 GET TIOT               @ZA26352 76830799
         DROP  GR4                                               YM5770 76830899
         USING TIOT1,GR15                                        YM5770 76830999
         SR    GR4,GR4                  CLEAR                    YM5770 76831099
         LR    GR1,GR4                  *                        YM5770 76831202
TRYAGAIN EQU   *                                                 YM5770 76831602
         IC    GR1,TIOELNGH             GET ENTRY LENGTH       @ZA03352 76832703
         LTR   GR1,GR1                  IS IT END OF TIOT ?    @ZA03352 76834703
         BCR   COND0,GR14               YES, RETURN            @ZA03352 76835103
         CLM   GR9,7,TIOESTTB+1         IS IT SAME UCB         @ZA01705 76835403
         LA    GR15,DISP0(GR1,GR15)     GET NEXT ENT           @ZA03352 76835803
         BNE   TRYAGAIN                 NO, GET NEXT ENT       @ZA03352 76836503
         LA    GR4,ADD1(GR4)            ADD 1 TO UCB COUNT       YM5770 76839603
         STC   GR4,ALLOCNT              SAVE ALLOCATION COUNT    YM5770 76842003
         B     TRYAGAIN                 CHK NEXT ENT             YM5770 76856403
CHKPRINT EQU   *                                                 YM5770 76858803
         CLC   SYSOUTDD,0(GR3)          DDNAME=SYSPRINT ?       OX01789 76861203
         BCR   8,GR14                   YES, EXIT               OX01789 76863603
         SPACE 2                                                        76866016
ZEROUCB  EQU   *                                                YM5582  76868001
         LA    GR1,MESS20               LOAD MSG NO.            YM5582  76870001
BLDMSG   EQU   *                                                YL02912 76870102
         BAL   GR9,BUILD                BRING MSG INTO BUFFER   YM5582  76870401
         MVC   K0(L8,GR1),K0(GR3)       MOVE DDNAME TO MSG      YM5582  76870801
         B     MSGWRT2                  GO PRINT MSG            YM5582  76871201
ERR855   EQU   *                                                YL02912 76875802
         LA    GR1,MESS55               VIRTUAL UCB ERROR MSG   YL02912 76880002
         B     BLDMSG                   GO PRINT MSG            YM08503 76881202
         DROP 9                                                YM01182  76883202
         USING CVT,GR9                  RESTORE USING           YL02912 76885802
NEEDUCB  EQU   *                                                        76890402
         L     GR15,CVTILK2            UCB ADDRESS TABLE.               76895002
STARTEST EQU   *                                               @30AAAG  76899603
         SLR   GR1,GR1                 CLEAR REGISTER          @30AAAG  76899803
         ICM   GR1,3,0(GR15)           INSERT UCB ADDR-16 BITS @30AAAG  76900003
         BZ    UPUCBPTR                NO--GO SEE IF MORE ENTRIES.      76908802
         USING UCB,GR1                                                  76913402
         TM    UCBTBYT3,UCB3DACC       THIS A DIRECT ACCESS DEVICE.     76918002
         BZ    UPUCBPTR                 NO--GO SEE IF MORE ENTRIES.     76922602
         CLC   1(3,GR3),UCBNAME         THIS THE DESIRED UCB.           76927202
         BNE   UPUCBPTR                 NO--GO SEE IF MORE ENTRIES.     76931802
         AIF  ('&LIB' EQ 'LIB2').NODC1  BRCH IF VS ASSEM        XL03912 76936402
         CLI   UCBTBYT4,DA2321          THIS A 2321                     76941002
         BE    PROC2321                 YES-SPECIAL CASE.               76945602
.NODC1   ANOP                                                   XL03912 76950202
UCBRET   LR    GR9,GR1                  ADDDRESS OF UCB.                76954802
         TM    UCBTBYT2,UCB2OPT4        THIS A VIRTUAL UCB ?   @Y30LSFY 76955003
         BO    ERR855                   YES, GO ISSUE ERR MSG  @Y30LSFY 76955203
         TM    UCBFL5,UCBNALOC          THIS DEVICE IN USE ?    YM01130 76956802
         BO    NEWMSG                   YES, ISSUE IEH859 MSG   YM01130 76958802
         BR    GR14                     RETURN.                         76959402
NEWMSG   EQU   *                                                YM01130 76961402
         LA    GR1,MESS59               LOAD MSG NO.            YM01130 76963402
         B     BLDMSG                   GO PRINT MSG            YM01130 76963802
         AIF  ('&LIB' EQ 'LIB2').NODC2  BRCH IF VS ASSEM        XL03912 76964002
         SPACE                                                          76968602
PROC2321 SR    GR4,GR4                  CLEAR.                          76973202
         IC    GR4,5(GR3)               PICK UP BIN NO.                 76977802
         N     GR4,MASK                 CLEAR ZONE BITS.                76982402
         SLA   GR4,4                    BIN NO. TIMES 16.               76987002
         LA    GR1,DATACELL(GR4)        SUB-UCB ADDRESS.                76991602
         B     UCBRET                   EXIT NOW.                       76996202
.NODC2   ANOP                                                   XL03912 77000802
         DROP  1,9                                                      77005402
UPUCBPTR LA    GR15,2(GR15)             STEP TO NEXT TABLE ENTRY.       77010016
         CLC   0(2,GR15),UCBLAST        ANY MORE ENTRIES.               77016016
         BNE   STARTEST                 YES--KEEP LOOKING.              77022016
         B     RMESS24                  NO--THIS UCB NOT IN SYSTEM.     77028016
         EJECT                                                          77040016
MSGPRT   EQU   *                                                        77070016
         TM    SW1,TEXTIN              ARE WE LOOKING FOR IPL TEXT.     77100016
         BO    NOIPLMSG                YES-GIVE PROPER MESSSAGE.        77130016
         LA    GR1,MESS0               MESSAGE NUMBER.                  77160016
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       77220016
         L     GR3,STORGR3             LAST ADDRESS SCANNED.            77310016
         LA    GR4,CARDBUFF            START OF CONTROL STATEMENT.      77400016
         SR    GR3,GR4                 NO. OF COLUMNS SCANNED.          77490016
         CVD   GR3,WURK                CONVERT TO DECIMAL               77580021
         UNPK  WURK(2),WURK+6(2)       UNPACK FOR PRINTING.             77670021
         OI    WURK+1,X'F0'            SET PROPER ZONE.                 77760021
         TR    WURK(2),IOTAB-240       CONVERT TO EBCDIC FOR PRINTING.  77850021
         MVC   0(2,GR1),WURK           PLACE ANSWER IN MESSAGE.         77940021
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        78030016
         SPACE                                                          78120016
INVALCOM LA    GR1,MESS1               MESSAGE NUMBER 801.              78210003
INV1     BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       78300016
         MVC   0(8,GR1),WURK           MOVE INVALID PORTION TO MESSAGE. 78390021
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        78480016
INVALKEY LA    GR1,MESS2               MESSAGE NUMBER 802.              78570016
         B     INV1                    BUILD AND WRITE OUT THE MESSAGE. 78660016
INVALP1  BCTR  GR2,0                   DECREMENT LENGTH FOR EXECUTE.    78750016
INVALPAR LR    GR5,GR1                 SAVE ADDRESS OF PARAMETER.       78840016
         LA    GR1,MESS3               MESSAGE NUMBER 803.              78930016
         BAL   GR9,BUILD               GO BUILD THE MESSAGE.            79020016
         LR    GR4,GR1                 ADDRESS TO MOVE IN PARAMETER.    79110016
         LR    GR1,GR5                 ADDRESS OF PARAMETER.            79200016
         EX    GR2,PMOVE               PARAMETER TO OUTPUT BUFFER.      79290016
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        79380016
         SPACE                                                          79470016
KEYMISS  LA    GR1,MESS4               MESSAGE NUMBER 804.              79560016
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       79650016
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        79740016
         SPACE                                                          79830016
DCBERROR LA    GR1,MESS5               MESSAGE NUMBER 805.              79920016
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       80010016
         LA    GR4,READ                SYSIN DCB ADDRESS.               80100016
         USING IHADCB,GR4                                               80190016
         MVC   0(8,GR1),DCBDDNAM       DDNAME TO MESSAGE.               80280016
         BAL   GR9,ERRPRINT            WRITE OUT THE MESSAGE.           80370016
         MVI   RETCODE,8               SET RETURN CODE.                 80460016
         B     ENDALL                  GO TERMINATE.                    80550016
         SPACE                                                          80640016
         SPACE                                                          80730016
BADCARD  LA    GR1,MESS12              MESSAGE NUMBER.                  80820016
BADCARD1 BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       80910016
         MVC   0(8,GR1),0(GR3)         DDNAME TO MESSAGE                81000016
         B     MSGWRT                  GO WRITE OUT THE MESSAGE.        81090016
MSGWRT2  OI    SWITCHRD,BYPASS         INSURE SCAN KNOWS OF ERROR.      81130016
         SPACE                                                          81180016
MSGWRT   BAL   GR14,FREECORE           FREE CORE ASSIGNED THIS FUNCTION 81270016
MSGWRT1  BAL   GR9,ERRPRINT            GO WRITE OUT THE MESSAGE.        81360016
         MVI   RETCODE,8               SET RETURN CODE.                 81450016
         TM    SWITCHRD,EOF            PREVIOUS EOF.                    81570016
         BO    CHECK                   YES-GO SEE IF FINISHED.          81600016
         B     SCAN                    RESUME SCAN OF CARDS,            81630016
         SPACE                                                          81720016
*   WRITE OUT ALL MESSAGES HERE.                                        81810016
ERRPRINT EQU   *                                                        81900016
         LINK  EP=IEHDPRNT                                              81990016
         BR    GR9                     RETURN.                          82080016
         SPACE                                                          82170016
*   BUILD ALL MESSAGES HERE.                                            82260016
BUILD    LINK  EP=IEHDMSGB                                              82350016
         BR    GR9                     RETURN.                          82440016
         SPACE                                                          82530016
SETCODE  MVI   RETCODE,16              SET RETURN CODE.                 82620016
         B     FREEWORK                GO FREE THE WORK AREA.           82710016
         SPACE                                                          82800016
COREMSG  LA    GR1,MESS18              MESSAGE NUMBER 818.              82890016
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       82980016
         B     MSGWRT                  GO WRITE OUT THE MESSAGE.        83070016
         SPACE                                                          83160016
NOIPL    MVI   SWITCHRD,EOF            INDICATE EOF ENCOUNTERED.        83220016
NOIPLMSG LA    GR1,MESS26              MESSAGE NUMBER 826.              83280016
         NI    SW1,X'FF'-TEXTIN        INSURE SWITCH IS OFF.            83340016
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         83430016
         MVC   0(8,GR1),WORKD8         DDNAME TO MESSAGE.        A32162 83500021
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        83570016
         SPACE                                                          83620016
RMESS24  LA    GR1,MESS24              MESSAGE NUMBER.                  83630016
         MVI   SWITCHRD,0              RESET CONTROL SWITCH      M2385  83632000
         B     BADCARD1                GO BUILD AND WRITE OUT MESSAE.  83640016
         EJECT                                                          83650016
FREEPOOL TM    23(GR1),1               ARE THERE BUFFERS.      @ZA04422 83655003
         BO    0(GR9)                  NO--RETURN.             @ZA04422 83660003
         FREEPOOL (1)                  FREE QSAM BUFFER POOLS.          83665016
         BR    GR9                     RETURN.                          83670016
*********************************************************************** 83790016
*                                                                     * 83880016
*   THIS ROUTINE WILL CLEAR ANY BLOCK OF CORE TO ZERO.                * 83970016
*                                                                     * 84060016
*     REGISTER 1 MUST CONTAIN THE STARTING ADDRESS UPON ENTRY.        * 84150016
*     REGISTER 2 IS A WORK REGISTER.                                  * 84240016
*     REGISTER 3 MUST CONTAIN THE SIZE UPON ENTRY.                    * 84330016
*     REGISTER 14 IS THE RETURN REGISTER.                             * 84420016
*                                                                     * 84510016
*********************************************************************** 84600016
         SPACE                                                          84690016
CLEAR    LA    GR2,255                 SET FOR EXECUTE.                 84780016
         MVI   0(GR1),X'00'            PRIME FIRST BYTE FOR EXEC.       84870016
EXEC     CH    GR3,TWO56               WILL THIS BE THE LAST PASS.      84960016
         BNH   LASTTIME                YES-DO ONE MORE MOVE.            85050016
         EX    GR2,MVZO                CLEAR 256 BYTES.                 85140016
         LA    GR1,256(GR1)            INCREMENT ADDRESS.               85230016
         SH    GR3,TWO56               UPDATE BYTE COUNT.               85320016
         B     EXEC                    RETURN TO CHECKPOINT.            85410016
         SPACE 1                                                        85500016
LASTTIME BCTR  GR3,0                   DECREMENT FOR MVC.               85590016
         EX    GR3,MVZO                CLEAR REMAINING PORTION.         85680016
         BR    GR14                    RETURN.                          85770016
         EJECT                                                          85860016
LOADADDR DC    F'0'                    FUNCTION ROUTINE ADDRESS.        85950016
         DS    0F                                                       86040016
EXITLST1 DC    X'85'         SYSIN DCB EXIT LIST                        86130016
         DC    AL3(DCBEXIT1)                                            86220016
LINKADDR DC    1D'0'                   NAME OF ROUTINE TO LOAD.         86310016
         DC    C'IEHDDUMP'             DUMP MODULE.                     86400016
         DC    C'IEHDREST'             RESTORE MODULE.                  86490016
         DC    C'IEHDGETA'             GETALT MODULE.                   86580016
         DC    C'IEHDLABL'             LABEL MODULE.                    86670016
         DC    C'IEHDANAL'             ANALYZE MODULE.                  86760016
          DC    C'IEHDANAL'            FORMAT MODULE.                   86850016
         DC    C'IEHDIPLI'             IPLPROG MODULE                   86890000
         SPACE 1                                                        86940016
         AIF   ('&LIB' EQ 'LIB1').WIN05 BRCH IF OS ASSEM        XL03130 86950002
ENDPL    EQU   X'80'                    END OF PARAM. LIST FLG  XL03130 86960003
L3       EQU   3                        LENGTH OF 3            @Y30LSFY 86960203
L1       EQU   1                                                VS06562 86970002
M7       EQU   7                       USED IN ICM/STCM INSTR  @VS40035 86971003
L43      EQU   43                                               VS06562 86980002
OPENED   EQU   X'10'                    DCBOFLG FOR OPEN DS     VS06562 86992002
FORMAT4  EQU   X'04'                    DSN KEY FOR F4 DSCB     VS06562 87000002
WINC     EQU   X'0A'                    WINCHESTER UCB TYPE     XL03130 87040003
MERLIN   EQU   X'09'                    MERLIN UCB TYPE        @Y30LSFY 87040503
ICEBERG  EQU   X'0D'                    ICEBERG UCB TYPE       @Y30LSFY 87041003
OUTDCB   DCB   DSORG=PS,MACRF=(E),DEVD=DA,EOEA=P8,XENDA=P9,EXLST=LIST   87090002
SVCTYP   DC    C'82'                    DEVTYPE SVC NO.         XL03130 87150003
         DS    H                        UNUSED                          87204003
.WIN05   ANOP                                                   XL03130 87208003
D4       EQU   4                        DISPLACEMENT OF 4       XL03130 87208403
D0       EQU   0                        DISPLACEMENT OF 0       XL03130 87208803
ZERO     DC    F'0'                                                     87210016
ROOTSAVE DS    18F                     SAVE AREA FOR CALLED ROUTINES.   87300016
KONSTANT DC    V(IEHDCONS)             DEVICE CONSTANT MODULE ADDRESS.  87390016
SS1OFFST DC    F'832'                  OFFSET - SS/1 CONSTANTS @Y30LSFY 87390503
ANSWER   DS    1F                      USED BY CONDITIONAL GETMAIN.     87430016
         SPACE 1                                                        87480016
MVZO     XC    0(1,GR1),0(GR1)         EXECUTED TO CLEAR CORE.          87570016
PMOVE    MVC   0(1,GR4),0(GR1)         USED TO MOVE DDNAME PARAMETERS.  87660016
CHKTODD  CLC   4(0,GR15),0(GR1)         EXECUTED COMPARE OF DDN  A50288 87750021
TWO56    DC    H'256'                  COMPARE CONSTANT.                87840016
EIGHT    DC    H'8'                                                     87930016
THREE    DC    H'3'                    COMPARE CONSTANT.                88020016
FIVE     DC    H'5'                     LENGTH OF TODD FOR 2321  A50288 88030021
*                                       OFFLINE                  A50288 88032021
DONESTAE DC    X'00'                   IF FF THEN ESTAE DONE   @ZA27199 88036099
         DS    0F                                                       88040016
         AIF   ('&LIB' EQ 'LIB1').ARONDK THIS ASSEM FOR OS, BRCH X02912 88050002
IPLMAX   DC    F'6496'                  MAX IPLTXT RECORD SIZE   X02912 88052002
.ARONDK  ANOP                                                    X02912 88054002
MASK     DC    X'0000000F'             MASK FOR 'AND'.                  88060016
UCBLAST  DC    XL2'FFFF'               LAST UCB IDENTIFIER.             88080016
RETCODE  DC    X'00'                   HIGHEST RETURN CODE, IF ANY.     88110016
SAVLGTH  DS    1C                      LENGTH SAVE AREA.                88200016
YES      DC    C'YES'                  PARAMETER COMPARISON.            88290016
NO       DC    C'NO'                   PARAMETER COMPARISON.            88380016
TXT      DC    C'TXT'                  TEXT CARD COMPARE.               88470016
END1     DC    C'END'                  END CARD COMPARE.                88560016
ALLOCNT  DC    XL1'0'                   UCB ALLOCATION COUNT     YM5770 88610002
CTOEMASK DC    X'2020202020202020'     USED TO CHANGE ZONES.            88650016
ALTTT    DC    X'0A0B0C0D0E0FDDDDDD'   TABLE FOR CONVERSION TO HEX.     88740016
         DC    X'DDDDDDDDDDDD'                                          88830016
         DC    X'00010203040506070809'                                  88920016
IOTAB    DC    C'0123456789ABCDEF'     TRANSLATE TABLE.                 89010016
         SPACE 1                                                        89100016
         EJECT                                                          89190016
PRINT    DCB   DSORG=PS,MACRF=PM,RECFM=FBSA,BFTEK=S,BFALN=F,           X89280016
               DDNAME=SYSPRINT,LRECL=121,EXLST=EXITLST1                 89370016
         SPACE                                                          89460016
READ     DCB   DSORG=PS,MACRF=GM,RECFM=FB,LRECL=80,BFTEK=S,            X89550016
               BUFNO=2,BFALN=F,DDNAME=SYSIN,EXLST=EXITLST1,EROPT=SKP    89640016
MAINT    DS    50F                     PATCH AREA.              US02496 89690000
         EJECT                                                          89730016
         IEHDWORK                                                       89820016
         SPACE                                                          89910016
         SPACE 1                                                        90000016
         IEHDBLKS                                                       90090016
         SPACE                                                          90180016
STAELIST DSECT                                                  YM01130 90190002
         DS    F                        TCB ADDRESS             YM01130 90200002
STAEND   DS    F                        HEX 80 IN HIGH BYTE     YM01130 90210002
STAEX    DS    0F                                               STAEFIX 90212002
STAESIZE EQU   STAEX-STAELIST           LENGTH OF STAE LIST     STAEFIX 90220002
         SPACE                                                          90222002
DEVMSK   DSECT                          MASKS DEVTYPE MACRO O/P XL03130 90230003
         DS    2F                                               XL03130 90240003
NOFCYL   DS    H                        NO. OF CYLINDERS       @ZA24409 90250099
IPLCARD  DSECT                         CARD FORMAT//IPL PROGRAM.        90270016
CARDID   DS    CL1                                                      90360016
CARDTYPE DS    CL3                     TYPE OF CARD.                    90450016
         DS    CL1                                                      90540016
CARDADDR DS    CL3                                                      90630016
         DS    CL2                                                      90720016
CARDBYTE DS    CL2                     NO. OF BYTES//THIS CARD.         90810016
         DS    CL2                                                      90900016
         DS    CL2                                                      90990016
CARDTEXT DS    CL56                    TEXT DATA PORTION.               91080016
         DS    CL8                                                      91170016
         EJECT                                                          91190016
UCB      DSECT                                                          91210016
         IEFUCBOB LIST=YES                                              91230002
         EJECT                                                          91260016
         DCBD  DSORG=PS                                                 91350016
         EJECT                                                          91440016
CVT      DSECT                                                          91530016
         CVT   SYS=MIN                                                  91620016
         EJECT                                                          91670002
         IKJTCB SYS=AOS2,DSECT=YES,LIST=YES                      YM5770 91680002
         EJECT                                                          91690002
TIOT     DSECT                                                   YM5770 91700002
         IEFTIOT1                                                YM5770 91702002
         EJECT                                                  VS06562 91704002
JFCB     DSECT                                                  VS06562 91706002
         IEFJFCBN                                               VS06562 91708002
         END                                                            91800016
./  ADD  SSI=70880134,NAME=IEHDCONS
          TITLE 'IEHDCONS ---- CONSTANTS MODULE FOR IEHDASDS'           00510002
         COPY  LCGASMSW                                          SM4351 00520002
IEHDCONS CSECT                                                          00550021
*                                                                       00550440
*C 807799,809146                     NOT OS  @YA09618=@XA09714=@ZA04350 00550840
*                                                                       00552002
*C 807919,809262                     NOT OS  @YA06115=@XA06587=@ZA01237 00554002
*                                                                       00560002
*C 807799,809146                     NOT OS  @YA06114=@XA04178=@ZA01236 00570002
*                                                                       00600002
*C 807983,809371                     NOT OS  @YA04842=@ZA01203=@XA05808 00610002
*                                                                       00620002
*        RELEASE 23 DELETIONS                                         * 00640020
*        RELEASE 22 DELETIONS                                         * 00680020
*        RELEASE 21 DELETIONS                                         * 00800020
*                                                               YM03149 00802002
*1056975000                                                      X02114 00810021
*1056813220,971300                                               A45608 00820021
*1056811050,811400                                               A43208 00850021
*        RELEASE 20 DELETIONS                                         * 00900020
*3062225000,365000,505000,645000,785000,811890,814060,955000,    5594   00900620
*3062972480                                                      5594   00901220
*3062972460                                                      M5447  00902020
*3062970700,972000-972500                                        M4682  00905020
*                                                                M0025  00910020
*3062200000,935000                                               M3215  00920020
*3062815000-830000                                               S20201 00950020
*3062195000-198000,340000-345000,480000-485000,620000-625000,    S20201 00960020
*3062760000-765000,810420,811540-811610,813710-813780,930000-    S20201 00970020
*3062935000,972000-972100                                        S20201 00980020
* APAR 39509 IS FIXED IN THIS MODULE BUT                        A39509  00986020
* FLAGGED AS S20201                                             A39509  00992020
*********************************************************************** 01000016
*                                                                     * 01500016
*                                                                     * 02000016
*   THIS CSECT CONTAINS ALL OF THE NECESSARY DEVICE DEPENDENT         * 02500016
*     CONSTANTS REQUIRED BY THE IEHDASDR PROGRAM. THESE CONSTANTS     * 03000016
*     ARE USED BY ALL FUNCTIONS. THIS CSECT CONTAINS NO EXECUTABLE    * 03500016
*     CODE AND THE CONSTANTS IN THIS MODULE ARE NEVER CHANGED         * 04000016
*     DURING PROGRAM EXECUTION.                                       * 04500016
*                                                                     * 05000016
*                                                                     * 05500016
*   WARNING--THE DEVICE ORDER MUST NOT BE CHANGED. THE ORDER IS       * 06000016
*     DEPENDENT UPON THE OS/360 UCB DEVICE TYPE CODE--UCBTBYT4-.      * 06500016
*   THESE ENTRIES ARE ACCESSED BY MULTIPLYING THE UCB DEVICE TYPE     * 07000016
*   CODE TIMES THE ENTRY SIZE.                                        * 07500016
*                                                                     * 08000016
*                                                                     * 08500016
*********************************************************************** 09000016
         EJECT                                                          09500016
         AIF   ('&LIB' EQ 'LIB2').VSDEV BRCH IF VS ASSEM        XL03145 09550003
*   2311 DEVICE CONSTANTS---UCB CODE=1                                  10000016
         SPACE 1                                                        10500016
K2311    DS    0F                      START OF 2311 CONSTANTS.         11000016
         DC    X'00CA0009'             CCHH OF LAST ALTERNATE.          11500016
         DC    X'0000FFF7'             CONVERSION TO CHANGE CYLINDERS.  12000016
         DC    X'FFFF000A'             CONVERSION TO GIVE CC-1,HH+XX.   12500016
         DC    H'60'                   MAXIIMUM RECORDS PER TRACK.      13000016
         DC    H'3694'                 SURFACE ANALYSIS TRACK CAPACITY. 13500016
         DC    X'00C70009'             CCHH OF LAST PRIMARY TRACK.      14000016
         DC    H'30'                   NUMBER OF ALTERNATES.            14500016
         DC    H'203'                  NUMBER OF CYLINDERS.             15000016
         DC    H'10'                   TRACKS PER CYLINDER.             15500016
         DC    H'3625'                 TRACK CAPACITY.                  16000016
         DC    X'511414'               RECORD OVERHEAD.                 16500016
         DC    X'01'                   FLAG BYTE.                       17000016
         DC    X'0219'                 TOLERANCE FACTOR.                17500016
         DC    X'10'                   DSCBS PER TRACK.                 18000016
         DC    X'0A'                   DIRECTORY BLOCKS PER TRACK.      18500016
         DC    H'2000'                 NUMBER OF PRIMARY TRACKS.        19000016
         DC    H'4720'                  RESTORE BUFFER SIZE      S20201 19300020
         DC    H'1072'                  SIZE D/R WRT CKD BUFFER  S20201 19600020
*                                       CCWS.                    M3215  20100020
         DC    H'3648'                 SIZE OF DATA BUFFER--DUMP.       20500016
         DC    H'512'                  SIZE OF READ COUNT CCWS.         21200016
         DC    H'480'                  SIZE OF COUNT FIELD BUFFER.      22000016
         DC    H'5968'                  TOTAL DUMP BUFFER SIZE   5594   22500020
LAST2311 DS    0H                      END OF CONSTANTS THIS ENTRY.     23000016
         SPACE 1                                                        23500016
SIZE2311 EQU   LAST2311-K2311          TABLE SIZE THIS DEVICE.          24000016
         EJECT                                                          24500016
*   2301 DEVICE CONSTANTS---UCB CODE=2                                  25000016
K2301    DS    0F                      START OF 2301 CONSTANTS.         25500016
         DC    X'000000C7'             CCHH OF LAST ALTERNATE.          26000016
         DC    X'00000001'             CONVERSION TO CHANGE CYL(SPEC).  26500016
         DC    X'FFFF0008'             CONVERSION TO GIVE CC-1,HH+XX.   27000016
         DC    H'157'                  MAXIMUM RECORDS PER TRACK.       27500016
         DC    H'20624'                SURFACE ANALYSIS TRACK CAPACITY. 28000016
         DC    X'000000C7'             CCHH OF LAST PRIMARY TRACK.      28500016
         DC    H'0'                    NUMBER OF ALTERANTES.            29000016
         DC    H'25'                   NUMBER OF CYLINDERS.             29500016
         DC    H'8'                    TRACKS PER CYLINDER.             30000016
         DC    H'20483'                TRACK CAPACITY.                  30500016
         DC    X'BA3535'               RECORD OVERHEAD.                 31000016
         DC    X'04'                   FLAG BYTE.                       31500016
         DC    H'512'                  TOLERANCE FACTOR.                32000016
         DC    X'3F'                   DSCBS PER TRACK.                 32500016
         DC    X'2D'                   DIRECTORY BLOCKS PER TRACK.      33000016
         DC    H'200'                  NUMBER OF PRIMARY TRACKS.        33500016
         DC    H'23128'                 RESTORE BUFFER SIZE      S20201 34000020
         DC    H'2624'                  SIZE D/R WRT CKD BUFFER  S20201 34500020
         DC    H'20504'                MAXIMUM DATA SIZE FOR ONE TRACK. 35000016
         DC    H'1280'                 MAXIMUM SIZE FOR RD CNT CCWS.    35500016
         DC    H'1256'                 MAXIMUM SIZE FOR COUND BUFFER.   36000016
         DC    H'25920'                 TOTAL DUMP BUFFER SIZE   5594   36500020
LAST2301 DS    0H                      END OF CONSTANTS THIS ENTRY.     37000016
         SPACE 1                                                        37500016
SIZE2301 EQU   LAST2301-K2301          TABLE SIZE THIS DEVICE.          38000016
         EJECT                                                          38500016
*   2303 DEVICE CONSTANTS---UCB CODE=3                                  39000016
K2303    DS    0F                      START OF 2303 CONSTANTS.         39500016
         DC    X'004F0009'             CCHH OF LAST ALTERNATE.          40000016
         DC    X'0000FFF7'             CONVERSION TO CHANGE CYL.        40500016
         DC    X'FFFF000A'             CONVERSION TO GIVE CC-1,HH+XX.   41000016
         DC    H'47'                   MAXIMUM RECORDS PER TRACK.       41500016
         DC    H'5008'                 SURFACE ANALYSIS TRACK CAPACITY. 42000016
         DC    X'004F0009'             CCHH OF LAST PRIMARY TRACK.      42500016
         DC    H'0'                    NUMBER OF ALTERNATES.            43000016
         DC    H'80'                   NUMBER OF CYLINDERS.             43500016
         DC    H'10'                   TRACKS PER CYLINDER.             44000016
         DC    H'4892'                 TRACK CAPACITY.                  44500016
         DC    X'922626'               RECORD OVERHEAD.                 45000016
         DC    X'00'                   FLAG BYTE.                       45500016
         DC    H'512'                  TOLERANCE FACTOR.                46000016
         DC    X'11'                   DSCBS PER TRACK.                 46500016
         DC    X'0C'                   DIRECTORY BLOCKS PER TRACK.      47000016
         DC    H'800'                  NUMBER OF PRIMARY TRACKS.        47500016
         DC    H'5776'                  RESTORE BUFFER SIZE      S20201 48000020
         DC    H'864'                   SIZE D/R WRT CKD BUFFER  S20201 48500020
         DC    H'4912'                 MAXIMUM DATA SIZE FOR ONE TRACK. 49000016
         DC    H'400'                  MAXIMUM SIZE FOR RD CNT CCWS.    49500016
         DC    H'376'                  MAXIMUM SIZE FOR COUNT BUFFER.   50000016
         DC    H'6808'                  TOTAL DUMP BUFFER SIZE   5594   50500020
LAST2303 DS    0H                      END OF CONSTANTS THIS ENTRY.     51000016
         SPACE 1                                                        51500016
SIZE2303 EQU   LAST2303-K2303          TABLE SIZE THIS DEVICE.          52000016
         EJECT                                                          52500016
*   2302 DEVICE CONSTANTS---UCB CODE=4                                  53000016
K2302    DS    0F                      START OF 2302 CONSTANTS.         53500016
         DC    X'00F9002D'             CCHH OF LAST ALTERNATE.          54000016
         DC    X'0000FFD3'             CONVERSION TO CHANGE CYL.        54500016
         DC    X'FFFF002E'             CONVERSION TO GIVE CC-1,HH+46.   55000016
         DC    H'81'                   MAXIMUM RECORDS PER TRACK.       55500016
         DC    H'5053'                 SURFACE ANALYSIS TRACK CAPACITY. 56000016
         DC    X'00F5002D'             CCHH OF LAST PRIMARY TRACK.      56500016
         DC    H'184'                  NUMBER OF ALTERNATES.            57000016
         DC    H'250'                  NUMBER OF CYLINDERS.             57500016
         DC    H'46'                   TRACKS PER CYLINDER.             58000016
         DC    H'4984'                 TRACK CAPACITY.                  58500016
         DC    X'511414'               RECORD OVERHEAD.                 59000016
         DC    X'01'                   FLAG BYTE.                       59500016
         DC    H'537'                  TOLERANCE FACTOR.                60000016
         DC    X'16'                   DSCBS PER TRACK.                 60500016
         DC    X'0E'                   DIRECTORY BLOCKS PER TRACK.      61000016
         DC    H'11316'                NUMBER OF PRIMARY TRACKS.        61500016
         DC    H'6408'                  RESTORE BUFFER SIZE      S20201 62000020
         DC    H'1408'                  SIZE D/R WRT CKD BUFFER  S20201 62500020
         DC    H'5000'                 MAXIMUM DATA SIZE FOR ONE TRACK. 63000016
         DC    H'672'                  MAXIMUM SIZE FOR RD CNT CCWS.    63500016
         DC    H'648'                  MAXIMUM SIZE FOR COUNT BUFFER.   64000016
         DC    H'7984'                  TOTAL DUMP BUFFER SIZE   5594   64500020
LAST2302 DS    0H                      END OF CONSTANTS THIS ENTRY.     65000016
         SPACE 1                                                        65500016
SIZE2302 EQU   LAST2302-K2302          TABLE SIZE THIS DEVICE.          66000016
         EJECT                                                          66500016
*   2321 DEVICE CONSTANTS---UCB CODE=5                                  67000016
K2321    DS    0F                      START OF 2321 CONSTANTS.         67500016
         DC    X'13090413'             CCHH OF LAST ALTERNATE.          68000016
         DC    X'000000ED'             CONVERSION TO CHANGE CYL.        68500016
         DC    X'FFFF0014'             CONVERSION TO GIVE CC-1,HH+20.   69000016
         DC    H'65'                   MAXIMUM RECORDS PER TRACK.       69500016
         DC    H'2000'                 SURFACE ANALYSIS TRACK CAPACITY. 70000016
         DC    X'13050413'             CCHH OF LAST PRIMARY TRACK.      70500016
         DC    H'400'                  NUMBER OF ALTERNATES.            71000016
         DC    H'1000'                 NUMBER OF CYLINDERS.             71500016
         DC    H'20'                   TRACKS PER CYLINDER.             72000016
         DC    H'2000'                 TRACK CAPACITY.                  72500016
         DC    X'641010'               RECORD OVERHEAD.                 73000016
         DC    X'03'                   FLAG BYTE.                       73500016
         DC    H'537'                  TOLERANCE FACTOR.                74000016
         DC    X'08'                   DSCBS PER TRACK.                 74500016
         DC    X'05'                   DIRECTORY BLOCKS PER TRACK.      75000016
         DC    H'19600'                NUMBER OF PRIMARY TRACKS.        75500016
         DC    H'3168'                  RESTORE BUFFER SIZE      S20201 76000020
         DC    H'1152'                  SIZE D/R WRT CKD BUFFER  S20201 76500020
         DC    H'2016'                 MAXIMUM DATA SIZE FOR ONE TRACK. 77000016
         DC    H'544'                  MAXIMUM SIZE FOR RD CNT CCWS.    77500016
         DC    H'520'                  MAXIMUM SIZE FOR COUNT BUFFER.   78000016
         DC    H'4488'                  TOTAL DUMP BUFFER SIZE   5594   78500020
LAST2321 DS    0H                      END OF CONSTANTS THIS ENTRY.     79000016
         SPACE 1                                                        79500016
SIZE2321 EQU   LAST2321-K2321          TABLE SIZE THIS DEVICE.          80000016
         EJECT                                                          80500016
.VSDEV   ANOP                   BRANCH POINT FOR VS ASSEMBLIES  XL03145 80550003
         AIF   ('&LIB' EQ 'LIB1').OSDEV BRCH IF OS ASSEM        XL03145 80560003
         EJECT                                                          80650003
*        DEVICE CONSTANTS---UCB CODE= X'0A' - MODEL 1           XL03130 80660003
WINCH1   DS    0F            START OF WINCHESTER CONSTANTS.     XL03130 80670003
         DC    X'015C000B'   CCHH OF LAST ALTERNATE.            XL03130 80680003
         DC    X'0000FFF5'   CONVERSION TO CHANGE CYL.          XL03130 80690003
         DC    X'FFFF000C'   CONVERSION TO GIVE CC-1,HH+XX.     XL03130 80692003
         DC    H'50'                    MAX RECORDS PER TRACK   XL03130 80694003
         DC    H'8535'       SURFACE ANALYSIS TRACK CAPACITY    XL03130 80696003
         DC    X'015B000B'   CCHH OF LAST PRIMARY TRACK.        XL03130 80698003
         DC    H'12'         NUMBER OF ALTERNATES.              XL03130 80698403
         DC    H'349'        NUMBER OF CYLINDERS.               XL03130 80698803
         DC    H'12'         TRACKS PER CYLINDER.               XL03130 80699203
         DC    H'8535'                  TRACK CAPACITY          XL03130 80699603
         DC    X'F2F24B'     RECORD OVERHEAD.                   XL03130 80699703
         DC    X'01'         FLAG BYTE.                          S20201 80699803
         DC    H'512'        TOLERANCE FACTOR.                  XL03130 80699903
         DC    X'16'         DSCBS PER TRACK.                   XL03130 80749903
         DC    X'10'         DIRECTORY BLOCKS PER TRACK.        XL03130 80759903
         DC    H'4188'       NUMBER OF PRIMARY TRACKS.          XL03130 80769903
         DC    H'9288'                  RESTORE BUFF SIZE      @ZA04350 80779940
         DC    H'888'                   SIZE D/R WRT CKD BUFFER XL03130 80789903
         DC    H'8400'                 MAXIMUM DATA SIZE FOR   @ZA01237 80791902
*                                       ONE TRACK               XL03130 80793903
         DC    H'448'                   MAX SIZE FOR RD CNT CCW XL03130 80795903
         DC    H'400'                   MAX SIZE CNT BUFFER     XL03130 80797903
         DC    H'12288'      TOTAL DUMP BUFF SIZE              @ZA01203 80798302
LASTWIN1 DS    0H            END OF CONSTANTS THIS ENTRY.       XL03130 80798703
         SPACE 1                                                 S20201 80798803
SIZEWIN1 EQU   LASTWIN1-WINCH1 TABLE SIZE THIS DEVICE.          XL03130 80798903
         EJECT                                                          80809303
*        DEVICE CONSTANTS---UCB CODE= X'0A' - MODEL 2           XL03130 80819303
WINCH2   DS    0F            START OF MCRL CONSTANTS.           XL03130 80837403
         DC    X'02B9000B'   CCHH OF LAST ALTERNATE.            XL03130 80843303
         DC    X'0000FFF5'   CONVERSION TO CHANGE CYL.          XL03130 80849203
         DC    X'FFFF000C'   CONVERSION TO GIVE CC-1,HH+XX.     XL03130 80859203
         DC    H'50'                    MAX RECORDS PER TRACK   XL03130 80869203
         DC    H'8535'       SURFACE ANALYSIS TRACK CAPACITY    XL03130 80879203
         DC    X'02B7000B'   CCHH OF LAST PRIMARY TRACK.        XL03130 80879303
         DC    H'24'         NUMBER OF ALTERNATES.              XL03130 80892703
         DC    H'698'        NUMBER OF CYLINDERS.               XL03130 80902703
         DC    H'12'         TRACKS PER CYLINDER.               XL03130 80904703
         DC    H'8535'                  TRACK CAPACITY          XL03130 80905103
         DC    X'F2F24B'     RECORD OVERHEAD.                   XL03130 80905503
         DC    X'01'         FLAG BYTE.                          S20201 80905903
         DC    H'512'        TOLERANCE FACTOR.                  XL03130 80906003
         DC    X'16'         DSCBS PER TRACK.                   XL03130 80906103
         DC    X'10'         DIRECTORY BLOCKS PER TRACK.        XL03130 80910603
         DC    H'8376'       NUMBER OF PRIMARY TRACKS.          XL03130 80912640
         DC    H'9288'                 RESTORE BUF SIZE        @ZA04350 80914640
         DC    H'888'                   SIZE D/R WRT CKD BUFFER XL03130 80915003
         DC    H'8400'                 MAXIMUM DATA SIZE FOR   @ZA01237 80925002
*                                       ONE TRACK               XL03130 80936203
         DC    H'448'                   MAX SIZE FOR RD CNT CCW XL03130 80936603
         DC    H'400'                   MAX SIZE CNT BUFFER     XL03130 80937003
         DC    H'12288'      TOTAL DUMP BUFF SIZE              @ZA01203 80937102
LASTWIN2 DS    0H            END OF CONSTANTS THIS ENTRY.       XL03130 80937203
         SPACE 1                                                        80944903
SIZEWIN2 EQU   LASTWIN2-WINCH2 TABLE SIZE THIS DEVICE.          XL03130 80948603
         ORG   *+(3*(SIZEWIN1+2))                               XL03130 80958603
         EJECT                                                          80998603
.OSDEV   ANOP  BRANCH POINT FOR OS ASSEM                        XL03145 81077003
*                                                                     * 81112803
*   2305   DEVICE CONSTANTS---UCB CODE=6                                81150103
*                                                                       81187403
*        THIS TABLE IS FOR ZEUS ATHENS                                  81224703
*                                                                       81262003
K2305A   DS    0F                  START OF 2305 ATHENS          S20201 81299303
          DC    X'00300000'             CCHH OF LAST ALTERNATE   S20201 81336603
         DC    X'0000FFF9'         CONVERSION TO CHANGE CYL      S20201 81373903
         DC    X'FFFF0008'         CONVERSION TO GIVE CC-1,HH+XX S20201 81411203
         DC    H'33'               MAX RECORDS/TRACK             S20201 81448503
         DC    H'14576'            SURFACE ANALYSIS TRACK CAP    S20201 81485803
         DC    X'002F0007'         CCHH OF LAST PRIMARY          S20201 81523103
         DC    H'1'                NUMBER OF ALTERNATES          S20201 81560403
         DC    H'48'               NUMBER OF CYLINDERS           S20201 81597703
         DC    H'8'                TRACKS/CYLINDER               S20201 81635003
         DC    H'14568'            TRACK CAPACITY                A43208 81672303
         DC    X'027ACA'           RECORD OVERHEAD               S20201 81709603
         DC    X'09'               FLAG BYTE                     S20201 81746903
         DC    H'512'              TOLERANCE FACTOR              S20201 81784203
         DC    X'12'               DSCBS/TRACK                   S20201 81821503
         DC    X'10'               DIRECTORY BLOCKS/TRACK        A43208 81858803
         DC    H'384'              NUMBER OF PRIMARY TRACKS      S20201 81896103
         DC    H'16772'                 RESTORE BUFFER SIZE      YM3149 81933402
         DC    H'2216'                  SIZE D/R WRT CKD BUFFER  S20201 81970703
         DC    H'14548'            MAX DATA SIZE/TRK             S20201 82008003
         DC    H'576'              MAX SIZE FOR RD CNT CCWS      S20201 82045303
         DC    H'552'              MAX SIZE FOR COUNT BUFFER     S20201 82082603
         DC    H'18172'                 TOTAL DUMP BUFFER SIZE   5594   82119903
END2305A DS    0H                  END OF CONSTANTS              S20201 82157203
         SPACE                                                          82194503
SIZEATH  EQU   END2305A-K2305A     TABLE SIZE THIS DEVICE        S20201 82231803
         EJECT                                                          82269103
*   2305  DEVICE CONSTANTS---UCB CODE=7                                 82306403
*                                                                       82343703
*        THIS TABLE IS FOR ZEUS-CORINTH                                 82381003
*                                                                       82418303
K2305C   DS    0F                  START OF 2305 CORINTH         S20201 82455603
         DC    X'00600000'         CCHH OF LAST ALTERNATE        S20201 82492903
         DC    X'0000FFF9'         CONVERSION TO CHANGE CYL      S20201 82530203
         DC    X'FFFF0008'         CONVERSION TO GIVE CC-1,HH+XX S20201 82567503
         DC    H'72'               MAXIMUM RECORDS PER TRACK     S20201 82604803
         DC    H'14866'            SURFACE ANALYSIS TRACK CAP    S20201 82642103
         DC    X'005F0007'         CCHH OF LAST PRIMARY          S20201 82679403
         DC    H'1'                NUMBER OF ALTERNATES          S20201 82716703
         DC    H'96'               NUMBER OF CYLINDERS           S20201 82754003
         DC    H'8'                TRACKS/CYLINDER               S20201 82791303
         DC    H'14858'            TRACK CAPACITY               SA54635 82828603
         DC    X'01215B'           RECORD OVERHEAD               S20201 82865903
         DC    X'09'               FLAG BYTE                     S20201 82903203
         DC    H'512'              TOLERANCE FACTOR              S20201 82940503
         DC    X'22'               DSCBS/TRACK                   S20201 82977803
         DC    X'1A'               DIRECTORY BLOCKS/TRACK        S20201 83015103
         DC    H'768'              NUMBER OF PRIMARY TRKS        S20201 83052403
         DC    H'17070'            TOTAL RESTORE BUFFER SIZE    YM03149 83089702
         DC    H'2216'             SIZE D/R WRT/RD CKD CCW       S20201 83127003
*                                       BUFFER                   S20201 83164303
         DC    H'14846'            MAX. DATA SIZE/TRK            S20201 83201603
         DC    H'1088'             MAX SIZE FOR RD CNT CCWS      S20201 83238903
         DC    H'1064'             MAX SIZE FOR COUNT BUFFER     S20201 83276203
         DC    H'19472'                 TOTAL DUMP BUFFER SIZE   5594   83313503
END2305C DS    0H                  END OF CONSTANTS THIS ENTRY   S20201 83350803
         SPACE                                                          83388103
SIZECOR  EQU   END2305C-K2305C     TABLE SIZE THIS DEVICE        S20201 83425403
         EJECT                                                          83500016
*   2314 DEVICE CONSTANTS---UCB CODE=8                                  84000016
K2314    DS    0F                      START OF 2314 CONSTANTS.         84500016
         DC    X'00CA0013'             CCHH OF LAST ALTERNATE.          85000016
         DC    X'0000FFED'             CONVERSION TO CHANGE CYL.        85500016
         DC    X'FFFF0014'             CONVERSION TO GIVE CC-1,HH+XX.   86000016
         DC    H'73'                   MAXIMUM RECORDS PER TRACK.       86500016
         DC    H'7402'                 SURFACE ANALYSIS TRACK CAPACITY. 87000016
         DC    X'00C70013'             CCHH OF LAST PRIMARY TRACK.      87500016
         DC    H'60'                   NUMBER OF ALTERNATES.            88000016
         DC    H'203'                  NUMBER OF CYLINDERS.             88500016
         DC    H'20'                   TRACKS PER CYLINDER.             89000016
         DC    H'7294'                 TRACK CAPACITY.                  89500016
         DC    X'922D2D'               RECORD OVERHEAD.                 90000016
         DC    X'01'                   FLAG BYTE.                       90500016
         DC    H'534'                  TOLERANCE FACTOR.                91000016
         DC    X'19'                   DSCBS PER TRACK.                 91500016
         DC    X'11'                   DIRECTORY BLOCKS PER TRACK.      92000016
         DC    H'4000'                 NUMBER OF PRIMARY TRACKS.        92500016
         DC    H'8576'                  RESTORE BUFFER SIZE     YM03149 93000002
         DC    H'1256'                  SIZE D/R WRT CKD BUFFER  S20201 93500020
         DC    H'7312'                 MAXIMUM DATA SIZE FOR ONE TRACK. 94000016
         DC    H'608'                  MAXIMUM SIZE FOR RD CNT CCWS.    94500016
         DC    H'560'                  MAXIMUM SIZE FOR COUNT BUFFER.   95000016
         DC    H'9992'                  TOTAL DUMP BUFFER SIZE   5594   95500020
LAST2314 DS    0H                      END OF CONSTANTS THIS ENTRY.     96000016
         SPACE 1                                                        96500016
SIZE2314 EQU   LAST2314-K2314          TABLE SIZE THIS DEVICE.          97000016
         EJECT                                                          97010020
*        DEVICE CONSTANTS---UCB CODE=9                                  97020020
KMERL    DS    0F            START OF MCRL CONSTANTS.            S20201 97030020
         DC    X'019A0012'   CCHH OF LAST ALTERNATE.             S20201 97040020
         DC    X'0000FFEE'   CONVERSION TO CHANGE CYL.           S20201 97050020
         DC    X'FFFF0013'   CONVERSION TO GIVE CC-1,HH+XX.      S20201 97060020
         DC    H'98'                    MAX RECORDS PER TRACK    M4682  97070020
         DC    H'13195'      SURFACE ANALYSIS TRACK CAPACITY     S20201 97080020
         DC    X'01930012'   CCHH OF LAST PRIMARY TRACK.         S20201 97090020
         DC    H'133'        NUMBER OF ALTERNATES.               S20201 97100020
         DC    H'411'        NUMBER OF CYLINDERS.                S20201 97110020
         DC    H'19'         TRACKS PER CYLINDER.                S20201 97120020
         DC    H'13165'            TRACK CAPACITY               SA54635 97130002
         DC    X'BFBF38'     RECORD OVERHEAD.                   SA54635 97140002
         DC    X'01'         FLAG BYTE.                          S20201 97150020
         DC    H'512'        TO LERANCE FACTOR.                  S20201 97160020
         DC    X'27'         DSCBS PER TRACK.                    S20201 97170020
         DC    X'1C'         DIRECTORY BLOCKS PER TRACK.         S20201 97180020
         DC    H'7676'       NUMBER OF PRIMARY TRACKS.          SA54635 97190002
         DC    H'14728'                 RESTORE BUFFER SIZE     YM03149 97198002
         DC    H'1672'                  SIZE D/R WRT CKD BUFFER  M4682  97206020
         DC    H'13048'                 MAXIMUM DATA SIZE FOR    M4682K 97214020
*                                       ONE TRAC                 M4682  97222020
         DC    H'832'                   MAX SIZE FOR RD CNT CCWS M4682  97230020
         DC    H'784'                   MAX SIZE CNT BUFFER      M4682  97238020
         DC    H'16592'                 TOTAL DUMP BUFFER SIZE   5594   97248020
LASTMERL DS    0H            END OF CONSTANTS THIS ENTRY.        S20201 97260020
         SPACE 1                                                 S20201 97270020
SIZEMERL EQU   LASTMERL-KMERL  TABLE SIZE THIS DEVICE.           S20201 97280020
         EJECT                                                          97330003
*    TABLE ENTRIES FOR X'0A' THRU X'0C' ARE NOTCURRENTLY USED.  XL03145 97332003
         ORG   *+SIZEMERL+SIZEMERL+SIZEMERL+6                   XL03145 97340003
         EJECT                                                          97350003
*        DEVICE CONSTANTS---UCB CODE= X'0D'                     XL03145 97380003
ICEBERG  DS    0F            START OF MCRL CONSTANTS.           XL03145 97430003
         DC    X'032E0012'   CCHH OF LAST ALTERNATE.            XL03145 97480003
         DC    X'0000FFEE'   CONVERSION TO CHANGE CYL.          XL03145 97530003
         DC    X'FFFF0013'   CONVERSION TO GIVE CC-1,HH+XX.     XL03145 97580003
         DC    H'98'                    MAX RECORDS PER TRACK   XL03145 97630003
         DC    H'13195'      SURFACE ANALYSIS TRACK CAPACITY    XL03145 97680003
         DC    X'03270012'   CCHH OF LAST PRIMARY TRACK.        XL03145 97730003
         DC    H'133'        NUMBER OF ALTERNATES.              XL03145 97780003
         DC    H'815'        NUMBER OF CYLINDERS.               XM4391  97830003
         DC    H'19'         TRACKS PER CYLINDER.               XL03145 97880003
         DC    H'13165'            TRACK CAPACITY               XL03145 97930003
         DC    X'BFBF38'     RECORD OVERHEAD.                   XL03145 97980003
         DC    X'01'         FLAG BYTE.                         XL03145 98030003
         DC    H'512'        TO LERANCE FACTOR.                 XL03145 98080003
         DC    X'27'         DSCBS PER TRACK.                   XL03145 98130003
         DC    X'1C'         DIRECTORY BLOCKS PER TRACK.        XL03145 98180003
         DC    H'15352'      NUMBER OF PRIMARY TRACKS.          XL03145 98230003
         DC    H'14728'                 RESTORE BUFFER SIZE     XL03145 98280002
         DC    H'1672'                  SIZE D/R WRT CKD BUFFER XL03145 98330003
         DC    H'13048'                 MAXIMUM DATA SIZE FOR   XL03145 98380003
*                                       ONE TRAC                XL03145 98430003
         DC    H'832'                   MAX RD CNT CCWS SIZE    XL03145 98480003
         DC    H'784'                   MAX SIZE CNT BUFFER     XL03145 98530003
         DC    H'16592'                 TOTAL DUMP BUFFER SIZE  XL03145 98580003
LASTICEB DS    0H            END OF CONSTANTS THIS ENTRY.       XL03145 98630003
         SPACE 1                                                XL03145 98680003
SIZEICEB EQU   LASTICEB-ICEBERG         TABLE SIZE THIS DEVICE. XL03145 98730003
         EJECT                                                          98732003
*        SS/1 CONSTANTS PLACED HERE TO ALLOW IODEVCON POINTER  @Y30LSFY 98734003
*        TO BE ADJUSTED BY A CONSTANT FOR SS/1.                @Y30LSFY 98736003
         ORG   KMERL+832                                       @Y30LSFY 98738003
*        DEVICE CONSTANTS---SS/1 UCB CODE=9                    @Y30LSFY 98740003
SS1MER   DS    0F            START OF MCRL CONSTANTS           @Y30LSFY 98740403
         DC    X'019A0012'   CCHH OF LAST ALTERNATE.           @Y30LSFY 98742003
         DC    X'0000FFEE'   CONVERSION TO CHANGE CYL.         @Y30LSFY 98744003
         DC    X'FFFF0013'   CONVERSION TO GIVE CC-1,HH+XX.    @Y30LSFY 98746003
         DC    H'98'                    MAX RECORDS PER TRACK  @Y30LSFY 98748003
         DC    H'13195'      SURFACE ANALYSIS TRACK CAPACITY   @Y30LSFY 98750003
         DC    X'01980012'   CCHH OF LAST PRIMARY TRACK.       @Y30LSFY 98752003
         DC    H'38'         NUMBER OF ALTERNATES.             @Y30LSFY 98754003
         DC    H'411'        NUMBER OF CYLINDERS.              @Y30LSFY 98756003
         DC    H'19'         TRACKS PER CYLINDER.              @Y30LSFY 98758003
         DC    H'13165'            TRACK CAPACITY              @Y30LSFY 98760003
         DC    X'BFBF38'     RECORD OVERHEAD.                  @Y30LSFY 98762003
         DC    X'01'         FLAG BYTE.                        @Y30LSFY 98764003
         DC    H'512'        TO LERANCE FACTOR.                @Y30LSFY 98766003
         DC    X'27'         DSCBS PER TRACK.                  @Y30LSFY 98768003
         DC    X'1C'         DIRECTORY BLOCKS PER TRACK.       @Y30LSFY 98770003
         DC    H'7771'       NUMBER OF PRIMARY TRACKS.         @Y30LSFY 98772003
         DC    H'14728'                 RESTORE BUFFER SIZE    @Y30LSFY 98774003
         DC    H'1672'                  SIZE D/R WRT CKD BUFFER@Y30LSFY 98776003
         DC    H'13048'                 MAXIMUM DATA SIZE FOR  @Y30LSFY 98778003
*                                       ONE TRAC               @Y30LSFY 98780003
         DC    H'832'                  MAX SIZE FOR RD CNT CCWS@Y30LSFY 98782003
         DC    H'784'                   MAX SIZE CNT BUFFER    @Y30LSFY 98784003
         DC    H'16592'                 TOTAL DUMP BUFFER SIZE @Y30LSFY 98786003
LASTSS1M DS    0H            END OF CONSTANTS THIS ENTRY.      @Y30LSFY 98788003
         SPACE 1                                               @Y30LSFY 98790003
SIZESS1M EQU   LASTSS1M-SS1MER  TABLE SIZE THIS DEVICE.        @Y30LSFY 98792003
         EJECT                                                          98794003
         ORG   *+SIZESS1M+SIZESS1M+SIZESS1M+6                  @Y30LSFY 98798003
         EJECT                                                          98800003
*        DEVICE CONSTANTS---SS/1 UCB CODE= X'0D'               @Y30LSFY 98802003
SS1ICE   DS    0F            START OF MCRL CONSTANTS.          @Y30LSFY 98804003
         DC    X'032E0012'   CCHH OF LAST ALTERNATE.           @Y30LSFY 98806003
         DC    X'0000FFEE'   CONVERSION TO CHANGE CYL.         @Y30LSFY 98808003
         DC    X'FFFF0013'   CONVERSION TO GIVE CC-1,HH+XX.    @Y30LSFY 98810003
         DC    H'98'                    MAX RECORDS PER TRACK  @Y30LSFY 98812003
         DC    H'13195'      SURFACE ANALYSIS TRACK CAPACITY   @Y30LSFY 98814003
         DC    X'03280012'   CCHH OF LAST PRIMARY TRACK.       @Y30LSFY 98816003
         DC    H'114'        NUMBER OF ALTERNATES.             @Y30LSFY 98818003
         DC    H'815'        NUMBER OF CYLINDERS.              @Y30LSFY 98820003
         DC    H'19'         TRACKS PER CYLINDER.              @Y30LSFY 98822003
         DC    H'13165'            TRACK CAPACITY              @Y30LSFY 98824003
         DC    X'BFBF38'     RECORD OVERHEAD.                  @Y30LSFY 98826003
         DC    X'01'         FLAG BYTE.                        @Y30LSFY 98828003
         DC    H'512'        TO LERANCE FACTOR.                @Y30LSFY 98830003
         DC    X'27'         DSCBS PER TRACK.                  @Y30LSFY 98832003
         DC    X'1C'         DIRECTORY BLOCKS PER TRACK.       @Y30LSFY 98834003
         DC    H'15371'      NUMBER OF PRIMARY TRACKS.         @Y30LSFY 98836003
         DC    H'14728'                 RESTORE BUFFER SIZE    @Y30LSFY 98838003
         DC    H'1672'                  SIZE D/R WRT CKD BUFFER@Y30LSFY 98840003
         DC    H'13048'                 MAXIMUM DATA SIZE FOR  @Y30LSFY 98842003
*                                       ONE TRAC               @Y30LSFY 98844003
         DC    H'832'                   MAX RD CNT CCWS SIZE   @Y30LSFY 98846003
         DC    H'784'                   MAX SIZE CNT BUFFER    @Y30LSFY 98848003
         DC    H'16592'                 TOTAL DUMP BUFFER SIZE @Y30LSFY 98850003
LASTSS1I DS    0H            END OF CONSTANTS THIS ENTRY.      @Y30LSFY 98852003
         SPACE 1                                               @Y30LSFY 98854003
SIZESS1I EQU   LASTSS1I-SS1ICE          TABLE SIZE THIS DEVICE.@Y30LSFY 98856003
         END                                                            98858003
./  ADD  SSI=70880135,NAME=IEHDDATE
         COPY  LCGASMSW                                                 01002021
IEHDDATE CSECT                                                          01010021
 TITLE   'IEHDDATE-      DETERMINES CURRENT DATE   IEHDASDR UTILITY'    01030016
*                                                                     * 01060016
*STATUS- CHANGE LEVEL 000                                             * 01090016
*                                                                     * 01120016
*FUNCTION/OPERATION- THIS ROUTINE DETERMINES THE CURRENT DATE AS      * 01150016
*   TO THE MONTH-DAY-YEAR.                                            * 01180016
*                                                                     * 01210016
*ENTRY POINTS-  THE ONLY ENTRY POINT IS IEHDDATE.                     * 01240016
*                                                                     * 01270016
*INPUT-  REGISTER 1 MUST POINT TO AN 8-BYTE AREA TO RECEIVE THE DATE  * 01300016
*   ON ANY BOUNDARY ALIGNMENT.                                        * 01330016
*                                                                     * 01360016
*EXITS-NORMAL-  RETURN TO CALLING ROUTINE VIA LINK REGISTER.          * 01390016
*                                                                     * 01420016
*EXITS-ERROR-  NONE.                                                  * 01450016
*                                                                     * 01480016
*EXTERNAL ROUTINES-  ALWAYS ENTERED FROM AND RETURNS TO -IEHDPRNT-.   * 01510016
*                                                                     * 01540016
*SUPERVISOR MACROS-  TIME.                                            * 01570016
*                    GETMAIN.                                         * 01600016
*                    FREEMAIN.                                        * 01630016
*                                                                     * 01660016
*TABLES/WORK AREAS-  XTMN IS A TABLE OF THE NUMBER OF DAYS IN         * 01690016
*   EACH MONTH.                                                       * 01720016
*                                                                     * 01750016
*OUTPUT-  THE CURRENT DATE IN THE FORM OF -MM/DD/YY- IS PLACED IN     * 01780016
*   AN 8-BYTE RECEIVING AREA.                                         * 01810016
*                                                                     * 01840016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,NON-PRIVILEGED.                   * 01870016
*                                                                       01900016
         EJECT                                                          01930016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             02000016
GR0      EQU   0                                                        03000016
GR1      EQU   1                                                        04000016
GR2      EQU   2                                                        05000016
GR3      EQU   3                                                        06000016
GR4      EQU   4                                                        07000016
GR5      EQU   5                                                        08000016
GR6      EQU   6                                                        09000016
GR7      EQU   7                                                        10000016
GR8      EQU   8                                                        11000016
GR9      EQU   9                                                        12000016
GR10     EQU   10                                                       13000016
GR11     EQU   11                                                       14000016
GR12     EQU   12                                                       15000016
GR13     EQU   13                                                       16000016
GR14     EQU   14                                                       17000016
GR15     EQU   15                                                       18000016
         EJECT                                                          19000016
         USING *,GR11                                                   20000016
IEHDPRDA SAVE  (14,12),T               SAVE THE REGISTERS.              21000016
         LR    GR11,GR15               LOAD BASE REGISTER.              22000016
         LR    GR7,GR1                 SAVE TARGET ADDRESS.             27000016
         GETMAIN R,LV=0+ASIZE                                           27100016
         SPACE                                                          27200016
         LR    GR8,GR1                 SAVE AREA/WORKAREA ADDRESS.      27300016
         USING AREA,GR8                                                 27400016
         SPACE                                                          27500016
         ST    GR13,4(GR8)             ADDRESS OF NEW AREA TO OLD AREA. 27600016
         ST    GR8,8(GR13)             ADDRESS OF OLD AREA TO NEW AREA. 27700016
         LR    GR13,GR8                SAVE AREA ADDRESS.               27800016
         SPACE                                                          28000016
         TIME                                                           29000016
         SPACE                                                          30000016
         LR    GR0,GR1                 CONTAINS DATE.                   31000016
         SRDL  GR0,16                  SEPARATE YEARS AND DAYS.         32000016
         SRL   GR1,16                  DAYS TO LOW ORDER.               33000016
         LR    GR4,GR0                 SAVE YEAR.                       34000016
         SR    GR0,GR0                 CLEAR.                           35000016
         LA    GR3,19                  TEST TO SEE IF YEAR(IN DECIMAL)  36000016
         NR    GR3,GR4                   IS DIVISIBLE BY FOUR.          37000016
         BZ    DA010                   NO--                             38000016
         LA    GR2,18                                                   39000016
         XR    GR3,GR2                 YES-GR3 WILL CONTAIN ZERO.       40000016
         BZ    DA010                   IS THIS LEAP YEAR.               41000016
         LA    GR3,1                   NO--                             42000016
         SPACE                                                          43000016
DA010    STM   GR0,GR1,WORKAREA        SET UP FOR CONVERSION.           44000016
         CVB   GR2,72(GR13)            CONVERT DAYS TO BINARY.          45000016
         SR    GR1,GR1                 GR1 WILL COUNT MONTHS.           46000016
         LR    GR5,GR1                 CLEAR                            47000016
         SPACE                                                          48000016
DA020    LA    GR1,1(GR1)              INCREMENT MONTH.                 49000016
         IC    GR5,XTMN-1(GR1)         DAYS IN MONTH.                   50000016
         SR    GR2,GR5                 SUBTRACT FROM DAYS LEFT.         51000016
         LA    GR6,3                   CONSTANT FOR 3RD MONTH           52000016
         CLR   GR6,GR1                 IS THIS MARCH.                   53000016
         BC    7,DA030                 NO--                             54000016
         SPACE                                                          55000016
         LTR   GR3,GR3                 YES-AND IS IT LEAP YEAR.         56000016
         BC    2,DA030                 NO--                             57000016
         BCTR  GR2,0                   YES-REDUCE DAYS BY ONE.          58000016
         SPACE                                                          59000016
DA030    LTR   GR2,GR2                 ARE DAYS COUNTED DOWN TO ZERO.   60000016
         BC    2,DA020                 NO--REPEAT LOOP.                 61000016
         AR    GR2,GR5                 YES-RESTORE SUBTRACTED VALUE.    62000016
         LTR   GR2,GR2                 TEST FOR ZERO(FEBRUARY 29).      63000016
         BNZ   DA040                   NO--                             64000016
         LA    GR2,29                  YES-SET DAY FOR 29TH.            65000016
         BCTR  GR1,0                   DECREMENT TO FEBRUARY.           66000016
         SPACE                                                          67000016
DA040    LA    GR3,2                   LOOP COUNT.                      68000016
DA050    CVD   GR1,WORKAREA            CHANGE MONTH TO DECIMAL.         69000016
         L     GR5,WORKAREA+4          MONTH TO LOWER HALF.             70000016
         SLL   GR5,20                                                   71000016
         SLDL  GR4,8                   SHIFT IT UP TO YEAR OR MONTH.    72000016
         LR    GR1,GR2                 DAY                              73000016
         BCT   GR3,DA050               REPEAT UNTIL DONE.               74000016
         SLL   GR4,8                   POSITION DATE FOR STORING.       75000016
         ST    GR4,WORKAREA            STORE YEAR/MONTH/DAY FOR UNPACK. 75800016
         UNPK  WORKAREA+2(7),WORKAREA(4)   CHANGE TO GRAPHICS           76600016
         SPACE                                                          77400016
         USING TARGET,GR7                                               78200016
         MVC   MONTH(2),TMONTH         MONTH TO TARGET.                 79000016
         MVI   SLASH1,C'/'             SEPARATOR.                       79800016
         MVC   DAY(2),TDAY             DAY TO TARGET.                   80600016
         MVI   SLASH2,C'/'             SEPARATOR.                       81400016
         MVC   YEAR(2),TYEAR           YEAR TO TARGET.                  82200016
         SPACE                                                          83000016
DA060    LR    GR1,GR13                CORE TO BE RELEASED.             83400016
         L     GR13,4(GR13)            OLD SAVE AREA.                   83800016
         SPACE                                                          84200016
         FREEMAIN R,LV=0+ASIZE,A=(1)                                    84600016
         SPACE                                                          85000016
         RETURN (14,12),T,RC=0         RESTORE REGISTERS/RETURN.        86000016
         SPACE                                                          87000016
XTMN     DC    X'1F1C1F1E1F1E1F1F1E1F1E1F'  DAYS IN MONTH.              90000016
         EJECT                                                          90050016
*   DEFINITION OF TARGET AREA (8 BYTES ON ANY BOUNDARY).                90100016
TARGET   DSECT                                                          90150016
MONTH    DS    CL2                     CURRENT MONTH.                   90200016
SLASH1   DS    CL1                     MONTH/DAY SEPARATOR.             90250016
DAY      DS    CL2                     CURRENT DAY.                     90300016
SLASH2   DS    CL1                     DAY/YEAR SEPARATOR.              90350016
YEAR     DS    CL2                     CURRENT YEAR.                    90400016
         SPACE 3                                                        90450016
*   DEFINITION OF SAVE AND WORK AREAS.                                  90500016
AREA     DSECT                                                          90550016
DATESAVE DS    18F                     REGISTER SAVE AREA.              90600016
WORKAREA DS    0D                      WORK AREA ROUTINE.               90650016
         DS    CL2                                                      90700016
TYEAR    DS    CL2                     YEAR ENDS UP HERE.               90750016
TMONTH   DS    CL2                     MONTH ENDS UP HERE.              90800016
TDAY     DS    CL2                     DAY ENDS UP HERE.                90850016
         DS    CL8                                                      90870016
AEND     DS    0C                      END OF WORK AREA.                90900016
ASIZE    EQU   AEND-AREA               SIZE OF AREA.                    90950016
         END                                                            91000016
./  ADD  SSI=80740161,NAME=IEHDDOIO
         COPY  LCGASMSW                                                 00050021
IEHDDOIO CSECT                                                          00100021
*********************************************************************** 00102260
*                  FIXES THIS MODULE                                  * 00104260
*                     LATEST FIRST                                    * 00104360
*********************************************************************** 00104460
*                                                                       00106499
*C 55700,541000                              @XA21434=@ZA30990=@YA20534 00106699
*                                                                       00107299
*C 055700,437000                             @YA20010=@XA20758=@ZA26845 00107399
*                                                                       00107499
*C 542000,55700                              @ZA27730=@XA20309=@YA19677 00107599
*                                                                       00107699
*D 528100                                    @ZA13746=@XA15446=@YA14025 00108400
*C 55700,173800                              @ZA13746=@XA15446=@YA14025 00109200
*A 80600-80940,549100                        @ZA13746=@XA15446=@YA14025 00111500
*                                                                       00112840
*C 55700,445500                              @YA12939=@XA14175=@ZA10908 00115640
*A 445100-445200                             @YA12939=@XA14175=@ZA10908 00118440
*                                                                       00121260
*                                   3350 DEVICE SUPPORT        @ZA06534 00124000
*                                                                       00126860
*D 62400-62460                      @SA75996=@XA10959=@YA11189=@ZA06532 00129660
*C 55700,62500                      @SA75996=@XA10959=@YA11189=@ZA06532 00132460
*                                                                       00135203
*C 56000,62500                      @YA09679=@SA74485=@XA10384=@ZA04411 00138003
*A 55600-55700,62400-62460          @YA09679=@SA74485=@XA10384=@ZA04411 00140803
*                                                                       00143602
*C 77000                            @SA69574=@YA04867=@XA05836=@ZA01207 00146402
*                                                                       00149260
*A 516100,516200                    @SA69914=@XA05792=@YA04806=@ZA01201 00152002
*                                                                       00154060
*                        PTM XM0208 IS FIXED UNDER OS APAR NO. SA53223  00160002
*                                                XM4417=YA03005=SA67332 00170003
*  PTM XM5476 DELETES CHANGES FOR SA67332                        XM5476 00180003
*STATUS CHANGE LEVEL 000                                                00200021
*********************************************************************** 00210060
*                                                                     * 00250021
*FUNCTION/OPERATION- THIS ROUTINE HANDLES MOST OF THE I/O FOR THE     * 00300000
*   DUMP FUNCTION OF THE IEHDASDR UTILITY PROGRAM. ALL I/O INVOLVED   * 00350021
*   WITH DA AND/OR TAPE DEVICES IS AT THE EXCP LEVEL. THE FIRST       * 00400021
*   I/O OPERATION ON THE DIRECT ACCESS DEVICE RESULTS IN THE END OF   * 00450021
*   EXTENT APPENDAGE(IGG019P8) BEING ENTERED FROM IOS. THIS ROUTINE   * 00500021
*   WILL MODIFY THE DEB EXTENTS AND SET THE CORRECT FILE MASK.        * 00550021
*   PROCESSING WILL BE DONE ONE TRACK AT A TIME UNTIL EITHER THE      * 00600021
*   DUMP LIMITS OR THE VOLUME LIMITS ARE EXHAUSTED. CONTROL WILL BE   * 00650021
*   RETURNED TO -IEHDEXCP- AT THIS TIME.                              * 00700021
*                                                                     * 00750021
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDDOIO-, AND CONTROL IS     * 00800021
*   ALWAYS RECEIVED FROM THE -IEHDEXCP- ROUTINE.                      * 00850021
*                                                                     * 00900021
*INPUT- POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL BLOCK    * 00950021
*   (REGISTER 10).                                                    * 01000021
*                                                                     * 01050021
*OUTPUT TO DIRECT ACCESS- A COPY OF THE -FROM- DIRECT ACCESS          * 01100021
*   DEVICE WITH PREVIOUSLY UNOWNED TRACKS CLEANED UP.                 * 01150021
*                                                                     * 01200021
*OUTPUT TO TAPE-                                                      * 01250021
*   LIMITS RECORD- ALWAYS THE FIRST RECORD AFTER A TAPE MARK ON       * 01300021
*   EACH VOLUME OF TAPE. THIS RECORD IS 24 BYTES IN LENGTH AND        * 01350021
*   CONTAINS THE FOLLOWING INFORMATION.                               * 01400021
*                                                                     * 01450021
*        BYTES 0-3    CCHH OF THE FIRST TRACK DUMPED.                 * 01500021
*        BYTES 4-7    CCHH+1 OF THE LAST TRACK DUMPED.                * 01550021
*        BYTES 8-11   CCHH OF THE FIRST TRACK THIS VOLUME.            * 01600021
*        BYTES 12-19  CODE THAT IDENTIFIES THIS AS BEING A            * 01650021
*                     RESTORE TAPE.                                   * 01700021
*        BYTE  20     FULL DUMP SWITCH -X'F0'=FULL,X'00'=PARTIAL.     * 01750021
*        BYTE  21     DEVICE TYPE CODE AS FOLLOWS.                    * 01800021
*                        CODE 0    2321                               * 01850021
*                             1    2311                               * 01900021
*                             2    2314                               * 01950021
*                             3    2302                               * 02000021
*                             4    2303                               * 02050021
*                             5    2301                               * 02100021
*        BYTES 22-23  UNUSED.                                         * 02150021
*                                                                     * 02200021
*   CONTROL RECORD- THIS RECORD IS WRITTEN FOR EACH TRACK DUMPED      * 02250021
*   AND IMMEDIATELY PRECEDES THE DATA RECORD FOR EACH TRACK. IT       * 02300021
*   CONTAINS A CHANNEL PROGRAM USED BY RESTORE TO WRITE ONE TRACK.    * 02350021
*   THE LENGTH OF THIS RECORD DEPENDS ON THE NUMBER OF RECORDS ON     * 02400021
*   THE DUMPED TRACK.                                                 * 02450021
*                                                                     * 02500021
*   TRACK IMAGE RECORD- THIS RECORD CONTAINS THE DATA DUMPED FROM     * 02550021
*   A TRACK AND ALWAYS FOLLOWS A CONTROL RECORD.  IT IS WRITTEN AS    * 02600021
*   ONE MAXIMUM LENGTH PHYSICAL RECORD ON TAPE. IT CONTAINS THE       * 02650021
*   DATA FIELD OF RECORD ZERO AND ALL FIELDS OF OTHER RECORDS THAT    * 02700021
*   WERE ON THE TRACK THAT WAS DUMPED.                                * 02750021
*                                                                     * 02800021
*   TRAILER RECORD- THIS ALWAYS FOLLOWS THE TAPE MARK THAT WAS AT     * 02850021
*   THE END OF THE LAST TRACK IMAGE RECORD. IT IS 24 BYTES IN         * 02900021
*   LENGTH, OF WHICH ONLY THE FIRST 4 BYTES ARE USED. IT INDICATES    * 02950021
*   WHETHER THE RESTORE IS COMPLETE WHEN THE END OF THIS VOLUME       * 03000021
*   IS REACHED.                                                       * 03050021
*                                                                     * 03100021
*EXITS-NORMAL- SUCCESSFUL COMPLETION OF ALL I/O OPERATIONS RESULTS    * 03150021
*   IN A RETURN TO -IEHDEXCP- WITH A RETURN CODE OF ZERO.             * 03200021
*                                                                     * 03250021
*EXITS-ERROR-  ANY ERROR ENCOUNTERED WILL BE DESCRIBED BY AN          * 03300021
*   APPROPRIATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE        * 03350021
*   GREATER THAN ZERO WILL ALSO BE PASSED TO -IEHDEXCP-.              * 03400021
*   ERROR MESSAGES WILL BE PRINTED BY IEHDEXCP VIA THE BRANCH   SA53223 03450000
*   TABLE EXIT LABELED 'MSGWRT'.                                SA53223 03460000
*                                                                     * 03470000
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS ENTERED FROM -IEHDEXCP-.   * 03500021
*   FIVE OTHER CSECTS ARE USED BY THE ROUTINE. ANY MESSAGES WILL      * 03550021
*   BE WRITTEN OUT BY THE MESSAGE WRITER ROUTINE(IEHDPRNT) AFTER      * 03600021
*   BEING SET UP BY THE MESSAGE ROUTINE(IEHDMSGB). THE END OF         * 03650021
*   EXTENT APPENDAGE(IGG019P8) HANDLES THE LIMITS AND EXTENTS IN      * 03700021
*   THE DEB FOR ALL DA DEVICES INVOLVED. ALL DEVICE DEPENDENT         * 03750021
*   CONSTANTS WILL BE CONTAINED IN THE -IEHDCONS- CSECT. IEHDEXCP     * 03800021
*   WILL LOAD BOTH -IEHDAOUT- AND -IEHDPRNT- WHEN DUMPING TO A        * 03850021
*  SYSTEM OUTPUT DEVICE.  IEHDRCVR WILL BE LINKED TO WHEN AN I/O   O122 03900021
*  ERROR (MISSING ADDRESS MARKER OR DATA CHECK) ARE ENCOUNTERED    O122 03950021
*  WHEN DUMPING TO SYSOUT.                                         O122 04000021
*  THIS ROUTINE WILL CLOSELY INTERFACE WITH IEHDEXCP VIA A      SA53223 04010000
*  BRANCH TABLE.                                                SA53223 04020000
*  BRANCHING FROM ONE MODULE TO ANOTHER WILL BE FACILITATED VIA SA53223 04030000
*  A BRANCHING VALUE IN A PREVIOUSLY UNUSED BYTE, BRCHVAL, IN   SA53223 04042000
*  THE FUNCTION BLOCK, IEHDBLKS.                                SA53223 04046000
*                                                                     * 04050021
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE, NON-PRIVILEGED.          * 04100021
*                                                                     * 04150021
 TITLE 'IEHDDOIO-3RD CSECT OF IEHDDUMP-IEHDASDR SYSTEM UTILITY PROGRAM' 04200021
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             04250021
GR0      EQU   0                                                        04300021
GR1      EQU   1                                                        04350021
GR2      EQU   2                                                        04400021
GR3      EQU   3                                                        04450021
GR4      EQU   4                                                        04500021
GR5      EQU   5                                                        04550021
GR6      EQU   6                                                        04600021
GR7      EQU   7                                                        04650021
GR8      EQU   8                                                        04700021
GR9      EQU   9                                                        04750021
GR10     EQU   10                                                       04800021
GR11     EQU   11                                                       04850021
GR12     EQU   12                                                       04900021
GR13     EQU   13                                                       04950021
GR14     EQU   14                                                       05000021
GR15     EQU   15                                                       05050021
RCVT     EQU   9                                                        05100021
UCBPTR   EQU   9                                                        05150021
BASEREG  EQU   11                                                       05200021
WORKBASE EQU   12                                                       05250021
         SPACE 2                                                        05300021
*    MISCELLANEOUS EQUATES                                              05310003
BIT7     EQU   1                                                        05320003
         SPACE 2                                                        05330003
         USING FUNCBLK,10                                               05350021
         USING IEHDDOIO,BASEREG                                         05400021
         USING WORK,12                                                  05450021
         SAVE  (14,12),T,*             SAVE THE REGISTERS.              05500021
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          05550021
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04411 05560060
         DC    C'ZA30990'              LAST FIX THIS MOD       @ZA30990 05570099
APARNO   LA    GR7,EXCPSAVE            SAVE AREA ADDRESS.      @ZA04411 05600060
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      05650021
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      05700021
         LR    GR13,GR7                SAVE AREA FOR CALLED ROUTINES.   05750021
         USING IOBLOCKS,9                                               05800021
         LA    GR9,BLOCKS              ADDRESS PRIMARY I/O BLOCKS.      05850021
         L     GR14,FRTNPTR            LOAD RETURN ADDRESS.             05890021
         LTR   GR14,GR14                WILL BE ZERO 1ST TIME   SA53223 05890421
         BZ    START                    BRCH IF ZERO            SA53223 05890821
         XC    FRTNPTR,FRTNPTR                                          05891201
         BR    GR14                    TAKE UP WHERE WE LEFT OFF.       05892021
START    EQU   *                                                SA53223 05894021
         SR    GR3,GR3                  ZERO WORK REG           SA53223 05900021
         IC    GR3,BRCHVAL              GET BRANCH TABLE VALUE  SA53223 05950021
         XC    BRCHVAL,BRCHVAL                                          05960001
         LA    GR2,BRCHTABL             LOAD BRCH TABLE ADDR    SA53223 06000021
         AR    GR2,GR3                  COMPUTE TABLE ENTRY     SA53223 06050021
         BR    GR2                      BRCH TO ENTRY           SA53223 06100021
BRCHTABL EQU   *                                                SA53223 06150021
         B     RDCNTS                   GO READ COUNT FLDS      SA53223 06200021
         B     WRTHAR0                  GO BUILD/EXECUTE        SA53223 06210021
*                                       WRITE HA, WRITE R0.     SA53223 06230021
RDCNTS   TM    SEQSW,RPSFEAT1           RPS ON FROM DEV        @ZA06532 06250060
         BZ    RDCNTS1                  NO - CONTINUE            A42498 06300021
         L     GR2,RPSBUFPT             SET PROPPER ADDRESS IN   A42498 06350021
*                                       TIC                      A42498 06400021
         MVC   9(3,GR2),CCWBUFPT+1                               A42498 06450021
RDCNTS1  EXCP  OUTIOB                                            A42498 06500021
         CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               06550021
         BE    WAITOUT                 YES--DO NOT RETURN TO MONITOR.   06600021
*  LINK BACK TO MONITOR HERE.                                           06650021
         TM    SW1,MULTIPLE            ANY REASON TO GO BACK TO MONITOR 06700021
         BZ    WAITOUT                 NO--GO WAIT.                     06750021
         LA    GR3,WAITOUT             RETURN ADDRESS.                  06800021
         ST    GR3,FRTNPTR             SAVE IN RETURN POINTER.          06850021
         LA    GR15,0                  RETURN CODE FOR MONITOR.         06900021
         B     MULTPROC                RETURN.                  SA53223 06950021
WAITOUT  TM    OUTECB,COMPLETE         IS THE OPERATION COMPLETE.       07000021
         BO    WAITOUTA                YES--GO TEST THE STATUS.         07050021
         WAIT  ECB=OUTECB              NO---AWAIT COMPLETION OF I/O.    07100021
WAITOUTA EQU   *                                                   7343 07150021
         LA    GR2,RDCNTS              RETURN ADDRESS IF RECOVER   O122 07200021
         TM    OUTSTAT+4,X'02'         UNIT CHECK.                 7343 07250021
         BZ    WAITOUTX                NO-BRANCH.                  7343 07300021
         TM    OUTSENSE,DC             DATA CHECK.                 7343 07350021
         BO    IOERR                   YES-I/O ERROR.              7343 07400021
WAITOUTB TM    OUTSENSE+1,X'04'        CHECK FOR FILE PROTECT.          07450021
         BO    WAITOUTC                YES-GO CHECK FOR TRK OVERFLOW.   07500021
         TM    OUTSENSE,X'02'          CHECK FOR TRACK CONDITION.       07550021
         BZ    IOERR                   NO--MUST BE I/O ERROR.           07600021
WAITOUTC TM    OUTSENSE+1,X'01'        CHECK FOR OVERFLOW INCOMPLETE.   07650021
         BZ    WAITOUTX                NO                      @ZA01207 07700002
         CLI   OUTECB,X'41'             PERMANENT I/O ERROR      A45281 07750021
         BE    CHEKSTAT                 YES, ACCEPT ERROR        A45281 07800021
         OI    SWITCH,TRKOVFL          SET TRACK OVERFLOW INDICATOR.    07850021
         B     HAR0R1                  R1 IS TRACK OVERFLOW.      0811  07900021
WAITOUTX EQU   *                                                   7343 07950021
         TM    OUTSTAT+4,X'01'         EOF ON RECORD ONE.          7343 08000021
         BZ    WAITOUTD                NO-CHECK IF ALL OK.         7343 08050021
         L     GR1,OUTSTAT             GET CCW ADR FROM CSW    @ZA13746 08060099
         LA    GR1,0(GR1)              CLEAR FIRST BYTE        @ZA13746 08070099
         S     GR1,EIGHT               GET FAILING CCW         @ZA13746 08090000
         CLI   0(GR1),X'06'            READ R0 DATA ?          @ZA13746 08092099
         BE    IOERR                   YES THEN IO ERROR TERM. @ZA13746 08094099
         L     GR3,CCWBUFPT            YES-R1 IS EOF REC.          7343 08100021
         MVI   24(GR3),X'12'           SET OP CODE FOR READ COUNT. 7343 08150021
         B     RDCNTS                  RESTART CHANNEL PROGRAM.    7343 08200021
WAITOUTD EQU   *                                                   7343 08250021
         CLI   OUTECB,GOOD             ALL OK.                     7343 08300021
         BC    7,IOERR                 NO-I/O ERROR.               7343 08350021
         EJECT                                                          08400021
*********************************************************************** 08450021
*                                                                     * 08500021
*  TEST HERE TO SEE IF ONLY HOME ADDRESS,RECORD ZERO, OF HOME ADDRESS * 08550021
*  RECORD ZERO,RECORD ONE, OR RECORDS GREATER THAN RECORD ONE.        * 08600021
*                                                                     * 08650021
*********************************************************************** 08700021
         USING CCWS,2                                                   08750021
CHEKSTAT L     GR2,CCWBUFPT            RESET POINTER TO CCW BUFFER.     08800021
         LA    GR6,RDWRTCNT            COMPARE ADDR IF HA-R0 ONLY.      08850021
         ST    GR6,AREA                STORE FOR COMPARE.         0811  08900021
         CLC   AREA+1(3),OUTSTAT+1     IS CSW 8 BEYOND READ R0.   0811  08950021
         BE    HAR0                    YES--HAVE HA,R0 ONLY             09000021
         LA    GR6,8(GR6)              COMPARE ADDR. IF HA,R0,R1 ONLY.  09050021
         ST    GR6,AREA                STORE FOR COMPARE.         0811  09100021
         BAL   GR15,CHKCNTS             CHECK FOR BAD COUNT FLD SA53223 09110001
         CLC   AREA+1(3),OUTSTAT+1     IS CSW 8 BEYOND READ R1.   0811  09150021
         BE    HAR0R1                  YES--HAVE HA,R0-R1.              09200021
         B     CNGRDCKD                NO--HAVE HA,R0-RN.               09250021
WRTHAR0  L     GR6,DATBUFPT            ADDRESS OF DATA BUFFER.          09300021
         MVC   0(8,GR6),ZERO           ZERO FOR R0 DATA IF TRK NOT OWND 09350021
HAR0     CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        09400021
         BNE   ONTAPE                  NO--BRANCH.                      09450021
         LA    GR6,HAR0CCW1            GET ADDRESS OF HA-R0 CCWS        09500021
         LA    GR7,56                  SET NUMBER OF CCWS TO MOVE.      09550021
         BAL   GR14,SETUPCCW           GO TO PUT CCWS IN BUFFER.        09600021
         USING R0CCWS,8                                                 09650021
         MVC   WRITER0+1(3),DATBUFPT+1 RESET BUFFER ADDRESS             09700021
         MVC   READR0+1(3),DATBUFPT+1  RESET BUFFER ADDRESS             09750021
         LA    GR3,ZERO                SET ADDRESS OF ZEROES IN CCW     09800021
         ST    GR3,ERASEALL            TO ERASE REST OF TRACK.          09850021
         MVI   ERASEALL,X'11'          RESET OP CODE                    09900021
         B     CCWOUT                  GO TO WRITE R0-ERASE ON DA.      09950021
ONTAPE   LA    GR3,TAPECCW3                                             10000021
         ST    GR3,TOCCWAD             STORE CCW ADDRESS IN IOB.        10050021
         L     GR4,DATBUFPT            ADDRESS R0 DATA.                 10100021
         ST    GR4,8(GR3)              STORE INTO CCW.                  10150021
         MVI   8(GR3),X'01'            RESET OP CODE.                   10200021
         LA    GR4,8(GR4)              POINT TO END OF DATA.            10250021
         B     CCWOUT1                 GO TO PROCESS.                   10300021
HAR0R1   CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        10350021
         BNE   TOTAPE                  NO--BRANCH.                      10400021
         LA    GR6,CCWA                HA,R0,R1 CCWS.                   10450021
         LA    GR7,64                  LENGTH OF CCWS TO MOVE           10500021
         BAL   GR14,SETUPCCW           GO TO PUT CCWS IN BUFFER.        10550021
         USING R0CCWS,8                                                 10600021
         L     GR3,DATBUFPT            GET POINTER TO DATA BUFFER.      10650021
         LA    GR3,8(GR3)              POINT TO R1 DATA.                10700021
         ST    GR3,WRITER0             RESET ADDRESS IN WRT CKD.        10750021
         MVI   WRITER0,X'1D'           RESET WRT CKD OP CODE.           10800021
         TM    SWITCH,TRKOVFL          TRACK OVERFLOW.                  10850021
         BZ    HAR0R1A                 NO-DO NOT RESET CCW OP CODE.     10900021
         MVI   WRITER0,X'01'           RESET OP CODE FOR WRT SPECIAL.   10950021
HAR0R1A  SR    GR5,GR5                 CLEAR WORK REGISTER.             11000021
         IC    GR5,5(GR3)              KEY LENGTH FOR R1.               11050021
         AH    GR5,6(GR3)              ADD DATA LENGTH FOR R1.          11100021
         LA    GR5,8(GR5)              ADD COUNT FOR R1.                11150021
         STH   GR5,WRITER0+6           STORE TOTAL COUNT IN CCW.        11200021
         ST    GR3,ERASEALL            RESET ADDRESS IN READ BACK CHECK 11250021
         MVI   ERASEALL,X'1E'          RESET RD CKD OP CODE.            11300021
         LA    GR6,8                   SET UP COMPARE FOR EOF ON R1.    11350021
         CR    GR5,GR6                 COUNT FOR R1 EIGHT FOR EOF REC.  11400021
         BNE   HAR0R1B                 NO--DO NOT RESET OP CODE.        11450021
         MVI   ERASEALL,X'12'          YES--R1 IS EOF.RESET OP CODE.    11500021
HAR0R1B  MVC   READR0+1(3),DATBUFPT+1  RESET BUFFER ADDRESS.            11550021
         MVC   READREC0+1(3),DATBUFPT+1 RESET BUFFER ADDRESS.           11600021
         B     CCWOUT                  GO TO WRITE R0-R1 ON DA.         11650021
TOTAPE   LA    GR3,TAPECCW4            GET ADDRESS OF CCWS.             11700021
         ST    GR3,TOCCWAD             STORE CCW ADDRESS IN IOB.        11750021
         L     GR4,DATBUFPT            ADDRESS R0-R1 DATA.              11800021
         ST    GR4,8(GR3)              STORE INTO CCW.                  11850021
         MVI   8(GR3),X'01'            RESET OP CODE.                   11900021
         SR    GR5,GR5                 CLEAR OUT THE WORK REGISTER.     11950021
         IC    GR5,13(GR4)             KEY LENGTH FOR R1.               12000021
         AH    GR5,14(GR4)             ADD DATA LENGTH FOR R1.          12050021
         LA    GR5,16(GR5)             ADD DATA LENGTH R0, COUNT R1.    12100021
         STH   GR5,14(GR3)             STORE TOTAL COUNT IN CCW.        12150021
         AR    GR4,GR5                 POINT TO END OF DATA.            12200021
CCWOUT1  CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               12250021
         BNE   CCWOUT1A                NO-GO WRITE CCWS AND DATA. 0811  12300021
         BAL   GR8,LINKDOUT            YES--GO LINK TO IEHDAOUT.        12350021
         B     OUT4                    CONTINUE WITH NEXT TRACK.        12400021
CCWOUT1A EQU   *                                                  0811  12450021
         TM    SWITCH,TRKOVFL          TRACK OVERFLOW.            0811  12500021
         BZ    CCWOUT                  NO-DO NOT RESET OP CODE.   0811  12550021
         L     GR1,TAPECCW4            POINT TO CCWS TO BE WRITTEN.0811 12600021
         MVI   48(GR1),X'01'           WRITE SPECIAL OP CODE.     0811  12650021
CCWOUT   EXCP  TOIOB                   EXECUTE CHANNEL PROGRAM.         12700021
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                12750021
         BC    8,OUT3                  NO--GO TO AWAIT COMPLETION.      12800021
         L     GR3,TOCCWAD             ADDRESS OF CCWS.                 12850021
         L     GR8,COPYPTR             POINTER TO FIRST COPY BLOCK.     12900021
         USING COPYBLK,GR8                                              12950021
OUT1     LA    GR9,CIOBLOCK            ADDRESS THIS COPY I/O BLK.       13000021
         ST    GR3,TOCCWAD             CCW ADDR TO THIS COPY IOB.       13050021
         EXCP  TOIOB                   WRITE CCWS AND DATA ON TAPE.     13100021
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           13150021
         BZ    OUT2                    NO--GO TO AWAIT COMPLETION.      13200021
         L     GR8,CCOPYPTR            YES-POINTER TO NEXT COPY BLOCK.  13250021
         B     OUT1                    GO WRITE ON THE NEXT DEVICE.     13300021
OUT2     LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY DEVICES.  13350021
OUT3     BAL   GR14,WAITTO             GO TO AWAIT COMPLETION.          13400021
         B     OUT4                     RETURN TO IEHDEXCP              13410021
         EJECT                                                          13900021
*********************************************************************** 13950021
*   THIS SECTION MOVES EITHER THE HA,R0 ONLY CCWS OR THE HA,R0,R1     * 14000021
*   CCWS TO A BUFFER TO BE EXECUTED ON DIRECT ACCESS DEVICES.         * 14050021
*   ADDRESSES ARE RESET WHERE NECESSARY                               * 14100021
*********************************************************************** 14150021
SETUPCCW L     GR8,WRTBUFPT            ADDRESS OF CCW BUFFER.           14200021
         EX    GR7,MOVECCWS            MOVE NEEDED CCWS TO BUFFER.      14250021
         ST    GR8,TOCCWAD             STORE CCW ADDRESS IN IOB.        14300021
         TM    SEQSW+D1,RPSFEAT    RPS ON TODD                   S20201 14350021
         BZ    SETUP               NO                            S20201 14400021
         L     GR3,CCWBUFPT        PT TO CCW BUFR                S20201 14450021
         SH    GR3,SIXTEEN         PT TO RPS BUFR                S20201 14500021
         ST    GR8,D8(GR3)         RESET TIC ADDR                S20201 14550021
         MVI   D8(GR3),TICCODE     RESET TIC OP                  S20201 14600021
         ST    GR3,TOCCWAD         STORE RPS PTR IN IOB          S20201 14650021
SETUP    EQU   *                        *                        S20201 14700021
         USING R0CCWS,8                                                 14750021
         LA    GR3,TOSEEK+3            ADDRESS FOR SEARCH.              14800021
         ST    GR3,SEARCHR0            STORE INTO CCW.                  14850021
         LA    GR3,SEARCHR0            POINTER TO THIS CCW.             14900021
         MVI   0(GR3),X'31'            RESET OP CODE.                   14950021
         ST    GR3,TICBACK             STORE ADDRESS IN TIC.            15000021
         MVI   TICBACK,X'08'           RESET TIC OP CODE.               15050021
         LA    GR3,TOSEEK+3            ADDRESSS SEARCH ARGUMENT.        15100021
         ST    GR3,SEARCH1             STORE IN CCW.                    15150021
         LA    GR3,SEARCH1             ADDRESS SEARCH CCW.              15200021
         MVI   0(GR3),X'31'            RESET OP CODE.                   15250021
         ST    GR3,TICAGAIN            STORE ADDRESS IN TIC.            15300021
         MVI   TICAGAIN,X'08'          RESET TIC OP CODE.               15350021
         BR    GR14                    RETURN                           15400021
*********************************************************************** 15450021
* THIS SECTION BUILDS THE READ CKD CCWS WHEN HAVE MORE THAN R1 ON TRACK 15500021
*********************************************************************** 15550021
CNGRDCKD L     GR2,DATBUFPT            SET UP TO COMPUTE R1 TOTAL       15600021
         LA    GR2,8(GR2)              BUMP POINTER TO R1.              15650021
         LR    GR3,GR2                 SET 2ND REGISTER FOR ALIGN RTN.  15700021
         BAL   GR15,ALIGN              GO TO ALIGN ON DBLE WORD BDRY.   15750021
         L     GR3,CNTBUFPT            ADDRESS COUNT BUFFER.            15850021
         L     GR2,SAVESLOT            RESTORE ALIGNED POINTER.         15900021
         L     GR8,CCWBUFPT            CCW BUFF ADDRESS.                15950021
         MVC   0(8,GR2),0(GR3)         MOVE R2 COUNT FIELD TO DATA BUFF 16000021
         MVC   OUTSEEK+3(5),0(GR3) GET NEXT COUNT                A29477 16050021
         LA    GR2,8(GR2)              INCREMENT DATA BUFF PTR.         16100021
         OC    5(3,GR3),5(GR3)         IS R2 COUNT EQUAL TO ZERO.       16150021
         BC    7,NOTEOF                NO--R2 IS NOT AN EOF RECORD.     16200021
         MVC   16(8,GR8),8(GR8)        YES--MOVE IN TIC CCW.            16250021
         LA    GR6,24(GR8)             INCREMENT TO PTR TO 4TH CCW.     16300021
         ST    GR6,16(GR8)             STORE FORWARD TIC ADDRESS.       16350021
         MVI   16(GR8),X'08'           RESET TIC OP CODE.               16400021
         OI    SWITCH,R2EOF            SET R2=EOF SWITCH FOR LATER.     16450021
         LA    GR8,16(GR8)             POINT TO LAST CCW SET UP.        16500021
         LM    GR4,GR5,DMMYRCCW        DUMMY READ CCW.                  16550021
         LR    GR4,GR2                 SET DATA BUFF PTR IN CCW.        16600021
         B     CONTINUE                GO TO CHECK IF R3 THIS TRACK.    16650021
         EJECT                                                          16660021
**********************************************************************  16700021
*        FUNCTION: TEST COUNT FIELDS OF ALL RECORDS READ, TO DETERMINE  16750021
*              IF SAID COUNT FIELDS ARE IN ERROR. THAT IS, WILL THE     16800021
*              COUNT FIELDS CAUSE MORE DATA TO BE READ INTO CORE THAN   16850021
*              THE IEHDASDR BUFFER (DATBUFPT) WILL HOLD.                16900021
*              THE 'CCHH' PORTION OF COUNT FIELD WILL ALSO BE           16950021
*              CHECKED AGAINST THE INITIAL SEEK FIELD ARGUMENT, THEY    17000021
*              MUST MATCH OR IEH869I ERROR MESSAGE WILL BE ISSUED.      17050021
*              WORK REGISTERS: 1,2,3,5,6,8                              17060001
*              RETURN ON REG 15                                         17070001
**********************************************************************  17100021
         USING TESTCNT,GR3                                      SA53223 17102021
         USING CONSTANT,GR5                                     SA53223 17110021
CHKCNTS  EQU   *                                                SA53223 17120001
         SR    GR6,GR6                  ZERO WORK REG           SA53223 17130001
         L     GR3,DATBUFPT             LOAD ADDR R1 CNT        SA53223 17130401
         LA    GR3,8(GR3)               INCRE PAST R0 DATA      SA53223 17180401
         L     GR5,IODEVCON             LOAD DEVICE CONSTNT PTR SA53223 17350001
         L     GR1,OUTSTAT              GET IOBCSW CCW PTR      SA53223 17360001
         LA    GR1,0(GR1)               ZERO HIGH BYTE          SA53223 17370001
         S     GR1,EIGHT                BACKUP TO FAILING CCW  @ZA13746 17380000
         L     GR1,0(GR1)               LOAD END OF CNT ADDR    SA53223 17382001
         LA    GR1,0(GR1)               ZERO HIGH BYTE          SA53223 17390001
         SR    GR8,GR8                  ZERO TRACK TOTAL REG    SA53223 17400021
COMPSK   EQU   *                                                SA53223 17450001
         SR    GR2,GR2                  ZERO RECORD-TOTAL REG   SA53223 17700021
         IC    GR2,TESTKEY              GET KEY LENGTH          SA53223 17750021
         LA    GR2,L8(GR2)              ADD CNT FLD LENGTH      SA53223 17800021
         MVC   HAFWD(L2),TESTDL         MOVE DATA-LENGTH FIELD  SA53223 17850021
         A     GR2,FULWD                ADD DATA LGTH TO        SA53223 17900021
*                                       KEY LGTH + CNT FLD LGTH SA53223 17950021
         AR    GR8,GR2                  ADD THIS RECORDS' LGTH  SA53223 18000021
*                                       TO ALL OTHER RECS ON    SA53223 18050021
*                                       THIS TRK .              SA53223 18100021
         CH    GR8,DATASIZE             IS TOTAL GT BUFFER SIZE SA53223 18150001
         BH    BADCNT                   IF HIGH, ISSUE MSG      SA53223 18200021
         CLC   CCHHONE(L4),TESTCNT      DOES THIS RECORDS'      SA53223 18210001
*                                       'CCHH' MATCH THIS TRKS' SA53223 18220001
*                                       'CCHH'  ?               SA53223 18230001
         BNE   BADCNT                   IF NOT, ISSUE MSG69     SA53223 18240001
         LTR   GR6,GR6                  FRIST TIME THRU ?       SA53223 18240401
         BNZ   CHKCNT                   NO, NOT 1ST TIME THRU   SA53223 18240801
         CLC   AREA+1(3),OUTSTAT+1      ONLY R1 THIS TRK ?      SA53223 18241201
         BE    LEAVE                    YES, EXIT               SA53223 18241601
         L     GR3,CNTBUFPT             LOAD COUNT FLD BUFF PTR SA53223 18242001
         LA    GR6,LEAVE                SET FIRST TIME SWT      SA53223 18242401
         B     COMPSK                   GO TOTAL R2-RN CNT FLDS SA53223 18242501
CHKCNT   EQU   *                                                SA53223 18242801
         LA    GR3,L8(GR3)              INCRE COUNT FIELD PTR   SA53223 18250021
         CR    GR3,GR1                  REACHED END OF COUNT    SA53223 18300001
*                                       FIELD BUFFER YET ?      SA53223 18350021
         BL    COMPSK                   IF NOT, CHK NEXT COUNT  SA53223 18400021
LEAVE    EQU   *                                                SA53223 18402001
         L     GR2,CCWBUFPT             RELOAD WORK REG         SA53223 18410001
         L     GR6,AREA                 RELOAD WORK REG         SA53223 18420001
         BR    GR15                     RETURN                  SA53223 18450021
BADCNT   EQU   *                                                SA53223 18500021
         LA    GR1,MSG69                SET MESSAGE NO.         SA53223 18550021
         BAL   GR8,SETUPMSG             GO LINK TO IEHDMSGB     SA53223 18560021
         L     GR8,CCHHONE              LOAD CURRENT TRK ADDR   SA53223 18560401
         ST    GR8,CONVAD               STORE CURRENT TRK ADD  @ZA06534 18562000
         UNPK  CONVAD(9),CONVAD(5)      UNPK CCHH IN ERROR     @ZA06534 18572000
         TR    CONVAD(L8),TRT-240       TRANSLATE CCHH         @ZA06534 18582000
         SH    GR1,OFFSET               ADJUST LINE PTR ADDR    SA53223 18592000
         MVC   D0(L8,GR1),CONVAD        MOVE CCHH TO MSG       @ZA06534 18602000
         MVC   18(L8,GR1),DDNAME1      MOVE DDNAME TO MSG       SA53223 18634600
         B     MSGWRT                   GO SET BRCH TABLE VALUE SA53223 18642321
*                                       FOR IEHDEXCP.           SA53223 18650021
TRT      DC    C'0123456789ABCDEF'      TRANSLATE TABLE         SA53223 18652002
SETUPMSG EQU   *                                                SA53223 18660021
         LINK  EP=IEHDMSGB                                      SA53223 18670021
         BR    GR8                      RETURN                  SA53223 18680021
         DROP  GR3                                              SA53223 18700021
         DROP  GR5                                              SA53223 18750021
         EJECT                                                          18760021
NOTEOF   LM    GR4,GR5,DMMYRCCW        DUMMY READ CCW.                  18800021
         IC    GR5,5(GR3)              R2 KEY LENGTH.                   18850021
         AH    GR5,6(GR3)              R2 DATA LENGTH.                  18900021
         LR    GR4,GR2                 SET DATA BUFF PTR IN CCW.        18950021
         LA    GR8,16(GR8)             POINT TO FIRST READ CCW.         19000021
         STM   GR4,GR5,0(GR8)          STORE RD KEY/DATA R2 CCW.        19050021
         MVI   0(GR8),X'0E'            RESET OP CODE.                   19100021
         MVI   4(GR8),X'40'            RESET FLAGS.                     19150021
CONTINUE LA    GR6,8                   SET UP INCREMENTING FACTOR.      19200021
         AR    GR3,GR6                 POINT TO NEXT COUNT FIELD.       19250021
         LA    GR5,0(GR5)              CLEAR HIGH ORDER BYTE.           19300021
         AR    GR4,GR5                 ADD R2 COUNT TO DATA PTR.        19350021
         L     GR7,OUTSTAT             LOAD ADDRESS LAST RD CNT CCW.    19400021
         LA    GR7,0(GR7)              CLEAR HIGH ORDER BYTE.           19450021
         SH    GR7,THIRTY2             POINT TO LAST CCW EXECUTED.      19500021
         CR    GR7,GR8                 JUST HA THRU R2 THIS TRACK.      19550021
         BE    CCOFF                   YES-GO TO READ IN R2 KEY/DATA.   19600021
         NI    SWITCH,X'BF'            SET R2=EOF SWITCH OFF.           19650021
         AR    GR2,GR5                 ADD R2 KEY/DATA LENGTH TO PTR.   19700021
         BAL   GR15,ALIGNA             PROCESS FOR DBLE WORD BOUNDARY.  19750021
         AR    GR8,GR6                 INCREMENT CCW POINTER.           19800021
NEWRDCKD L     GR4,SAVESLOT            POINTER INTO CCW.                19850021
         SR    GR5,GR5                 CLEAR WORK REGISTER.             19900021
         IC    GR5,5(GR3)              GET THE KEY LENGTH FROM CNT BUF. 19950021
         AH    GR5,6(GR3)              ADD THE DATA LENGTH.             20000021
         AR    GR5,GR6                 ADD COUNT LENGTH.                20050021
         O     GR5,MSKFLGON            SET THE FLAGS.                   20100021
         STM   GR4,GR5,0(GR8)          STORE CCW IN LIST.               20150021
         MVI   0(GR8),X'1E'            RESET OP CODE.                   20200021
         CLC   6(2,GR3),ZERO           IS DATA LENGTH = 0.              20250021
         BNE   ZEROFLG                 NO,NOT EOF RECORD.               20300021
         CLI   5(GR3),X'00'            IS KEY LENGTH = ZERO.            20350021
         BNE   ZEROFLG                 NO,NOT EOF RECORD.               20400021
         MVI   0(GR8),X'12'            EOF RECORD, CHANGE OP CODE.      20450021
ZEROFLG  LA    GR4,0(GR4)              CLEAR OUT OP CODE.               20500021
         LA    GR5,0(GR5)              CLEAR OUT FLAGS.                 20550021
         AR    GR4,GR5                 ADD COUNT TO ADDRESS.            20600021
         ST    GR4,SAVESLOT            STORE FOR ALIGNMENT ROUTINE.     20650021
         BAL   GR15,ALIGNB             GO TO CHECK DOUBLE WORD BNDRY.   20700021
         AR    GR3,GR6                 BUMP COUNT FIELD POINTER.        20750021
         BXLE  GR8,GR6,NEWRDCKD        UPDATE CCW ADDRESS POINTER.      20800021
CCOFF    ST    GR4,TOTAL               STORE END OF DATA POINTER.       20850021
         TM    SWITCH,R2EOF            IS R2=EOF SWITCH STILL ON.       20900021
         BO    EOFONR2                 YES--NO EXCP THIS TRACK.   0811  20950021
*        L     GR5,4(GR7)              COUNT FIELD OF LAST CCW. SA51474 21000021
*        LA    GR5,1(GR5)              INCREMENT COUNT TO FORCE SA51474 21050021
*                                      TRACK OVERFLOW IF TRUE.  SA51474 21100021
*        ST    GR5,4(GR7)              COUNT TO LAST RD CCW.    SA51474 21150021
CCOFF1   MVI   4(GR7),X'20'            SET CC OFF IN LAST CCW.          21200021
READCKD  EXCP  OUTIOB                  2ND PASS-READ IN CNT,KEY,DATA.   21250021
EOFONR2  CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        21300021
         L     GR1,WRTBUFPT            ADDR FOR WRT/RD CKD CCWS.        21350021
         L     GR6,CCWBUFPT            ADDR RD CKD CCWS.                21400021
         L     GR3,DATBUFPT            ADDRESS OF DATA BUFFER.          21450021
         BNE   TAPEOUT                 NO--TAPE--BRANCH.                21500021
         L     GR2,DATBUFPT            ADDR DATA BUFFER.                21550021
         BAL   GR14,RESET              GO TO SET UP WRT CKD CCWS.       21600021
         L     GR6,WRTBUFPT            ADDR. BEGINNING WRT CKD CCWS.    21650021
         L     GR3,DATBUFPT            INITIALIZE DATA POINTER.         21700021
         BAL   GR14,SKIPON             GO TO SET SKIP BIT ON.           21750021
         TM    SWITCH,R2EOF            WAS R2 EOF AND LAST REC THIS TRK 21800021
         BO    NOWAIT                  YES--NO WAIT TODAY.              21850021
         BAL   GR14,WAITDISK           GO TO WAIT COMPLETION ON RDCKD.  21900021
NOWAIT   L     GR3,WRTBUFPT            ADDR WRT/RD CKD CCWS.            21950021
         ST    GR3,TOCCWAD             STORE CCW ADD IN IOB.            22000021
         TM    SEQSW+D1,RPSFEAT    RPS ON TODD                   S20201 22050021
         BZ    NOWAIT1             NO                            S20201 22100021
         L     GR14,CCWBUFPT       PT TO CCW BUFR                S20201 22150021
         SH    GR14,SIXTEEN        PT TO RPS BUFR                S20201 22200021
         ST    GR14,TOCCWAD        PTR TO IOB                    S20201 22250021
         ST    GR3,D8(GR14)        RESET TIC ADDR                S20201 22300021
         MVI   D8(GR14),TICCODE    RESET TIC OP                  S20201 22350021
NOWAIT1  EQU   *                        *                        S20201 22400021
         TM    SWITCH,TRKOVFL          TRACK OVERFLOW.            0811  22450021
         BC    8,CKDOUT                NO-GO WRITE ON TO DEVICE.  0811  22500021
         BAL   GR15,SETWRTSP           YES-SET UP WRT SPECIAL CCW.0811  22550021
         B     CKDOUT                  GO EXEC WRT/RD CKD CCWS.         22600021
TAPEOUT  CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               22650021
         BNE   TAPEOUT1                NO--GO TO PROCESS FOR TAPE.      22700021
         TM    SWITCH,R2EOF            WAS SECOND PASS NECESSARY.       22750021
         BO    TAPEOUT2                NO---NO WAIT TODAY.              22800021
         BAL   GR14,WAITDISK           GO TO AWAIT COMPLETION.          22850021
TAPEOUT2 L     GR4,TOTAL               END OF DATA POINTER.             22900021
         BAL   GR8,LINKDOUT            LINK TO IEHDAOUT.                22950021
         B     PROC4                   CONTINUE WITH NEXT TRACK.        23000021
TAPEOUT1 LA    GR2,R0R1CCWS            ADDR. OF SEEK AND SFM CCWS.      23050021
         MVC   0(16,GR1),0(GR2)        MOVE INTO WRT BUFFER.            23100021
         LA    GR1,16(GR1)             RESET BUFFER POINTER.            23150021
         LH    GR2,BUFFADDR            S/A D/R BUFFER ADDRESS.          23200021
         BAL   GR14,RESET              GO TO RESET ADDR. AND OP CODES.  23250021
         L     GR6,WRTBUFPT            ADDR. BEGINNING WRT CKD CCWS.    23300021
         LA    GR6,16(GR6)             POINT TO SEARCH,TIC CCWS.        23350021
         LH    GR2,BUFFADDR            INITIALIZE S/A D/R BUFF ADDR.    23400021
         BAL   GR14,SKIPON             GO TO SET SKIP BIT ON.           23450021
         LA    GR3,TAPECCW2            ADDRESS OF WRITE CCW.            23500021
         L     GR2,WRTBUFPT            ADDR WRT/RD CKD CCWS.            23550021
         SH    GR2,SIXTEEN             PROVIDE PADDING FOR CCWS.        23600021
         SR    GR1,GR2                 GR1 HAS LENGTH WRT/RD CKD CCWS.  23650021
         ST    GR1,4(GR3)              STORE LENGTH OF CCW REC. IN CCW  23700021
         MVI   4(GR3),X'20'            RESET THE FLAGS.                 23750021
         ST    GR2,0(GR3)              STORE BUFF ADDR. IN CCW.         23800021
         MVI   0(GR3),X'01'            RESET WRITE OP CODE.             23850021
         ST    GR3,TOCCWAD             STORE ADDRESS IN IOB.            23900021
         NI    TOFLGS,X'02'            INDICATE NO CMD CHAINING.        23950021
         EXCP  TOIOB                   WRITE OUT CCW REC ON TAPE.       24000021
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                24050021
         BC    8,SETSW                 NO--GO TO AWAIT COMPLETION.      24100021
         L     GR8,COPYPTR             POINTER TO FIRST COPY BLOCK.     24150021
         USING COPYBLK,8                                                24200021
TAPEOUTA LA    GR9,CIOBLOCK                                             24250021
         ST    GR3,TOCCWAD             CCW ADDRESS TO COPY IOB.         24300021
         EXCP  TOIOB                   WRITE CCWS TO TAPE COPY.         24350021
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           24400021
         BZ    TAPEOUTB                NO--GO TO AWAIT COMPLETION.      24450021
         L     GR8,CCOPYPTR            POINTER TO NEXT COPY BLOCK.      24500021
         B     TAPEOUTA                GO WRITE ON THE NEXT DEVICE.     24550021
TAPEOUTB LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY DEVICES.  24600021
SETSW    BAL   GR14,WAITTO             GO TO AWAIT COMPLETION.          24650021
         TM    SWITCH,R2EOF            WAS R2 EOF AND LAST REC THIS TRK 24700021
         BO    NOWAIT2                 YES--NO WAIT TODAY.              24750021
         BAL   GR14,WAITDISK           WAIT ON READ CKD CCWS.           24800021
NOWAIT2  L     GR1,TOTAL               END OF DATA POINTER.             24850021
         L     GR2,DATBUFPT            BEGINNING OF DATA BUFFER.        24900021
         SR    GR1,GR2                 GR1 HAS LENGTH OF DATA.          24950021
         LA    GR3,TAPECCW2        ADDRESS OF WRITE CCW.           0161 25000021
         TM    SWITCH,TRKOVFL          TRACK OVERFLOW.            0811  25050021
         BC    8,NOWAIT3               NO-CONTINUE.               0811  25100021
         L     GR3,WRTBUFPT            POINT TO WRT/RD CCWS.      0811  25150021
         LA    GR3,16(GR3)             INDEX PAST SEEK,SFM CCWS.  0811  25200021
         BAL   GR15,SETWRTSP           YES-SET UP WRT SPECIAL CCW.0811  25250021
         OI    TOFLGS,X'42'            SET CMD. CHAINING IN IOB.  0811  25300021
         L     GR3,CNTBUFPT            BUFFER POINTER.            0811  25350021
         ST    GR3,TOCCWAD             STORE ADDRESS IN IOB.      0811  25400021
         MVI   0(GR3),X'0C'            SET OP CODE IN CCW.        0811  25450021
         MVC   1(3,GR3),CCWBUFPT+1     ADDRESS FOR READ BACKWARD. 0811  25500021
         MVI   4(GR3),X'70'            SET FLAGS IN CCW.           2920 25550021
         MVC   5(3,GR3),TAPECCW2+5     LENGTH OF CCW RECORD.      0811  25600021
         MVC   8(8,GR3),TAPECCW2       WRITE CCW RECORD CCW.      0811  25650021
         MVI   12(GR3),X'60'           CHAINING.                  0811  25700021
         MVC   16(8,GR3),TAPECCW2      WRITE DATA RECORD CCW.     0811  25750021
         LA    GR3,16(GR3)             POINT TO WRT DATA CCW.     0811  25800021
NOWAIT3  ST    GR1,4(GR3)              DATA LENGTH TO CCW.        0811  25850021
         MVI   4(GR3),X'20'            RESET THE FLAGS.                 25900021
         ST    GR2,0(GR3)              STORE BUFFER ADDR IN CCW.        25950021
         AIF   ('&LIB' EQ 'LIB1').OSASSEM  BRCH IF OS ASSSEMBLY Y02113  26410002
*        TIMESTAMP WILL BE PLACED INTO FORMAT 4 DSCB HERE.      Y02113  26420002
         TM    TIMESET,TIMECHK          HAS F4 DSCB BEEN UPDATED Y02113 26440002
         BO    TIMEOK                   YES, DON'T CHECK        Y02113  26442002
         CLC   OUTSEEK+D3(L4),TIMESTMP  IS THIS THE F4 DSCB     Y02113  26446002
         BNE   TIMEOK                   NO, DON'T STORE CLOCK   Y02113  26448402
         STCK  CLOCK(GR2)               PUT TIMESTAMP IN DSCB   Y02113  26449202
         OI    TIMESET,TIMECHK          SET TIME CHECK SWT      Y02113  26449602
TIMEOK   EQU   *                                                Y02113  26449702
.OSASSEM ANOP  BRCH POINT FOR OS ASSEM.                         Y02113  26449802
         MVI   0(GR3),X'01'            RESET OP CODE.                   26449902
         MVI   R,0                     SET SEARCH ARG. FOR REC ZERO.    26450021
CKDOUT   EXCP  TOIOB                   EXEC OR WRITE WRT/RD CKD CCWS.   26500021
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                26550021
         BC    8,PROC3                 NO--GO TO AWAIT COMPLETION.      26600021
         L     GR3,TOCCWAD             POINTER TO CCWS.                 26650021
         L     GR8,COPYPTR             POINTER TO FIRST COPY BLOCK.     26700021
         USING COPYBLK,GR8                                              26750021
PROC1    LA    GR9,CIOBLOCK                                             26800021
         ST    GR3,TOCCWAD             STORE CCW PTR. IN COPY IOB.      26850021
         EXCP  TOIOB                   EXEC OR WRT CCWS.                26900021
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           26950021
         BZ    PROC2                   NO--GO TO AWAIT COMPLETION.      27000021
         L     GR8,CCOPYPTR            YES-POINTER TO NEXT COPY BLOCK.  27050021
         B     PROC1                   GO WRITE ON NEXT DEVICE.         27100021
PROC2    LA   GR9,BLOCKS               ADDRESSING FOR PRIMARY DEVICES.  27150021
         TM    SW1,MULTIPLE            ANY REASON TO GO BACK TO MONITOR 27200021
         BZ    PROC3                   NO--GO TO WAIT.                  27250021
         LA    GR3,PROC3               RETURN ADDRESS.                  27300021
         ST    GR3,FRTNPTR             SAVE IN RETURN POINTER.          27350021
         LA    GR15,0                  RETURN CODE FOR MONITOR.         27400021
         B     MULTPROC                RETURN.                          27450021
PROC3    BAL   GR14,WAITTO             GO TO AWAIT COMPLETION.          27500021
         CLI   DEVSW,X'FF'              IS THIS A DISK TO DISK   A37209 27550021
*                                       DUMP                     A37209 27600021
         BNE   PROC4                    NO, MUST BE TAPE         A37209 27650021
*        READ IN VOLUME ID IF FIRST ENTRY                             * 27700021
         CLI   IODEVCON,X'05'           IS THIS A 2321           A52430 27750021
         BE    PROC4                    YES, GO TO PROC4         A52430 27800021
         TM    FLGBYT1,BIT7             IS THIS THE FIRST ENTRY XL03130 27850003
         BO    PROC4                    YES, CONTINUE PROCESSING A37209 27900021
         OI    FLGBYT1,BIT7             SET FIRST ENTRY SWITCH  XL03130 27950003
         LA    GR3,SRCHKEYR             ADDR OF CCW TO READ IN   A37209 28000021
*                                         RECORD THREE                  28050021
         ST    GR3,TOCCWAD              SET UP IOB               A37209 28100021
         XC    TOSEEK+3(4),TOSEEK+3     CLEAR SEEK ADDR          A37209 28150021
         BAL   GR3,VOLIDCP              GO ISSUE CHANNEL PROGRAM A37209 28200021
*        REPLACE NEW VOLUME ID WITH THE ORIGINAL                      * 28250021
         L     GR3,TUCBPTR              GET PTR TO UCB           A37209 28300021
         MVC   RDVOLBUF+4(6),28(GR3)    PUT ORIGINAL IN BUFFER   A37209 28350021
         LA    GR3,SRCHKEYW             ADDR OF CCW TO WRITE OUT A37209 28400021
*                                         RECORD THREE                  28450021
         ST    GR3,TOCCWAD              SET UP IOB               A37209 28500021
         OC    COPYPTR(4),COPYPTR       ANY COPIES               A37209 28550021
         BZ    GOWRT                    NO, CONTINUE             A37209 28600021
*        SET UP COPY BLOCKS                                           * 28650021
         L     GR8,COPYPTR                                       A37209 28700021
         USING COPYBLK,8                                         A37209 28750021
LOOPWRT  EQU   *                                                 A37209 28800021
         LA    GR9,CIOBLOCK                                      A37209 28850021
         ST    GR3,TOCCWAD              POINT TO CHANNEL PROGRAM A37209 28900021
         OC    CCOPYPTR(4),CCOPYPTR     ANY COPIES               A37209 28950021
         BZ    GOWRT                    NO, GO WRITE COPIES      A37209 29000021
         L     GR8,CCOPYPTR             POINT TO NEXT COPY BLOCK A37209 29050021
         DROP  8                                                 A37209 29100021
         B     LOOPWRT                  GO SET UP NEXT COPY      A37209 29150021
*        EXECUTE CHANNEL PROGRAM TO WRITE OUT FIRST VOLUME ID         * 29200021
GOWRT    EQU   *                                                 A37209 29250021
         LA    GR9,BLOCKS               PRIMARY I/O BLOCKS       A37209 29300021
         BAL   GR3,VOLIDCP              GO ISSUE CHANNEL PROGRAM A37209 29350021
         MVC   TOSEEK+3(4),CCHHONE      CCHH OF FIRST TRACK      A37209 29400021
         OC    COPYPTR(4),COPYPTR       MORE COPIES              A37209 29450021
         BZ    ENDVOLID                 NONE LEFT                A37209 29500021
*        EXECUTE CHANNEL PROGRAM FOR COPIES                           * 29550021
         L     GR8,COPYPTR                                       A37209 29600021
         USING COPYBLK,GR8                                       A37209 29650021
COPYIT   LA    GR9,CIOBLOCK                                      A37209 29700021
         XC    TOSEEK+3(4),TOSEEK+3     CLEAR SEEK ADDR          A37209 29750021
         L     GR3,CUCBPTR              GET ADDR OF COPY UCB PTR A37209 29800021
         MVC   RDVOLBUF+4(6),28(GR3)    MOVE IN NEXT VOLID       A37209 29850021
         BAL   GR3,VOLIDCP              GO ISSUE CHANNEL PROGRAM A37209 29900021
         MVC   TOSEEK+3(4),CCHHONE      CCHH OF FIRST TRACK      A37209 29950021
         OC    CCOPYPTR(4),CCOPYPTR     MORE COPIES              A37209 30000021
         BZ    ENDVOLID                 NONE LEFT                A37209 30050021
         L     GR8,CCOPYPTR                                      A37209 30100021
         B     COPYIT                   MAKE NEXT COPY           A37209 30150021
*        SHARED EXCP, WAIT, AND TEST FOR I/O ERROR                    * 30200021
VOLIDCP  EQU   *                                                 A37209 30250021
         EXCP  TOIOB                                             A37209 30300021
         WAIT  ECB=TOECB                                         A37209 30350021
         CLI   TOECB,GOOD               CHECK FOR GOOD I/O       A37209 30400021
         BNE   IOTERR                   YES                      A37209 30450021
         BR    GR3                      RETURN TO                A37209 30500021
ENDVOLID LA    GR9,BLOCKS                                        A37209 30550021
         B     PROC4                    RETURN TO IEHDEXCP              30560021
         SPACE                                                    0811  30800021
SETWRTSP LA    GR3,24(GR3)             POINT TO WRT R1 CCW.       0811  30850021
         L     GR0,AREA                LENGTH OF CCW'S > R2.      0811  30900021
         AR    GR3,GR0                 POINT TO LAST WRT CCW.     0811  30950021
         MVI   0(GR3),X'01'            WRITE SPECIAL OP CODE.     0811  31000021
         BR    GR15                    RETURN TO CALLER.          0811  31050021
         EJECT                                                          31100021
*********************************************************************** 31150021
*                                                                     * 31200021
*   THIS SECTION BUILDS THE WRITE/READ COUNT/KEY/DATA CCWS TO BE      * 31250021
*        EXECUTED FOR DIRECT ACCESS OUTPUT OR WRITTEN OUT AS A CCW    * 31300021
*        RECORD FOR TAPE OUTPUT.                                      * 31350021
*                                                                     * 31400021
*        REGISTER 1 MUST CONTAIN POINTER TO THE WRT BUFF.             * 31450021
*        REGISTER 3 MUST CONTAIN POINTER TO THE DATA BUFF.            * 31500021
*        REGISTER 6 MUST CONTAIN POINTER TO THE CCW BUFF.             * 31550021
*        REGISTER 7 WILL CONTAIN ADDRESS OF LAST RD CKD CCW.          * 31600021
*                                                                     * 31650021
*********************************************************************** 31700021
RESET    LA    GR5,CCWA                ADDR SEARCH R0,TIC,WRT CKD R1.   31750021
         MVC   0(24,GR1),0(GR5)        MOVE THREE CCWS TO WRT BUFF.     31800021
         MVC   24(8,GR1),16(GR5)       MOVE IN 2ND WRT CKD CCW FOR R2.  31850021
         LA    GR4,2                   SET UP LOOP CONTROL.             31900021
         LA    GR3,8(GR3)              BUMP DATA POINTR TO REC ONE.     31950021
         CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        32000021
         BNE   RESET1                  NO-TAPE-DO NOT RESET ADDRESS.    32050021
         LA    GR0,TOSEEK+3            ADDRESS FOR SEARCH.              32100021
         ST    GR0,0(GR1)              STORE ADDRESS IN SEARCH CCW.     32150021
         MVI   0(GR1),X'31'            RESET OP CODE.                   32200021
         ST    GR1,8(GR1)              RESET TIC ADDRESS.               32250021
         MVI   8(GR1),X'08'            RESET TIC OP CODE.               32300021
RESET1   LA    GR1,16(GR1)             RESET WRT BUFF PTR.              32350021
         SR    GR7,GR6                 GR7 HAS LENGTH OF RD CKD CCWS.   32400021
         L     GR5,TICADDR              LOAD TIC ADDRESS         S20201 32450021
         AR    GR5,GR7                  ADD RD CKD LENGTH TO TIC S20201 32500021
         ST    GR5,CCWB+8               TIC ADDR                 M5599  32550021
         MVI   CCWB+8,X08               TIC OP                   M5599  32600021
         LA    GR2,8(GR2)              RESET DATA BUFF PTR TO REC ONE.  32650021
RESET11  ST    GR2,0(GR1)              ST R1 DATA PTR IN CCW.           32700021
         SR    GR5,GR5                 CLEAR WORK REGISTER.             32750021
         IC    GR5,5(GR3)              KEY LENGTH.                      32800021
         AH    GR5,6(GR3)              PLUS DATA LENGTH.                32850021
         LA    GR5,8(GR5)              PLUS COUNT LENGTH.               32900021
         STH   GR5,6(GR1)              STORE NEW COUNT INTO CCW.        32950021
         AR    GR3,GR5                 ADD R1 LENGTH.                   33000021
         AR    GR2,GR5                 ADD R1 LENGTH TO DATA PTR.       33050021
         ST    GR3,SAVESLOT            STORE TO SEE IF DOUBLE WORD.     33100021
         BAL   GR15,ALIGNB             GO TO CHECK DOUBLE WORD ALIGNMT. 33150021
         L     GR3,SAVESLOT            POINTER BACK INTO REGISTER.      33200021
         BAL   GR15,ALIGNA             GO TO CHECK DOUBLE WORD ALIGNMT. 33250021
         L     GR2,SAVESLOT            POINTER BACK INTO REGISTER.      33300021
         MVI   0(GR1),X'1D'            RESET OP CODE.                   33350021
         LA    GR1,8(GR1)              RESET WRT BUFF POINTER.          33400021
         BCT   GR4,RESET11             LOOP THRU TO PROCESS R2.         33450021
RESETA   LA    GR6,24(GR6)             INCREMENT RD CKD PTR TO R3.      33500021
         LA    GR8,16                  DECREMENT FACTOR.                33550021
         SR    GR7,GR8                 SUBTRACT FROM LENGTH COUNTER.    33600021
         ST    GR7,AREA                STORE LENGTH OF CCW'S > R2.0811  33650021
*                                      IF ZERO,CLEAR WORK AREA.         33700021
         LTR   GR7,GR7                 MORE THAN TWO RECORDS.           33750021
         BCR   8,GR14                  NO-2 RECS-RETURN.          0811  33800021
         LR    GR8,GR1                 SET UP FOR EXECUTE.              33850021
         SPACE                                                          33900021
         BAL   GR15,RESETCCW           MOVE CCWS FOR WRITE.             33950021
         OI    4(GR7),X'60'            SET FLAGS IN LAST CCW.           34000021
RESETB   CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        34050021
         BE    RESETC                  YES--DO NOT CHANGE DATA PTR.     34100021
         ST    GR2,0(GR1)              STORE DATA BUFF PTR INTO CCW.    34150021
         LH    GR5,6(GR1)              INSERT COUNT FROM CCW.           34200021
         AR    GR2,GR5                 ADD COUNT TO DATA POINTER.       34250021
         BAL   GR15,ALIGNA             GO TO CHECK DOUBLE WORD BDRY.    34300021
         L     GR2,SAVESLOT            POINTER BACK INTO REGISTER.      34350021
RESETC   MVI   0(GR1),X'1D'            SET WRT OP CODE.                 34400021
         BXLE  GR1,GR6,RESETB          UPDATE CCW ADDRESS POINTER       34450021
         BR    GR14                    RETURN.                    0811  34500021
SKIPON   LA    GR5,CCWB                ADDR SEARCH,TIC,WRT DATA CCWS.   34550021
         MVC   0(24,GR1),0(GR5)        MOVE THREE CCWS TO WRT BUFF.     34600021
         CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        34650021
         BNE   SKIPONN                 NO--TAPE--DO NOT RESET PTRS.     34700021
         LA    GR0,TOSEEK+3            ADDRESS FOR SEARCH.              34750021
         ST    GR0,0(GR1)              STORE ADDRESS IN SEARCH CCW.     34800021
         MVI   0(GR1),X'31'            RESET OP CODE.                   34850021
         ST    GR1,8(GR1)              RESET TIC ADDRESS.               34900021
         MVI   8(GR1),X'08'            RESET TIC OP CODE.               34950021
         ST    GR3,16(GR1)             STORE DATA POINTER.              35000021
         MVI   16(GR1),X'05'           RESET WRT DATA OP CODE.          35050021
SKIPONN  LA    GR1,24(GR1)             BUMP POINTER TO R1,R2 CCWS.      35100021
         MVC   0(16,GR1),16(GR6)       MOVE IN R1,R2 CCWS.              35150021
         L     GR7,AREA                LENGTH OF CCW'S > R2.      0811  35200021
         LTR   GR7,GR7                 GREATER THAN R2 THIS TRK.        35250021
         LA    GR15,SKIPONE            RETURN ADDRESS.                  35300021
         BZ    SETCCWS                 NO--GO SET REGS FOR BXLE.        35350021
         LA    GR6,32(GR6)             YES-BUMP PTR TO WRT CKD R3.      35400021
         LA    GR8,16(GR1)             POINT TO NEXT AVAILABLE SLOT.    35450021
         BAL   GR15,RESETCCW           MOVE CCWS FOR RD BACK CHECK.     35500021
SKIPONE  EQU   *                                                   0161 35550021
         AH    GR7,SIXTEEN         INCRM FOR BXLE LOOP.            0161 35600021
SKIPONE1 EQU   *                                                   0161 35650021
         LH    GR5,6(GR1)          LOAD CNT FROM THIS CCW.         0161 35700021
         CR    GR5,GR6                 IS COUNT ONLY 8 FOR EOF REC.     35750021
         BNE   SKIPONF                 NO--GO SET RD CKD OP CODE.       35800021
         MVI   0(GR1),X'12'            YES-SET RD COUNT OP CODE.        35850021
         B     SKIPONF1                GO TO SET SKIP BIT ON.           35900021
SKIPONF  MVI   0(GR1),X'1E'            SET RD CKD OP CODE FOR NON-EOF.  35950021
SKIPONF1 MVI   4(GR1),X'70'            SET SKIP BIT ON FOR RD BACK CHK. 36000021
         BXLE  GR1,GR6,SKIPONE1    LOOP THRU UNTIL DONE.           0161 36050021
         MVC   0(8,GR1),CCWB+32        MOVE IN READ BACK CHK R0 CCW.    36100021
         CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        36150021
         BNE   SKIPONG                 NO--DO NOT RESET PTRS.           36200021
         L     GR0,DATBUFPT            DATA BUFFER ADDRESS.             36250021
         ST    GR0,0(GR1)              STORE INTO CCW.                  36300021
         MVI   0(GR1),X'16'            RESET OP CODE.                   36350021
SKIPONG  AR    GR1,GR6                 POINT TO END OF WRT/RD CCWS.     36400021
         BR    GR14                    RETURN.                          36450021
         SPACE                                                          36500021
RESETCCW LA    GR5,255                 SET NO. OF BYTES FOR EXEC.       36550021
CHKMVC   CR    GR7,GR5                 WILL THIS BE THE LAST MOVE.      36600021
         BNH   LASTMVC                 YES--BRANCH.                     36650021
         EX    GR5,MOVECCWS            MOVE 256 CHARACTERS.             36700021
         LA    GR8,256(GR8)            INCREMENT MOVE TO POINTER.       36750021
         LA    GR6,256(GR6)            INCREMENT MOVE FROM POINTER.     36800021
         SR    GR7,GR5                 DECREMENT TOTAL LENGTH.          36850021
         B     CHKMVC                  CONTINUE PROCESSING.             36900021
LASTMVC  EX    GR7,MOVECCWS            MOVE CCWS TO WRT/RD CKD BUFF.    36950021
         L     GR7,AREA                RESTORE TOTAL LENGTH.      0811  37000021
SETCCWS  LA    GR6,8                   INCREMENTING FACTOR.             37050021
         AR    GR7,GR1                 SET END ADDRESS                  37100021
         SR    GR7,GR6                    FOR BXLE LOOP.                37150021
         BR    GR15                    RETURN.                          37200021
         SPACE                                                          37250021
*                                                                       37300021
*  LINK TO IEHDAOUT HERE.                                               37350021
*                                                                       37400021
         SPACE                                                          37450021
LINKDOUT EQU   *                                                SA53223 37460021
         LOAD  EP=IEHDPRNT                                      SA53223 37470021
         LR    GR2,GR0                  SAVE ADDR FOR IEHDAOUT  SA53223 37480021
         LR    GR3,GR4                  PASS END OF DATA POINTER.       37500021
         LA    GR1,CCHH                PASS PTR. TO CURRENT TRACK ADDR  37550021
         LINK  EP=IEHDAOUT                                      OX01980 37600003
         DELETE EP=IEHDPRNT             REDUCE CDE USE CNT.     OX01980 37700003
         BR    GR8                     RETURN TO CALLER.                37750021
         EJECT                                                          37800021
*                                                                       37850021
* WAIT ON COMPLETION OF EXCP AGAINST 'FROM' DEVICE HERE.                37900021
*                                                                       37950021
         SPACE                                                          38000021
WAITDISK TM    OUTECB,COMPLETE         IS THE OPERATION COMPLETE        38050021
         BO    TESTD0                  YES-GO TEST THE STATUS.     3651 38100021
         WAIT  ECB=OUTECB              NO--AWAIT COMPLETION OF DISK.    38150021
TESTD0   EQU   *                                                   3651 38200021
         LA    GR2,TESTD3              RETURN ADDRESS IF RECOVER   O122 38250021
         TM    OUTSTAT+4,X'02'         UNIT CHECK.                 7343 38300021
         BZ    TESTD01             NO,BRANCH                     M0025  38350021
         TM    OUTSENSE,DC             DATA CHECK.                 3651 38400021
         BO    IOERR                   YES-I/O ERROR.              3651 38450021
         TM    OUTSENSE+1,X'04'        FILE PROTECT.               7042 38500021
         BO    TESTD01                 YES-THAT'S OKAY.            7042 38550021
         TM    OUTSENSE,X'02'          TRACK CONDITION.            7042 38600021
         BZ    IOERR                   NO-I/O ERROR.               7042 38650021
TESTD01  EQU   *                                                   7042 38700021
         TM    OUTSENSE+1,X'01'        TRACK OVERFLOW.             7042 38750021
         BZ    TESTD                   NO-CHECK FOR EOF.         A31314 38800021
         OI    SWITCH,TRKOVFL          NO-MUST BE TRACK OVERFLOW.  3651 38850021
         BR    GR14                    RETURN TO CALLER.           3651 38900021
         SPACE                                                          38950021
TESTD    EQU   *                                                  0811  39000021
         TM    OUTSTAT+4,X'01'         EOF INDICATION.                  39050021
         BZ    TESTD6                  NO-SEE IF ALL OKAY.         3651 39100021
         L     GR3,CCWBUFPT            ADDRESS RD CKD CCWS.             39150021
         LA    GR3,16(GR3)             POINT TO RD KD R2 CCW.           39200021
         L     GR4,OUTSTAT             CSW ADDRESS.                     39250021
         LA    GR6,8                   SET UP REGISTER FOR SUBTRACTION. 39300021
         SR    GR4,GR6                 POINT TO CCW CAUSING THE EOF.    39350021
         TM    4(GR4),CCH              COMMAND CHAINING.           3651 39400021
         BCR   8,GR14                  NO-RETURN TO CALLER.        3651 39450021
         CR    GR3,GR4                 WAS EOF ON R2.                   39500021
         BE    TESTD2                  YES--SET UP FORWARD TIC.         39550021
         MVI   0(GR4),X'12'            NO---CHANGE CCW TO RD CNT.       39600021
         B     TESTD3                  GO TO RESTART CHANNEL PROGRAM.   39650021
TESTD2   SR    GR3,GR6                 POINT TO FIRST TIC CCW.          39700021
         MVC   0(8,GR4),0(GR3)         MOVE IN TIC CCW.                 39750021
         LA    GR6,8(GR4)              COMPUTE FORWARD TIC ADDRESS.     39800021
         ST    GR6,0(GR4)              STORE ADDRESS IN TIC CCW.        39850021
         MVI   0(GR4),X'08'            RESET OP CODE.                   39900021
TESTD3   EXCP  OUTIOB                  RESTART CHANNEL PROGRAM.         39950021
         B     WAITDISK                GO TO AWAIT COMPLETION.          40000021
TESTD6   EQU   *                                                  0811  40050021
         CLI   OUTECB,GOOD             ALL OK.                    0811  40100021
         BCR   8,GR14                  YES-RETURN TO CALLER.       7042 40150021
TESTD02  EQU   *                                                   7042 40200021
         CLI   OUTECB,X'41'            EXPECTED I/O ERROR.         7042 40250021
         BNE   IOERR                   NO-NOT EXPECTED.            7042 40300021
         TM    OUTSTAT+5,X'40'         INCORRECT LENGTH.           7042 40350021
         BZ    IOERR                   NO-I/O ERROR.               7042 40400021
         BR    GR14                    RETURN TO CALLER.           7042 40450021
         EJECT                                                          40500021
*                                                                       40550021
* WAIT ON COMPLETION OF EXCP AGAINST 'TO' DEVICE HERE.                  40600021
*                                                                       40650021
         SPACE                                                          40700021
WAITTO   BAL   GR4,WAIT2               WAIT ON PRIMARY 'TO' DEVICE.     40750021
* CONTROL RETURNED HERE IF EOV HIT.                                     40800021
         OI    SWITCH,EOV              SET EOV SWITCH.                  40850021
* CONTROL RETURNED HERE IF WAIT WAS GOOD.                               40900021
         OC    COPYPTR(4),COPYPTR      ARE COPIES BEING MADE.           40950021
         BCR   8,GR14                  NO--RETURN.                      41000021
         L     GR8,COPYPTR             YES-ADDRESS OF FIRST COPY BLOCK. 41050021
         USING COPYBLK,GR8                                              41100021
WAIT1    LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY.             41150021
         BAL   GR4,WAIT2               AWAIT COMPLETION OF THIS COPY.   41200021
* CONTROL RETURNED HERE IF EOV HIT.                                     41250021
         MVI   CERRSW,X'FF'            SET EOV SWITCH.                  41300021
* CONTROL RETURNED HERE IF WAIT WAS GOOD.                               41350021
         SPACE                                                          41400021
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           41450021
         BC    8,WAIT1A                NO--GO TO RETURN.                41500021
         L     GR8,CCOPYPTR            YES-ADDRESS NEXT COPY BLOCK.     41550021
         B     WAIT1                   GO WAIT ON NEXT COPY.            41600021
WAIT1A   LA    GR9,BLOCKS              PRIMARY I/O BLOCKS.              41650021
         BR    GR14                    RETURN.                          41700021
         SPACE                                                          41750021
WAIT2    TM    TOECB,COMPLETE          IS THE OPERATION COMPLETE.       41800021
         BO    WAIT3                   YES--GO TO TEST THE STATUS.      41850021
         WAIT  ECB=TOECB               NO--AWAIT COMPLETION             41900021
         SPACE 1                                                        41950021
WAIT3    CLI   TOECB,GOOD              ALL OK.                          42000021
         BNE   WAIT3A                  NO--GO TO SEE IF DA OUTPUT.      42050021
         LA    GR4,4(GR4)              YES--BUMP RETURN POINTER.        42100021
         BR    GR4                     RETURN.                          42150021
WAIT3A   CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        42200021
         BNE   WAIT4                   NO--TAPE--BRANCH.                42250021
*                                                                       42300021
* PROCESS HERE IF DIRECT ACCESS OUTPUT.                                 42350021
*                                                                       42400021
         TM    TOSTATUS+4,X'01'        EOF ENCOUNTERED.                 42450021
         BO    REPEAT                  YES--RESTART CCW CHAIN.          42500021
         TM    TOSENSE+1,X'08'         NO---TEST FOR NO RECORD FOUND.   42550021
         BZ    IOTERR                  NO---MUST BE I/O ERROR.          42600021
         L     GR3,TUCBPTR             ADDRESS OF UCB FOR 'TO' DEV.     42650021
         USING UCB,GR3                                                  42700021
         AIF   ('&LIB' EQ 'LIB2').NO2321                        Y02113  42750021
         CLI   UCBID,X'FF'             IS THIS A SUB UCB(2321).         42800021
         BE    WAIT3B                  NO--MAIN UCB--                   42850021
         LH    GR5,0(GR3)              BIN NUMBER.                      42900021
         SLA   GR5,4                   TIMES SIXTEEN.                   42950021
         LA    GR5,DATACELL-UCBOB(GR5) ADD LENGTH OF MAIN.              43000021
         LCR   GR5,GR5                 NEGATE.                          43050021
         AR    GR3,GR5                 ADDRESS OF MAIN UCB.             43100021
.NO2321  ANOP                           BRCH POINT IF VS ASSEM   Y02113 43150021
WAIT3B   CLC   TOSEEK+3(4),UCBSEEK     SWITCHED TO NEXT TRK ?   YL02912 43200002
         BE    IOTERR                  NO--LEGITIMATE ERROR.            43250021
         DROP  3                                                        43300021
         LA    GR3,CCWC                ADDRESS READ R0 CCW.             43350021
*                                                                       43400021
* THIS CODING IS USED ONLY WHEN INTERRUPTED WHILE DOING READ-BACK       43450021
* CHECKING AGAINST DA OUTPUT ON TRACK-OVERFLOW OR END-OF-FILE RECORDS.  43500021
*                                                                       43550021
REPEAT1  ST    GR3,TOCCWAD             RESET STARTING POINT IN IOB.     43600021
         EXCP  TOIOB                   FINISH THE CCW CHAIN.            43650021
         B     WAIT2                   GO TO AWAIT COMPLETION. @ZA26845 43700099
* EOF ON DISK ENCOUNTERED--PROCESS HERE.                                43750021
REPEAT   L     GR3,TOSTATUS            END OF INETERRUPTED CCW.         43800021
         LA    GR5,8                                                    43850021
         SR    GR3,GR5                 START OF INTERRUPTED CCW.        43900021
         TM    4(GR3),X'40'            IS THE CHAIN BIT ON.             43950021
         BC    8,REPEATA               NO--THIS CHAIN IS COMPLETE.      44000021
         LA    GR3,8(GR3)              YES--RESET THE START POINT.      44050021
         B     REPEAT1                 GO RESTART THE CCW CHAIN.        44100021
REPEATA  EQU   *                                                   6057 44150021
         CLI   DEVSW,X'FF'             DUMPING TO DA.              6057 44200021
         BCR   7,GR4                   NO-TAPE-RETURN.             6057 44250021
         LA    GR4,4(GR4)              YES-DA-BUMP RETURN POINTER. 6057 44300021
         BR    GR4                     RETURN.                          44350021
*                                                                       44400021
* PROCESS HERE IF TAPE OUTPUT.                                          44450021
*                                                                       44500021
WAIT4    TM    TOSTATUS+4,X'02'        UNIT CHECK?             @ZA10908 44510040
         BO    IOTERR                  YES-MUST BE I/O ERROR.  @ZA10908 44520040
         TM    TOSTATUS+4,X'01'        EOV ENCOUNTERED.        @ZA10908 44550040
         BZ    IOTERR                  NO--MUST BE I/O ERROR.           44600021
         B     REPEAT                  GO SEE IF RESTART NEEDED.   6057 44650021
         SPACE 1                                                   O122 44700021
ALIGN    SR    GR5,GR5                 CLEAR WORK REGISTER.             44750021
         IC    GR5,5(GR3)              KEY LENGTH.                      44800021
         AH    GR5,6(GR3)              ADD DATA LENGTH.                 44850021
         LA    GR5,8(GR5)              ADD COUNT LENGTH.                44900021
         AR    GR2,GR5                 ADD RECORD LENGTH TO DATA PTR.   44950021
ALIGNA   ST    GR2,SAVESLOT            STORE TO SEE IF DOUBLE WORD.     45000021
ALIGNB   TM    SAVESLOT+3,X'07'        IS PTR ON DOUBLE WORD BOUNDARY.  45050021
         BCR   8,GR15                  YES--RETURN TO CALLER.           45100021
         NI    SAVESLOT+3,X'F8'        NO---FORCE TO DOUBLE WORD.       45150021
         L     GR5,SAVESLOT            POINTER BACK INTO REGISTER.      45200021
         LA    GR5,8(GR5)              ADD EIGHT AFTER FORCING DOUBLE.  45250021
         ST    GR5,SAVESLOT            STORE FOR FUTURE USE.            45300021
         BR    GR15                    RETURN.                          45350021
         EJECT                                                          51200021
*                                                                       51250021
*  RETURN TO IEHDDUMP HERE.                                             51300021
*                                                                       51350021
         SPACE                                                          51400021
OUT4     EQU   *                                                        51450021
         MVI   BRCHVAL,OUT04              SET BRCH TABLE VALUE  SA53223 51500021
         B     RETEXCP                  RETURN TO EXCP          SA53223 51550021
IOTERR   EQU   *                                                SA53223 51600021
         LA    GR9,4(GR9)               UPDATE TO IOB ADR      @ZA01201 51610002
         ST    GR9,IOBPTR               SAVE ACTIVE IOB ADR    @ZA01201 51620002
         MVI   BRCHVAL,TAPERR             SET TAPE ERROR VALUE  SA53223 51650021
         B     RETEXCP                  RETURN TO PROC ERR      SA53223 51700021
IOERR    EQU   *                                                SA53223 51750021
         MVI   BRCHVAL,DISKERR          INDIC DISK ERR OCCURRED SA53223 51800021
         B     RETEXCP                  RETURN TO PROC ERR      SA53223 51850021
MSGWRT   EQU   *                                                SA53223 51900021
         MVI   BRCHVAL,MSG              INDIC MSG TO BE O/P     SA53223 51950001
         B     RETEXCP                  RETURN TO IEHDEXCP      SA53223 52000001
FINIS    EQU   *                                                SA53223 52010021
         MVI   BRCHVAL,FINISH           NOT USED                SA53223 52020001
         B     RETEXCP                  RETURN TO IEHDEXCP      SA53223 52030001
MULTPROC EQU   *                                                SA53223 52050021
         MVI   BRCHVAL,MULTI            INDIC MULTI-PROCESS     SA53223 52060021
         B     RETEXCP                  RESTORE REGISTERS       SA53223 52070001
PROC4    EQU   *                                                SA53223 52080021
         MVI   BRCHVAL,PROC04           PREPARE TO READ NXT TRK SA53223 52100021
RETEXCP  L     GR13,4(GR13)            RESTORE REGISTER THIRTEEN A51474 52350001
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN WITH PROPER CODE. 52400021
         EJECT                                                          52450021
MOVECCWS MVC   0(1,GR8),0(GR6)                                          52500021
         SPACE 2                                                        52550021
         DS    0F                                                       52600021
FULWD    DC    H'0'                     COUNT FIELD ADDEND.     SA53223 52610021
HAFWD    DS    H                        COUNT FIELD DATA LENGTH SA53223 52650021
BUFFADDR DC    X'3E18'                 DATA BUFFER ADDR FOR S/A D/R.    52700021
SIXTEEN  DC    H'16'                                                    52750021
THIRTY2  DC    H'32'                                                    52800021
OFFSET   DC    H'27'                    OFFSET FOR MSG VALUES   SA53223 52820001
*  THE FOLLOWING ARE 'BRCHVAL' BRANCH TABLE VALUES FOR IEHDEXCP SA53223 52850021
PROC04   EQU   X'00'                                            SA53223 52900021
DISKERR  EQU   X'04'                                            SA53223 52950021
TAPERR   EQU   X'08'                                            SA53223 53000021
OUT04    EQU   X'0C'                                            SA53223 53050021
MSG      EQU   X'10'                                            SA53223 53100021
FINISH   EQU   X'14'                                            SA53223 53110021
MULTI    EQU   X'18'                                            SA53223 53120021
*        END OF 'BRCHVAL' VALUES.                               SA53223 53150021
FOX0     EQU   X'0F'                    MASK FOR CHGING ZONE OF SA53223 53160021
*                                       CHAR BEFORE UNPKING.    SA53223 53180021
TAPMK    EQU   X'80'                                             A21395 53200021
GOOD     EQU   X'7F'                                                    53250021
DC       EQU   X'08'                   USED FOR DATA CHECKING TEST.3651 53300021
CCH      EQU   X'40'                   USED TO CHECK COMMAND CHAIN.3651 53350021
L2       EQU   2                        OFFSET CONSTANT         SA53223 53400021
L3       EQU   3                        OFFSET CONSTANT         SA53223 53450021
L8       EQU   8                        LENGTH CONSTANT         SA53223 53550021
MSG69    EQU   69                       ERROR MESSAGE VALUE     SA53223 53600021
D0       EQU   0                        OFFSET CONSTANT         SA53223 53610000
D12      EQU   12                       OFFSET CONSTANT         SA53223 53620000
D8       EQU   8                   DISP OF 8                     S20201 53650021
D4       EQU   4                        DISP OF 4               SA53223 53660021
X08      EQU   X'08'                   HEX CONSTANT.             S20201 53700021
RPSFEAT1 EQU   X'04'               RPS ON FROMDD                 S20201 53750021
TICCODE  EQU   X'08'               TIC CCW OP                    S20201 53800021
RPSFEAT  EQU   X'40'               RPS ON TODD                   S20201 53850021
D1       EQU   1                   DISP OF 1                     S20201 53900021
D3       EQU   3                        DISPL OF 3              Y02113  53950021
L4       EQU   4                        LENGTH OF 4             Y02113  54000021
TIMECHK  EQU   X'01'                    INDIC TIMESTAMP         Y02113  54050021
CLOCK    EQU   92                       F4DSCB TIMESTAMP DISPL @ZA30990 54100099
*                                       INTO BUFFER             Y02113  54150021
CCHHADDR DS    1F                      SAVE AREA FOR CCHH OF IPL TRK.   54250021
AREA     DS    1F                      SAVE AREA FOR CCW LENGTH.  0811  54300021
SAVESLOT DS    1F                      SAVE AREA FOR ALIGNMENT @ZA06534 54301000
CONVAD   DC    D'0'                    USED TO COVERT CCHH     @ZA06534 54302000
         DC    X'0'                     USED WHEN UPACKING CCHH SA53223 54304001
LABEL1   DC    C'MAINTENANCE'           LABEL OF MAINT. AREA    SA53223 54310001
         DC    100F'0'                                                  54330001
LABEL2   DC    C'AREA'                  END OF MAINT. AREA      SA53223 54340001
         DS    0D                                                A37209 54350021
RDVOLBUF DS    CL92                     VOLID BUFFER             A37209 54400021
SRKEY    DC    X'0000000003'            RECORD THREE SEARCH      A37209 54450021
*                                       ARGUMENT                 A37209 54500021
         DS    0H                      HALF WORD ALIGHNMENT      A51474 54700021
ZERO     DC    6X'0'                   TWO BYTES OF ZEROS WILL   A51474 54750021
*                                      ALSO BE USED FROM THE     A51474 54800021
*                                      FOLLOWING CONSTANT.       A51474 54850021
F1       DC    F'1'                                                     54900021
EIGHT    DC    F'8'                     LENGTH OF CCW          @ZA13746 54910000
         DS    0F                                                S20201 54950021
TICADDR  DC    X'000032E8'              TIC ADDR WITH NO RD CKD  S20201 55000021
         SPACE                                                          55050021
MSKFLGON DC    X'60000000'             SET CHAIN COMMAND AND SILI BITS  55100021
SCC2321  DC    X'00F60000'             INCREMENT TO NEXT SUBCELL.       55150021
STC2321  DC    X'0000FB00'             INCREMENT TO NEXT STRIP.         55200021
RPSBUF   DS    1F                                                S20201 55350021
TAPECCW5 CCW   X'1F',0,X'40',1         WTM.                             55400021
         CCW   3,0,X'20',24            NOOP-ALSO WRTS CNTRL REC AT EOV  55450021
         CCW   1,0,X'20',24            WRITE TRAILER RECORD.            55500021
         SPACE                                                          55550021
SEARIDEQ CCW   X'31',0,X'60',5         SEARCH ID EQUAL ON R0            55600021
         CCW   8,SEARIDEQ,X'60',5      TIC BACK.                        55650021
         CCW   6,0,X'60',8             READ R0 DATA.                    55700021
         CCW   X'9E',0,X'60',X'4000'   READ CKD R1               4074   55750021
*                                      WITH MAXIMUM COUNT               55800021
DUMMYCCW CCW   X'92',0,X'60',8         DUMMY READ COUNT CCW.            55850021
DMMYRCCW CCW   X'1E',0,X'60',0         DUMMY READ COUNT/KEY/DATA CCW    55900021
         SPACE 1                                                        55950021
HAR0CCW  CCW   7,X'0032AA',X'40',6     SEEK                             56000021
         CCW   X'1F',X'0031A6',X'40',1 SET FILE MASK                    56050021
HAR0CCW1 CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0.                   56100021
         CCW   8,X'0032D8',0,0         SEARCH UNTIL FOUND.              56150021
         CCW   5,X'003E18',X'60',8     WRITE R0 DATA.                   56200021
HAR0CCW2 CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0                    56250021
         CCW   8,X'0032F0',0,0         REPEAT UNTIL FOUND.              56300021
         CCW   6,X'003E18',X'70',8     READ BACK CHECK R0 DATA.         56350021
         CCW   X'11',X'000BF0',X'20',8 ERASE REST OF TRACK.             56400021
         EJECT                                                          56450021
R0R1CCWS CCW   7,X'0032AA',X'40',6     SEEK.                            56500021
         CCW   X'1F',X'0031A6',X'40',1 SET FILE MASK.                   56550021
CCWA     CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0                    56600021
         CCW   8,X'0032D8',0,0         REPEAT UNTIL FOUND.              56650021
         CCW   X'1D',X'003E20',X'60',X'FFFF' WRITE COUNT KEY DATA R1.   56700021
CCWB     CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0                    56750021
         CCW   8,X'0032F0',0,0         REPEAT UNTIL FOUND.              56800021
         CCW   5,X'003E18',X'60',8     WRITE DATA R0.                   56850021
         CCW   X'1E',X'003E20',X'70',X'FFFF' READ BACK CHECK R1.        56900021
CCWC     CCW   X'16',X'003E18',X'30',16      READ BACK CHECK R0 DATA.   56950021
         SPACE                                                          57000021
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      57050021
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              57100021
RDVDATA  CCW   6,0,X'20',96            READ FORMAT 4 DSCB.              57150021
*        CHANNEL PROGRAMS FOR SAVING OLD VOLID                          57200021
SRCHKEYR CCW   X'31',SRKEY,X'60',5      SEARCH ID EQUAL          A37209 57250021
         CCW   8,SRCHKEYR,0,0                                    A37209 57300021
         CCW   X'06',RDVOLBUF,X'20',92  READ IN VOLID            A37209 57350021
SRCHKEYW CCW   X'31',SRKEY,X'60',5      SEARCH ID EQUAL          A37209 57400021
         CCW   8,SRCHKEYW,0,0                                    A37209 57450021
         CCW   X'05',RDVOLBUF,X'20',92  WRITE OUT ORIGINAL VOLID A37209 57500021
TOTAL    DS    F'0'                                              A51474 57550021
EXCPSAVE DS    18F                      SAVE AREA                A37209 57600021
         SPACE                                                          57650021
* THIS IS USED TO WRITE HA, R0, R1 ONLY.                                57700021
R0CCWS   DSECT                                                          57750021
*   USED WHEN MODIFYING HA, R0 CCWS FOR EXECUTION.                      57800021
SEARCHR0 DS    2F                                                       57850021
TICBACK  DS    2F                                                       57900021
WRITER0  DS    2F                                                       57950021
SEARCH1  DS    2F                                                       58000021
TICAGAIN DS    2F                                                       58050021
READR0   DS    2F                                                       58100021
ERASEALL DS    2F                                                       58150021
READREC0 DS    2F                                                       58200021
         SPACE                                                          58250021
CCWS     DSECT                                                          58300021
SEIDEQR0 DS    CL8                                                      58350021
TICBACKA DS    CL8                                                      58400021
RDWRDATA DS    CL8                                                      58450021
RDWRTCKD DS    CL8                                                      58500021
RDWRTCNT DS    CL8                                                      58550021
         EJECT                                                          58600021
         IEHDWORK                                                       58650021
         EJECT                                                          58700021
IOBLOCKS DSECT                                                          58750021
* DUMP 'TO' ECB.                                                        58800021
TOECB    DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   58850021
* DUMP 'TO' IOB.                                                        58900021
TOIOB    DS    0F                                                       58950021
TOFLGS   DS    CL2                     FLAGS ONE AND TWO.               59000021
TOSENSE  DS    CL2                     SENSE BYTES.                     59050021
TOECBAD  DS    1F                      ECB ADDRESS.                     59100021
TOSTATUS DS    2F                      CHANNEL STATUS.                  59150021
TOCCWAD  DS    1F                      CCW LIST ADDRESS.                59200021
TODCBAD  DS    1F                      DCB ADDRESS.                     59250021
TORESAD  DS    1F                      RESTART ADDRESS.                 59300021
TOBLKCNT DS    CL2                     BLOCK COUNT INCREMENT.           59350021
TOERROR  DS    CL2                     ERROR COUNT.                     59400021
TOSEEK   DS    2F                      MBBCCHHR.                        59450021
* DUMP 'TO' DCB.                                                        59500021
TODCB    DS    13F                     DCB.                             59550021
         DS    0D                      FOR DOUBLE WORD ALIGNMENT.       59600021
TAPECCW2 DS    1D                      USED TO PUT OUT CCW RECORD       59650021
*                                        AND DATA ON TAPE.              59700021
TAPECCW3 DS    2D                      WRITE HA,R0 CCWS ON TAPE.        59750021
TAPECCW4 DS    2D                      WRITE HA,R0,R1 CCWS ON TAPE.     59800021
         DS    0D                      FOR DOUBLE WORD ALIGNMENT.       59850021
* DUMP 'FROM' ECB.                                                      59900021
OUTECB   DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   59950021
* DUMP 'FROM' IOB.                                                      60000021
OUTIOB   DS    0F                                                       60050021
OUTFLG   DS    CL2                     FLAGS ONE AND TWO.               60100021
OUTSENSE DS    CL2                     SENSE BYTES.                     60150021
OUTECBAD DS    1F                      ECB ADDRESS.                     60200021
OUTSTAT  DS    2F                      CHANNEL STATUS.                  60250021
OUTCCWAD DS    1F                      CCW LIST ADDRESS.                60300021
OUTDCBAD DS    1F                      DCB ADDRESS.                     60350021
OUTRESAD DS    1F                      RESTART ADDRESS.                 60400021
OUTBLKCT DS    CL2                     BLOCK COUNT INCREMENT.           60450021
OUTERROR DS    CL2                     ERROR COUNT.                     60500021
OUTSEEK  DS    2F                      7BBCCHHR.                        60550021
CCHH     EQU   OUTSEEK+3               CYLINDER/HEAD ADDRESS.           60600021
R        EQU   OUTSEEK+7               RECORD NUMBER.                   60650021
* DUMP 'FROM' DCB.                                                      60700021
OUTDCB   DS    18F                     DCB.                             60750021
         SPACE                                                          60800021
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           60850021
DBSIZE   EQU   IOBLKEND-IOBLOCKS       SIZE OF IOBLOCKS DSECT.          60900021
         EJECT                                                          60950021
         SPACE 1                                                        61000021
         IEHDBLKS                                                       61050021
         EJECT                                                          61100021
         SPACE 2                                                        61150021
         SPACE                                                          61200021
TESTCNT  DSECT                                                  SA53223 61250021
         DS    CL5                      'CCHHR' OF COUNT FIELD  SA53223 61300021
TESTKEY  DS    CL1                      KEY LENGTH              SA53223 61350021
TESTDL   DS    H                        DATA LENGTH             SA53223 61400021
         SPACE                                                          61450021
RBUFFER  DSECT                                                          61500021
ZERO1    DS    CL8                     WILL CONTAIN 8 BYTES OF ZEROS.   61550021
CCWBUFF  EQU   ZERO1                                                    61600021
TICSW    DS    CL1                     'FF' INDICATES PREVIOUS CCW=TIC. 61650021
         DS    CL3                     NOT USED.                        61700021
ADDRESS  DS    CL4                     TEMPORARY ADDRESS HOLDER.        61750021
SEEKCCW  DS    CL8                     SEEK CCW FOR STAND-ALONE.        61800021
SETMASK  DS    CL8                     SET FILE MASK FOR STAND-ALONE.   61850021
SEARIDE  DS    CL8                     SEARCH EQUAL ID CCW.             61900021
         EJECT                                                          61950021
CVT      DSECT                                                          62000021
         CVT   SYS=MIN                                                  62050021
         EJECT                                                          62100021
UCB      DSECT                                                          62150021
         IEFUCBOB                                                       62200021
         EJECT                                                          62250021
JFCB     DSECT                                                          62300021
         IEFJFCBN                                                       62350021
         EJECT                                                          62400021
         DCBD  DSORG=PS                                                 62450021
         END                                                            62500021
./  ADD  SSI=80130037,NAME=IEHDDUMP
         COPY  LCGASMSW                                                 00092000
IEHDDUMP CSECT                                                          00100000
*********************************************************************** 00101037
*                  FIXES THIS MODULE                                    00102037
*                     LATEST FIRST                                      00103037
*********************************************************************** 00104037
*                                                                       00104237
*D 820919                           @XA16072=@YA18844=@ZA24409=@SA79773 00104499
*C 106800                           @XA16072=@YA18844=@ZA24409=@SA79773 00104599
*                                                                       00104799
*C 106800                                    @ZA16457=@XA16080=@YA15372 00104899
*A 262400,327200,556700                      @ZA16457=@XA16080=@YA15372 00104999
*                                                                       00105037
*A 357000-357600,717300-718500,822900         SU32             @G32DSPD 00105532
*                                                                       00105799
*C 107100,841500                             @XA12918=@YA13328=@ZA10935 00106037
*A 106700-106800                             @XA12918=@YA13328=@ZA10935 00107037
*                                                                       00108037
*                                    ADD 3350 DEVICE SUPPORT.  @Z30RSAG 00110037
*        RELEASE 21 DELETIONS                                         * 00150020
*584100-590400,593100-599400                  SA65560 = OX2864 = OY2654 00150437
*600300,843000,843600                                                   00150803
*1244                                                            X02114 00151021
*462355,462359                                                   M0980  00152021
*1244462358                                                      A44482 00155021
*1244                                                            A42497 00160021
*        RELEASE 20 DELETIONS                                         * 00170020
*0910672300-674100                                               M4826  00172020
*0910844600                                                      M5900  00175020
*0910503100,504900,506700-507600                                 M5598  00180020
*0910462218-462274                                               A37209 00190020
*0910                                                            A33180 00220020
*0910902700                                                      A31384 00250020
*0910461700,464400                                               A34026 00270020
*0910158400,165600,354600,461735,461798,461994-462001,676800,    S20201 00280020
*0910593700-594000                                               A38120 00282020
*                                                                M0025  00285020
*0910678600,828900,829800,883800                                 S20201 00290020
*0910593400                                                      S20201 00290520
*0910233100-235800                                               M4998  00290720
*        RELEASE 19 DELETIONS                                           00291020
*2064593800                                                      A30268 00292020
*2064593230-593260                                               A29172 00293020
*2064                                                            M4513  00294020
*        RELEASE 18 DELETIONS                                           00295020
*3431594000-596700                                               1326   00296020
*3431584100-585000                                               2320   00297020
*3431287100-288000,592200,843300-844200                          2319   00298020
*STATUS CHANGE LEVEL 004                                                00328021
*                                                                     * 00360016
*********************************************************************** 00390037
          EJECT                                                         00420037
*FUNCTION/OPERATION- THIS ROUTINE IN CONJUNCTION WITH THE -IEHDEXCP-  * 00450016
*   AND -IEHDAOUT- ROUTINES HANDLES THE DUMP FUNCTION OF THE          * 00540016
*   IEHDASDR UTILITY PROGRAM. RESPONSIBILITY IS DIVIDED AS            * 00630016
*   FOLLOWS:                                                          * 00720016
*        IEHDDUMP- WILL PREPARE ALL INVOLVED DEVICES FOR PROCESSING   * 00810016
*                  AND OBTAIN CORE FOR THE BUFFER. UPON COMPLETION    * 00900016
*                  OF THE DUMP FUNCTION,WILL PERFORM HOUSEKEEPING     * 00990016
*                  FOR ALL INVOLVED DEVICES AND RELEASE THE BUFFER.   * 01080016
*                  CONTROL WILL THEN BE RETURNED TO THE MONITOR.      * 01170016
*        IEHDEXCP- WILL PERFORM ALL I/O OPERATIONS, PASSING CONTROL   * 01260016
*                  TO -IEHDAOUT- WHEN DUMPING TO A SYSTEM OUTPUT      * 01350016
*                  DEVICE. CONTROL WILL BE RETURNED TO -IEHDDUMP-     * 01440016
*                  UPON COMPLETION OF I/O PROCESSING.                 * 01530016
*        IEHDAOUT- WILL FORMAT AND DUMP ONE TRACK AT A TIME TO A      * 01620016
*                  SYSTEM OUTPUT DEVICE. CONTROL WILL BE RETURNED TO  * 01710016
*                  -IEHDEXCP-.                                        * 01800016
*                                                                     * 01890016
*   DUMP CONSISTS OF COPYING(DUMPING) DATA FROM ONE DIRECT ACCESS     * 01980016
*   DEVICE TO ONE OR MORE LIKE DIRECT ACCESS DEVICES, TO ONE OR MORE  * 02070016
*   TAPES, OR TO A SYSTEM OUTPUT DEVICE. ANY TAPES THUS CREATED CAN   * 02160016
*   THEN BE PROCESSED BY EITHER THE -IEHDASDR- UTILITY PROGRAM OR     * 02250016
*   THE STAND-ALONE DUMP/RESTORE PROGRAM(IBCDMPRS).                   * 02340016
*                                                                     * 02430016
*   THE -IEHDDUMP- ROUTINE LOCATES THE DEVICES BY USING THE DDNAMES   * 02520016
*   PASSED TO IT IN THE FUNCTION BLOCK. THIS ALLOWS THE ROUTINES TO   * 02610016
*   CONCURRENTLY PROCESS DUMP FUNCTIONS, AS EACH FUNCTION HAS         * 02700016
*   ASSOCIATED WITH ITS OWN I/O CONTROL BLOCKS. OPEN ON ALL DA        * 02790016
*   DEVICES IS DONE BY MEANS OF AN OPEN, TYPE=J ON THE FORMAT FOUR    * 02880016
*   DSCB.                                                             * 02970016
*                                                                     * 03060016
*   THE DATA ON THE DIRECT ACCESS DEVICE TO BE DUMPED(COPIED)         * 03150016
*   WILL BE READ IN ONE TRACK AT A TIME. ONLY THAT DATA               * 03240016
*   RESIDING ON TRACKS OWNED WILL BE COPIED. DATA OWNERSHIP           * 03330016
*   IS DETERMININED BY INTERROGATING THE FORMAT FIVE DSCB. WHEN       * 03420016
*   DUMPING DATA TO A SYSTEM OUTPUT DEVICE, THE ENTIRE RANGE OF       * 03510016
*   SPECIFIED TRACKS, OWNED AND UNOWNED, WILL BE DUMPED.              * 03600016
*                                                                     * 03690016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDDUMP-, AND CONTROL        * 03780016
*   IS ALWAYS RECEIVED FROM THE MONITOR ROUTINE(IEHDASDS).            * 03870016
*                                                                     * 03960016
*INPUT- POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL          * 04050016
*   BLOCK(REGISTER 10).                                               * 04140016
*                                                                     * 04230016
*EXITS-NORMAL- A SUCCESSFUL DUMP OPERATION RESULTS IN A RETURN        * 04320016
*   TO THE MONITOR(IEHDASDS) WITH A RETURN CODE OF ZERO. A DUMP       * 04410016
*   COMPLETE MESSAGE IS ALSO PLACED IN THE MESSAGE DATA SET.          * 04500016
*                                                                     * 04590016
*EXITS-ERROR-  ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROP-       * 04680016
*   IATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER       * 04770016
*   THAN ZERO WILL ALSO BE PASSED TO THE MONITOR(IEHDASDS).           * 04860016
*                                                                     * 04950016
*                                                                     * 05040016
*EXTERNAL ROUTINES-  THIS ROUTINE IS ALWAYS ENTERED FROM THE          * 05130016
*   MONITOR ROUTINE(IEHDASDS). FOUR OTHER CSECTS ARE USED BY THIS     * 05220016
*   ROUTINE. ANY MESSAGES ISSUED WILL BE WRITTEN OUT BY THE MESSAGE   * 05310016
*   WRITER ROUTINE(IEHDPRNT) AFTER BEING SET UP BY THE MESSAGE        * 05400016
*   ROUTINE(IEHDMSGB). ALL CHECKING FOR DATA SET EXPIRATION DATES     * 05490016
*   AND PASSWORD PROTECTED DATA SETS IS DONE BY IEHDPASS.             * 05580016
*   THE OTHER CSECT USED BY THIS ROUTINE IS IEHDCONS WHICH            * 05670016
*   CONTAINS ALL OF THE DEVICE DEPENDENT CONSTANTS.                   * 05760016
*                                                                     * 05850016
*TABLES/WORK AREAS-  UPON ENTRY, REGISTERS 10 AND 12 POINT TO A       * 05940016
*   FUNCTION BLOCK AND WORK AREA RESPECTIVELY. THEY ARE DESCRIBED     * 06030016
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 06120016
*   THIS ROUTINE MUST ALSO SECURE ONE BUFFER FOR READING IN           * 06210016
*   DATA AND CREATION OF THE NECESSARY CCW LISTS AND/OR RECORDS.      * 06300016
*   THE BUFFER IS BROKEN DOWN INTO THE FOLLOWING AREAS-               * 06390016
*        CCWBUFPT-CREATION AND SET-UP OF THE RD CNT CCWS(M/T) OR      * 06480016
*        THE RD CKD CCWS.                                             * 06570016
*        WRTBUFPT-CREATION AND SET-UP OF THE WRT/RD CKD CCWS          * 06660016
*        (EXECUTED FOR DA OUTPUT OR WRITTEN AS A CCW RECORD FOR       * 06750016
*        TAPE OUTPUT).                                                * 06840016
*        CNTBUFPT-THE COUNTS FOR A PARTICULAR TRACK WILL BE           * 06930016
*        READ INTO THIS AREA.                                         * 07020016
*        DATBUFPT-THE DATA FOR A PARTICULAR TRACK WILL BE             * 07110016
*        READ INTO THIS AREA.                                         * 07200016
*        FORM5FPT-A TABLE OF THE UNOWNED EXTENTS FOR THE -FROM-       * 07290016
*        DA DEVICE.                                                   * 07380016
*                                                                     * 07470016
*   IF COPIES ARE BEING MADE, THERE WILL ALSO                         * 07560016
*   BE ONE OR MORE COPY BLOCKS CHAINED FROM THE FUNCTION BLOCK. SEE   * 07650016
*   THE -COPYBLK- DSECT FOR A DESCRIPTION.                            * 07740016
*                                                                     * 07830016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE, NON-PRIVILEGED.          * 07920016
*                                                                     * 08010016
 TITLE 'IEHDDUMP-ENTRY POINT IEHDDUMP-IEHDASDR SYSTEM UTILITY PROGRAM'  08100016
*********************************************************************** 08140037
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             08190016
*********************************************************************** 08230037
GR0      EQU   0                                                        08280016
GR1      EQU   1                                                        08370016
GR2      EQU   2                                                        08460016
GR3      EQU   3                                                        08550016
GR4      EQU   4                                                        08640016
GR5      EQU   5                                                        08730016
GR6      EQU   6                                                        08820016
GR7      EQU   7                                                        08910016
GR8      EQU   8                                                        09000016
GR9      EQU   9                                                        09090016
GR10     EQU   10                                                       09180016
GR11     EQU   11                                                       09270016
GR12     EQU   12                                                       09360016
GR13     EQU   13                                                       09450016
GR14     EQU   14                                                       09540016
GR15     EQU   15                                                       09630016
RCVT     EQU   9                                                        09720016
UCBPTR   EQU   9                                                        09810016
BASEREG  EQU   11                                                       09900016
WORKBASE EQU   12                                                       09990016
*********************************************************************** 10030037
         EJECT                                                          10080037
         USING FUNCBLK,10                                               10170016
         USING IEHDDUMP,BASEREG                                         10260016
         USING WORK,12                                                  10350016
         SPACE 1                                                        10440016
         SAVE  (14,12),T,*             SAVE THE REGISTERS.              10530016
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          10620016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA10935 10650037
         DC    C'OZ24409'              LAST APAR THIS MODULE   @ZA24409 10680099
APARNO   LA    GR7,DUMPSAVE            SAVE AREA ADDRESS       @ZA10935 10710037
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      10800016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      10890016
         LR    GR13,GR7                SAVE AREA FOR CALLED ROUTINES.   10980016
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     11070016
         TM    0(GR3),PROCESS          PREVIOUSLY UNDER WAY.            11160016
         BZ    START2                  NO--START FROM THE BEGINNING.    11250016
         B     CALLEXCP                RETURN TO EXECUTING MODULE.      11340016
         EJECT                                                          11430016
*********************************************************************** 11520016
*                                                                     * 11610016
*   DETERMINE DIRECT DEVICE TYPE AND SET UP POINTER TO THE            * 11700016
*     PROPER DEVICE CONSTANTS FOR THIS DEVICE.                        * 11790016
*                                                                     * 11880016
*********************************************************************** 11970016
         SPACE 1                                                        12060016
         SPACE                                                          12150016
START2   L     GR8,FUCBPTR             UCB POINTER FOR 'FROM' DEVICE.   12240016
         CLI   IODEVCON,X'00'           HAVE WE ALREADY FIGURED  A42497 12260021
*                                       ADDRES                   A42497 12280021
         BNE   START4                   YES - DON'T RE-FIGURE    A42497 12300021
         USING UCB,8                                                    12330016
         TM    UCBTBYT3,UCB3DACC       IS THIS A DIRECT ACCESS DEVICE.  12600016
         BZ    BADPARM                 NO--MUST BE BAD PARAMETER.       12690016
START3   SR    GR3,GR3                 CLEAR WORK REGISTER.             12780016
         AIF   ('&LIB' EQ 'LIB1').NOWIN BRCH IF OS ASSEM        XL03130 12830003
         CLI   UCBTBYT4,WINCH           WINCHESTER DEVICE ?     XL03130 12840003
         BNE   NOWIN                    NO, BRCH                XL03130 12850003
         IC    GR3,IDEVMOD              PICKUP WINCH MODEL NO.  XL03130 12860003
         B     YESWIN                   BRCH AROUND OS CODE     XL03130 12862003
NOWIN    EQU   *                                                XL03130 12864003
.NOWIN   ANOP                                                   XL03130 12866003
         IC    GR3,UCBTBYT4            UCB DEVICE TYPE CODE.            12870016
YESWIN   EQU   *                                                XL03130 12920003
         LA    GR5,KDEVSIZE            SIZE OF EACH DEVICE ENTRY.       12960016
         BCTR  GR3,0                   DECREMENT FOR INDEX.             13050016
         MR    GR4,GR3                 ENTRY SIZE TIMES INDEX VALUE.    13140016
         L     GR4,IODEVCON            BEGIN ADDRESS OF DEVICE CONSTANT 13230016
         AR    GR4,GR5                 ADDRESS OF CONSTANTS THIS DEVICE 13320016
         ST    GR4,IODEVCON            SAVE IN FUNCTION BLOCK.          13410016
         MVC   IODEVCON(1),UCBTBYT4     UCB DEVICE TYPE CODE.           13500016
         TM    UCBTBYT2,RPS            RPS FEATURE ON FROMDD.    S20201 13520020
         BZ    START4                  NO-BRANCH.                S20201 13540020
         OI    SEQSW,FEATURE1          YES-SET RPS SWITCH.       S20201 13560020
         B     START4                  GO TO GET CORE FOR BUFFERS.      13590016
         DROP  8                                                        14580016
         SPACE                                                          14670016
         EJECT                                                          14760016
*********************************************************************** 14850016
*                                                                     * 14940016
*   THIS SECTION ATTEMPTS TO OBTAIN CORE FOR ONE BUFFER TO BE USED    * 15030016
*     FOR CCW PROCESSING AND DATA READ IN FROM THE DIRECT ACCESS      * 15120016
*     DEVICE. IF NO BUFFER IS OBTAINED, THE 'NOCORE' SWITCH IS SET    * 15210016
*     FOR THIS FUNCTION.                                              * 15300016
*                                                                     * 15390016
*********************************************************************** 15480016
         USING CONSTANT,GR9                                             15570016
START4   L     GR9,IODEVCON            ADDRESSING FOR DEVICE CONSTANTS. 15660016
         LH    GR2,BUFFSIZE            SIZE PER BUFFER/THIS DEVICE.     15750016
         LA    GR3,RPSBUFPT            SAVE ADDRESS OF BUFFER    S20201 15810020
*                                       HERE.                    S20201 15870020
         GETMAIN EC,LV=(2),A=(3)       GET CORE FOR BUFFER.             15930016
         LTR   GR15,GR15               WAS CORE AVAILABLE.              16020016
         BZ    BUFFOK                  YES--GO TO SET UP BUFFER PTRS.   16110016
         L     GR3,PTRCFUNC            NO--POINTER TO CURRENT FUNCTION. 16200016
         OI    0(GR3),WAITING+NOCORE   INDICATE NO CORE AVAILABLE.      16290016
         LA    GR15,4                  SET UP RETURN CODE.              16380016
         B     FINAL3                  RETURN TO MONITOR.               16470016
BUFFOK   EQU   *                                                 S20201 16500020
         L     GR3,RPSBUFPT            ADDRESS OF DUMP BUFFER.   S20201 16530020
         LA    GR3,D16(GR3)            INCREMENT TO POINT TO     S20201 16560020
         ST    GR3,CCWBUFPT              CCW BUFFER.             S20201 16590020
         AH    GR3,RCCWSIZE            ADD SIZE OF CCW BUFFER.          16650016
         ST    GR3,WRTBUFPT            SAVE POINTER TO WRTCCWS.         16740016
         AH    GR3,WRTSIZE             ADD SIZE OF WRT-RD CKD CCWS.     16830016
         ST    GR3,CNTBUFPT            SAVE POINTER TO COUNT BUFFER.    16920016
         AH    GR3,CNTSIZE             ADD SIZE OF COUNT BUFFER.        17010016
         ST    GR3,DATBUFPT            SAVE POINTER TO DATA BUFFER.     17100016
         AH    GR3,DATASIZE            ADD SIZE OF DATA BUFFER.         17190016
         ST    GR3,FORM5FPT            SAVE POINTER TO FORMAT 5 AREA.   17280016
CLEAR    L     GR1,DATBUFPT            BEGINNING OF DATA BUFFER.        17370016
         LH    GR3,DATASIZE            LENGTH OF DATA BUFFER.           17460016
         LA    GR2,255                 SET LENGTH FOR EXEC.             17550016
         MVI   0(GR1),C' '             PRIME FIRST BYTE FOR EXEC.       17640016
EXEC     CR    GR3,GR2                 THIS THE LAST MOVE.              17730016
         BNH   LASTEXEC                YES--DO ONE MORE MOVE.           17820016
         EX    GR2,MOVE                MOVE 256 BYTES.                  17910016
         LA    GR1,256(GR1)            INCREMENT DATA BUFF POINTER.     18000016
         SH    GR3,TWO56               UPDATE BYTE COUNT.               18090016
         B     EXEC                    RETURN TO CHECK POINT.           18180016
LASTEXEC EX    GR3,MOVE                CLEAR REMAINING PORTION.         18270016
         DROP  9                                                        18360016
         EJECT                                                          18450016
*********************************************************************** 18540016
*                                                                     * 18630016
*   THIS SECTION WILL SET UP THE 'FROM' DA IOBLOCKS (ECB,IOB,DCB)     * 18720016
*   IN THE FUNCTION BLOCK. THE DEB FIELDS WILL ALSO BE FILLED IN.     * 18810016
*   THE 'TO' DEVICE TYPE WILL BE DETERMINED AND THE CORRESPONDING     * 18900016
*     IOBLOCKS MOVED INTO THE FUNCTION BLOCK.                         * 18990016
*                                                                     * 19080016
*********************************************************************** 19170016
         SPACE 2                                                        19260016
         USING IOBLOCKS,9                                               19350016
SETUPBLK LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY I/O BLKS. 19440016
         MVC   OUTECB(WBLKSIZE),WRTECB   SET UP 'FROM' DA I/O BLOCKS.   19530016
         LA    GR3,OUTECB              GET ADDRESS OF ECB.              19620016
         ST    GR3,OUTECBAD            SAVE ECB ADDRESS IN IOB.         19710016
         LA    GR3,OUTDCB              GET DCB ADDRESS.                 19800016
         ST    GR3,OUTDCBAD            SAVE DCB ADDRESS IN IOB.         19890016
         USING IHADCB,GR3                                               19980016
         MVC   DCBDDNAM(8),DDNAME1     MOVE DDNAME TO DCB.              20070016
         ST    GR10,DCBIOBAD           FUNCTION BLOCK ADDRESS TO DCB.   20160016
         MVC   OPENLD+1(3),OUTDCBAD+1  DA DCB NAME TO OPEN LIST.        20250016
         SPACE                                                          20340016
         BAL   GR14,OPENJ              GO TO OPEN 'FROM' DA DEVICE.     20430016
         L     GR3,FUCBPTR             UCB PTR. FOR 'FROM' DEVICE.      20520016
         USING UCB,3                                                    20610016
         CLI   UCBID,X'FF'             IS THIS A SUB UCB(2321).         20700016
         BE    SETUP                   NO--FORGET ABOUT BIN NUMBER.     20790016
         MVC   OUTSEEK+1(2),0(GR3)     BIN NUMBER.                      20880016
         DROP  3                                                        20970016
         SPACE                                                          21060016
         USING CONSTANT,9              ADDRESSING FOR DEVICE CONSTANT   21150016
SETUP    L     GR9,IODEVCON            ADDRESSING FOR DEVICE CONSTANTS. 21240016
         MVI   DUMPSW,X'F0'            SET SWITCH TO INDICATE FULL DUMP 21330016
         MVC   CCHHONE(4),CCHHBEG      LOWER LIMIT TO 1ST TRK DUMPED.   21420016
         TM    SEQSW,BEGIN             IS BEGINNING TRACK SPECIFIED.    21510016
         BZ    TESTEND                 NO--CHECK IF END ADDR SPECIFIED. 21600016
         MVI   DUMPSW,X'00'            SET SWITCH FOR PARTIAL DUMP.     21690016
         MVC   DUMPWORK(4),CCHHBEG     MOVE IN LOWER LIMIT.             21780016
         BAL   GR14,TRKVALID           GO CHECK FOR VALID LIMIT.        21870016
TESTEND  TM    SEQSW,END               IS ENDING TRACK SPECIFIED.       21960016
         BZ    FULLDUMP                NO--SET TO END OF PRIMARY TRKS.  22050016
         MVI   DUMPSW,X'00'            SET SWITCH FOR PARTIAL DUMP.     22140016
         MVC   DUMPWORK(4),CCHHEND     YES--MOVE IN UPPER LIMIT.        22230016
         BAL   GR14,TRKVALID           GO CHECK IF VALID LIMIT.         22320016
         CLC   CCHHBEG(4),CCHHEND      BEGIN ADDR HIGHER THAN END.      22410016
         BH    INVALTRK                YES--GO TO WRITE ERROR MSG.      22500016
         B     UPDATE                  GO TO UPDATE LAST TRK SPECIFIED. 22590016
FULLDUMP MVC   CCHHEND(4),LASTORIG     FULL DUMP-MOVE IN LAST PRIMARY.  22680016
UPDATE   BAL   GR14,UPCCHH             GO TO ADD ONE TO UPPER LIMIT     22770016
         DROP  9                                                        22860016
         USING UCB,8                                                    22950016
         USING IOBLOCKS,9                                               23040016
TESTTODD L     GR8,TUCBPTR             UCB PTR. FOR 'TO' DEVICE.        23130016
         LA    GR9,BLOCKS              PRIMARY I/O BLOCKS.              23220016
         CLC   SYSOUTDD(8),DDNAME2      IS IT SYSOUT             M4998  23280020
         BE    SETSW1                   YES - CHECK FOR COPIES   M4998  23340020
         CLI   UCBID,X'FF'              2321                     M4998  23400020
         BNE   SETUPDA                  YES - GO SET UP          M4998  23460020
         B     TESTTO                   CHECK IF TAPE            M4998  23520020
SETSW1   EQU   *                                                 M4998  23580020
         OC    COPYPTR(4),COPYPTR      YES--WERE COPIES REQUESTED.      23670016
         BZ    SETSW                   NO--GO SET SWITCHES.             23760016
         L     GR3,COPYPTR             YES--SET PTR TO DDNAME3.         23850016
         B     COPYERR1                GO PRINT MSG, TERMINATE.         23940016
SETSW    OI    DEVSW,X'F0'             SET SWITCHES TO INDICATE         24030016
         OI    SWITCH,DUMPALL            DUMPING TO SYSOUT.             24120016
         B     LINKPASS                GO CHK FOR PASSWORD DATASETS.    24210016
TESTTO   TM    UCBTBYT3,UCB3TAPE       TAPE DEVICE.                     24300016
         BO    SETUPTAP                YES--INITIALIZE FOR TAPE.        24390016
         TM    UCBTBYT3,UCB3DACC       DIRECT ACCESS.                   24480016
         BZ    BADDEV                  NO--GO PRINT MSG, TERMINATE.     24570016
TESTDA   CLC   UCBTBYT4(1),IODEVCON    FROM AND TO SAME DEVICE TYPE.    24660016
         BE    SAMET                    BRCH IF LIKE DEVICES    XL03145 24710003
         CLI   IODEVCON,MERLN           IS FROMDD A MERLIN ?    XL03145 24720003
         BNE   BADDEV                   NO, GO TEST FOR WINCH.  XL03145 24730003
         CLI   UCBTBYT4,ICEBG           IS TODD AN ICEBERG      XL03145 24740003
         BNE   BADDEV                  GO TO PRINT MSG,TERMINATE.       24740403
         B     SETDOS                   BRCH IF ICEBERG         XL03145 24742003
SAMET    EQU   *                                                XL03145 24744003
         CLI   UCBTBYT4,WINCH           WINCHESTER DEVICE ?     XL03130 24744403
         BNE   TESTSYSR                 NO, TEST FOR SYSRES DEV XL03130 24744803
         CLC   IDEVMOD,ODEVMOD          COMPARE I/O DEV TYPES   XL03130 24746003
         BH    BADDEV                   GIVE ERROR MSG IF I/P   XL03130 24748003
         BE    TESTSYSR                 BRCH IF EQUAL MODELS    XL03130 24748103
*                                       DEVICE BIGGER THAN O/P XL03145  24748203
SETDOS   EQU   *                                                XL03130 24748303
         OI    FLGBYT1,DOSBIT           SET SWT FOR LATER TEST  XL03130 24748403
TESTSYSR TM    SRTESTAT,SRTESYSR       THIS IS SYSTEM RESIDENCE VOL.    24840016
         BO    INVALTO                 YES--THIS IS NOT ALLOWED.        24930016
         TM    UCBTBYT2,RPS            RPS FEATURE ON TODD.      S20201 24950020
         BZ    SETUPDA                 NO-BRANCH                 S20201 24970020
         OI    SEQSW+D1,FEATURE        YES-SET RPS SWITCH.       S20201 24990020
         DROP  8                                                        25020016
         SPACE 2                                                        25110016
*********************************************************************** 25150037
*  IF DUMPING TO DIRECT ACCESS, SET UP I/O BLOCKS HERE.                 25200016
*********************************************************************** 25240037
         SPACE                                                          25290016
SETUPDA  OI    DEVSW,X'FF'             SET DA SWITCH IN FUNCTION BLOCK. 25380016
         MVC   TOECB(WBLKSIZE),WRTECB  SET UP 'TO' DA BLOCK IN FUNC BLK 25470016
         LA    GR3,TOECB               GET 'TO' ECB ADDRESS             25560016
         ST    GR3,TOECBAD             SAVE IN IOB.                     25650016
         LA    GR3,TODCB               ADDRESS OF DCB.                  25740016
         ST    GR3,TODCBAD             SAVE IN IOB.                     25830016
         USING IHADCB,GR3                                               25920016
         MVC   DCBDDNAM(8),DDNAME2     MOVE DDNAME TO DCB.              26010016
         MVC   OPENLD+1(3),TODCBAD+1   DA DCB FOR OPEN LIST.            26100016
         ST    GR10,DCBIOBAD           STORE FUNCTION BLOCK PTR.        26190016
         MVI   OPENLD,X'8F'            CHANGE OPEN FOR OUTPUT  @ZA16457 26230037
         SPACE 1                                                        26280016
         BAL   GR14,OPENJ              GO TO READ JFCB.                 26370016
         LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY DEVICES.  26460016
         SPACE                                                          26550016
         BAL   GR14,FORMAT4            GO READ IN FORMAT 4.             26640016
         SPACE                                                          26730016
         MVC   ALTDATA(6),0(GR3)       SAVE ALTERNATE DATA.             26820016
         MVC   NOCYL,D10(GR3)           COPY TODD NO. OF CYL.   XL03130 26870003
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                26910016
         BZ    MORE2                   NO--GO CHK FOR PASSWORD DATASETS 27000016
         B     COPYPROC                YES-GO SET UP FOR COPIES.        27090016
         SPACE 2                                                        27180016
*********************************************************************** 27220037
*  IF DUMPING TO TAPE, SET UP I/O BLOCKS HERE.                          27270016
*********************************************************************** 27310037
         SPACE                                                          27360016
SETUPTAP MVC   TOECB(DTBLKSIZ),DTECB   'TO' TAPE I/O BLKS TO FUNCBLK.   27450016
         LA    GR3,TOECB               ADDRESS OF ECB.                  27540016
         ST    GR3,TOECBAD             SAVE IN IOB.                     27630016
         LA    GR3,TODCB               SAVE ADDRESS OF DCB              27720016
         ST    GR3,TODCBAD             IN IOB.                          27810016
         MVC   DCBDDNAM(8),DDNAME2     MOVE DDNAME TO DCB.              27900016
         DROP  3                                                        27990016
*********************************************************************** 28030037
*  SET UP CONTROL RECORD FOR OUTPUT TO TAPE.                            28080016
*********************************************************************** 28120037
         SR    GR3,GR3                 CLEAR WORK REGISTER.             28170016
         IC    GR3,IODEVCON            UCB DEVICE TYPE CODE.            28260016
         LA    GR3,CODES-1(GR3)        ADDRESS S/A D/R DEV TYPE CODE.   28350016
         MVC   CONTROL+21(1),0(GR3)    MOVE DEV TYPE CODE TO CTRL REC.  28440016
         MVC   CONTROL+12(8),RESTCODE  RESTORE TAPE CODE TO CTRL REC.   28530016
         MVC   DEVMOD,IDEVMOD           MOVE IN WINCH MODEL #   XL03130 28580003
         LA    GR3,CONTROL             PTR TO CONTROL RECORD.           28620016
         ST    GR3,TAPECCW5            POINTER INTO CCW.           2319 28680018
         MVI   TAPECCW5,X'01'          RESET OP CODE.              2319 28740018
         L     GR8,TUCBPTR             UCB POINTER.                1326 28800018
         BAL   GR2,OPENT               GO TO OPEN ON TAPE,WRT CTRL REC. 28890016
         MVC   REELCK(4),REELCTRL      INITIALIZE TRAILER INFO.         28980016
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                29070016
         BZ    MORE2                   NO--GO TO PROCESS FORMAT 5.      29160016
         EJECT                                                          29250016
*********************************************************************** 29340016
*                                                                     * 29430016
*   THIS SECTION WILL SET UP THE IOBLOCKS (ECB,IOB,DCB) AND THEN      * 29520016
*   OPEN THE DEVICES SPECIFIED IN THE COPY BLOCKS. IF THE 'TO'        * 29610016
*   DEVICES ARE INCONSISTENT, THE FUNCTION WILL BE TERMINATED.        * 29700016
*                                                                     * 29790016
*********************************************************************** 29880016
         SPACE                                                          29970016
         USING COPYBLK,7                                                30060016
         USING UCB,8                                                    30150016
         USING IOBLOCKS,9                                               30240016
COPYPROC L     GR7,COPYPTR             ADDRESSING FOR COPY BLOCK.       30330016
COPYP1   L     GR8,CUCBPTR             UCB PTR. FOR THIS COPY.          30420016
         LA    GR9,CIOBLOCK            ADDRESS OF COPY I/O BLOCK.       30510016
COPYP2   TM    UCBTBYT3,UCB3TAPE       THIS A TAPE DEVICE.              30870016
         BO    TAPECOPY                YES--INITIALIZE FOR TAPE.        30960016
         TM    UCBTBYT3,UCB3DACC       IS THIS DIRECT ACCESS DEVICE.    31050016
         BZ    BADDEV1                 ALL OTHER=ERROR.                 31140016
         CLI   DEVSW,X'FF'             WAS PRIMARY 'TO' DA.             31230016
         BNE   COPYERR                 GO TO PRINT MSG,TERMINATE.       31320016
         CLC   UCBTBYT4(1),IODEVCON    ARE FROM AND TO DEVICES ALIKE.   31410016
         BE    SAME                     BRCH IF LIKE DEVICES    XL03145 31542003
         CLI   IODEVCON,MERLN           IS FROMDD A MERLIN ?    XL03145 31552003
         BNE   COPYERR                  NO, GO TEST FOR WINCH.  XL03145 31562003
         CLI   UCBTBYT4,ICEBG           IS TODD AN ICEBERG      XL03145 31572003
         BNE   COPYERR                 GO TO PRINT MSG,TERMINATE.       31582003
         B     TSTSYSR                  BRCH IF ICEBERG         XL03145 31584003
SAME     EQU   *                                                XL03145 31586003
         CLI   UCBTBYT4,WINCH           WINCHESTER DEVICE ?     XL03130 31588003
         BNE   TSTSYSR                  NO, TEST FOR SYSRES DEV XL03130 31588403
         CLC   ODEVMOD,CDEVMOD          COMPARE O/P DEV TYPES   XL03130 31588803
         BNE   COPYERR                  GIVE ERROR MSG IF O/P   XL03130 31589203
*                                       DEVICE MODELS DIFFER.   XL03130 31589603
TSTSYSR  EQU   *                                                XL03145 31589703
         TM    SRTESTAT,SRTESYSR       THIS A SYSTEM RESIDENCE VOLUME.  31590016
         BO    CINVALTO                YES--THIS IS NOT ALLOWED.        31680016
         TM    SEQSW+D1,FEATURE       *RPS ON PRIMARY TODD.      S20201 31690020
         BZ    COPYP3                 *NO-BRANCH.                S20201 31700020
         TM    UCBTBYT2,RPS           *RPS ON THIS TODD          S20201 31710020
         BO    COPYP3                 *YES-SWITCH ALREADY SET.   S20201 31720020
         NI    SEQSW+D1,SWOFF         *NO-SET SWITCH OFF         S20201 31730020
COPYP3   EQU   *                                                 S20201 31740020
         SPACE                                                          31770016
*********************************************************************** 31810037
*  SET UP DIRECT ACCESS I/O COPY BLOCKS HERE.                           31860016
*********************************************************************** 31900037
         MVC   TOECB(WBLKSIZE),WRTECB   'TO' DA CTRL BLKS TO COPYBLK.   31950016
         LA    GR3,TOECB               GET 'TO' ECB ADDRESS.            32040016
         ST    GR3,TOECBAD             SAVE IN IOB.                     32130016
         LA    GR3,TODCB               ADDRESS OF DCB.                  32220016
         USING IHADCB,GR3                                               32310016
         ST    GR3,TODCBAD             SAVE IN IOB.                     32400016
         MVC   DCBDDNAM(8),DDNAME3     MOVE DDNAME TO DCB.              32490016
         ST    GR10,DCBIOBAD           STORE FUNCTION BLOCK PTR.        32580016
         MVC   OPENLD+1(3),TODCBAD+1   DA DCB TO OPEN LIST.             32670016
         MVI   OPENLD,X'8F'            CHANGE OPEN FOR OUTPUT  @ZA16457 32710037
         SPACE                                                          32760016
         BAL   GR14,OPENJ              GO TO READ JFCB.                 32850016
         SPACE                                                          32940016
         LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY.             33030016
         SPACE                                                          33120016
         BAL   GR14,FORMAT4            GO READ IN THE FORMAT 4.         33210016
         SPACE                                                          33300016
         MVC   CALTDATA(6),0(GR3)      SAVE ALTERNATE DATA.             33390016
         B     MORECOPY                GO TO SEE IF MOVE COPY BLOCKS.   33480016
         EJECT                                                          33570016
         SPACE                                                          33660016
*********************************************************************** 33700037
*  SET UP TAPE I/O COPY BLOCKS HERE.                                    33750016
*********************************************************************** 33790037
TAPECOPY CLI   DEVSW,X'00'             DUMPING TO TAPE.                 33840016
         BNE   COPYERR                 NO--INVALID COPY REQUEST.        33930016
         MVC   TOECB(DTBLKSIZ),DTECB   'TO' TAPE CTRL BLKS TO COPYBLK.  34020016
         LA    GR3,TOECB               ADDRESS OF ECB.                  34110016
         ST    GR3,TOECBAD             SAVE IN IOB.                     34200016
         LA    GR3,TODCB               SAVE ADDRESS OF DCB              34290016
         ST    GR3,TODCBAD                IN IOB.                       34380016
         MVC   DCBDDNAM(8),DDNAME3     MOVE DDNAME TO DCB.              34470016
         DROP  GR3                                                      34560016
         L     GR8,CUCBPTR             COPY UCB POINTER.           1326 34600018
         BAL   GR2,OPENT               GO TO OPEN TAPE, WRT CTRL REC.   34650016
         MVC   CREELCK(4),REELCTRL     INITIALIZE TRAILER INFO.         34740016
MORECOPY L     GR7,CCOPYPTR            ADDRESS NEXT COPY BLOCK,IF ANY.  34830016
         LTR   GR7,GR7                 ANY MORE COPY BLOCK POINTERS.    34920016
         BP    COPYP1                  YES--GO PROCESS NEXT COPY.       35010016
MORE2    LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY I/O BLKS. 35100016
         CLI   DEVSW,X'00'             DUMPING TO TAPE.                 35190016
         BNE   LINKPASS                NO--NO WAIT TODAY--.             35280016
         BAL   GR14,WAITTO             WAIT ON EXCP OF CONTROL RECORD.  35370016
LINKPASS EQU   *                        *                        S20201 35380020
         TM    SEQSW,FEATURE1          RPS FEATURE ON FROMDD.    S20201 35390020
         BO    LINKP                   YES-BRANCH.               S20201 35400020
         TM    SEQSW+D1,FEATURE        RPS FEATURE ON TODD.      S20201 35410020
         BZ    LINKP1                  NO-BRANCH.                S20201 35420020
LINKP    EQU   *                                                 S20201 35430020
         L     GR1,RPSBUFPT            PTR TO RPS BUFFER.        S20201 35440020
         MVC   D0(L16,GR1),SETCCW      MOVE SET SECTOR AND TIC   S20201 35450020
*                                        CCWS TO RPS BUFFER.            35460020
LINKP1   EQU   *                                                 S20201 35470020
         L     GR1,CCWBUFPT            PTR TO BUFFER FOR         S20201 35480020
*                                       PASSWORD.                S20201 35490020
         LINK  EP=IEHDPASS             CHK PASSWORD DS,EXPIRATION DTES  35550016
         CLM   GR15,B'0001',RC4        NON-TERMINATION RETURN? @G32DSPD 35700032
         BNH   CALLEXCP                YES--GO TO IEHDEXCP     @G32DSPD 35760032
         ST    GR15,DUMPWORK           TEMPORARY STORAGE FOR RET. CODE. 35820016
         BAL   GR14,CLOSEOUT           GO TO CLOSE ALL DUMP DCBS.       35910016
         BAL   GR14,FINALR1            GO TO FREE UP BUFFER.            36000016
         L     GR15,DUMPWORK           RESTORE RETURN CODE.             36090016
         B     FINAL3                  RETURN TO THE MONITOR.           36180016
         DROP  7,8                                                      36220002
         SPACE                                                          45540016
CALLEXCP CALL  IEHDEXCP                                                 45630016
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     45720016
         TM    0(GR3),COMPLETE         IS THIS FUNCTION COMPLETE.       45810016
         BO    EOJ                     YES--GO TO CLOSE AND FREE BUFFS. 45900016
         LA    GR15,0                  SET RETURN CODE FOR MONITOR.     45990016
         B     FINAL3                  GO TO RETURN.                    46080016
EOJ      EQU   *                                                 A34026 46110020
         ST    GR15,COMPCODE           SAVE RETURN CODE.         A34026 46140020
FINISH   CLI   DEVSW,X'FF'             DUMPING TO DA.            M4513  46170719
         BNE   EOJ1                    NO--GO TO CLOSE DEBS      M4513  46171419
         LA    GR9,BLOCKS         ADDR OF PRIMARY I/O BLKS.      M4513  46172119
         L     GR8,TUCBPTR        UCB PTR FOR PRIMARY 'TO'       M4513  46172819
         L     GR3,FORM5FPT        GET F5 POINTER                S20201 46173220
         MVC   2(6,GR3),ALTDATA    AND PUT IN ALT TRK DATA       S20201 46173620
         LA    GR3,DDNAME2             DDNAME OF TO DEVICE.      M4513  46174219
         BAL   GR2,RDVOLID        GO TO UPDATE ALT TRK INFO      M4513  46174919
         OC    COPYPTR(4),COPYPTR    ARE COPIES BEING MADE       M4513  46175619
         BZ    EOJ1              NO-ONLY ONE OUTPUT VOL.         M4513  46176319
         L     GR3,COPYPTR             ADDR 1ST COPY.            M4513  46177019
         USING COPYBLK,GR3                                       M4513  46177719
CFINIS   LA    GR9,CIOBLOCK            ADDR OF COPY I/O BLK      M4513  46178419
         L     GR8,CUCBPTR             PTR TO UCB FOR COPY.      M4513  46179119
         L     GR2,FORM5FPT        GET F5 POINTER                S20201 46179520
         MVC   2(6,GR2),ALTDATA    AND PUT IN ALT TRK DATA       S20201 46179920
         BAL   GR2,RDVOLID             GO TO UPDATE ALT TRK      M4513  46180519
         OC    CCOPYPTR(4),CCOPYPTR    MORE 'DA' COPIES.         M4513  46181219
         BZ    EOJ1                NO-CLOSE AND FREE BUFFS.      M4513  46181919
         L     GR3,CCOPYPTR            ADDR NEXT COPYBLK.        M4513  46182619
         B     CFINIS                  GO PROCESS THIS COPY      M4513  46183319
         EJECT                                                          46183637
*********************************************************************** 46184019
*                                                                     * 46184719
* THIS ROUTINE READS IN THE VOL LABEL OF THE DIRECT ACCESS            * 46185419
*     DEVICE. IF THE OLD SER NO. IS TO BE RETAINED AND IT IS          * 46186119
*     DIFFERENT THAN THE NEW SER NUMBER, THE VOL LABEL IS             * 46186819
*     REWRITTEN WITH THE OLD SER NUMBER. THIS ROUTINE ALSO            * 46187519
*     UPDATES THE ALT TRK INFROMATION FIELDS IN THE FORMAT4           * 46188219
*     DSCB.                                                           * 46188919
*                                                                     * 46189619
*        REG 8 MUST POINT TO THE UCB FOR THE DA DEVICE.               * 46190319
*        REG 9 MUST POINT TO THE DA CONTROL BLOCKS                    * 46191019
*          UPON ENTRY.                                                * 46191719
*        REGISTERS 4,7 ARE WORK REGISTERS.                            * 46192419
*        REGISTER 2 IS THE RETURN REGISTER.                           * 46193119
*                                                                     * 46193819
*********************************************************************** 46194519
         USING UCB,GR8                                           M4513  46195219
         USING IOBLOCKS,9                                        M4513  46195919
RDVOLID  XC    TOSEEK+3(5),TOSEEK+3    CLEAR SEARCH ARGUMENT.    M4513  46196619
         LA    GR7,TOSEEK+3            SEARCH ADDRESS.           M4513  46197319
         ST    GR7,READVTOC            PLACE IN SEARCH CCW.      M4513  46198019
         MVI   READVTOC,X'31'          RESET OP CODE.            M4513  46198719
         LA    GR7,READVTOC                                      S20201 46198920
         TM    SEQSW+D1,FEATURE        TODD HAVE RPS FEATURE.    S20201 46199120
         BZ    RDVOLIDA                NO-BRANCH.                S20201 46199320
         ST    GR7,TIC                 SET UP TIC/TO ADDRESS.    S20201 46199520
         LA    GR7,SETCCW              YES-POINT TO SET SECTOR   S20201 46199720
         MVI   K8(GR7),TICCODE         RESET TIC OP CODE.        S20201 46199920
*                                         CCW FOR IOB.                  46200120
RDVOLIDA EQU   *                        *                        S20201 46200320
         ST    GR7,TOCCWAD                                       S20201 46200520
         L     GR7,DATBUFPT            READ IN AREA.             M4513  46200819
         ST    GR7,RDVDATA             BUFF PTR TO READ CCW      M4513  46201519
         CLI   UCBTBYT4,X'01'          THIS A 2311.              M4513  46202219
         BNE   RDVOLID1            NO-DON'T CHECK IPL TEXT.      M4513  46202919
         MVI   TOSEEK+6,1              SET SEARCH FOR TRK 1      M4513  46203619
         LA    GR4,RDVDATA             CCW ADDRESS.              M4513  46204319
         ST    GR4,TOCCWAD             STORE IN IOB.             M4513  46205019
         MVI   RDVDATA,X'16'       SET OP CODE FOR READ R0.      M4513  46205719
         BAL   GR4,VOLEXCP           GO RAD IN CNT FLD R0.       M4513  46206419
         MVC   CCHHADDR(4),0(GR7)      SAVE CCHH OF IPL TRK      M4513  46207119
         MVI   TOSEEK+6,0              SET FOR TRACK 0.          M4513  46207819
         MVI   TOSEEK+7,2              SET FOR RECORD 2.         M4513  46208519
         LA    GR4,READVTOC            CCW ADDRESS.              M4513  46209219
         ST    GR4,TOCCWAD             STORE IN IOB.             M4513  46209919
         MVI   RDVDATA,6         SET OP CODE FOR READ DATA       M4513  46210619
         BAL   GR4,VOLEXCP             READ IN TRK 0/ RCD 2      M4513  46211319
         MVC   34(4,GR7),CCHHADDR      SEEK BOOTSTRAP ADDR       M4513  46212019
         MVI   RDVDATA,5         SET OP CODE FOR WRITE.          M4513  46212719
         BAL   GR4,VOLEXCP             GO REWRITE RECORD 2.      M4513  46213419
RDVOLID1 MVI   RDVDATA,6           SET OP CODE FOR READ.         M4513  46214119
         MVI   TOSEEK+7,3              SET SEARCH FOR RCD 3      M4513  46214819
         MVI   RDVDATA+L4,CCSILI        SET CMD CHN + SILI FLG  YL02912 46215202
         L     GR4,RDVDATA              GET DATA ADDRESS        YL02912 46215302
         AH    GR4,RDVDATA+L6           ADD LENGTH              YL02912 46215402
         ST    GR4,RDHA                 STORE ADR FOR HOME ADDR YL02192 46215902
         MVI   RDHA,RHA                 RESTORE CMD CODE        YL02192 46216302
         BAL   GR4,VOLEXCP             GO READ IN VOL LABEL      M4513  46217502
         L     GR4,RDHA                 LOAD PTR TO HOME ADDR   YL02192 46217702
         MVI   RDVDATA+L4,SILI          RESET SILI BIT ONLY     YL02192 46218202
         TM    0(GR4),ALTRK             THIS A ALTERNATE TRK ?  YL02192 46218302
         BNO   TRACKOK                 NO--CONTINUE              M4513  46218502
         LA    GR1,28                  TRK 0 DEFECTIVE MSG.      M4513  46219002
        BAL   GR4,SETUPMSG            GO TO SET UP TMSG.         M4513  46219502
         MVC   0(8,GR1),0(GR3)         DDNAME TO MSG.            M4513  46220002
         BAL   GR4,MSGWRT1             GO TO PRINT THIS MSG      M4513  46220502
TRACKOK  EQU   *                                                 M4513  46221002
         USING VLABEL,GR7                                        M4513  46221502
         TM    SEQSW,CPYVOLID           USE VOLID ON 'FROM' DISK A37209 46221820
         BNO   UPDATE4                  NO, KEEP ORIGINAL VOLID  A37209 46222520
         L     GR4,FUCBPTR              GET UCB PTR TO 'FROM'    A37209 46223220
*                                       DISK                     A37209 46223920
         MVC   SERIAL(6),28(GR4)        MOVE IN 'FROM' VOLID     A52430 46226700
GO2321   MVI   RDVDATA,5           SET CCW OP CODE TO WRITE      A52430 46228100
         BAL   GR4,VOLEXCP             REWRITE THE LABEL.        M4513  46228819
UPDATE4  L     GR1,CNTBUFPT            TEMPORARY STORAGE         M4513  46229519
         MVC   0(6,GR1),SERIAL             FOR SER NUMBER.       M4513  46230219
         MVC   TOSEEK+3(5),VTOCPTR     NEW VTOC ADDR IN IOB      M4513  46230919
         CLC   TOSEEK+3(4),CCHHBEG     VTOC ADDR GT FIRST        M4513  46231619
         BL    POSTUCB                  TRK THIS DUMP//NO.       M4513  46232319
         CLC   TOSEEK+3(4),CCHHEND     VTOC ADDR LT UPPER        M4513  46233019
         BNL   POSTUCB                  LIMIT//NO-POST UCB.      M4513  46233719
         MVI   RDVDATA,6               SET CCW CODE TO READ      M4513  46234419
         BAL   GR4,VOLEXCP        GO READ IN FORMAT 4 DSCB.      M4513  46235119
M0980    L     GR4,FORM5FPT             MOVE IN SAVED ALT.       M0980  46235521
         MVC   8(6,GR7),2(GR4)          TRACK INFORMATION        M0980  46235921
         MVC   D18(L2,GR7),NOCYL        MOVE TODD CYL NO.       XL03130 46236203
         TM    FLGBYT1,DOSBIT           SWT SET FOR DOS CONTAM  XL03130 46244303
         BNO   NODOS                    NO, BRCH                XL03130 46246303
         OI    D14(GR7),DOSCON          SET DOS CONTAM BIT      XL03130 46248303
NODOS    EQU   *                                                XL03130 46250303
         AIF   ('&LIB' EQ 'LIB1').VSAM01 BRCH IF OS ASSEM Y02113        46250903
         STCK  CLOCK(GR7)               STORE TIMESTAMP IN F4   Y02113  46257003
*                                       DSCB                            46263103
.VSAM01  ANOP                                                   Y02113  46269203
         MVI   RDVDATA,5         SET CCW OP CODE FOR WRITE       M4513  46275303
         BAL   GR4,VOLEXCP       GO REWRITE FORMAT 4 DSCB.       M4513  46281403
*********************************************************************** 46284437
* POST UCB HERE.                                                        46287503
*********************************************************************** 46290537
POSTUCB  ST    GR8,POSTLIST           UCB ADDR TO PARM LIST      M4513  46293603
         L     GR1,CNTBUFPT           TEMPORARY SER STORAGE      M4513  46299703
         ST    GR1,POSTLIST+4          NO. TO PARM LIST.         M4513  46305803
         LA    GR1,TOSEEK              VTOC POINTER.             M4513  46311903
         ST    GR1,POSTLIST+8          POINTER TO PARM LIST      M4513  46318003
         MVI   POSTLIST,X'08'          'POST' CODE FOR SVC.      M4513  46324103
         MVI   POSTLIST+8,X'80'        SET LIST ENTRY BIT.       M4513  46330203
         CNOP  0,4                                               M4513  46336303
         BAL   GR1,POST              PARM LIST ADDR FOR SVC      M4513  46342403
POSTLIST DC    F'0'                    UCB ADDRESS.              M4513  46348503
         DC    F'0'                    SERIAL NUMBER ADDR.       M4513  46354603
         DC    F'0'                    VTOC ADDRESS.             M4513  46360703
POST     SVC   POSTSER                 GO UPDATE UCBS.           M4513  46366803
POSTSER  EQU   82                      SVC NUMBER.               M4513  46372903
         BR    GR2                     RETURN TO CALLER.         M4513  46379003
         DROP  7,8                                               A52430 46415603
EOJ1     EQU   *                                                 A52430 46421703
         BAL   GR14,CLOSEOUT           GO TO CLOSE ALL DUMP DCBS.       46427803
         BAL   GR14,FINALR1            GO TO FREE BUFFER, IF ANY.       46433903
         L     GR15,COMPCODE           RESTORE RETURM CODE.      A34026 46440020
         LTR   GR15,GR15               RETURN CODE ZERO.                46530016
         BZ    FINALR2                 YES--GO TO PUT OUT MESSAGE.      46620016
         B     UNUSABLE                NO---GO PUT OUT UNUSABLE MSG.    46710016
VOLEXCP  EXCP  TOIOB                   EXECUTE CHANNEL PROG      M4513  46720019
         WAIT  ECB=TOECB                                         A33180 46725020
         CLI   TOECB,GOOD              ALL OK.                   M4513  46730019
         BCR   8,GR4                   YES-RETURN.               M4513  46740019
         B     IOTERR                                            M4513  46750019
         DROP  9                                                        46800016
         EJECT                                                          46890016
         USING IOBLOCKS,9                                               46980016
WAITDISK LA    GR9,BLOCKS                                               47070016
         TM    OUTECB,COMPLETE         IS THE OPERATION COMPLETE        47160016
         BO    TESTD                   YES--GO TEST THE STATUS.         47250016
         WAIT  ECB=OUTECB              NO--AWAIT COMPLETION OF DISK.    47340016
         SPACE                                                          47430016
TESTD    CLI   OUTECB,GOOD             ALL OK.                          47520016
         BNE   IOERR                   NO--I/O ERROR                    47610016
         BR    GR14                    YES--RETURN                      47700016
         SPACE                                                          47790016
WAITTO   LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY DEVICES.  47880016
         BAL   GR4,WAIT2               GO TO AWAIT COMPLETION.          47970016
         OC    COPYPTR(4),COPYPTR      ARE COPIES BEING MADE.           48060016
         BCR   8,GR14                  NO--RETURN.                      48150016
         L     GR8,COPYPTR             YES-ADDRESS OF FIRST COPY BLOCK. 48240016
         USING COPYBLK,GR8                                              48330016
WAIT1    LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY.             48420016
         BAL   GR4,WAIT2               AWAIT COMPLETION OF THIS COPY.   48510016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           48600016
         BC    8,WAIT1A                NO--RETURN.                      48690016
         L     GR8,CCOPYPTR            YES-ADDRESS NEXT COPY BLOCK.     48780016
         B     WAIT1                   GO WAIT ON NEXT COPY.            48870016
WAIT1A   LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY I/O BLKS  48960016
         BR    GR14                    RETURN TO CALLER.                49050016
         SPACE                                                          49140016
WAIT2    TM    TOECB,COMPLETE          IS THE OPERATION COMPLETE.       49230016
         BO    TESTT                   YES--GO TEST THE STATUS.         49320016
         WAIT  ECB=TOECB               NO--AWAIT COMPLETION             49410016
         SPACE 1                                                        49500016
TESTT    CLI   TOECB,GOOD              ALL OK.                          49590016
         BNE   IOTERR                  NO--I/O ERROR.                   49680016
         BR    GR4                     RETURN.                          49770016
         SPACE                                                          49860016
         SPACE 1                                                        49950016
         USING CONSTANT,9                                               50040016
TRKVALID CLC   DUMPWORK(1),LASTORIG      COMPARE EACH BYTE              50130016
         BH    INVALTRK                  OF REQUESTED EXTENTS           50220016
         BE    CHEKREST                THAT'S O.K. TOO.            0969 50230017
         CLI   LASTALT,X'13'           THIS A 2321.                0969 50240017
         BNE   CHEKREST                NO-BRANCH.                  0969 50250017
         CLC   DUMPWORK+1(1),LASTALT+1  CKECK REQUEST.             0969 50260017
         BH    INVALTRK                INVALID REQUEST.            0969 50270017
         B     CHKREST                 CONTINUE CHECKING.          0969 50280017
CHEKREST EQU   *                                                   0969 50290017
         CLC   DUMPWORK(2),LASTORIG     COMPARE CC               M5598  50340020
         BH    INVALTRK                  A PARTIAL DUMP. IF ANY         50400016
CHKREST  EQU   *                                                   0969 50440017
         CLC   DUMPWORK+2(2),LASTORIG+2 COMPARE HH               M5598  50510020
         BH    INVALTRK                  HIGHER THAN THE CCHH OF        50580016
         BR    GR14                    RETURN TO CALLER IF LIMIT OKAY.  50850016
         EJECT                                                          50940016
*********************************************************************** 51030016
*                                                                     * 51120016
*   THE FOLLOWING ROUTINE UPDATES THE TRACK ADDRESS FOR SETTING       * 51210016
*   LIMITS FOR THE DUMP OPERATION.                                    * 51300016
*                                                                     * 51390016
*   REGISTER 9 POINTS TO THE CORRECT IOBLOCK.                         * 51480016
*   REGISTER 14 IS THE RETURN REGISTER.                               * 51570016
*                                                                     * 51660016
*********************************************************************** 51750016
         SPACE 2                                                        51840016
         USING IOBLOCKS,GR9                                             51930016
         USING CONSTANT,2                                               52020016
UPCCHH   L     GR2,IODEVCON            ADDRESSING FOR DEVICE CONSTANT.  52110016
         L     GR3,CCHHEND             CURRENT CCHH ADDRESS.            52200016
         CLC   CCHHEND+3(1),LASTORIG+3  THIS LAST TRACK OF CYLINDER.    52290016
         BC    4,UPCCHH1               NO--                             52380016
         A     GR3,CONVCYL             YES,STEP TO NEXT CYLINDER.       52470016
         SPACE 2                                                        52560016
CK2321   CLI   CCHHEND+2,X'04'         IS THIS 2321 AND LAST CYLINDER.  52650016
         BC    7,UPCCHH2               NO--RETURN.                      52740016
         AL    GR3,STC2321             INCREMENT STRIP.                 52830016
         CLI   CCHHEND+1,X'09'         THIS LAST STRIP.                 52920016
         BC    7,UPCCHH2               NO--RETURN.                      53010016
         AL    GR3,SCC2321             INCREMENT SUBCELL.               53100016
         B     UPCCHH2                 GO STORE VALUE AND RETURN.       53190016
         SPACE                                                          53280016
UPCCHH1  AL    GR3,F1                  INCREMENT TO NEXT TRACK.         53370016
UPCCHH2  ST    GR3,CCHHEND             SAVE NEW VALUE.                  53460016
         BR    14                      RETURN.                          53550016
         DROP  2                                                        53640016
         EJECT                                                          53730016
*********************************************************************** 53820016
*                                                                     * 53910016
*  THIS ROUTINE OPENS THE DATA CONTROL BLOCKS FOR ALL DIRECT ACCESS   * 54000016
*     DEVICES INVOLVED. THE OPEN IS ALWAYS PERFORMED ON THE FORMAT    * 54090016
*     FOUR DSCB OF THE VTOC.                                          * 54180016
*                                                                     * 54270016
*        REGISTER 14 IS THE RETURN REGISTER.                          * 54360016
*                                                                     * 54450016
*********************************************************************** 54540016
         SPACE                                                          54630016
         SPACE 3                                                        54720016
OPENJ    MVC   LIST+1(3),CCWBUFPT+1    BUFFER ADDRESS TO READ JFCB.     54810016
         RDJFCB MF=(E,OPENLD)                                           54900016
         L     GR8,CCWBUFPT            ADDRESS JFCB WAS READ INTO.      54990016
         USING JFCB,8                                                   55080016
         MVI   JFCBDSNM,X'04'          SET DSNAME FIELD FOR             55170016
         MVC   JFCBDSNM+1(43),JFCBDSNM   FORMAT 4 DSCB.                 55260016
         OI    JFCBTSDM,X'08'          PREVENT WRITING BACK JFCB.       55350016
         OPEN  MF=(E,OPENLD),TYPE=J                                     55440016
         DROP  8                                                        55530016
         L     GR8,OPENLD              DISK DCB ADDRESS                 55620016
         MVI   OPENLD,X'80'            RESTORE OPEN TO INPUT   @ZA16457 55660037
         USING IHADCB,8                                                 55710016
         TM    DCBOFLGS,X'10'          WAS THERE A SUCCESSFUL OPEN.     55800016
         BZ    NOOPEN                  NO--GIVE AN ERROR MESSAGE        55890016
         NI    DCBMACRF+1,X'F3'        SET BITS OFF TO PREVENT CLOSE    55980016
*                                        FROM WRITING AN EOF RECORD     56070016
*                                        AND UPDATING THE DSCB.         56160016
         BR    GR14                    RETURN.                          56250016
         DROP  8                                                        56340016
         EJECT                                                          56430016
*********************************************************************** 56520016
*  THIS ROUTINE OPENS THE DATA CONTROL BLOCKS FOR ALL TAPE DEVICES.   * 56610016
*     UPON SUCCESSFUL OPEN, THE CONTROL RECORD WILL BE WRITTEN ON     * 56700016
*     THE TAPE.                                                       * 56790016
*                                                                     * 56880016
*        REGISTER 9 MUST POINT TO THE CORRECT IOBLOCKS.               * 56970016
*        REGISTER 8 MUST POINT TO THE UCB.                        1326* 57010018
*        REGISTERS 3,8 ARE WORK REGISTERS.                            * 57060016
*        REGISTER 2 IS THE RETURN REGISTER.                           * 57150016
*********************************************************************** 57240016
         USING IOBLOCKS,GR9                                             57330016
         USING UCB,8                                               1326 57370018
OPENT    MVC   OPENLT+1(3),TODCBAD+1   TAPE DCB ADDRESS TO OPEN LIST.   57420016
         LH    GR3,SRTEFSCT            TAPE DATA SET SEQUENCE COUNT1326 57450018
         DROP  8                                                   1326 57480018
         OPEN  MF=(E,OPENLT)           OPEN TAPE DCB.                   57510016
         L     GR8,OPENLT              TAPE DCB ADDRESS.                57600016
         USING IHADCB,8                                                 57690016
         TM    DCBOFLGS,X'10'          WAS THERE A SUCCESSFUL OPEN.     57780016
         BZ    NOOPEN                  NO--GIVE AN ERROR MESSAGE.       57870016
         DROP  8                                                        57960016
         MVC   LIST+1(3),CCWBUFPT+1    BUFFER ADDRESS TO RD JFCB.       58050016
         RDJFCB MF=(E,OPENLT)          READ JFCB.                       58140016
         L     GR8,CCWBUFPT            ADDRESS OF READ-IN JFCB.         58230016
         USING JFCB,8                                                   58320016
         TM    JFCBIND2,X'10'          SECURITY PROTECTED.              58950016
         BZ    WRTCNTRL                NO--GO TO PROCESS.        OX2864 59040003
         OI    SWITCH,PASSSW+STDLABEL  SET PASSWORD PROTECT SWITCH.     59130016
WRTCNTRL LA    GR3,TAPECCW5            CCW ADDRESS.                     60120016
WRTTM    EQU   *                                                   2319 60160018
         ST    GR3,TOCCWAD             STORE CCW ADDRESS IN IOB.        60210016
         EXCP  TOIOB                   PUT CONTROL RECORD ON TAPE.      60300016
         BR    GR2                     RETURN.                          60390016
         EJECT                                                          60480016
*********************************************************************** 60570016
*                                                                     * 60660016
*   THIS SECTION READS IN THE FORMAT 4 DSCB FROM THE VTOC.              60750016
*   THE ALTERNATE TRACK INFORMATION IS SAVED FOR THAT VOLUME.         * 60840016
*                                                                     * 60930016
*   REGISTER 3 WILL RETURN A POINTER TO THE 6 BYTES OF ALTERNATE DATA.* 61020016
*   REGISTER 9 MUST POINT TO THE I/O CONTROL BLOCKS FOR THIS DEVICE.  * 61110016
*   REGISTER 14 IS THE RETURN REGISTER.                               * 61200016
*                                                                     * 61290016
*********************************************************************** 61380016
         SPACE 1                                                        61470016
         USING IOBLOCKS,9                                               61560016
         USING IHADCB,GR8                                               61650016
FORMAT4  LA    GR8,TODCB               ADDRESS OF DCB.                  61740016
         L     GR1,DCBDEBAD            ADDRESS OF DEB.                  61830016
         MVC   TOSEEK+3(4),38(GR1)     CCHH OF VTOC TO IOB.             61920016
         CLI   IODEVCON,X'05'          IS THIS A 2321.                  62010016
         BNE   SETR                    NO--FORGET ABOUT BIN NUMBER.     62100016
         MVC   TOSEEK+1(2),36(GR1)     BIN NO. TO IOB FROM DEB.         62190016
SETR     MVI   TOSEEK+7,X'01'          SET R OF CCHHR FOR FORMAT4 DSCB. 62280016
         LA    GR3,TOSEEK+3            SEARCH ADDRESS.                  62370016
         ST    GR3,READVTOC            SEARCH ADDRESS TO SEARCH CCW.    62460016
         MVI   READVTOC,X'31'          RESET CCW OP CODE.               62550016
         LA    GR3,READVTOC            CCW ADDRESS//READ VTOC.          62640016
         TM    SEQSW+D1,FEATURE        TODD HAVE RPS FEATURE.    S20201 62650020
         BZ    SETRR                   NO-BRANCH                 S20201 62660020
         ST    GR3,TIC                 YES-RESET TIC ADDRESS.    S20201 62670020
         MVI   TIC,TICCODE             RESET TIC OP CODE.        S20201 62680020
         LA    GR3,SETCCW              POINT TO SET SECTOR CCW.  S20201 62690020
SETRR    EQU   *                        *                        S20201 62700020
         ST    GR3,TOCCWAD             SET UP IOB.                      62730016
         L     GR3,CCWBUFPT            ADDRESS OF BUFFER.               62820016
         ST    GR3,RDVDATA             STORE ADDRESS IN READ CCW.       62910016
         LA    GR3,RDVDATA             ADDRESS OF READ CCW.             63000016
         MVI   0(GR3),X'06'            RESET OP CODE.                   63090016
         EXCP  TOIOB                   READ IN THE FORMAT 4 DSCB.       63180016
         WAIT  ECB=TOECB               WAIT COMPLETION.                 63270016
         CLI   TOECB,GOOD              ANY ERRORS.                      63360016
         BNE   IOERR                   YESS--GO GIVE MESAAGE.           63450016
         MVC   TOSEEK+3(5),ZERO        ZERO 'CCHHR' OF SEARCH ARGUMENT. 63540016
         L     GR3,RDVDATA             ADDRESS OF FORMAT 4 DATA.        63630016
         LA    GR3,8(GR3)              ADDRESS OF ALTERNATE DATA.       63720016
         BR    GR14                    RETURN.                          63810016
         DROP  8,9                                                      63900016
         EJECT                                                          63990016
*********************************************************************** 64080016
*                                                                     * 64170016
*   THIS ROUTINE CLOSES THE DATA CONTROL BLOCKS FOR ALL DEVICES       * 64260016
*     (DIRECT ACCESS AND TAPE, IF ANY). IF THE DCBS HAVE NOT BEEN     * 64350016
*     OPENED WHEN THIS ROUTINE IS CALLED, NO ACTION IS PERFORMED.     * 64440016
*        REGISTERS 4,5,8,9 ARE WORK REGISTERS.                        * 64530016
*        REGISTER 2 IS THE RETURN REGISTER.                           * 64620016
*                                                                     * 64710016
*********************************************************************** 64800016
         SPACE                                                          64890016
         USING IOBLOCKS,9                                               64980016
         USING IHADCB,5                                                 65070016
CLOSEOUT LA    GR9,BLOCKS              ADDRESS OF BASIC I/O BLOCKS.     65160016
         L     GR5,OUTDCBAD            ADDRESS OF FROM DCB.             65250016
         TM    DCBOFLGS,X'10'          DEVICE EVER OPENED.              65340016
         BCR   8,GR14                  NO--RETURN TO CALLER.            65430016
         BAL   GR4,CLOSE1              GO TO CLOSE THIS DCB.            65520016
         CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               65610016
         BCR   8,GR14                  YES--RETURN TO CALLER.           65700016
         L     GR5,TODCBAD             TO DCB ADDRESS.                  65790016
         BAL   GR4,CLOSE               GO TO CLOSE THIS DCB.            65880016
         OC    COPYPTR(4),COPYPTR      COPIES REQUESTED.                65970016
         BCR   8,GR14                  NO--RETURN TO CALLER.            66060016
         L     GR8,COPYPTR             ADDR THIS COPY BLOCK.            66150016
         USING COPYBLK,GR8                                              66240016
CLOSEA   LA    GR9,CIOBLOCK            ADDR COPY I/O BLOCK.             66330016
         L     GR5,TODCBAD             ADDR. THIS COPY DCB.             66420016
         BAL   GR4,CLOSE               GO CLOSE THIS DCB.               66510016
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     66600016
         BCR   8,GR14                  NO--RETURN TO CALLER.            66690016
         L     GR8,CCOPYPTR            PTR. TO NEXT COPY BLOCK.         66780016
         B     CLOSEA                  CLOSE TILL ALL DCBS PROCESSED.   66870016
         SPACE                                                          66960016
CLOSE    TM    DCBOFLGS,X'10'          DEVICE EVER OPENED.              67050016
         BCR   8,GR4                   NO--RETURN.                      67140016
CLOSE1   EQU   *                                                 M4826  67170020
         CLI   DEVSW,X'00'         DUMPING TO TAPE               M4826  67200020
         BNE   CLOSEDA             NO                            M4826  67230020
         CLOSE ((5),REWIND)                                      M4826  67260020
         BR    GR4                 RETURN                        M4826  67290020
CLOSEDA  EQU   *                                                 M4826  67320020
         CLOSE ((5))                                             M4826  67350020
         BR    GR4                                               M4826  67380020
         DROP  GR5,GR8                                           M4826  67410020
         EJECT                                                          67500016
*********************************************************************** 67540037
*   THIS SECTION FREES THE CORE THAT WAS USED FOR BUFFERS.              67590016
*********************************************************************** 67620037
FINALR1  EQU   *                        *                        S20201 67650020
         CLC   RPSBUFPT(L4),ZERO       ANY BUFFERS ASSIGNED.     S20201 67710020
         BCR   8,GR14                  NO--RETURN.                      67770016
         L     GR1,RPSBUFPT            ADDRESS OF BUFFER.        S20201 67860020
         USING CONSTANT,2                                               67950016
FREEBUF  L     GR2,IODEVCON            ADDRESS OF DEVICE CONSTANTS.     68040016
         LH    GR0,BUFFSIZE            BUFFER SIZE.                     68130016
         FREEMAIN R,LV=(0),A=(1)                                        68220016
         BR    GR14                    RETURN TO CALLER.                68310016
         SPACE                                                          68400016
FINALR2  MVC   FORM5FPT(8),DDNAME2     DDNAME OF PRIMARY 'TO'.          68490016
         L     GR8,TUCBPTR             UCB PTR FOR PRIMARY 'TO'.        68580016
         BAL   GR7,FINALOUT            GO TO SET UP AND PRINT MSG.      68670016
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                68760016
         BZ    FINALR7                 NO--GO TO RETURN TO MONITOR.     68850016
         L     GR3,COPYPTR             YES--PTR TO FIRST OR ONLY COPY.  68940016
         USING COPYBLK,3                                                69030016
FINALR3  MVC   FORM5FPT(8),DDNAME3     DDNAME FOR THIS COPY.            69120016
         L     GR8,CUCBPTR             UCB PTR FOR THIS COPY.           69210016
         BAL   GR7,FINALOUT            GO TO SET UP AND PRINT THIS MSG  69300016
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     69390016
         BZ    FINALR7                 NO--GO TO RETURN TO THE MONITOR  69480016
         L     GR3,CCOPYPTR            PTR TO NEXT COPY.                69570016
         B     FINALR3                 GO TO PROCESS.                   69660016
         SPACE 2                                                        69750016
FINALOUT LA    GR1,6                   DUMP COMPLETION MESSAGE.         69840016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       69930016
         MVC   MESS+9(7),DUMPTO        'DUMP TO' INTO MESSAGE.          70020016
         MVC   0(8,GR1),FORM5FPT       DDNAME TO MESSAGE.               70110016
         CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        70200016
         BNE   FINALR5                 NO--GO TO BLANK SERIAL REF.      70290016
         CLI   IODEVCON,X'05'          IS THIS 2321              A52430 70340000
         BE    FIXMSG                  YES, FIX MSG FOR 2321     A52430 70350000
         TM    SEQSW,CPYVOLID          DID WE RETAIN NEW SERIAL.        70380016
         BZ    FINALR4A                NO--DO NOT ALTER UCB PTR. A52430 70470000
         USING UCB,8                                                    70560016
         L     GR8,FUCBPTR             YES--FROM DEVICE UCB PTR.        70650016
FINALR4A MVC   40(6,GR1),SRTEVOLI      VOLID TO MESSAGE.         A52430 70700000
         B     FINALR6                 GO TO PRINT THIS MESSAGE. A52430 70710000
FIXMSG   TM    SEQSW,CPYVOLID          DO WE RETAIN OLD SERIAL   A52430 70740000
         BZ    TOBIN                   YES, GO GET TO SUB UCB    A52430 70790000
         L     GR8,FUCBPTR             NO, GET FROM SUB UCB      A52430 70830000
TOBIN    MVC   40(6,GR1),4(GR8)        SET VOLID TO MESSAGE      A52430 70970000
         B     FINALR6                 GO PRINT THIS MESSAGE     A52430 70980000
FINALR5  MVC   22(18,GR1),21(GR1)      BLANKOUT VOLID REF IF TAPE OUT.  71190016
FINALR6  BAL   GR9,MSGWRT1             GO TO PRINT THIS MESSAGE.        71280016
         BR    GR7                     RETURN TO CALLER                 71370016
         EJECT                                                          71460016
FINALR7  LA    GR15,0                  SET UP RETURN CODE.              71550016
         CLI   RCODE,X'FF'             WAS FORMAT 5 BAD.                71640016
         BE    USERC4                  YES,GO SET RC=4         @G32DSPD 71730032
         TM    FLGBYT2,CPYREJEC        IEHDPASS RETURN=4 ?     @G32DSPD 71770032
         BNO   FINAL3                  NO, LEAVE ZERO RETURN   @G32DSPD 71810032
USERC4   LA    GR15,4                  USE RETURN CODE 4       @G32DSPD 71850032
FINAL3   L     GR13,DUMPSAVE+4         RESTORE REGISTER 13.             71910016
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN WITH PROPER CODE. 72000016
         SPACE 2                                                        72090016
         EJECT                                                          72180016
*********************************************************************** 72270016
*                                                                     * 72360016
*   THIS SECTION SETS UP THE PROPER MESSAGES AND LINKS TO THE         * 72450016
*   MESSAGE WRITER TO OUTPUT ANY MESSAGES.                            * 72540016
*                                                                     * 72630016
*********************************************************************** 72720016
         SPACE 1                                                        72810016
BADPARM  LA    GR1,19                  FROMDD IS NOT DIRECT ACCESS.     72900016
         LA    GR3,DDNAME1             DDNAME FOR MESSAGE.              72990016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       73080016
         B     MSGOUT                  GO TO PRINT THIS MESSAGE.        73170016
         SPACE                                                          73260016
         USING IHADCB,8                                                 73350016
NOOPEN   LA    GR1,5                   DEVICE CANNOT BE OPENED.         73440016
         LA    GR3,DCBDDNAM            DDNAME FOR MESSAGE.              73530016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       73620016
         B     MSGOUT                  GO TO PRINT THIS MESSAGE.        73710016
         SPACE                                                          73800016
         SPACE                                                          73890016
BADDEV   LA    GR3,DDNAME2             DDNAME FOR MESSAGE.              73980016
         B     BADDEV2                 GO TO SET UP FOR THIS MESS AGE.  74070016
BADDEV1  LR    GR3,GR7                 POINT TO DDNAME FOR MESSAGE.     74160016
BADDEV2  LA    GR1,20                  INVALID DUMP TO DEV SPECIFIED.   74250016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       74340016
         B     MSGOUT                  GO TO PRINT THIS MESSAGE.        74430016
         SPACE                                                          74520016
COPYERR  LR    GR3,GR7                 POINT TO DDNAME FOR MESSAGE.     74610016
COPYERR1 LA    GR1,21                  INCONSISTENT COPY DEVICES.       74700016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       74790016
         B     MSGOUT                  GO TO PRINT THIS MESSAGE.        74880016
         SPACE                                                          74970016
          SPACE                                                         75060016
INVALTO  LA    GR3,DDNAME2             SET UP DDNAME FOR MESSAGE.       75150016
         B     INVALMSG                GO TO SET UP FOR MESSAGE.        75240016
CINVALTO LR    GR3,GR7                 POINT TO DDNAME FOR MESSAGE.     75330016
INVALMSG LA    GR1,14                  INVALID DUMP DEVICE.             75420016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       75510016
         MVC   MESS+8(7),DUMPTO        FILL IN 'DUMP TO' IN MESSAGE.    75600016
         B     MSGOUT                  GO TO PRINT THIS MESSAGE.        75690016
         SPACE                                                          75780016
INVALTRK LA    GR3,DDNAME1             SET UP DDNAME FOR MESSAGE.       75870016
         LA    GR1,22                  INVALID TRK ADDRESS SPECIFIED.   75960016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MESSAGE.       76050016
         B     MSGOUT                  GO TO PRINT THIS MESSAGE.        76140016
         EJECT                                                          76230016
*********************************************************************** 76320016
*  THIS ROUTINE WILL RECEIVE CONTROL UPON DETECTION OF AN I/O ERROR.  * 76410016
*                                                                     * 76500016
*  SYNADAF(SVC 68) AND ITS ASSOCIATED MACROS WILL BE USED TO          * 76590016
*  DETERMINE THE ERROR CONDITION.                                     * 76680016
*                                                                     * 76770016
*********************************************************************** 76860016
IOERR    LA    GR3,OUTIOB              FROM IOB ADDRESS.                76950016
         B     IOMSG                   GO TO EXECUTE SYNADAF.           77040016
IOTERR   LA    GR3,TOIOB               TO IOB ADDRESS.                  77130016
IOMSG    LA    GR1,13                  I/O ERROR MESSAGE.               77220016
         BAL   GR2,SETUPMSG            SET UP THIS MESSAGE.             77310016
         LR    GR1,GR3                 RESTORE POINTER TO IOB.          77400016
         SYNADAF ACSMETH=EXCP,PARM1=(1)                                 77490016
         MVC   MESS+22(78),49(GR1)     SYNADAF MSG TO BUFFER.    SM4350 77580021
         SYNADRLS                                                       77670016
         BAL   GR14,CLOSEOUT           GO TO CLOSE ALL DCBS.            77760016
         BAL   GR14,FINALR1            GO TO FREE CORE.                 77850016
         BAL   GR9,MSGWRT1             PRINT I/O ERROR MSG.             77940016
         CLI   DEVSW,X'FF'             DUMPING TO DA.                   78030016
         BE    UNUSE1                  GO SET HIGH RETURN CODE.         78120016
UNUSABLE CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               78210016
         BE    UNUSE1                  YES--GO SET HIGH RETURN CODE.    78300016
         LA    GR3,DDNAME2             DDNAME FOR MESSAGE.              78390016
         BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MESSAGE.  78480016
         OC    COPYPTR(4),COPYPTR      ANY COPIES.                      78570016
         BZ    UNUSE1                  NO-BRANCH.                       78660016
         USING COPYBLK,GR3                                              78750016
         L     GR3,COPYPTR             PTR TO 1ST OR ONLY COPY BLK.     78840016
UNUSE    BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MSG.      78930016
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     79020016
         BZ    UNUSE1                  NO-BRANCH.                       79110016
         L     GR3,CCOPYPTR            YES-PTR TO NEXT COPY BLK.        79200016
         B     UNUSE                   CONTINUE PROCESSING.             79290016
UNUSE1   LA    GR15,8                  SET RETURN CODE.                 79380016
         B     FINAL3                  RETURN TO MONITOR.               79470016
         EJECT                                                          79560016
MSGWRTA  LA    GR1,30                  UNUSABLE MESSAGE.                79650016
         BAL   GR2,SETUPMSG            GO TO SET UP THIS MSG.           79740016
         MVC   0(8,GR1),0(GR3)         DDNAME TO MESSAGE.               79830016
         BAL   GR9,MSGWRT1             GO TO PRINT MSG.                 79920016
         BR    GR4                     RETURN TO CALLER.                80010016
         DROP  GR3                                                      80100016
         SPACE                                                          80190016
SETUPMSG LINK  EP=IEHDMSGB             GO TO MOVE IN DESIRED MESSAGE.   80280016
         BR    GR2                     RETURN.                          80370016
         SPACE                                                          80460016
MSGOUT   MVC   0(8,GR1),0(GR3)         DDNAME TO MESSAGE.               80550016
         SPACE                                                          80640016
MSGWRT   BAL   GR14,CLOSEOUT           GO TO CLOSE ALL DUMP DCBS.       80730016
         BAL   GR14,FINALR1            GO FREE BUFFER SPACE, IF ANY.    80820016
         BAL   GR9,MSGWRT1             GO TO PRINT OUT MESSAGE.         80910016
         LA    GR15,8                  SET UP ERROR RETURN CODE.        81000016
         B     FINAL3                  RETURN TO MONITOR.               81090016
MSGWRT1  LINK  EP=IEHDPRNT             PRINT THE MESSAGE.               81180016
         BR    GR9                     RETURN.                          81270016
         SPACE                                                          81360016
MOVE     MVC   1(1,GR1),0(GR1)         EXECUTED TO CLEAR DATA BUFFER.   81450016
         SPACE                                                          81540016
         EJECT                                                          81630016
*********************************************************************** 81650037
* CONSTANTS AND EQU:S                                                   81670037
*********************************************************************** 81690037
         DS    0H                                                       81720016
SIXTEEN  DC    H'32'                                                    81810016
TWO56    DC    H'256'                                                   81900016
RESTCODE DC    X'F47006016663B24D'     RESTORE TAPE CODE.               81990016
CCSILI   EQU   X'60'                    READ-DATA CHAINING CODE YL02912 82000002
SILI     EQU   X'20'                    READ DATA SILI BIT      YL02912 82010002
L6       EQU   6                        OFFSET TO DATA LEN      YL02192 82020002
RHA      EQU   X'1A'                    READ HOME ADDR CMD      YL02192 82030002
ALTRK    EQU   X'01'                    ALTERNATE INDIC IN HA   YL02192 82032002
R1       EQU   X'01'                    RECORD NO. OF F4 DSCB   SA58744 82040001
R2       EQU   X'02'                    RECORD NO. OF F5 DSCB   SA58744 82050001
D58      EQU   58                       OFFSET INTO F4 DSCB     SA58744 82060001
CONTAM   EQU   X'80'                    DOS CONTAMINATION BIT   SA58744 82070001
GOOD     EQU   X'7F'                                                    82080016
HALF2    DC    H'2'                                              S20201 82082020
D0       EQU   0                       DISPLACEMENT OF ZERO.     S20201 82084020
D1       EQU   1                                                 S20201 82088020
WINCH    EQU   X'0A'                    WINCHESTER DEVICE TYPE  XL03130 82095903
ICEBG    EQU   X'0D'                    ICEBERG DEVICE TYPE     XL03145 82099803
MERLN    EQU   X'09'                    MERLIN DEVICE TYPE      XL03145 82103703
L1       EQU   1                                                XL03145 82107603
L2       EQU   2                                                XL03145 82111503
D14      EQU   14                       DOS CONTAM BIT OFFSET   XL03145 82115403
D10      EQU   10                       OFFSET TO F4 CYL CNT    XL03145 82119303
D18      EQU   18                       OFFSET TO F4 CYL CNT    XL03145 82121303
DOSCON   EQU   X'80'                    F4 DSCB DOS CONTAM FLAG XL03130 82123203
D16      EQU   16                      DISPLACEMENT OF SIXTEEN.  S20201 82127103
K8       EQU   8                                                 S20201 82131003
L4       EQU   4                       LENGTH OF FOUR.           S20201 82134903
L16      EQU   16                      LENGTH OF EIGHT.          S20201 82138803
D38      EQU   38                       DISP OF 38              Y02113  82142703
CLOCK    EQU   32                       DISPL INTO BUFFER FOR   Y02113  82146603
*                                       TIMESTAMP               Y02113  82150503
RPS      EQU   X'10'                   TEST FOR UCB RPS FEATURE. S20201 82154403
SWOFF    EQU   X'BF'                  *TO SET RPS SWITCH OFF.    S20201 82158303
TICCODE  EQU   X'08'                                             S20201 82162203
COMPCODE DS    1F                      FOR COMPLETION CODE.      A34026 82166103
ZERO     DC    2F'0'                                                    82200032
F1       DC    F'1'                                                     82230032
CCHHADDR DS    1F            SAVE AREA FOR CCHH OF IPL TRK.      M4513  82260032
RC4      DC   AL1(4)                  TEST IEHDPASS RETURN     @G32DSPD 82290032
*********************************************************************** 82320037
*    TABLE OF STAND/ALONE DUMP/RESTORE DEVICE TYPE CODES.               82350016
*********************************************************************** 82390037
CODES    DC    X'01'                   2311.                            82440016
         DC    X'05'                   2301.                            82530016
         DC    X'04'                   2303.                            82620016
         DC    X'03'                   2302.                            82710016
         DC    X'00'                   2321.                            82800016
         DC    X'06'                   2305-1                    S20201 82890037
         DC    X'07'                   2305-2                    S20201 82980037
         DC    X'02'                   2314.                            83070016
         DC    X'09'                   3330                      S20201 83110037
         DC    X'0A'                   WINCHESTER(3340)         XL03130 83120037
         DC    X'0B'                   MADRID(3350)            @Z30RSAG 83130037
         DC    X'0C'                   UNUSED                           83140037
         DC    X'0D'                   ICEBERG(3330-11)         XL03145 83150037
         DS    0F                                                       83160016
SCC2321  DC    X'00F60000'             INCREMENT TO NEXT SUBCELL.       83250016
STC2321  DC    X'0000FB00'             INCREMENT TO NEXT STRIP.         83340016
REELCTRL EQU   F1                                                       83430016
DUMPTO   DC    C'DUMP TO'              FOR COMPLETION MESSAGE.          83520016
DUMPSAVE DS    18F                                                      83610016
LIST     DS    0F                      FOR READ IN JFCB.                83700016
         DC    X'87'                                                    83790016
         DC    AL3(0)                                                   83880016
         SPACE 3                                                        83970016
OPENLT  OPEN  (,(OUTPUT)),MF=L         PARAMETER LIST FOR OPEN TAPE.    84060016
OPENLD   RDJFCB (,(INPUT)),MF=L        PARM LIST FOR OPEN DA.  @ZA10935 84150037
         EJECT                                                          84240016
TAPECCW5 CCW   1,0,X'20',24            WRITE CONTROL RECORD.       2319 84420018
         SPACE                                                          84440020
SETCCW   EQU   *                                                 M5900  84450020
         CCW   X'23',F1,X'40',1         SET SECTOR ZERO          M5900  84460020
TIC      CCW   8,0,X'40',0             TIC INTO CHANNEL PROGRAM. S20201 84480020
         SPACE                                                          84510016
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      84600016
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              84690016
RDVDATA  CCW   6,0,X'20',140           READ VTOC DSCB.                  84780016
RDHA     CCW   26,0,X'20',5             READ HA TO DETERMINE IF YL02912 84830002
*                                       THIS TRK IS AN ALTERN.  YL02912 84840002
         SPACE 1                                                        84870016
HAR0CCW  CCW   7,X'0032AA',X'40',6     SEEK                             84960016
         CCW   X'1F',X'0031A6',X'40',1 SET FILE MASK                    85050016
HAR0CCW1 CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0.                   85140016
         CCW   8,X'0032D8',0,0         SEARCH UNTIL FOUND.              85230016
         CCW   5,X'003E18',X'60',8     WRITE R0 DATA.                   85320016
HAR0CCW2 CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0                    85410016
         CCW   8,X'0032F0',0,0         REPEAT UNTIL FOUND.              85500016
         CCW   6,X'003E18',X'70',8     READ BACK CHECK R0 DATA.         85590016
         CCW   X'11',X'000BF0',X'20',8 ERASE REST OF TRACK.             85680016
         SPACE                                                          85770016
R0R1CCWS CCW   7,X'0032AA',X'40',6     SEEK.                            85860016
         CCW   X'1F',X'0031A6',X'40',1 SET FILE MASK.                   85950016
CCWA     CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0                    86040016
         CCW   8,X'0032D8',0,0         REPEAT UNTIL FOUND.              86130016
         CCW   X'1D',X'003E20',X'60',X'FFFF'   WRITE CNT,KEY DATA R1.   86220016
CCWB     CCW   X'31',X'0032AC',X'60',5 SEARCH FOR R0                    86310016
         CCW   8,X'0032F0',0,0         REPEAT UNTIL FOUND.              86400016
         CCW   5,X'003E18',X'60',8     WRITE DATA R0.                   86490016
         CCW   X'1E',X'003E20',X'70',X'FFFF'   READ BACK CHK R1.        86580016
         CCW   X'16',X'003E18',X'30',16    READ BACK CHK R0.            86670016
         SPACE                                                          86760016
         EJECT                                                          86850016
*********************************************************************** 86890037
*   DUMP DA WRITE-OUT ECB.                                              86940016
*********************************************************************** 86980037
         DS    0D                      ALIGNMENT.                       87030016
WRTECB   DC    F'0'                    WAIT//COMPLETE BITS.             87120016
*********************************************************************** 87160037
*   DUMP DA WRITE-OUT IOB.                                              87210016
*********************************************************************** 87250037
WRTIOB   DS    0F                                                       87300016
WRTFLAGS DC    XL2'4200'               FLAG ONE AND TWO.                87390016
WRTSENSE DS    H'0'                    SENSE BYTES.                     87480016
WRTECBAD DC    A(WRTECB)               ECB ADDRESS.                     87570016
WRTSTAT  DC    2F'0'                   CHANNEL STATUS.                  87660016
WRTCCWAD DS    A(0)                    CCW ADDRESS.                     87750016
WRTDCBAD DC    A(WRTDCB)               DCB ADDRESS.                     87840016
WRTRESAD DC    F'0'                    RESTART ADDRESS.                 87930016
WRTBLKCT DC    H'1'                    BLOCK COUNT INCREMENT.           88020016
WRTERROR DC    H'0'                    ERROR COUNT.                     88110016
WRTSEEK  DC    2F'0'                   MBBCCHHR.                        88200016
*********************************************************************** 88240037
*   DUMP DA WRITE-OUT DCB.                                              88290016
*********************************************************************** 88310037
         AIF   ('&LIB' EQ 'LIB1').OSDCB                                 88342000
WRTDCB   DCB   DSORG=PS,MACRF=(E),DEVD=DA,EOEA=P8,XENDA=P9,            C88344000
               EXLST=LIST,                                             C88394000
               SIOA=P7,PGFX=YES                                   M5431 88460000
         AGO   .C1                                                      88462000
.OSDCB   ANOP                                                           88464000
WRTDCB   DCB   DSORG=PS,MACRF=(E),DEVD=DA,EOEA=P8,XENDA=P9,            C88466000
               EXLST=LIST                                               88468000
.C1      ANOP                                                           88468400
WRTLSTBL DS    0H                      END OF CONTROL BLOCKS.           88470016
WBLKSIZE EQU   WRTLSTBL-WRTECB         SIZE OF I/O BLOCKS-CUMP.         88560016
         EJECT                                                          88650016
*********************************************************************** 88690037
*   DUMP TAPE WRITE-TO ECB                                              88740016
*********************************************************************** 88780037
         DS    0D                      ALIGNMENT.                       88830016
DTECB    DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   88920016
         SPACE                                                          89010016
*********************************************************************** 89050037
*   DUMP TAPE WRITE-TO IOB.                                             89100016
*********************************************************************** 89140037
DTIOB    DS    0F                                                       89190016
DTFLAGS  DC    XL2'4200'               FLAGS ONE AND TWO.               89280016
DTSENSE  DC    H'0'                    SENSE BYTES.                     89370016
DTECBAD  DC    A(DTECB)                ECB ADDRESS.                     89460016
DTSTATUS DC    2F'0'                   CHANNEL STATUS.                  89550016
DTCCWS   DC    A(0)                    ADDRESS OF CCWS.                 89640016
DTDCBAD  DC    A(DTDCB)                DCB ADDRESS.                     89730016
DTRESAD  DC    F'0'                    RESTART ADDRESS.                 89820016
DTBLKCT  DC    H'0'                    BLOCK COUNT INCREMENT.           89910016
DTERROR  DC    H'0'                    ERROR COUNT.                     90000016
DTPADD   DC    2F'0'                   NOT USED FOR TAPE IOB.           90090016
DTDCB    DCB   DSORG=PS,MACRF=(E),DEVD=TA,EXLST=LIST             A31384 90130020
         SPACE                                                          90180016
CCW2     CCW   1,0,X'20',0             USED TO PUT OUT CCW RECORD.      90360016
*                                         AND DATA FOR TAPE.            90450016
CCW3     CCW   1,HAR0CCW-16,X'60',88   WRITE HA,R0 CCWS ON TAPE.        90540016
         CCW   1,0,X'20',24            WRITE R0 DATA ON TAPE.           90630016
CCW4     CCW   1,R0R1CCWS-16,X'60',96  WRITE HA,R0,R1 CCWS ON TAPE.     90720016
         CCW   1,0,X'20',0             WRITE R0,R1 DATA ON TAPE.        90810016
         SPACE                                                          90900016
DTLSTBLK DS    0H                      END OF CONTROL BLOCK.            90990016
DTBLKSIZ EQU   DTLSTBLK-DTECB          SIZE OF TAPE I/O BLOCK FOR DUMP. 91080016
         EJECT                                                          91170016
         IEHDWORK                                                       91260016
         EJECT                                                          91350016
IOBLOCKS DSECT                                                          91440016
* DUMP 'TO' ECB.                                                        91530016
TOECB    DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   91620016
* DUMP 'TO' IOB.                                                        91710016
TOIOB    DS    0F                                                       91800016
TOFLGS   DS    CL2                     FLAGS ONE AND TWO.               91890016
TOSENSE  DS    CL2                     SENSE BYTES.                     91980016
TOECBAD  DS    1F                      ECB ADDRESS.                     92070016
TOSTATUS DS    2F                      CHANNEL STATUS.                  92160016
TOCCWAD  DS    1F                      CCW LIST ADDRESS.                92250016
TODCBAD  DS    1F                      DCB ADDRESS.                     92340016
TORESAD  DS    1F                      RESTART ADDRESS.                 92430016
TOBLKCNT DS    CL2                     BLOCK COUNT INCREMENT.           92520016
TOERROR  DS    CL2                     ERROR COUNT.                     92610016
TOSEEK   DS    2F                      MBBCCHHR.                        92700016
* DUMP 'TO' DCB.                                                        92790016
TODCB    DS    13F                     DCB.                             92880016
         DS    0D                      FOR DOUBLE WORD ALIGNMENT.       92970016
TAPECCW2 DS    1D                      USED TO PUT OUT CCW RECORD       93060016
*                                        AND DATA ON TAPE.              93150016
TAPECCW3 DS    2D                      WRITE HA,R0 CCWS ON TAPE.        93240016
TAPECCW4 DS    2D                      WRITE HA,R0,R1 CCWS ON TAPE.     93330016
         DS    0D                      FOR DOUBLE WORD ALIGNMENT.       93420016
* DUMP 'FROM' ECB.                                                      93510016
OUTECB   DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   93600016
* DUMP 'FROM' IOB.                                                      93690016
OUTIOB   DS    0F                                                       93780016
OUTFLG   DS    CL2                     FLAGS ONE AND TWO.               93870016
OUTSENSE DS    CL2                     SENSE BYTES.                     93960016
OUTECBAD DS    1F                      ECB ADDRESS.                     94050016
OUTSTAT  DS    2F                      CHANNEL STATUS.                  94140016
OUTCCWAD DS    1F                      CCW LIST ADDRESS.                94230016
OUTDCBAD DS    1F                      DCB ADDRESS.                     94320016
OUTRESAD DS    1F                      RESTART ADDRESS.                 94410016
OUTBLKCT DS    CL2                     BLOCK COUNT INCREMENT.           94500016
OUTERROR DS    CL2                     ERROR COUNT.                     94590016
OUTSEEK  DS    2F                      7BBCCHHR.                        94680016
CCHH     EQU   OUTSEEK+3               CYLINDER/HEAD ADDRESS.           94770016
R        EQU   OUTSEEK+7               RECORD NUMBER.                   94860016
* DUMP 'FROM' DCB.                                                      94950016
OUTDCB   DS    18F                     DCB.                             95040016
         SPACE                                                          95130016
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           95220016
DBSIZE   EQU   IOBLKEND-IOBLOCKS       SIZE OF IOBLOCKS DSECT.          95310016
         SPACE 1                                                        95400016
         IEHDBLKS                                                       95490016
VLABEL   DSECT                                                 , M4513  95499019
VOLUME   DS    CL3                     LABEL IDENTIFIES.         M4513  95508019
VOLNO    DS    CL1                     LABEL NUMBER.             M4513  95517019
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.      M4513  95526019
SECURITY DS    CL1                     VOLUME SECURITY.          M4513  95535019
VTOCPTR  DS    CL10                    POINTER TO VTOC.          M4513  95544019
         DS    CL20                    RESERVED.                 M4513  95553019
OWNER    DS    CL10                    OWNER IDENTIFICATION      M4513  95562019
         DS    CL29                    BLANK.                    M4513  95571019
         SPACE                                                          95580016
         EJECT                                                          95670016
CVT      DSECT                                                          95760016
         CVT   SYS=MIN                                                  95850016
         EJECT                                                          95940016
UCB      DSECT                                                          96030016
         IEFUCBOB                                                       96120016
         EJECT                                                          96210016
JFCB     DSECT                                                          96300016
         IEFJFCBN                                                       96390016
         EJECT                                                          96480016
         DCBD  DSORG=PS                                                 96570016
         END                                                            96660016
./  ADD  SSI=70880138,NAME=IEHDEXCP
         COPY  LCGASMSW                                                 00100000
IEHDEXCP CSECT                                                          00102021
*                                                                       00104440
*C 111500,277000,759000             @SA75596=@XA10959=@YA11189=@ZA06532 00105940
*A 169800-169840,275500-276500,     @SA75596=@XA10959=@YA11189=@ZA06532 00107940
*A 751500                           @SA75596=@XA10959=@YA11189=@ZA06532 00110540
*                                                                       00110840
*C 111500,122748,122757             @YA10573=@SA75577=@XA10923=@ZA04436 00114740
*                                                                       00118640
*C 111500                           @SA74482=@YA10558=@XA10391=@ZA04427 00122540
*A 731720-731760                    @SA74482=@YA10558=@XA10391=@ZA04427 00126440
*                                                                       00130340
*C 111500                           @YA09679=@SA74485=@XA10384=@ZA04411 00134240
*A 122344                           @YA09679=@SA74485=@XA10384=@ZA04411 00138140
*                                                                       00142040
*C 124032                           @XA08872=@SA74445=@YA08050=@ZA03364 00145940
*A 111400-111600,124032,124120,     @XA08872=@SA74445=@YA08050=@ZA03364 00149840
*A 124124                           @XA08872=@SA74445=@YA08050=@ZA03364 00153740
*                                                                       00157600
*D 122320,122620,122640,161456      @SA73402=@YA06584=@XA07254=@ZA01677 00161500
*C 122340,122740,124090,124190      @SA73402=@YA06584=@XA07254=@ZA01677 00165400
*C 161440                           @SA73402=@YA06584=@XA07254=@ZA01677 00169300
*A 122744-122805,124058             @SA73402=@YA06584=@XA07254=@ZA01677 00173200
*A 124136-124183,124203-124207      @SA73402=@YA06584=@XA07254=@ZA01677 00177100
*A 124244-124245,161436             @SA73402=@YA06584=@XA07254=@ZA01677 00181000
*A 161444-161452,826500-826592      @SA73402=@YA06584=@XA07254=@ZA01677 00184900
*A 845100-845480                    @SA73402=@YA06584=@XA07254=@ZA01677 00188800
*                                                                       00192700
*C 576660,589660,734040             @SA69914=@YA04806=@XA05792=@ZA01201 00196600
*A 733520,733540                    @SA69914=@YA04806=@XA05792=@ZA01201 00200500
* D148000-149000,144500-145500                                   YM0959 00204400
*158000,80100                                                    4073   00208300
*        RELEASE 23 DELETIONS                                         * 00212220
*        RELEASE 22 DELETIONS                                         * 00216120
*        RELEASE 21 DELETIONS                                         * 00220020
*A161404                                              VS08480 = OZ00607 00220402
*569760-575160,581160-667560,795500-796500   SA65560 = OX2864 = OY2654  00222003
*                         PTM XM0208 IS ANSWERED UNDER OS APAR SA53223  00230002
*                                               XM4417=YA03005=SA67332  00232003
*           PTM 5476 IS FLAGGED AS SA67332                      XM5476  00234003
*1310161700                                                      A42498 00240021
*        RELEASE 20 DELETIONS                                         * 00260020
*0900447050,447070,773900                                        M6419  00265020
*0900478600-478800                                               M5599  00270020
*0900478600-478800,795000                                        A37209 00290020
*0900622630-622670,622680-622820,668950                          A21395 00328020
*0900564070,564750                                               A31314 00338020
*0900564070                                                      M0025  00343020
*0900                                                            S20201 00348020
* APAR 38132 IS FIXED IN THIS MODULE AS OF RELE 19.6            A38132  00348320
*        RELEASE 19 DELETIONS                                           00348720
*2276380000                                                      A29477 00349420
*2276661900-666200,671200-723200,897000-905000                   M4513  00350120
*2276669150-669180                                               A29172 00350820
*177000-179800,564160-564840,585600-585800                       7042   00351520
*076200,731800-732700,734500                                     O122   00352220
*175000                                                          7343   00352920
*607430                                                          6057   00353620
*        RELEASE 18 DELETIONS                                           00354320
*3411563000,569000,578200-578700                                 3651   00355020
*3411428380                                                      2920   00355720
*3411669150-669250,669600                                        2319   00356420
*3411622630                                                      1326   00357120
*STATUS CHANGE LEVEL 005                                                00377121
*                                                                     * 00400016
*FUNCTION/OPERATION- THIS ROUTINE HANDLES SOME OF THE I/O FOR THE     * 00500002
*   DUMP FUNCTION OF THE IEHDASDR UTILITY PROGRAM. ALL I/O INVOLVED   * 00600016
*   WITH DA AND/OR TAPE DEVICES IS AT THE EXCP LEVEL. THE FIRST       * 00700016
*   I/O OPERATION ON THE DIRECT ACCESS DEVICE RESULTS IN THE END OF   * 00800016
*   EXTENT APPENDAGE(IGG019P8) BEING ENTERED FROM IOS. THIS ROUTINE   * 00900016
*   WILL MODIFY THE DEB EXTENTS AND SET THE CORRECT FILE MASK.        * 01000016
*   PROCESSING WILL BE DONE ONE TRACK AT A TIME UNTIL EITHER THE      * 01100016
*   DUMP LIMITS OR THE VOLUME LIMITS ARE EXHAUSTED. CONTROL WILL BE   * 01200016
*   RETURNED TO -IEHDDUMP- AT THIS TIME.                              * 01300016
*   MOST OF THE I/O WILL BE HANDLED BY IEHDDOIO MODULE, WHICH   SA53223 01350002
*   WAS CREATED AS A RESULT OF SPLITTING IEHDEXCP FOR VS1/2.    SA53223 01360002
*                                                                     * 01400016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDEXCP-, AND CONTROL IS     * 01500016
*   ALWAYS RECEIVED FROM THE -IEHDDUMP- ROUTINE.                      * 01600016
*                                                                     * 01700016
*INPUT- POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL BLOCK    * 01800016
*   (REGISTER 10).                                                    * 01900016
*                                                                     * 02000016
*OUTPUT TO DIRECT ACCESS- A COPY OF THE -FROM- DIRECT ACCESS          * 02100016
*   DEVICE WITH PREVIOUSLY UNOWNED TRACKS CLEANED UP.                 * 02200016
*                                                                     * 02300016
*OUTPUT TO TAPE-                                                      * 02400016
*   LIMITS RECORD- ALWAYS THE FIRST RECORD AFTER A TAPE MARK ON       * 02500016
*   EACH VOLUME OF TAPE. THIS RECORD IS 24 BYTES IN LENGTH AND        * 02600016
*   CONTAINS THE FOLLOWING INFORMATION.                               * 02700016
*                                                                     * 02800016
*        BYTES 0-3    CCHH OF THE FIRST TRACK DUMPED.                 * 02900016
*        BYTES 4-7    CCHH+1 OF THE LAST TRACK DUMPED.                * 03000016
*        BYTES 8-11   CCHH OF THE FIRST TRACK THIS VOLUME.            * 03100016
*        BYTES 12-19  CODE THAT IDENTIFIES THIS AS BEING A            * 03200016
*                     RESTORE TAPE.                                   * 03300016
*        BYTE  20     FULL DUMP SWITCH -X'F0'=FULL,X'00'=PARTIAL.     * 03400016
*        BYTE  21     DEVICE TYPE CODE AS FOLLOWS.                    * 03500016
*                        CODE 0    2321                               * 03600016
*                             1    2311                               * 03700016
*                             2    2314                               * 03800016
*                             3    2302                               * 03900016
*                             4    2303                               * 04000016
*                             5    2301                               * 04100016
*        BYTES 22-23  UNUSED.                                         * 04200016
*                                                                     * 04300016
*   CONTROL RECORD- THIS RECORD IS WRITTEN FOR EACH TRACK DUMPED      * 04400016
*   AND IMMEDIATELY PRECEDES THE DATA RECORD FOR EACH TRACK. IT       * 04500016
*   CONTAINS A CHANNEL PROGRAM USED BY RESTORE TO WRITE ONE TRACK.    * 04600016
*   THE LENGTH OF THIS RECORD DEPENDS ON THE NUMBER OF RECORDS ON     * 04700016
*   THE DUMPED TRACK.                                                 * 04800016
*                                                                     * 04900017
*   TRACK IMAGE RECORD- THIS RECORD CONTAINS THE DATA DUMPED FROM     * 05000017
*   A TRACK AND ALWAYS FOLLOWS A CONTROL RECORD.  IT IS WRITTEN AS    * 05100016
*   ONE MAXIMUM LENGTH PHYSICAL RECORD ON TAPE. IT CONTAINS THE       * 05200016
*   DATA FIELD OF RECORD ZERO AND ALL FIELDS OF OTHER RECORDS THAT    * 05300016
*   WERE ON THE TRACK THAT WAS DUMPED.                                * 05400016
*                                                                     * 05500016
*   TRAILER RECORD- THIS ALWAYS FOLLOWS THE TAPE MARK THAT WAS AT     * 05600016
*   THE END OF THE LAST TRACK IMAGE RECORD. IT IS 24 BYTES IN         * 05700016
*   LENGTH, OF WHICH ONLY THE FIRST 4 BYTES ARE USED. IT INDICATES    * 05800016
*   WHETHER THE RESTORE IS COMPLETE WHEN THE END OF THIS VOLUME       * 05900016
*   IS REACHED.                                                       * 06000016
*                                                                     * 06100016
*EXITS-NORMAL- SUCCESSFUL COMPLETION OF ALL I/O OPERATIONS RESULTS    * 06200016
*   IN A RETURN TO -IEHDDUMP- WITH A RETURN CODE OF ZERO.             * 06300016
*                                                                     * 06400016
*EXITS-ERROR-  ANY ERROR ENCOUNTERED WILL BE DESCRIBED BY AN          * 06500016
*   APPROPRIATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE        * 06600016
*   GREATER THAN ZERO WILL ALSO BE PASSED TO -IEHDDUMP-.              * 06700016
*                                                                     * 06800016
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS ENTERED FROM -IEHDDUMP-.   * 06900016
*   FIVE OTHER CSECTS ARE USED BY THE ROUTINE. ANY MESSAGES WILL      * 07000016
*   BE WRITTEN OUT BY THE MESSAGE WRITER ROUTINE(IEHDPRNT) AFTER      * 07100016
*   BEING SET UP BY THE MESSAGE ROUTINE(IEHDMSGB). THE END OF         * 07200016
*   EXTENT APPENDAGE(IGG019P8) HANDLES THE LIMITS AND EXTENTS IN      * 07300016
*   THE DEB FOR ALL DA DEVICES INVOLVED. ALL DEVICE DEPENDENT         * 07400016
*   CONSTANTS WILL BE CONTAINED IN THE -IEHDCONS- CSECT. IEHDEXCP     * 07500016
*   WILL LOAD BOTH -IEHDAOUT- AND -IEHDPRNT- WHEN DUMPING TO A        * 07560016
*  SYSTEM OUTPUT DEVICE.  IEHDRCVR WILL BE LINKED TO WHEN AN I/O   O122 07590019
*  ERROR (MISSING ADDRESS MARKER OR DATA CHECK) ARE ENCOUNTERED    O122 07620019
*  WHEN DUMPING TO SYSOUT.                                         O122 07650019
*                                                                     * 07700016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE, NON-PRIVILEGED.          * 07730016
*                                                                     * 07760016
 TITLE 'IEHDEXCP-2ND CSECT OF IEHDDUMP-IEHDASDR SYSTEM UTILITY PROGRAM' 07860016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             08000016
GR0      EQU   0                                                        08100016
GR1      EQU   1                                                        08200016
GR2      EQU   2                                                        08300016
GR3      EQU   3                                                        08400016
GR4      EQU   4                                                        08500016
GR5      EQU   5                                                        08600016
GR6      EQU   6                                                        08700016
GR7      EQU   7                                                        08800016
GR8      EQU   8                                                        08900016
GR9      EQU   9                                                        09000016
GR10     EQU   10                                                       09100016
GR11     EQU   11                                                       09200016
GR12     EQU   12                                                       09300016
GR13     EQU   13                                                       09400016
GR14     EQU   14                                                       09500016
GR15     EQU   15                                                       09600016
RCVT     EQU   9                                                        09700016
UCBPTR   EQU   9                                                        09800016
BASEREG  EQU   11                                                       09900016
WORKBASE EQU   12                                                       10000016
         SPACE 2                                                        10100016
         USING FUNCBLK,10                                               10200016
         USING IEHDEXCP,BASEREG                                         10300016
         USING WORK,12                                                  10400016
         SAVE  (14,12),T,*             SAVE THE REGISTERS.              10600016
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          10700016
         LA    GR7,EXCPSAVE            SAVE AREA ADDRESS.               10800016
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      10900016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      11000016
         LR    GR13,GR7                SAVE AREA FOR CALLED ROUTINES.   11100016
         USING IOBLOCKS,9                                               11130016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA03364 11140040
         DC    C'OZ06532'              LAST APAR FIXED IN MOD  @ZA06532 11150040
APARNO   LA    GR9,BLOCKS              ADR PRIMARY I/O BLOCKS. @ZA03364 11160040
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     11300016
         TM    0(GR3),PROCESS          PREVIOUSLY UNDER WAY.            11400016
         BZ    FORMAT5                 NO--START FROM THE BEGINNING.    11500002
         B     RDCNTS                   RETURN TO IEHDDOIO      SA53223 11600002
         EJECT                                                          11710016
*********************************************************************** 11900002
*        THIS SECTION WILL READ IN THE FORMAT 4 DSCB TO DETERMINE     * 11950002
*        IF THE I/P DEVICE IS A DOS PACK. IF IT IS, THE 'DUMPALL'     * 12010002
*        SWITCH WILL BE SET. IF IT IS NOT A DOS                       * 12060002
*        PACK, THE FORMAT5 DSCB WILL READ IN . ALL AVAILABLE          * 12100002
*        EXTENTS WILL BE CONVERTED FROM RTA TO MBBCCHHR, USING        * 12150002
*        THE CVT CONVERT ROUTINE. THE CONVERTED EXTENTS WILL BE       * 12200002
*        STORED IN THE FORMAT5 TABLE FOR LATER USE DETERMINING        * 12202002
*        IF AN INDIVIDUAL TRACK IS OWNED AND THUS IF THIS TRACK       * 12204002
*        SHOULD BE DUMPED.                                            * 12206002
**********************************************************************  12208002
         USING IHADCB,GR8                                               12210002
         USING IOBLOCKS,GR9                                             12212002
FORMAT5  CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               12214002
         BE    START                   YES--DO NOT PROCESS FORMAT5      12216002
         LA    GR8,OUTDCB              ADDRESS OF DCB.                  12218002
         L     GR1,DCBDEBAD            ADDRESS OF DEB.                  12220002
         MVC   OUTSEEK+3(4),38(GR1)    CCHH OF VTOC TO IOB.             12222002
         AIF   ('&LIB' EQ 'LIB1').NOTIME BRCH IF OS ASSEM        Y02113 12224002
         MVC   TIMESTMP(L4),D38(GR1)    SAVE CCHH OF F4 DSCB     Y02113 12226002
.NOTIME  ANOP                                                    Y02113 12228002
         MVI   R,R1                     SET REC NO. FOR F4 DSCB SA58744 12230002
RDF4     EQU  *                                                @ZA01677 12234002
         MVI   RDVTOC,X'FF'            INDICATE VTOC JUST READ @ZA04411 12234440
         LA    GR3,OUTSEEK+3           SEARCH ADDRESS.                  12236002
         ST    GR3,READVTOC            SEARCH ADDRESS TO SEARCH CCW.    12238002
         MVI   READVTOC,X'31'          RESET OP CODE.                   12240002
         LA    GR3,READVTOC            CCW ADDRESS OF RD FORMAT5 CCW.   12242002
         ST    GR3,OUTCCWAD            SET CCW ADDRESS IN IOB.          12244002
         L     GR3,FORM5FPT            ADDRESS OF BUFFER.               12246002
         LA    GR3,D84(GR3)            INCREMENT INTO BUFFER            12248002
         ST    GR3,RDVDATA             STORE ADDRESS IN READ KD CCW.    12250002
         MVI   RDVDATA,X'0E'           RESET OP CODE.                   12252002
         EXCP  OUTIOB                  READ IN FORMAT5 DSCB TO BUFFER.  12254002
         WAIT  ECB=OUTECB              AWAIT COMPLETION                 12256002
         CLI   OUTECB,GOOD             ALL OK                           12258002
         BNE   IOERR                   NO-ERROR                         12260002
         MVI   R,R2                    RESET SEEK ARGU FOR F5   SA58744 12266002
         LA    GR7,START               SET 1ST TIME THRU SWT    SA58744 12268002
         TM    D58(GR3),CONTAM+VTOCERR FMT 5 BAD ?                      12270002
         BNZ   NOCOND                  YES, DONOT READ F5      @ZA03364 12272040
         MVC   F5CCHHR(5),OUTSEEK+3    CCHHR OF FIRST F5 DSCB  @ZA01677 12274002
*                                      TO CAMLST (OBTAIN)      @ZA01677 12274402
OBTF5    L     GR3,FUCBPTR             PTR TO FROM UCB         @ZA04436 12274840
         MVC   FRVOL(6),28(GR3)        FROM VOLSER TO CAMLST   @ZA01677 12275202
         USING F5BUF,GR8               F5BUF DSECT             @ZA01677 12275602
         L     GR8,FORM5FPT            PT TO F5BUF             @ZA04436 12275740
         LA    GR3,DS5KEYID            PTR TO F5 DSCB          @ZA01677 12275802
         ST    GR3,F5DSCB+12           READ IN ADR CAMLST      @ZA01677 12275902
         OBTAIN F5DSCB                 OBTAIN F5 DSCB          @ZA01677 12276002
         LTR   GR15,GR15               SUCCESFUL OBTAIN        @ZA01677 12278502
         BNZ   SETFLG                  NO, WRITE MSG 817       @ZA01677 12280502
CONVRT   EQU   *                                                SA58744 12286802
         USING CVT,GR8                                                  12289402
         USING CONSTANT,GR9                                             12292002
         L     GR8,CVTPTR              ADDRESS COMM. VECTOR TABLE.      12294602
         L     GR9,IODEVCON            ADDRESS FOR DEVICE CONSTANTS.    12297202
         L     GR15,CVTPCNVT           ADDRESS CVT CONVERT ROUTINE.     12299802
         DROP  8                                                        12302402
         LA    GR2,D140(GR3)           ADDRESS FOR CONVERTED RTA.       12305002
         MVC   44(90,GR3),45(GR3)      MAKE EXTENTS CONTIGUOUS.         12307602
         MVC   151(5,GR3),135(GR3)     SAVE NEXT F5 PTR                 12310202
         MVC   134(4,GR3),ZERO         ZERO END OF EXTENTS FIELD.       12312802
         BCTR  GR3,0                   DECREMENT PTR. FOR LATER USE.    12315402
         MVC   DUMPWORK(4),ZERO        CLEAR OUT WORK AREA.             12318002
         L     GR1,CNTBUFPT            ADDRESS OF DUMMY DEB.            12320602
         MVI   16(GR1),1               SET FOR ONE EXTENT.              12323202
         L     GR8,FUCBPTR             UCB PTR. FOR 'FROM' DEVICE.      12325802
         EJECT                                                          12328402
FORMAT5A ST    GR8,32(GR1)             UCB PTR. TO DUMMY DEB.           12331002
         MVC   38(4,GR1),ZERO          ZERO FOR LOWER LIMITS.           12333602
         MVI   42(GR1),X'FF'           SET 'FFFF' FOR UPPER             12336202
         MVC   43(5,GR1),42(GR1)         LIMITS IN DEB.                 12338802
         MVI   46(GR1),X'7F'           NUMBER TRKS/EXTENT.              12341402
         L     GR8,FORM5FPT            ADDR. FORMAT5 EXTENTS TABLE.     12344002
         SPACE                                                          12346602
*  INITIALIZATION OF REGISTER COMPLETE. START CONVERTING RTA TO CCHH.   12349202
*              REGISTER 1- ADDRESS OF THE DUMMY DEB.                    12351802
*              REGISTER 2- ADDRESS FOR CONVERTED RTA.                   12354402
*              REGISTER 3- ADDRESS OF READ-IN FORMAT5 DSCB.             12357002
*              REGISTER 4- TRKS PER CYL THIS DEVICE.                    12359602
*              REGISTER 8- ADDR NEXT AVAILABLE SLOT IN FORMAT5 TABLE.   12362202
         SPACE                                                          12364802
NEXTRTA  LH    GR4,TRKCYL              TRKS/CYLINDER THIS DEVICE.       12367402
         LA    GR6,1                   FOR INNER LOOP.                  12370002
         LA    GR3,5(GR3)              INCREMENT EXTENT POINTER.        12372602
         MVC   DUMPWORK(2),0(GR3)      MOVE IN BEGINNING RTA THIS EXT.  12375202
         L     GR0,DUMPWORK            PRIME REGISTER 0 FOR CONVERT RTN 12377802
         LTR   GR0,GR0                 END OF EXTENTS.                  12380402
         BZ    LASTRTA                 YES--GO TO SET END OF TABLE.     12383002
CONVERT  LR    GR5,GR13                SAVE REGISTER THIRTEEN.          12385602
         STM   14,12,12(13)            SAVE THE REGISTERS.              12388202
         BALR  GR14,GR15               GO TO CONVERT RTA TO MBBCCHHR.   12390802
         LTR   GR15,GR15               SUCCESSFUL RETURN.               12393402
         LR    GR13,GR5                RESTORE REGISTER THIRTEEN.       12396002
         LM    14,12,12(GR13)          RESTORE ALL THE REGISTERS.       12398602
         BZ    OKEND                   GOOD RETURN-CONTINUE PROCESSING. 12401202
NOCOND   MVI   DOUBLE+4,X'FF'          NOT WRITE COND= IN MSG  @ZA03364 12403240
SETFLG   EQU   *                                                SA58744 12403802
         ST    GR15,DOUBLE             SAVE COND CODE          @ZA01677 12405802
         LA    GR1,17                  INVALID FORMAT5 EXTENT.          12406402
         BAL   GR4,SETUPMSG            SET UP THIS MESSAGE.    @ZA01677 12409002
         MVC   0(8,GR1),DDNAME1        DDNAME TO MESSAGE.               12411602
         TM    DOUBLE+4,X'FF'          WRITE COND= ?           @ZA03364 12412040
         BO    IGNOREF5                NO THEN BRANCH          @ZA03364 12412440
         LA    GR1,8(GR1)              PT AFTER THE DNAME=XXXX @ZA01677 12413602
         MVC   0(5,GR1),COND           MOVE COND= TO MSG       @ZA01677 12414002
         LA    GR1,5(GR1)              PT AFTER COND=          @ZA01677 12414102
         L     GR15,DOUBLE             RELOAD COND CODE        @ZA01677 12414502
         MVI   DOUBLE,X'00'            CLEAR CONVERT AREA      @ZA01677 12414702
         MVC   DOUBLE+1(7),DOUBLE                              @ZA01677 12415102
         CVD   GR15,DOUBLE             CONVERT COND CODE (DEC) @ZA01677 12415502
         UNPK  0(3,GR1),DOUBLE+6(2)    UNPACK COND CODE        @ZA01677 12415902
         OI    2(GR1),X'F0'            SET CORRECT SIGN        @ZA01677 12416402
         MVI   BADCOND,X'00'           CLEAR SWITCH            @ZA01677 12416802
         S     GR15,FOUR               COND CODE = 4?          @ZA01677 12417202
         BZ    TERM                    YES,BRANCH              @ZA01677 12417302
         S     GR15,EIGHT              COND CODE = 12?         @ZA01677 12417402
         BNZ   IGNOREF5                NO,BRANCH               @ZA01677 12417902
TERM     MVI   BADCOND,X'FF'           INDICATE TERMINATE      @ZA01677 12418302
IGNOREF5 BAL   GR4,MSGWRT              WRITE OUT THIS MESSAGE. @ZA01677 12419002
         TM    BADCOND,X'FF'           TERMINATE? (C/C=4/12)   @ZA01677 12420302
         BO    SETCOND                 YES,BRANCH              @ZA01677 12420702
         MVI   RCODE,X'FF'             SET SWITCH FOR RETURN CODE 4.    12422202
         OI    SWITCH,DUMPALL          SET SWITCH TO DUMP ALL TRKS.     12423102
         BR    GR7                     START DUMP I/O FUNCTIONS.        12424002
SETCOND  LA    GR15,8                  SET CON CODE = 8 RETURN @ZA01677 12424402
         B     FINALR3                 TERMINATE THIS FUNCTION @ZA01677 12424502
         EJECT                                                          12424602
OKEND    MVC   0(4,GR8),3(GR2)         MOVE CCHH TO FORMAT5 TABLE.      12427202
         LA    GR8,4(GR8)              INCREMENT FORMAT5 TABLE PTR.     12429802
         MVC   DUMPWORK(4),ZERO        CLEAR OUT WORK AREA.             12432402
         BCT   GR6,NEXTRTA             TAKE BRANCH IF SWITCH IS SET.    12435002
         MVC   DUMPWORK+2(2),0(GR3)      MOVE IN BEGINNING RTA.         12437602
         L     GR0,DUMPWORK            PRIME REGISTER 0 FOR CONVERT RTN 12440202
         MVC   DUMPWORK(4),ZERO        CLEAR OUT WORK AREA.             12442802
         MVC   DUMPWORK+2(2),2(GR3)    MOVE NO OF FULL CYL THIS EXTENT  12445402
         L     GR5,DUMPWORK            PRIME REGISTER FOR MULTIPLY.     12448002
         MR    GR4,GR4                 COMPUTE TOTAL TRACKS.            12450602
         IC    GR4,4(GR3)              ADDITIONAL TRACKS THIS EXTENT.   12453202
         AR    GR4,GR5                 TOTAL ADDITIONAL TRACKS.         12455802
         AR    GR0,GR4                 END RTA THIS EXTENT.             12458402
         BCTR  GR0,0                   DECREMENT NO. OF ADDITIONAL TRKS 12461002
         SLL   GR0,16                  LEFT JUSTIFY FOR CONVERT RTN.    12463602
         LA    GR6,2                   SET UP INNER LOOP CONTROL.       12466202
         MVC   DUMPWORK(4),ZERO        CLEAR OUT WORK AREA.             12468802
         B     CONVERT                 GO TO CONVERT ENDING RTA.        12471402
LASTRTA  MVI   0(GR8),X'FF'            SET END OF TABLE POINTER.        12474002
         BR    GR7                     CONTINUE                         12476602
         EJECT                                                          12479202
         USING IOBLOCKS,9                                               12481802
START    LA    GR9,BLOCKS              ADDRESS PRIMARY I/O BLOCKS.      12484402
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     12487002
         OI    0(GR3),PROCESS          SET SWITCH FOR NOW PROCESSING.   12489602
         MVC   TOSEEK+3(4),CCHHONE     MOVE IN THE                      12492202
         MVC   CCHH(4),CCHHONE              TRACK TO BE DUMPED.         12494802
         MVI   OUTSEEK+3,X'FF'         SET 'CC' OF CCHH FOR APPENDAGE.  12497402
         CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               12500002
         BNE   BUILDCNT                       NO-- GO BEGIN PROCESSING  12506002
         LOAD  EP=IEHDAOUT             LOAD -IEHDAOUT- INTO CORE.       12512002
         ST    GR0,DAOUTADR            SAVE ENTRY POINT.                12518002
         LOAD  EP=IEHDPRNT             LOAD -IEHDPRNT- INTO CORE.       12524002
         ST    GR0,PRNTADR             SAVE ENTRY POINT.                12530002
         EJECT                                                          12536002
*********************************************************************** 12542002
*                                                                     * 12548002
*  THIS SECTION WILL BUILD THE READ COUNT CCWS. MAXIMUM NUMBER OF     * 12554002
*  CCWS IS DETERMINED BY THE MAXIMUM NUMBERS OF RECORDS POSSIBLE PER  * 12560002
*  TRACK THIS DEVICE. THESE WILL BE EXECUTED WITH THE ENTIRE          * 12566002
*  CHANNEL PROGRAM BEING RESTARTED IF RECORD ONE IS AN EOF. GOOD      * 12572002
*  RETURNS FROM THE WAIT WILL BE FILE PROTECT OR TRACK CONDITION.     * 12578002
*  POSSIBLY IN COMBINATION WITH OVERFLOW INCOMPLETE.                  * 12584002
*                                                                     * 12590002
*********************************************************************** 12600002
BUILDCNT L     GR2,CCWBUFPT            GET POINTER TO CCW BUFFER.       12620002
         USING CCWS,2                                                   12640002
         USING IOBLOCKS,GR9                                             12660002
         LA    GR9,BLOCKS          ADDRESS PRIMARY I/O BLOCKS.          12680002
         ST    GR2,OUTCCWAD            CCW ADDRESS TO IOB.              12700016
         TM    SEQSW,RPSFEAT1      FROM DEVICE HAVE RPS          S20201 12706020
         BZ    GO                  NO                            S20201 12712020
         LR    GR4,GR2             PUT BUFF PTR IN WORK REG      S20201 12718020
         SH    GR4,SIXTEEN         PT TO RPS BUFR                S20201 12724020
         ST    GR4,OUTCCWAD        ST PTR IN IOB                 S20201 12730020
         ST    GR2,D8(GR4)         SET UP TIC ADDR               S20201 12736020
         MVI   D8(GR4),TICCODE     RESET TIC OP                  S20201 12742020
GO       EQU   *                        *                        S20201 12748020
         MVI   AOUTSW,FMTTRK           SWITCH TO FORMAT TRACK      O122 12760019
         MVI   RECNUM,X'00'            INITIALIZE FOR NEW TRACK    O122 12820019
         MVC   0(40,GR2),SEARIDEQ      MOVE IN 'DUMMY' CCWS.            12900016
         LA    GR4,OUTSEEK+3           SEARCH ADDRESS.                  13000016
         ST    GR4,SEIDEQR0            STORE INTO CCW.                  13100016
         MVI   0(GR2),X'31'            RESET OP CODE.                   13200016
* THIS SETS UP CORRECT ADDRESSES IN THE CCWS.                           13400016
         ST    GR2,TICBACKA            RESET TIC ADDRESS.               13500016
         MVI   TICBACKA,X'08'          RESET TIC OP CODE.               13600016
         L     GR4,DATBUFPT            POINT TO DATA BUFFER             13800016
         ST    GR4,TRACKPT             SAVE ADDRESS FOR IEHDAOUT   O122 13850019
         ST    GR4,RDWRDATA            STORE ADDRESS IN READ R0 CCW.    13900016
         MVI   RDWRDATA,X'06'          RESET OP CODE.                   14000016
         LA    GR4,8(GR4)              POINT 8 BEYOND ACTUAL BEGINNING. 14100016
         ST    GR4,RDWRTCKD            PUT POINTER IN CCW.              14200016
         MVI   RDWRTCKD,X'9E'          RESET RD CKD OP CODE.            14300016
         MVC   RDWRTCNT+1(3),CNTBUFPT+1  SET ADDR OF COUNT BUFF IN CCW. 14400016
         L     GR8,IODEVCON            PT TO DEVCONS             YM0959 14450000
         USING CONSTANT,GR8                                      YM0959 14500000
         MVC   RDWRTCKD+6(2),DATASIZE  SET BYTE COUNT            YM0959 14550000
         LM    GR4,GR5,32(GR2)         PICK UP DUMMY CCW.               14600016
         LA    GR6,8                   SET UP INCREMENTING FACTOR.      14700016
         LH    GR7,MAXREC              MAXIMUM RECS PER TRK THIS DEV.   15000016
         LA    GR3,RDWRTCNT            SET UP BEGINNING ADDRESS.        15100016
CREATCCW STM   GR4,GR5,0(GR3)          STORE 'DUMMY' CCW IN LIST.       15200016
         AR    GR4,GR6                 UPDATE COUNT BUFFER ADDRESS.     15500016
         AR    GR3,GR6                 INCREMENT CCW POINTER.           15600016
         BCT   GR7,CREATCCW            LOOP THRU UNTIL THRU.            15800016
         SR    GR3,GR6                 BACK UP ONE CCW           4074   15850000
         MVI   4(GR3),X'00'            TURN OFF CHAIN BIT        4074   15900000
         MVI   R,0                     SET SEARCH FOR RECORD ZERO.      16000016
         USING IOBLOCKS,9                                               16010016
TRKOWNED LA    GR9,BLOCKS              ADDRESS PRIMARY I/O BLOCKS.      16020016
         TM    SWITCH,DUMPALL          DUMPING ALL TRACKS THIS DEV.     16030016
         BO    RDCNTS                  YES--GO TO PROCESS FOR THIS TRK. 16040016
         LA    GR5,CCHHONE             CURRENT TRACK ADDRESS.           16050016
         L     GR4,FORM5FPT            PTR TO ENTRY IN FORMAT5 TABLE    16060016
TRKCHK   CLC   0(4,GR5),0(GR4)         CURRENT TRK > OR = LOWER LIMIT.  16070016
         BL    RDCNTS                  NO--LESS THAN--DUMP IT.          16080016
         CLC   4(4,GR4),LASTORIG       UPPER LIMIT=LAST PRIMARY TRK.    16084016
         BE    FINIS                   YES--ECONOMY RUN--GO TO FINISH.  16088016
         CLC   0(4,GR5),4(GR4)         CURRENT TRK < OR = UPPER LIMIT.  16096016
         BNH   WRTHAR0                 YES--DO NOT DUMP IT.             16100016
         LA    GR4,8(GR4)              BUMP TABLE PTR TO NEXT EXTENTS.  16110016
         ST    GR4,FORM5FPT            STORE TABLE PTR FOR FUTURE USE.  16120016
         CLI   0(GR4),X'FF'            END OF TABLE.                    16130016
         BNE   TRKCHK                  NO--GO CHECK NEXT EXTENTS.       16140016
         L     GR8,IODEVCON             RELOAD 'DCONS PTR       OZ00607 16140402
         L     GR3,DATBUFPT            PTR TO DATA BUFFER               16140802
         AH    GR3,DATASIZE            PT TO FORM5 AREA                 16141602
         CLC   235(5,GR3),ZERO         LAST FMT 5                       16142402
         BE    NOMORE                  YES                              16143202
         ST    GR3,FORM5FPT            PT TO HEAD OF AREA      @ZA01677 16143602
         MVC   F5CCHHR(5),235(GR3)     CCHHR OF 2:ND F5 DSCB   @ZA01677 16144002
*                                      TO CAMLST (OBTAIN)      @ZA01677 16144402
         BAL   GR7,OBTF5               DO OBTAIN OF 2-NN F5    @ZA01677 16144802
*                                      DSCB                    @ZA01677 16145202
         USING IOBLOCKS,GR9                                             16146402
         LA    GR9,BLOCKS              ADDR PRIMARY IO BLKS             16147202
         MVC   OUTSEEK+3(4),CONTROL+8  NEXT CCHH                        16148002
         MVI   R,0                     SET TO REC 0                     16148802
         L     GR2,CCWBUFPT            GET PTR TO CCW BUFR              16158002
         TM    SEQSW,RPSFEAT1          RPS ON FROM DEVICE               16163002
         BZ    OK                      NO                               16168002
         L     GR2,RPSBUFPT            YES-PT TO RPS BUFR               16173002
OK       ST    GR2,OUTCCWAD            STORE IN IOB                     16178002
         B     TRKOWNED                CONTINUE CHECK                   16183002
         DROP  8                                                        16188002
NOMORE   EQU   *                                                        16193002
         OI    SWITCH,DUMPALL          SET SWITCH TO DUMP REST OF TRKS  16198002
RDCNTS   EQU   *                                                        16203002
         MVI   BRCHVAL,RDCNTVAL         SET IEHDDOIO BRCH VALUE SA53223 16208002
RDCNTS1  EQU   *                                                SA53223 16258002
         CALL  IEHDDOIO                                         SA53223 16600002
         LA    GR3,BRCHTABL             GET BRCH TABLE ADDR     SA53223 16800002
         SR    GR2,GR2                  ZERO WORK REGISTER      SA53223 16810002
         IC    GR2,BRCHVAL              LOAD BRCH TABLE VALUE   SA53223 16850002
         AR    GR3,GR2                  COMPUTE BRCH TABL ENTRY SA53223 16900002
         BR    GR3                      BRCH TO TABLE ENTRY     SA53223 16950002
WRTHAR0  EQU   *                                                SA53223 16960002
         MVI   BRCHVAL,WRTHARO          SET IEHDDOIO BRCH VALUE SA53223 16970002
         CLI   RDVTOC,X'FF'            JUST READ VTOC?         @ZA06532 16980040
         BNE   RDCNTS1                 NO THEN BRANCH          @ZA06532 16982040
         MVI   RDVTOC,X'F0'            TO GET OK EXTENT IN DEB @ZA06532 16984040
         B     RDCNTS1                  GO CALL IEHDDOIO        SA53223 16990002
BRCHTABL EQU   *                                                SA53223 17000002
         B     PROC4                                            SA53223 17050002
         B     IOERR                                            SA53223 17100002
         B     IOTERR                                           SA53223 17150002
         B     OUT4                                             SA53223 17200002
         B     ISUMSG                                           SA53223 17250002
         B     FINIS                    NOT USED                SA53223 17300002
         B     FINAL3                                           SA53223 17350002
*        END OF BRCH TABLE.                                     SA53223 17580002
OUT4     BAL   GR14,UPCCHH             GO UPDATE THE TRACK ADDRESS.     27500016
         CLI   RDVTOC,X'F0'            TO P8 FIRST TIME        @ZA06532 27550040
         BNE   SKIPP8                  NO,THEN NO FF IN CCHH   @ZA06532 27600040
         MVI   OUTSEEK+3,X'FF'         SET 'CC' OF CCHH FOR P8 @ZA06532 27650040
SKIPP8   L     GR3,CCWBUFPT            ADDRESS READ COUNT CCWS @ZA06532 27700040
         MVI   24(GR3),X'9E'           RESET OP CODE IN CASE R1=EOF.    27800016
         NI    SWITCH,X'AF'            TURN OFF ALL BUT DUMP ALL TRKS.  27850016
         TM    DEVSW,X'F0'             DUMPING TO DA OR SYSOUT.   0811  27860017
         BO    TRKOWNED                YES-BRANCH.                0811  27870017
         L     GR1,TAPECCW4            POINT TO CCWS WRITTEN.     0811  27880017
         MVI   48(GR1),X'1D'           RESET OP CODE IN CASE T.O. 0811  27890017
         B     TRKOWNED                CONTINUE PROCESSING W/ NXT TRK.  27900016
         AIF   ('&LIB' EQ 'LIB1').VSAM01 BRCH IF OS ASSEM       Y02113  43050001
*        TIMESTAMP TEST MADE HERE                               Y02113  43070001
         TM    TIMESET,TIMECHK          HAS F4 DSCB BEEN UPD    Y02113  43080001
         BO    TIMEOK                   YES, DON'T CHK          Y02113  43090001
         CLC   OUTSEEK+D3(L4),TIMESTMP  IS THIS THE F4 DSCB     Y02113  43092001
         BNE   TIMEOK                   NO, DON'T SET CLOCK     Y02113  43094001
         STCK  CLOCK(GR2)               PUT TIMESTMP IN F4 DSCB Y02113  43096001
         OI    TIMESET,TIMECHK          SET CHECK SWITCH        Y02113  43098001
TIMEOK   EQU   *                                                Y02113  43098401
.VSAM01  ANOP                                                   Y02113  43098801
PROC4    BAL   GR14,UPCCHH             GO UPDATE THE TRACK ADDRESS.     44800016
         NI    SWITCH,X'AF'            TURN OFF ALL BUT DUMP ALL TRKS.  44900016
         OI    TOFLGS,X'42'            INDICATE CMD CHAINING.           44950016
         B     BUILDCNT                 GO PROCESS NEXT TRK             56466002
         EJECT                                                          56516002
*                                                                       56566002
*  WRITE TRAILER RECORD.                                                56616002
*                                                                       56666002
         SPACE                                                          56716002
TRAILER  L     GR5,CNTBUFPT            BUFFER POINTER.                  56766002
         ST    GR1,0(GR5)              ST TRAILER REC IN BUFFER.        56816002
         ST    GR5,TAPECCW5         DATA PTR TO WRITE CCW.              56866003
         LA    GR5,TAPECCW5            ADDRESS OF CCWS.                 56916002
         MVI   TAPECCW5,WRTAPE          RESET WRITE OP CODE.            56966003
WRTTRL   ST    GR5,TOCCWAD             CCW POINTER TO IOB.              57316002
VOLEXCP  EXCP  TOIOB                   EXECUTE CHANNEL PROGRAM.         57366002
         WAIT  ECB=TOECB               AWAIT COMPLETION.                57416002
         CLI   TOECB,GOOD              ALL OK.                          57466002
         BCR   8,GR2                   YES-RETURN.                      57516003
         TM    TOSTATUS+4,X'01'        UNIT EXCEPTION-EOV.              57566002
         BCR   1,GR2                   YES-THAT'S OK-RETURN.            57616003
         B     IOTERROR           ALL OTHER IS I/O ERROR       @ZA01201 57666002
YESEOV   EQU   *                                                        57716002
         LA    GR3,TODCB                LOAD DCB ADDRESS                57766002
         USING IHADCB,3                                                 57816002
         OI    DCBOFLGS,TAPMK           INSURE BIT 0 IS ON      SA21395 57866002
         EOV   TODCB                                                    57916002
         LA    GR2,CONTROL              GET ADDR OF HDR         OX2864  57926003
         ST    GR2,TAPECCW5             STORE IN TAPE CCW       OX2864  57936003
         MVI   TAPECCW5,WRTAPE          RESET OPECODE           OX2864  57946003
         L     GR2,CNTBUFPT            BUFFER ADDRESS.                  57966002
         ST    GR2,TOCCWAD             CCW PTR. TO IOB.            2319 58016002
         MVC   0(L8,GR2),TAPECCW5      CCWS TO WRITE CONTROL REC.       58066003
         EXCP  TOIOB                   WRITE CONTROL RECORD.            58766002
         WAIT  ECB=TOECB               NO---AWAIT COMPLETION.           58816002
         CLI   TOECB,GOOD              ALL OK.                          58866002
         BCR   8,GR4                   YES--RETURN.                     58916002
         B     IOTERROR                NO---I/O ERROR          @ZA01201 58966002
         EJECT                                                          62360016
*********************************************************************** 62400016
*                                                                     * 62500016
*   THE FOLLOWING ROUTINE UPDATES THE TRACK ADDRESS AND CHECKS        * 62600016
*   TO SEE IF THIS WAS THE LAST TRACK TO BE DUMPED.  IF NO,THE        * 62700016
*   ROUTINE WILL UPDATE THE EXTENTS IN THE DEB AND RETURN.  IF        * 62800016
*   THIS IS THE LAST TRACK, THE ROUTINE WILL BRANCH TO THE CLOSE      * 62900016
*   OUT ROUTINE.                                                      * 63000016
*                                                                     * 63100016
*   REGISTER 9 POINTS TO THE CORRECT IOBLOCK.                         * 63200016
*   REGISTER 14 IS THE RETURN REGISTER.                               * 63300016
*                                                                     * 63400016
*********************************************************************** 63500016
         USING IOBLOCKS,GR9                                             63700016
         USING CONSTANT,2                                               63800016
UPCCHH   L     GR2,IODEVCON            ADDRESSING FOR DEVICE CONSTANT.  63900016
         L     GR3,CONTROL+8           CURRENT CCHH ADDRESS.            64000016
         CLC   OUTSEEK+6(1),LASTORIG+3   THIS LAST TRACK OF CYLINDER.   64100016
         BC    4,UPCCHH1               NO--                             64200016
         A     GR3,CONVCYL             YES,STEP TO NEXT CYLINDER.       64300016
         AIF   ('&LIB' EQ 'LIB2').X0001                         Y02113  64350000
CK2321   CLI   OUTSEEK+5,X'04'         IS THIS 2321 AND LAST CYLINDER.  64500016
         BC    7,UPCCHH2               NO--RETURN.                      64600016
         AL    GR3,STC2321             INCREMENT STRIP.                 64700016
         CLI   OUTSEEK+4,X'09'         THIS LAST STRIP.                 64800016
         BC    7,UPCCHH2               NO--RETURN.                      64900016
         AL    GR3,SCC2321             INCREMENT SUBCELL.               65000016
.X0001   ANOP                                                   Y02113  65050000
         B     UPCCHH2                 GO STORE VALUE AND RETURN.       65100016
UPCCHH1  AL    GR3,F1                  INCREMENT TO NEXT TRACK.         65300016
UPCCHH2  ST    GR3,CONTROL+8           SAVE NEW VALUE.                  65400016
         CLC   CONTROL+4(4),CONTROL+8    THIS LAST TRACK TO DUMP.       65500016
         BE    FINIS                   YESS--GO TO FINISH UP THE JOB.   65600016
         MVC   OUTSEEK+3(4),CONTROL+8   TRACK ADDRESS TO IOB.           65700016
         MVC   TOSEEK+3(4),CONTROL+8       TRK ADDRESS TO 'TO' IOB.     65800016
         TM    SWITCH,EOV              EOV SWITCH SET FOR PRIMARY 'TO'. 65809016
         BZ    UPCCHH3                 NO--GO CHECK FOR COPIES.         65818016
         NI    SWITCH,X'FD'            SET EOV SWITCH OFF.              65827016
         L     GR1,REELCK              CURRENT TRAILER INFO.            65836016
         SLL   GR1,1                   UPDATE AND                       65845016
         ST    GR1,REELCK                 STORE TRAILER INFO.           65854016
         BAL   GR2,TRAILER             GO TO WRITE TRAILER.             65863016
         BAL   GR4,YESEOV              GO TO FORCE EOV.                 65872016
UPCCHH3  OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                65890016
         BCR   8,GR14                  NO--RETURN TO CALLER.            65899016
         L     GR8,COPYPTR             ADDRESS OF COPY BLOCK.           65908016
         USING COPYBLK,8                                                65917016
UPCCHH4  LA    GR9,CIOBLOCK            I/O BLOCK FOR COPY.              65926016
         MVC   TOSEEK+3(4),CONTROL+8   UPDATE SEARCH ARGUMENT.          65935016
         TM    CERRSW,X'FF'            EOV THIS COPY.                   65944016
         BZ    UPCCHH5                 NO--GO TO SEE IF MORE COPIES.    65953016
         MVI   CERRSW,0                SET COPY EOV SWITCH OFF.         65962016
         L     GR1,CREELCK             CURRENT TRAILER INFO.            65971016
         SLL   GR1,1                   UPDATE AND                       65980016
         ST    GR1,CREELCK                STORE TRAILER INFO.           65989016
         BAL   GR2,TRAILER             GO TO WRITE TRAILER RECORD.      65998016
         BAL   GR4,YESEOV              GO TO EXECUTE EOV.               66007016
UPCCHH5  OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     66025016
         BC    8,UPCCHH6               NO--GO TO RETURN.                66034016
         L     GR8,CCOPYPTR            POINTER TO NEXT COPY.            66043016
         B     UPCCHH4                 GO TO PROCESS THIS COPY.         66052016
UPCCHH6  LA    GR9,BLOCKS              PRIMARY I/O BLOCK.               66061016
         BR    GR14                    RETURN TO CALLER.                66070016
         DROP  2,8                                                      66080016
         EJECT                                                          66090016
FINIS    CLI   DEVSW,X'FF'             DUMPING TO DIRECT ACCESS.        66140016
         BE    FINALR2                 YES--GO TO ENDING THIS    M4513  66240019
*                                       FUNCTION                 M4513  66340019
FINISA   CLI   DEVSW,X'F0'             DUMPING TO SYSOUT.               66624016
         BNE   FINISAA                 NO--MUST BE TO TAPE.             66628016
         DELETE EP=IEHDAOUT            DELETE THE LOAD MODULE.          66632016
         DELETE EP=IEHDPRNT                                             66636016
         B     FINALR2                 GO TO RETURN TO IEHDDUMP.        66640016
FINISAA  L     GR1,REELCK              CURRENT TRAILER RECORD INFO.     66644016
         SLL   GR1,1                   UPDATE AND STORE                 66650016
         LCR   GR1,GR1                 TRAILER INFORMATION              66660016
         BAL   GR2,TRAILER             GO WRITE THE TRAILER RECORD.     66665016
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                66670016
         BZ    FINALR2                 NO--GO TO RETURN TO IEHDDUMP.    66680016
         L     GR3,COPYPTR             ADDRESS FIRST OR ONLY COPY.      66690016
         USING COPYBLK,3                                                66700016
CFINISA  LA    GR9,CIOBLOCK            ADDRESSING FOR THIS COPY BLK.    66710016
         L     GR1,CREELCK             TRAILER RECORD INFORMATION.      66720016
         SLL   GR1,1                   UPDATE AND                       66730016
         LCR   GR1,GR1                 SAVE THIS                        66740016
         BAL   GR2,TRAILER             GO TO WRITE TRAILER RECORD.      66750016
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     66760016
         BZ    FINALR2                 NO--GO TO RETURN TO IEHDDUMP.    66770016
         L     GR3,CCOPYPTR            PTR. TO NEXT COPY.               66780016
         B     CFINISA                 GO TO PROCESS.                   66790016
         DROP  3                                                        66800016
         EJECT                                                          72360016
*********************************************************************** 72400016
*                                                                     * 72500016
*  THIS ROUTINE WILL RECEIVE CONTROL UPON DETECTION OF AN I/O ERROR.  * 72600016
*  SYNADAF(SVC 68) AND ITS ASSOCIATED MACROS WILL BE USED TO          * 72700016
*  DETERMINE THE ERROR CONDITION.                                     * 72800016
*                                                                     * 72900016
*********************************************************************** 73000016
         SPACE                                                          73090016
IOERR    STM   0,15,SAVERR             SAVE REGISTERS              O122 73100019
         LA    GR3,OUTIOB              ADDRESS OF FROM IOB         O122 73110019
         CLI   DEVSW,X'F0'             DUMPING TO SYSOUT           O122 73120019
         BNE   CANTCONT                NO                          O122 73130019
         TM    OUTSTAT+4,X'02'         UNIT CHECK                  O122 73140019
         BNO   CANTCONT                NO                          O122 73150019
         TM    OUTSENSE,X'08'          DATA CHECK                  O122 73160019
         BO    RECOVER                 YES                         O122 73170019
         L     GR4,FUCBPTR             LOAD FROM UCB ADR.      @ZA04427 73172040
         TM    19(GR4),X08             2314?                   @ZA04427 73174040
         BNO   CANTCONT                NO THEN BRANCH          @ZA04427 73176040
         TM    OUTSENSE+1,X'02'        MISSING ADDRESS MARKER      O122 73180019
         BNO   CANTCONT                NO                          O122 73190019
*        SET UP PARAMETERS FOR IEHDRCVR                            O122 73200019
RECOVER  LM    GR4,GR5,DAOUTADR        ADDR OF IEHDAOUT & IEHDPRNT O122 73210019
         LA    GR6,OUTIOB              ADDRESS OF IOB              O122 73220019
*              REGISTERS 10 AND 12 ALREADY CONTAIN ADDRESSES OF    O122 73230019
*              IEHDBLKS AND IEHDWORK                               O122 73240019
         LINK  EP=IEHDRCVR             TRY RECOVER FROM I/O ERROR  O122 73250019
         LTR   GR15,GR15               IS RETURN CODE ZERO         O122 73260019
         BNZ   TESTRETN                NO, TEST FOR FOUR           O122 73270019
         LM    0,15,SAVERR             YES, RESTORE REGISTERS      O122 73280019
         B     PROC4                   RETURN TO PROCESS TRACK  SA67332 73290003
TESTRETN SRL   GR15,3                                              O122 73300019
         LTR   GR15,GR15               IS RETURN CODE FOUR         O122 73310019
         BZ    PROC4                   YES, GO PROCESS NEXT TRACK  O122 73320019
         B     FINALR3                 NO, TERMINATE THE FUNCTION  O122 73330019
SAVERR   DS    16F                     REGISTER SAVE AREA          O122 73340019
         EJECT                                                     O122 73350019
IOTERROR LA    GR9,4(GR9)             ADD TO POINT TO IOB      @ZA01201 73352002
         ST    GR9,IOBPTR              SAVE ACTIVE IOB ADR     @ZA01201 73354002
IOTERR   L     GR3,IOBPTR              LOAD ACTIVE IOB ADR     @ZA01201 73404002
CANTCONT LA    GR1,13                  I/O ERROR MESSAGE           O122 73450019
         BAL   GR4,SETUPMSG            GO TO SET UP THIS MSG.           73540016
         LR    GR1,GR3                 RESTORE POINTER TO IOB.          73630016
         SYNADAF ACSMETH=EXCP,PARM1=(1)                                 73720016
         MVC   MESS+22(78),49(GR1)     SYNADAF MSG TO BUFFER.    SM4350 73810021
         SYNADRLS                                                       73900016
ISUMSG   EQU   *                                                SA53223 73950002
         BAL   GR4,MSGWRT              GO TO PRINT THIS MESSAGE.        74000016
         LA    GR15,8                  SET UP RETURN CODE.              74200016
         B     FINALR3                 RETURN.                          74300016
         EJECT                                                          74400016
SETUPMSG LINK  EP=IEHDMSGB             MOVE MESSAGE TO BUFFER.          74410016
         BR    GR4                     RETURN TO CALLER.                74420016
         SPACE                                                          74430016
MSGWRT   LINK  EP=IEHDPRNT             PRINT THIS MESSAGE.              74440016
         BR    GR4                     RETURN TO CALLER.                74450016
         SPACE                                                          74460016
*                                                                       74500016
*  RETURN TO IEHDDUMP HERE.                                             74600016
*                                                                       74700016
         SPACE                                                          74800016
FINALR2  LA    GR15,0                  SET RETURN CODE.                 74900016
FINALR3  L    GR3,PTRCFUNC             SLOT FOR CURRENT FUNCTION.       75000016
         MVI   0(GR3),COMPLETE         INDICATE IT IS COMPLETE.         75100016
FINAL3   MVI   RDVTOC,X'00'            CLEAR SW                @ZA06532 75150040
         L     GR13,4(GR13)            RESTORE REGISTER 13     @ZA06532 75900040
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN WITH PROPER CODE. 76000016
         EJECT                                                          76100016
         DS    0H                                                       76700016
SIXTEEN  DC    H'16'                                                    76900016
WRTAPE    EQU   X'01'                   WRITE TAPE OP-CODE     NUFORMAT 76950003
TAPMK    EQU   X'80'                                             A21395 77100020
GOOD     EQU   X'7F'                                                    77200016
DC       EQU   X'08'                   USED FOR DATA CHECKING TEST.3651 77230018
CCH      EQU   X'40'                   USED TO CHECK COMMAND CHAIN.3651 77260018
D8       EQU   8                   DISP OF 8                     S20201 77265020
D0       EQU   0                        DISPLACEMENT OF ZERO    SA53223 77267002
L8       EQU   8                        LENGTH CONSTANT         SA53223 77269002
RDCNTVAL EQU   X'00'                    CAUSES IEHDDOIO TO BRCH SA53223 77269402
*                                       TO A LABEL: RDCNTS.     SA53223 77269902
WRTHARO  EQU   X'04'                    CAUSES IEHDDOIO TO BRCH SA53223 77272402
*                                       TO A LABEL: WRTHAR0.    SA53223 77276402
X08      EQU   X'08'                   HEX CONSTANT.             S20201 77277502
RPSFEAT1 EQU   X'04'               RPS ON FROMDD                 S20201 77280002
TICCODE  EQU   X'08'               TIC CCW OP                    S20201 77282502
RPSFEAT  EQU   X'40'               RPS ON TODD                   S20201 77285020
D1       EQU   1                   DISP OF 1                     S20201 77290020
D3       EQU   3                        DISPL. OF 3             Y02113  77292001
D4       EQU   4                        DISPL. OF 4                     77292202
D38      EQU   38                       DISPL. OF 38                    77292402
D58      EQU   58                       DISPL. OF 58                    77292602
D84      EQU   84                       DISPL. OF 84                    77292802
D140     EQU   140                      DISPL. OF 140                   77293002
R1       EQU   1                        RECORD NO OF FMT 4              77293202
R2       EQU   2                        RECORD NO OF FMT 5              77293402
CONTAM   EQU   X'80'                    CONAMINATION BIT                77293602
VTOCERR  EQU   X'40'                    DADSM ERROR BIT                 77293802
L4       EQU   4                        LENGTH OF 4             Y02113  77294001
TIMECHK  EQU   X'01'                    MEANS TIMESTAMP SAVED   Y02113  77296001
CLOCK    EQU   92                       DISPL INTO BUFFER FOR   Y02113  77298001
*                                       TIMESTAMP.              Y02113  77298401
*                                       INTO BUFFER             Y02113  77300002
AREA     DS    1F                      SAVE AREA FOR CCW LENGTH.  0811  77370017
LABEL1   DC    C'MAINTENANCE'           LABEL OF MAINT. AREA    SA53223 77372002
         DC    100F'0'                                                  77372402
LABEL2   DC    C'AREA'                  END OF MAINT. AREA      SA53223 77372802
         DS    0D                                                A37209 77374020
RDVOLBUF DS    CL92                     VOLID BUFFER             A37209 77378020
SRKEY    DC    X'0000000003'            RECORD THREE SEARCH      A37209 77382020
*                                       ARGUMENT                 A37209 77386020
         DS    0H                      HALF WORD ALIGHNMENT      A51474 77396000
ZERO     DC    6X'0'                   TWO BYTES OF ZEROS WILL   A51474 77400000
*                                      ALSO BE USED FROM THE     A51474 77450000
*                                      FOLLOWING CONSTANT.       A51474 77460000
SCC2321  DC    X'00F60000'             INCREMENT TO NEXT SUBCELL.       77470002
STC2321  DC    X'0000FB00'             INCREMENT TO NEXT STRIP.         77480002
F1       DC    F'1'                                                     77500016
         DS    0F                                                S20201 77800020
DAOUTADR DS    1F                      IEHDAOUT ENTRY POINT SAVE AREA.  79100016
PRNTADR  DS    1F                      IEHDPRNT ENTRY POINT SAVE AREA.  79200016
TAPECCW5 CCW   1,0,X'20',24            WRITE TRAILER RECORD.   NUFORMAT 79650003
         SPACE                                                          79700016
SEARIDEQ CCW   X'31',0,X'60',5         SEARCH ID EQUAL ON R0            79800016
         CCW   8,SEARIDEQ,X'60',5      TIC BACK.                        79900016
         CCW   6,0,X'60',8             READ R0 DATA.                    80000016
         CCW   X'9E',0,X'60',X'4000'   READ CKD R1               4074   80100000
*                                      WITH MAXIMUM COUNT               80150000
DUMMYCCW CCW   X'92',0,X'60',8         DUMMY READ COUNT CCW.            80200016
DMMYRCCW CCW   X'1E',0,X'60',0         DUMMY READ COUNT/KEY/DATA CCW    80300016
         SPACE 1                                                        80400016
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      82440016
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              82460016
RDVDATA  CCW   6,0,X'20',140           READ FORMAT 4 DSCB.              82560002
*        CHANNEL PROGRAMS FOR SAVING OLD VOLID                          82570020
SRCHKEYR CCW   X'31',SRKEY,X'60',5      SEARCH ID EQUAL          A37209 82580020
         CCW   8,SRCHKEYR,0,0                                    A37209 82590020
         CCW   X'06',RDVOLBUF,X'20',92  READ IN VOLID            A37209 82600020
SRCHKEYW CCW   X'31',SRKEY,X'60',5      SEARCH ID EQUAL          A37209 82610020
         CCW   8,SRCHKEYW,0,0                                    A37209 82620020
         CCW   X'05',RDVOLBUF,X'20',92  WRITE OUT ORIGINAL VOLID A37209 82630020
TOTAL    DS    F'0'                                              A51474 82632000
EXCPSAVE DS    18F                      SAVE AREA                A37209 82640020
F5DSCB   CAMLST SEEK,F5CCHHR,FRVOL,44  OBTAIN OF F5 DSCB       @ZA01677 82650002
*                                      44 IS USED AS A ADR     @ZA01677 82650402
*                                      OVERWRITTEN AT OBTF5    @ZA01677 82650802
F5CCHHR  DC    5X'0'                   CCHHR OF F5 DSCB        @ZA01677 82652040
FRVOL    DC    6X'0'                   VOLSER OF FROM          @ZA01677 82654040
         DS    0D                                              @ZA01677 82656002
DOUBLE   DC    8X'0'                   CONVERT AREA            @ZA01677 82658002
FOUR     DC    F'4'                                            @ZA01677 82658402
EIGHT    DC    F'8'                                            @ZA01677 82658802
COND     DC    C'COND='                                        @ZA01677 82659202
BADCOND  DS    X'00'                                           @ZA01677 82659602
         SPACE                                                          82660016
* THIS IS USED TO WRITE HA, R0, R1 ONLY.                                82760016
R0CCWS   DSECT                                                          82900016
*   USED WHEN MODIFYING HA, R0 CCWS FOR EXECUTION.                      83000016
SEARCHR0 DS    2F                                                       83100016
TICBACK  DS    2F                                                       83200016
WRITER0  DS    2F                                                       83300016
SEARCH1  DS    2F                                                       83400016
TICAGAIN DS    2F                                                       83500016
READR0   DS    2F                                                       83600016
ERASEALL DS    2F                                                       83700016
READREC0 DS    2F                                                       83800016
         SPACE                                                          83900016
CCWS     DSECT                                                          84000016
SEIDEQR0 DS    CL8                                                      84100016
TICBACKA DS    CL8                                                      84200016
RDWRDATA DS    CL8                                                      84300016
RDWRTCKD DS    CL8                                                      84400016
RDWRTCNT DS    CL8                                                      84500016
         SPACE                                                          84502002
F5BUF    DSECT                         F5 DSCB                 @ZA01677 84510002
         DS    CL84                    WORK AREA               @ZA01677 84520002
DS5KEYID DS    CL4                     05050505                @ZA01677 84530002
DS5AVEX1 DS    CL5                     FIRST AVE EXTENT        @ZA01677 84540002
DS5AVEX2 DS    CL35                    7 MORE AVE EXTENT       @ZA01677 84542002
DS5FMTID DS    CL1                     FORMAT 5 ID(F5)         @ZA01677 84544002
DS5AVEX3 DS    CL90                    18 MORE AVE EXTENT      @ZA01677 84546002
DS5PTRDS DS    CL5                     PTR TO NXT F5 DSCB      @ZA01677 84548002
         EJECT                                                          84550016
         IEHDWORK                                                       84600016
         EJECT                                                          84700016
IOBLOCKS DSECT                                                          84800016
* DUMP 'TO' ECB.                                                        84900016
TOECB    DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   85000016
* DUMP 'TO' IOB.                                                        85100016
TOIOB    DS    0F                                                       85200016
TOFLGS   DS    CL2                     FLAGS ONE AND TWO.               85300016
TOSENSE  DS    CL2                     SENSE BYTES.                     85400016
TOECBAD  DS    1F                      ECB ADDRESS.                     85500016
TOSTATUS DS    2F                      CHANNEL STATUS.                  85600016
TOCCWAD  DS    1F                      CCW LIST ADDRESS.                85700016
TODCBAD  DS    1F                      DCB ADDRESS.                     85800016
TORESAD  DS    1F                      RESTART ADDRESS.                 85900016
TOBLKCNT DS    CL2                     BLOCK COUNT INCREMENT.           86000016
TOERROR  DS    CL2                     ERROR COUNT.                     86100016
TOSEEK   DS    2F                      MBBCCHHR.                        86200016
* DUMP 'TO' DCB.                                                        86300016
TODCB    DS    13F                     DCB.                             86400016
         DS    0D                      FOR DOUBLE WORD ALIGNMENT.       86500016
TAPECCW2 DS    1D                      USED TO PUT OUT CCW RECORD       86600016
*                                        AND DATA ON TAPE.              86700016
TAPECCW3 DS    2D                      WRITE HA,R0 CCWS ON TAPE.        86800016
TAPECCW4 DS    2D                      WRITE HA,R0,R1 CCWS ON TAPE.     86900016
         DS    0D                      FOR DOUBLE WORD ALIGNMENT.       87000016
* DUMP 'FROM' ECB.                                                      87100016
OUTECB   DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   87200016
* DUMP 'FROM' IOB.                                                      87300016
OUTIOB   DS    0F                                                       87400016
OUTFLG   DS    CL2                     FLAGS ONE AND TWO.               87500016
OUTSENSE DS    CL2                     SENSE BYTES.                     87600016
OUTECBAD DS    1F                      ECB ADDRESS.                     87700016
OUTSTAT  DS    2F                      CHANNEL STATUS.                  87800016
OUTCCWAD DS    1F                      CCW LIST ADDRESS.                87900016
OUTDCBAD DS    1F                      DCB ADDRESS.                     88000016
OUTRESAD DS    1F                      RESTART ADDRESS.                 88100016
OUTBLKCT DS    CL2                     BLOCK COUNT INCREMENT.           88200016
OUTERROR DS    CL2                     ERROR COUNT.                     88300016
OUTSEEK  DS    2F                      7BBCCHHR.                        88400016
CCHH     EQU   OUTSEEK+3               CYLINDER/HEAD ADDRESS.           88500016
R        EQU   OUTSEEK+7               RECORD NUMBER.                   88600016
* DUMP 'FROM' DCB.                                                      88700016
OUTDCB   DS    18F                     DCB.                             88800016
         SPACE                                                          89100016
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           89200016
DBSIZE   EQU   IOBLKEND-IOBLOCKS       SIZE OF IOBLOCKS DSECT.          89300016
         EJECT                                                          89350016
         SPACE 1                                                        89400016
         IEHDBLKS                                                       89500016
         EJECT                                                          89600016
         SPACE 2                                                        90600016
         SPACE                                                          90700016
RBUFFER  DSECT                                                          90800016
ZERO1    DS    CL8                     WILL CONTAIN 8 BYTES OF ZEROS.   90900016
CCWBUFF  EQU   ZERO1                                                    91000016
TICSW    DS    CL1                     'FF' INDICATES PREVIOUS CCW=TIC. 91100016
         DS    CL3                     NOT USED.                        91200016
ADDRESS  DS    CL4                     TEMPORARY ADDRESS HOLDER.        91300016
SEEKCCW  DS    CL8                     SEEK CCW FOR STAND-ALONE.        91400016
SETMASK  DS    CL8                     SET FILE MASK FOR STAND-ALONE.   91500016
SEARIDE  DS    CL8                     SEARCH EQUAL ID CCW.             91600016
         EJECT                                                          91700016
CVT      DSECT                                                          91800016
         CVT   SYS=MIN                                                  91900016
         EJECT                                                          92000016
UCB      DSECT                                                          92100016
         IEFUCBOB                                                       92200016
         EJECT                                                          92300016
JFCB     DSECT                                                          92400016
         IEFJFCBN                                                       92500016
         EJECT                                                          92600016
         DCBD  DSORG=PS                                                 92700016
         END                                                            92800016
./  ADD  SSI=80130039,NAME=IEHDGETA
         TITLE 'IEHDGETA - PERFORMS GETALT FUNCTION  IEHDASDR UTILITY'  00302421
         COPY  LCGASMSW                                                 00304021
IEHDGETA CSECT                                                          00310000
**********************************************************************  00311099
*                                                                       00312099
*                        FIXES THIS MODULE                              00313099
*                        LATEST FIRST.                                  00314099
*                                                                       00315099
**********************************************************************  00316099
*                                                                       00317099
*D 66000                               ONLY SU32               @ZA25515 00317599
*C 115000                              ONLY SU32               @ZA25515 00318099
*A 103500-104000                       ONLY SU32               @ZA25515 00318299
*A 255105-255108,886500                ONLY SU32               @ZA25515 00318499
*                                                                       00319099
*                                                                     * 00320016
*                    VS2-3 SU32                                @G32DSPD 00320132
*                                                              @G32DSPD 00321132
*        RELEASE 23 DELETIONS                                         * 00324020
*        RELEASE 22 DELETIONS                                         * 00328020
*        RELEASE 21 DELETIONS                                         * 00332020
*                                                                A49434 00334000
*        RELEASE 20 DELETIONS                                         * 00336020
*1145348000                                                      A35813 00337020
*1145                                                            S20201 00338020
*1145162000,177000                                               S20201 00343020
*D 300000,383000                                               @Z30RSAG 00345032
*C 300500,446500,405800                                        @Z30RSAG 00347032
*A 166820,271100-380,337500-867,373000-378000                  @Z30RSAG 00347432
*A 447600,700,483500,600                                       @Z30RSAG 00347832
*STATUS CHANGE LEVEL 003                                                00348020
*                                                                     * 00360016
**********************************************************************  00366099
      EJECT                                                             00372099
*FUNCTION/OPERATION- THIS ROUTINE HANDLES THE -GETALT- FUNCTION       * 00380016
*   OF THE IEHDASDR SYSTEM UTILITY PROGRAM. GETALT IS USED TO         * 00400016
*   ASSIGN ALTERNATE TRACKS FOR DEFECTIVE OR QUESTIONABLE TRACKS      * 00420016
*   ON DISK OR DATA CELL VOLUMES. THE TRACKS SPECIFIED ON THE GETALT  * 00440016
*   CONTROL CARD WILL HAVE THE NEXT AVAILABLE ALTERNATE TRACK         * 00460016
*   ASSIGNED. THIS FUNCTION IS EXECUTED IN AN SVC ROUTINE.            * 00480016
*   RACF AUTHORIZATION IS REQUIRED FOR RACF DEFINED VOLUMES.   @G32DSPD 00490032
*                                                                     * 00500016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDGETA- AND CONTROL IS      * 00520016
*   ALWAYS RECEIVED FROM THE MONITOR MODULE IEHDASDS.                 * 00540016
*                                                                     * 00560016
*INPUT- POINTERS TO A WORKAREA(REGISTER12) AND TO A CONTROL BLOCK     * 00580016
*   (REGISTER 10).                                                    * 00600016
*   DATA IS ON A DIRECT ACCESS DEVICE OTHER THAN A DRUM DEVICE        * 00620016
*                                                                     * 00640016
*EXITS- NORMAL- A SUCCESSFUL GETALT OPERATION RESULTS IN A RETURN     * 00660016
*   TO THE MONITOR (IEHDASDS) WITH A RETURN CODE OF 0. A GETALT       * 00680016
*   COMPLETE MESSAGE IS PLACED IN THE MESSAGE DATA SET.               * 00700016
*                                                                     * 00720016
*EXITS- ERROR- ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROPRIATE   * 00740016
*   MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER THAN       * 00760016
*   ZERO WILL BE PASSED BACK TO THE MONITOR.                          * 00780016
*                                                                     * 00790016
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS ENTERED FROM               * 00800016
*   THE MONITOR MODULE IEHDASDS. FOUR OTHER CSECTS ARE USED BY        * 00820016
*   THIS ROUTINE. MESSAGES ISSUED WILL BE FORMULATED BY THE MESSAGE   * 00840016
*   ROUTINE(IEHDMSGB) AND PRINTED BY THE PRINT ROUTINE                * 00860016
*   (IEHDPRNT). THE END OF EXTENT APPENDAGE(IGG019P8) HANDLES         * 00880016
*   THE LIMITS AND EXTENTS IN THE DEB FOR ALL DA DEVICES INVOLVED     * 00900016
*   THE SVC ROUTINE(IGC0008B) HANDLES THE ACTUAL ASSIGNMENT OF AN     * 00920016
*   ALTERNATE TRACK.                                                  * 00940016
*                                                                     * 00960016
*TABLES/WORK AREAS- UPON ENTRY REGISTERS 10 AND 12 POINT TO A         * 00980016
*   FUNCTION BLOCK AND A WORKAREA RESPECTIVELY. THEY ARE DESCRIBED    * 01000016
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 01020016
*                                                                     * 01040016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE.                          * 01060016
*                                                                     * 01080016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             01500016
GR0      EQU   0                                                        01800016
GR1      EQU   1                                                        02100016
GR2      EQU   2                                                        02400016
GR3      EQU   3                                                        02700016
GR4      EQU   4                                                        03000016
GR5      EQU   5                                                        03300016
GR6      EQU   6                                                        03600016
GR7      EQU   7                                                        03900016
GR8      EQU   8                                                        04200016
GR9      EQU   9                                                        04500016
GR10     EQU   10                                                       04800016
GR11     EQU   11                                                       05100016
GR12     EQU   12                                                       05400016
GR13     EQU   13                                                       05700016
GR14     EQU   14                                                       06000016
GR15     EQU   15                                                       06300016
UCBPTR   EQU   9                                                        06900016
BASEREG  EQU   11                                                       07200016
WORKBASE EQU   12                                                       07500016
         USING FUNCBLK,10                                               07800016
         USING IEHDGETA,BASEREG                                         08100016
         USING WORK,12                                                  08400016
         SAVE  (14,12),T,*             SAVE THE REGISTERS               08700016
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          09000016
         LA    GR7,GETASAVE            SAVE AREA ADDRESS                09300016
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      09600016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      09900016
         LR    GR13,GR7                LOAD SAVE AREA ADDRESS.          10200016
         SR    GR8,GR8                 INITIALIZE REGISTER TO ZERO.     10300016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA25515 10350099
         DC    C'SU32 OZ25515'         LAST FIX THIS MODULE    @ZA25515 10400099
**********************************************************************  10500016
*        DETERMINE DEVICE TYPE AND SET UP POINTER TO THE  PROPER      * 10800016
*        DEVICE CONSTANTS FOR THIS DEVICE.                            * 11100016
**********************************************************************  11400016
APARNO   L     GR7,RDDCBAD             POINTER TO DCB          @ZA25515 11500099
         USING IHADCB,7                                                 11600016
         L     UCBPTR,TUCBPTR          PICK UP POINTER TO UCB           11700016
         USING UCB,9                                                    12000016
         AIF    ('&LIB' EQ 'LIB2').X225600                      XL03145 12050003
         CLI   UCBID,X'FF'             IS THIS MAIN UCB                 12100016
         BNE   IS2321                  NO-MUST BE 2321                  12200016
.X225600 ANOP                                                   XL03145 12250003
         TM    UCBTBYT3,UCB3DACC       IS THIS A DIRECT ACCESS DEVICE.  12300016
         BZ    BADPARM                 NO--MUST BE BAD PARAMETER.       12600016
         AIF   ('&LIB' NE 'LIB1').X301600                       XL03912 12650003
         CLI   UCBTBYT4,ZEUS1      IS IT 2305-1                  S20201 12660020
         BE    GOODEV              YES IT IS                     S20201 12720020
         CLI   UCBTBYT4,ZEUS2      NO IS IT 2305-2               S20201 12780020
         BE    GOODEV              YEH                           S20201 12840020
         TM    UCBTBYT4,X'02'          IS THIS DRUM DEVICE              12900016
         BO    DRUMDEV                 YES - CANNOT HANDLE DEVICE       13200016
GOODEV   EQU   *                                                 S20201 13250020
.X301600 ANOP                                                   XL03912 13260003
         TM    SRTESTAT,SRTESYSR       THIS A SYSTEMS RESIDENCE VOLUME  13300016
         BO    SYSRES                  YES-NOT ALLOWED                  13400016
         SR    GR3,GR3                                                  13500016
         IC    GR3,UCBTBYT4            UCB DEVICE TYPE CODE             13800016
         AIF   ('&LIB' EQ 'LIB1').X227600                       XL03130 13850003
         CLI   UCBTBYT4,WIN             IS THIS A 3340?         XL03130 13900003
         BNE   GETCON                   NO, GET DEVICE CONSTANT.XL03130 13950003
         IC    GR3,ODEVMOD              YES, USE DEV MOD NO.    XL03130 14000003
GETCON   EQU   *                                                XL03130 14050003
.X227600 ANOP                                                   XL03130 14060003
         LA    GR5,KDEVSIZE            SIZE OF EACH DEVICE ENTRY        14100016
         BCTR  GR3,0                   DECREMENT FOR PROPER INDEX       14400016
         MR    GR4,GR3                 ENTRY SIZE TIMES INDEX VALUE     14700016
         L     GR4,IODEVCON            BEGIN ADDRESS OF DEVICE CONSTANT 15000016
         AR    GR4,GR5                 ADDRESS OF CONSTANTS THIS DEVICE 15300016
         ST    GR4,IODEVCON            SAVE IN FUNCTION BLOCK           15600016
         AIF   ('&LIB' EQ 'LIB2').X225601                       XL03145 15900003
         B     SKIP                                                     16260016
IS2321   LA    GR3,4                   INDEX FOR 2321                   16320016
         LA    GR5,KDEVSIZE            SIZE OF EACH DEVICE ENTRY        16380016
         MR    GR4,GR3                 ENTRY SIZE TIMES INDEX VALUE     16440016
         L     GR4,IODEVCON            BEGIN ADDRESS OF DEVICE CONSTANT 16500016
         AR    GR4,GR5                 ADDRESS OF CONSTANTS THIS DEVICE 16560016
         ST    GR4,IODEVCON            SAVE IN FUNCTION BLOCK           16620016
.X225601 ANOP                                                   XL03145 16650003
SKIP     L     GR2,IODEVCON                                             16680016
         MVC   IODEVCON(1),UCBTBYT4    SAVE UCB DEVICE TYPE    @Z30RSAG 16682032
         CLI   UCBTBYT4,ZEUS1          IS ITB2305                S20201 16690020
         BE    ZEUSCMPR                YES - CHK ALTS DIFFERENT  S20201 16700020
         CLI   UCBTBYT4,ZEUS2          IS IT A 2305              S20201 16710020
         BE    ZEUSCMPR                YES - CHK ALTS DIFFERENT  S20201 16720020
         AIF   ('&LIB' EQ 'LIB1').X227913                       XL03912 16720303
         CLI   UCBTBYT4,K2314          IS THIS 2314             XL03145 16720603
         BE    CHKCYL1                 YES, CHECK CCHH          XL03145 16720903
         AGO   .X227914                                         XL03912 16721203
.X227913 ANOP                                                   XL03912 16721503
         CLI   UCBTBYT4,MERLN          IS THIS 3330              A49434 16722000
         BNE   CHKCYL1                  NO                       X99204 16724000
.X227914 ANOP                                                   XL03912 16726003
CKLAST   EQU   *                        MERLIN                   X99204 16729200
         USING CONSTANT,2                                               16740016
         CLC   GTRACK(2),LASTALT       IS VALID TRACK SPECIFIED  A49434 16750000
         BH    TRKINVLD                NO, GO SET RTN CODE       A49434 16760003
         B     CHKHD1                  CONTINUE CHECKING         A49434 16770000
CHKCYL1  EQU   *                       CHECK CCHH                A49434 16790000
         CLC   GTRACK(1),LASTALT       IS TRACK SPECIFIED A             16870016
         BH    TRKINVLD                  VALID TRACK.                   16940016
         CLC   GTRACK+1(1),LASTALT+1                                    17010016
         BH    TRKINVLD                                                 17080016
CHKHD1   EQU   *                       CONTINUE 3330 CHECKING    A49434 17130000
         CLC   GTRACK+2(1),LASTALT+2                                    17150016
         BH    TRKINVLD                                                 17220016
         CLC   GTRACK+3(1),LASTALT+3                                    17290016
         BH    TRKINVLD                INVALID TRACK                    17400016
         B     AFTZEUS                 GO AROUND ZEUS  CODE      S20201 17460020
ZEUSCMPR CLC   GTRACK(2),LASTALT       OVER LAST ALT             S20201 17520020
         BNL   TRKINVLD                YES - INVALID TRACK       S20201 17580020
         CLC   GTRACK+2(1),LASTALT+2   CHK THIRD BYTE            S20201 17640020
         BH    TRKINVLD                YES - INVALID TRACK       S20201 17700020
         CLI   GTRACK+3,X'07'           TRACK TOO BIG            S20201 17760020
         BH    TRKINVLD                YES - INVALID TRACK       S20201 17820020
AFTZEUS  EQU   *                                                 S20201 17940020
         MVC   REQUEST+VOL(L6),SRTEVOLI  SET VOLID TO MSG.      YL02912 17990002
         DROP  GR9                                              YL02912 17992002
         L     GR9,CVTPTR               GET ADDRESS OF CVT.     YL02912 17994002
         USING CVT,GR9                                          YL02912 17996002
         L     GR9,CVTTCBP              GET PTR TO TCB ADDRESS. YL02912 17998002
         L     GR9,D4(GR9)              GET TCB ADDRESS.        YL02912 17998402
         L     GR9,D12(GR9)             GET TIOT ADDRESS.       YL02912 17998802
         MVC   REQUEST+JJJ(L8),D0(GR9)  SET JOB NAME TO MSG.    YL02912 17999202
         MVC   REQUEST+SSS(L8),D8(GR9)  SET STEP NAME TO MSG.   YL02912 17999602
REQUEST  WTOR  'IEH846D CONFIRM REQUEST TO ASSIGN ALTERNATES ON VOLID= *17999702
                    .JJJJJJJJ,SSSSSSSS.',REPLY,1,WTORECB,ROUTCDE=(4),  *17999802
               DESC=(2)                                         YL02912 18024902
         TM    WTORECB,COMPLETE         IS OPERATION COMPLETE?  YL02912 18037402
         BO    TESTANSW                 YES,GO CHECK ANSWER.    YL02912 18049902
         WAIT  ECB=WTORECB              NO, AWAIT COMPLETION.   YL02912 18059902
TESTANSW MVI   WTORECB,ZERO             CLEAR ECB POST BITS.    YL02912 18069902
         CLI   REPLY,C'U'               REPLY EQUAL 'U'?        YL02912 18079902
         BE    USE                      YES, CONTINUE LABEL.    YL02912 18089902
         CLI   REPLY,C'T'               REPLY EQUAL 'T'?        YL02912 18091902
         BE    TERM                     YES, TERMINATE.         YL02912 18093902
         MVC   ERRANS+ERJJ(L8),D0(GR9)  SET JOB NAME TO MSG.    YL02912 18095902
         MVC   ERRANS+ERSS(L8),D8(GR9)  SET STEP NAME TO MSG.   YL02912 18097902
ERRANS   WTO   'IEH808I REPLY IN ERROR. REPLY WITH  U  OR  T , JJJJJJJJ*18098302
               ,SSSSSSSS.',ROUTCDE=(4),DESC=(5)                 YL02912 18098702
         B     REQUEST                  GO WRITE REQUEST AGAIN. YL02912 18099102
         DROP  GR9                                              YL02912 18099502
USE      EQU  *                                                 YL02912 18099602
         EJECT                                                          18099702
*********************************************************************** 18099902
*                                                                     * 18300016
*  THIS ROUTINE OPENS THE DATA CONTROL BLOCKS FOR ALL DIRECT ACCESS   * 18600016
*     DEVICES INVOLVED. THE OPEN IS ALWAYS PERFORMED ON THE FORMAT    * 18900016
*     FOUR DSCB OF THE VTOC.                                          * 19200016
*                                                                     * 19500016
*********************************************************************** 19800016
         MVC   DCBDDNAM(8),DDNAME2     PUT DDNAME IN DCB                20700016
         MVC   OPENLD+1(3),RDDCBAD+1   MOVE DCB ADDRESS TO LIST         21000016
OPENJ    LA    GR9,GETAREA             BUFFER ADDRESS TO READ JFCB      21300016
         ST    GR9,LIST                                                 21600016
         MVI   LIST,X'87'              EXIT LIST CODE                   21900016
         RDJFCB MF=(E,OPENLD)                                           22200016
         USING JFCB,9                                                   22500016
         MVI   JFCBDSNM,X'04'          SET DSNAME FIELD FOR             22800016
         MVC   JFCBDSNM+1(43),JFCBDSNM   FORMAT 4 DSCB.                 23100016
         MVI   JFCBTSDM,X'08'          STOP WRITE OF JFCB AT OPEN       23400016
         OPEN  MF=(E,OPENLD),TYPE=J                                     23700016
         TM    DCBOFLGS,X'10'          WAS THERE A SUCCESSFUL OPEN.     24000016
         BZ    NOOPEN                  NO--GIVE AN ERROR MESSAGE        24300016
         NI    DCBMACRF+1,X'F3'        SET BITS OFF TO PREVENT CLOSE    24600016
*                                        FROM WRITING AN EOF RECORD     24900016
*                                        AND UPDATING THE DSCB.         25200016
         ST    GR10,DCBIOBAD           FUNCTION BLOCK ADDRESS IN DCB    25500016
         SPACE 2                                                        25500832
*********************************************************************** 25501632
*       THIS SECTION OF CODE PERFORMS RACF AUTHORIZATION CHECKS. THE  * 25502432
*  USER MUST HAVE ALTER AUTHORIZATION TO GET AN ALTERNATE TRACK. IF   * 25503232
*  HE DOES NOT, THE OPERATION WILL NOT BE ALLOWED. IF RACF IS NOT     * 25504032
*  ACTIVE IN THE SYSTEM RACF CHECKING WILL NOT BE PERFORMED.          * 25504832
*********************************************************************** 25505632
         L     GR5,CVTPTR              GET CVT POINTER         @G32DSPD 25506432
         USING CVT,GR5                                         @G32DSPD 25507232
         L     GR5,CVTRAC              GET RACF POINTER        @G32DSPD 25508032
         DROP  GR5                                             @G32DSPD 25508832
         LTR   GR5,GR5                 TEST THE RACF POINTER   @G32DSPD 25509632
         BZ    NULLRACF                NOT ACTIVE IF PTR NULL  @G32DSPD 25510432
         USING RCVT,GR5                GO END SEE IF RACF IS   @ZA25515 25510599
         TM    RCVTSTA1,RCVTDASD       CURRENT.                @ZA25515 25510699
         BZ    NULLRACF                NO IT WAS NOT.          @ZA25515 25511099
         DROP  GR5                                             @ZA25515 25511199
         L     GR5,TUCBPTR             GET UCB POINTER         @G32DSPD 25511232
         USING UCB,GR5                                         @G32DSPD 25512032
         MVC   RACVOL,UCBVOLI          SET VOLID FOR RACHECK   @G32DSPD 25512832
         DROP  GR5                                             @G32DSPD 25513632
         RACHECK ATTR=ALTER,ENTITY=RACVOL,CLASS='DASDVOL'      @G32DSPD 25514432
         CLM   GR15,B'0001',RC8        RC 8=UNAUTHORIZED       @G32DSPD 25515232
         BE    UNAUTH                  RC 8,GO TERMINATE       @G32DSPD 25516032
NULLRACF EQU   *                       RACF NOT ACTIVE,OR      @G32DSPD 25516832
*                                      VOL ID NOT RACF DEFINED,@G32DSPD 25517632
*                                      OR RACF AUTHORIZED.     @G32DSPD 25518432
        SPACE 2                                                         25519232
*********************************************************************** 25520016
*                                                                     * 25540016
*  THIS ROUTINE DETERMINES IF THE ALTERNATE TRACK REQUEST IS A VALID  * 25560016
*     ONE. IF SO, SVC 82 IS ISSUED TO ASSIGN AN ALTERNATE TRACK FOR   * 25580016
*     THE ONE SPECIFIED AS BAD. THE SVC ROUTINE PASSES BACK A RETURN  * 25600016
*     CODE WHICH IS CHECKED AND A MESSAGE IS WRITTEN DESCRIBING EITHER* 25620016
*     THE ALTERNATE TRACK OR THE ERROR CONDITION WHICH PREVENTED THE  * 25640016
*     ASSIGNMENT OF A TRACK.                                          * 25660016
*                                                                     * 25680016
*********************************************************************** 25700016
         CLC   GTRACK(4),TRKZERO       IS BAD TRACK ZERO                25800016
         BE    TRKINVLD                YES - INVALID REQUEST            26100016
         L     GR6,DCBDEBAD            PICK UP DEB ADDRESS              26400016
         CLC   GTRACK(4),38(GR6)       IS BAD TRACK VTOC                26700016
         BE    TRKINVLD                FIRST TRACK OF VTOC INVALID      26800016
         BH    COMPAR2                 GO CHECK FOR REST OF VTOC        26900016
ASSIGN   MVC   PARMLIST+1(3),TUCBPTR+1  PICK UP UCB POINTER             27000016
         MVC   PARMLIST+4(4),GTRACK    PUT BAD TRACK ADDRESS IN LIST    27100016
         CLI   IODEVCON,D3350          IS IT 3350 ?            @Z30RSAG 27110032
         BNE   NOMAD                   NO, SKIP THIS           @Z30RSAG 27120032
         LH    GR5,DATASIZE                                    @Z30RSAG 27130032
         GETMAIN R,LV=(GR5)                                    @Z30RSAG 27132032
         ST    GR1,DATAREA                                     @Z30RSAG 27134032
         ST    GR1,BUFFADR             STORE ADDR AWAY         @Z30RSAG 27134432
         BAL   GR1,FILLBUFF            GO FILL BUFFER          @Z30RSAG 27136032
NOMAD    EQU   *                                               @Z30RSAG 27138032
         AIF   ('&LIB' EQ 'LIB1').X228305                       XL03130 27140003
         LA    GR1,ODEVMOD              GET DEV MOD NO. PTR.    XL03130 27180003
         ST    GR1,PARMLIST+12          PUT PTR INTO PARM LIST. XL03130 27220003
.X228305 ANOP                                                   XL03130 27260003
         LA    GR1,31                  DESCRIBE DEFECTIVE TRACK.        27300016
         LA    GR5,NEXTONE             SET UP FOR BRANCH AFTER PRINT    27350016
MSGLINK  BAL   GR4,MSGBLD              GO SET UP MESSAGE                27400016
         UNPK  GTRACK(9),PARMLIST+4(5) PUT TRACK ADDRESS IN PRINTABLES  27450016
         TR    GTRACK(8),TTABLE-240                                     27500016
         MVC   13(8,GR1),GTRACK        PUT TRACK ADDRESS IN MESSAGE     27550016
MOVENAME MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            27600016
         B     MSGPRNT                 GO PRINT MESSAGE                 27650016
         DROP  9                                                        27720016
NEXTONE  LA    GR1,PARMLIST            PICK UP PARAMETER LIST ADDRESS   27920016
         SVC   ALTER                   ASSIGN ALTERNATE TRACK           28620016
         B     *+4(15)                 BRANCHING TABLE FOR RETURN CODES 29400016
         B     GOODRTN                 GOOD RETURN                      29700016
         NOP   *                       CONDITION CODE 4        @Z30RSAG 30000032
         B     MSG23                      NOT APPLICABLE       @Z30RSAG 30050032
         B     IOERR                   I/O ERROR                        30600016
         B     NOMORE                  NO MORE TRACKS AVAILABLE         30900016
GOODRTN  L     GR0,PARMLIST+4          PICK UP ALTERNATE TRK ADDRESS    31100016
         LA    GR1,32                  DESCRIBE ALTERNATE TRACK         31300016
         LA    GR5,NEXT                SET UP FOR BRANCK AFTER PRINT    31500016
         LTR   GR0,GR0                 WAS ALTERNATE TRK ASSIGNED       31700016
         BNE   MSGLINK                 YES-GO INDICATE NEW TRACK        31900016
         LA    GR4,MOVENAME            NO-SET UP FOR BRANCH AFTER MSG   32100016
         B     MSGBLD                  GO INDICATE NO ALTERNATE TRK     32300016
NEXT     EX    GR8,SWITCH1                                              32500016
         LA    GR1,6                   OPERATION COMPLETED SUCCESSFULLY 32700016
         L     UCBPTR,TUCBPTR          PICK UP POINTER TO UCB           33340016
         USING UCB,9                                                    33380016
         BAL   GR4,MSGBLD              GO SET UP MESSAGE                33420016
         MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            33460016
         AIF   ('&LIB' EQ 'LIB2').X225602                       XL03145 33465003
         CLI   UCBID,X'FF'             IS THIS A 2321.                  33470016
         BNE   YES2321                 YES-GO HANDLE.                   33480016
.X225602 ANOP                                                   XL03145 33490003
         MVC   40(6,GR1),SRTEVOLI      PUT VOL/SER NO IN MESSAGE        33500016
SETMSG   MVC   MESS+8(10),MODNAME      PUT FUNCTION NAME IN MESSAGE.    33540016
         BAL   GR5,MSGPRNT             GO PRINT MESSAGE                 33580016
         LA    GR15,0                  SET UP RETURN CODE/SUCCESSFUL    33620016
         L     GR3,PTRCFUNC            PICK UP POINTER TO CURRENT FUNC. 33660016
         MVI   0(GR3),COMPLETE         SET COMPLETE BIT FOR FUNCTION.   33700016
         B     CLOSEUP                                                  33740016
************************************************************   @Z30RSAG 33750032
*                                                          *   @Z30RSAG 33760032
*        THIS ROUTINE FILLS THE DATA BUFFER                *   @Z30RSAG 33770032
*                                                          *   @Z30RSAG 33772032
************************************************************   @Z30RSAG 33774032
FILLBUFF EQU   *                                               @Z30RSAG 33776032
         L     GR4,DATAREA             POINT TO BUFFER         @Z30RSAG 33778032
         LH    GR5,DATASIZE            LENGTH OF BUFFER        @Z30RSAG 33778432
         AR    GR5,GR4                 POINT TO END OF BUFFER  @Z30RSAG 33778832
         SH    GR5,EIGHT                                       @Z30RSAG 33779232
MOVEIT   EQU   *                                               @Z30RSAG 33779632
         MVC   0(L8,GR4),BITPAT        MOVE BIT PATTERN        @Z30RSAG 33779732
         LA    GR4,L8(GR4)                                     @Z30RSAG 33779832
         CR    GR4,GR5                 IS END ?                @Z30RSAG 33779932
         EJECT                                                          33782002
         BL    MOVEIT                  LOOP IF NO              @Z30RSAG 33783232
         BR    GR1                     RETURN WHEN FINISHED    @Z30RSAG 33785232
         DROP  9                                                        33786732
*********************************************************************** 33790016
*                                                                     * 33800016
*  THIS SECTION WRITES OUT MESSAGES, SETS RETURN CODES AND RETURNS    * 33810016
*     CONTROL.                                                          33820016
*                                                                     * 33830016
*********************************************************************** 33840016
BADPARM  LA    GR1,10                  IS NOT DIRECT ACCESS             33900016
         B     MSG1                                                     34200016
         AIF  ('&LIB' NE 'LIB1').X301201                        XL03145 34250003
DRUMDEV  LA    GR1,23                  IS DRUM DEVICE                   34500016
         B     MSG2                     GO SET UP MESSAGE        A35813 34800020
.X301201 ANOP                                                   XL03145 34850003
NOOPEN   LA    GR1,5                   UNSUCCESSFUL OPEN                35100016
         B     MSG1                                                     35400016
COMPAR2  CLC   GTRACK(4),42(GR6)       IS BAD TRACK PART OF VTOC        35700016
         BH    ASSIGN                  OK TO ASSIGN ALTERNATE           36000016
         LA    GR8,X'F0'               SET SWITCH TO WRITE WARNING      36030016
         B     ASSIGN                    MESSAGE AFTER TRACK ASSIGNMENT 36060016
UNUSABLE LA    GR1,30                  BAD TRACK IS PART OF VGOC OR     36100016
*                                        IS TRACK ZERO.                 36200016
*                                        WRITING MESSAGE.               36400016
         B     MSG1                    GO WRITE MESSAGE                 36600016
TRKINVLD LA    GR1,22                  INVALID TRACK ADDRESS            36900016
         B     MSG1                    GO WRITE MESSAGE                 37200016
*  RACF AUTHORIZATION ERROR                                             37207032
UNAUTH   LA    GR1,MSG66I              SET FOR IEH866I MSG     @G32DSPD 37214032
         BAL   GR4,MSGBLD              GET MESSAGE TEXT        @G32DSPD 37221032
         MVC   0(L'GETALTNM,GR1),GETALTNM    TE GETALT         @G32DSPD 37228032
         MVC   18(8,GR1),DDNAME2       SET DDNAME              @G32DSPD 37235032
         B     PRNTM                   GO PRINT ERROR MSG      @G32DSPD 37242032
MSG23    EQU   *                                               @Z30RSAG 37250032
         LA    GR1,23                                          @Z30RSAG 37300032
         BAL   GR4,MSGBLD                                      @Z30RSAG 37350032
         MVC   0(L8,GR1),GTRACK        MOVE TRACK NO. TO MSG.  @Z30RSAG 37400032
         B     PRNTM                                           @Z30RSAG 37450032
FREEMN   EQU   *                                               @Z30RSAG 37500032
         CLI   IODEVCON,D3350          IS IT 3350 ?            @Z30RSAG 37550032
         BNER  GR5                     NO, SKIP FOLLOWING      @Z30RSAG 37600032
         L     GR4,BUFFADR             POINT TO BUFFER         @VS40034 37650032
         LTR   GR4,GR4                 ZERO PTR ?              @VS40034 37660032
         BZR   GR5                     YES, EXIT               @VS40034 37670032
         LH    GR6,DATASIZE            GET LENGTH BUFFER       @Z30RSAG 37700032
         FREEMAIN R,LV=(GR6),A=(GR4)   FREE IT                 @Z30RSAG 37750032
         BR    GR5                     RETURN                  @Z30RSAG 37800032
IOERR    LA    GR1,13                  I/O ERROR                        38100016
         BAL   GR4,MSGBLD              GO SET UP MESSAGE                38300016
         MVC   0(3,GR1),MSGCON         PUT SVC NO. AND DDNAME IN MSG    38500016
         MVC   3(8,GR1),DDNAME2                                         38700016
         LA    GR5,CODESET             SET UP FOR BRANCH AFTER PRINT    38900016
         B     MSGPRNT                 GO PRINT MESSAGE                 39100016
MSG2     BAL   GR4,MSGBLD               GO SET UP MESSAGE        A35813 39160020
         MVC   0(8,GR1),DDNAME2         PUT DD NAME IN MESSAGE   A35813 39220020
         BAL   GR5,MSGPRNT                                       A35813 39280020
         LA    GR15,4                   SET RETURN CODE TO 4     A35813 39340020
         TM    DCBOFLGS,X'10'           WAS OPEN PERFORMED       A35813 39400020
         BZ    FINAL                    NO, DONT CLOSE           A35813 39460020
         B     CLOSEUP                  GO CLOSE DCB             A35813 39520020
NOMORE   LA    GR1,27                  NO MORE ALTERNATE TRACKS         39600016
MSG1     BAL   GR4,MSGBLD              GO SET UP MESSAGE                39900016
         MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            40200016
PRNTM    BAL   GR5,MSGPRNT             GO PRINT MESSAGE        @Z30RSAG 40500032
CODESET  BAL   GR5,FREEMN              FREE BUFFER IF 3350     @Z30RSAG 40550032
         LA    GR15,8                  SET UP RETURN CODE/ERR  @Z30RSAG 40580032
         TM    DCBOFLGS,X'10'          WAS OPENED PERFORMED             40660016
         BZ    FINAL                   NO-DON'T CLOSE                   40740016
CLOSEUP  LR    GR3,GR15                SAVE RETURN CODE                 40820016
         CLOSE ((7))                                                    40900016
         LR    GR15,GR3                PUT RETURN CODE IN REG 15        40980016
FINAL    L     GR13,GETASAVE+4         RESTORE REGISTER 13              41100016
         RETURN (14,12),T,RC=(15)      RETURN WITH PROPER CODE          41400016
SWITCH1  NOP   UNUSABLE                SWITCH FOR WARNING MESSAGE FOR   41460016
*                                        ALTERNATE ASSIGNED TO VTOC     41520016
*                                        MESSAGE WRITING.               41600016
SYSRES   LA    GR1,14                  IS A SYSTEMS RESIDENCE VOLUME    41700016
         BAL   GR4,MSGBLD              GO SET UP MESSAGE                41800016
         MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            41900016
         MVC   MESS+8(10),MODNAME                                       42000016
         LA    GR5,CODESET             SET UP FOR BRANCH AFTER PRINT    42100016
         B     MSGPRNT                 GO PRINT MESSAGE                 42200016
MSGBLD   LINK  EP=IEHDMSGB             GO SET UP MESSAGE                42300016
         BR    GR4                     CONTINUE PROCESSING              42400016
TERM     EQU  *                                                 YL02912 42450002
         LA   GR1,MESS57               INDICATE GETALT DENIED.  YL02912 42460002
         BAL  GR4,MSGBLD               GO BUILD MESSAGE.        YL02912 42470002
         MVC  D0(L8,GR1),DDNAME2       PUT DDNAME IN MESSAGE.   YL02912 42480002
         MVC  MESS+D8(L6),MODNAME      OVERLAY FUNCTION NAME.   YL02912 42490002
         LA   GR5,CODESET              SET BRANCH AFTER PRINT.  YL02912 42492002
MSGPRNT  LINK  EP=IEHDPRNT             GO PRINT MESSAGE                 42500016
         BR    GR5                     CONTINUE PROCESSING              42600016
         DROP  7                                                        42700016
         AIF   ('&LIB' EQ 'LIB2').X225603                       XL03145 42800003
         USING DATACELL,9                                               42900016
YES2321  MVC   40(6,GR1),DCELVOLI      PLACE 232U SERIAL IN MESSAGE     43100016
         B     SETMSG                  GO WRITE OUT THE MESSAGE.        43300016
         DROP  9                                                        43500016
.X225603 ANOP                                                   XL03145 43600003
LIST     DS    0F            FOR READ IN JFCB                           43800016
         DC    X'87'                                                    44100016
         DC    AL3(0)                                                   44400016
OPENLD   RDJFCB (,(OUTPUT)),MF=L       PARAMETER LIST FOR OPEN          44500016
PARMLIST DC    X'1F'                   PARAMETER LIST FOR SVC           44550016
         DC    AL3(0)                                                   44600016
         DC    1F'0'                                           @Z30RSAG 44650032
DATAREA  DC    F'0'                                            @Z30RSAG 44660032
         DC    X'80'                                                    44700016
         DC    AL3(0)                                                   44750016
BITPAT   DC    X'76B3BD1FAAAAFFFF'                             @Z30RSAG 44760032
EIGHT    DC    H'8'                                            @Z30RSAG 44770032
TTABLE   DC    C'0123456789ABCDEF'     TRANSLATE TABLE                  44800016
MSGCON   DC    C'82,'                  SVC NO. FOR I/O ERROR MESSAGE    44850016
MODNAME  DC    C'GETALT FOR'           NAME OF MODULE                   44940016
GETALTNM DC    C'GETALT'                FUNCTION NAME          @G32DSPD 44942032
RC8      DC    AL1(8)                   RETURN CODE 8          @G32DSPD 44962032
GETASAVE DS    18F                     SAVE AREA                        45000016
TRKZERO  DC    F'0'                                                     45300016
RDDCBAD  DC    A(RDDCB)                DCB ADDRESS.                     45600016
D0       EQU   0                        DISPLACEMENT VALUE 0    YL02912 45650002
D4       EQU   4                        DISPLACEMENT VALUE 4    YL02912 45700002
D8       EQU   8                        DISPLACEMENT VALUE 8    YL02912 45750002
D12      EQU   12                       DISPLACEMENT VALUE 12   YL02912 45800002
MSG66I   EQU   66                       IEH866I OFFSET         @G32DSPD 45802032
L6       EQU   6                        LENGTH VALUE OF 6.      YL02912 45842032
L8       EQU   8                        LENGTH VALUE OF 8.      YL02912 45900002
ZERO     EQU   0                        IMMEDIATE CONSTANT.     YL02912 45950002
MESS57   EQU   57                       MESSAGE IEH857I.        YL02912 46000002
VOL      EQU   70                       DISPLACEMENT FOR VOLID. YL02912 46010002
JJJ      EQU   77                       DISPLACEMENT FOR JOB.   YL02912 46020002
SSS      EQU   86                       DISPLACEMENT FOR STEP.  YL02912 46030002
ERJJ     EQU   56                       DISPLACEMENT FOR JOB.   YL02912 46040002
ERSS     EQU   65                       DISPLACEMENT FOR STEP.  YL02912 46042002
WTORECB  DC    F'0'                     ECB FOR WTOR INST.      YL02912 46050002
ALTER    EQU   82                                                       47600016
ZEUS1    EQU   X'06'                                             S20201 48200020
ZEUS2    EQU   X'07'                                             S20201 48250000
MERLN    EQU   X'09'                   3330 ID                   A49434 48300000
D3350    EQU   X'0B'                   3350 DEVICE TYPE        @Z30RSAG 48350032
         AIF   ('&LIB' EQ 'LIB1').X228310                       XL03130 48400003
WIN      EQU   X'0A'                   3340 DEVICE TYPE.        XL03130 48500003
.X228310 ANOP                                                   XL03130 48600003
K2314    EQU   X'08'                   2314 ID                  XL03145 48700003
         AIF   ('&LIB' EQ 'LIB1').OSDCB                                 48820000
RDDCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST,EOEA=P8,    M5431 F48850000
               SIOA=P7,PGFX=YES                                  M5431  48900000
         AGO   .C1                                                      48950000
.OSDCB   ANOP                                                           49000000
RDDCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST,EOEA=P8            49050000
.C1      ANOP                                                           49100000
MAINT    DS    50F                     PATCH AREA.              US02492 49150002
REPLY    DS   CL1                      AREA FOR WTOR REPLY.     YL02912 49150102
RACVOL   DS   CL6                      VOL SER FOR RACHECK     @G32DSPD 50150132
         EJECT                                                          52900016
         IEHDWORK                                                       59900016
         EJECT                                                          66900016
         IEHDBLKS                                                       73900016
VLABEL   DSECT                                                          85800016
VOLUME   DS    CL3                     LABEL IDENTIFIER.                86100016
VOLNO    DS    CL1                     LABEL NUMBER.                    86400016
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.             86700016
SECURITY DS    CL1                     VOLUME SECURITY.                 87000016
VTOCPTR  DS    CL10                    POINTER TO VTOC                  87300016
         DS    CL20                    RESERVED.                        87600016
OWNER    DS    CL10                    OWNER IDENTIFICATION.            87900016
         DS    CL29                    BLANK.                           88200016
         EJECT                                                          88250002
CVT      DSECT                                                          88300002
         CVT                                                            88350032
         EJECT                                                          88600016
         ICHPRCVT                                              @ZA25515 88650099
         EJECT                                                          88700099
UCB      DSECT                                                          89100016
         IEFUCBOB                                                       89400016
         EJECT                                                          89500016
JFCB     DSECT                                                          89700016
         IEFJFCBN                                                       90000016
         EJECT                                                          90100016
         DCBD  DSORG=PS                                                 90300016
         END                                                            90600016
./  ADD  SSI=70880140,NAME=IEHDINIT
         TITLE 'IEHDINIT -- INITIALIZATION MODULE FOR IEHDREST'         00100002
         COPY  LCGASMSW                                                 00110002
IEHDINIT CSECT                                                          00150002
*                                                                     * 00200002
*D 185600-900                                                  @ZM42083 00200403
*STATUS CHANGE LEVEL 001                                              * 00250002
*                                                                     * 00300002
*A111230                                                       @ZM40088 00302003
*A111214-111222                                                @ZM40425 00304003
*D111230                                                       @ZM40425 00306003
*FUNCTION/OPERATION- THIS ROUTINE WILL INITIALIZE THE CONTROL BLOCKS  * 00350002
*   AND WORK AREAS FOR THE RESTORE FUNCTION. THE DATA CONTROL BLOCKS  * 00400002
*   ARE OPENED AND THE 'TO' DEVICE IS TESTED FOR UNEXPIRED AND/OR     * 00450002
*   PASSWORD PROTECTED DATA SETS.                                     * 00500002
*                                                                     * 00550002
*ENTRY POINTS-  THE ONLY ENTRY POINT IS -IEHDINIT-, AND CONTROL IS    * 00600002
*   ALWAYS RECEIVED FROM THE MONITOR ROUTINE(IEHDASDS).               * 00650002
*                                                                     * 00700002
*INPUT-  POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL         * 00750002
*   BLOCK(REGISTER 10).                                               * 00800002
*                                                                     * 00850002
*EXITS-NORMAL- A SUCCESSFUL RESTORE RESULTS IN A RETURN TO THE        * 00900002
*   MONITOR(IEHDASDS) WITH A RETURN CODE OF 0. A RESTORE COMPLETE     * 00950002
*   MESSAGE IS ALSO PLACED IN THE MESSAGE DATA SET.                   * 01000002
*                                                                     * 01050002
*EXITS-ERROR-  ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROP-       * 01100002
*   IATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER       * 01150002
*   THAN ZERO WILL ALSO BE PASSED BACK TO THE MONITOR.                * 01200002
*                                                                     * 01250002
*EXTERNAL ROUTINES-  THIS ROUTINE IS ALWAYS ENTERED FROM THE          * 01300002
*   MONITOR ROUTINE (IEHDASDS). ALL MESSAGES ARE BUILT BY -IEHDMSGB-  * 01350002
*   AND WRITTEN OUT BY -IEHDPRNT-. ALL DEVICE CONSTANTS REFERENCED    * 01400002
*   ARE IN -IEHDCONS-. EXPIRATION DATE AND SECURITY TESTS ARE MADE    * 01450002
*   BY -IEHDPASS-. THE ACTUAL RESTORE FUNCTION IS EXECUTED IN         * 01500002
*   MODULE -IEHDREST-.                                                * 01550002
*                                                                     * 01600002
*TABLES/WORK AREAS-  UPON ENTRY, REGISTERS 10 AND 12 POINT TO A       * 01650002
*   FUNCTION BLOCK AND WORK AREA RESPECTIVELY. THEY ARE DESCRIBED     * 01700002
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 01750002
*   THIS ROUTINE MUST ALSO SECURE BUFFER SPACE FOR READING IN TAPE    * 01800002
*   RECORDS. THE PROGRAM ATTEMPTS TO GET TWO BUFFERS BUT CAN GET      * 01850002
*   BY WITH ONE.                                                      * 01900002
*   IF COPIES ARE BEING MADE FROM THE RESTORE TAPE, THERE WILL ALSO   * 01950002
*   BE ONE OR MORE COPY BLOCKS CHAINED FROM THE FUNCTION BLOCK. SEE   * 02000002
*   THE -COPYBLK- DSECT FOR A DESCRIPTION.                            * 02050002
*                                                                     * 02100002
*ATTRIBUTES- SERIALLY REUSABLE,RELOCATABLE                            * 02150002
*                                                                     * 02200002
*********************************************************************** 02250002
         EJECT                                                          02300002
*********************************************************************** 02350002
*                                                                     * 02400002
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                           * 02450002
*                                                                     * 02500002
*********************************************************************** 02550002
         SPACE                                                          02600002
GR0      EQU   0                                                        02650002
GR1      EQU   1                                                        02700002
GR2      EQU   2                                                        02750002
GR3      EQU   3                                                        02800002
GR4      EQU   4                                                        02850002
GR5      EQU   5                                                        02900002
GR6      EQU   6                                                        02950002
GR7      EQU   7                                                        03000002
GR8      EQU   8                                                        03050002
GR9      EQU   9                                                        03100002
GR10     EQU   10                                                       03150002
GR11     EQU   11                                                       03200002
GR12     EQU   12                                                       03250002
GR13     EQU   13                                                       03300002
GR14     EQU   14                                                       03350002
GR15     EQU   15                                                       03400002
UCBPTR   EQU   9                                                        03450002
BASEREG  EQU   11                                                       03500002
K0       EQU   0                       DISPLACEMENT CONSTANT.           03550002
         SPACE 3                                                        03600002
*********************************************************************** 03650002
*                                                                     * 03700002
*   MESSAGE REFERENCES.                                               * 03750002
*                                                                     * 03800002
*********************************************************************** 03850002
         SPACE                                                          03900002
MESS5    EQU   5                       MESSAGE IEH805                   03950002
MESS10   EQU   10                      MESSAGE IEH810                   04000002
MESS11   EQU   11                      MESSAGE IEH811                   04050002
MESS13   EQU   13                      MESSAGE IEH813                   04100002
MESS14   EQU   14                      MESSAGE IEH814                   04150002
MESS21   EQU   21                      MESSAGE IEH821                   04200002
MESS30   EQU   30                      MESSAGE IEH830                   04250002
         EJECT                                                          04300002
         USING FUNCBLK,GR10                                             04350002
         USING IEHINIT,BASEREG                                          04400002
         USING WORK,GR12                                                04450002
         SPACE 1                                                        04500002
IEHINIT  SAVE  (14,12),T               SAVE THE REGISTERS.              04550002
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          04600002
         LA    GR7,INITSAVE            SAVE AREA ADDRESS.               04650002
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      04700002
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      04750002
         LR    GR13,GR7                LOAD SAVE AREA ADDRESS.          04800002
         SPACE 2                                                        04850002
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     04900002
         TM    0(GR3),PROCESS          PREVIOUSLY UNDER WAY?            04950002
         BZ    START2                  NO--START FROM THE BEGINNING.    05000002
         B     CALLREST                RETURN TO IEHDREST.              05050002
         EJECT                                                          05100002
*********************************************************************** 05150002
*                                                                     * 05200002
*   ESTABLISH ADDRESSABILITY TO PROPER DEVICE CONSTANTS.              * 05250002
*                                                                     * 05300002
*********************************************************************** 05350002
START2   L     UCBPTR,TUCBPTR          TO-UCB ADDRESS.                  05400002
         USING UCB,9                                                    05450002
         LA    GR8,DDNAME2             USED ON ERROR ONLY.              05500002
         TM    UCBTBYT3,UCB3DACC       IS THIS A DIRECT ACCESS DEVICE.  05550002
         BZ    BADPARM                 NO--MUST BE BAD PARAMETER.       05600002
         TM    SRTESTAT,SRTESYSR       THIS A SYSTEMS RESIDENCE VOLUME. 05650002
         BO    BADDEV                  YES-THIS IS NOT ALLOWED.         05700002
         SR    GR3,GR3                 CLEAR.                           05750002
         AIF   ('&LIB' EQ 'LIB1').WIN01 BRCH IF OS ASSEM                05800002
         CLI   UCBTBYT4,WINCH           WINCHESTER DEVICE ?             05850002
         BNE   WINNO                    NO, BRCH                        05900002
         IC    GR3,ODEVMOD              INSERT WINCH. MODEL NO.         05950002
         B     WINYES                   CONTINUE                        06000002
WINNO    EQU   *                                                        06050002
.WIN01   ANOP                          BRCH POINT FOR OS ASSEM          06100002
         IC    GR3,UCBTBYT4            UCB DEVICE TYPE CODE.            06150002
WINYES   EQU   *                                                        06200002
         LA    GR5,KDEVSIZE            SIZE OF EACH DEVICE ENTRY.       06250002
         BCTR  GR3,0                   DECREMENT FOR PROPER INDEX.      06300002
         MR    GR4,GR3                 ENTRY SIZE TIMES INDEX VALUE.    06350002
         L     GR4,IODEVCON            BEGIN ADDRESS OF DEVICE CONSTANT 06400002
         AR    GR4,GR5                 ADDRESS OF CONSTANTS THIS DEVICE 06450002
         ST    GR4,IODEVCON            SAVE IN FUNCTION BLOCK.          06500002
         MVC   IODEVCON(1),UCBTBYT4    UCB DEVICE TYPE CODE.            06550002
         TM    UCBTBYT2,RPS            TODD HAVE RPS                    06600002
         BZ    STARTIO                 NO                               06650002
         OI    SEQSW+D1,RPSFEAT        YES SET RPS SWITCH               06700002
STARTIO  EQU   *                                                        06750002
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                06800002
         BZ    START5                  NO--GO GET BUFFER SPACE.         06850002
         L     GR8,COPYPTR             YES-COPY BLOCK ADDRESS.          06900002
         USING COPYBLK,GR8                                              06950002
START9   L     UCBPTR,CUCBPTR          ADDRESS OF COPY UCB.             07000002
         TM    UCBTBYT3,UCB3DACC       IS THIS A DIRECT ACCESS DEVICE.  07050002
         BZ    BADPARM                 NO--INVALID PARAMETER.           07100002
         TM    SRTESTAT,SRTESYSR       IS THIS SYSTEMS RESIDENCE.       07150002
         BO    BADDEV                  YES-NOT ALLOWED.                 07200002
         CLC   IODEVCON(1),UCBTBYT4    SAME DEVICE TYPE AS PRIMARY.     07250002
         BNE   BADCOPY                 NO--INCONSISTANT                 07300002
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           07350002
         BZ    START5                  NO--GO START PROCESSING.         07400002
         L     GR8,CCOPYPTR            ADDRESS OF NEXT COPY.            07450002
         B     START9                  GO PROCESS THIS COPY.            07500002
         DROP  8,9                                                      07550002
         EJECT                                                          07600002
*********************************************************************** 07650002
*                                                                     * 07700002
*   THIS SECTION ATTEMPTS TO OBTAIN CORE BUFFERS FOR READING IN THE   * 07750002
*     RECORDS FROM THE RESTORE TAPE. IF TWO BUFFERS ARE OBTAINED, A   * 07800002
*     SWITCH IS SET TO INDICATE THIS. IF NO BUFFERS ARE OBTAINED,     * 07850002
*     THE 'NOCORE SWITCH IS SET FOR THAT FUNCTION.                    * 07900002
*                                                                     * 07950002
*********************************************************************** 08000002
         SPACE 1                                                        08050002
         USING CONSTANT,9                                               08100002
START5   L     GR9,IODEVCON            ADDRESSING FOR DEVICE CONSTANTS. 08150002
         LH    GR2,RBUFSIZE            SIZE PER BUFFER/THIS DEVICE.     08200002
         LA    GR3,BUFFPTR1            SAVE ADDRESS OF BUFFER 1 HERE.   08250002
         BAL   GR14,GETBUFF            GO GET 1ST BUFFER.               08300002
         DROP  9                                                        08350002
         SPACE 1                                                        08400002
         LTR   GR15,GR15               WAS CORE AVAILABLE FOR BUFFER.   08450002
         BZ    TRYTWO                  YES--SEE IF SECOND BUFFER AVAIL. 08500002
         SPACE 1                                                        08550002
         L     GR3,PTRCFUNC            NO--POINTER TO CURRENT FUNCTION. 08600002
         OI    0(GR3),NOCORE           INDICATE NO CORE AVAILABLE.      08650002
         LA    GR15,4                  SET RETURN CODE.                 08700002
         B     FINAL3                  RETURN TO MONITOR.               08750002
         SPACE 1                                                        08800002
GETBUFF  GETMAIN EC,LV=(2),A=(3)       GET CORE FOR A BUFFER.           08850002
         BR    GR14                    RETURN.                          08900002
         SPACE 1                                                        08950002
TRYTWO   LA    GR3,BUFFPTR2            SAVE ADDRESS OF BUFFER 2 HERE.   09000002
         BAL   GR14,GETBUFF            GO TRY TO GET A 2ND BUFFER.      09050002
         LTR   GR15,GR15               WAS CORE AVAILABLE FOR SECOND.   09100002
         BP    SETUPBLK                GO SET UP THE CONTROL BLOCKS.    09150002
         MVI   BUFFSW,X'FF'            SET SWITCH TO SHOW TWO BUFFERS.  09200002
         EJECT                                                          09250002
*********************************************************************** 09300002
*                                                                     * 09350002
*   THIS ROUTINE MOVES THE NECESSARY I/O CONTROL BLOCKS INTO THE      * 09400002
*     SPECIFIED BUFFER. IT ALSO MODIFIES THE NECESSARY POINTERS AND   * 09450002
*     MOVES IN THE DDNAMES TO THE DCBS.                               * 09500002
*                                                                     * 09550002
*********************************************************************** 09600002
         SPACE 1                                                        09650002
SETUPBLK MVC   BLOCKS(RBLKSIZE),RDECB  I/O BLOCKS TO FUNCTION BLOCK.    09700002
         LA    GR9,BLOCKS              ADDRESS OF I/O BLOCKS.           09750002
         USING IOBLOCKS,9                                               09800002
         LA    GR3,TAPEECB             ADDRESS OF ECB.                  09850002
         ST    GR3,TECBAD              SAVE IN IOB.                     09900002
         LA    GR3,TAPEDCB             ADDRESS OF DCB.                  09950002
         ST    GR3,TDCBAD              SAVE IN IOB.                     10000002
         USING IHADCB,GR3                                               10050002
         MVC   DCBDDNAM(8),DDNAME1     MOVE TAPE DDNAME TO DCB.         10100002
         LA    GR3,DISKECB             ADDRESS OF DISK ECB.             10150002
         ST    GR3,DECBAD              SAVE IN IOB.                     10200002
         LA    GR3,DISKDCB             ADDRESS OF DISK DCB.             10250002
         ST    GR3,DDCBAD              SAVE IN IOB.                     10300002
         MVC   DCBDDNAM(8),DDNAME2     MOVE DIRECT ACCESS DDNAME TO DCB 10350002
         ST    GR10,DCBIOBAD           FUNCTION BLOCK ADDRESS TO DCB.   10400002
         L     GR3,BUFFPTR1            ADDRESS OF BUFFER 1.             10450002
         USING RBUFFER,3                                                10500002
         AGO   .SPEED1                                                  10520003
         LA    GR3,CCWBUFF             SLOT TO READ IN CCW RECORD.      10550002
.SPEED1  ANOP                                                           10560003
         LA    GR3,CCWBUFF             CLEAR HI BYTE.          @ZM00000 10570003
         ST    GR3,RDVDATA             SET ADDRESS IN READ DSCB CCW.    10600002
         MVI   RDVDATA,X'06'           RESET THE OP CODE.               10650002
         ST    GR3,TAPECCW1            SET ADDRESS IN TAPE CCW.         10700002
         MVI   TAPECCW1,2              RESET THE OP CODE.               10750002
         L     GR15,IODEVCON           ADDRESSING FOR DEVICE CONSTANTS. 10800002
         USING CONSTANT,15                                              10850002
         AH    GR3,CCWSIZE             ADDRESS TO READ IN DATA.         10900002
         ST    GR3,TAPEDAT1            SET ADDRESS IN TAPE CCW.         10950002
         MVI   TAPEDAT1,2              RESET THE OP CODE.               11000002
         MVC   TAPECCW1+6(2),CCWSIZE   SET TAPE CCW COUNT FOR MAXIMUM.  11050002
         MVC   TAPEDAT1+6(2),DATASIZE  SET TAPE CCW COUNT FOR MAXIMUM.  11100002
         CLI   BUFFSW,ON               THIS A BUFFERED OPERATION.       11150002
         BNE   TESTCOPY                NO--GO CHECK FOR COPIES.         11200002
         L     GR3,BUFFPTR2            YES-BUFFER 2 ADDRESS.            11250002
         USING RBUFFER,3                                                11300002
         ST    GR3,TAPECCW2            SET UP TAPE READ CCW.            11400002
         MVI   TAPECCW2,2              RESET THE OP CODE.               11450002
         AH    GR3,CCWSIZE             SLOT TO READ IN DATA.            11500002
         ST    GR3,TAPEDAT2            SET UP TAPE READ CCW.            11550002
         MVI   TAPEDAT2,2              RESET THE OP CODE.               11600002
         MVC   TAPECCW2+6(2),CCWSIZE   SET TAPE CCW COUNT FOR MAXIMUM.  11650002
         MVC   TAPEDAT2+6(2),DATASIZE  SET TAPE CCW COUNT FOR MAXIMUM.  11700002
         EJECT                                                          11750002
TESTCOPY EQU   *                                                        11800002
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                11850002
         BZ    TESTTAPE                NO--GO START ON THE TAPE.        11900002
         DROP  9                                                        11950002
         L     GR9,COPYPTR             YES-POINTER TO FIRST COPY BLOCK. 12000002
         USING COPYBLK,GR9                                              12050002
MORE2    MVC   CIOBLOCK(116),RDECB     MOVE IN THE I/O CONTROL BLOCKS.  12100002
         LA    GR7,CIOBLOCK            ADDRESS OF COPY I/O BLOCKS.      12150002
         USING IOBLOCKS,GR7                                             12200002
         LA    GR3,DISKECB             COPY ECB ADDRESS.                12250002
         ST    GR3,DECBAD              STORE IN COPY IOB.               12300002
         LA    GR3,DISKDCB             COPY DCB ADDRESS.                12350002
         USING IHADCB,GR3                                               12400002
         ST    GR3,DDCBAD              DCB ADDRESS TO IOB.              12450002
         MVC   DCBDDNAM(8),DDNAME3     DDNAME TO DCB.                   12500002
         ST    GR10,DCBIOBAD           FUNCTION BLOCK ADDRSS TO DCB.    12550002
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           12600002
         BZ    TESTTAPE                NO--GO START ON THE TAPE.        12650002
         L     GR9,CCOPYPTR            YES-ADDRSSS OF NEXT COPY BLOCK.  12700002
         B     MORE2                   GO PROCESS MORE COPIES.          12750002
         DROP  3,7,9,15                                                 12800002
         EJECT                                                          12850002
*********************************************************************** 12900002
*                                                                     * 12950002
*   THIS ROUTINE OPENS THE DATA CONTROL BLOCKS FOR ALL DIRECT         * 13000002
*     ACCESS DEVICES INVOLVED. OPEN IS ALWAYS PERFORMED ON THE        * 13050002
*     FORMAT 4 DSCB OF THE VTOC.                                      * 13100002
*                                                                     * 13150002
*        REGISTERS 2,5,8,9 ARE WORK REGISTERS.                        * 13200002
*        REGISTER  14 IS THE RETURN REGISTER.                         * 13250002
*                                                                     * 13300002
*********************************************************************** 13350002
         SPACE 2                                                        13400002
OPENJ    MVC   LIST+1(3),BUFFPTR1+1    BUFFER ADDRESS TO READ JFCB LIST 13450002
         OC    COPYPTR(4),COPYPTR      COPIES//MORE THAN ONE TO OPEN.   13500002
         BZ    OPEN3                   NO--JUST OPEN ON ONE DEVICE.     13550002
         L     GR9,COPYPTR             ADDRESS OF 1ST OR ONLY COPY.     13600002
         USING COPYBLK,GR9                                              13650002
OPEN2    LA    GR8,CIOBLOCK            I/O BLOCKS//THIS DEVICE.         13700002
         BAL   GR2,OPEN1               GO OPEN THE DCB FOR THIS DEVICE. 13750002
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           13800002
         BZ    OPEN3                   NO--GO OPEN THE FIRST DEVICE.    13850002
         L     GR9,CCOPYPTR            ADDRESS OF NEXT COPY BLOCK.      13900002
         B     OPEN2                   REPEAT OPENJ ON OTHER DEVICES.   13950002
OPEN3    LA    GR8,BLOCKS              I/O BLOCKS FOR UNIT DEVICE.      14000002
         BAL   GR2,OPEN1               GO OPEN DCB FOR UNIT DEVICE.     14050002
         BR    GR14                    RETURN.                          14100002
         DROP  GR9                                                      14150002
         SPACE                                                          14200002
         USING IOBLOCKS,GR8                                             14250002
OPEN1    MVC   OPENLD+1(3),DDCBAD+1    DA DCB ADDRESS FOR OPEN LIST.    14300002
         RDJFCB MF=(E,OPENLD)                                           14350002
         L     GR5,BUFFPTR1            ADDRESS JFCB WAS READ INTO.      14400002
         USING JFCB,GR5                                                 14450002
         MVI   JFCBDSNM,X'04'          SET DSNAME FIELD FOR             14500002
         MVC   JFCBDSNM+1(43),JFCBDSNM   FORMAT 4 DSCB.                 14550002
         MVI   JFCBTSDM,X'08'          PREVENT WRITE-BACK OF JFCB.      14600002
         OPEN  MF=(E,OPENLD),TYPE=J                                     14650002
         L     GR5,OPENLD              DIRECT ACCESS DCB ADDRESS.       14700002
         USING IHADCB,5                                                 14750002
         TM    DCBOFLGS,X'10'          WAS THERE A SUCCESSFUL OPEN.     14800002
         BZ    NOOPEN                  NO--GIVE AN ERROR MESSAGE.       14850002
         NI    DCBMACRF+1,X'F3'        SET BITS OFF TO PREVENT CLOSE    14900002
*                                        FROM WRITING AN EOF RECORD     14950002
*                                        AND UPDATING THE DSCB.         15000002
         BR    GR2                     RETURN.                          15050002
         DROP  GR5,GR8                                                  15100002
         EJECT                                                          15150002
*********************************************************************** 15200002
*                                                                     * 15250002
*   THIS ROUTINE OPENS THE TAPE FOR INPUT.                            * 15300002
*                                                                     * 15350002
*********************************************************************** 15400002
         SPACE                                                          15450002
TESTTAPE L     UCBPTR,FUCBPTR          FROM UCB ADDRESS.                15500002
         USING UCB,9                                                    15550002
         TM    UCBTBYT3,UCB3TAPE       IS THIS A TAPE DEVICE.           15600002
         BZ    BADTAP                  NO--MUST BE BAD PARAMETER.       15650002
         LH    GR8,SRTEFSCT            TAPE DATA SET SEQ. COUNT.        15700002
         LA    GR9,BLOCKS              ADDRESS OF I/O BLOCKS.           15750002
         USING IOBLOCKS,9                                               15800002
         SPACE 1                                                        15850002
         L     GR5,TDCBAD              TAPE DCB ADDRESS.                15900002
         OPEN  ((5),(INPUT))           OPEN TAPE DCB.                   15950002
         L     GR5,TDCBAD              TAPE DCB ADDRESS.                16000002
         USING IHADCB,GR5                                               16050002
         TM    DCBOFLGS,X'10'          WAS THERE A SUCCESSFUL OPEN.     16100002
         BZ    NOOPEN                  NO--GIVE AN ERROR MESSAGE.       16150002
         MVC   LIST+1(3),BUFFPTR1+1    BUFFER ADDRESS TO DCB LIST.      16200002
         L     GR5,TDCBAD              TAPE DCB ADDRESS.                16250002
         RDJFCB ((5))                  READ JFCB FOR TAPE.              16300002
         L     GR3,BUFFPTR1            ADDRESS OF JFCB.                 16350002
         USING JFCB,3                                                   16400002
         MVC   VOLNUMB,JFCBVLCT        MOVE VOL CNT TO WORKAREA SA65804 16450002
         OC    VOLNUMB,JFCBNVOL        ALSO VOL SER COUNT.       YM7437 16460002
         TM    JFCBLTYP,X'11'          UNLABELED OR BLP TAPE.           16500002
         BC    5,PROCDA                YES--MUST BE SOME KIND OF LABEL. 16550002
         OI    SWITCH,STDLABEL         INDICATE USING NL TAPE(S).       16600002
         DROP  3                                                        17100002
PROCDA   BAL   GR14,OPENJ              GO OPEN ON DIRECT ACCESS DEVICE. 17150002
         LA    GR9,BLOCKS              I/O CONTROL BLOCKS.              17200002
         BAL   GR14,FORMAT4            GO READ IN THE FORMAT 4.         17250002
         MVC   ALTDATA(6),0(GR3)       SAVE THE ALTERNATE DATA.         17300002
         OC    COPYPTR(4),COPYPTR      ARE THERE COPIES.                17350002
         BZ    CALLREST               NO--GO MAKE SECURITY TEST.        17400002
         L     GR7,COPYPTR             YES-POINTER TO FIRST COPY.       17450002
         USING COPYBLK,GR7                                              17500002
MORE4    EQU   *                                                OX03063 17510002
         LTR   GR7,GR7                 COPIES ?                 OX03063 17520002
         BZ    CALLREST                NO, CALL IEHDREST        OX03063 17530002
         LA    GR9,CIOBLOCK            ADDRESS OF I/O BLOCKS.   OX03063 17550002
         BAL   GR14,FORMAT4            GO READ IN THE FORMAT4.          17600002
         MVC   CALTDATA(6),0(GR3)      SAVE THE ALTERNATE DATA.         17650002
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           17700002
         BZ    CALLREST               NO--GO MAKE SECURITY TEST OX03063 17750002
         L     GR7,CCOPYPTR            YES-POINTER TO NEXT COPY.        17800002
         B     MORE4                   GO READ IN THE FORMAT FOUR.      17850002
         EJECT                                                          18200002
*********************************************************************** 18250002
*                                                                     * 18300002
*        IEHDREST IS CALLED AT THIS POINT                             * 18350002
*                                                                     * 18400002
*********************************************************************** 18450002
         SPACE 2                                                        18500002
CALLREST EQU   *                                                        18550002
VOLRST   CALL  IEHDREST                 GO TO RESTORE MODULE   @ZM00000 18600003
         SPACE 2                                                        18650003
RSTRTN   ST    GR15,RETCODE             SAVE RETURN CODE       @ZM00000 18700003
         L     GR3,PTRCFUNC             POINTER TO CURRENT FUNCTION.    18750002
         TM    0(GR3),COMPLETE          IS FUNCTION COMPLETE?           18800002
         BO    CLOSE                    YES, CLOSE DCB AND FREE CORE.   18850002
         SPACE                                                          18900002
         LA    GR15,0                   NO, SET RETURN CODE FOR MONITOR 18950002
         B     FINAL3                   RETURN TO MONITOR.              19000002
         EJECT                                                          19050002
*********************************************************************** 19100002
*                                                                     * 19150002
*   THIS SECTION READS IN THE FORMAT 4 DSCB FROM THE VTOC.            * 19200002
*   THE ALTERNATE TRACK INFORMATION IS SAVED FOR THAT VOLUME.         * 19250002
*                                                                     * 19300002
*   REGISTER 3 WILL RETURN A POINTER TO THE 6 BYTES OF ALTERNATE DATA.* 19350002
*   REGISTER 9 MUST POINT TO THE I/O CONTROL BLOCKS FOR THIS DEVICE.  * 19400002
*   REGISTER 14 IS THE RETURN REGISTER.                               * 19450002
*********************************************************************** 19500002
         SPACE 1                                                        19550002
         USING IOBLOCKS,9                                               19600002
         USING IHADCB,GR8                                               19650002
FORMAT4  LA    GR8,DISKDCB             ADDRESS FOR DCB.                 19700002
         L     GR1,DCBDEBAD            ADDRESS OF DEB.                  19750002
         MVC   CCHH(4),38(GR1)         CCHH OF VTOC TO IOB.             19800002
* GET THE ADDRESS OF THE VTOC  THE FOLLOWING NECESSARY CCHH UNALIGNED   19805003
         MVI   R,1                     SET SEARCH FOR RECORD ONE.       19850002
         LA    GR3,DSEEK+3             SEARCH ADDRESS.                  19900002
         ST    GR3,READVTOC            SEARCH ADDRESS TO SEARCH CCW.    19950002
         MVI   READVTOC,X'31'          RESET THE CCW OP CODE.           20000002
         LA    GR3,READVTOC            CCW ADDRESS//READ VTOC.          20050002
         TM    SEQSW+D1,RPSFEAT        TODD HAVE RPS?                   20100002
         BZ    SETRR                   NO.                              20150002
         LA    GR3,SETCCW              YES,SETUP ADDR OF                20200002
*                                      SET SECTOR CCW FOR IOB.          20250002
         LA    GR1,READVTOC            GET TIC ADDRESS.                 20300002
         ST    GR1,SECTIC              PUT IN TIC.                      20350002
         MVI   SECTIC,X'08'            RESTORE TIC CMD.                 20400002
SETRR    EQU   *                                                        20450002
         ST    GR3,DCCWAD              SET UP IOB.                      20500002
         EXCP  DISKIOB                 READ IN THE FORMAT 4 DSCB.       20550002
         WAIT  ECB=DISKECB             AWAIT COMPLETION.                20600002
         CLI   DISKECB,GOOD            ANY ERRORS.                      20650002
         BNE   IOERR                   NO--I/O ERROR.                   20700002
         MVI   R,0                     RESET RECORD NO. TO ZERO.        20750002
         L     GR3,RDVDATA             ADDRESS OF FORMAT 4 DATA.        20800002
         LA    GR3,8(GR3)              ADDRESS OF ALTERNATE DATA.       20850002
         BR    GR14                    RETURN.                          20900002
         DROP  8,9                                                      20950002
         EJECT                                                          21000002
*********************************************************************** 21050002
*                                                                     * 21100002
*                ALL MESSAGES ARE BUILT HERE.                         * 21150002
*                                                                     * 21200002
*********************************************************************** 21250002
         SPACE                                                          21300002
BADDEV   LA    GR1,MESS14              MESSAGE 814.                     21350002
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       21400002
         MVC   MESS+8(10),FUNCTION     FUNTION TYPE TO MESSAGE.         21450002
BADDEV1  MVC   0(8,GR1),0(GR8)         DDNAME TO MESSAGE.               21500002
         B     MSGWRT                  GO WRITE OUT THE MESSAGE.        21550002
         SPACE 1                                                        21600002
BADPARM  LA    GR1,MESS10              MESSAGE 810.                     21650002
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       21700002
         B     BADDEV1                 COMPLETE MESSAGE AND WRITE OUT.  21750002
         SPACE                                                          21800002
BADCOPY  LA    GR1,MESS21              MESSAGE 821.                     21850002
         BAL   GR9,BUILD               PLACE MESSSAGE IN BUFFER.        21900002
         USING COPYBLK,GR8                                              21950002
         MVC   0(8,GR1),DDNAME3        PLACE DDNAME IN MESSAGE.         22000002
         B     MSGWRT                  GO WRITE OUT THE MESSAGE.        22050002
         DROP  GR8                                                      22100002
         SPACE                                                          22150002
         USING IOBLOCKS,GR9                                             22200002
IOERR    LA    GR3,DISKIOB             IOB ADDRESS.                     22250002
         DROP  9                                                        22300002
         LA    GR1,MESS13              MESSAGE 813.                     22350002
         BAL   GR9,BUILD               PLACE MESSAGE HEADING IN BUFFER. 22400002
         LR    GR1,GR3                 IOB ADDRESS.                     22450002
         SYNADAF ACSMETH=EXCP,PARM1=(1)                                 22500002
         MVC   MESS+22(78),49(GR1)     MOVE SYNAD MESS TO BUFFER SM4350 22550002
         SYNADRLS                                                       22600002
         BAL   GR9,MSGWRT1             WRITE OUT I/O ERROR MSG.         22650002
UNUSABLE LA    GR3,DDNAME2             DDNAME FOR MESSAGE.              22700002
         BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MESSAGE.  22750002
         OC    COPYPTR(4),COPYPTR      ANY COPIES.                      22800002
         BZ    FINAL4                  NO--BRANCH.                      22850002
         USING COPYBLK,GR3                                              22900002
         L     GR3,COPYPTR             PTR TO 1ST OR ONLY COPY BLK.     22950002
UNUSE    BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MSG.      23000002
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     23050002
         BZ    FINAL4                  NO--BRANCH.                      23100002
         L     GR3,CCOPYPTR            YES-PTR TO NEXT COPY BLK.        23150002
         B     UNUSE                   CONTINUE PROCESSING.             23200002
         SPACE                                                          23250002
BUILD    LINK  EP=IEHDMSGB                                              23300002
         BR    GR9                     RETURN.                          23350002
         SPACE                                                          23400002
MSGWRT1  EQU   *                                                        23450002
         LINK  EP=IEHDPRNT             WRITE OUT THE MESSAGE.           23500002
         BR    GR9                     RETURN.                          23550002
         SPACE                                                          23600002
MSGWRTA  LA    GR1,MESS30              MESSAGE 830.                     23650002
         BAL   GR9,BUILD               GO TO SET UP MSG.                23700002
         MVC   0(8,GR1),0(GR3)         DDNAME TO MESSAGE.               23750002
         BAL   GR9,MSGWRT1             GO TO PRINT MSG.                 23800002
         BR    GR4                     RETURN TO CALLER.                23850002
         SPACE                                                          23900002
BADTAP   LA    GR1,MESS11              MESSAGE 811.                     23950002
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         24000002
         MVC   0(8,GR1),DDNAME1        DDNAME TO MESSAGE.               24050002
         B     MSGWRT                  GO WRITE OUT THE MESSAGE.        24100002
         SPACE                                                          24150002
NOOPEN   LA    GR1,MESS5               MESSAGE 805.                     24200002
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         24250002
         USING IHADCB,GR5                                               24300002
         MVC   0(8,GR1),DCBDDNAM       MOVE DDNAME TO MESSAGE.          24350002
         DROP  GR5                                                      24400002
         SPACE                                                          24450002
MSGWRT   EQU   *                                                        24500002
         BAL   GR9,MSGWRT1              GO WRITE ERROR MESSAGE.         24550002
FINAL4   EQU   *                                                        24600002
         LA    GR15,8                   SET UP THE RETURN CODE.         24650002
         ST    GR15,RETCODE             SAVE THE RETURN CODE.           24700002
         EJECT                                                          24750002
*********************************************************************** 24800002
*                                                                     * 24850002
*   THIS ROUTINE CLOSES THE DATA CONTROL BLOCKS FOR ALL DIRECT        * 24900002
*     ACCESS DEVICES AND THE ONE TAPE DEVICE USED BY RESTORE. IF      * 24950002
*     THE DCBS HAD NOT BEEN OPENED WHEN THIS ROUTINE IS CALLED,       * 25000002
*     NO ACTION IS PERFORMED.                                         * 25050002
*                                                                     * 25100002
*        REGISTERS 2,5,8,9 ARE WORK REGISTERS.                        * 25150002
*                                                                     * 25200002
*********************************************************************** 25250002
         SPACE 2                                                        25300002
         USING IHADCB,GR5                                               25350002
         USING IOBLOCKS,GR9                                             25400002
CLOSE    LA    GR9,BLOCKS              ADDR PRIMARY I/O BLOCKS.         25450002
         L     GR5,DDCBAD              ADDR. UNIT DCB.                  25500002
         BAL   GR2,CLOSE1              GO TO CLOSE THIS DEVICE.         25550002
         L     GR5,TDCBAD              FROM DCB.                        25600002
         TM    DCBOFLGS,X'10'          DEVICE EVER OPENED.              25650002
         BZ    FINALR1                 NO, GO FREE CORE.                25700002
         OI    DCBOFLGS,X'04'          INDICATE TAPE MARK READ.         25750002
         BAL   GR2,CLOSE2              GO TO CLOSE THIS DCB.            25800002
         OC    COPYPTR(4),COPYPTR      COPIES REQUESTED.                25850002
         BZ    FINALR1                 NO, GO FREE CORE.                25900002
         L     GR8,COPYPTR             PTR. TO FIRST COPY BLOCK.        25950002
         USING COPYBLK,GR8                                              26000002
CLOSEA   LA    GR9,CIOBLOCK            ADDR COPY I/O BLOCK.             26050002
         L     GR5,DDCBAD              ADDR. OF COPY DCB.               26100002
         BAL   GR2,CLOSE1              GO TO CLOSE THIS DCB.            26150002
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES?                     26200002
         BZ    FINALR1                 NO, GO FREE CORE.                26250002
         L     GR8,CCOPYPTR            PTR. TO NEXT COPY BLOCK.         26300002
         B     CLOSEA                  CONTINUE TILL ALL DCBS CLOSED.   26350002
         SPACE                                                          26400002
CLOSE1   TM    DCBOFLGS,X'10'          DEVICE EVER OPENED.              26450002
         BCR   8,GR2                   NO--RETURN.                      26500002
CLOSE2   CLOSE ((5))                   CLOSE THIS DCB.                  26550002
         BR    GR2                     RETURN.                          26600002
         DROP  GR5,GR8,GR9                                              26650002
         EJECT                                                          26700002
*********************************************************************** 26750002
*                                                                     * 26800002
*   THIS SECTION FREES THE CORE THAT WAS USED FOR BUFFERS, IF ANY.    * 26850002
*                                                                     * 26900002
*********************************************************************** 26950002
         SPACE                                                          27000002
FINALR1  CLC   BUFFPTR1(4),ZERO        ARE THERE ANY BUFFERS ASSIGNED.  27050002
         BE    FINALR2                 NO--RETURN TO MONITOR.           27100002
         L     GR1,BUFFPTR1            ADDRESS OF FIRST BUFFER.         27150002
         BAL   GR8,FREEBUF             GO FREE BUFFER ONE.              27200002
         CLI   BUFFSW,ON               IS THIS A BUFFERED OPERATION.    27250002
         BNE   FINALR2                 NO--GO RETURN TO MONITOR.        27300002
         L     GR1,BUFFPTR2            ADDRESS OF 2ND BUFFER.           27350002
         BAL   GR8,FREEBUF             GO FREE SECOND BUFFER.           27400002
         B     FINALR2                 RETURN TO MONITOR                27450002
         USING CONSTANT,9                                               27500002
FREEBUF  L     GR9,IODEVCON            ADDRESS OF DEVICE CONSTANTS.     27550002
         LA    GR1,0(GR1)              INSURE HIGH ORDER BYTE CLEARED.  27600002
         LH    GR0,RBUFSIZE            PICK UP BUFFER SIZE.             27650002
         FREEMAIN R,LV=(0),A=(1)       FREE CORE.                       27700002
         BR    GR8                     RETURN.                          27750002
         DROP  GR9                                                      27800002
         SPACE 1                                                        27850002
FINALR2  EQU   *                                                        27900002
         L     GR15,RETCODE            LOAD RETURN CODE                 27950002
         SPACE                                                          28000002
FINAL3   L     GR13,INITSAVE+4         RESTORE REGISTER 13.             28050002
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN W/PROPER CODE.    28100002
         EJECT                                                          28150002
*********************************************************************** 28200002
*                                                                     * 28250002
*                         DEFINED CONSTANTS                           * 28300002
*                                                                     * 28350002
*********************************************************************** 28400002
         SPACE                                                          28450002
OPENLD  RDJFCB (,(OUTPUT)),MF=L        PARAMETER LIST FOR OPEN DA.      28500002
LIST     DS    0F                      FOR READ IN OF JFCB.             28550002
         DC    X'87'                                                    28600002
         DC    AL3(0)                                                   28650002
F1       DC    F'1'                    USED TO INCREMENT TRACK ADDRESS. 28700002
ZERO     DC    F'0'                                                     28750002
RETCODE  DC    F'0'                                                     28800002
GOOD     EQU   X'7F'                   NO ERRORS ON I/O.                28850002
ON       EQU   X'FF'                   SWITCH ON.                       28900002
RPS      EQU   X'10'                   TEST FOR UCB RPS FEATURE         28950002
RPSFEAT  EQU   X'40'                   RPS FEATURE SWITCH               29000002
WINCH    EQU   X'0A'                   UCB DEVICE TYPE                  29050002
FUNCTION DC    C'RESTORE TO'           MESSAGE FILL IN.                 29100002
SETCCW   CCW   X'23',F1,X'40',1        SET SECTOR ZERO                  29150002
SECTIC   CCW   8,0,0,0                                                  29200002
         SPACE                                                          29250002
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      29300002
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              29350002
RDVDATA  CCW   6,0,X'20',96            READ FORMAT 4 DATA.              29400002
         EJECT                                                          29450002
*********************************************************************** 29500002
*                                                                     * 29550002
*                          CONTROL BLOCKS                             * 29600002
*                                                                     * 29650002
*********************************************************************** 29700002
         SPACE                                                          29750002
*   RESTORE DA WRITE-OUT ECB.                                         * 29800002
         DS    0D                      NECESSARY ALIGNMENT.             29850002
RDECB    DC    F'0'                    WAIT//COMPLETE BITS              29900002
*   RESTORE DA WRITE-OUT IOB.                                           29950002
RDIOB    DS    0F                                                       30000002
RDFLAGS  DC    XL2'4200'               FLAG1 AND FLAG2.                 30050002
RDSENSE  DC    H'0'                    SENSE BYTES.                     30100002
RDECBAD  DC    A(RDECB)                ECB ADDRESS.                     30150002
RDSTATUS DC    2F'0'                   CHANNEL STATUS.                  30200002
RDCCWAD  DC    A(0)                    CCW ADDRESS.                     30250002
RDDCBAD  DC    A(RDDCB)                DCB ADDRESS.                     30300002
RDRESAD  DC    F'0'                    RESTART ADDRESS.                 30350002
RDBLKCT  DC    H'1'                    BLOCK COUNT INCREMENT.           30400002
RDERROR  DC    H'0'                    ERROR COUNT.                     30450002
RDSEEK   DC    2F'0'                   MBBCCHHR.                        30500002
*   RESTORE DA WRITE-OUT DCB.                                           30550002
         AIF   ('&LIB' EQ 'LIB1').OSDCB                                 30600002
RDDCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST,EOEA=P8,          C30650002
               XENDA=P9,SIOA=P7,PGFX=YES                                30700002
         AGO   .C1                                                      30750002
.OSDCB   ANOP                                                           30800002
RDDCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST,EOEA=P8            30850002
.C1      ANOP                                                           30900002
*   RESTORE TAPE READ-IN ECB.                                           30950002
RTECB    DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   31000002
*   RESTORE TAPE READ-IN IOB.                                           31050002
RTIOB    DS    0F                      RESTORE.                         31100002
FLAGS    DC    XL2'4200'               FLAG1 AND FLAG2.                 31150002
SENSE    DC    H'0'                    SENSE BYTES.                     31200002
ADECB    DC    A(RTECB)                ECB ADDRESS.                     31250002
STATUS   DC    2F'0'                   CHANNEL STATUS.                  31300002
CCWS     DC    A(0)                    ADDRESS OF CCWS.                 31350002
DCBAD    DC    A(RTDCB)                DCB ADDRESS                      31400002
RESTART  DC    F'0'                    RESTART ADDRESS.                 31450002
BLKCT    DC    H'1'                    BLOCK COUNT INCREMENT.           31500002
TERROR1  DC    H'0'                    ERROR COUNT.                     31550002
         SPACE 1                                                        31600002
         SPACE 1                                                        31650002
RTDCB    DCB   DSORG=PS,MACRF=(E),DEVD=TA,EXLST=LIST,TRTCH=C            31700002
R1CCW    CCW   2,0,X'60',X'FFFF'       READ CCWS INTO BUFFER ONE.       31750002
R1DATA   CCW   2,0,X'20',X'FFFF'       READ DATA INTO BUFFER ONE.       31800002
         SPACE                                                          31850002
R2CCW    CCW   2,0,X'60',X'FFFF'       READ CCWS INTO BUFFER TWO.       31900002
R2DATA   CCW   2,0,X'20',X'FFFF'       READ DATA INTO BUFFER TWO.       31950002
RDLSTBLK DS    0H                      END OF CONTROL BLOCKS            32000002
RBLKSIZE EQU   RDLSTBLK-RDECB          SIZE OF I/O BLOCKS--RESTORE.     32050002
INITSAVE DC    18F'0'                  REG SAVE AREA FOR IEHDINIT       32100002
D1       EQU   1                       DISP OF 1                        32150002
MAINT    DS    100X                    ZAP FIX AREA.                    32200002
         EJECT                                                          32250002
IOBLOCKS DSECT                                                          32300002
*   RESTORE DA WRITE-OUT ECB.                                           32350002
DISKECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   32400002
         SPACE 1                                                        32450002
*   RESTORE DA WRITE-OUT IOB.                                           32500002
DISKIOB  DS    0F                                                       32550002
DISKFLG  DS    CL2                     FLAGS 1 AND 2.                   32600002
DSENSE   DS    CL2                     SENSE BYTES.                     32650002
DECBAD   DS    1F                      ECB ADDRESS.                     32700002
DSTATUS  DS    2F                      CHANNEL STATUS.                  32750002
DCCWAD   DS    1F                      CCW LIST ADDRESS.                32800002
DDCBAD   DS    1F                      DCB ADDRESS.                     32850002
DRESAD   DS    1F                      RESTART ADDRESS.                 32900002
DBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           32950002
DERROR1  DS    CL2                     ERROR COUNT                      33000002
DSEEK    DS    2F                      MBBCCHHR.                        33050002
BB       EQU   DSEEK+1                 BIN ADDRESS.                     33100002
CCHH     EQU   DSEEK+3                 CYLINDER-HEAD ADDRESS.           33150002
R        EQU   DSEEK+7                 RECORD NUMBER.                   33200002
         SPACE 1                                                        33250002
*   RESTORE DA WRITE-OUT DCB.                                           33300002
DISKDCB  DS    18F                                                      33350002
         SPACE 2                                                        33400002
*   RESTORE TAPE READ-IN ECB.                                           33450002
TAPEECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   33500002
         SPACE 1                                                        33550002
*   RESTORE TAPE READ-IN IOB.                                           33600002
TAPEIOB  DS    0F                                                       33650002
TAPEFLG  DS    CL2                     FLAGS 1 AND 2.                   33700002
TSENSE   DS    CL2                     SENSE BYTES.                     33750002
TECBAD   DS    1F                      ECB ADDRESS                      33800002
TSTATUS  DS    2F                      CHANNEL STATUS.                  33850002
TCCWAD   DS    1F                      CCW LIST ADDRESS.                33900002
TDCBAD   DS    1F                      DCB ADDRESS.                     33950002
TRESAD   DS    1F                      RESTART ADDRESS.                 34000002
TBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           34050002
TERROR   DS    CL2                     ERROR COUNT                      34100002
         SPACE 1                                                        34150002
*   RESTORE TAPE READ-IN DCB NUMBER ONE.                                34200002
TAPEDCB  DS    13F                                                      34250002
         SPACE 1                                                        34300002
*   CCWS TO READ-IN RESTORE TAPE.                                       34350002
         DS    0D                      ALIGNMENT.                       34400002
TAPECCW1 DS    CL8                     USED TO READ CCW RECORD.         34450002
TAPEDAT1 DS    CL8                     USED TO READ DATA RECORD.        34500002
TAPECCW2 DS    CL8                     USED TO READ CCW RECORD.         34550002
TAPEDAT2 DS    CL8                     USED TO READ DATA RECORD.        34600002
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           34650002
          EJECT                                                         34700002
         IEHDBLKS                                                       34750002
         EJECT                                                          34800002
         IEHDWORK                                                       34850002
         SPACE                                                          34900002
VLABEL   DSECT                                                          34950002
VOLUME   DS    CL3                     LABEL IDENTIFIER.                35000002
VOLNO    DS    CL1                     LABEL NUMBER.                    35050002
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.             35100002
SECURITY DS    CL1                     VOLUME SECURITY.                 35150002
VTOCPTR  DS    CL10                    POINTER TO VTOC                  35200002
         DS    CL20                    RESERVED.                        35250002
OWNER    DS    CL10                    OWNER IDENTIFICATION.            35300002
         DS    CL29                    BLANK.                           35350002
         SPACE                                                          35400002
RBUFFER  DSECT                                                          35450002
ZERO1    DS    CL8                     WILL CONTAIN 8 BYTES OF ZEROS.   35500002
CCWBUFF  EQU   ZERO1                                                    35550002
TICSW    DS    CL1                     'FF' INDICATES PREVIOUS CCW=TIC. 35600002
         DS    CL3                     NOT USED.                        35650002
ADDRESS  DS    CL4                     TEMPORARY ADDRESS HOLDER.        35700002
SEEKCCW  DS    CL8                     SEEK CCW FOR STAND-ALONE.        35750002
SETMASK  DS    CL8                     SET FILE MASK FOR STAND-ALONE.   35800002
SEARIDE  DS    CL8                     SEARCH EQUAL ID CCW.             35850002
*   VARIOUS CCW COMBINATIONS CAN FOLLOW FROM THIS POINT ON.             35900002
         EJECT                                                          35950002
CVT      DSECT                                                          36000002
         CVT   SYS=MIN                                                  36050002
         EJECT                                                          36100002
UCB      DSECT                                                          36150002
         IEFUCBOB                                                       36200002
         EJECT                                                          36250002
JFCB     DSECT                                                          36300002
         IEFJFCBN                                                       36350002
         EJECT                                                          36400002
         DCBD  DSORG=PS                                                 36450002
         END                                                            36500002
./  ADD  SSI=80130040,NAME=IEHDIPLI
         TITLE 'IEHDIPLI-PUT STANDALONE DUMP ON TRACK ZERO'             00050000
IEHDIPLI CSECT                                                          00100000
*********************************************************************** 00110099
*                                                                       00114099
*                    FIXES THIS MODULE                                  00118099
*                    LATEST FIRST.                                      00122099
*                                                                       00126099
*********************************************************************** 00130099
*                                                                       00134099
*C 64700                             SU32 ONLY                 @ZA25515 00138099
*A 88744-88756,329350                SU32 ONLY                 @ZA25515 00142099
*                                                                       00146099
*  NO DELETEION                      SU32                      @G32DSPD 00150099
*                                                                       00154099
*C 65000                             ONLY MVS                  @ZA04429 00158099
*A 64600-64700,137508                ONLY MVS                  @ZA04429 00162099
*                                                                       00166099
*                                                               YM4605  00170099
*********************************************************************   00174099
      EJECT                                                             00178099
*FUNCTION/OPERATION                                                 *   00200000
*   THE IEHDIPLI FUNCTION OF IEHDASDR WRITES THREE TO FIVE RECORDS  *   00250000
*   ON TRACK ZERO OF AN INITIALIZED 2314, 2305, 333X, 3340,    MADRID   00300032
*   OR 3350 VOLUME.                                            MADRID   00310032
*   IF PURGE=YES IS SPECIFIED ON THE IEHDASDR CONTROL CARD          *   00350000
*   ANY PREVIOUSLY WRITTEN RECORDS PAST RECORD THREE WILL BE        *   00400000
*   OVERWRITTEN,THIS INCLUDES ANY ADDITIONAL RECORDS IN THE VOLUME  *   00450000
*   LABEL SET,IPLTEXT,IMDSADMP TEXT,ETC.  IF PURGE =NO IS           *   00500000
*   SPECIFIED(OR DEFAULTED) THE FUNCTION PERFORMS AS FOLLOWS;       *   00550000
*                                                                   *   00600000
*      IF THE TODD DEVICE IS A 2314 AND THE LABEL SET CONTAINS MORE *   00650000
*      THAN THE VOL1 RECORD,THE FUNCTION TERMINATES WITH THE        *   00700000
*      APPROPRIATE MESSAGE TO SYSPRINT. IF NO ADDITIONAL RECORDS ARE*   00750000
*      PRESENT IN THE LABEL SET, THE FUNCTION PROCEEDS.             *   00800000
*                                                                   *   00850000
*      IF THE TODD DEVICE IS 2305, 333X, 3340, OR 3350,        MADRID   00900032
*      THE FUNCTION                                            MADRID   00910032
*      REPLACES THE EXISTING IPL1 AND IPL2 RECORDS WITH USER INPUT  *   00950000
*      RECORDS 1 AND 2. USER INPUT RECORDS 3 THRU 5 FOLLOW THE      *   01000032
*      VOLUME LABEL SET.                                            *   01050000
*                                                              @G32DSPD 01060032
*   RACF AUTHORIZATION REQUIRED (UPDATE) TO PUT IPL TEXT ON    @G32DSPD 01070032
*   VOLUMES THAT ARE DEFINED TO RACF.                          @G32DSPD 01080032
*                                                                   *   01100000
*ENTRY POINT---THE ONLY ENTRY POINT IS IEHDIPLI AND CONTROL IS      *   01150000
*      ALWAYS RECEIVED FROM IEHDASDS.                               *   01200000
*                                                                   *   01250000
*EXITS----NORMAL----A SUCESSFUL COMPLETION RESULTS IN A RETURN TO   *   01300000
*      THE MONITOR WITH A RETURN CODE OF 0 AND A COMPLETE MSG IN    *   01350000
*      THE MSG DATA SET.                                            *   01400000
*EXTERNAL ROUTINES---                                               *   01450000
*      IEHDMSGB--VIA LINK                                           *   01500000
*      IEHDPRNT--VIA LINK                                           *   01550000
*                                                                   *   01600000
*********************************************************************   01650000
*   REGISTER EQUATES                                                    01700000
GR0      EQU   0                                                        01750000
GR1      EQU   1                                                        01800000
GR2      EQU   2                                                        01850000
GR3      EQU   3                                                        01900000
GR4      EQU   4                                                        01950000
GR5      EQU   5                                                        02000000
GR6      EQU   6                                                        02050000
GR7      EQU   7                                                        02100000
GR8      EQU   8                                                        02150000
GR9      EQU   9                                                        02200000
GR10     EQU   10                                                       02250000
GR11     EQU   11                                                       02300000
GR12     EQU   12                                                       02350000
GR13     EQU   13                                                       02400000
GR14     EQU   14                                                       02450000
GR15     EQU   15                                                       02500000
WORKBASE EQU   12                                                       02550000
BASEREG  EQU   11                                                       02600000
         SPACE                                                          02650000
*   DEVICE TYPE EQUATES                                                 02700000
DA       EQU   X'20'                                                    02750000
D2314    EQU   X'08'                    2314                            02800000
D23051   EQU   X'06'                    2305-1                          02850000
D23052   EQU   X'07'                    2305-2                          02900000
D3330    EQU   X'09'                    3330                            02950000
WINCH    EQU   X'0A'                    3340                    XM3772  02960003
D2301    EQU   X'02'                    2301                            03000000
         SPACE                                                          03050000
EXCODE   EQU   X'87'                    EXIT LIST CODE                  03100000
OFOUR    EQU   X'04'                    FMT 4 DSNAME                    03150000
NOEOF    EQU   X'7F'                    FLAG TO NOT WRITE EOF ON CLOSE  03200000
NOWRITE  EQU   X'08'                    DONT WRITE JFCB                 03250000
DOPEN    EQU   X'10'                    SUCCESSFUL OPEN                 03300000
FOUR     EQU   4                        CONSTANT 4                      03350000
FOUR0    EQU   X'40'                   STATUS FOR INCORRECT LENGTH      03400000
IPLREC   EQU   24+144                   SIZE OF IPL1 & IPL2 RECORDS     03450000
THREE    EQU   3                        VALUE THREE                     03500000
L8       EQU   8                        LENGTH OF 8                     03550000
D3       EQU   3                        DISPLACEMENT OF 3        M4720  03560000
D7       EQU   7                        DISPLACEMENT OF 7               03600000
GOOD     EQU   X'7F'                    OH RETURN FROM EXCP             03650000
ERROFF   EQU   X'3F'                    TURNS OFF ERROR FLG IN DCBIFLGS 03700000
IENHEX   EQU   X'0A'                    VALUE HEX 10                    03750000
PERMERR  EQU   X'41'                    PERMANENT EXCP ERROR            03800000
UNITCHC  EQU   X'02'                    CSW UNIT CHECK CONDITION        03860000
ONE      EQU   1                                                        03900000
SENS08   EQU   X'08'                    NO REL FOUND SENSE              03950000
VOLVTOC  EQU   11                       DISP OF VTOC PTR IN VOL1 LABEL  04000000
FIVE     EQU   5                                                        04050000
NAMEDISP EQU   8                        DISPL OF NAME IN MESSAGE        04100000
RET0     EQU   0                        RETURN CODE OF ZERO             04150000
RET8     EQU   8                                                        04200000
DISPZERO EQU   0                        DISPLACEMENT ZERO               04250000
DISP1    EQU   1                       DISPLACEMENT OF 1                04300000
DISP2    EQU   2                       DISPLACEMENT OF 2                04350000
DISP19   EQU   19                       DISPLACEMENT                    04400000
DISP49   EQU   49                       DISPLACEMENT                    04450000
L3       EQU   3                        LENGTH 3                YM4605  04500002
L4       EQU   4                        LENGTH 4                        04510002
L5       EQU   5                        LENGTH 5                        04550000
L11      EQU   11                       LENGTH 11                       04600000
L6       EQU   6                        LENGTH 6                        04650000
L43      EQU   43                       LENGTH 43                       04700000
L78      EQU   78                       LENGTH OF 78                    04750000
KEYL0    EQU   X'00'                    2314 IPL3,4,5 KEY LENGTH        04760000
ATE      EQU   X'08'                    2314 WRITE CKD CCW CNT          04770000
REC4     EQU   X'04'                    RECORD NUMBER                   04800000
REC5     EQU   X'05'                    RECORD NUMBER                   04850000
REC6     EQU   X'06'                    RECORD NUMBER                   04900000
OTHREE   EQU   X'03'                    VALUE THREE HEX                 04950000
TWLV     EQU   X'0C'                    NON 2314 WRITE CKD CCW CNT      04960000
TWO      EQU   2                        VALUE TWO                       05000000
SERDISP  EQU   40                       DISP OF SERIAL # IN MESSAGE     05050000
SEARDISP EQU   38                       DISPLACEMENT INTO IPL2 RECORD   05100000
*                                       OF THE SEARCH ADDRESS.          05150000
WTDATA   EQU   X'05'                    WRITE DATA COMMAND CODE         05200000
BIGREC   EQU   X'10'                    GREATER THAN 2K INPUT REC       05250000
CCSILI   EQU   X'40'                    SET CMD CHAIN                   05300000
ENDCCW   EQU   X'00'                    SET TO END CCW CHAIN            05350000
CCWMASK  EQU   X'07'                    MASK TO STORE ADDR IN CCW       05400000
VOLIDOFF EQU   62                       VOLID OFFSET FOR IEH852 YM4605  05410002
UNITOFF  EQU   69                       IEH852 UCBNAME OFFSET   YM4605  05420002
JOBNOFF  EQU   74                       IEH852 JOBNAME OFFSET   YM4605  05430002
STEPOFF  EQU   84                       IEH852 STEPNAME OFFSET  YM4605  05440002
*********************************************************************** 05450000
*   MESSAGE EQUATES                                                   * 05500000
*                                                                     * 05550000
*********************************************************************** 05600000
MESSG6   EQU   6                                                        05650000
MESSG5   EQU   5                                                        05700000
MESSG10  EQU   10                                                       05750000
MESSG13  EQU   13                                                       05800000
MESSG14  EQU   14                                                       05850000
MESSG34  EQU   34                                                       05900000
MESSG99  EQU   99                                                       05950000
MESSG70  EQU   70                                                       06000000
MESSG71  EQU   71                                                       06050000
MESSG72  EQU   72                                                       06100000
MSG66I   EQU   66                       IEH866I OFFSET         @G32DSPD 06110032
         SPACE                                                          06150000
         USING WORK,WORKBASE            SET UP WORK AREA BASE           06200000
         USING FUNCBLK,GR10             SET UP FUNCTION BLOCK BASE      06250000
         USING IEHMAIN,BASEREG          SET UP PROGRAM BASE             06300000
         SPACE                                                          06350000
IEHMAIN  SAVE  (14,12),T,IEHDIPLI       SAVE REGISTER FOR CALLER        06400000
         LR    BASEREG,GR15             ESTABLISH PROGRAM ADDRESSABILIT 06450000
         B     APARNO                   BRANCH AROUND APAR NO  @ZA04429 06460032
         DC    C'SU32 OZ25515'          LAST FIX THIS MOD      @ZA25515 06470099
APARNO   LA    GR7,IPLISAV              SAVE AREA ADDRESS      @ZA04429 06500032
         ST    GR7,L8(GR13)             ADDR OF NEW AREA TO OLD         06550000
         ST    GR13,FOUR(GR7)           ADDR OF OLD AREA TO NEW         06600000
         LR    GR13,GR7                 LOAD SAVE AREA ADDR             06650000
         SPACE                                                          06700000
         L     GR4,TUCBPTR              ADDR OF UCB                     06750000
         USING UCB,GR4                                                  06800000
*   CHECK FOR ACCEPTABLE DEVICE                                         06850000
         TM    UCBTBYT3,DA              DIRECT ACCESS DEVICE ?          06900000
         BZ    BADEVICE                 NO- PREPARE FOR ERROR RETURN    06950000
         CLI   UCBTBYT4,D23051          DEVICE A 2305-1?                07100000
         BL    NOTOKDEV                 BRANCH IF LOW          XL03145  07150003
         SPACE                                                          07500000
DEVOK    EQU   *                                                        07550000
         TM    SRTESTAT,SRTESYSR        IS THIS VOLUME SYSTEM RESIDENT  07600000
         BO    BADDEV                   YES-SET UP ERROR MESSAGE        07650000
*********************************************************************** 07700000
*                                                                     * 07750000
*   THIS ROUTINE OPENS THE OUTPUT DATA CONTROL BLOCK. THE OPEN        * 07800000
*   IS PERFORMED ON THE FORMAT FOUR DSCB OF THE VTOC                  * 07850000
*                                                                     * 07900000
*********************************************************************** 07950000
         LA    GR5,OUTDCB               OUTPUT DCB ADDRESS              08000000
         USING IHADCB,GR5                                               08050000
         MVC   DCBDDNAM,DDNAME2         PUT DDNAME IN DCB               08100000
         MVC   OPENLST+ONE(THREE),WRDCBAD+ONE   DCB ADDRESS TO LIST     08150000
         LA    GR9,RDBUFF               BUFFER ADDR TO READ JFCB        08200000
         ST    GR9,LIST                 STORE ADDRESS IN LIST           08250000
         MVI   LIST,EXCODE              EXIT LIST CODE                  08300000
         RDJFCB MF=(E,OPENLST)                                          08350000
         USING JFCB,GR9                                                 08400000
         MVI   JFCBDSNM,OFOUR           SET DSNAME FIELD FOR            08450000
         MVC   JFCBDSNM+ONE(L43),JFCBDSNM  FORMAT 4 DSCB                08500000
         MVI   JFCBTSDM,NOWRITE         STOP WRITE OF JFCB AT OPEN      08550000
         OPEN  MF=(E,OPENLST),TYPE=J                                    08600000
         TM    DCBOFLGS,DOPEN           WAS OPEN SUCCESSFUL             08650000
         BZ    NOOPEN                   NO GIVE AN ERROR MESSAGE        08700000
         BAL   GR7,WTOR                 PROMPT OPER             YL02912 08710002
         LA    GR7,OUTIOB               IOB ADDRESS                     08750000
         ST    GR7,DCBIOBAD             IN DCB                          08800000
         DROP  GR9                                                      08850000
*********************************************************************** 08852032
*       THIS SECTION OF CODE TEST THE RACF AUTHORIZATION OF THE USER. * 08854032
*  THE USER MUST HAVE UPDATE AUTHORITY IN ORDER TO PUT IPL TEXT ON    * 08856032
*  THE PACK IF THE PACK IS RACF DEFINED. IF RACF IS NOT ACTIVE  IN    * 08858032
*  THE SYSTEM AUTHORIZATION CHECKS ARE NOT MADE.                      * 08860032
*********************************************************************** 08862032
         L     GR9,CVTPTR              GET CVT PTR             @G32DSPD 08864032
         USING CVT,GR9                                         @G32DSPD 08866032
         L     GR9,CVTRAC              GET RACF POINTER        @G32DSPD 08868032
         DROP  GR9                                             @G32DSPD 08870032
         LTR   GR9,GR9                 TEST RACF POINTER       @G32DSPD 08872032
         BZ    NULLRACF                NULL IF RACF NOT ACTIVE @G32DSPD 08874032
         USING RCVT,GR9                DO CHECK IF RACF IS     @ZA25515 08874499
         TM    RCVTSTA1,RCVTDASD       CURRENT.                @ZA25515 08874899
         BZ    NULLRACF                NO NOT CURRENT          @ZA25515 08875299
         DROP  GR9                     YES DO RACHECK          @ZA25515 08875699
         MVC   RACVOL,UCBVOLI          GET VOLID FROM UCB      @G32DSPD 08876032
         RACHECK ATTR=UPDATE,ENTITY=RACVOL,CLASS='DASDVOL'     @G32DSPD 08878032
         CLM   GR15,B'0001',RC8        TEST FOR UNAUTHORIZED   @G32DSPD 08880032
         BE    UNAUTH                  YES,GO TERMINATE        @G32DSPD 08882032
NULLRACF EQU   *                                               @G32DSPD 08884032
         SPACE 2                                               @G32DSPD 08886032
*   READ IN THE VOLUME LABEL TO VERIFY THAT THE OUTPUT VOLUME           08900000
*   IS NOT A DOS VOLUME WITH THE VTOC ON CYL 0 TRACK 0.                 08950000
         LA    GR7,RDVOL1               CCW ADDRESS                     09000000
         ST    GR7,OUTCCWA              PUT IN IOB                      09050000
         XC    OUTSEEK(L8),OUTSEEK      SET IOB SEEK FIELD TO           09100000
*                                       CYL 0 TRACK 0                   09150000
         EXCP  OUTIOB                                                   09200000
         WAIT  ECB=OUTECB                                               09250000
         CLI   OUTECB,GOOD              OK RETURN ?                     09300000
         BNE   IOERR                    BRANCH IF NO                    09350000
         CLC   VOL1BUF(L4),VOL1         GOOD VOL1 RECORD         M4720  09360000
         BNE   IOERR                    NO, PUT OUT ERROR MESS   M4720  09370000
         OC    VOL1BUF+VOLVTOC(L4),VOL1BUF+VOLVTOC  VTOC ON      YM3041 09400002
*                                       CYL 0, HEAD 0 ?                 09450002
         BZ    DOSVOLER                 BRANCH IF ZERO                  09500000
         SPACE                                                          09550000
*   IS PURGE = YES SPECIFIED?                                           09600000
         TM    SEQSW+ONE,PURGE          PURGE=YES SPECIFIED?            09650000
         BNO   RDLABELS                 NO-BRANCH TO READ VOL LABEL SET 09700000
*   INITIALIZE THE SEARCH ADDRESS FOR THE IPL2 RECORD TO RECORD 4.      09750000
         MVI   SEARCHAD+FOUR,OFOUR      SET REC # TO FOUR               09800000
         MVI   SLAST+FOUR,OTHREE        SET REC # FOR OUTPUT SEARCH.    09850000
*   INSERT RECORD NUMBER IN OUTPUT CCW COUNT FIELDS                     09900000
         MVI   IPLCK3R,REC4             RECORD FOUR IN CCW COUNT FIELD  09950000
         MVI   IPLCK4R,REC5             RECORD FIVE IN CCW COUNT FIELD  10000000
         MVI   IPLCK5R,REC6             RECORD SIX IN CCW COUNT FIELD   10050000
*   OPEN INPUT DCB AND GET CORE FOR INPUT RECORDS.                      10100000
*   THE NUMBER OF BYTES FOR INPUT BUFFER EQUALS 3 TIMES THE             10150000
*   DCBBLKSI PLUS 24 PLUS 144, ALL ROUNDED TO AD WORD BOUNDARY.         10200000
OPENIN   EQU   *                                                        10250000
         LA    GR5,INDCB                ADDRESS OF INPUT DCB            10300000
         MVC   DCBDDNAM(L8),DDNAME1     MOVE DDNAME INTO DCB            10350000
         OPEN  INDCB                    OPEN INPUT DCB                  10400000
         TM    DCBOFLGS,DOPEN           SUCCESSFUL OPEN?                10450000
         BZ    NOOPENIN                 NO - PRINT MESSAGE              10500000
         L     GR3,GETLEN               LOAD LENGTH FOR GETMAIN         10550000
         GETMAIN R,LV=(GR3)                                             10600000
         LR    GR6,GR1                  SAVE BUFFER ADDRIN GR6          10650000
         SR    GR3,GR3                  INITIALIZE FOR RECORD COUNT     10700000
         ST    GR1,COREADR              SAVE ADDRESS OF GOTTEN CORE     10750000
         BAL   GR9,GETIN                BRANCH TO READ 1ST REC          10800000
         CLC   DCBLRECL,TWFOUR+DISP2    LENGTH = 24?                    10850000
         BNE   LENERR                   NO-BRANCH-WRONG LENGTH          10900000
         STCM  GR1,CCWMASK,ADDR1+DISP1  STORE DATA ADDR IN CCW          10950000
         AH    GR6,DCBLRECL             ADD REC LENGTH TO BUFFER PTR.   11000000
         BAL   GR9,GETIN                GET RECORD 2.                   11050000
         CLC   DCBLRECL,ONE44           LENGTH = 144                    11100000
         BNE   LENERR                   NO-BRANCH-WRONG LENGTH          11150000
         STCM  GR1,CCWMASK,ADDR2+DISP1  STORE DATA ADDR IN CCW          11200000
         MVC   SEARDISP(L5,GR1),SEARCHAD MOVE SEARCH ADDR TO IPL2       11250000
         AH    GR6,DCBLRECL             ADD REC LENGTH TO BUFFER PTR    11300000
         BAL   GR9,GETIN                READ 3RD RECORD.                11350000
         ST    GR1,ADDR3                STORE DATA ADDR IN CCW.         11400000
         AH    GR6,DCBLRECL             ADD REC LENGTH TO BUFFER PTR    11450000
         MVC   DLEN3,DCBLRECL           MOVE REC LENGTH INTO OUTPUT CCW 11500000
         MVC   IPLCK3L,DCBLRECL         MOVE REC LENGTH TO OUTPUT COUNT 11550000
         MVI   FLAG3,CCSILI             SET CC IN CCW                   11600000
         XC    LARGREC,LARGREC          SET FLAG TO ZERO                11650000
         CLC   DCBLRECL,TWOK            INPUT REC > 2048 BYTES?         11700000
         BNH   GETFOUR                  BRANCH IF LOW OR EQ             11750000
         OI    LARGREC,BIGREC           SET 2 REC MAX FLAG IF HIGH      11800000
GETFOUR  EQU   *                                                        11850000
         BAL   GR9,GETIN                GET 4TH RECORD                  11900000
         ST    GR1,ADDR4                STORE DATA ADDR IN CCW.         11950000
         AH    GR6,DCBLRECL             ADD REC LENGTH TO BUFFER PTR    12000000
         MVC   DLEN4,DCBLRECL           MOVE REC LENGTH INTO OUTPUT CCW 12050000
         MVC   IPLCK4L,DCBLRECL         MOVE REC LENGTH TO OUTPUT COUNT 12100000
         MVI   FLAG4,CCSILI             SET CC IN CCW                   12150000
         CLC   DCBLRECL,TWOK            INPUT REC > 2048 BYTES?         12200000
         BH    ENDIN                    PRETEND EOF AFTER 4 RECS        12250000
*                                       IF REC > 2048                   12300000
         TM    LARGREC,BIGREC           WAS 2 REC SWITCH SET BY REC 4?  12350000
         BO    ENDIN                    PRETEND EOF AFTER 4 RECS IF     12400000
*                                       ANY > 2048 BYTES                12450000
         BAL   GR9,GETIN                GET 5TH RECORD                  12500000
         ST    GR1,ADDR5                STORE DATA ADDR IN CCW          12550000
         MVC   DLEN5,DCBLRECL           MOVE REC LENGTH INTO OUTPUT CCW 12600000
         MVC   IPLCK5L,DCBLRECL         MOVE REC LENGTH TO OUTPUT COUNT 12650000
         CLC   DCBLRECL,TWOK            INPUT REC > 2048 BYTES?         12700000
         BH    LENERR                   TOO LARGE IF > 2048             12750000
WRITOUT  EQU   *                                                        12800000
         LA    GR5,OUTDCB               DCB ADDRESS                     12850000
         LA    GR9,CCWOUT               STORE CCW ADDRESS               12900000
         ST    GR9,OUTCCWA              IN IOB                          12950000
         XC    OUTSEEK(L8),OUTSEEK      INIT IOB SEEK TO CYL 0 HEAD 0   13000000
         L     GR4,TUCBPTR              LOAD UCB ADDR OF O/P DEVICE     13010000
         CLI   UCBTBYT4,D2314           THIS A 2314 DEVICE              13030000
         BE    SET2314                  YES, BRCH                       13040000
         MVI   IPLCHKL3,REC4            SET IPL3 KEY LENGTH FLD         13042000
         MVI   IPLCHKL4,REC4            SET IPL4 KEY LENGTH FLD         13044000
         MVI   IPLCHKL5,REC4            SET IPL5 KEY LENGTH FLD         13046000
         MVI   CCWOUT3+D7,TWLV          SET IPL3 CCW CNT FLD            13046400
         MVI   CCWOUT4+D7,TWLV          SET IPL4 CCW CNT FLD            13046800
         MVI   CCWOUT5+D7,TWLV          SET IPL5 CCW CNT FLD            13047200
DOIT     EQU   *                                                        13048000
         EXCP  OUTIOB                                                   13050000
         WAIT  ECB=OUTECB                                               13100000
         CLI   OUTECB,GOOD              GOOD RETURN FROM I/O ?          13150000
         BNE   IOERR                    NO-BRANCH                       13200000
FINISH   EQU   *                        SET UP SUCCESSFUL COMPLETION    13250000
*                                       MESSAGE                         13300000
         LA    GR1,MESSG6               MESSAGE NUMBER                  13350000
         BAL   GR9,MSGBLD              GO BUILD MESSAGE                 13400000
         MVC   0(L8,GR1),DDNAME2        PUT DDNAME IN MESSAGE           13450000
         MVC   SERDISP(L6,GR1),UCBVOLI    PUT SERIAL NUMBER IN MESSAGE  13500000
         L     GR4,TUCBPTR              ADDRESS OF UCB                  13550000
         MVC   MESS+NAMEDISP(NAMELEN),NAME MODULE NAME IN MESSAGE       13600000
         LA    GR9,GOODRTN                                              13650000
         B     MSGPRNT                  GO PRINT MESSAGE                13700000
         EJECT                                                          13700102
*********************************************************************** 13700802
*        THE FOLLOWING ROUTINE WILL PROMPT THE OPERATOR TO              13701202
*        ALLOW PROCESSING TO CONTINUE.                                  13701602
*********************************************************************** 13701702
WTOR     EQU   *                                                YL02912 13701802
         USING UCB,GR3                                                  13701902
         L     GR3,TUCBPTR              GET TODD UCB ADDR       YL02192 13706402
         MVC   PUTMSG+VOLIDOFF(L6),SRTEVOLI VOLID TO MESS 852   YM4605  13710402
         MVC   PUTMSG+UNITOFF(L3),UCBNAME   UNIT ADDR TO MSG    YM4605  13710802
         L     GR3,CVTPTR               GET CVT ADDR            YL02912 13710902
         USING CVT,GR3                                                  13714702
         L     GR3,CVTTCBP              GET CURRENT TCB ADDR    YL02912 13716702
         L     GR3,L4(GR3)              INCRE TO CURRENT TCB    YL02912 13716802
         USING TIOT,GR3                                                 13717102
         L     GR3,TIOTOFF(GR3)         GET TIOT PTR            YL02912 13717502
         MVC   PUTMSG+JOBNOFF(L8),TIOCNJOB JOBNAME TO MSG        YM4605 13717902
         MVC   PUTMSG+STEPOFF(L8),TIOCSTEP MOVE STEPNAME TO MSG  YM4605 13718302
         DROP  GR3                                                      13726402
PUTMSG   WTOR  'IEH852D REQUEST PERMISSION TO PUT IPL-TEXT ON VVVVVV/CU*13729602
               U, JJJJJJJJ, SSSSSSSS',REPLY,1,DSKECB,                  *13732802
               ROUTCDE=(4),DESC=(2)                                     13736002
         TM    DSKECB,COMPLETE          ANWSER YET ?            YL02192 13739202
         BO    OK                       YES, AVOID WAIT         YL02192 13742402
         WAIT ECB=DSKECB                                                13745602
OK       EQU   *                                                YL02912 13748802
         MVI   DSKECB,X'00'             CLEAR FIRST ECB BYTE   @ZA04429 13750832
         CLI   REPLY,C'U'               OPERATOR SAY USE IT ?   YL02192 13752002
         BE    XIT7                     YES, RETURN ON REG 7    YL02192 13755202
         CLI   REPLY,C'T'               OPER SAY DONT USE ?     YL02192 13758402
         BNE   PUTMSG                   RE=ISSUE MSG            YL02192 13761602
         B     SETCODE                  SET RC=8                YL02912 13764802
XIT7     BR    GR7                      EXIT                    YL02912 13768002
SET2314  EQU   *                                                        13771202
         MVI   IPLCHKL3,KEYL0           SET IPL3 KEY LENGTH FLD         13774402
         MVI   IPLCHKL4,KEYL0           SET IPL4 KEY LENGTH FLD         13777602
         MVI   IPLCHKL5,KEYL0           SET IPL5 KEY LENGTH FLD         13780802
         MVI   CCWOUT3+D7,ATE           SET IPL3 CCW CNT FLD            13784002
         MVI   CCWOUT4+D7,ATE           SET IPL4 CCW CNT FLD            13787202
         MVI   CCWOUT5+D7,ATE           SET IPL5 CCW CNT FLD            13790402
         B     DOIT                     GO ISSUE EXCP                   13793602
MSGBLD   EQU   *                                                        13796802
         LINK  EP=IEHDMSGB              GO CONSTRUT MESSAGE             13800000
         BR    GR9                      RETURN                          13850000
MSGPRNT  EQU   *                                                        13900000
         LINK  EP=IEHDPRNT              GO PRINT MESSAGE                13950000
         BR    GR9                      RETURN                          14000000
*********************************************************************** 14050000
*                                                                     * 14100000
*   READ THE VOLUME LABEL SET AND DETERMINE HOW MANY                  * 14150000
*   LABELS IT CONTAINS. THEN SET THE SEARCH ADDRESS                   * 14200000
*   OF THE OUTPUT CCW CHAIN TO THE LAST VOLUME LABEL IN THE           * 14250000
*   SET.                                                              * 14300000
*                                                                     * 14350000
*********************************************************************** 14400000
RDLABELS EQU   *                                                        14450000
         LA    GR9,RDVOLX               ADDRESS OF CCW CHAIN     M4720  14500000
         ST    GR9,OUTCCWA              STORE IN IOB                    14550000
         XC    OUTSEEK(L8),OUTSEEK      INIT IOB SEEK FIELD TO ZEROS    14600000
         MVI   OUTSEEK+D7,REC4          SET SEEK ADDR FOR VOL2-8 M4720  14600400
         LA    GR9,VOL1                 SETUP VOLX BASE REG      M4720  14602000
         USING VOLX,GR9                 ISSUE USING FOR DSECT    M4720  14604000
*        VOL1 - VOL8 CONSTANTS MUST BE IN CONSEQUTIVE LOCATIONS  M4720  14606000
SEEKVOLX EQU   *                                                 M4720  14610000
         LA    GR9,L4(GR9)              INCRE VOLX BASE REG      M4720  14620000
         EXCP  OUTIOB                                                   14650000
         WAIT  ECB=OUTECB                                               14700000
         CLI   OUTECB,GOOD              OK RETURN ?                     14750000
         BE    TSTVOLX                  BRANCH IF YES.           M4720  14800000
         CLI   OUTECB,PERMERR           PERM ERROR ?                    14850000
         BE    UNITCHK                  YES, GO CHK FOR UNIT CHK M4720  14860000
         B     IOERR                    NO - MUST BE UNHANDLEABLE       14900000
TSTVOLX  EQU   *                                                 M4720  14902000
         CLC   VOL1BUF(L4),VOLX         GOOD VOL2-8 LABEL        M4720  14904000
         BNE   SETCCW2                  NO, BRCH                 M4720  14906000
         CLC   VOLX(L4),VOL8            THIS THE LAST USER LAB   M4720  14908000
         BE    SETCCW1                  YES, BRCH                M4720  14908800
         SR    GR7,GR7                  ZERO WORK REG            M4720  14909200
         IC    GR7,OUTSEEK+D7           GET # OF LAST REC READ   M4720  14909600
         LA    GR7,1(GR7)               INCRE IT BY 1            M4720  14909700
         STC   GR7,OUTSEEK+D7           UPDATE SEEK ADDR         M4720  14909800
         B     SEEKVOLX                 GO READ NEXT VOL2-8 REC  M4720  14909900
         DROP  GR9                                               M4720  14923200
UNITCHK  EQU   *                                                 M4720  14936700
         TM    OUTSTAT+FOUR,UNITCHC     DID UNIT CHECK OCCUR?           14950000
         BNO   CHECKMOR                 NO - CHECK FOR WRONG LENGTH     15000000
         TM    OUTSENS+ONE,SENS08       NO RECORD FOUND?         M4720  15050000
         BO    SETCCW2                  YES - SET OUTPUT CCW'S          15100000
         B     IOERR                    UNSOLVABLE PROBLEM              15150000
CHECKMOR EQU   *                                                        15200000
         TM    OUTSTAT+FIVE,FOUR0       WRONG LENGTH RECORD?            15250000
         BNO   IOERR                    BRANCH TO I/O ERROR ROUT IF NO. 15300000
SETCCW2  EQU   *                                                        15350000
         NI    DCBIFLGS,ERROFF          TURN OFF PERM ERROR FLAG        15400000
         SR    GR7,GR7                  ZERO WORK REG            M4720  15450000
         IC    GR7,OUTSEEK+D7           GET LAST REC SOUGHT      M4720  15500000
TST2314  EQU   *                                                XM6295  15510000
         S     GR7,FFOUR                SUBTRACT 4 TO FIND DISPL M4720  15550000
*                                       PAST VOL1 RECORD         M4720  15600000
         CLI   UCBTBYT4,WINCH           3340 DEVICE ?           XM3772  15650003
         BNE   T2314                    NO, BRCH                XM3772  15700003
         CH    GR7,TWOO                 DO WE HAVE ONLY TWO     XM3772  15750003
*                                       USER VOLUME LABELS ?    XM3772  15800003
         BH    TOMANY                   NO, MORE THAN TWO       XM3772  15850003
         B     SETCCW2A                 ONLY 2 USER LABELS, BRCH XM3772 15900003
T2314    EQU   *                                                XM3772  15950003
         CLI   UCBTBYT4,D2314          VOLUME A 2314 ?                  16050000
         BNE   SETCCW2A                NO, CONTINUE                     16100000
         LTR   GR7,GR7                 YES, ANY ADDITIONAL LABELS ?     16150000
         BNZ   TOMANY                  BRANCH TO ERROR IF YES           16200000
SETCCW2A LA    GR7,FOUR(GR7)            ADD 4 TO ALLOW FOR IPL1, IPL2,  16250000
*                                       AND VOL1 RECORDS AND POINT      16300000
*                                       PAST THE LAST LABEL IN THE      16350000
*                                       LABEL SET.                      16400000
         SPACE                                                          16450000
SETCCW3  EQU   *                                                        16500000
         STC   GR7,SEARCHAD+FOUR        SAVE REC # TO BE PUT IN         16550000
*                                       SEARCH ADDRESS OF IPL2 RECORD.  16600000
         BCTR  GR7,GR0                  SUBTRACT ONE FROM REC # TO      16650000
*                                       POINT TO LAST LABEL IN VOL      16700000
*                                       LABEL SET.                      16750000
         STC   GR7,SLAST+FOUR           STORE REC # IN SEARCH ADDR      16800000
*                                       FOR OUTPUT CCW'S                16850000
         LA    GR7,ONE(GR7)             CALC REC # OF 3RD OUTPUT REC    16900000
         STC   GR7,IPLCK3R              STORE IN COUNT FIELD            16950000
         LA    GR7,ONE(GR7)             CALC REC # OF 4TH OUTPUT REC    17000000
         STC   GR7,IPLCK4R              STORE IN COUNT FIELD            17050000
         LA    GR7,ONE(GR7)             CALC REC # OF 5TH OUTPUT REC    17100000
         STC   GR7,IPLCK5R              STORE IN COUNT FIELD            17150000
         B     OPENIN                   BRANCH TO OPEN INPUT DCB        17200000
*   CONTROL BRANCHES HERE IF LABEL SET HAS EIGHT RECORDS.               17250000
SETCCW1  EQU   *                                                        17300000
         LA    GR7,L11                  REC NO. FOR IPL2 SEARCH ADDR    17350000
         B     TST2314                  GO TEST FOR 2314        XM6295  17400000
GOODRTN  EQU   *                                                        17450000
         LA    GR15,RET0                LOAD RETURN CODE                17500000
         L     GR3,PTRCFUNC             PICK UP PTR TO CURRENT FUNC.    17550000
         MVI   DISPZERO(GR3),COMPLETE   SET COMPLETE                    17600000
         B     ENDUP                    GO TO CLOSE                     17650000
IOERR    EQU   *                                                        17700000
         LA    GR1,MESSG13              I/O ERROR MESSAGE #.            17750000
         BAL   GR9,MSGBLD               BUILD MESSAGE                   17800000
         SYNADAF ACSMETH=EXCP,PARM1=OUTIOB                              17850000
         MVC   MESS+DISP19(L78),DISP49(GR1) PUT I/O INFO IN BUFFER      17900000
         SYNADRLS                                                       17950000
ERRPRNT  BAL   GR9,MSGPRNT              GO PRINT ERROR MESSAGE          18000000
SETCODE  LA    GR15,RET8                SET UP RETURN CODE ERROR        18050000
         LA    GR2,RET8                 SET RETURN CODE                 18100000
         LA    GR5,INDCB                INPUT DCB ADDRESS               18150000
         TM    DCBOFLGS,DOPEN           IS INPUT DCB OPEN?              18200000
         BNO   CLOSOUT                  IF NOT , DONT CLOSE IT          18250000
ENDUP    EQU   *                                                        18300000
         LR    GR2,GR15                 SAVE RETURN CODE                18350000
         L     GR3,GETLEN               NUMBER OF BYTES TO FREE         18400000
         L     GR6,COREADR              ADDRESS OF GOTTEN CORE          18450000
         FREEMAIN R,LV=(GR3),A=(GR6)                                    18500000
CLOSIN   CLOSE INDCB                    CLOSE INPUT DCB                 18550000
CLOSOUT  LA    GR5,OUTDCB               POINT TO OUTPUT DCB             18600000
         NI    DCBWRITE,NOEOF           PREVENT WRITE OF EOF            18650000
         CLOSE OUTDCB                                                   18700000
         SPACE                                                          18750000
         LR    GR15,GR2                 RESTORE RETURN CODE             18800000
GOBACK   L     GR13,IPLISAV+FOUR                                        18850000
         RETURN (14,12),T,RC=(15)       RETURN WIHT PROPER CODE         18900000
*   GET A RECORD FROM THE INPUT DATA SET -- MOVE MODE.                  18950000
*   REGISTER 6 MUST POINT TO THE INPUT AREA. REG 3 COUNTS RECORDS.      19000000
*   REGISTER 9 IS THE RETURN REGISTER.                                  19050000
         SPACE                                                          19100000
GETIN    EQU   *                                                        19150000
         GET   INDCB,(GR6)                                              19200000
         LA    GR3,ONE(GR3)             INCREMENT INPUT REC COUNT       19250000
         BR    GR9                      RETURN TO CALLER.               19300000
*  END OF DATA ROUTINE IS BRANCHED TO WHEN EOF IS REACHED ON            19350000
*   INPUT.                                                              19400000
*   ON ENTRY REGISTER 3 CONTAINS THE COUNT OF INPUT RECORDS             19450000
         SPACE                                                          19500000
ENDIN    EQU   *                                                        19550000
         CH    GR3,HTHREE               MINIMUM 3 RECORDS ?             19600000
         BL    LENERR                   NO - BRANCH - TOO FEW RECORDS   19650000
         BNE   INIT5                    START INIT OF TRACK ZERO        19700000
         MVI   FLAG3,ENDCCW             SET TO STOP OUTPUT AFTER 3 REC  19750000
         B     WRITOUT                  GO WRITE OUTPUT RECS            19800000
INIT5    EQU   *                                                        19850000
         MVI   FLAG4,ENDCCW             SET TO STOP OUTPUT AFTER REC 4  19900000
         B     WRITOUT                  GO WRITE TRACK 0                19950000
NOOPEN   EQU   *                                                        20000000
         LA    GR1,MESSG5               BAD OPEN  ON OUTPUT DCB         20050000
         B     ERRSET                   GO TO ERROR                     20100000
NOOPENIN EQU   *                                                        20150000
         LA    GR1,MESSG5               MESSAGE NUMBER                  20200000
         BAL   GR9,MSGBLD               GO BUILD MESSAGE                20250000
         MVC   DISPZERO(L8,GR1),DDNAME1 PUT DDNAME IN MESSAGE           20300000
PRINTERR BAL   GR9,MSGPRNT              GO PRINT MESSAGE                20350000
         LA    GR2,RET8                 RETURN CODE                     20400000
         B     CLOSOUT                  CLOSE OUTPUT DCB AND RETURN     20450000
BADEVICE EQU   *                                                        20500000
         LA    GR1,MESSG10              INCORRECT DEVICE                20550000
ERRSET   EQU   *                                                        20600000
         BAL   GR9,MSGBLD               GO BUILD MESSAGE                20650000
         MVC   DISPZERO(L8,GR1),DDNAME2 PUT DDNAME IN MESSAGE           20700000
         B     PRINTMSG                 PRINT MSG                       20750000
BADDEV   EQU   *                                                        20800000
         LA    GR1,MESSG14              DEVICE IS SYTEM RESIDENCE       20850000
         BAL   GR9,MSGBLD               GO BUILD MESSAGE                20900000
         MVC   DISPZERO(L8,GR1),DDNAME2 PUT DD NAME IN MESSAGE          20950000
         B     PRINTMSG                 GO PRINT MESSAGE                21000000
NOTOKDEV EQU   *                        DEVICE NOT SUPPORTED            21050000
         LA    GR15,MESSG34             LOAD MESSAGE #                  21100000
         BAL   GR9,MSGBLD               GO BUILD MESSAGE                21150000
         MVC   DISPZERO(L8,GR1),DDNAME2 PUT DD NAME IN MESSAGE          21200000
         B     PRINTMSG                 GO PRINT MESSAGE                21250000
PRINTMSG EQU   *                                                        21300000
         BAL   GR9,MSGPRNT              GO PRINT MESSAGE                21350000
         LA    GR15,RET8                RETURN CODE                     21400000
         B     GOBACK                   BRANCH TO RETURN                21450000
TOMANY   EQU   *                        USER HAS >1 LABEL ON 2314       21500000
*                                       AND PURGE NOT REQUESTED         21550000
         LA    GR1,MESSG71             LOAD MESSAGE NUMBER              21600000
         BAL   GR9,MSGBLD               GO BUILD MESSAGE                21650000
         MVC   DISPZERO(L8,GR1),DDNAME2 MOVE DDNAME TO MESSAGE          21700000
         B     PRINTERR                 GO PRINT MESSAGE                21750000
LENERR   EQU   *                       INPUT NOT MIN 3 RECS OR          21800000
*                                       WRONG LENGTH RECORDS            21850000
         LA    GR1,MESSG70             LOAD MESSAGE NUMBER              21900000
         BAL   GR9,MSGBLD              GO BUILD MESSAGE                 21950000
         MVC   DISPZERO(L8,GR1),DDNAME1 PUT DDNAME IN MESSAGE           22000000
         B     ERRPRNT                 GO PRINT MESSAGE                 22050000
DOSVOLER EQU   *                        DOS VOLUME HAS VTOC ON          22100000
*                                       CYL 0 TRK 0.                    22150000
         LA    GR1,MESSG72              MESSAGE NUMBER                  22200000
         BAL   GR9,MSGBLD               GO BUILD MESSAGE                22250000
         MVC   DISPZERO(L8,GR1),DDNAME2 PUT DDNAME IN MESSAGE           22300000
         B     PRINTERR                 GO PRINT MESSAGE                22350000
* RACF AUTHORIZATION HAS FAILED PRINT MESSAGE AND TERMINATE    @G32DSPD 22351032
UNAUTH   LA    GR1,MSG66I              SET FOR MSG IEH866I     @G32DSPD 22352032
         BAL   GR9,MSGBLD              GO GET MESSAGE TEXT     @G32DSPD 22353032
         MVC   0(L'PUTIPLNM,GR1),PUTIPLNM  INDICATE PUTIPL     @G32DSPD 22354032
         MVC   20(L'DDNAME2,GR1),DDNAME2  INDICATE DDNAME      @G32DSPD 22355032
         B     PRINTMSG                GO PRINT MESSAGE        @G32DSPD 22356032
TWOO     DC    H'2'                     NO. OF ALLOWABLE USER   XM3772  22360003
*                                       VOLUME LABELS FOR 3340. XM3772  22370003
LIST     DS    0F                       FOR REAN IN JFCB                22400000
         DC    X'87'                   LIST                             22450000
         DC    AL3(0)                  LIST                             22500000
OPENLST  RDJFCB (,(OUTPUT)),MF=L       PARMAMETER LIST FOR OPEN         22550000
RACVOL   DS    CL6                      VOLSER TO RACHECK      @G32DSPD 22552032
RC8      DC    AL1(8)                   NOT DEFINED RACHECK    @G32DSPD 22562032
PUTIPLNM DC    C'PUTIPL'                IEH866I FUNCTION TEXT  @G32DSPD 22572032
         SPACE                                                          22600000
*   CHANNEL PROGRAM TO READ IN VOLUME LABEL OF OUTPUT VOLUME.           22650000
         DS    0D                                                       22700000
RDVOL1   CCW   X'31',VOL1ID,X'60',5     SEARCH ID ON VOL1 RECORD M4720  22750000
         CCW   X'08',RDVOL1,0,0         TIC                             22800000
         CCW   X'06',VOL1BUF,0,80       READ VOLUME LABEL RECORD        22850000
         SPACE                                                          22900000
*   CHANNEL PROGRAM TO LOCATE LAST LABEL OF VOLUME LABEL SET ON         22950000
*   TRACK 0. A MAXIMUM OF 8 ARE ALLOWED                                 23000000
         DS    0D                       ALIGN ON DOUBLE WORD            23050000
RDVOLX   CCW   X'31',OUTSEEK+D3,X'60',5 SEARCH ID ON VOL2-8 REC  M4720  23060000
         CCW   X'08',RDVOLX,0,0         TIC                      M4720  23070000
         CCW   X'06',VOL1BUF,X'20',4    READ VOLUME LABEL RECORD M4720  23080000
         SPACE                                                          23130000
OUTDCB   DCB   MACRF=(E),DSORG=PS,IOBAD=OUTIOB,                        X26950000
               DEVD=DA,EOEA=P8,EXLST=LIST,SIOA=P7,PGFX=YES       YM3011 27000000
         DS    0F                                                       27050000
TIOTOFF  EQU   12                       OFFSET TO TIOT          YL02912 27052002
REPLY    DS    F                        AREA FOR OPER REPLY     YL02192 27060002
DSKECB   DC    F'0'                     WTOR ECB FOR IEH852     YL02912 27070002
OUTECB   DC    F'0'                     ECB                             27100000
OUTIOB   DS    0F                       IOB                             27150000
OUTFLAG1 DC    XL1'42'                  CMD CHAIN, UNRELATED            27200000
OUTFLAG2 DC    XL1'00'                  IOB FLAG BYTE 2                 27250000
OUTSENS  DC    H'0'                     SENSE BYTES                     27300000
OUTECBA  DC    A(OUTECB)                ECB ADDRESS                     27350000
OUTSTAT  DC    2F'0'                    CSW STATUS                      27400000
OUTCCWA  DC    A(RDVOLX)                ADDR OF CCW LIST         M4720  27450000
OUTDCBA  DC    A(OUTDCB)                ADDR OF DCB                     27500000
         DC    F'0'                     RESTART ADDRESS                 27550000
         DC    H'1'                     BLK CNT INCREMENT               27600000
         DC    H'0'                     ERROR COUNT                     27650000
OUTSEEK  DC    2F'0'                    MBBCCHHR                        27700000
*   CCWS TO WRITE THREE TO FIVE RECORDS ON TRACK ZERO, CYL ZERO.        27750000
         SPACE                                                          27800000
CCWOUT   DS    0D                                                       27850000
         DC    X'31'                    SEARCH R1 ID EQUAL              27900000
         DC    AL3(SIDR1)               ADDR                            27950000
         DC    X'60000005'              FLAGS                           28000000
         DC    X'08'                    TIC                             28050000
         DC    AL3(CCWOUT)              ADDR                            28100000
         DC    F'0'                     DUMMY                           28150000
ADDR1    DC    X'05'                    WRITE DATA                      28200000
         DC    AL3(0)                   ADDR                            28250000
         DC    X'40000018'              FLAGS                           28300000
CCWOUT2  DC    X'31'                    SEARCH ID OF REC 2              28350000
         DC    AL3(SIDR2)               ADDR                            28400000
         DC    X'60000005'              FLAGS                           28450000
         DC    X'08'                    TIC                             28500000
         DC    AL3(CCWOUT2)             ADDR                            28550000
         DC    F'0'                     DUMMY                           28600000
ADDR2    DC    X'05'                    WRITE DATA                      28650000
         DC    AL3(0)                   ADDR                            28700000
         DC    X'40000090'              FLAGS                           28750000
CCWOUTS  DC    X'31'                    SEARCH ID OF LAST VOL LABEL     28800000
         DC    AL3(SLAST)               ADDR                            28850000
         DC    X'60000005'              FLAGS                           28900000
         DC    X'08'                    TIC                             28950000
         DC    AL3(CCWOUTS)             ADDR                            29000000
         DC    F'0'                     DUMMY                           29050000
CCWOUT3  DC    X'1D'                    WRITE THIRD OUTPUT RECORD       29100000
         DC    AL3(IPLCK3)              ADDR                            29150000
         DC    X'A0000008'              FLAGS                           29200000
ADDR3    DC    X'1D'                    CHAIN DATA                      29250000
         DC    AL3(0)                   ADDR                            29300000
FLAG3    DC    X'4000'                  FLAGS                           29350000
DLEN3    DC    H'0'                     DATA LENGTH                     29400000
         SPACE                                                          29450000
CCWOUT4  DC    X'1D'                    WRITE FOURTH OUTPUT RECORD      29500000
         DC    AL3(IPLCK4)              ADDR                            29550000
         DC    X'A0000008'              FLAGS                           29600000
ADDR4    DC    X'1D'                    CHAIN DATA                      29650000
         DC    AL3(0)                   ADDR                            29700000
FLAG4    DC    X'4000'                  FLAGS                           29750000
DLEN4    DC    H'0'                     DATA LENGTH                     29800000
         SPACE                                                          29850000
CCWOUT5  DC    X'1D'                    WRITE FIFTH OUT PUT RECORD      29900000
         DC    AL3(IPLCK5)              ADDR                            29950000
         DC    X'A0000008'              FLAGS                           30000000
ADDR5    DC    X'1D'                    CHAIN DATA                      30050000
         DC    AL3(0)                   ADDR                            30100000
         DC    X'0000'                  FLAGS                           30150000
DLEN5    DC    H'0'                     DATA LENGTH                     30200000
*   COUNT AND KEY FIELDS FOR OUTPUT TO CYL 0 TRACK 0.                   30250000
         SPACE                                                          30300000
IPLCK1   DC    XL8'0000000001040018'    COUNT FIELD IPL1                30350000
IPLK1    DC    CL4'IPL1'                KEY IPL1                        30400000
IPLCK2   DC    XL8'0000000002040090'    COUNT IPL2                      30450000
IPLK2    DC    CL4'IPL2'                KEY IPL2                        30500000
IPLCK3   DC    XL4'00000000'            CCHH                            30550000
IPLCK3R  DC    X'00'                    REC NO.                         30600000
IPLCHKL3 DC    X'00'                    KEY LENGTH                      30650000
IPLCK3L  DC    X'0000'                  DATA LENGTH                     30700000
IPLK3    DC    CL4'IPL3'                KEY VALUE FOR IPL3              30710000
         SPACE                                                          30750000
IPLCK4   DC    XL4'00000000'            CCHH                            30800000
IPLCK4R  DC    X'00'                    REC NO.                         30850000
IPLCHKL4 DC    X'00'                    KEY LENGTH                      30900000
IPLCK4L  DC    X'0000'                  DATA LENGTH                     30950000
IPLK4    DC    CL4'IPL4'                KEY VALUE FOR IPL4              30960000
         SPACE                                                          31000000
IPLCK5   DC    XL4'00000000'            CCHH                            31050000
IPLCK5R  DC    X'00'                    REC. NO.                        31100000
IPLCHKL5 DC    X'00'                    KEY LENGTH                      31150000
IPLCK5L  DC    X'0000'                  DATA LENGTH                     31200000
IPLK5    DC    CL4'IPL5'                KEY VALUE FOR IPL5              31210000
         SPACE                                                          31250000
INDCB    DCB   BLKSIZE=3072,DSORG=PS,EODAD=ENDIN,                      X31300000
               MACRF=GM,RECFM=U                                         31350000
NAME     DC    C'PUTIPL OF'             MODULE NAME CONSTANT            31400000
NAMELEN  EQU   *-NAME                   LENGTH OF NAME                  31450000
VOL1BUF  DS    20F                      VOLUME LABEL BUFFER             31500000
VOL1ID   DC    XL5'0000000003'          ID OF VOLUME LABEL              31550000
VOL1     DC    CL4'VOL1'                KEY OF VOLUME LABEL             31600000
VOL2     DC    CL4'VOL2'                KEY OF VOL2 LABEL               31650000
VOL3     DC    CL4'VOL3'                KEY OF VOL3 LABEL               31700000
VOL4     DC    CL4'VOL4'                KEY OF VOL4 LABEL               31750000
VOL5     DC    CL4'VOL5'                KEY OF VOL5 LABEL               31800000
VOL6     DC    CL4'VOL6'                KEY OF VOL6 LABEL               31850000
VOL7     DC    CL4'VOL7'                KEY OF VOL7 LABEL               31900000
VOL8     DC    CL4'VOL8'                KEY OF VOL8 LABEL               31950000
SEARCHAD DC    XL5'00'                  SEARCH ADDRESS                  32000000
IPLISAV  DS    18F                      SAVE AREA                       32050000
WRDCBAD  DC    A(OUTDCB)                ADDR                            32100000
GETLEN   DC    F'8000'                  LENGTH FOR GETMAIN FOR INPUT    32150000
*                                       BUFFER                          32200000
SIDR1    DC    XL5'0000000001'          SEARCH ARGUMENT FOR CCW         32250000
SIDR2    DC    XL5'0000000002'          SEARCH ARGUMENT                 32300000
SLAST    DC    XL5'00'                  SEARCH ARGUMENT FOR OUTPUT CCW  32350000
HEIGHT   DC    H'8'                     HALFWORD - VALUE 8              32400000
TWFOUR   DC    F'24'                    FULLWORD VALUE 24               32450000
ONE44    DC    H'144'                   HALFWORD VALUE 144              32500000
HTHREE   DC    H'3'                     HALFWORD VALUE THREE            32550000
FFOUR    DC    F'4'                     FULLWORD VALUE FOUR      M4720  32560000
HFIVE    DC    H'5'                     HALFWORD VALUE 5                32600000
LEN08    DC    H'8'                     HALFWORD VALUE 8                32650000
TWOK     DC    H'2048'                  USED FOR LRECL COMPARE          32700000
ZERODATA DC    CL8'0'                   FULLWORD                        32750000
COREADR  DS    F                        SAVE ADDR OF GOTTEN CORE HERE   32800000
PATCHA   DS    50F                      PATCH AREA FOR PROGRAM          32850000
         EJECT                                                          32900099
         IEHDBLKS                                                       32907099
         EJECT                                                          32914099
         IEHDWORK                                                       32921099
         EJECT                                                          32928099
         ICHPRCVT                                              @ZA25515 32935099
         EJECT                                                          32942099
         IECDSECS CVT,TIOT,EXPAND=YES                                   32960002
UCB      DSECT                                                          33000000
         IEFUCBOB                                                       33050000
JFCB     DSECT                                                          33100000
         IEFJFCBN                                                       33150000
         DCBD  DSORG=PS                                                 33200000
VOLX     DSECT                          FOR VOL2 - 8 CONSTANTS   M4720  33210000
         DS    CL4                                               M4720  33230000
         END                                                            33250000
./  ADD  SSI=80130042,NAME=IEHDLABL
         TITLE 'IEHDLABL - PERFORMS LABEL FUNCTION  IEHDASDR UTILITY'   00302121
         COPY  LCGASMSW                                                 00302421
IEHDLABL CSECT                                                          00304000
*********************************************************************** 00310099
*                                                                       00315099
*                     FIXES THIS MODULE                                 00320099
*                     LATEST FIRST.                                     00325099
*                                                                       00330099
*********************************************************************** 00335099
*                                                                       00340099
*D 66000                                  SU32 ONLY            @ZA25515 00342099
*C 113000                                 SU32 ONLY            @ZA25515 00345099
*A 112000-112500                          SU32 ONLY            @ZA25515 00348099
*A 217160-217190,753100                   SU32 ONLY            @ZA25515 00355099
*                                                                       00360099
*  NO DELETION                            SU32                 @G32DSPD 00365099
*                                                                     * 00370099
*003600,011900,012300,212500,318200                                O122 00375099
*                                                                     * 00380099
*STATUS- CHANGE LEVEL 001                                          O122 00385099
*********************************************************************** 00390099
      EJECT                                                             00395099
*FUNCTION/OPERATION- THIS ROUTINE HANDLES THE -LABEL- FUNCTION        * 00420016
*   OF THE IEHDASDR SYSTEM UTILITY PROGRAM. LABEL CONSISTS OF         * 00450016
*   WRITING A NEW VOLUME SERIAL NUMBER ON A SPECIFIED DIRECT          * 00480016
*   ACCESS DEVICE. IN ADDITION, IT WILL OPTIONALLY ADD AN OWNER       * 00510016
*   NAME TO THE VOLUME LABEL RECORD.                                  * 00540016
*   RACF AUTHORIZATION IS REQUIRED ON THOSE VOL IDS THAT ARE   @G32DSPD 00540532
*   DEFINED TO RACF.                                           @G32DSPD 00550532
*                                                                     * 00570016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDLABL-, AND CONTROL        * 00600016
*   IS ALWAYS RECEIVED FROM THE MONITOR MODULE IEHDASDS.              * 00630016
*                                                                     * 00660016
*INPUT- POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL          * 00690016
*   BLOCK (REGISTER 10).                                              * 00720016
*   DATA IS ON A DIRECT ACCESS DEVICE. ONLY THE VOLUME LABEL          * 00750016
*   RECORD (RECORD 3 ON TRACK 0) WILL BE READ.                        * 00780016
*                                                                     * 00810016
*EXITS- NORMAL- A SUCCESSFUL LABEL OPERATION RESULTS IN A RETURN      * 00840016
*   TO THE MONITOR(IEHDASDS) WITH A RETURN CODE OF 0. A LABEL         * 00870016
*   COMPLETE MESSAGE IS ALSO PLACED IN THE MESSAGE DATA SET.          * 00900016
*                                                                     * 00930016
*EXITS- ERROR- ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROPRIATE   * 00960016
*   MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER THAN       * 00990016
*   ZERO WILL ALSO BE PASSED BACK TO THE MONITOR.                     * 01020016
*                                                                     * 01050016
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS ENTERED FROM THE           * 01080016
*   MONITOR MODULE IEHDASDS. FOUR OTHER CSECTS ARE USED BY THIS       * 01110016
*   ROUTINE. ANY MESSAGES ISSUED WILL BE FORMULATED BY THE MESSAGE    * 01140016
*   ROUTINE (IEHDMSGB) AND PRINTED BY THE PRINT ROUTINE (IEHDPRNT)    * 01170016
*   THE END OF EXTENT APPENDAGE (IGG019P8) HANDLES THE LIMITS AND  O122 01190019
*   EXTENTS IN THE DEB FOR ALL DA DEVICES INVOLVED. IGC0008B (SVC 82) * 01210016
*   ENTERS THE NEW VOLUME SERIAL NUMBER INTO THE UCB, AND FOR AN   O122 01220019
*   OFFLINE LABEL FUNCTION WILL REQUEST OPERATOR CONFIRMATION AND  O122 01230019
*   BUILD A DEB IN PROTECTED CORE.                                 O122 01240019
*                                                                     * 01260016
*TABLES/WORK AREAS- UPON ENTRY REGISTERS 10 AND 12 POINT TO A         * 01290016
*   FUNCTION BLOCK AND A WORK AREA RESPECTIVELY. THEY ARE DESCRIBED   * 01320016
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 01350016
*                                                                     * 01380016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE.                          * 01410016
*                                                                     * 01440016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             01500016
GR0      EQU   0                                                        01800016
GR1      EQU   1                                                        02100016
GR2      EQU   2                                                        02400016
GR3      EQU   3                                                        02700016
GR4      EQU   4                                                        03000016
GR5      EQU   5                                                        03300016
GR6      EQU   6                                                        03600016
GR7      EQU   7                                                        03900016
GR8      EQU   8                                                        04200016
GR9      EQU   9                                                        04500016
GR10     EQU   10                                                       04800016
GR11     EQU   11                                                       05100016
GR12     EQU   12                                                       05400016
GR13     EQU   13                                                       05700016
GR14     EQU   14                                                       06000016
GR15     EQU   15                                                       06300016
UCBPTR   EQU   9                                                        06900016
BASEREG  EQU   11                                                       07200016
WORKBASE EQU   12                                                       07500016
         USING FUNCBLK,10                                               07800016
         USING IEHDLABL,BASEREG                                         08100016
         USING WORK,12                                                  08400016
         SAVE  (14,12),T,*             SAVE THE REGISTERS               08700016
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          09000016
         LA    GR7,LABLSAVE            SAVE AREA ADDRESS.               09300016
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      09600016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      09900016
         LR    GR13,GR7                LOAD SAVE AREA ADDRESS.          10200016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA25515 11200099
         DC    C'SU32 OZ25515'         LAST FIX THIS MODULE    @ZA25515 11250099
APARNO   L     GR8,RDDCBAD             POINTER TO DCB          @ZA25515 11300099
         USING IHADCB,8                                                 12200016
         L     UCBPTR,TUCBPTR          PICK UP POINTER TO UCB           14600016
         USING UCB,9                                                    20400016
         LA    GR4,0                   INITIALIZE BIN NO. TO 0          20500016
         ST    GR4,RDSEEK                                               20600016
         AIF   ('&LIB' EQ 'LIB2').X234300                       XL03912 20650005
         CLI   UCBID,X'FF'             IS THIS MAIN UCB                 20700016
         BNE   PASSBY                  NO-GO PICK UP BIN NUMBER         20800016
.X234300 ANOP                                                   XL03912 20850005
         TM    UCBTBYT3,UCB3DACC       IS THIS A DIRECT ACCESS DEVICE   20900016
         BZ    BADPARM                 NO--MUST BE BAD PARAMETER.       21000016
         TM    SRTESTAT,SRTESYSR       THIS A SYSTEMS RESIDENCE VOLUME  21100016
         BO    BADDEV                  YES - NOT ALLOWED                21200016
CHKMORE  EQU   *                                                   O122 21206019
         CLI   DDNAME2,X'40'           OFFLINE LABEL REQUEST.      O122 21212019
         BNE   SKIP                    NO-NO NEED TO CHECK FURTHER.O122 21218019
         TM    SRTESTAT-UCBOB(UCBPTR),SRTEONLI  YES-DEVICE ONLINE. O122 21224019
         BO    ONLINERR                YES-SET UP ERROR MESSAGE.   O122 21230019
         LA    GR1,RDAREA              ADDR. OF AREA FOR LIST.     O122 21236019
         ST    UCBPTR,0(GR1)           STORE UCB PTR. IN LIST.     O122 21242019
         MVI   0(GR1),X'8F'            SET UP BUILD DEB INDICATOR. O122 21248019
         ST    GR8,4(GR1)              STORE DCB PTR. IN LIST.     O122 21254019
         MVI   4(GR1),X'88'            SET LAST ENTRY INDICATOR.   O122 21260019
         SVC   POST                    CONSTRUCT DEB.              O122 21266019
         LTR   GR15,GR15               WAS DEB SUCCESSFULLY BUILT. O122 21272019
         BNZ   ONLINERR                NO-SET UP ERROR MESSAGE.    O122 21278019
         ST    GR10,DCBIOBAD           FUNCTION BLK PTR TO DCB.    O122 21284019
         B     READ                    GO TO READ IN OLD LABEL.    O122 21290019
         AIF   ('&LIB' EQ 'LIB2').X234301                       XL03912 21292005
         DROP  9                                                        21300016
         USING DCELBBNR,9                                               21400016
PASSBY   MVC   RDSEEK+1(2),DCELBBNR    PICK UP BIN NO. FOR 2321         21500016
         B     CHKMORE                 CHECK IF OFFLINE REQUEST.   O122 21550019
.X234301 ANOP                                                   XL03912 21560005
SKIP     EQU   *                                                YL02912 21650002
*********************************************************************** 21655032
*     THIS SECTION OF CODE PERFORMS RACF SECURITY CHECKING.IF THE NEW * 21660032
*  VOLID IS RACF DEFINED, THE USER MUST HAVE ALTER ACCESS TO IT. IF   * 21665032
*  THE OLD VOLID IS RACF DEFINED THE USER MUST HAVE ALTER ACCESS TO   * 21670032
*  IT. NO SECURITY CHECKING WILL TAKE PLACE IT RACF IS NOT ACTIVE IN  * 21675032
*  THE SYSTEM.                                                 @G32DSPD 21680032
*********************************************************************** 21685032
         L     GR5,CVTPTR              GET CVTPTR              @G32DSPD 21690032
         USING CVT,GR5                                         @G32DSPD 21695032
         L     GR5,CVTRAC              GET RACF POINTER        @G32DSPD 21700032
         DROP  GR5                                             @G32DSPD 21705032
         LTR   GR5,GR5                 IS RACF ACTIVE ?        @G32DSPD 21710032
         BZ    NULLRACF                NO,SKIP RACF CHECKS     @G32DSPD 21715032
         USING RCVT,GR5                DO CHECK IF RACF IS     @ZA25515 21716099
         TM    RCVTSTA1,RCVTDASD       CURRENT.                @ZA25515 21717099
         BZ    NULLRACF                NO DONT RACHECK         @ZA25515 21718099
         DROP  GR5                     YES DO RACHECK          @ZA25515 21719099
*  TEST THE OLD VOLID FOR RACF SECURITY                        @G32DSPD 21720032
         MVC   RACVOL,UCBVOLI                                  @G32DSPD 21725032
         RACHECK ATTR=ALTER,ENTITY=RACVOL,CLASS='DASDVOL'      @G32DSPD 21730032
         CLM   GR15,B'0001',RC8        USER UNAUTHORIZED ?     @G32DSPD 21735032
         BE    UNAUTH                  YES,GO TERMINATE        @G32DSPD 21740032
*  TEST THE NEW VOLID FOR RACF SECURITY                        @G32DSPD 21745032
         MVC   RACVOL(6),SERNO                                 @G32DSPD 21750032
         RACHECK ATTR=ALTER,ENTITY=RACVOL,CLASS='DASDVOL'      @G32DSPD 21755032
         CLM   GR15,B'0001',RC8        USER UNAUTHORIZED ?     @G32DSPD 21760032
         BE    UNAUTH                  YES,GO TERMINATE        @G32DSPD 21765032
NULLRACF EQU   *                                               @G32DSPD 21770032
*   END RACF AUTHORIZATION CHECKS.                             @G32DSPD 21775032
         SPACE 2                                               @G32DSPD 21780032
         MVC   REQUEST+VOL(L6),SRTEVOLI SET VOLID TO MSG.       YL02912 21800002
         DROP  GR9                                              YL02912 21850002
         L     GR9,CVTPTR               GET ADDRESS OF CVT.     YL02912 21860002
         USING CVT,GR9                                          YL02912 21870002
         L     GR9,CVTTCBP              GET PTR TO TCB ADDRESS. YL02912 21880002
         L     GR9,D4(GR9)              GET TCB ADDRESS.        YL02912 21890002
         L     GR9,D12(GR9)             GET TIOT ADDRESS.       YL02912 21892002
         MVC   REQUEST+JJJ(L8),D0(GR9)  SET JOB NAME TO MSG.    YL02912 21894002
         MVC   REQUEST+SSS(L8),D8(GR9)  SET STEP NAME TO MSG.   YL02912 21896002
REQUEST  WTOR  'IEH853D CONFIRM REQUEST TO LABEL CURRENT VOLID=      . *21898002
               JJJJJJJJ,SSSSSSSS.',REPLY,1,WTORECB,ROUTCDE=(4),DESC=(2) 21898402
         TM    WTORECB,COMPLETE         IS OPERATION COMPLETE?  YL02912 21898802
         BO    TESTANSW                 YES,GO CHECK ANSWER.    YL02912 21899202
         WAIT  ECB=WTORECB              NO, AWAIT COMPLETION.   YL02912 21899602
TESTANSW MVI   WTORECB,ZERO             CLEAR ECB POST BITS.    YL02912 21899702
         CLI   REPLY,C'U'               REPLY EQUAL 'U'?        YL02912 21899802
         BE    USE                      YES, CONTINUE LABEL.    YL02912 21899902
         CLI   REPLY,C'T'               REPLY EQUAL 'T'?        YL02912 21949902
         BE    TERM                     YES, TERMINATE.         YL02912 21959902
         MVC   ERRANS+ERJJ(L8),D0(GR9)  SET JOB NAME TO MSG.    YL02912 21969902
         MVC   ERRANS+ERSS(L8),D8(GR9)  SET STEP NAME TO MSG.   YL02912 21979902
ERRANS   WTO   'IEH808I REPLY IN ERROR. REPLY WITH  U  OR  T , JJJJJJJJ*21989902
               ,SSSSSSSS.',ROUTCDE=(4),DESC=(5)                 YL02912 21991902
         B     REQUEST                  GO WRITE REQUEST AGAIN. YL02912 21993902
         DROP  GR9                                              YL02912 21995902
         EJECT                                                          21997902
*********************************************************************** 21999902
*                                                                     * 22200016
*  THIS ROUTINE OPENS THE DATA CONTROL BLOCKS FOR ALL DIRECT ACCESS   * 22500016
*     DEVICES INVOLVED. THE OPEN IS ALWAYS PERFORMED ON THE FORMAT    * 22800016
*     FOUR DSCB OF THE VTOC.                                          * 23100016
*                                                                     * 23400016
*********************************************************************** 24000016
USE      EQU   *                                                        24010002
         MVC   DCBDDNAM(8),DDNAME2     PUT DDNAME IN DCB                24050002
         MVC   OPENLD+1(3),RDDCBAD+1   MOVE DCB ADDRESS TO LIST         24100016
OPENJ    LA    GR9,RDAREA    BUFFER ADDRESS TO READ JFCB.               24300016
         ST    GR9,LIST                                                 24600016
         MVI   LIST,X'87'              EXIT LIST CODE                   24700016
         RDJFCB MF=(E,OPENLD)                                           24900016
         USING JFCB,9                                                   25200016
         MVI   JFCBDSNM,X'04'          SET DSNAME FIELD FOR             25500016
         MVC   JFCBDSNM+1(43),JFCBDSNM   FORMAT 4 DSCB.                 25800016
         MVI   JFCBTSDM,X'08'          STOP WRITE OF JFCB AT OPEN       25900016
         OPEN  MF=(E,OPENLD),TYPE=J                                     26100016
         TM    DCBOFLGS,X'10'          WAS THERE A SUCCESSFUL OPEN.     27000016
         BZ    NOOPEN                  NO--GIVE AN ERROR MESSAGE        27300016
         NI    DCBMACRF+1,X'F3'        SET BITS OFF TO PREVENT CLOSE    27600016
*                                        FROM WRITING AN EOF RECORD     27900016
*                                        AND UPDATING THE DSCB.         28200016
         ST    GR10,DCBIOBAD           FUNCTION BLOCK ADDRESS IN DCB    28300016
         EJECT                                                     O122 28310019
*********************************************************************** 28320016
*                                                                     * 28340016
*  THIS ROUTINE READS THE VOLUME LABEL, ENTERS THE NEW VOLUME SERIAL  * 28360016
*     NUMBER, AND OWNER ID IF ANY, AND WRITES OUT THE NEW LABEL ONTO  * 28380016
*     THE VOLUME.                                                       28400016
*                                                                     * 28420016
*********************************************************************** 28440016
         DROP  9                                                        28480016
READ     EQU   *                                                   O122 28500019
         LA    GR5,RDAREA              SET UP READ/WRITE AREA           28520016
         ST    GR5,RDWRTCCW                IN CHANNEL PROGRAM           28540016
         MVI   RDWRTCCW,6              SRT OP CODE FOR READ             28560016
         MVI   RDWRTCCW+4,X'20'                                         28570016
         EXCP  RDIOB                   READ VOLUME LABLE                28580016
         BAL   GR4,WAITD               AWAIT COMPLETION OF I/O          28600016
         MVI   POSTSW,X'00'            INITIALIZE SWITCH                28606016
         CLI   DDNAME2,X'40'           OFFLINE LABEL REQUEST.      O122 28608019
         BE    NOSET                   YES-CONTINUE PROCESSING.    O122 28610019
         CLC   RDAREA+4(6),SERNO       IS NEW LABEL SAME AS OLD         28612016
         BNE   NOSET                   NO-UCB CAN BE POSTED             28618016
         MVI   POSTSW,X'01'            YES-SET SWITCH TO PREVENT POST   28624016
NOSET    MVC   RDAREA+4(6),SERNO       MOVE IN NEW SERIAL NUMBER        28630016
         TM    SEQSW,OWNERID           IS OWNER ID SPECIFIED            28640016
         BZ    WRITEOUT                NO - GO WRITE VOLUME LABEL       28660016
         MVC   RDAREA+41(10),OWNID     MOVE IN NEW OWNERID              28680016
WRITEOUT MVI   RDWRTCCW,5              SET OP CODE FOR WRITE            28700016
         MVI   RDWRTCCW+4,X'60'                                         28710016
         EXCP  RDIOB                   WRITE VOLUME LABEL               28720016
         BAL   GR4,WAITD               AWAIT COMPLETION OF I/O          28740016
         CLI   POSTSW,X'01'            SHOULD NEW SERIAL NO GO IN UCB   28743016
         BE    FINISH                  NO-GO RETURN CONTROL             28746016
         CLI   DDNAME2,X'40'           OFFLINE LABEL REQUEST.      O122 28746219
         BNE   POSTA                   NO-CONTINUE.                O122 28746419
         LA    GR1,RDAREA              AREA FOR LIST.              O122 28746619
         LA    GR2,SERNO               PTR. TO NEW SERIAL NUMBER.  O122 28746819
         MVC   0(4,GR1),TUCBPTR        UCB PTR. TO LIST.           O122 28747019
         MVI   0(GR1),X'88'            SET SPECIAL POST INDICATOR. O122 28747219
         ST    GR2,4(GR1)              PTR. TO NEW SERIAL NO.      O122 28747419
         SR    GR2,GR2                 CLEAR REGISTER.             O122 28747619
         ST    GR2,8(GR1)              ZERO VTOR PTR. IN LIST.     O122 28747819
         MVC   12(4,GR1),DCBDEBAD      DEB PTR. TO LIST.           O122 28748019
         MVI   12(GR1),X'80'           SET LAST ENTRY INDICATOR.   O122 28748219
         B     POSTB                   GO POST THE UCB.            O122 28748419
POSTA    EQU   *                                                   O122 28748619
         MVC   PARMLIST+1(3),TUCBPTR+1 PUT UCB POINTER IN LIST SVC      28749016
         LA    GR1,SERNO               PUT ADDRESS OF NEW SERIAL        28752016
         ST    GR1,PARMLIST+4              NUMBER IN LIST FOR SVC       28755016
         LA    GR1,PARMLIST            PUT ADDRESS OF LIST IN REGISTER  28758016
POSTB    EQU   *                                                   O122 28759019
         SVC   POST                                                     28761016
FINISH   LA    GR1,6                   SET UP SUCCESSFUL COMPLETION     28770016
*                                         MESSAGE                       28780016
         BAL   GR9,MSGBLD                                               28782016
         MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            28784016
         MVC   40(6,GR1),SERNO         PUT SERIAL NO IN MESSAGE         28786016
         MVC   MESS+8(8),NAME          PUT MODULE NAME IN MESSAGE       28788016
         LA    GR9,GOODRTN                                              28790016
         B     MSGPRNT                 GO PRINT MESSAGE                 28792016
**********************************************************************  28800016
*                        WAIT           ROUTINE                       * 28900016
**********************************************************************  29000016
WAITD    TM    DISKECB,COMPLETE        IS THE OPERATION COMPLETE.       29100016
         BO    TESTD                   YES-GO TEST THE STATUS.          29400016
         WAIT  ECB=DISKECB             AWAIT COMPLETION OF DISK.        29700016
TESTD    CLI   DISKECB,GOOD            ALL OK.                          30000016
         BNE   IOERR                   NO--I/O ERROR.                   30300016
         MVI   DISKECB,0               CLEAR POSTED BITS IN THE ECB.    30600016
         BR    GR4                     RETURN.                          30900016
*********************************************************************** 30930016
*                                                                     * 30960016
*  THIS SECTION WRITES OUT MESSAGES, SETS RETURN CODES, AND RETURNS   * 30990016
*     CONTROL.                                                        * 31020016
*                                                                     * 31050016
*********************************************************************** 31080016
TERM     EQU   *                                                YL02912 31090002
         LA    GR1,MESS57               INDICATE LABEL DENIED.  YL02912 31100002
         BAL   GR9,MSGBLD               GO BUILD MESSAGE.       YL02912 31102002
         MVC   D0(L8,GR1),DDNAME2       PUT DDNAME IN MSG.      YL02912 31104002
         B     ERRPRNT                  PRT MSG AND TERMINATE.  YL02912 31106002
NOOPEN   LA    GR1,5                   BAD OPEN                         31110016
         B     ERRSET                                                   31140016
BADPARM  LA    GR1,10                  INCORRECT DEVICE                 31170016
ERRSET   BAL   GR9,MSGBLD              GO BUILD MESSAGE                 31200016
         MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            31230016
         B     ERRPRNT                 GO PRINT MESSAGE                 31260016
BADDEV   LA    GR1,14                  IS SYSTEM RESIDENCE VOLUME       31290016
         BAL   GR9,MSGBLD              GO BUILD MESSAGE                 31320016
         MVC   0(8,GR1),DDNAME2        PUT DDNAME IN MESSAGE            31350016
         MVC   MESS+8(8),NAME          PUT MODULE NAME IN MESSAGE       31380016
         B     ERRPRNT                 GO PRINT MESSAGE                 31410016
ONLINERR EQU   *                                                   O122 31413019
         LA    GR1,24                  MESSAGE NUMBER.             O122 31416019
         BAL   GR9,MSGBLD              GO BUILD MESSAGE.           O122 31419019
         MVC   0(8,GR1),DDNAME2        DDNAME TO MESSAGE.          O122 31422019
         MVC   MESS+9(6),NAME          MOVE LABEL KEYWORD          O122 31425019
         MVC   MESS+15(1),MESS+14            INTO THE MESSAGE.     O122 31428019
         B     ERRPRNT                 PRINT MESSAGE AND TERMINATE.O122 31431019
* RACF AUTHORIZATION NOT HELD BY USER PRINT MSG AND TERMINATE  @G32DSPD 31431432
UNAUTH   LA    GR1,MESS66             SET FOR MSG IEH866I      @G32DSPD 31431832
         BAL   GR9,MSGBLD             GET MESSAGE TEXT         @G32DSPD 31432232
         MVC   0(L'LABELNM,GR1),LABELNM INDICATE LABEL FUNCT.  @G32DSPD 31432632
         MVC   20(L'DDNAME2,GR1),DDNAME2 INSERT DDNAME         @G32DSPD 31433032
         B     ERRPRNT                GO TERMINATE             @G32DSPD 31433432
         EJECT                                                     O122 31434019
IOERR    LA    GR1,13                  I/O ERROR                        31440016
         BAL   GR9,MSGBLD              GO BUILD MESSAGE                 31470016
         SYNADAF ACSMETH=EXCP,PARM1=RDIOB                               31500016
         MVC   MESS+22(78),49(GR1)     PUT I/O INFO IN BUFFER    SM4350 31530021
         SYNADRLS                                                       31560016
ERRPRNT  BAL   GR9,MSGPRNT             GO PRINT ERROR MESSAGE           31590016
SETCODE  LA    GR2,8                   SET UP RETURN CODE/ERROR  XM1377 31800001
ENDUP    EQU   *                                                   O122 31808019
         CLI   DDNAME2,X'40'           OFFLINE LABEL REQUEST.      O122 31816019
         AIF   ('&LIB' EQ 'LIB1').X227107                               31816502
         BNE   CKDCB                    NO, TEST DCB.            YM3475 31817002
         CLC   DCBDEBAD(4),BLANKS       WAS DEB REMOVED?         YM3475 31817502
         BE    AROUND                   YES, GO RETURN.          YM3475 31818002
         LA    GR1,RDAREA               AREA FOR LIST.           YM3475 31818502
         MVI   0(GR1),DELDEB            DELETE DEB REQUEST.      YM3475 31819002
         MVC   12(4,GR1),DCBDEBAD       DEB ADDR INTO LIST       YM3475 31819502
         MVI   12(GR1),PARMEND          SET LAST ENTRY IND.      YM3475 31820002
         SVC   POST                     GO DELETE DEB.           YM3475 31820502
         B     AROUND                   SKIP CLOSE               YM3475 31821002
CKDCB    EQU   *                                                 YM3475 31821502
         AGO   .X227108                                          YM3475 31822002
.X227107 ANOP                                                    YM3475 31822502
         BE    AROUND                  YES-NO FURTHER CHECKING.    O122 31824019
.X227108 ANOP                                                    YM3475 31828002
         TM    DCBOFLGS,X'10'          NO-WAS DATA SET OPENED.     O122 31832019
         BZ    AROUND                  NO- SKIP  CLOSE                  31840016
         CLOSE ((8))                   CLOSE DATA SET                   31880016
AROUND   EQU   *                                                 YM5579 31890001
         LR    GR15,GR2                PUT RETURN CODE BACK IN REG 15   31900016
         L     GR13,LABLSAVE+4         RESTORE REGISTER 13       YM5579 31920001
         RETURN (14,12),T,RC=(15)      RETURN WITH PROPER CODE          32000016
         EJECT                                                     O122 32100019
MSGBLD   LINK  EP=IEHDMSGB             GO CONSTRUCT MESSAGE             32200016
         BR    GR9                                                      32400016
MSGPRNT  LINK  EP=IEHDPRNT             GO PRINT MESSAGE                 32600016
         BR    GR9                                                      32800016
GOODRTN  LA    GR2,0                   SUCCESS COMPLETION CODE   YM5579 33000001
         L     GR3,PTRCFUNC            PICK UP POINTER TO CURRENT FUNC. 33300016
         MVI   0(GR3),COMPLETE         SET COMPLETE BIT FOR FUNCTION.   33400016
         B     ENDUP                                                    33500016
LIST     DS    0F            FOR READ IN JFCB                           33900016
         DC    X'87'                                                    34200016
         DC    AL3(0)                                                   34500016
OPENLD   RDJFCB (,(OUTPUT)),MF=L       PARAMETER LIST FOR OPEN          34560016
PARMLIST DC    X'08'                   PARAMETER LIST FOR SVC           34620016
         DC    AL3(0)                     TO POST UCB                   34680016
         DC    F'0'                                                     34740016
         DC    X'80'                                                    34800016
         DC    AL3(0)                                                   34860016
POSTSW   DC    X'00'                   SWITCH TO INDICATE POST UCB      34920016
POST     EQU   82                                                       34980016
RACVOL   DS    CL6                      VOLSER ENTITY          @G32DSPD 34980532
RC8      DC    AL1(8)                   RETURN CODE 8          @G32DSPD 34982032
         AIF   ('&LIB' EQ 'LIB1').X227106                        YM3475 35000002
DELDEB   EQU   X'F8'                    DEB DELETE REQUEST.      YM3475 35020002
PARMEND  EQU   X'80'                    END OF PARM LIST IND.    YM3475 35040002
BLANKS   DC    X'40404040'              OFFLINE DDNAME END.      YM3475 35060002
LABELNM  DC    C'LABEL'                 FUNCTION FOR IEH866I   @G32DSPD 35060532
.X227106 ANOP                                                    YM3475 35080002
D0       EQU   0                        DISPLACEMENT VALUE 0    YL02912 35090002
D4       EQU   4                        DISPLACEMENT VALUE 4    YL02912 35092002
D8       EQU   8                        DISPLACEMENT VALUE 8    YL02912 35094002
D12      EQU   12                       DISPLACEMENT VALUE 12   YL02912 35096002
MESS66   EQU   66                       IEH866I OFFSET         @G32DSPD 35096532
L6       EQU   6                        LENGTH VALUE OF 6.      YL02912 35097232
L8       EQU   8                        LENGTH VALUE OF 8.      YL02912 35097932
ZERO     EQU   0                        IMMEDIATE CONSTANT.     YL02912 35098802
MESS57   EQU   57                       MESSAGE IEH857I.        YL02912 35099202
WTORECB  DC    F'0'                     ECB FOR WTOR INST.      YL02912 35099602
LABLSAVE DS    18F                                                      35100016
NAME     DC    C'LABEL OF'             MODULE NAME CONSTANT             35150016
GOOD     EQU   X'7F'                   NO I/O ERRORS                    35200016
VOL      EQU   63                       DISPLACEMENT FOR VOLID. YL02912 35210002
JJJ      EQU   71                       DISPLACEMENT FOR JOB.   YL02912 35220002
SSS      EQU   80                       DISPLACEMENT FOR STEP.  YL02912 35230002
ERJJ     EQU   56                       DISPLACEMENT FOR JOB.   YL02912 35240002
ERSS     EQU   65                       DISPLACEMENT FOR STEP.  YL02912 35242002
         EJECT                                                     O122 35250019
CCWLIST  CCW   X'31',RDSEEK+3,X'60',5     SEARCH FOR RECORD 3           35300016
         CCW   8,CCWLIST,0,0              REPEAT UNTIL FOUND            35400016
RDWRTCCW CCW   0,0,X'20',80               READ/WRITE DATA               35500016
CCWLIST1 CCW   X'31',RDSEEK+3,X'60',5  SEARCH FOR RECORD3               35550016
         CCW   X'08',CCWLIST1,0,0      REPEAT UNTIL FOUND               35600016
RDBKCHK  CCW   X'06',0,X'30',80        READ CHECK                       35650002
*      LABL DA WRITE-OUT ECB.                                           35700016
         DS    0D                      NECESSARY ALIGNMENT.             36000016
DISKECB  DC    F'0'                    WAIT//COMPLETE BITS              36300016
*      LABL DA WRITE-OUT IOB.                                           36600016
RDIOB    DS    0F                                                       36900016
RDFLAGS  DC    XL2'2000'               FLAG1 AND FLAG2                  37200016
RDSENSE  DC    H'0'                    SENSE BYTES.                     37500016
RDECBAD  DC    A(DISKECB)              ECB ADDRESS                      37800016
RDSTATUS DC    2F'0'                   CHANNEL STATUS.                  38100016
RDCCWAD  DC    A(CCWLIST)              CCW ADDRESS.                     38400016
RDDCBAD  DC    A(RDDCB)                DCB ADDRESS.                     38700016
RDRESAD  DC    F'0'                    RESTART ADDRESS.                 39000016
RDBLKCT  DC    H'1'                    BLOCK COUNT INCREMENT.           39300016
RDERROR  DC    H'0'                    ERROR COUNT.                     39600016
RDSEEK   DC    1F'0'                   MBCCHHR.                         39800016
         DC    X'00000003'                                              40000016
         EJECT                                                     O122 40100019
*      LABL DA WRITE-OUT DCB.                                           40200016
         AIF   ('&LIB' EQ 'LIB1').OSDCB                                 40300000
RDDCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST,EOEA=P8,    M5431 F41200000
               SIOA=P7,PGFX=YES                                   M5431 41250000
         AGO   .C1                                                      41300000
.OSDCB   ANOP                                                           41350000
RDDCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST,EOEA=P8            41400000
.C1      ANOP                                                           41450000
REPLY    DS    CL1                      AREA FOR WTOR REPLY.    YL02912 41500002
         EJECT                                                          42200016
         IEHDWORK                                                       43500016
         EJECT                                                          48500016
         IEHDBLKS                                                       53500016
VLABEL   DSECT                                                          72300016
VOLUME   DS    CL3                     LABEL IDENTIFIER.                72600016
VOLNO    DS    CL1                     LABEL NUMBER.                    72900016
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.             73200016
SECURITY DS    CL1                     VOLUME SECURITY.                 73500016
VTOCPTR  DS    CL10                    POINTER TO VTOC                  73800016
         DS    CL20                    RESERVED.                        74100016
OWNER    DS    CL10                    OWNER IDENTIFICATION.            74400016
         DS    CL29                    BLANK.                           74700016
         EJECT                                                          75300016
         ICHPRCVT                                              @ZA25515 75310099
         EJECT                                                          75320099
CVT      DSECT                                                          75350002
         CVT                                                            75400032
         EJECT                                                          75450002
UCB      DSECT                                                          75900016
         IEFUCBOB                                                       76200016
         EJECT                                                          76300016
JFCB     DSECT                                                          76500016
         IEFJFCBN                                                       76800016
         EJECT                                                          76900016
         DCBD  DSORG=PS                                                 77100016
         END                                                            77400016
./  ADD  SSI=70880143,NAME=IEHDMSGB
         TITLE 'IEHDMSGB --- MESSAGE SELECTION'                         01010000
         COPY  LCGASMSW                                          SM4351 01020000
IEHDMSGB CSECT                                                          01050000
*STATUS- CHANGE LEVEL 000                                             * 03000016
*                                                                     * 04000016
*FUNCTION/OPERATION-  THIS ROUTINE SELECTS THE PROPER MESSAGE FROM    * 05000016
*   THE MESSAGE CSECT-IEHDMSGS-. THE SELECTED MESSAGE IS MOVED INTO   * 06000016
*   THE OUTPUT BUFFER. THIS ROUTINE ALSO COMPUTES THE DISPLACEMENT    * 07000016
*   TO A PORTION OF THE MESSAGE THAT MUST LATER BE FILLED IN.         * 08000016
*                                                                     * 09000016
*ENTRY POINTS-  THE ONLY ENTRY POINT IS -IEHDMSGB-.                   * 10000016
*                                                                     * 11000016
*INPUT-  REGISTER 1 MUST CONTAIN THE DESIRED MESSAGE NUMBER.          * 12000016
*        REGISTER 12 POINTS TO THE COMMON WORK AREA.                  * 13000016
*                                                                     * 14000016
*EXITS-NORMAL-  RETURN TO CALLING ROUTINE VIA LINK REGISTER.          * 15000016
*                                                                     * 16000016
*EXITS-ERROR-  NONE.                                                  * 17000016
*                                                                     * 18000016
*EXTERNAL ROUTINES-  ENTERED FROM ANY MODULE THAT DESIRES TO          * 19000016
*   SELECT AT MESSAGE AND LOAD IT IN THE OUTPUT BUFFER. THIS          * 20000016
*   ROUTINE MUST USE THE -IEHDMSGS- CSECT TO PICK UP THE PROPER       * 21000016
*   MESSAGE.                                                          * 22000016
*                                                                     * 23000016
*SUPERVISOR MACROS-  SAVE                                             * 24000016
*                                                                     * 26000016
*TABLES/WORKAREAS-  USE THE COMMON WORK AREA CALLED -WORK-.           * 27000016
*                                                                     * 28000016
*OUTPUT-  THE SELECTED MESSAGE IS PLACED IN THE OUTPUT BUFFER.        * 29000016
*   REGISTER 1 POINTS TO A FILL-IN SLOT, IF ANY.                      * 30000016
*                                                                     * 31000016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,NON-PRIVILEGED.                   * 32000016
*                                                                       33000016
         EJECT                                                          34000016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             35000016
GR0      EQU   0                                                        36000016
GR1      EQU   1                                                        37000016
GR2      EQU   2                                                        38000016
GR3      EQU   3                                                        39000016
GR4      EQU   4                                                        40000016
GR5      EQU   5                                                        41000016
GR6      EQU   6                                                        42000016
GR7      EQU   7                                                        43000016
GR8      EQU   8                                                        44000016
GR9      EQU   9                                                        45000016
GR10     EQU   10                                                       46000016
GR11     EQU   11                                                       47000016
GR12     EQU   12                                                       48000016
GR13     EQU   13                                                       49000016
GR14     EQU   14                                                       50000016
GR15     EQU   15                                                       51000016
         EJECT                                                          52000016
         SAVE  (14,12),T,*             SAVE THE REGISTERS.              53000016
         SPACE                                                          54000016
         LR    GR11,GR15               LOAD THE BASE REGISTER.          55000016
         USING IEHDMSGB,GR11                                            55600016
         USING WORK,GR12                                                56200016
         SPACE                                                          57000016
         L     GR2,ADMSGTAB            START OF DISPLACEMENT TABLE.     58000016
         SLA   GR1,1                   MESSAGE NO. TIMES TWO.           59000016
         LA    GR1,0(GR1,GR2)          ADDRESS OF DISPLACEMENT ENTRY.   59700016
         LH    GR5,0(GR1)              CONTENTS THIS DISPLACEMENT ENTRY 60400016
         SPACE                                                          61100016
         L     GR3,ADMSGTXT            START OF MESSAGES.               61800016
         AR    GR3,GR5                 ADDRESS OF DESIRED MESSAGE.      62500016
         SPACE                                                          63200016
         LH    GR4,2(0,GR1)            CONTENTS OF NEXT ENTRY.          63900016
         SR    GR4,GR5                 DIFFERENCE=LENGTH OF MESSAGE.    64600016
         SPACE                                                          65300016
         BCTR  GR4,0                   DECREMENT FOR EXECUTION.         66000016
         BCTR  GR4,0                   ACCOUNT FOR LST BYTE OF MESSAGE. 66300016
         EX    GR4,MSGMOVE             MOVE MESSAGE TO OUTPUT BUFFER.   66700016
         SPACE                                                          68000016
         CLI   0(GR3),0                IS MESSAGE TO BE FILLED IN.      69000016
         BE    EXIT                    NO--RETURN.                      70000016
         SPACE                                                          71000016
         SR    GR1,GR1                 CLEAR.                           72000016
         IC    GR1,0(GR3)              DISPLACEMENT TO SLOT.            73000016
         LA    GR1,MESS(GR1)           ADDRESS OF SLOT.                 73500016
         SPACE                                                          74000016
EXIT     LM    14,0,12(13)             RESTORE REGISTERS.               74500016
         LM    2,12,28(13)             RESTORE REGISTERS.               75000016
         MVI   12(13),X'FF'            SET RETURN INDICATION.           75500016
         BR    14                      RETURN.                          76000016
         SPACE                                                          77000016
         SPACE                                                          78000016
MSGMOVE  MVC   MESS(1),1(GR3)          MOVES MESSAGE TO BUFFER.         79000016
ADMSGTAB DC    V(MSGTABLE)             MESSAGE DISPLACEMENT TABLE.      80000016
ADMSGTXT DC    V(MSGSTART)             START OF MESSAGES.               81000016
         EJECT                                                          81500016
         IEHDWORK                                                       82000016
         END                                                            83000016
 $ END                                                                  84000016
./  ADD  SSI=80130046,NAME=IEHDMSGS
 TITLE   'IEHDMSGS --- MESSAGE CSECT FOR IEHDASDR UTILITY'              00200002
IEHDMSGS CSECT                                                          00600002
*********************************************************************** 00602099
*                  FIXES THIS MODULE                                  * 00604099
*                     LATEST FIRST                                    * 00606099
*********************************************************************** 00608099
*                                                                       00610000
*  IEH870 ISSUED INSTEAD OF IEH869  @XA20204=@SA80022=@YA19511=@ZA28124 00611099
*A 34090-35800                      @XA20204=@SA80022=@YA19511=@ZA28124 00612099
*C 48000-88000,240500-247000,       @XA20204=@SA80022=@YA19511=@ZA28124 00613099
*C 512500-514000,552500-554000,     @XA20204=@SA80022=@YA19511=@ZA28124 00614099
*C 556500-558000,598500-602500,     @XA20204=@SA80022=@YA19511=@ZA28124 00615099
*C 638500-640000,654300-654900,     @XA20204=@SA80022=@YA19511=@ZA28124 00616099
*C 656412-656426,656456-656460,     @XA20204=@SA80022=@YA19511=@ZA28124 00617099
*C 656484-656488,698400-704900      @XA20204=@SA80022=@YA19511=@ZA28124 00618099
*                                                                       00619099
*C 657050,657100                    MVS ONLY                   @ZA16475 00620099
*                                                                       00630000
*  VS2-3 SU32 DELETIONS NONE                                   @G32DSPD 00636099
*                                                                       00642099
*C656424,652444,652472,656492                                  @ZM40436 00650032
*C656492,656496,698600,699200,699400,699628                    @ZM42083 00700032
*3394                                                            A32161 00800002
*                                                                  O122 01000002
*                                                               AS14063 01200002
*850000-855000                                                     O122 01400002
*3394                                                            A21395 01600002
*                                                                       01700032
*                                                                       01781032
*   THE FOLLOWING CHANGES WERE MADE FOR VS2/4   @Z40RSRJ                01782032
*C004000,A017810-017850,C164000,656405,A656406-656408,C704000           01783032
*   END OF THE CHANGES FOR  @Z40RSRJ                                    01785032
*                                                                       01786032
*                                                                       01788032
*D656407                                                       @ZM43011 01792032
*STATUS CHANGE LEVEL 003                                                01800002
*********************************************************************** 02000002
*                                                                     * 02200002
*   EACH MESSAGE IS REFERENCED BY A TWO-BYTE DISPLACEMENT ENTRY WHICH * 02400002
*     IS ADDED TO THE START-ADDRESS OF THE MESSAGE TEXT. THE FIRST    * 02600002
*     BYTE OF EACH MESSAGE IS A ONE-BYTE DISPLACEMENT ENTRY WHICH     * 02800002
*     IS USED TO COMPUTE THE ADDRESS OF THAT PORTION OF THE MESSAGE   * 03000002
*     THAT REMAINS TO BE COMPLETED.                                   * 03200002
*                                                                     * 03400002
*     EXAMPLE: MSGIEH869I                                             * 03409099
*                                                                     * 03418099
*     X'45' (DECIMAL 69) IS ENTERED IN REG1.                          * 03427099
*     45 X 2 = 8A                                                     * 03436099
*     MSGTABLE + 8A = 0B79                                            * 03445099
*     MSGSTART + 0B79 = 0C17                                          * 03454099
*     0C17 = MSG69                                                    * 03463099
*     THEN A MOVE FROM MSG69+1 IS DONE WITH THE LENGTH (SEE NOTE1)    * 03472099
*     OFF THE MSG.                                                    * 03481099
*                                                                     * 03490099
*     NOTE1:                                                          * 03499099
*     MSGTABLE + 8A = 0B79 IS SUBTRACT FROM                           * 03508099
*     THE NXT ENTRY IN THE MSGTABLE WICH IS MSGTABLE + 8C = 0BC5      * 03517099
*     0BC5 - 0B79 = 4C THEN                                           * 03526099
*     4C - 2 = 4A WICH IS THE CORRECT LENGTH.                         * 03535099
*                                                                     * 03544099
*     NOTE2: THE LENGTH AT MSG69 IS USED TO INDICATE WHERE ADDITIONAL * 03553099
*     INFORMATION SHOULD BE INCLUDED, SUCH AS VOLID ETC.              * 03562099
*     IF THIS LENGTH IS ZERO THEN NO ADDITIONAL INFO IS NEEDED.       * 03571099
*                                                                     * 03580099
*********************************************************************** 03600002
         SPACE 2                                                        03800002
         ENTRY MSGTABLE                                                 04000002
         ENTRY MSGSTART                                                 04200002
         EJECT                                                          04400002
MSGTABLE DS    0H                      START OF MESSAGE DISPLACEMENTS.  04600002
*********************************************************************** 04800099
*                                    THE MSG IS USED IN        @ZA28124 04850099
*********************************************************************** 04900099
         DC    AL2(MSG0-MSGSTART)    ALL ENVIRONMENT           @ZA28124 04950099
         DC    AL2(MSG1-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05000099
         DC    AL2(MSG2-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05050099
         DC    AL2(MSG3-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05100099
         DC    AL2(MSG4-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05150099
         DC    AL2(MSG5-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05200099
         DC    AL2(MSG6-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05250099
         DC    AL2(MSG7-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05300099
         DC    AL2(MSG8-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05350099
         DC    AL2(MSG9-MSGSTART)    ALL ENVIRONMENT           @ZA28124 05400099
         DC    AL2(MSG10-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05450099
         DC    AL2(MSG11-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05500099
         DC    AL2(MSG12-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05550099
         DC    AL2(MSG13-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05600099
         DC    AL2(MSG14-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05650099
         DC    AL2(MSG15-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05700099
         DC    AL2(MSG16-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05750099
         DC    AL2(MSG17-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05800099
         DC    AL2(MSG18-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05850099
         DC    AL2(MSG19-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05900099
         DC    AL2(MSG20-MSGSTART)   ALL ENVIRONMENT           @ZA28124 05950099
         DC    AL2(MSG21-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06000099
         DC    AL2(MSG22-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06050099
         DC    AL2(MSG23-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06100099
         DC    AL2(MSG24-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06150099
         DC    AL2(MSG25-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06200099
         DC    AL2(MSG26-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06250099
         DC    AL2(MSG27-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06300099
         DC    AL2(MSG28-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06350099
         DC    AL2(MSG29-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06400099
         DC    AL2(MSG30-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06450099
         DC    AL2(MSG31-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06500099
         DC    AL2(MSG32-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06550099
         DC    AL2(MSG33-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06600099
         DC    AL2(MSG34-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06650099
         DC    AL2(MSG35-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06700099
         DC    AL2(MSG36-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06750099
         DC    AL2(MSG37-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06800099
         DC    AL2(MSG38-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06850099
         DC    AL2(MSG39-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06900099
         DC    AL2(MSG40-MSGSTART)   ALL ENVIRONMENT           @ZA28124 06950099
         DC    AL2(MSG41-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07000099
         DC    AL2(MSG42-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07050099
         DC    AL2(MSG43-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07100099
         DC    AL2(MSG44-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07150099
         DC    AL2(MSG45-MSGSTART)   MVS,SU08,SU32             @ZA28124 07200099
         DC    AL2(MSG46-MSGSTART)   MVS,SU08,SU32             @ZA28124 07250099
         DC    AL2(MSG47-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07300099
         DC    AL2(MSG48-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07350099
         DC    AL2(MSG49-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07400099
         DC    AL2(MSG50-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07450099
         DC    AL2(MSG51-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07500099
         DC    AL2(MSG52-MSGSTART)   MVS,SU08,SU32             @ZA28124 07550099
         DC    AL2(MSG53-MSGSTART)   MVS,SU08,SU32             @ZA28124 07600099
         DC    AL2(MSG54-MSGSTART)   MVS,SU08,SU32             @ZA28124 07650099
         DC    AL2(MSG55-MSGSTART)   ALL ENVIRONMENT           @ZA28124 07700099
         DC    AL2(MSG56-MSGSTART)   MVS,SU08,SU32             @ZA28124 07750099
         DC    AL2(MSG57-MSGSTART)   MVS,SU08,SU32             @ZA28124 07800099
         DC    AL2(MSG58-MSGSTART)   MVS,SU08,SU32             @ZA28124 07850099
         DC    AL2(MSG59-MSGSTART)   MVS,SU08,SU32             @ZA28124 07900099
         DC    AL2(MSG60-MSGSTART)   SU08,SU32                 @ZA28124 07950099
         DC    AL2(MSG61-MSGSTART)   NONE                      @ZA28124 08000099
         DC    AL2(MSG62-MSGSTART)   NONE                      @ZA28124 08050099
         DC    AL2(MSG63-MSGSTART)   NONE                      @ZA28124 08100099
         DC    AL2(MSG64-MSGSTART)   SU32                      @ZA28124 08150099
         DC    AL2(MSG65-MSGSTART)   NONE                      @ZA28124 08200099
         DC    AL2(MSG66-MSGSTART)   SU32                      @ZA28124 08250099
         DC    AL2(MSG67-MSGSTART)   NONE                      @ZA28124 08300099
         DC    AL2(MSG68-MSGSTART)   MVS,SU08,SU32             @ZA28124 08350099
         DC    AL2(MSG69-MSGSTART)   ALL ENVIRONMENT           @ZA28124 08400099
         DC    AL2(MSG70-MSGSTART)   ALL ENVIRONMENT           @ZA28124 08450099
         DC    AL2(MSG71-MSGSTART)   ALL ENVIRONMENT           @ZA28124 08500099
         DC    AL2(MSG72-MSGSTART)   ALL ENVIRONMENT           @ZA28124 08550099
         DC    AL2(MSG73-MSGSTART)   NONE                      @ZA28124 08600099
         DC    AL2(MSG74-MSGSTART)   NONE                      @ZA28124 08650099
         DC    AL2(MSG75-MSGSTART)   NONE                      @ZA28124 08700099
         DC    AL2(MSG76-MSGSTART)   NONE                      @ZA28124 08750099
         DC    AL2(MSG77-MSGSTART)   NONE                      @ZA28124 08800099
         SPACE 1                                                AS14063 17600002
         DC    AL2(DELIM-MSGSTART)                                      17800002
         EJECT                                                          18000002
MSGSTART DS    0C                      START OF ALL MESSAGES.           18200002
         SPACE                                                          18400002
MSG0     DC    AL1(MSG0B-MSG0A)                                         18600002
MSG0A    DC    C'IEH800I  INVALID CONTROL STATEMENT. '                  18800002
         DC    C'LAST COLUMN SCANNED='                                  19000002
MSG0B    DS    0C                                                       19200002
         SPACE                                                          19400002
MSG1     DC    AL1(MSG1B-MSG1A)                                         19600002
MSG1A    DC    C'IEH801I  INVALID COMMAND='                             19800002
MSG1B    DS    0C                                                       20000002
         SPACE                                                          20200002
MSG2     DC    AL1(MSG2B-MSG2A)                                         20400002
MSG2A    DC    C'IEH802I  INVALID KEYWORD='                             20600002
MSG2B    DS    0C                                                       20800002
         SPACE                                                          21000002
MSG3     DC    AL1(MSG3B-MSG3A)                                         21200002
MSG3A    DC    C'IEH803I  INVALID PARAMETER='                           21400002
MSG3B    DS    0C                                                       21600002
         SPACE                                                          21800002
MSG4     DC    AL1(*-*)                                                 22000002
MSG4A    DC    C'IEH804I  REQUIRED KEYWORD(S) MISSING'                  22200002
         SPACE                                                          22400002
MSG5     DC    AL1(MSG5B-MSG5A)                                         22600002
MSG5A    DC    C'IEH805I  DDNAME='                                      22800002
MSG5B    DC    C'         CANNOT BE OPENED'                             23000002
         SPACE                                                          23200002
MSG6     DC    AL1(MSG6B-MSG6A)                                         23400002
MSG6A    DC    C'IEH806I             DDNAME='                           23600002
MSG6B    DC    C'         IS COMPLETE. VOLUME SERIAL NO.='              23800002
         SPACE 1                                                        24000099
MSG7     DC    AL1(*-*)                                        @ZA28124 24050099
MSG7A    DC    C'IEH807I UNUSED MESSAGE'                       @ZA28124 24100099
**************** IEH807D IS A WTO MSG ISSUED IN IEHDPASS ***** @ZA28124 24150099
**************** IEH807D IS USED IN ALL ENVIRONMENT      ***** @ZA28124 24200099
         SPACE 1                                               @ZA28124 24250099
MSG8     DC    AL1(*-*)                                        @ZA28124 24300099
MSG8A    DC    C'IEH808D UNUSED MESSAGE'                       @ZA28124 24350099
**************** IEH808I IS A WTOR MSG ISSUED IN IEHDPASS **** @ZA28124 24400099
**************** IEH808I IS USED IN ALL ENVIRONMENT      ***** @ZA28124 24450099
         SPACE 1                                               @ZA28124 24500099
MSG9     DC    AL1(*-*)                                        @ZA28124 24550099
MSG9A    DC    C'IEH809D UNUSED MESSAGE'                       @ZA28124 24600099
**************** IEH809I IS A WTO  MSG ISSUED IN IGC0008B **** @ZA28124 24650099
**************** IEH809I IS USED IN ALL ENVIRONMENT      ***** @ZA28124 24700099
         SPACE 1                                               @ZA28124 24750099
MSG10    DC    AL1(MSG10B-MSG10A)                                       25000002
MSG10A   DC    C'IEH810I  TODD DDNAME='                                 25200002
MSG10B   DC    C'         IS NOT DIRECT ACCESS'                         25400002
         SPACE                                                          25600002
MSG11    DC    AL1(MSG11B-MSG11A)                                       25800002
MSG11A   DC    C'IEH811I  FROMDD DDNAME='                               26000002
MSG11B   DC    C'         IS NOT A TAPE'                                26200002
         SPACE                                                          26400002
MSG12    DC    AL1(MSG12B-MSG12A)                                       26600002
MSG12A   DC    C'IEH812I  UNABLE TO MATCH DDNAME='                      26800002
MSG12B   DS    0C                                                       27000002
         EJECT                                                          27200002
MSG13    DC    AL1(MSG13B-MSG13A)                                       27400002
MSG13A   DC    C'IEH813I  SYSTEM ERROR ENCOUNTERED DURING SVC'   SM4350 27600002
MSG13B   DS    0C                                                       27800002
         SPACE                                                          28000002
MSG14    DC    AL1(MSG14B-MSG14A)                                       28200002
MSG14A   DC    C'IEH814I             SYSTEMS RESIDENCE IS NOT '         28400002
         DC    C'ALLOWED. DDNAME='                                      28600002
MSG14B   DS    0C                                                       28800002
         SPACE                                                          29000002
MSG15    DC    AL1(MSG15B-MSG15A)                                       29200002
MSG15A   DC    C'IEH815I  INCORRECT DEVICE TYPE ON RESTORE. DDNAME='    29400002
MSG15B   DS    0C                                                       29600002
         SPACE                                                          29800002
MSG16    DC    AL1(MSG16B-MSG16A)                                       30000002
MSG16A   DC    C'IEH816I  NOT A RESTORE TAPE ON DDNAME='                30200002
MSG16B   DS    0C                                                       30400002
         SPACE                                                          30600002
MSG17    DC    AL1(MSG17B-MSG17A)                                       30800002
MSG17A   DC    C'IEH817I  FORMAT 5 DSCB IN VTOC FOUND TO BE INCORRECT'  31000002
         DC    C' FOR FROMDD='                                          31200002
MSG17B   DS    0C                                                       31400002
         SPACE                                                          31600002
MSG18    DC    AL1(*-*)                                                 31800002
MSG18A   DC    C'IEH818I  MAIN STORAGE REQUIREMENTS NOT AVAILABLE'      32000002
         DC    C' FOR THIS FUNCTION'                                    32200002
         SPACE                                                          32400002
MSG19    DC    AL1(MSG19B-MSG19A)                                       32600002
MSG19A   DC    C'IEH819I  FROMDD='                                      32800002
MSG19B   DC    C'         IS NOT DIRECT ACCESS'                         33000002
         SPACE                                                          33200002
MSG20    DC    AL1(MSG20B-MSG20A)                                       33400002
MSG20A   DC    C'IEH820I  INVALID DUMP DEVICE SPECIFIED. DDNAME='       33600002
MSG20B   DS    0C                                                       33800002
         SPACE                                                          34000002
MSG21    DC    AL1(MSG21B-MSG21A)                                       34200002
MSG21A   DC    C'IEH821I  INVALID COPY REQUEST. DDNAME='                34400002
MSG21B   DS    0C                                                       34600002
         SPACE                                                          34800002
MSG22    DC    AL1(MSG22B-MSG22A)                                       35000002
MSG22A   DC    C'IEH822I  INVALID TRACK ADDRESS SPECIFIED. DDNAME='     35200002
MSG22B   DS    0C                                                       35400002
         SPACE                                                          35600002
MSG23    DC    AL1(MSG23B-MSG23A)                                       35800002
MSG23A   DC    C'IEH823I  NO ERROR WAS DETECTED, AN ALTERNATE' @Z30RSAG 36000032
         DC    C' WAS NOT ASSIGNED FOR TRACK: '                @Z30RSAG 36200032
MSG23B   DS    0C                                              @Z30RSAG 36400032
         EJECT                                                          36600002
MSG24    DC    AL1(MSG24B-MSG24A)                                       36800002
MSG24A   DC    C'IEH824I  ANALYZE TERMINATED. DEVICE NOT OFF-LINE AND'  37000002
         DC    C' CONFIRMED. TODD='                                     37200002
MSG24B   DS    0C                                                       37400002
         SPACE                                                          37600002
MSG25    DC    AL1(MSG25B-MSG25A)                                       37800002
MSG25A   DC    C'IEH825I  INVALID VTOC LIMITS SPECIFIED FOR TODD='      38000002
MSG25B   DS    0C                                                       38200002
         SPACE                                                          38400002
MSG26    DC    AL1(MSG26B-MSG26A)                                       38600002
MSG26A   DC    C'IEH826I  IPL TEXT NOT FOUND OR APPLICABLE FOR TODD='   38800002
MSG26B   DS    0C                                                       39000002
         SPACE                                                          39200002
MSG27    DC    AL1(MSG27B-MSG27A)                                       39400002
MSG27A   DC    C'IEH827I  NO MORE ALTERNATE TRACKS AVAILABLE FOR TODD=' 39600002
MSG27B   DS    0C                                                       39800002
         SPACE                                                          40000002
MSG28    DC    AL1(MSG28B-MSG28A)                                       40200002
MSG28A   DC    C'IEH828I  TRACK ZERO IS DEFECTIVE ON TODD='             40400002
MSG28B   DC    C'         THIS VOLUME IS NON-IPLABLE.'                  40600002
         SPACE                                                          40800002
MSG29    DC    AL1(MSG29B-MSG29A)                                       41000002
MSG29A   DC    C'IEH829I  HA-R0 AREA WAS DEFECTIVE. TODD='              41200002
MSG29B   DS    0C                                                       41400002
         SPACE                                                          41600002
MSG30    DC    AL1(MSG30B-MSG30A)                                       41800002
MSG30A   DC    C'IEH830I  THE VOLUME SPECIFIED BY TODD='                42000002
MSG30B   DC    C'         HAS BECOME UNUSABLE.'                         42200002
         SPACE                                                          42400002
MSG31    DC    AL1(MSG31B-MSG31A)                                       42600002
MSG31A   DC    C'IEH831I  DEFECTIVE TRACK ON TODD='                     42800002
MSG31B   DC    C'         WAS'                                          43000002
         SPACE                                                          43200002
MSG32    DC    AL1(MSG32B-MSG32A)                                       43400002
MSG32A   DC    C'IEH832I  ALTERNATE TRACK ON TODD='                     43600002
MSG32B   DC    C'          IS N/A'                                      43800002
         SPACE                                                          44000002
MSG33    DC    AL1(MSG33B-MSG33A)                                       44200002
MSG33A   DC    C'IEH833I  DEVICE NOT SUPPORTED FOR'            @Y30LSFY 44400003
         DC    C' MSS ANALYSIS. TODD='                         @Y30LSFY 44600003
MSG33B   DS    0C                                              @Y30LSFY 44650003
         SPACE                                                          44800002
MSG34    DC    AL1(MSG34B-MSG34A)                                       45000002
MSG34A   DC    C'IEH834I  DIRECT ACCESS DEVICE NOT SUPPORTED. DDNAME='  45200002
MSG34B   DS    0C                                                       45400002
         SPACE                                                          45600002
MSG35    DC    AL1(*-*)                                                 45800002
MSG35A   DC    C'IEH835I  TAPE DD STATEMENT DOES NOT SPECIFY CORRECT '  46000002
         DC    C'LABEL INFORMATION FOR SECURITY PROTECTION'             46200002
         EJECT                                                          46400002
         SPACE                                                          46600002
MSG36    DC    AL1(MSG36B-MSG36A)                                       46800002
MSG36A   DC    C'IEH836I  INCORRECT PASSWORD WAS GIVEN FOR A '          47000002
         DC    C'DATA SET ON DDNAME='                                   47200002
MSG36B   DS    0C                                                       47400002
         SPACE                                                          47600002
MSG37    DC    AL1(MSG37B-MSG37A)                                       47800002
MSG37A   DC    C'IEH837I  UNEXPIRED DATA SET(S) NOT CONFIRMED ON'       48000002
         DC    C' TODD DDNAME='                                         48200002
MSG37B   DS    0C                                                       48400002
         SPACE                                                          48600002
MSG38    DC    AL1(MSG38B-MSG38A)                                       48800002
MSG38A   DC    C'IEH838I  INVALID BLOCKSIZE SPECIFIED. DDNAME='         49000002
MSG38B   DS    0C                                                       49200002
         SPACE                                                          49400002
MSG39    DC    AL1(MSG39B-MSG39A)                                       49600002
MSG39A   DC    C'IEH839I  HIGHEST RETURN CODE ENCOUNTERED WAS'          49800002
MSG39B   DS    0C                                                       50000002
         SPACE                                                          50200002
MSG40    DC    AL1(MSG40B-MSG40A)                                       50400002
MSG40A   DC    C'IEH840I  NO DD CARD PROVIDED FOR SECURITY'             50600002
         DC    C' DATA SET ON FROMDD='                                  50800002
MSG40B   DS    0C                                                       51000002
         SPACE 1                                                        51200099
MSG41    DC    AL1(*-*)                                        @ZA28124 51250099
MSG41A   DC    C'IEH841I UNUSED MESSAGE'                       @ZA28124 51300099
**************** IEH841D IS A WTOR MSG ISSUED IN IGC0008B **** @ZA28124 51350099
**************** IEH841D IS USED IN ALL ENVIRONMENT      ***** @ZA28124 51400099
         SPACE 1                                               @ZA28124 51450099
MSG42    DC    AL1(MSG42B-MSG42A)                                  O122 51800002
MSG42A   DC    C'IEH842I  DATA CHECK IN '                          O122 52000002
MSG42B   DC    C'      FIELD ON TRK='                              O122 52200002
         SPACE 1                                                   O122 52400002
MSG43    DC    AL1(MSG43B-MSG43A)                                  O122 52600002
MSG43A   DC    C'IEH843I  DATA CHECK IN COUNT FIELD AND POSSIBLY ' O122 52800002
         DC    C'IN KEY AND DATA FIELDS ON TRK='                   O122 53000002
MSG43B   DS    0C                                                  O122 53200002
         SPACE 1                                                   O122 53400002
MSG44    DC    AL1(MSG44B-MSG44A)                                  O122 53600002
MSG44A   DC    C'IEH844I MISSING ADDRESS MARKER ON TRK='           O122 53800002
MSG44B   DS    0C                                                  O122 54000002
         SPACE 1                                                   O122 54200002
MSG45    DC    AL1(MSG45B-MSG45A)                                  O122 54400002
MSG45A   DC    C'IEH845I  DEVICE NOT SUPPORTED FOR OFFLINE QUICK'  O122 54600002
         DC    C' DASDI FEATURE.  TODD='                           O122 54800002
MSG45B   DS    0C                                                  O122 55000002
         SPACE 1                                               @ZA28124 55200099
MSG46    DC    AL1(*-*)                                        @ZA28124 55250099
MSG46A   DC    C'IEH846I UNUSED MESSAGE'                       @ZA28124 55300099
**************** IEH846D IS A WTOR MSG ISSUED IN IEHDGETA **** @ZA28124 55350099
**************** IEH846D IS ONLY USED IN MVS,SU08 AND SU32**** @ZA28124 55400099
         SPACE 1                                               @ZA28124 55450099
MSG47    DC    AL1(*-*)                                          A32161 55500099
MSG47A   DC    C'IEH847I INVALID PARAMETER IN EXEC CARD'         A32161 55550099
         SPACE 1                                                 A21395 55600099
MSG48    DC    AL1(*-*)                                        @ZA28124 55650099
MSG48A   DC    C'IEH848I UNUSED MESSAGE'                       @ZA28124 55700099
**************** IEH848D IS A WTOR MSG ISSUED IN IEHDREST **** @ZA28124 55750099
**************** IEH848D IS USED IN ALL ENVIRONMENT       **** @ZA28124 55800099
         SPACE 1                                               @ZA28124 55850099
MSG49    DC    AL1(*-*)                                          A21395 57400002
MSG49A   DC    C'IEH849I  RESTORE TERMINATED. ADDITIONAL TAPE REQUIRED' 57600002
         SPACE 1                                                   O122 57800002
MSG50    DC    AL1(MSG50B-MSG50A)                               XM6320  58000002
MSG50A   DC    C'IEH850I  SUBSEQUENT RESTORE VOLUMES NOT'       XM6320  58200002
         DC    C' SPECIFIED IN JCL FOR DDNAME='                 XM6320  58400002
MSG50B   DS    0C                                               XM6320  58600002
         SPACE 1                                                XM7053  58800002
MSG51    DC    AL1(MSG51B-MSG51A)                               XM7053  59000002
MSG51A   DC    C'IEH851I  THIS DEVICE IS BEING SHARED WITH'     XM7053  59200002
         DC    C' OTHER DATA SETS FOR DDNAME='                  XM7053  59400002
MSG51B   DS    0C                                               XM7053  59600002
         SPACE 1                                               @ZA28124 59800099
MSG52    DC    AL1(*-*)                                        @ZA28124 59850099
MSG52A   DC    C'IEH852D UNUSED MESSAGE'                       @ZA28124 59900099
**************** IEH852I IS A WTOR MSG ISSUED IN IEHDIPLI **** @ZA28124 59950099
**************** IEH852I IS ONLY USED IN MVS,SU08 AND SU32**** @ZA28124 60000099
         SPACE 1                                               @ZA28124 60050099
MSG53    DC    AL1(*-*)                                        @ZA28124 60100099
MSG53A   DC    C'IEH853I UNUSED MESSAGE'                       @ZA28124 60150099
**************** IEH853D IS A WTOR MSG ISSUED IN IEHDLABL **** @ZA28124 60200099
**************** IEH853D IS ONLY USED IN MVS,SU08 AND SU32**** @ZA28124 60250099
         SPACE 1                                               @ZA28124 60300099
MSG54    DC    AL1(MSG54B-MSG54A)                               YL02912 62000002
MSG54A   DC    C'IEH854I  DEVICE HAS ALREADY BEEN ENQUED UPON'  YL02912 62200002
         DC    C' DDNAME='                                      YL02912 62400002
MSG54B   DS   0C                                                YL02912 62600002
         SPACE 1                                                YL02912 62800002
MSG55    DC    AL1(MSG55B-MSG55A)                               YL02912 63000002
MSG55A   DC    C'IEH855I  VIRTUAL UCBS ARE NOT SUPPORTED'       YL02912 63200002
         DC    C' DDNAME='                                      YL02912 63400002
MSG55B   DS   0C                                                YL02912 63600002
         SPACE 1                                               @XM07447 63800099
MSG56    DC    AL1(*-*)                                        @ZA28124 63850099
MSG56A   DC    C'IEH856I UNUSED MESSAGE'                       @ZA28124 63900099
**************** IEH856D IS A WTOR MSG ISSUED IN IEHDREST **** @ZA28124 63950099
**************** IEH856D IS ONLY USED IN MVS,SU08 AND SU32**** @ZA28124 64000099
         SPACE 1                                               @ZA28124 64050099
MSG57    DC    AL1(MSG57B-MSG57A)                               YL02912 64800002
MSG57A   DC    C'IEH857I  LABEL  FUNCTION DENIED BY OPERATOR'   YL02912 65000002
         DC    C' DDNAME='                                      YL02912 65200002
MSG57B   DS   0C                                                YL02912 65400002
         SPACE 1                                               @ZA28124 65410099
MSG58    DC    AL1(*-*)                                        @ZA28124 65430099
MSG58A   DC    C'IEH858I UNUSED MESSAGE'                       @ZA28124 65450099
**************** IEH858D IS A WTOR MSG ISSUED IN IEHDPASS **** @ZA28124 65470099
**************** IEH858D IS ONLY USED IN MVS,SU08 AND SU32**** @ZA28124 65490099
         SPACE 1                                               @ZA28124 65510099
MSG59    DC    AL1(MSG59B-MSG59A)                               YL02912 65610002
MSG59A   DC    C'IEH859I  REQUESTED DEVICE IS IN USE BY'        YL02912 65620002
         DC    C' ANOTHER OFFLINE SYSTEM COMPONENT: '           YL02912 65630002
MSG59B   DS   0C                                                YL02912 65640002
         SPACE 1                                               @ZM40436 65640432
MSG60    DC    AL1(MSG60B-MSG60A)       MESSAGE LENGTH         @Z40RSRJ 65640532
MSG60A   DC    C'IEH860I  INVALID SECURITY AUTHORIZATION '     @Z40RSRJ 65640632
         DC    C'FOR A DATA SET ON DDNAME = '  MESSAGE TEXT    @Z40RSRJ 65640832
MSG60B   DS    0C                                              @Z40RSRJ 65640932
         SPACE 1                                               @ZA28124 65641099
MSG61    DC    AL1(*-*)                                        @ZA28124 65641299
MSG61A   DC    C'IEH861I UNUSED MESSAGE'                       @ZA28124 65641499
         SPACE 1                                               @ZA28124 65641699
MSG62    DC    AL1(*-*)                                        @ZA28124 65641899
MSG62A   DC    C'IEH862I UNUSED MESSAGE'                       @ZA28124 65642099
         SPACE 1                                               @ZA28124 65642299
MSG63    DC    AL1(*-*)                                        @ZA28124 65642499
MSG63A   DC    C'IEH863I UNUSED MESSAGE'                       @ZA28124 65642699
         SPACE 1                                               @ZA28124 65642899
MSG64    DC    AL1(MSG64B-MSG64A)                              @ZM40436 65644032
MSG64A   DC    C'IEH864I INADEQUATE RACF AUTHORIZATION TO USE' @G32DSPD 65644332
         DC    C' CPYVOLID FOR VOLUME SERIAL = ' MESSAGE TEXT  @G32DSPD 65644632
MSG64B   DS    0C                                              @ZM40436 65644932
         SPACE 1                                               @ZA28124 65645299
MSG65    DC    AL1(*-*)                                        @ZA28124 65645599
MSG65A   DC    C'IEH865I UNUSED MESSAGE'                       @ZA28124 65645899
         SPACE 1                                               @ZA28124 65646199
MSG66    DC    AL1(MSG66B-MSG66A)                              @ZM40436 65646499
MSG66A   DC    C'IEH866I INADEQUATE RACF AUTHORIZATION FOR '   @G32DSPD 65646799
MSG66B   DC    C'        ON DDNAME = '                         @G32DSPD 65647099
         SPACE 1                                               @ZA28124 65647399
MSG67    DC    AL1(*-*)                                        @ZA28124 65647699
MSG67A   DC    C'IEH867I UNUSED MESSAGE'                       @ZA28124 65647999
         SPACE 1                                               @ZA28124 65648299
MSG68    DC    AL1(MSG68B-MSG68A)                               Y02083  65650002
MSG68A   DC    C'IEH868I  A CHECKPOINT/RESTART DATA SET IS ON ' Y02083  65700002
         DC    C'VOLUME. OPERATOR HAS DENIED '                 @ZA16475 65705099
         DC    C'USE OF VOLUME FOR DDNAME= '                   @ZA16475 65715099
MSG68B   DS   0C                                                Y02083  65760002
MSG69    DC    AL1(MSG69B-MSG69A)                               SA53223 65800002
MSG69A   DC    C'IEH869I  BAD COUNT FIELD ENCOUNTERED ON '      SA53223 66000002
         DC    C'TRACK =          DDNAME =          '           SA53223 66200002
MSG69B   DS    0C                                               AS14063 66400002
         SPACE 1                                                AS14063 66600002
MSG70    DC    AL1(MSG70B-MSG70A)                               AS14063 66800002
MSG70A   DC    C'IEH870I  INCORRECT INPUT DATA SET FORMAT.  '   AS14063 67000002
         DC    C'FROMDD DDNAME = '                              AS14063 67200002
MSG70B   DS    0C                                               AS14063 67400002
         SPACE 1                                                AS14063 67600002
MSG71    DC    AL1(MSG71B-MSG71A)                               AS14063 67800002
MSG71A   DC    C'IEH871I  POSSIBLE LACK OF SPACE ON TRACK 0 '   AS14063 68000002
         DC    C'DUE TO USER LABEL(S).  '                       AS14063 68200002
         DC    C'TODD = '                                       AS14063 68400002
MSG71B   DS    0C                                               AS14063 68600002
         SPACE 1                                                AS14063 68800002
MSG72    DC    AL1(MSG72B-MSG72A)                               AS14063 69000002
MSG72A   DC    C'IEH872I  OUTPUT VOLUME WITH VTOC ON CYL. 0 '   AS14063 69200002
         DC    C'TRACK ZERO NOT ALLOWED.  '                     AS14063 69400002
         DC    C'TODD = '                                       AS14063 69600002
MSG72B   DS    0C                                               AS14063 69800002
         SPACE 1                                                        69820032
MSG73    DC    AL1(*-*)                                        @ZA28124 69840099
MSG73A   DC    C'IEH873I UNUSED MESSAGE'                       @ZA28124 69890099
         SPACE 1                                               @ZA28124 69940099
MSG74    DC    AL1(*-*)                                        @ZA28124 69990099
MSG74A   DC    C'IEH874I UNUSED MESSAGE'                       @ZA28124 70040099
         SPACE 1                                               @ZA28124 70090099
MSG75    DC    AL1(*-*)                                        @ZA28124 70140099
MSG75A   DC    C'IEH875I UNUSED MESSAGE'                       @ZA28124 70190099
         SPACE 1                                               @ZA28124 70240099
MSG76    DC    AL1(*-*)                                        @ZA28124 70290099
MSG76A   DC    C'IEH876I UNUSED MESSAGE'                       @ZA28124 70340099
         SPACE 1                                               @ZA28124 70390099
MSG77    DC    AL1(*-*)                                        @ZA28124 70440099
MSG77A   DC    C'IEH877I UNUSED MESSAGE'                       @ZA28124 70490099
         SPACE 1                                                        70540099
DELIM    DS    0C                 MUST BE AT END OF LAST MESSAGE   O122 70590099
         END                                                            70640099
./  ADD  SSI=81600007,NAME=IEHDPASS
   TITLE 'IEHDPASS --- INSURES PASSWORD PROTECTION  IEHDASDR UTILITY'   00200121
         COPY  LCGASMSW                                          SM4351 00200221
IEHDPASS CSECT                                                          00200421
*********************************************************************** 00200508
*                  FIXES THIS MODULE                                    00200608
*                     LATEST FIRST                                      00204108
*********************************************************************** 00206108
*                                                                       00206508
*FIX FOR SERVICEING 46 DSCB/TRACK   @XA21058=@YA20902=@SA80167=@ZA32596 00206699
*                                                                       00206799
*C 51000,51300                       SU32 ONLY                 @ZA25515 00206899
*A 140510-140540                     SU32 ONLY                 @ZA25515 00206999
*C 401366-401384,728000              SU32 ONLY                 @ZA25515 00207099
*                                                                       00207499
*C 037690,037700,51100,500076        MVS ONLY                  @ZA16477 00207599
*                                                                       00207699
*C 500642,500665                     MVS ONLY                  @ZA16475 00207899
*A 500646-500655                     MVS ONLY                  @ZA16475 00208099
*                                                                       00208299
*  NO DELETIONS FOR VS2-3 SU32                                 @G32DSPD 00208499
*                                                                       00208699
*C 51200,52500,446000                        @YA13331=@XA14207=@ZA11927 00208899
*A 50500-51000                               @YA13331=@XA14207=@ZA11927 00209099
*                                                                       00209299
*  SU808 CHANGES                                               @Z40RSRB 00209499
*                                                               YM7392  00209699
*        RELEASE 21 DELETIONS                                         * 00211408
*                                                         PI0134=YM5964 00214908
*                                       OX03105 = YM3060                00218408
*1193                                                            A44112 00221908
*        RELEASE 20 DELETIONS                                         * 00225408
*1010630800                                                      M6183  00228908
*1010484000-486000                                               M4979  00232408
*1010287000,290000,349000,350000                                 A32516 00235908
*1010624000                                                      A33538 00239408
*1010396000                                                      S20201 00242908
*1010631000                                                      M5900  00246408
*        RELEASE 18 DELETIONS                                           00249908
*3166452900-453000,455900-457400,480000,613300                   MC0I   00253408
*        VS2 RELEASE 4 CHANGES                                          00255908
*A138200-138400,A286400-287600,493006-493012,564000-564600,    @Z40UAY1 00256308
*A585300-585600                                                @Z40UAY1 00256708
*STATUS CHANGE LEVEL 004                                                00256908
*C146200,493060                                                @Z40UAY1 00257108
*   THIS ENDS THE CHANGES FOR @Z40UAY1                                  00257308
*0000000000                                                    @Z40RSRJ 00257708
*                                                                     * 00260408
*********************************************************************** 00262408
         EJECT                                                          00263908
*FUNCTION/OPERATION- THIS ROUTINE PERFORMS THE FUNCTION OF            * 00273608
*   CHECKING FOR PASSWORD PROTECTED AND                        @Z40RSRB 00283608
*   RACF PROTECTED DATASETS ON VOLUMES WHICH                   @Z40RSRB 00285608
*   ARE BEING ANALYZED, FORMATTED, DUMPED FROM OR TO AND RESTORED TO. * 00294008
*   IF SUCH DATA SETS ARE FOUND, THIS ROUTINE REQUIRES THAT THE       * 00300808
*   APPROPRIATE PASSWORD(S) BE PROVIDED OR THE APPROPRIATE     @Z40RSRB 00310808
*   RACF AUTHORIZATION(S) BE HELD BEFORE ALLOWING THE          @Z40RSRB 00320808
*   FUNCTION TO CONTINUE USING THE VOLUME.                            * 00321208
*     UNEXPIRED DATA SETS ARE ALSO CHECKED FOR ON THE TO DEVICE.      * 00328008
*   INSTRUCTION TO OVERRIDE SUCH DATASETS AND USE THE VOLUME          * 00334808
*   MUST APPEAR IN THE CONTROL CARD AND THE OPERATORS REPLY TO A      * 00341608
*   CONSOLE MESSAGE IN ORDER TO ALLOW THE FUNCTION TO CONTINUE.       * 00348408
*   RACF AUTHORIZATION TO BYPASS THE ABOVE SECURITY CHECKING   @G32DSPD 00358432
*   ON EACH VOLUME IS TESTED. IF NO SUCH AUTHORIZATION IS HELD @G32DSPD 00363432
*   THE SECURITY CHECKS ARE MADE.                              @G32DSPD 00368432
*                                                                     * 00375608
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDPASS- AND CONTROL IS      * 00382408
*   RECEIVED FROM EITHER DUMP(IEHDDUMP), RESTORE(IEHDREST), OR        * 00389208
*   FORMAT/ANALYZE(IEHDANAL).                                         * 00396008
*                                                                     * 00402808
*INPUT- POINTERS TO A WORKAREA (REGISTER 12), TO A CONTROL BLOCK      * 00409608
*   (REGISTER 10), AND TO A BUFFER AREA (REGISTER 1).                 * 00416408
*     THE DIRECT ACCESS DEVICE BEING ANALYZED, FORMATTED, RESTORED    * 00423208
*   TO AND DUMPED FROM OR TO SERVE AS INPUT TO THIS MODULE. ALSO THE  * 00430008
*   TAPE BEING DUMPED TO, IF MAGNETIC TAPE IS USED, MAY BE INPUT TO   * 00436808
*   THIS ROUTINE.                                                     * 00443608
*                                                                     * 00450408
*EXITS- NORMAL- IF NO ERROR CONDITIONS OCCUR, -IEHDPASS- RETURNS TO   * 00457208
*   THE FUNCTION (IEHDANAL, IEHDDUMP, IEHDREST) WHICH LINKED TO IT    * 00464008
*   WITH A RETURN CODE OF ZERO.                                       * 00470808
*                                                                     * 00477608
*EXITS- ERROR- IF A NORMAL ERROR CONDITION OCCURS (ONE WHICH MAY BE   * 00484408
*   DIAGNOSED) AN ERROR MESSAGE IS WRITTEN AND A RETURN CODE          * 00491208
*   GREATER THAN ZERO IS PASSED BACK TO THE FUNCTION WHICH LINKED     * 00498008
*   TO -IEHDPASS-. IF AN ABNORMAL ERROR OCCURS A RETURN CODE GREATER  * 00504808
*   THAN ZERO IS SET BUT NO MESSAGE IS WRITTEN. RETURN IS ALWAYS TO   * 00511608
*   THE FORMAT/ANALYZE, DUMP OR RESTORE MODULE.                       * 00518408
*                                                                     * 00525208
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS ENTERED FROM EITHER        * 00532008
*   IEHDDUMP, IEHDREST OR IEHDANAL. MESSAGES WILL BE FORMULATED       * 00538808
*   BY IEHDMSGB AND PRINTED BY IEHDPRNT.                              * 00545608
*                                                                     * 00552408
*TABLES/WORKAREAS- UPON ENTRY REGISTERS 10 AND 12 POINT TO A          * 00559208
*   FUNCTION BLOCK AND A WORKAREA RESPECTIVELY. THEY ARE DESCRIBED    * 00566008
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-. REGISTER 1 POINTS TO   * 00572808
*   A BUFFER AREA TO BUILD THE CHANNEL PROGRAM AND READ IN THE DSCBS. * 00579608
*                                                                     * 00586408
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             00593208
GR0      EQU   0                                                        00600016
GR1      EQU   1                                                        00800016
GR2      EQU   2                                                        01000016
GR3      EQU   3                                                        01200016
GR4      EQU   4                                                        01400016
GR5      EQU   5                                                        01600016
GR6      EQU   6                                                        01800016
GR7      EQU   7                                                        02000016
GR8      EQU   8                                                        02200016
GR9      EQU   9                                                        02400016
GR10     EQU   10                                                       02600016
GR11     EQU   11                                                       02800016
GR12     EQU   12                                                       03000016
GR13     EQU   13                                                       03200016
GR14     EQU   14                                                       03400016
GR15     EQU   15                                                       03600016
L6       EQU   6                        VOLUME ID LENGTH       @G32DSPD 03602032
L7       EQU   7                        FUNCTION NAME LENGTH   @G32DSPD 03605032
L8       EQU   8                        MAX DDNAME LENGTH       Y02083  03610002
MESS68   EQU   68                       IEH868I MESSAGE         Y02083  03650002
SEROFFS  EQU   65                       IEH858D VOLSER OFFSET   Y02083  03700002
COPYON   EQU   1                        COPYSW=COPIES USED     @Z40RSRB 03710008
PARTIAL  EQU   0                        DUMPSW=PARTIAL DUMP    @Z40RSRB 03720008
MSG60    EQU   60                       IEH860I MSG OFFSET     @Z40RSRB 03730008
MSG64    EQU   64                       IEH864I MSG OFFSET     @G32DSPD 03740032
MESS66   EQU   66                       IEH866I MSG OFFSET     @G32DSPD 03750032
UNITOFFS EQU   25                       IEH858I UNIT-ADDR OFFSET Y02083 03760002
CHPTP    EQU   X'10'                    CHECKPOINT PROMPT ISSUED YM7392 03762002
ON       EQU   X'01'                    DONOT PROMPT OPER FOR   YM7392  03764002
*                                       UNEXPIRED DATA/SETS     YM7392  03766002
OFF      EQU   X'00'                    RESETS ON SWITCH        YM7392  03768002
JN       EQU   73                       OFFSET TO JOBNAME     @ZA16477  03769000
SN       EQU   83                       OFFSET TO STEPNAME    @ZA16477  03770000
DSIDSIND EQU   93                       FORMAT 1 DSCB OFFSET    Y02083  03780002
CHKPT    EQU   X'01'                    DSCB FLAG FOR           Y02083  03790002
*                                       CHECK/POINT RESTART D/S Y02083  03792002
BASEREG  EQU   11                                                       03800016
VSAMID   EQU   X'08'                    FORMAT 1 VSAM FLAG      YM3060  03850003
D83      EQU   83                       OFFSET TO DSORG IN F1   YM3060  03900003
*                                       DSCB.                   YM3060  03950003
         USING FUNCBLK,10                                               04000016
         USING WORK,12                                                  04200016
         USING IEHDPASS,BASEREG                                         04400016
         USING CCWBUFF,9                                                04600016
         SAVE  (14,12),T,*             SAVE REGISTERS                   04800016
         LR    BASEREG,GR15            LOAD BASE REGISTER               05000016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA11927 05050008
         DC    C'SU32'                 SU08 APPLIED            @ZA25515 05100099
         DC    C'OZ32596 '             LAST FIX THIS MODUL     @ZA32596 05130099
         DC    C'&SYSDATE'                                     @Z40RSRB 05190008
         DS    0H                                              @Z40RSRB 05240008
APARNO   LA    GR2,PASSSAVE            SAVE AREA ADDRESS       @ZA11927 05250008
         ST    GR2,8(GR13)             ADDRESS OF NEW AREA TO OLD       05400016
         ST    GR13,4(GR2)             ADDRESS OF OLD AREA TO NEW       05600016
         LR    GR13,GR2                LOAD SAVE AREA ADDRESS           05800016
         LA    GR1,0(GR1)              SELECT OUT ADDRESS ONLY IN REG   05900016
         LR    GR9,GR1                 PICK UP POINTER TO BUFFER AREA   06000016
*                                         FOR CHANNEL PROG AND DSCBS    06200016
         MVI   TSTDSCB,X'00'           CLEAR SWITCH           A@ZA32596 06210099
*********************************************************************** 06220016
*  THIS ROUTINE BUILDS THE CHANNEL PROGRAMS NEEDED TO READ IN THE     * 06240016
*     DSCBS ONE TRACK AT A TIME. THE CCWS ARE PLACED IN A VARIABLE    * 06260016
*     LENGTH BUFFER AREA WHICH IS POINTED TO BY REGISTER 1. WORK      * 06280016
*     AREAS ARE ALSO INITIALIZED.                                     * 06300016
*********************************************************************** 06320016
         USING CONSTANT,3                                               06340016
         L     GR3,IODEVCON            PICK UP POINTER TO CONSTANT AREA 06360016
         SR    GR0,GR0                 CLEAR REGISTER.                  06380016
         IC    GR0,DSCBTRK             PICK UP NUMBER DSCBS PER TRACK   06400016
         ST    GR0,DSCBNO              SAVE NUMBER DSCBS PER TRACK      06460016
         DROP  3                                                        06520016
         LR    GR15,GR0                COMPUTE ADDRESS OF               06600016
         SLL   GR15,3                     AREA TO READ DSCBS. SAVE      06800016
         LA    GR15,24(GR15)              POINTER                       07000016
         ALR   GR15,GR1                                                 07200016
         ST    GR15,DSCBPTR            SAVE POINTER TO DSCB READAREA    07400016
         LA    GR8,140                 SIZE OF ONE DSCB                 07600016
         LM    GR2,GR7,CCWLIST         PICK UP FIRST THREE CCWS         07800016
         ALR   GR4,GR1                 PUT CORRECT ADDRESS IN TIC CCW   08000016
         STM   GR2,GR5,0(GR1)          PLACE SEARCH AND TIC CCWS IN     08200016
*                                         BUFFER.                       08400016
         ALR   GR6,GR15                PUT ADDRESS OF READ IN AREA      08600016
*                                         IN READ CCW                   08800016
CCWLOOP  STM   GR6,GR7,16(GR1)         PLACE CORRECT NUMBER OF          09000016
         ALR   GR6,GR8                    READ INSTRUCTIONS IN          09200016
         LA    GR1,8(GR1)                 BUFFER WITH APPROPRIATE       09400016
         BCT   GR0,CCWLOOP                READ IN AREA ADDRESSES        09600016
         MVI   RDCNT,X'92'             INITIALIZE DUMMY CCWS.      0552 09700017
         LM    GR2,GR3,RDCNT           PICK UP LAST CCW                 09800016
         STM   GR2,GR3,16(GR1)         PLACE CCW TO POSITION TO         10000016
*                                         NEXT TRACK IN BUFFER          10200016
         ST    GR1,RDCNTAD        SAVE ADDR FOR RD CNT MODIFICATION.    10300016
         LA    GR4,CCW1                PUT CCW ADDRESS                  10400016
         ST    GR4,DCCWAD                 IN IOB                        10600016
         MVC   LASTDSCB(5),NINES       INITIALIZE FOR END OF READ DSCBS 10800016
         SR    GR5,GR5                  ZERO OUT REGISTER               11000016
         ST    GR5,SECSW               INITIALIZE SWITCHES TO ZERO      11600016
         ST    GR5,TABLEAD             INITIALIZE TABLE ADDRESS TO ZERO 11800016
         ST    GR5,TABLESIZ            INIT. GETMAIN SIZE      @G32DSPD 11900032
*********************************************************************** 12000016
*   THIS ROUTINE DETERMINES WHICH FUNCTION IS IN OPERATION            * 12200016
*     AT PRESENT. DUMP REQUIRES CHECKING BOTH THE FROM AND TO DEVICES.* 12400016
*********************************************************************** 12600016
         CLI   FUNCSW,ANALYSIS         IS FUNCTION ANALYZE              12800016
         BE    TODEV                   YES-CHECK TO DEV ONLY            13000016
         CLI   FUNCSW,FORMAT           IS FUNCTION FORMAT               13200016
         BE    TODEV                   YES-CHECK TO DEV ONLY            13400016
         CLI   FUNCSW,RESTORE          IS FUNCTION RESTORE              13600016
         BE    TODEV1                  YES-CHECK TO DEV ONLY            13800016
         CLI   FUNCSW,DUMP             IS FUNCTION DUMP                 13860016
         BNE   SETCODE                 NO-ABNORMALLY TERMINATE JOB      13920016
*********************************************************************** 14000016
*           THIS SECTION OF CODE PERFORMS RACF SECURITY CHECKING. IF  * 14005032
*  THE DUMP FROM VOLUME IS RACF DEFINED THE USER MUST HAVE READ       * 14010032
*  ACCESS IN ORDER TO DUMP THE VOLUME.                         @G32DSPD 14015032
*********************************************************************** 14020032
         L     GR7,CVTPTR          GET CVT POINTER             @G32DSPD 14025032
         USING CVT,GR7                                         @G32DSPD 14030032
         L     GR7,CVTRAC          GET RACF POINTER            @G32DSPD 14035032
         DROP  GR7                                             @G32DSPD 14040032
         LTR   GR7,GR7             RACF ACTIVE IN THE SYSTEM?  @G32DSPD 14045032
         BZ    NULRACF1            NO,SKIP CHECKING            @G32DSPD 14050032
         USING RCVT,GR7            DO CHECK IF RACF IS         @ZA25515 14051099
         TM    RCVTSTA1,RCVTDASD   CURRENT.                    @ZA25515 14052099
         BZ    NULRACF1            NO DONT RACHECK             @ZA25515 14053099
         DROP  GR7                 YES DO RACHECK              @ZA25515 14054099
         L     GR7,FUCBPTR         GET FROM UCB                @G32DSPD 14055032
         USING UCB,GR7                                         @G32DSPD 14060032
         MVC   RACVOL,UCBVOLI      PUT UCB IN PARM LIST        @G32DSPD 14065032
         RACHECK ATTR=READ,ENTITY=RACVOL,CLASS=DASDVOL,        @G32DSPD*14070032
               VOLSER=0,MF=(E,RACKPRM)                         @G32DSPD 14075032
         CLM   GR15,B'0001',RC8   VOLID DEFINED,UNAUTHORIZED ? @G32DSPD 14080032
         BE    UNAUTHF            NOT AUTHORIZED,GO TERMINATE  @G32DSPD 14085032
         CLM   GR15,B'0001',RC4   VOLID RACF DEFINED ?         @G32DSPD 14090032
         BE    NULRACF1           NO,END RACF CHECKS           @G32DSPD 14095032
* VOLUME IS RACF DEFINED AND USER IS READ AUTHORIZED, CHECK    @G32DSPD 14100032
* FOR AUTHORIZATION TO USE CPYVOLID OPTION.                    @G32DSPD 14105032
         TM    SEQSW,CPYVOLID     'CPYVOLID' REQUESTED ?       @G32DSPD 14110032
         BZ    TAPECHK            NO,BYPASS PASSWORD CHECKS    @G32DSPD 14115032
         CLI   DEVSW,X'FF'        TO DEVICE A DA DEVICE        @G32DSPD 14116032
         BNE   TAPECHK            'CPYVOLID' IGNORED IF NOT DA @G32DSPD 14117032
         RACHECK ATTR=ALTER,ENTITY=RACVOL,CLASS=DASDVOL,       @G32DSPD*14120032
               VOLSER=0,MF=(E,RACKPRM)                         @G32DSPD 14125032
         LTR   GR15,GR15          IS USER AUTHORIZED ?         @G32DSPD 14130032
         BZ    TAPECHK            YES,ALLOW REQUEST            @G32DSPD 14135032
*   USER NOT AUTHORIZED,RESET 'CPYVOLID' INDICATOR             @G32DSPD 14140032
         NI    SEQSW,255-CPYVOLID DISALLOW 'CPYVOLID'          @G32DSPD 14145032
         OI    FLGBYT2,CPYREJEC   INDICATE CPYVOLID DISALLOWED @G32DSPD 14146032
         BAL   GR4,UNAUTHC        GIVE DIAGNOSTIC(IEH864I)     @G32DSPD 14150032
         B     TAPECHK            OK TO BYPASS PASSWD CHECKS   @G32DSPD 14155032
NULRACF1 EQU   *                                               @G32DSPD 14160032
* END RACF FROM VOL CHECKS.                                    @G32DSPD 14165032
*                                                              @G32DSPD 14170032
*********************************************************************** 14175032
*   THIS ROUTINE SCANS THE TIOT TO DETERMINE THE AMOUNT OF CORE       * 14200016
*     NEEDED FOR THE DSNAME TABLE OF PASSWORD PROTECTED DATASETS ON   * 14300016
*     THE FROM DEVICE.                                                * 14400016
*********************************************************************** 14600016
         TM    SEQSW,FEATURE1           FROM DD HAVE RPS                14620008
         BZ    FROMDEV             NO                            S20201 14640020
         MVC   TIC+D1(L3),DCCWAD+D1  SET UP TIC ADDR             S20201 14660020
         LA    GR4,SETCCW          POINT TO RPS CCWS             S20201 14680020
         ST    GR4,DCCWAD          STORE IN IOB                  S20201 14700020
FROMDEV  EQU   *                        *                        S20201 14720020
         L     GR8,CVTPTR              PICK UP POINTER TO CVT           14800016
         USING CVT,GR8                                                  15000016
         L     GR6,CVTTCBP             PICK UP POINTER TO TCB           15200016
         L     GR6,4(GR6)                                               15300016
         L     GR7,12(GR6)             PICK UP POINTER TO TIOT          15400016
         USING TIOT,GR7                                                 15600016
         LA    GR6,DDENTRY             PICK UP ADDRESS OF FIRST DDENTRY 15800016
         ST    GR6,TIOTSAVE              IN TIOT AND SAVE               16000016
         USING DDENTRY,GR6                                              16200016
         DROP  7,8                                                      16400016
         SR    GR4,GR4                 INITIALIZE REGISTER TO ZERO      16600016
NEXTDD   CLC   TIOEDDNM(8),INCON       IS IT SYSIN                      16920016
         BE    BUMPPTR                 YES-BUMP POINTER TO NEXT ENTRY   17200016
         CLC   TIOEDDNM(8),PRINTCON    IS IT SYSPRINT                   17400016
         BE    BUMPPTR                 YES-BUMP POINTER TO NEXT ENTRY   17600016
         CLC   TIOEDDNM(8),BLANKS  IS IT BLANK                   A44112 17620021
         BE    BUMPPTR              YES MUST BE CONCATENATED DD  A44112 17640021
         SR    GR3,GR3                 PUT TIOT LENGTH IN               17680016
         IC    GR3,TIOELNGH               REGISTER                      17760016
         SH    GR3,TWENTY              CALCULATE INDEX TO LAST UCB PTR  17840016
         AR    GR6,GR3                 ADJUST DD ENTRY INDEX FOR UCB    17920016
CHECKUCB CLC   TIOEFSRT(3),FUCBPTR+1   UCB FOR FROM DEVICE?             18000016
         BNE   NEXTUCB                 NO- MORE UCBS                    18080016
ADDENTRY EX    GR5,SWITCH1             SWITCH TO REDIRECT FLOW 2ND TIME 18200016
         LA    GR4,52(GR4)             ADD TO CORE SIZE FOR GETMAIN     18400016
NEXTUCB  LTR   GR3,GR3                 MORE UCBS TO CHECK               18430016
         BE    BUMPPTR                 NO - GO GET NEXT DD ENTRY        18460016
         SH    GR3,FOUR                INDEX TO NEXT UCB                18490016
         SH    GR6,FOUR                POINT TO NEXT UCB PTR            18520016
         B     CHECKUCB                GO CHECK NEXT UCB                18550016
BUMPPTR  SR    GR3,GR3                 PUT TIOT LENGTH IN               18580016
         IC    GR3,TIOELNGH                REGISTER                     18610016
         AR    GR6,GR3                 BUMP PTR TO NEXT DD ENTRY        18640016
         L     GR0,0(GR6)              END OF TIOT REACHED              18700016
         LTR   GR0,GR0                                                  18800016
         BNE   NEXTDD                  NO-GET NEXT ENTRY                19000016
         EX    GR5,SWITCH2             SWITCH TO REDIRECT FLOW 2ND TIME 19200016
         LA    GR8,TABLEAD             YES-SET UP ADDRESS FOR GETMAIN   19800016
         ST    GR4,TABLESIZ            SAVE SIZE OF DSNAME TABLE        20000016
         GETMAIN EC,LV=(4),A=(8)       GET CORE FOR DSNAME TABLE        20200016
         LTR   GR15,GR15               CORE AVAILABLE?                  20400016
         BNE   MORECORE                NO-GO WRITE MESSAGE              20600016
*********************************************************************** 20800016
*   THIS ROUTINE CREATES A TABLE CONTAINING THE NAMES OF EVERY DATASET* 21000016
*    ON THE FROM DEVICE FOR WHICH A PASSWORD DD CARD WAS SUPPLIED.    * 21100016
*    THE CORRESPONDING DDNAME FOR EACH DSNAME IS ALSO PLACED IN THE   * 21200016
*    TABLE.                                                             21300016
*********************************************************************** 21600016
         L     GR6,TIOTSAVE            PICK UP POINTER TO TIOT DDENTRY  21800016
         LA    GR5,X'F0'               SET SWITCHES FOR 2ND TIME        22000016
*                                        SCAN OF TIOT                   22200016
         LA    GR7,DADCB               PICK UP POINTER TO DCB           22400016
         ST    GR7,DDCBAD                                               22500016
         USING IHADCB,7                                                 22600016
         MVC   OPENLD+1(3),DDCBAD+1    MOVE DCB ADDRESS TO LIST         22800016
         LA    GR2,READJFCB            PICK UP BUFFER ADDRESS TO        23000016
         ST    GR2,LIST                  READ JFCB                      23200016
         MVI   LIST,X'87'              PICK UP EXIT LIST CODE           23400016
         L     GR8,TABLEAD             PICK UP POINTER TO DSNAME TABLE  23600016
         LA    GR15,VTOCREAD           SET UP FOR BRANCH IF TABLE FULL  23800016
         BAL   GR14,NEXTDD             GO GET FIRST DDNAME FOR RDJFCB   24000016
         SR    GR6,GR3            RESET POINTER TO START DD ENTRY. 9956 24100017
         MVC   DCBDDNAM(8),TIOEDDNM    PUT DDNAME IN DCB                24200016
         MVC   0(8,GR8),DCBDDNAM       ENTER DDNAME IN TABLE            24400016
         LA    GR8,8(GR8)              BUMP POINTER TO DSNAME SLOT      24600016
         RDJFCB MF=(E,OPENLD)          READ JFCB                        24800016
         USING JFCB,2                                                   25000016
         MVC   0(44,GR8),JFCBDSNM      ENTER DSNAME IN TABLE            25200016
         MVI   JFCBTSDM,X'08'          STOP WRITE OF JFCB AT OPEN       25300016
         LA    GR8,44(GR8)             BUMP POINTER TO NEXT ENTRY SLOT  25400016
         BAL   GR15,BUMPPTR            GO GET NEXT DDNAME IF ANY        25600016
*********************************************************************** 26400016
*  THIS ROUTINE CHECKS ALL THE FORMAT 1 DATA SET LABELS ON THE FROM   * 26600016
*    DEVICE FOR PROTECTION AND LOOKS UP THE NAME OF PROTECTED DATASETS* 26800016
*     IN THE DSNAME TABLE CREATED. IF NO PASSWORD DD CARD WAS SUPPLIED* 27000016
*     FOR THE DATA SET AND IT DOES NOT APPEAR IN THE DSNAME TABLE     * 27200016
*     A MESSAGE IS WRITTEN AND A RETURN CODE OF 8 IS SET. OTHERWISE A * 27400016
*     MESSAGE IS WRITTEN TO THE OPERATOR REQUESTING THE PASSWORD      * 27600016
*     FOR EACH DATA SET, ONE AT A TIME. AN INCORRECT RESPONSE         * 27800016
*     RESULTS IN A RETURN CODE OF 8 WITH MESSAGE. A CORRECT RESPONSE  * 28000016
*     ALLOWS PROCESSING TO CONTINUE.                                  * 28200016
*********************************************************************** 28400016
VTOCREAD LR    GR5,GR8                                                  28420016
         USING UCB,GR8                                                  28440016
         L     GR8,FUCBPTR             PICK UP POINTER TO UCB           28460016
         MVC   JFCBVOLS(6),SRTEVOLI    PUT VOL/SER NO. IN JFCB          28500016
         DROP  8                                                        28520016
BACK     LA    GR8,44                  SET REGISTER TO LAST ENTRY       28540016
         SR    GR5,GR8                    FOR LOOP CONTROL              28560016
         LA    GR7,BLOCKS+180           PICK UP DCB ADDRESS             28640008
         MVI   RDCNT,X'92'              INIT RDCNT TO MULTI-TRK         28730008
         L     GR2,DCBDEBAD       PICK UP POINTER TO DEB.               28830016
         MVC   SEEKAD+1(6),36(GR2) EXTRACT LOW EXTENT FROM DEB.         28910016
REPEAT   EQU   *                                                 A32516 28980020
         ST    GR7,DDCBAD               PUT DCB ADDR IN IOB.     A32516 29050020
         L     GR6,DSCBNO         GET NO. OF DSCBS PER TRK.      A32516 29120020
         L     GR3,DSCBPTR             PICK UP POINTER TO DSCB READAREA 29200016
         CLI   RDCNT,X'12'             END OF VTOC REACHED              29260016
         BE    RESTCCWS                YES-GO CHECK TODEVICE  C@ZA32596 29320099
         CLC   SEEKAD+3(4),LASTDSCB    IS LAST F1 DSCB FINISHED         29370099
         BH    RESTCCWS                YES-GO CHECK TO DEVICE C@ZA32596 29420099
         CLC   SEEKAD+3(4),42(GR2) IS THIS LAST TRACK OF VTOC.          29680016
         BNE   GOODCCW                 NO-GO READ                       29760016
         MVI   RDCNT,X'12'             YES CHANGE RDCNT TO SINGLE TRACK 29840016
         L     GR1,RDCNTAD                                              29860016
         CLI   DSCBNO+3,X'2E'          46 DSCB/TRACK?         A@ZA32596 29880099
         BNE   ENDCCW1                 NO THEN OK             A@ZA32596 29900099
         S     GR1,EIGHT               ONE LESS 0E CCW OP     A@ZA32596 29920099
ENDCCW1  MVI   16(GR1),X'12'      SET SINGLE READ COUNT.      C@ZA32596 29940099
GOODCCW  MVC   SAVECCHH(5),SEEKAD+3    SAVE SEARCH CCHHR      A@ZA32596 29960099
         EXCP  DISKIOB                 READ A DSCB            C@ZA32596 29980099
         BAL   GR4,WAIT                AWAIT COMPLETION OF I/O          30000099
         CLI   44(GR3),X'F4'           IS DSCB A FORMAT 4               30020099
         BNE   CHECKF1                 NO-GO CHECK FORMAT 1             30040099
         CLI   TSTDSCB,X'FF'           BEEN HERE BEFORE?      A@ZA32596 30060099
         BE    OKDSCB1                 YES, BRANCH            A@ZA32596 30080099
         L     GR4,FUCBPTR             GET UCB POINTER        A@ZA32596 30100099
         CLI   19(GR4),X'0B'           3350?                  A@ZA32596 30120099
         BNE   OKDSCB1                 NO, NO ACTION          A@ZA32596 30140099
         CLI   74(GR3),X'2E'           NO OF DSCB/TRK = 46?   A@ZA32596 30160099
         BNE   OKDSCB1                 NO, NO ACTION          A@ZA32596 30180099
         MVI   TSTDSCB,X'FF'           INDICATE BEEN HERE     A@ZA32596 30200099
         L     GR4,DSTATUS             PICK UP CCW POINTER    A@ZA32596 30220099
         LA    GR4,0(GR4)              CLEARHIGH ORDER BYTE   A@ZA32596 30240099
         S     GR4,SIXTEEN             POINT TO LAST 0E-OP    A@ZA32596 30260099
         MVC   SAVECCW(16),0(GR4)      SAVE CCW (0E + 92) OP  A@ZA32596 30280099
         MVC   0(8,GR4),8(GR4)         MAKE STRING 46 0E-CCWS A@ZA32596 30300099
         MVC   SEEKAD+3(5),SAVECCHH    START READ VTOC AGAIN  A@ZA32596 30320099
         LA    GR6,46                  INDICATE 46 DSCB/TRK   A@ZA32596 30340099
         ST    GR6,DSCBNO              SAVE NO OF DSCBS       A@ZA32596 30360099
         B     GOODCCW                 REATART CCW STRING     A@ZA32596 30380099
RESTCCWS CLI   TSTDSCB,X'FF'           ANY CHANGES TO CCWS?   A@ZA32596 30400099
         BNE   TAPECHK                 NO, TEST TO-DEVICE     A@ZA32596 30420099
         MVI   TSTDSCB,X'00'           RESET SWITCH           A@ZA32596 30440099
         MVI   DSCBNO+3,X'2F'          SET 47 DSCB/TRACK      A@ZA32596 30460099
         L     GR1,DSTATUS             GET CSW POINTER        A@ZA32596 30480099
         LA    GR1,0(GR1)              CLEAR HIGH ORDER BYTE  A@ZA32596 30500099
         S     GR1,EIGHT               POINT TO LAST CCW      A@ZA32596 30520099
         MVC   0(16,GR1),SAVECCW       SAVE CCW (0E + 92)OP   A@ZA32596 30540099
         B     TAPECHK                 GO TEST TO-DEVICE      A@ZA32596 30560099
OKDSCB1  MVC   LASTDSCB(5),45(GR3)  SAVE ADDR OF LAST F1 DSCB C@ZA32596 30580099
         LA    GR3,140(GR3)            BUMP POINTER TO NEXT DSCB        30800016
         BCTR  GR6,0                   SUBTRACT 1 FROM NO. DSCBS LEFT   31000016
CHECKF1  CLI   44(GR3),X'F1'           IS DSCB A FORMAT 1               31200016
         BNE   CONTROL1                                                 31400016
         STM   GR5,GR8,PROMPTSA         SAVE WORK REG          @Z40RSGD 31410008
         TM    DSIDSIND(GR3),CHKPT      THIS A CHKPT/RSTRT DS ? Y02083  31450002
         BNO   NOCR1                    NO, BRCH                Y02083  31460002
         L     GR8,FUCBPTR              LOAD UCB REG            YM7392  31480002
         BAL   GR4,PROMPT               YES, TELL OPERATOR.     Y02083  31500002
NOCR1    EQU   *                                                Y02083  31550002
         USING F1DSCB,GR3              FORMAT 1                @Z40RSRB 31560008
         TM    DS1DSIND,F1RACDEF       RAC DEFINED             @Z40RSRB 31570008
         BO    FRRACDEF                BR IF YES TO OPEN       @Z40RSRB 31580008
         TM    93(GR3),X'14'           D/S PASSWORD PROTECTED    A46957 31650000
         BC    9,CONTROL1              NO-CONTINUE               A46957 31700000
         DROP  GR3                     DROP F1DSCB             @Z40RSRB 31720108
         LA    GR7,DADCB               PICK UP PPINTER TO DUMMY DCB TO  31750003
         ST    GR7,DDCBAD                  OPEN PASSWORD DATA SET       31800003
         TM    D83(GR3),VSAMID          VSAM DSCB ?             YM3060  31810003
         BNO   NOVSAM                   NO, CONTINUE            YM3060  31820003
         MVC   DCBDDNAM,DDNAME1         MOVE FROMDD DDNAME      YM3060  31830003
         B     VSAM1                    OPEN VSAM F1 DSCB       YM3060  31840003
NOVSAM   EQU       *                                            YM3060  31842003
         LA    GR4,52                  SET UP FOR LOOP CONTROL          31850003
         L     GR8,TABLEAD             YES-PICK UP POINTER TO TABLE     32000016
         LTR   GR8,GR8                 HAVE ENTRIES BEEN MADE IN TABLE  32060016
         BZ    NOCARD                   YES, CHECK ENTRIES      YM3060  32070003
CKTABLE  CLC   0(44,GR3),8(GR8)        IS DATA SET IN TABLE             32400016
         BE    GETPASS                 YES-GO REQUEST PASSWORD          32600016
         BXH   GR8,GR4,NOCARD          BUMP POINTER TO NEXT ENTRY       32800016
         B     CKTABLE                 CHECK NEXT TABLE ENTRY           33000016
GETPASS  MVC   DCBDDNAM(8),0(GR8)      PUT DDNAME IN DCB                33200016
VSAM1    EQU   *                                                YM3060  33250003
         L     GR2,LIST           SET UP JFCB POINTER.             0141 33300017
         MVC   JFCBDSNM,D0(GR3)        PUT DSNAME IN JFCB       YM3060  33400003
         OPEN  MF=(E,OPENLD),TYPE=J                                     33600016
         TM    DCBOFLGS,X'10'          WAS OPEN SUCCESSFUL              33800016
         BZ    BADPASS                 NO-GO TERMINATE JOB              34000016
         NI    DCBMACRF+1,X'F3'        SET BITS OFF TO STOP WRITE OF    34200016
*                                        EOF AND UPDATE OF DSCB         34400016
         CLOSE ((7))                                                    34600016
         TM    D83(GR3),VSAMID          VSAM DSCB ?             YM3060  34650003
         BO    VSAM2                    YES, DON,T SET TAPE     YM3060  34700003
*                                       SECURITY SWITCH.        YM3060  34750003
         MVI   SECSW,X'01'             SET SECURITY SWITCH              34800016
VSAM2    EQU   *                                                YM3060  34850003
         LA    GR7,BLOCKS+180       PUT DCB FROM DUMP IN IOB     A32516 34860020
         L     GR2,DCBDEBAD            OBTAIN POINTER TO DEB     A32516 34920020
         CLI   FUNCSW,DUMP             NORMAL DUMP ?           @ZM40033 34970008
         BE    CONTROL1                YES, CONTINUE           @ZM40033 35010008
         LA    GR7,BLOCKS+172          USE VER2 OFFSET         @ZM40033 35050008
CONTROL1 LA    GR3,140(GR3)            BUMP POINTER TO NEXT DSCB        35100016
         BCT   GR6,CHECKF1             SUBTRACT 1 FROM NO. DSCBS LEFT   35400016
         B     REPEAT                  READ AGAIN                       35800016
FRRACDEF EQU   *                       OPEN TO CHECK SECURITY  @Z40RSGD 35801008
*   CHECK FOR INPUT RACF AUTHORIZATION                                  35802008
         L     GR8,FUCBPTR              INPUT UCB              @Z40RSGD 35803008
         LA    GR15,ACHKTRD             REQUEST INPUT AUTH     @Z40RSGD 35804008
         LR    GR5,GR3                  DSCB ADDRESS           @Z40RSGD 35804208
         BAL   GR7,SETUPUCB             CHECK RAC AUTH         @Z40RSGD 35805008
         L     GR5,PROMPTSA             RESTORE REG 5          @Z40RSGD 35805208
         B     VSAM2                    AUTHORIZED - CONTINUE  @Z40RSGD 35806008
*********************************************************************** 36000016
*  THIS ROUTINE CHECKS TO SEE IF TO DEVICE IS TAPE AND IF SOURCE      * 36030016
*    DIRECT ACCESS DEVICE HAS PASSWORD PROTECTED DATASETS. IF SO      * 36060016
*    THE SWITCH WHICH INDICATES STANDARD LABEL, PASSWORD PROTECTED    * 36090016
*    TAPE WITH BLANK OR ZERO SEQUENCE NUMBER MUST BE ON FOR           * 36120016
*    PROCESSING TO CONTINUE. OTHERWISE JOB IS TERMINATED WITH MESSAGE.* 36150016
*********************************************************************** 36200016
TAPECHK  CLI   DEVSW,X'00'             IS TO DEVICE TAPE                36500016
         BNE   DADEV                   NO- GO CHECK DIRECT ACCESS       36800016
         CLI   SECSW,X'01'             YES-IS SECURITY SWITCH ON        37200016
         BNE   RELEASE                 NO-GO RETURN TO PROCESSING       37400016
         TM    SWITCH,PASSSW           YES-IT THIS STANDARD LABEL       37600016
*                                          PASSWORD PROTECTED TAPE      37800016
*                                          WITH SEQ NO = BLANK OR ZERO  37900016
         BO    RELEASE                 YES-GO RETURN TO PROCESSING      38000016
         LA    GR1,35                  TAPE NOT SL AND PROTECTED        38200016
         BAL   GR5,MSGBLD              GO BUILD MESSAGE                 38300016
         LA    GR5,SETCODE             SET UP FOR BRANCH AFTER PRINT    38400016
         B     MSGPRNT                 GO PRINT MESSAGE                 38500016
*********************************************************************** 38600016
*  THIS ROUTINE CHECKS ALL FORMAT 1 DATA SET LABELS ON A DA DEVICE    * 38610016
*    FOR EXPIRATION AND FOR PROTECTION. IF AT LEAST ONE UNEXPIRED     * 38620016
*    DATA SET IS ENCOUNTERED AND EITHER THE PURGE OPTION IS NOT       * 38630016
*    SPECIFIED BY THE USER OR THE PURGE OPTION IS SPECIFIED BUT THE   * 38640016
*    OPERATOR REQUESTS TERMINATION OF THE JOB IN RESPONSE TO A WTOR   * 38650016
*    MESSAGE, AN ERROR MESSAGE IS WRITTEN AND A RETURN CODE OF 8 IS   * 38660016
*    SET.                                                             * 38670016
*  OTHERWISE THE DATA SET IS CHECKED FOR PROTECTION. THE PASSWORD FOR * 38680016
*    A PROTECTED DATA SET MUST BE SUPPLIED IF THE DATA SET IS TO BE   * 38690016
*    SCRATCHED AND THE VOLUME USABLE.                                 * 38700016
*********************************************************************** 38800016
         USING COPYBLK,6                                                38900016
DADEV    CLI   DEVSW,X'FF'             IS TO DEVICE DIRECT ACCESS       39000016
         BNE   DUMPFUNC                NO-GO CHECK FOR DUMP FUNCTION    39100016
TODEV1   LA    GR7,BLOCKS+44           PICK UP POINTER TO DCB/RESTORE   39400016
         B     TODEV2              GO TO PROCESS                 S20201 39600020
TODEV    LA    GR7,FBLOCKS             PICK UP POINTER TO DCB/FORMAT    39800016
*                                         AND ANALYSIS                  40000016
TODEV2   EQU   *                        *                        S20201 40010020
         LA    GR4,CCW1            RESET PTR IN                  S20201 40020020
         ST    GR4,DCCWAD          IOB                           S20201 40030020
         TM    SEQSW+D1,FEATURE    TODD HAVE RPS                 S20201 40040020
         BZ    GOAHEAD             NO                            S20201 40050020
         MVC   TIC+D1(L3),DCCWAD+D1  SET UP TIC ADDR             S20201 40060020
         LA    GR4,SETCCW          POINT TO RPS CCWS             S20201 40070020
         ST    GR4,DCCWAD          STORE IN IOB                  S20201 40080020
GOAHEAD  EQU   *                                                 S20201 40090020
VREAD    ST    GR7,DDCBAD              PUT DCB ADDRESS IN IOB           40100016
*********************************************************************** 40103032
*    THIS SECTION OF CODE PERFORMS RACF AUTHORIZATION CHECKS ON THE   * 40106032
*  'TO' VOLUME. IF THE VOLUME IS RACF DEFINED THE USER MUST HAVE      * 40109032
*  ALTER ACCESS TO THE VOLUME BEFORE DUMP,RESTORE,ANALYZE OR FORMAT   * 40112032
*  WILL BE ALLOWED.                                         @G32DSPD  * 40115032
*********************************************************************** 40118032
         L     GR3,CVTPTR              GET CVT POINTER         @G32DSPD 40121032
         USING CVT,GR3                                         @G32DSPD 40124032
         L     GR3,CVTRAC              GET RACF POINTER        @G32DSPD 40127032
         DROP  GR3                                             @G32DSPD 40130032
         LTR   GR3,GR3                 RACF ACTIVE IN SYSTEM   @G32DSPD 40133032
         BZ    NULRACF2                NO,SKIP CHECKS          @G32DSPD 40136032
         USING RCVT,GR3                DO CHECK IF RACF IS     @ZA25515 40136699
         TM    RCVTSTA1,RCVTDASD       CURRENT.                @ZA25515 40137299
         BZ    NULRACF2                NO DONT RACHECK         @ZA25515 40137899
         DROP  GR3                     YES DO RACHECK          @ZA25515 40138499
* GET VOLID FROM UCB. FIRST DETERMINE IF 'TO' OR 'COPY ' UCB.  @G32DSPD 40139032
         L     GR8,TUCBPTR             GET 'TO' UCB            @G32DSPD 40142032
         TM    COPYSW,COPYON           WORKING ON A COPY ?     @G32DSPD 40145032
         BZ    NOTCPY                  NO, KEEP 'TO' UCB       @G32DSPD 40148032
         L     GR8,CUCBPTR             YES,GET 'COPY' UCB      @G32DSPD 40151032
         USING UCB,GR8                                         @G32DSPD 40154032
NOTCPY   MVC   RACVOL,UCBVOLI          GET VOLID               @G32DSPD 40157032
         DROP  GR8                                             @G32DSPD 40160032
         RACHECK  ATTR=ALTER,ENTITY=RACVOL,CLASS=DASDVOL,      @G32DSPD*40163032
               VOLSER=0,MF=(E,RACKPRM)                         @G32DSPD 40166032
         CLM   GR15,B'0001',RC8        UNAUTHORIZED ?          @G32DSPD 40169032
         BE    UNAUTHT                 UNAUTHORIZED,GO END     @G32DSPD 40172032
         LTR   GR15,GR15               DEFINED AND AUTHORIZED? @G32DSPD 40175032
         BZ    CKMOREDD                YES,SKIP PASSWORD CHECKS@G32DSPD 40178032
*      IF 'TO VOL' IS NOT DEFINED TO RACF,CHECK PASSWORDS.     @G32DSPD 40181032
*  END 'TO VOL' RACF SECURITY CHECKS.                          @G32DSPD 40184032
         SPACE 2                                               @G32DSPD 40187032
NULRACF2 EQU   *                                               @G32DSPD 40190032
         MVC   LASTDSCB(5),NINES       INITIALIZE FOR END OF READ DSCB  40200016
         MVI   RDCNT,X'92'             INITIALIZE RDCNT TO MULTI-TRACK  40250016
         L     GR1,RDCNTAD                                              40260016
         MVI   16(GR1),X'92'      RESET RD CNT FOR MULTI-TRK.           40270016
         L     GR3,DCBDEBAD            PICK UP POINTER TO DEB           40300016
         MVC   SEEKAD+1(6),36(GR3)     EXTRACT LOW EXTENT FROM DEB      40400016
REPEAT2  L     GR2,DSCBNO              PICK UP NUMBER DSCBS PER TRACK   40600016
         L     GR5,DSCBPTR             PICK UP POINTER TO DSCB READAREA 40800016
         CLI   RDCNT,X'12'             END OF VTOC REACHED              40860016
         BE    OKCCWS                 YES-GO CHECK FOR COPIES C@ZA32596 40920099
         CLC   SEEKAD+3(4),LASTDSCB    IS LAST F1 DSCB FINISHED         40970099
         BH    OKCCWS                 YES-GO CHECK FOR COPIES C@ZA32596 41020099
         CLC   SEEKAD+3(4),42(GR3)     IS THIS LAST TRACK OF VTOC       41280016
         BNE   CCWOK                   NO-GO READ                       41360016
         MVI   RDCNT,X'12'             YES CHANGE RDCNT TO SINGLE TRACK 41440016
         L     GR1,RDCNTAD                                              41460016
         CLI   DSCBNO+3,X'2E'          VTOC HAS 46 DSCB/TRK   A@ZA32596 41480099
         BNE   ENDCCW2                 NO THEN OK             A@ZA32596 41500099
         S     GR1,EIGHT               ONE LESS 0E-OP CCW     A@ZA32596 41520099
ENDCCW2  MVI   16(GR1),X'12'           SET SINGLE READ COUNT. C@ZA32596 41540099
CCWOK    MVC   SAVECCHH(5),SEEKAD+3    SAVE SEARCH CCHHR      A@ZA32596 41560099
         EXCP  DISKIOB                 READ A DSCB            C@ZA32596 41580099
         BAL   GR4,WAIT                AWAIT COMPLETION OF I/O          41600099
         CLI   44(GR5),X'F4'           IS DSCB A FORMAT 4               41620099
         BNE   F1CHECK                 NO-GO CHECK FORMAT 1             41640099
         CLI   TSTDSCB,X'FF'           BEEN HERE BEFORE?      A@ZA32596 41660099
         BE    OKDSCB2                 YES THEN BRANCH        A@ZA32596 41680099
         L     GR4,TUCBPTR             GET UCB POINTER        A@ZA32596 41700099
         CLI   19(GR4),X'0B'           3350?                  A@ZA32596 41720099
         BNE   OKDSCB2                 NO, NO ACTION          A@ZA32596 41740099
         CLI   74(GR5),X'2E'           ACTUAL NO OF DSCB =46? A@ZA32596 41760099
         BNE   OKDSCB2                 NO, NO ACTION          A@ZA32596 41780099
         MVI   TSTDSCB,X'FF'           INDICATE BEEN HERE     A@ZA32596 41800099
         L     GR4,DSTATUS             PICK UP CCW POINTER    A@ZA32596 41820099
         LA    GR4,0(GR4)              CLEAR HIGH ORDER BYTE  A@ZA32596 41840099
         S     GR4,SIXTEEN             POINT TO LAST 0E CCW   A@ZA32596 41860099
         MVC   SAVECCW(16),0(GR4)      SAVE CCW (0E + 92) OP  A@ZA32596 41880099
         MVC   0(8,GR4),8(GR4)         MAKE STRING 46 0E-CCWS A@ZA32596 41900099
         MVC   SEEKAD+3(5),SAVECCHH    INDICATE START VTOC    A@ZA32596 41920099
         LA    GR2,46                  INDICATE 46 DSCB/TRACK A@ZA32596 41940099
         ST    GR2,DSCBNO              SAVE NO OF DSCBS       A@ZA32596 41960099
         B     CCWOK                   RESTART CCW-STRING     A@ZA32596 41980099
OKCCWS   CLI   TSTDSCB,X'FF'           ANY CHANGES TO CCWS?   A@ZA32596 42000099
         BNE   CKMOREDD                NO, THEN CHECK COPIES  A@ZA32596 42020099
         MVI   TSTDSCB,X'00'           RESET SWITCH           A@ZA32596 42040099
         MVI   DSCBNO+3,X'2F'          SET 47 DSCB/TRK        A@ZA32596 42060099
         L     GR1,DSTATUS             GET CSW POINTER        A@ZA32596 42080099
         LA    GR1,0(GR1)              CLEAR HIGH ORDER BYTE  A@ZA32596 42100099
         S     GR1,EIGHT               POINT TO LAST CCW      A@ZA32596 42120099
         MVC   0(16,GR1),SAVECCW       SAVE CCW (0E + 92) OP  A@ZA32596 42140099
         B     CKMOREDD                ALL OK, CHECK COPIES   A@ZA32596 42160099
OKDSCB2  MVC   LASTDSCB(5),45(GR5)  SAVE ADDR OF LAST F1 DSCB C@ZA32596 42180099
         LA    GR5,140(GR5)            BUMP POINTER TO NEXT DSCB        42400016
         BCTR  GR2,0                   SUBTRACT 1 FROM NO. DSCBS LEFT   42600016
F1CHECK  CLI   44(GR5),X'F1'           IS DSCB A FORMAT 1               42800016
         BNE   CONTROL2                                                 43000016
         TM    WTORSW,ON                WRITE TO OPER SWITCH ON  YM7392 43200002
         BO    SCRATCH                 YES-GO SCRATCH DATA SET   YM7392 43400002
               TIME                                                     43600016
         LR    GR0,GR1                 PUT DATE IN REGISTER 0           43660016
         XC    DATE(8),DATE            CLEAR OUT DATE AREA              43720016
         STH   GR0,DATE+6              ISOLATE DAY                      43780016
         SRDL  GR0,4                   SAVE ZONE IN REGISTER 1          43840016
         SRL   GR0,12                  ISOLATE YEAR                     43900016
         SLDL  GR0,4                   PUT ZONE ON YEAR                 43960016
         CVB   GR4,DATE                CONVERT DAY                      44020016
         STH   GR0,DATE+6              PUT YEAR IN FIELD                44080016
         CVB   GR1,DATE                CONVERT YEAT                     44140016
         STH   GR4,DATE+6              SAVE DAY                         44200016
         STC   GR1,DATE+5              SAVE YEAR                        44260016
         CLC   56(3,GR5),DATE+5        DATA SET EXPIRED                 44360016
         BNH   SCRATCH                 YES-GO SCRATCH DATA SET @ZA11927 44600008
         TM    SEQSW+1,PURGE           NO-PURGE REQUESTED?              44800016
         BZ    UNEXPIRE                NO-GO TERMINATE JOB              45000016
         OI    WTORSW,ON                SET WTOR SWITCH         YM7392  45200002
         CLI   COPYSW,X'01'            IS THIS COPIES                   45210016
         BNE   SKIP1                   NO-GO PICK UP UCB POINTER        45220016
         L     GR8,CUCBPTR             PICK UP POINTER TO COPY UCB      45230016
         B     CONTINUE                                                 45240016
SKIP1    L     GR8,TUCBPTR             PICK UP POINTER TO UCB           45250016
         USING UCB,GR8                                                  45260016
CONTINUE EQU   *                                                        45270002
PASSBY   MVC   TRYAGAIN+55(6),SRTEVOLI  PUT VOL-SER IN WTOR        MC0I 45300018
PASSBY1  MVC   TRYAGAIN+24(3),UCBNAME   PUT CH-UNIT ADDRESS IN WTORMC0I 45320018
         DROP  GR8                                                      45350016
         L     GR8,CVTPTR              PICK UP POINTER TO CVT           45380016
         USING CVT,GR8                                                  45410016
         L     GR8,CVTTCBP             PICK UP POINTER TO TCB           45440016
         L     GR8,4(GR8)                                               45470016
         DROP  8                                                        45500016
         L     GR8,12(GR8)             PICK UP POINTER TO TIOT          45530016
         USING TIOT,GR8                                                 45560016
         MVC   TRYAGAIN+63(8),TIOCNJOB  SAVE JOBNAME AND STEPNAME  MC0I 45600018
         MVC   TRYAGAIN+73(16),TIOCSTEP      IN WTOR MESSAGE       MC0I 45640018
TRYAGAIN WTOR  'IEH807D       HAS UNEXPIRED DATA SETS,       ,         X45680003
                        ,                 .',REPLY,1,DISKECB,      MC0IX45720018
               ROUTCDE=(4),DESC=(2)                                MC0I 45760018
WTREPLY  TM    DISKECB,COMPLETE        IS OPERATION COMPLETE            45800016
         BO    OKAY                    YES-GO CLEAR BITS                46000016
         WAIT  ECB=DISKECB             N/-WAIT FOR REPLY                46200016
OKAY     MVI   DISKECB,0               CLEAR POSTED BITS IN ECB         46400016
         CLI   REPLY,X'E4'             DOES REPLY INDICATE USE          46600016
         BE    SCRATCH                 YES-GO SCRATCH DATA SET          46800016
         CLI   REPLY,X'E3'             NO-DOES REPLY INDICATE TERMINATE 47000016
         BNE   NEWREPLY                NO-OPERATOR ERROR                47200002
UNEXPIRE LA    GR1,37                  UNEXPIRED DATASET ON TODD        47400016
         B     ERRORT                                                   47600016
NEWREPLY MVC   FILLIN+55(8),TIOCNJOB   PUT JOBNAME AND STEPNAME IN      47700016
         MVC   FILLIN+65(16),TIOCSTEP       WTO MESSAGE                 47800016
FILLIN   WTO   'IEH808I REPLY IN ERROR. REPLY WITH "U" OR "T",         C47900016
               ,                 .',ROUTCDE=(4),DESC=(5)           MC0I 48000018
         B     TRYAGAIN                 RE-ISSUE MSG                    48200002
         EJECT                                                          48200103
SCRATCH  EQU   *                                                Y02083  48210002
         TM    DSIDSIND(GR5),CHKPT      THIS A CHKPT/RSTRT DS ? Y02083  48250002
         BZ    NOCR2                    NO, BRCH                Y02083  48252002
         STM   GR5,GR8,PROMPTSA         SAVE WORK REG           Y02083  48256002
         L     GR8,TUCBPTR              GET TODD UCB ADDR       YM7392  48258002
         CLI   COPYSW,ON                COPIES ?                YM7392  48258402
         BNE   NOCR2A                   NO                      YM7392  48258802
         L     GR8,CUCBPTR              GET COPY UCB ADDR       YM7392  48259202
NOCR2A   EQU   *                                                YM7392  48259602
         BAL   GR4,PROMPT               YES, TELL OPERATOR.     Y02083  48260002
         SPACE 1                                                        48262002
NOCR2    EQU   *                                                Y02083  48270002
         USING F1DSCB,GR5               FORMAT 1               @Z40RSRB 48270508
         TM    DS1DSIND,F1RACDEF        RAC DEFINED            @Z40RSRB 48271008
         BZ    TONOTRAC                 BR IF NO               @Z40RSRB 48271508
         TM    DS1DSORG+D1,VSAMID       VSAM DSCB              @Z40RSRB 48272008
         BO    PR010                    BR IF YES TO OPEN      @Z40RSRB 48272508
         CLI   FUNCSW,RESTORE           DUMP/RESTORE FUNCTION  @Z40RSRB 48273008
         BH    RACCHKTO                 BR IF NO TO RACHECK    @Z40RSRB 48273508
         LA    GR15,ACHKTUPD            REQUEST UPDATE AUTH    @Z40RSGD 48273708
         CLI   DUMPSW,PARTIAL           PARTIAL DUMP/RESTORE   @Z40RSRB 48274008
         BE    RACCHKT2                 BR IF YES TO OPEN      @Z40RSRB 48274508
RACCHKTO EQU   *                        RACHECK DATASET NAME   @Z40RSRB 48275008
         LA    GR15,ACHKTALT            REQUEST ALTER AUTH     @Z40RSGD 48275208
RACCHKT2 EQU   *                        CHECK FOR COPY         @Z40RSGD 48275408
         LA    GR7,CONTROL2             RETURN IF SUCESSFUL    @Z40RSGD 48275708
         CLI   COPYSW,COPYON            WORKING ON COPY        @Z40RSRB 48276908
         BNE   GETOUCB2                 BR IF NO               @Z40RSRB 48277208
         L     GR8,CUCBPTR              GET COPY 'TO' UCB      @Z40RSRB 48277508
         B     SETUPUCB                 BR TO MOVE VOLSER      @Z40RSRB 48277808
GETOUCB2 EQU   *                        NOT COPY               @Z40RSRB 48278108
         L     GR8,TUCBPTR              GET 'TO' UCB           @Z40RSRB 48278408
SETUPUCB EQU   *                        MOVE VOLSER FOR RAC    @Z40RSRB 48278508
         USING UCB,GR8                  ADDRESS UCB            @Z40RSRB 48279008
         MVC   RACVOL,SRTEVOLI          MOVE VOLSER            @Z40RSRB 48279508
         RACHECK ENTITY=DS1DSNAM,MF=(E,RACKPRM), ALTER OWNER   @G32DSPD*48280032
               VOLSER=RACVOL,                                  @G32DSPD*48280332
               CLASS=DATASET,ATTR=(GR15) OF DATASET CHECKED    @Z40RSGD 48280632
         LTR   GR15,GR15                ALTER OWNER            @Z40RSRB 48281008
         BZR   GR7                      BRANCH IF YES          @Z40RSRB 48281508
         LA    GR1,MSG60                IEH860I MSG            @Z40RSRB 48282008
         BAL   GR5,MSGBLD               BUILD MSG              @Z40RSRB 48282508
*   PUT DDNAME IN MESSAGE                                      @Z40RSGD 48283008
         LA    GR5,DDNAME1              ASSUME IT IS FROM VOL  @Z40RSGD 48283408
         CLI   ACHKFLG2-ACHKLIST+RACKPRM,ACHKTRD IS IT FROM    @G32DSPD 48283932
         BE    MVDDN2                   YES-FROM VOLUME        @Z40RSGD 48289208
         LA    GR5,DDNAME2              ASSUME TO VOLUME       @Z40RSGD 48290408
         CLI   COPYSW,COPYON            IS IT A COPY VOL       @Z40RSGD 48290808
         BNE   MVDDN2                   NO-TO VOLUME           @Z40RSGD 48291608
         LA    GR5,DDNAME3              MUST BE COPY VOLUME    @Z40RSGD 48292808
MVDDN2   EQU   *                        DDNAME2 TO MSG         @Z40RSRB 48294008
         MVC   D0(L'DDNAME2,GR1),0(GR5) DDNAME TO MSG          @Z40RSGD 48295208
         B     GO                       PRINT MSG              @Z40RSRB 48296408
TONOTRAC EQU   *                        NOT RAC PROTECTED      @Z40RSRB 48297608
         DROP  GR5,GR8                                         @Z40RSRB 48298808
         TM    93(GR5),X'10'            IS IT PASSWORD PROTECTED M4979  48300002
         BZ    CONTROL2                 NO - DONT CHECK          M4979  48400020
         SPACE 1                                                        48410002
         TM    D83(GR5),VSAMID          VSAM DSCB ?             YM5964  48450002
         BO    PR010                    YES-GO TO OPEN          YM5964  48500002
         CLI   COPYSW,X'01'            COPIES BEING USED                48620016
         BNE   SKIP2                   NO-GO GET UCB POINTER            48640016
         L     GR8,CUCBPTR             PICK UP POINTER TO UCB           48660016
         B     ONWARD                                                   48680016
SKIP2    L     GR8,TUCBPTR             PICK UP POINTER TO UCB           48700016
         USING UCB,GR8                                                  48720016
ONWARD   EQU   *                                                        48810002
PASSOVER MVC   VOLIST+6(6),SRTEVOLI    PUT VOL-SER IN LIST              48990016
PASS     MVC   VOLIST+2(4),UCBTYP      PUT DEVICE TYPE IN LIST          49080016
         SR    GR0,GR0                 ZERO OUT REGISTER                49200016
         ST    GR5,PARMLIST+4          PROVIDE CURRENT DSCB FOR SCRATCH 49300016
         CLI   FUNCSW,RESTORE          IS FUNCTION DUMP/RESTORE US03168 49300608
         BH    PR040                    NO-CONTINUE             US03168 49302608
         CLI   DUMPSW,X'00'             YES, IS IT PARTIAL              49304608
         BNE   PR040                    NO-CONTINUE             US03168 49308003
         SPACE 1                                                        49309003
PR010    EQU   *                                                US03168 49310003
         LA    GR1,DADCB                LOAD DCBADDRS           US03168 49310203
         DROP  GR2,GR7                                          US03168 49310403
         USING IHADCB,GR1                                       US03168 49310603
         ST    GR1,OPENLD               PUT DCB ADDRS IN PARM   US03168 49311003
         MVI   OPENLD,X'8F'             SET END PARM FLAG       YM05997 49311202
         MVC   DCBDDNAM,DDNAME2         MOVE PRIME TO DDNAME    US03168 49311403
         CLI   COPYSW,X'01'             IS COPY SWITCH ON       US03168 49311603
         BNE   PR020                    NO-BRANCH OVER          US03168 49311803
         MVC   DCBDDNAM,DDNAME3         MOVE COPY TO DDNAME     US03168 49314003
PR020    EQU   *                                                US03168 49314203
         LA    GR0,READJFCB             ADDRS OF JFCB           US03168 49316003
         ST    GR0,LIST                 STORE IN PARM LIST      US03168 49318003
         MVI   LIST,X'87'               SET END INDICATOR       US03168 49320003
         RDJFCB MF=(E,OPENLD)           READ IN JFCB            US03168 49322003
         LA    GR1,READJFCB             ADDRS OF JFCB           US03168 49324003
         USING JFCB,GR1                                         US03168 49326003
         MVI   JFCBTSDM,X'08'           PREVENT JFCB WRITE-BACK US03168 49326103
         SPACE 1                                                        49336003
         MVC   JFCBDSNM,D0(GR5)         MOVE DSNAME TO JFCB     US03168 49340003
         OPEN  MF=(E,OPENLD),TYPE=J     OPEN DATASET            US03168 49342003
         LA    GR1,DADCB                LOAD DCB ADDRS          US03168 49344003
         USING IHADCB,GR1                                       US03168 49346003
         TM    DCBOFLGS,X'10'           WAS OPEN SUCCESSFUL     US03168 49348003
         BO    PR030                    YES-CONTINUE            US03168 49350003
         LA    GR1,36                   NO-SET ERROR CODE       US03168 49352003
         B     ERRORT                   GO PRINT MSG            US03168 49354003
         SPACE 1                                                        49356003
PR030    EQU   *                                                US03168 49358003
         CLOSE MF=(E,OPENLD)            CLOSE DATASET           US03168 49360003
         B     CONTROL2                 CONTINUE PROCESSING     US03168 49362003
         EJECT                                                          49364003
PR040    EQU   *                                                US03168 49366003
         DROP  GR1                                              US03168 49368003
         USING IHADCB,GR7                                       US03168 49370003
         SCRATCH PARMLIST              SCRATCH DATA SET                 49400016
         LTR   GR15,GR15               RETURN SUCCESSFUL                49600016
         BE    CONTROL2                                                 49800016
         TM    VOLIST+13,X'04'         I/O ERROR DURING SCRATCH         49820016
         BZ    PASSERR                 NO-PASSWORD ERROR                49840016
         LA    GR1,13                  YES-GO BUILD MESSAGE             49860016
         BAL   GR5,MSGBLD                                               49880016
         MVC   0(3,GR1),MSGCON         PROVIDE SVC NO TO PRINT          49900016
         CLI   COPYSW,X'01'            COPIES BEING USED                49920016
         BNE   SKIP3                   NO-GO MOVE DDNAME TO PRINT       49940016
         MVC   3(8,GR1),DDNAME3        PROVIDE COPIES TODD TO PRINT     49960016
         B     GO                                                       49980016
         EJECT                                                          49982002
**********************************************************************  49984002
*        THE FOLLOWING ROUTINE WILL PROMPT THE OPERATOR WHEN A          49986002
*        CHECKPOINT/RESTART DATA-SET IS ENCOUNTERED.                    49988402
**********************************************************************  49988502
         SPACE                                                          49988802
PROMPT   EQU   *                                                        49990002
         TM    WTORSW,CHPTP             PROMPTED OPER BEFORE?   YM7392  49992002
         BO    RELOAD                   YES, EXIT THIS RTNE.    YM7392  49992102
         MVC   CHKRESTR+SEROFFS(6),SRTEVOLI PUT VOL-SER IN WTOR Y02083  49992302
         MVC   CHKRESTR+UNITOFFS(3),UCBNAME PUT CH-UNIT IN WTOR Y02083  49993002
         DROP  GR8                                               Y02083 49994002
         L     GR8,CVTPTR              PICK UP POINTER TO CVT    Y02083 49996002
         USING CVT,GR8                                           Y02083 49998002
         L     GR8,CVTTCBP             PICK UP POINTER TO TCB    Y02083 49998402
         L     GR8,4(GR8)                                        Y02083 49998802
         DROP  8                                                 Y02083 49999202
         L     GR8,12(GR8)             PICK UP POINTER TO TIOT   Y02083 49999602
         USING TIOT,GR8                                          Y02083 49999702
         MVC   CHKRESTR+JN(L8),TIOCNJOB SAVE JOBNAME AND STPNM  YM7392  49999802
         MVC   CHKRESTR+SN(L8),TIOCSTEP      IN WTOR MESSAGE    YM7392  50000002
CHKRESTR WTOR  'IEH858D       HAS A CHECKPOINT/RESTART DATA SET,       X50006602
               ,        ,                 .',REPLY,1,DISKECB,  @ZA16477X50007600
               ROUTCDE=(4),DESC=(2)                              Y02083 50010602
         TM    DISKECB,COMPLETE        IS OPERATION COMPLETE     Y02083 50012602
         BO    OKOK                    YES-GO CLEAR BITS         Y02083 50013002
         WAIT  ECB=DISKECB             N/-WAIT FOR REPLY         Y02083 50013102
OKOK     MVI   DISKECB,0               CLEAR POSTED BITS IN ECB  Y02083 50013202
         CLI   REPLY,C'U'              DOES REPLY INDICATE USE   Y02083 50019902
         BE    RELOAD                   YES, RETURN             Y02083  50030002
         CLI   REPLY,C'T'               DID OPER TERM. REQUEST? Y02083  50043302
         BE    WRITEMSG                 TELL PRGMR THE OPER     Y02083  50045302
*                                       CANCELED HIS REQUEST.   Y02083  50049302
         MVC   FILLIT+55(8),TIOCNJOB   PUT JOBNAME AND STEPNAME IN      50051302
         MVC   FILLIT+65(16),TIOCSTEP       WTO MESSAGE         Y02083  50051702
FILLIT   WTO   'IEH808I REPLY IN ERROR. REPLY WITH "U" OR "T",         C50052102
               ,                 .',ROUTCDE=(4),DESC=(5)        Y02083  50052502
         B     CHKRESTR                 RE-ISSUE MSG            Y02083  50053702
RELOAD   EQU   *                                                Y02083  50053802
         OI    WTORSW,CHPTP             SET PROMPT FLAG         YM7392  50055802
         LM    GR5,GR8,PROMPTSA         RELOAD WORK REG         Y02083  50055902
         BR    GR4                      RETURN                  Y02083  50057902
WRITEMSG EQU   *                                                Y02083  50059002
         LA    GR1,MESS68               LOAD MSG NO. IEH868I    Y02083  50061102
         BAL   GR5,MSGBLD               BUILD MSG IEH868I       T02083  50063202
         MVC   0(L8,GR1),DDNAME1        MOVE IN DDNAME1       @ZA16475  50064299
         CLI   FUNCSW,DUMP              DUMP FUNCTION?        @ZA16475  50064999
         BE    LM                       DDNAME1 IT IS         @ZA16475  50065699
         MVC   0(L8,GR1),DDNAME2                              @ZA16475  50066399
LM       LM    GR5,GR8,PROMPTSA         RELOAD WORK REG       @ZA16475  50067099
         B     FORWARD                  GO PRT MSG AND EXIT     Y02083  50069502
         EJECT                                                          50071602
SKIP3    MVC   3(8,GR1),DDNAME2        PROVIDE TODD NAME TO PRINT       50073702
GO       LA    GR5,SETCODE             SET UP BRANCH AFTER PRINT        50075802
         B     MSGPRNT                 GO PRINT MESSAGE                 50077902
PASSERR  TM    VOLIST+13,X'02'         PASSWORD ERROR                   50080016
         BZ    SETCODE                 NO-OTHER ERROR/ABNORMALLY END    50120016
         LA    GR1,36                  YES-INCORRECT PASSWORD/TODD      50160016
         B     ERRORT                                                   50200016
CONTROL2 LA    GR5,140(GR5)            BUMP POINTER TO NEXT DSCB        50400016
         BCT   GR2,F1CHECK             SUBTRACT 1 FROM NO.DSCBS LEFT    50600016
         B     REPEAT2                 READ AGAIN                       51000016
         EJECT                                                          51000203
*********************************************************************** 51200016
*  THIS ROUTINE CHECKS TO SEE IF THERE ARE COPY VOLUMES. IF SO, THE   * 51250016
*   DCB IS PICKED UP, THE WRITE TO OPERATOR SWITCH IS INITIALIZED     * 51300016
*   AND THE NEXT VOLUME IS PROCESSED.                                 * 51350016
*********************************************************************** 51400016
CKMOREDD CLI   COPYSW,X'01'            HAVE ANY COPIES BEEN DONE        51500016
         BE    MORECOPY                YES-PICK UP CORRECT POINTER      51600016
         L     GR6,COPYPTR             ARE COPIES INVOLVED              51700016
         LTR   GR6,GR6                                                  51800016
         BE    RELEASE                 NO-GO RETURN CONTROL             52000016
         MVI   COPYSW,X'01'            INDICATE FIRST COPY DONE         52800016
         USING COPYBLK,6                                                53000016
RESUME   TM    FUNCSW,X'40'            IS FUNCTION FORMAT OR ANALYZE    53080016
         BO    FORMANAL               YES-FO PICK UP PROPER DCB POINTER 53160016
         LA    GR7,CIOBLOCK+44         PICK UP COPY DCB POINTER FOR     53240016
         B     SKIP                       DUMP OR RESTORE               53320016
FORMANAL LA    GR7,CIOBLOCK            PICK UP COPY DCB POINTER - F/A   53400016
SKIP     OI    WTORSW,OFF               RESET WTOR SWT          YM7392  53480002
         B     VREAD                   GO READ DSCB'S                   53600016
MORECOPY L     GR6,CCOPYPTR            PICK UP POINTER TO COPYBLOCK     54200016
         LTR   GR6,GR6                 MORE COPIES                      54260016
         BE    RELEASE                 NO-GO RETURN CONTROL             54320016
         B     RESUME                                                   54400016
*********************************************************************** 54600016
*  THIS ROUTINE IS USED TO PRINT ERROR MESSAGES FOR THE TO DEVICE     * 54660016
*    TO FREE CORE GOTTEN AND TO RETURN CONTROL.                       * 54720016
*********************************************************************** 54800016
ERRORT   BAL   GR5,MSGBLD              GO BUILD MESSAGE                 55200016
         CLI   COPYSW,X'01'            COPIES BEING USED                55300016
         BNE   SKIP4                   NO-GO MOVE DDNAME TO PRINT       55400016
         MVC   0(8,GR1),DDNAME3        YES-PROVIDE COPIES TODD TO PRINT 55500016
         B     FORWARD                                                  55600016
SKIP4    MVC   0(8,GR1),DDNAME2        PROVIDE TODD NAME TO PRINT       55700016
FORWARD  BAL   GR5,MSGPRNT             GO PRINT MESSAGE                 55800016
SETCODE  LA    GR15,8                  SET UP RETURN CODE/ERROR         56200016
ENDUP    CLI   FUNCSW,DUMP             MUST CORE BE FREED/DUMP ONLY     56300016
         BNE   GOBACK                  NO - GO RETURN                   56400008
         LR    GR3,GR15                SAVE RETURN CODE                 56450008
         L     GR4,TABLESIZ            PICK UP SIZE OF CORE             56500016
         LTR   GR4,GR4                 WAS CORE OBTAINED       @Z40RSRB 56510008
         BZ    GOBACK                  SKIP FREEMAIN IF NOT    @Z40RSRB 56520008
         LA    GR8,TABLEAD             PICK UP ADDRESS OF CORE          56600016
         FREEMAIN E,LV=(4),A=(8)       FREE CORE GOTTEN                 56800016
         LR    GR15,GR3                PUT RETURN CODE BACK IN REG 15   56900016
GOBACK   TM    FLGBYT2,CPYREJEC        'CPYVOLID' DISALLOWED   @G32DSPD 56920032
         BNO   KEEPRCX                 NO,LEAVE R-CODE AS IS   @G32DSPD 56960032
         CLM   GR15,B'0001',RC4        CURRENT R-CODE G.E. 4   @G32DSPD 57000032
         BNL   KEEPRCX                 YES,KEEP THAT CODE      @G32DSPD 57040032
         LA    GR15,4                  USE RC4 RETURN          @G32DSPD 57080032
KEEPRCX  EQU   *                       R-CODE NOT CHANGED      @G32DSPD 57120032
         L     GR13,PASSSAVE+4         RESTORE REGISTER 13              57160032
         RETURN (14,12),T,RC=(15)      RETURN WITH PROPER CODE          57200016
*********************************************************************** 57400016
*  THIS SECTION PRINTS ERROR MESSAGES FOR THE FROM DEVICE, AND SETS   * 57450016
*    UP RETURN CODES. THE SYNADAF MACRO IS USED FOR THE I/O ERROR     * 57500016
*    MESSAGE.                                                         * 57550016
*********************************************************************** 57600016
NOCARD   LA    GR1,40                  NO DD CARD FOR SECURITY DS       57660016
         B     ERRORF                                                   57720016
BADPASS  LA    GR1,36                  INCORRECT PASSWORD/FROMDD        57800016
ERRORF   BAL   GR5,MSGBLD              GO BUILD MESSAGE                 58000016
         MVC   0(8,GR1),DDNAME1        PROVIDE FROMDD NAME TO PRINT     58200016
         LA    GR5,SETCODE             SET UP FOR BRANCH AFTER PRINT    58300016
         B     MSGPRNT                 GO PRINT MESSAGE                 58400016
DUMPFUNC CLI   FUNCSW,DUMP             IS FUNCTION DUMP                 58500016
         BNE   SETCODE                 NO-ABNORMALLY TERMINATE JOB      58600016
RELEASE  LA    GR15,0                  SET UP RETURN CODE/SUCCESSFUL    58800016
         B     ENDUP                                                    59000016
MORECORE L     GR7,PTRCFUNC            INDICATE CORE NOT AVAILABLE/WAIT 59200016
         OI    0(GR7),NOCORE+WAITING                                    59400016
         LA    GR15,4                  SET RETURN CODE AND RETURN       59600016
         B     ENDUP                                                    59800016
* RACF AUTHORIZATION FAILURE, 'CPYVOLID' NOT ALLOWED.          @G32DSPD 59805032
UNAUTHC  LA    GR1,MSG64               INDICATE MSG IEH864I    @G32DSPD 59810032
         BAL   GR5,MSGBLD              GET MESSAGE TEXT        @G32DSPD 59815032
         MVC   0(L'RACVOL,GR1),RACVOL  SET VOLID IN MESSAGE    @G32DSPD 59820032
         BAL   GR5,MSGPRNT             GO PRINT MESSAGE        @G32DSPD 59825032
         BR    GR4                     CONTINUE OTHER FUNCTIONS@G32DSPD 59830032
* RACF AUTHORIZATION FAILURE ON 'FROM VOL'.                    @G32DSPD 59835032
UNAUTHF  LA    GR1,MESS66              INDICATE MSG IEH866I.   @G32DSPD 59840032
         BAL   GR5,MSGBLD              GET MESSAGE TEXT        @G32DSPD 59845032
         MVC   0(L7,GR1),DUMPNM        SET FUNCTION NAME       @G32DSPD 59850032
         MVC   20(L'DDNAME1,GR1),DDNAME1 INDICATE DDNAME       @G32DSPD 59852032
         LA    GR5,SETCODE             SET BAL RETURN,RC=8     @G32DSPD 59855032
         B     MSGPRNT                 PRINT AND TERMINATE     @G32DSPD 59860032
*  RACF AUTHORIZATION FAILURE ON 'TO VOL'.                     @G32DSPD 59865032
UNAUTHT  LA    GR1,MESS66              INDICATE MSG IEH866I    @G32DSPD 59870032
         BAL   GR5,MSGBLD              GET MESSAGE TEXT        @G32DSPD 59875032
         MVC   0(L7,GR1),DUMPNM        USE DUMP NAME           @G32DSPD 59880032
         CLI   FUNCSW,DUMP             IS IT DUMP ?            @G32DSPD 59885032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59890032
         MVC   0(L7,GR1),RESTNM        USE RESTORE NAME        @G32DSPD 59895032
         CLI   FUNCSW,RESTORE          IS IT RESTORE ?         @G32DSPD 59900032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59905032
         MVC   0(L7,GR1),ANALZNM       USE ANALYZE NAME        @G32DSPD 59910032
         CLI   FUNCSW,ANALYSIS         IS IT ANALYZE ?         @G32DSPD 59915032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59920032
         MVC   0(L7,GR1),FRMATNM       USE FORMAT NAME         @G32DSPD 59925032
         CLI   FUNCSW,FORMAT           IS IT FORMAT ?          @G32DSPD 59930032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59935032
         MVC   0(L7,GR1),BLANKS        UNKNOWN FUNCTION        @G32DSPD 59940032
SETDD2   MVC   20(L8,GR1),DDNAME2      SET DDNAME              @G32DSPD 59945032
         CLI   COPYSW,COPYON           THIS A COPY ?           @G32DSPD 59950032
         BNE   KPDD2                   NO,KEEP DDNAME2         @G32DSPD 59955032
         MVC   20(L8,GR1),DDNAME3      USE DDNAME3-COPY DD     @G32DSPD 59960032
KPDD2    LA    GR5,SETCODE             SET RC=8                @G32DSPD 59965032
         B     MSGPRNT                 PRINT AND TERMINATE     @G32DSPD 59970032
IOERR    LA    GR1,13                  I/O ERROR                        60000016
         BAL   GR5,MSGBLD              GO BUILD MESSAGE                 60200016
         SYNADAF ACSMETH=EXCP,PARM1=DISKIOB                             60400016
         MVC   MESS+22(78),49(GR1)     I/O INFORMATION TO PRINT  SM4350 60600021
         SYNADRLS                                                       60800016
         LA    GR5,SETCODE             SET UP FOR BRANCH AFTER PRINT    60870016
         B     MSGPRNT                 GO PRINT MESSAGE                 60940016
MSGBLD   LINK  EP=IEHDMSGB             BUILD MESSAGE                    61010016
         BR    GR5                                                      61080016
MSGPRNT  LINK  EP=IEHDPRNT             PRINT MESSAGE                    61150016
         BR    GR5                                                      61220016
         DROP  6                                                        61290016
         AIF  ('&LIB' NE 'LIB1').NOTOS  BRCH IF NON-OS ASSEM Y02083     61292002
*********************************************************************** 61296016
*   THIS SECTION CALCULATES THE ADDRESS OF THE MAIN UCB GIVEN THE SUB * 61302016
*      UCB POINTER FOR A 2321.                                        * 61308016
*********************************************************************** 61314016
         USING DATACELL,GR8                                             61318016
         USING JFCB,GR2                                         US03168 61318103
IS2321   MVC   JFCBVOLS(6),DCELVOLI    PUT VOL-SER FOR 2321 IN JFCB     61322016
         B     BACK                                                     61326016
YES2321  MVC   TRYAGAIN+56(6),DCELVOLI  PICK UP 2321 VOL-SER       MC0I 61328018
         MVI   TRYAGAIN+26,C'/'                                    MC0I 61330018
         MVC   TRYAGAIN+27(1),DCELBBNR+1    BIN NO. W/CUU FOR 2321 MC0I 61332018
         LA    GR3,PASSBY1             SET BRANCH AFTER CALCULATION     61334016
         B     CKMAIN                                                   61338016
Y2321    MVC   VOLIST+6(6),DCELVOLI    PICK UP 2321 VOL/SER             61342016
         LA    GR3,PASS                SET BRANCH AFTER CALCULATION     61346016
CKMAIN   LH    GR15,DCELBBNR           CALCULATE MAIN UCB               61350016
         SLL   GR15,4                                                   61356016
         LA    GR15,SRTEUSER-UCBOB(GR15)                                61362016
         SR    GR8,GR15                                                 61368016
NOCONVRT BR    GR3                                                      61374016
         DROP  8                                                        61380016
.NOTOS   ANOP                                                   Y02083  61390002
*********************************************************************** 61400016
*    WAIT ROUTINE FOR I/O OPERATIONS                                  * 61500016
*********************************************************************** 61600016
WAIT     TM    DISKECB,COMPLETE        IS OPERATION COMPLETE            61800016
         BO    TEST                    YES-GO TEST STATUS               62000016
         WAIT  ECB=DISKECB             NO-WAIT COMPLETION OF DISK       62200016
TEST     EQU   *                                                 A33538 62280020
         CLC   DSENSE(2),ZERO          ANY ERROR CONDITION.      A33538 62360020
         BNE   IOERR                   YES-I/O ERROR.            A33538 62440020
         CLI   DISKECB,GOOD            ALL OK.                   A33538 62520020
         BNE   IOERR                   NO-I/O ERROR                     62600016
         MVI   DISKECB,0               CLEAR POSTED BITS IN ECB         62800016
         BR    GR4                     RETURN                           63000016
         SPACE                                                          63050020
SETCCW   DS    0D                                                M6183  63080020
         CCW   X'23',F1,X'40',1         SET SECTOR ZERO          M5900  63110020
TIC      CCW   8,0,X'40',0                                       S20201 63150020
CCWLIST  CCW   X'31',SEEKAD+3,X'40',5                                   63200016
         CCW   X'08',CCW1-CCWBUFF,0,0                                   63400016
RDCCW    CCW   X'0E',0,X'60',140                                        63600016
RDCNT    CCW   X'92',SEEKAD+3,X'20',5                                   63800016
*   DA EVENT CONTROL BLOCK (ECB).                                       64000016
         DS    0D                      NECESSARY ALIGNMENT              64200016
DISKECB  DC    F'0'                    WAIT/COMPLETE BITS               64400016
*   DA INPUT/OUTPUT BLOCK (IOB).                                        64600016
DISKIOB  DS    0F                                                       64800016
DFLAGS   DC    XL2'4200'               FLAG1 AND FLAG2                  65000016
DSENSE   DC    H'0'                    SENSE BYTES                      65200016
DECBAD   DC    A(DISKECB)              ECB ADDRESS                      65400016
DSTATUS  DC    2F'0'                   CHANNEL STATUS                   65600016
DCCWAD   DC    1F'0'                   CCW ADDRESS                      65800016
DDCBAD   DC    F'0'                    DCBADDRESS                       66000016
DRESAD   DC    F'0'                    RESTART ADDRESS                  66200016
DBLKCT   DC    H'1'                    BLOCK COUNT INCREMENT            66400016
DERROR   DC    H'0'                    ERROR COUNT                      66600016
SEEKAD   DC    1F'0'                   MBBCCHHR                         66800016
         DC    X'00000001'                                              67000016
LASTDSCB DS    CL5                                                      67200016
NINES    DC    CL5'99999'                                               67400016
ZERO     DC    H'0'                    CHECK SENSE BYTES.        A33538 67500020
SIXTEEN  DC    F'16'                                          A@ZA32596 67510099
EIGHT    DC    F'8'                                           A@ZA32596 67520099
SAVECCW  DC    4F'0'                                          A@ZA32596 67530099
SAVECCHH DC    X'0000000000'                                  A@ZA32596 67540099
TSTDSCB  DC    X'00'                                          A@ZA32596 67550099
LIST     DS    0F                      FOR READ IN JFCB                 67600016
         DC    X'87'                                                    67800016
         DC    AL3(0)                                                   68000016
OPENLD   RDJFCB (,(INPUT)),MF=L        PARAMETER LIST FOR OPEN          68200016
TABLESIZ DS    1F                      SIZE OF DSNAME TABLE             68400016
TABLEAD  DS    1F                      POINTER TO DSNAME TABLE          68600016
DATE     DS    1D                      CURRENT DATE                     68800016
SECSW    DS    CL1                     SECURITY SWITCH                  69000016
WTORSW   DS    CL1                     WRITE TO OPERATOR INDICATOR      69200016
COPYSW   DS    CL1                     COPYSWITCH                       69400016
REPLY    DS    CL1                     OPERATOR REPLY                   69600016
REPLYAD  DC    A(REPLY)                ADDRESS OF OPERATOR REPLY AREA   69800016
GOOD     EQU   X'7F'                   NO I/O ERROR                     69900016
TICCODE  EQU   X'08'               TIC CCW OP CODE               S20201 69920020
D0       EQU   0                        DISP OF ZERO            SA61117 69922003
D1       EQU   1                   DISP OF 1                     S20201 69940020
L3       EQU   3                   LENGTH OF 3                   S20201 69960020
RACKPRM  RACHECK MF=L,CLASS=DATASET                            @G32DSPD 69970032
DATASET  DC    AL1(7),CL7'DATASET'      CLASS NAME             @Z40RSRJ 69980132
DASDVOL  DC    AL1(7),CL7'DASDVOL'      DASD CLASS NAME        @G32DSPD 69985032
RACVOL   DS    CL6                     VOLSER TO RACHECK       @Z40RSRB 69990008
PARMLIST CAMLST SCRATCH,0,,VOLIST,,OVRD                                 70000016
VOLIST   DC    H'1'                    VOLUME LIST FOR SCRATCH DATA SET 70200016
         DS    1H                                                       70400016
         DS    2F                                                       70600016
         DC    H'0'                                                     70800016
DSCBNO   DS    1F                      SAVE AREA FOR NUMBER DSCBS       70900016
DSCBPTR  DS    1F                      POINTER TO READAREA FOR DSCBS    71000016
RDCNTAD  DS    F                                                        71050016
DUMPNM   DC    CL7'DUMP   '            FUNCTION NAME           @G32DSPD 71057032
RESTNM   DC    CL7'RESTORE'            FUNCTION NAME           @G32DSPD 71064032
FRMATNM  DC    CL7'FORMAT '            FUNCTION NAME           @G32DSPD 71071032
ANALZNM  DC    CL7'ANALYZE'            FUNCTION NAME           @G32DSPD 71078032
RC4      DC    AL1(4)                  RACF R-CODE TESTS       @G32DSPD 71085032
RC8      DC    AL1(8)                  RACF RETURN-UNAUTHORIZED@G32DSPD 71092032
INCON    DC    C'SYSIN   '                                              71100016
PRINTCON DC    C'SYSPRINT'                                              71200016
DPASS    DC    CL8'DPASS   '            PAREST DDNAME           SA61117 71202003
F1       DC    F'1'                                              S20201 71250020
BLANKS   DC    CL8' '                                            A44112 71270021
TWENTY   DC    H'20'                                                    71300016
FOUR     DC    H'4'                                                     71400016
MSGCON   DC    C'29,'                  SVC NO. FOR I/O ERROR MESSAGE    71500016
TIOTSAVE DS    1F                      SAVE AREA FOR FIRST DD ENTRY     71600016
PROMPTSA DS    5F                       SAVE AREA FOR SUB-RTNE  Y02083  71650002
PASSSAVE DS    18F                                                      71800016
SWITCH1  NOPR  14                                                       72000016
SWITCH2  NOPR  15                                                       72200016
READJFCB DS    44F                     AREA TO READ IN JFCB             72400016
DADCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST                    72600016
         ICHPRCVT                                              @ZA25515 72800099
         EJECT                                                          72840099
         ICHACHKL                                          /*@Z40RSGD*/ 72880099
         EJECT                                                          72920099
         IEHDWORK                                                       72960099
         EJECT                                                          73000099
         IEHDBLKS                                                       73040099
         EJECT                                                          73080099
CCWBUFF  DSECT                                                          73200016
CCW1     DS    1D                                                       73400016
CCW2     DS    1D                                                       73600016
CCW3     DS    1D                                                       73800016
         EJECT                                                          73810099
F1DSCB   DSECT                          DSECT FOR F1DSCB       @Z40RSRB 73860099
         IECSDSL1 (1)                   FORMAT 1 DSCB          @Z40RSRB 73910099
F1RACDEF EQU   X'40'                    DS1DSIND=RAC DEFINED   @Z40RSRB 73960099
         EJECT                                                          74010099
CVT      DSECT                                                          74060099
         CVT                                                   @G32DSPD 74110099
         EJECT                                                          74160099
UCB      DSECT                                                          74210099
         IEFUCBOB                                                       74260099
         EJECT                                                          74310099
JFCB     DSECT                                                          74360099
         IEFJFCBN                                                       74410099
         DCBD  DSORG=PS                                                 74460099
         EJECT                                                          74510099
TIOT     DSECT                                                          75400016
TIOCNJOB DS    2F                                                       75600016
TIOCSTEP DS    4F                                                       75800016
DDENTRY  DS    0F                      DD ENTRY FOR EACH DD CARD        76000016
TIOELNGH DS    CL1                     LENGTH OF DD ENTRY               76200016
TIOESTTA DS    CL1                                                      76400016
TIOERLOC DS    CL2                                                      76600016
TIOEDDNM DS    2F                                                       77000016
TIOEJFCB DS    CL3                                                      77400016
TIOESTTC DS    CL1                                                      77600016
TIOESTTB DS    CL1                                                      77800016
TIOEFSRT DS    CL3                                                      78000016
         END                                                            88000016
./  ADD  SSI=70880146,NAME=IEHDPRNT
 TITLE   'OUTPUT MESSAGE WRITER  IEHDPRNT'                              00900016
         COPY  LCGASMSW                                                 00950021
IEHDPRNT CSECT                                                          01800016
*                                                                       01800403
*C 72000,684000                                                @ZA01240 01800803
*A 63500-64000                                                 @ZA01240 01801203
*                                                                       01801603
*A 423500-425000,706500             @SA69598=@YA06118=@XA06603=@ZA01240 01802002
************************************************************            01804002
*                                                                  0811 01806017
*1417684000                                                        0811 01812017
*                                                                  1352 01814018
*3476684000                                                        1352 01816018
*                                                                     * 01820016
*684000                                                            6057 01830019
*3462684000                                                      M0028  01832020
*3462                                                            A32533 01835020
*3462684000                                                      M0025  01840020
*STATUS CHANGE LEVEL 005                                                01845020
*                                                                     * 01860016
*FUNCTION/OPERATION- THIS ROUTINE HANDLES ALL OUTPUT TO THE SYSOUT    * 01880016
*   DATA SET FOR THE IEHDASDR SYSTEM UTILITY PROGRAM. INITIAL ENTRY   * 01900016
*   TO THIS ROUTINE RESULTS IN THE HEADER INFORMATION BEING FORMATED  * 01920016
*   (PROGRAM TITLE, DATE, AND PAGE NUMBER) AND WRITTEN OUT USING THE  * 01940016
*   QSAM PUT MACRO, MOVE MODE. THE MESSAGE BUFFER (IN IEHDWORK        * 01960016
*   DSECT) IS THEN BLANKED OUT AND CONTROL RETURNED TO THE MONITOR.   * 01980016
*   SUBSEQUENT ENTRIES WILL WRITE OUT THE CONTENTS OF THIS BUFFER     * 02000016
*   (CONTROL CARDS,MESSAGES, ETC.), DECREMENT THE LINE COUNT,         * 02020016
*   BLANK THE OUTPUT BUFFER, AND RETURN TO THE CALLER.                * 02040016
*                                                                     * 02060016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDPRNT-.                    * 02080016
*                                                                     * 02100016
*INPUT- A POINTER TO THE WORK AREA IN REGISTER 12.                    * 02120016
*                                                                     * 02140016
*EXITS-NORMAL- CONTROL IS RETURNED TO THE CALLING ROUTINE BY A        * 02160016
*   BRANCH ON REGISTER 14. NO RETURN CODE IS PASSED.                  * 02180016
*                                                                     * 02200016
*EXITS-ERROR- NONE.                                                   * 02220016
*                                                                     * 02240016
*EXTERNAL ROUTINES- INITIAL ENTRY TO THIS ROUTINE AND FOR EACH        * 02260016
*   NEW PAGE OF OUTPUT, THE ROUTINE WILL CALL -IEHDDATE- TO PROCESS   * 02280016
*   MONTH/DAY/YEAR FOR THE HEADING.                                   * 02300016
*                                                                     * 02320016
*TABLES/WORK AREAS- UPON ENTRY, REGISTER 12 WILL POINT TO THE WORK    * 02340016
*   AREA, DESCRIBED BY THE DSECT -IEHDWORK-.                          * 02360016
*                                                                     * 02380016
*ATTRIBUTES- SERIALLY REUSABLE, RELOCATABLE.                          * 02400016
*                                                                     * 02420016
*NOTE- THE VERSION LEVEL OF THE IEHDASDR SYSTEM UTILITY PROGRAM IS    * 02440016
*   CONTAINED IN THE HEADER INFORMATION LABELED 'TOPLINE'. THIS       * 02460016
*   VERSION LEVEL SHOULD BE UPDATED WHEN INCREMENTAL IMPROVEMENTS     * 02480016
*   AND/OR RELEASE LEVELS CHANGE.                                     * 02500016
*                                                                     * 02520016
         EJECT                                                          02540016
         SAVE  (14,12),T,*             SAVE THE REGISTERS.              02800016
         USING IEHDPRNT,REG11          SET UP ADDRESSIBILITY.           03800016
         USING WORK,12                                                  05400016
         LR    REG11,REG15             LOAD BASE REGISTER.              06300016
         B     APARNO                  BRANCH AROUND APARNO    @ZA01240 06350003
         DC    C'IEHDPRNT OZ01240'     LAST FIX THIS MOD       @ZA01240 06400003
APARNO   LA    REG1,PRNTSAVE           ADDRESS NEW SAVE AREA.  @ZA01240 07200003
         ST    REG1,8(REG13)           SAVE ADDRESS OF NEW AREA IN OLD. 08100016
         ST    REG13,4(REG1)           SAVE ADDRESS OF OLD AREA IN NEW. 09000016
         LR    REG13,REG1              SAVE AREA ADDRESS.               09300016
         MVC   MSGNO(2),MESS+K4        SAVE MSG NUMBER.          A32533 09400020
         LA    REG3,MSGWTR             ADDRESS OF MESSAGE BUFFER.       09600016
         SPACE 1                                                        09900016
         TM    MSGSW1,X'FF'            IS THIS THE INITIAL ENTRY.       10800016
         BC    8,FRSTNTRY              YES-GO PRINT HEADER AND PAGE NO. 11700016
         BAL   REG9,PRINT              NO--GO PRINT A LINE.             12600016
         SPACE 1                                                        13500016
RETURN   L     REG13,PRNTSAVE+4        RESET REGISTER 13.               14400016
         RETURN (14,12),T              RESTORE REGS AND RETURN.         15300016
         SPACE 1                                                        16200016
PRINT    L     REG4,PRINT1             DCB ADDRESS.                     18200016
         PUT   (REG4),(REG3)           WRITE OUT THE MESSAGE.           20700016
         MVI   MSGWTR,X'40'            SET FOR SINGLE SPACE.            20900016
         MVI   MESS,BLANK              BLANK FIRST BYTE.                21100016
         MVC   MESS+1(119),MESS        CLEAR REMAINDER OF BUFFER.       21300016
         LH    REG7,LINECNT1           PICK UP THE NUMBER OF LINES.     21600016
         BCT   REG7,NOTHDR             REDUCE BY ONE/BRANCH NOT ZERO.   22500016
         CLC   MSGNO(2),LASTMSG        LAST LINE OF FUNCTION.    A32533 22800020
         BE    K0(0,REG9)              YES-RETURN TO CALLER.     A32533 23100020
         MVC   LINECNT1(2),LINECNT     RESET THE LINE COUNT.            23400016
         BAL   REG8,HEADER1            BRANCH TO PRINT HEADER.          24300016
         BR    REG9                    RETURN.                          25200016
         SPACE 1                                                        26100016
NOTHDR   STH   REG7,LINECNT1           SAVE THE NEW LINE COUNT.         27000016
         BR    REG9                    RETURN.                          28800016
         SPACE 2                                                        29700016
HEADER   MVI   MESS,BLANK              BLANK FIRST BYTE.                30600016
         MVC   MESS+1(119),MESS        CLEAR REMAINDER OF BUFFER.       31500016
HEADER1  MVC   NOTHER+10(4),PAGE       MOVE IN PAGE.                    32400016
         LH    REG6,PAGENO             PICK UP THE PAGE NUMBER.         33300016
         CVD   REG6,DOUBLE             CONVERT TO DECIMAL.              34200016
         UNPK  NUMB(3),DOUBLE+6(2)     CONVERT TO GRAPHIC AND MOVE.     35100016
         OI    NUMB+2,X'F0'            RESET ZONE.                      36000016
         LA    REG6,LAST1-TOPLINE-1    LENGTH OF HEADER MINUS ONE.      36900016
         L     REG7,HEAD               ADDRESS OF HEADER.               37800016
         EX    REG6,MOVER              MOVE IN THE HEADER.              38700016
         LA    REG1,MESS+5             TARGET ADDRESS FOR DATE.         39000016
         CALL  IEHDDATE                                                 39300016
         MVI   CC,X'F1'                CONTROL CHARACTER.               39600016
         L     REG4,PRINT1             DCB ADDRESS.                     40600016
         PUT   (REG4),(REG3)           WRITE OUT THE HEADER.            42300016
         LH    REG7,LINECNT1           PICK UP NUMBER OF LINES @ZA01240 42350002
         LH    REG5,THREE              LOAD 3 TO REG5          @ZA01240 42400002
         SR    REG7,REG5               SUBTRAKT 3 FROM LINECNT @ZA01240 42450002
         STH   REG7,LINECNT1           SAVE NEW LINECNT        @ZA01240 42500002
         MVI   MESS,BLANK              BLANK FIRST BYTE.                42600016
         MVC   MESS+1(119),MESS        CLEAR REMAINDER OF BUFFER.       42900016
         MVI   MSGWTR,X'60'            TRIPLE SPACE BEFORE PRINT.       43200016
         LH    REG6,PAGENO             PICK UP THE PAGE NUMBER.         47700016
         LA    REG6,1(REG6)            ADD ONE TO PAGE NUMBER.          48600016
         STH   REG6,PAGENO             SAVE THE NEW PAGE NUMBER.        49500016
         BR    REG8                    RETURN.                          50400016
         SPACE 1                                                        51300016
FRSTNTRY BAL   REG8,HEADER             GO WRITE OUT THE HEADER.         52300016
         MVI   MSGSW1,X'FF'            INDICATE FIRST ENTRY.            54900016
         B     RETURN                  TAKE NORMAL EXIT.                55800016
         SPACE 1                                                        58500016
DOUBLE   DC    1D'0'                   WORK AREA FOR CONVERT.           62100016
PRNTSAVE DS    18F                     SAVE AREA FOR CALLED ROUTINES.   63000016
HEAD     DC    A(TOPLINE)              ADDRESS OF HEADER                63900016
MOVER    MVC   MESS+35(1),0(REG7)      EXECUTED TO MOVE IN HEADER.      64800016
PAGE     DC    CL4'PAGE'               'PAGE' HEADING.                  65700016
TOPLINE  DC    CL29'SYSTEM SUPPORT UTILITIES --- '                      67500016
         DC    CL17'IEHDASDR   MVS-3.0'                        @ZA01240 68400003
LAST1    DS    0C                      END OF HEADER.                   69300016
BLANK    EQU   C' '                    BLANK CHARACTER.                 70200016
M39      EQU   39                      LAST MSG PRINTED.         A32533 70300020
K4       EQU   4                       DISPLACEMENT CONSTANT     A32533 70400020
K0       EQU   0                       DISPLACEMENT CONSTANT     A32533 70500020
MSGNO    DS    1H                      MESSAGE NUMBER AREA       A32533 70600020
THREE    DC    H'3'                    NO OF LINES/HEADER      @ZA01240 70650002
LASTMSG  DC    CL2'39'                 LAST MESSAGE PRINTED      A32533 70700020
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             71100016
REG0     EQU   0                                                        72000016
REG1     EQU   1                                                        72900016
REG2     EQU   2                                                        73800016
REG3     EQU   3                                                        74700016
REG4     EQU   4                                                        75600016
REG5     EQU   5                                                        76500016
REG6     EQU   6                                                        77400016
REG7     EQU   7                                                        78300016
REG8     EQU   8                                                        79200016
REG9     EQU   9                                                        80100016
REG10    EQU   10                                                       81000016
REG11    EQU   11                                                       81900016
REG12    EQU   12                                                       82800016
REG13    EQU   13                                                       83700016
REG14    EQU   14                                                       84600016
REG15    EQU   15                                                       85500016
         SPACE 1                                                        86400016
         IEHDWORK                                                       91400016
         END                                                            98100016
./  ADD  SSI=70880147,NAME=IEHDRCVR
 TITLE 'IEHDRCVR - RECOVER FROM I/O ERRORS WHEN DUMPING TO SYSPRINT'    00100019
         COPY  LCGASMSW                                          SM4351 00200021
IEHDRCVR CSECT                                                     O122 00250021
*******************************************************************O122 00300019
*                                                                  O122 00400019
*STATUS - CHANGE LEVEL 000                                         O122 00500019
*                                                                  O122 00600019
*FUNCTION/OPERATION - IEHDRCVR RECEIVES CONTROL WHEN IEHDEXCP      O122 00700019
*        ENCOUNTERS A PERMANENT DATA CHECK OR MISSING ADDRESS      O122 00800019
*        MARKER ON A DIRECT ACCESS DEVICE WHILE DUMPING TO SYSOUT. O122 00900019
*        THE ROUTINE PRINTS THE GOOD PORTION OF THE TRACK ALREADY  O122 01000019
*        READ SUCCESSFULLY, IDENTIFIES THE RECORD AND FIELD (COUNT,O122 01100019
*        KEY OR DATA) IN ERROR, READS AND PRINTS THE DEFECTIVE     O122 01200019
*        RECORD, MODIFIES THE ORIGINAL CHANNEL PROGRAM TO BYPASS   O122 01300019
*        THIS RECORD, AND RETURNS CONTROL TO IEHDEXCP.             O122 01400019
*                                                                  O122 01500019
*ENTRY POINTS - THIS ROUTINE IS ALWAYS ENTERED AT IEHDRCVR.        O122 01600019
*        CONTROL IS ALWAYS RECEIVED FROM IEHDEXCP.                 O122 01700019
*                                                                  O122 01800019
*INPUT - THE ADDRESS OF THE DIRECT ACCESS IOB MUST BE IN REG 6.    O122 01900019
*                                                                  O122 02000019
*OUTPUT - THE DEFECTIVE TRACK IS PRINTED ON THE SYSTEM OUTPUT      O122 02100019
*        DEVICE, WITH A MESSAGE DECSRIBING THE FIELD IN ERROR.     O122 02200019
*                                                                  O122 02300019
*EXTERNAL ROUTINES - IEHDAOUT IS USED TO FORMAT AND PRINT THE TRACKO122 02400019
*        IMAGE.  A SWITCH CONTROLS HOW MUCH OF THE RECORD IS       O122 02500019
*        PRINTED  AT A TIME AND HOW IT IS FORMATTED. IEHDMSGB IS   O122 02600019
*        USED TO FORMAT THE MESSAGES AND IEHDPRNT TO PRINT THEM.   O122 02700019
*        ALL EXTERNAL ROUTINES ARE ENTERED VIA THE LINK MACRO OR   O122 02800019
*        A DIRECT BRANCH AND LINK.                                 O122 02900019
*                                                                  O122 03000019
*EXITS-NORMAL - CONTROL IS RETURNED TO IEHDEXCP WITH A RETURN CODE O122 03100019
*        OF 0 IF IEHDRCVR SUCCESSFULLY RECOVERED AND PRINTED THE   O122 03200019
*        DEFECTIVE RECORD.  A RETURN CODE OF 4 IS USED IF RECOVERY O122 03300019
*        WAS SUCCESSFUL AND IEHDEXCP IS TO CONTINUE WITH THE NEXT  O122 03400019
*        TRACK.                                                    O122 03500019
*                                                                  O122 03600019
*     -ERRORS - CONTROL IS RETURNED TO IEHDEXCP WITH A RETURN CODE O122 03700019
*        OF 8 IF THE DEFECTIVE RECORD COULD NOT BE RECOVERED (DATA O122 03800019
*        CHECK IN THE COUNT FIELD OR MISSING ADDRESS MARKER ON     O122 03900019
*        2301). IEHDEXCP SHOULD TERMINATE THE FUNCTION WITH A      O122 04000019
*        RETURN CODE OF 8.                                         O122 04100019
*                                                                  O122 04200019
*TABLES/WORKAREAS - FUNCBLK IS USED TO COMMUNICATE WITH IEHDAOUT.  O122 04300019
*        UPON ENTRY TO IEHDRCVR, REGISTER 10 POINTS TO THIS DSECT  O122 04400019
*                                                                  O122 04500019
*ATTRIBUTES - SERIALLY REUSABLE,RELOCATABLE,NONPRIVILEGED.         O122 04600019
         EJECT                                                     O122 04700019
*NOTE - IEHDRCVR MAY STORE IN ITS OWN CORE IF IT REINITIALIZES ALL O122 04800019
*        NEEDED CONSTANTS.  THIS IS BECAUSE SIMULTANEOUS FUNCTIONS O122 04900019
*        ARE IMPOSSIBLE WHEN DUMPING TO SYSOUT.                    O122 05000019
*                                                                  O122 05100019
*     - NEED TO BE ABLE TO RECOVER FROM I/O ERROR ON 06, 9E, 92,   O122 05200019
*        0E, 1E AND 12                                             O122 05300019
*                                                                  O122 05400019
*     -  06 IS ALWAYS READ DATA RECORD 0, 9F RAD COUNT KEY DATA R1 O122 05500019
*        0E READ KEY DATA RECORD 2                                 O122 05600019
*                                                                  O122 05700019
*     -  IEHDRCVR REPLACES ERROR CCW WITH 03, 0F 08 OR 12          O122 05800019
*                                                                  O122 05900019
*******************************************************************O122 06000019
         EJECT                                                     O122 06100019
         USING *,BASEREG                                           O122 06200019
         USING OUTIOB,IOB                                          O122 06300019
         USING OUTECB,A                VALID WHILE WAIT FOR I/O    O122 06400019
         USING FUNCBLK,BLKPTR                                      O122 06500019
         USING WORK,AWORK                                          O122 06600019
         SAVE  (14,12),T,*                                         O122 06700019
         LR    BASEREG,ENTER                                       O122 06800019
         LA    A,RCVRSAVE              SAVE AREA ADDRESS           O122 06900019
         ST    A,8(SAVEREG)            ADDR NEW SAVE AREA TO OLD   O122 07000019
         ST    SAVEREG,4(A)            ADDR OLD SAVE AREA TO NEW   O122 07100019
         LR    SAVEREG,A               CURRENT SAVE AREA           O122 07200019
         STM   PARM1,PARM2,DAOUTADR    SAVE PARAMETERS             O122 07300019
         LA    A,8                                                 O122 07400019
         L     ERRCCW,OUTSTAT          CCW ADDRESS FROM CSW        O122 07500019
         SR    ERRCCW,A                ADDR CCW GETTING DATA CHECK O122 07600019
         XC    TICADDR(4),TICADDR      INITIALIZE FOR CHKNOP AND   O122 07700019
*                                      RETRN1                      O122 07800019
         CLI   0(ERRCCW),X'31'         IS CCW A SEARCH             O122 07900019
         BE    SRCHERR                 YES                         O122 08000019
         TM    OUTSENSE+1,X'0A'        MISS ADR MKR AND NO REC FND O122 08100019
         BO    SRCHERR                 YES, CAN'T FIN HA OR R0     O122 08200019
         CLI   RECNUM,X'00'            FIRST ERROR AN TRACK EXCEPT O122 08300019
*                                      READ COUNT AND READ DATA    O122 08400019
         BNE   TESTRDSC                NO, TEST FOR ALREADY READ   O122 08500019
*        PRINT GOOD PORTION OF TRACK   (AT LEAST TRACK ADDRESS AND O122 08600019
*        R0 DATA)                                                  O122 08700019
NOTRDSUC L     ENDATA,0(ERRCCW)        ADDRESS OF INPUT            O122 08800019
         S     ENDATA,EIGHT                                        O122 08900019
         CLI   0(ERRCCW),X'0E'         IS CCW A READ KEY DATA (R2) O122 09000019
         BNE   FIRSTPR                 NO                          O122 09100019
         S     ENDATA,EIGHT            YES, DO NOT PRINT R2        O122 09200019
FIRSTPR  BAL   LINK2,PRINT             PRINT FIRST PART OF TRACK   O122 09300019
         MVI   AOUTSW,FMTCNT           SET SWITCH TO FORMAT COUNT  O122 09400019
         MVC   TRACKPT(4),0(ERRCCW)                                O122 09500019
         BAL   LINK1,SYNADAF           SET UP SYNADAF MESSAGE      O122 09600019
         BAL   LINK1,PRTMSG            PRINT SYNADAF MESSAGE       O122 09700019
         MVC   CCWCODE(8),0(ERRCCW)    SAVE ERROR CCW              O122 09800019
         TM    OUTSENSE+1,X'02'        MISSING ADDRESS MARKER      O122 09900019
         BO    MISADRMK                YES                         O122 10000019
         TM    OUTSENSE+1,X'80'        WAS IT DATA CHECK IN COUNT  O122 10100019
         BO    COUNTERR                YES, RCVR FROM DC IN COUNT  O122 10200019
         TM    CCWCODE,X'9E'           READ COUNT MULTI-TRK R1     O122 10300019
         BO    ERKEYDAT                YES, DC IN KEY OR DATA      O122 10400019
RESIDCNT SR    A,A                      ZERO                       O122 10500019
         CH    A,OUTSTAT+6             IS RESIDUAL COUNT ZERO      O122 10600019
         BNE   TRYRD                   NO, DATA CHECK IN KEY FIELD,O122 10700019
*                                      TRY READING DATA FIELD      O122 10800019
         TM    OUTSTAT+4,X'01'         IS IT END OF FILE RECORD    O122 10900019
         BNO   DATAERR                 NO, DATA CHECK IN DATA FIELDO122 11000019
*                                      YES, FALL THROUGH TO DATA   O122 11100019
*                                      CHECK IN KEY FIELD          O122 11200019
         EJECT                                                     O122 11300019
*******************************************************************O122 11400019
*        DATA CHECK IN KEY FIELD                                   O122 11500019
*******************************************************************O122 11600019
         SPACE 3                                                   O122 11700019
KEYMSG   EQU   *                                                   O122 11800019
*        PRINT DATA CHECK IN KEY                                   O122 11900019
         LA    FIELD,KEYFLD                                        O122 12000019
         BAL   LINK1,PRTMSG42          PRINT MESSAGE IEH842I       O122 12100019
*        DETERMINE IF ERROR CCW READ COUNT FIELD                   O122 12200019
INSRTWHT LA    A,CCWCODE                                           O122 12300019
         BAL   LINK1,GETRECNO          GET RECORD NUMBER           O122 12400019
         STC   B,RECNUM                UPDATE RECORD NUMBER        O122 12500019
         TM    CCWCODE,X'1E'           WAS ERROR CCW A RCKD        O122 12600019
         BO    INSRTRC                 YES, REPLACE WITH READ COUNTO122 12700019
*                                      AND RETURN                  O122 12800019
         L     A,OUTCCWAD               GET STARTING CCW ADDR   OX01495 12850002
         LA    A,0(A)                   ZERO HIGH BYTE          OX01495 12860002
         LA    ERRCCW,0(ERRCCW)         ZERO HIGH BYTE          OX01495 12870002
         CR    ERRCCW,A                 COMPARE ADDRESSES       OX01495 12880002
         BL    RETRN4                   IF LOW, ERROR MUST BE   OX01495 12890002
*                                       IN IOS OR ERP. EXIT TO  OX01495 12892002
*                                       PROCESS NEXT TRACK.     OX01495 12894002
         MVI   0(ERRCCW),NOP           NO, REPLACE CCW WITH NOP    O122 12900019
         MVI   AOUTSW,NOFMT            DO NOT FORMAT THIS RECORD   O122 13000019
         L     ENDATA,TRACKPT          ADDRESS OF RECORD           O122 13100019
         TM    CCWCODE,X'0E'           IS CCW A READ KEY DATA (R2) O122 13200019
         BNO   PRKEYDAT                NO                          O122 13300019
         LR    A,ENDATA                ADDRESS OF KEY DATA         O122 13400019
         S     A,EIGHT                 ADDRESS OF COUNT KEY DATA   O122 13500019
         ST    A,TRACKPT                                           O122 13600019
         MVI   AOUTSW,FMTCNT           FORMAT COUNT FOR THIS RECORDO122 13700019
PRKEYDAT AH    ENDATA,CCWCODE+6        END OF DATA                 O122 13800019
         TM    CCWCODE+4,X'40'         CHAINING BIT ON             O122 13900019
         BO    PRKD                    YES                         O122 14000019
         BCTR  ENDATA,0                SUBTRACT 1 IF LAST RECORD   O122 14100019
*                                      (IEHDEXCP ADDS 1 TO CHECK   O122 14200019
*                                      FOR OVERFLOW)               O122 14300019
PRKD     BAL   LINK2,PRINT             PRINT RECORD                O122 14400019
         MVI   AOUTSW,FMTCNT           RESET SWITCH TO FORMAT COUNTO122 14500019
         TM    CCWCODE+4,X'40'        CHAINGING BIT ON             O122 14600019
         BNO   RETRN4                  FINISHED, GO PROCESS NEXT TRO122 14700019
MORE1    BAL   LINK1,MORE              UPDATE TRACKPT              O122 14800019
         B     OKRETRN                 RETURN                      O122 14900019
INSRTRC  MVC   0(8,ERRCCW),RC          REPLACE CCW WITH READ COUNT O122 15000019
         BAL   LINK1,PRTRC             PRINT RECORD, FORMATTING CT O122 15100019
         TM    CCWCODE+4,X'40'        CHAINGING BIT ON             O122 15200019
        BO    MORE1                   YES                          O122 15300019
         B     RETRN4                  FINISHED, GO PROCESS NEXT T O122 15400019
*        TEST FOR DATA CHECK IN DATA FIELD ALSO                    O122 15500019
TRYRD    MVC   0(8,ERRCCW),TIC         REPLACE ERROR CCW WITH TIC  O122 15600019
*                                      TO RCVRCCWS                 O122 15700019
         MVC   RCVRCCWS(8),RD          MOVE IN READ DATA CCW       O122 15800019
         L     A,CCWCODE+4             BYTE COUNT IN CCW           O122 15900019
         SH    A,OUTSTAT+6             LENGTH READ                 O122 16000019
         SLL   A,16                    REMOVE ALL BUT LENGTH       O122 16100019
         SRL   A,16                                                O122 16200019
         A     A,CCWCODE               NEXT BYTE IN INPUT RECORD   O122 16300019
         LA    A,0(A)                  CLEAR HIGH ORDER BYTE       O122 16400019
         O     A,RCVRCCWS                                          O122 16500019
         ST    A,RCVRCCWS              INSERT ADDRESS INTO READ DATO122 16600019
         BAL   LINK2,CHKERROR          RETRY I/O                   O122 16700019
         LTR   RETCODE,RETCODE         IS RETURN CODE 0            O122 16800019
         BZ    KEYMSG                  YES, DATA FIELD OK          O122 16900019
*        PRINT DATA CHECK IN KEY AND DATA FIELDS                   O122 17000019
         LA    FIELD,KEYFLD                                        O122 17100019
         BAL   LINK1,PRTMSG42          PRINT MESSAGE IEH842I       O122 17200019
*        CONTINUE INTO NEXT SECTION TO PRINT DATA CHECK IN DATA    O122 17300019
*        FIELD MESSAGE AND TO PRINT DEFECTIVE RECORD               O122 17400019
         EJECT                                                     O122 17500019
*******************************************************************O122 17600019
*        DATA CHECK IN DATA FIELD                                  O122 17700019
*******************************************************************O122 17800019
         SPACE 3                                                   O122 17900019
DATAERR  EQU   *                                                   O122 18000019
*        PRINT DATA CHECK IN DATA FIELD                            O122 18100019
         LA    FIELD,DATAFLD                                       O122 18200019
         BAL   LINK1,PRTMSG42          PRINT MESSAGE IEH842I       O122 18300019
         B     INSRTWHT                PRINT RECORD AND REPLACE CCWO122 18400019
         EJECT                                                     O122 18500019
*******************************************************************O122 18600019
*        DETERMINE WHETHER DATA CHECK IN KEY OR DATA FIELD OF R1   O122 18700019
*              (BYTE COUNT IN CSW WON'T HELP WHEN COUNT IN CCW     O122 18800019
*              IS FFFF)                                            O122 18900019
*******************************************************************O122 19000019
         SPACE 3                                                   O122 19100019
ERKEYDAT L     A,FUCBPTR               ADDRESS OF UCB              O122 19200019
         CLI   19(A),X'02'             IS DEVICE A 2301            O122 19300019
         BE    TRYRD                   YES, ASSUME DATA CHECK IN   O122 19400019
*                                      KEY TO BE SURE READ DATA    O122 19500019
*        (NO NEED TO CHECK FOR PREVIOUS NOP)                       O122 19600019
         MVC   0(8,ERRCCW),TIC         TIC TO RCVRCCWS             O122 19700019
         MVC   RCVRCCWS(16),READTRK    READ KEY AND DATA AGAIN     O122 19800019
         L     A,CCWCODE               ADDRESS OF COUNT FIELD      O122 19900019
         LA    A,5(A)                  PTR TO KEY AND DATA LENGTH  O122 20000019
         ST    A,RCVRCCWS                                          O122 20100019
         MVI   RCVRCCWS,X'0F'          REPLACE SPACE COUNT OP CODE O122 20200019
         SR    B,B                     ZERO                        O122 20300019
         IC    B,0(A)                  KEY LENGTH                  O122 20400019
         LA    A,1(A)                  POINT TO DATA LENGTH        O122 20500019
         AH    B,0(A)                  KEY LENGTH + DATA LENGTH    O122 20600019
         STH   B,RCVRCCWS+14           LENGTH FOR RKD CCW          O122 20700019
         LA    A,2(A)                  POINTER TO KEY AND DATA     O122 20800019
         ST    A,RCVRCCWS+8                                        O122 20900019
         MVI   RCVRCCWS+8,X'0E'        REPLACE OP CODE             O122 21000019
         BAL   LINK2,CHKERROR          READ KEY AND DATA AGAIN     O122 21100019
*        (ASSUME IF DATA CHECK DOES NOT OCCUR ON RETRY THAT IT WAS O122 21200019
*        IN THE DATA FIELD)                                        O122 21300019
         B     RESIDCNT                TEST FOR KEY OR DATA ERROR  O122 21400019
*                                      WITH THIS CSW BYTE COUNT    O122 21500019
         EJECT                                                     O122 21600019
*******************************************************************O122 21700019
*        DATA CHECK IN COUNT FIELD                                 O122 21800019
*******************************************************************O122 21900019
         SPACE 3                                                   O122 22000019
COUNTERR L     A,FUCBPTR               ADDRESS OF UCB              O122 22100019
         CLI   19(A),X'02'             IS DEVICE A 2301            O122 22200019
         BE    CNT2301                 YES, CANNOT RECOVER FROM    O122 22300019
*                                      COUNT ERROR                 O122 22400019
         TM    CCWCODE,X'1E'           IS CCW A READ COUNT KEY DATAO122 22500019
        BO     RCKDERR               YEYES, CCW IS A READ CKD      O122 22600019
*        DATA CHECK ON READ COUNT COMMAND                          O122 22700019
         LA    FIELD,COUNTFLD          NAME OF DEFECTIVE FIELD     O122 22800019
         BAL   LINK1,PRTMSG42          PRINT MESSAGE IEH842I       O122 22900019
         TM    CCWCODE,X'92'           READ COUNT MULTITRACK       O122 23000019
         BO    RDCMULTI                YES                         O122 23100019
         BAL   LINK1,PRTCNT            PRINT RECORD FORMATTING CNT O122 23200019
         L     A,CCWCODE               ADDRESS OF THIS RECORD      O122 23300019
         B     INCR                    INCREMENT TO NEXT RECORD    O122 23400019
RDCMULTI MVI   AOUTSW,NOFMT            DO NOT FORMAT THIS COUNT    O122 23500019
         BAL   LINK1,PRTCNT            PRINT COUNT FIELD           O122 23600019
         MVI   AOUTSW,FMTCNT           RESET SWITCH TO FORMAT COUNTO122 23700019
         L     A,DATBUFPT              ADDRESS OF DATA BUFFER      O122 23800019
INCR     LA    A,8(A)                  ADDRESS OF R1 OR NEXT REC   O122 23900019
         ST    A,TRACKPT               SAVE ADDRESS FOR IEHDAOUT   O122 24000019
*        MAKE ERROR CCW A SPACE COUNT                              O122 24100019
INSRTSC  LR    A,ERRCCW                ADDRESS OF CCW              O122 24200019
         BAL   LINK1,SPACECNT          INSERT SPACE COUNT          O122 24300019
         B     OKRETRN                 RETURN                      O122 24400019
         SPACE 1                                                   O122 24500019
*        DATA CHECK IN COUNT OF READ COUNT KEY DATA COMMAND        O122 24600019
*        SET UP SPACE COUNT                                        O122 24700019
RCKDERR  LR    A,ERRCCW                                            O122 24800019
         BAL   LINK1,GTRECNUM                                      O122 24900019
         STC   B,RECNUM                                            O122 25000019
         LR    A,ERRCCW                ADDRESS OF CCW              O122 25100019
         BAL   LINK2,CHKNOP            CHECK FOR PREVIOUS NOP      O122 25200019
         MVC   RCVRCCWS(16),READTRK    SPACE COUNT AND READ KEY DATO122 25300019
        L     A,CCWCODE  )             ADDR OF COUNT FIELD         O122 25400019
         LA    A,5(A)                  ADDR OF KEY AND DATA LENGTHSO122 25500019
         ST    A,RCVRCCWS              LENGTH ADDRESS FOR SPACE CNTO122 25600019
         MVI   RCVRCCWS,X'0F'          SPACE COUNT OP CODE         O122 25700019
         LA    A,3                                                 O122 25800019
         STH   A,RCVRCCWS+6            BYTE COUNT FOR SC CCW       O122 25900019
*        COMPLETE READ KEY DATA CCW                                O122 26000019
         L     A,CCWCODE          ADDR OF COUNT FIELD              O122 26100019
         LA    A,8(A)             ADDR KEY AND DATA FIELDS         O122 26200019
         ST    A,RCVRCCWS+8       INSERT ADDR IN RKD CCW           O122 26300019
         MVI   RCVRCCWS+8,X'0E'        READ KEY DATA OP CODE       O122 26400019
*        REPLACE ERROR CCW WITH TIC TO RCVRCCWS                    O122 26500019
         MVC   0(8,ERRCCW),TIC                                     O122 26600019
*        RETRY ERROR CHAIN AND TEST FOR ERROR                      O122 26700019
         BAL   LINK2,CHKERROR          RETRY I/O                   O122 26800019
         LTR   RETCODE,RETCODE         IS RETURN CODE 0            O122 26900019
         BZ    CNTONLY                 YES, KEY AND DATA OK        O122 27000019
*        PRINT DATA CHECK IN COUNT AND POSSIBLY IN KEY AND DATA    O122 27100019
         LA    MSG,IEH843I                                         O122 27200019
         LINK  EP=IEHDMSGB                                         O122 27300019
         UNPK  0(9,MSG),OUTSEEK+3(5)   TRACK ADDRESS               O122 27400019
         MVI   8(MSG),C' '             CLEAR TRASH FROM UNPACK     O122 27500019
         TR    0(8,MSG),IOTAB-240      GRAPHIC TRACK ADDRESS       O122 27600019
         MVC   9(8,MSG),DDNAME1        DIRECT ACCESS DD NAME       O122 27700019
         L     ENTER,PRNTADR           ADDRESS OF IEHDPRNT         O122 27800019
         BALR  LINK,ENTER              GO PRINT MESSAGE            O122 27900019
*        READ REMAINDER OF TRACK BECAUES LENGTH FIELDS IN COUNT    O122 28000019
*        MAY BE BAD                                                O122 28100019
REMTRK1  BAL   LINK1,REMTRK            READ AND PRINT TRACK        O122 28200019
         MVI   AOUTSW,FMTCNT           RESET SWITCH TO FORMAT COUNTO122 28300019
         TM    CCWCODE+4,X'40'        CHAINGING BIT ON             O122 28400019
         BNO   RETRN4                  FINISHED, GO PROCESS NEXT TRO122 28500019
         CLI   CCWCODE,X'9E'           READING R1                  O122 28600019
         BO    RETRN4                  YES, GO PROCESS NEXT TRACK  O122 28700019
*                                      (CAN'T CALC WHERE R2 STARTS)O122 28800019
MORE2    BAL   LINK1,MORE              UPDATE TRACKPT              O122 28900019
         B     INSRTSC            INSERT SC IN ERROR CCW           O122 29000019
*        PRINT DATA CHECK IN COUNT                                 O122 29100019
CNTONLY  EQU   *                                                   O122 29200019
         LA    FIELD,COUNTFLD                                      O122 29300019
         BAL   LINK1,PRTMSG42          PRINT MESSAGE IEH842I       O122 29400019
*        PRINT RECORD                                              O122 29500019
         BAL   LINK1,PRTRC                                         O122 29600019
         TM    CCWCODE+4,X'40'        CHAINGING BIT ON             O122 29700019
        BO    MORE2                   YES                          O122 29800019
         B     RETRN4                  FINISHED, GO PROCESS NEXT T O122 29900019
         SPACE 2                                                   O122 30000019
*        CANNOT RECOVER FORM DATA CHECK IN COUNT FIELD OR MISSING  O122 30100019
*        ADDRESS MARKER ON 2301 BECAUSE IT DOESN'T RECOGNIZE THE   O122 30200019
*        COUNT COMMAND.                                            O122 30300019
CNT2301  LA    FIELD,COUNTFLD                                      O122 30400019
         BAL   LINK1,PRTMSG42          PRINT MESSAGE IEH842I       O122 30500019
*        PRINT COUNT FIELD                                         O122 30600019
         BAL   LINK1,PRTCNT                                        O122 30700019
         B     RETRN8                  RETURN TO IEHDEXCP          O122 30800019
         EJECT                                                     O122 30900019
*******************************************************************O122 31000019
*                                                                  O122 31100019
*        MISSING ADDRESS MARKER                                    O122 31200019
*                                                                  O122 31300019
*******************************************************************O122 31400019
         SPACE 3                                                   O122 31500019
MISADRMK EQU   *                                                   O122 31600019
*        IS DEVICE A 2301                                          O122 31700019
         L     A,FUCBPTR               ADDRESS OF UCB              O122 31800019
         TM    19(A),X'02'             IS DEVICE A 2301            O122 31900019
         BO    RETRN8                  YES, CANNOT RECOVER         O122 32000019
*        PRINT MESSAGE IEH844I                                     O122 32100019
         LA    MSG,IEH844I             MESSAGE NUMBER              O122 32200019
         LINK  EP=IEHDMSGB             SET UP MESSAGE              O122 32300019
         UNPK  0(9,MSG),OUTSEEK+3(5)   TRACK ADDRESS               O122 32400019
         MVI   8(MSG),C' '             CLEAR TRASH FROM UNPACK     O122 32500019
         TR    0(8,MSG),IOTAB-240      GRAPHIC TRACK ADDRESS       O122 32600019
         MVC   9(8,MSG),DDNAME1        DIRECT ACCESS DD NAME       O122 32700019
         L     ENTER,PRNTADR           ADDRESS OF IEHDPRNT         O122 32800019
         BALR  LINK,ENTER              GO PRINT MESSAGE            O122 32900019
         CLI   CCWCODE,X'92'           IS CCW A READ COUNT MULTI-TRO122 33000019
         BE    NOT2301                 YES, DO NOT UPDATE RECNUM   O122 33100019
         LR    A,ERRCCW                                            O122 33200019
         BAL   LINK1,GTRECNUM          GET RECORD NUMBER           O122 33300019
         STC   B,RECNUM                UPDATE RECORD NUMBER        O122 33400019
NOT2301  B     REMTRK1                 NO, READ AND PRINT TRACK    O122 33500019
         EJECT                                                     O122 33600019
*******************************************************************O122 33700019
*        REISSUE I/O AND TEST FOR I/O ERROR                        O122 33800019
*        (DESTROYS REGISTERS 0,1,A,B)                              O122 33900019
*******************************************************************O122 34000019
         SPACE 3                                                   O122 34100019
CHKERROR EXCP  OUTIOB                  DATA CHECK EXPECTED         O122 34200019
         L     A,OUTECBAD              ADDRESS OF ECB              O122 34300019
         WAIT  ECB=OUTECB                                          O122 34400019
         TM    OUTSTAT+4,X'02'         UNIT CHECK                  O122 34500019
         BO    TSTDTACH                YES, TEST FOR DATA CHECK    O122 34600019
         TM    OUTSTAT+5,X'FF'         OTHER ERROR                 O122 34700019
         BZ    ERRNO                   RETURN WITHOUT ERROR        O122 34800019
         B     CANTRCVR                YES, CAN'T RECOVER          O122 34900019
TSTDTACH TM    OUTSENSE,X'08'     DATA CHECK                       O122 35000019
         BO    ACCPT                   YES                         O122 35100019
         TM    OUTSENSE+1,X'02'        MISSING ADDRESS MARKER      O122 35200019
         BNO   TSTACCPT           NO, TEST IF ERROR ACCEPTABLE     O122 35300019
*        DATA CHECK ON RETRY                                       O122 35400019
ACCPT    L     A,OUTSTAT          DID DATA CHECK OCCUR ON          O122 35500019
         CLC   0(8,A),RCVRCCWS+8       FIRST RCVRCCW               O122 35600019
         BE    ERRYES             YES, DATA CHECK EXPECTED         O122 35700019
         CLC   0(8,A),RCVRCCWS+16      DID DATA CHECK OCCUR ON     O122 35800019
*                                      SECOND RCVRCCW              O122 35900019
         BE    ERRYES                  YES, ERROR EXPECTED         O122 36000019
*        DATA CHECK ON CCW ALREADY EXECUTED SUCCESSFULLY           O122 36100019
         S     A,EIGHT                 ADDRESS OF FAILING CCW      O122 36200019
         TM    0(A),X'31'              SEARCH COMMAND              O122 36300019
         BO    SRCHERR                 YES                         O122 36400019
         LA    LINK1,READSUCC                                      O122 36500019
         ST    LINK2,SAVELNK2      SAVE RETURN REGISTER            O122 36600019
         LA    LINK2,TRYAGAIN                                      O122 36700019
         TM    OUTSENSE+1,X'80'        DATA CHECK IN COUNT         O122 36800019
         BO    GTRECNUM                YES, GET RECORD NUMBER FROM O122 36900019
*                                      PREVIOUS CCW                O122 37000019
         B     GETRECNO                RECOVER FROM NEW ERROR &    O122 37100019
*                                      CONTINUE PRCCESSING OLD ERR O122 37200019
*        RETRY I/O AFTER RECOVERING FROM ERROR ON RECORD ALREADY   O122 37300019
*        READ SUCCESSFULLY                                         O122 37400019
TRYAGAIN L     LINK2,SAVELNK2          RESTORE LINKAGE REGISTER    O122 37500019
         L     B,TICADDR                                           O122 37600019
         LTR   B,B                                                 O122 37700019
         BZ    CHKERROR                                            O122 37800019
         ST    A,0(B)                  CHANGE TIC TO RCVRCCWS TO   O122 37900019
         MVI   0(B),X'08'              TIC TO THIS ERROR CCW       O122 38000019
         XC    TICADDR(4),TICADDR                                  O122 38100019
         B     CHKERROR                RETRY I/O                   O122 38200019
TSTACCPT EQU   *                                                   O122 38300019
         TM    OUTSENSE,X'02'          TRACK CONDITION CHECK       O122 38400019
         BO    ERRNO                   YES, RETRY SUCCESSFUL       O122 38500019
         TM    OUTSENSE+1,X'05'        FILE PROTECT OR OVFLOW INCM O122 38600019
         BO    ERRNO                   YES                         O122 38700019
         TM    OUTSENSE+1,X'08'        NO RECORD FOUND             O122 38800019
         BZ    CANTRCVR                NO                          O122 38900019
         LA    B,PRTREM                RETURN ADDR FOR REMTRK      O122 39000019
         CR    B,LINK2                 DID NO REC FND OCCUR REMTRK O122 39100019
         BNE   CANTRCVR                NO                          O122 39200019
         LA    B,RCVRCCWS+16           END OF REMTRK CHAN PROG     O122 39300019
         CH    B,OUTCCWAD+2            NO REC FND ON 0E AFTER 0F   O122 39400019
         BNE   CANTRCVR                NO                          O122 39500019
*        RETRY SUCCESSFUL                                          O122 39600019
ERRNO    SR    RETCODE,RETCODE         RETURN CODE = 0             O122 39700019
         BR    LINK2                                               O122 39800019
*        RETRY UNSUCCESSFUL                                        O122 39900019
ERRYES   TM    OUTSENSE+1,X'02'        MISSING ADDRESS MARKER      O122 40000019
         BO    CANTRCVR                YES, DIDN'T RECOVER              40100019
         LA    RETCODE,8               RETURN CODE = 8             O122 40200019
         BR    LINK2                                               O122 40300019
         EJECT                                                     O122 40400019
*******************************************************************O122 40500019
*        MAKE CCW ADDRESSED BY REGISTER A A SPACE COUNT            O122 40600019
*        (DESTROYS REGISTER B)                                     O122 40700019
*******************************************************************O122 40800019
         SPACE 3                                                   O122 40900019
SPACECNT BAL   LINK2,CHKNOP            CHECK FOR PRECEEDING NOP    O122 41000019
         L     B,0(A)                  ADDRESS OF COUNT FIELD      O122 41100019
         LA    B,5(B)                  ADDR OF KEY AND DATA LENGTHSO122 41200019
         ST    B,0(A)                  LENGTH ADDRESS FOR SP CNT   O122 41300019
         MVI   0(A),X'0F'              SPACE COUNT OP CODE         O122 41400019
         LA    B,3                                                 O122 41500019
         STH   B,6(A)                  BYTE COUNT FOR SC CCW       O122 41600019
         BR    LINK1                   RETURN                      O122 41700019
         SPACE 10                                                  O122 41800019
*******************************************************************O122 41900019
*        CHECK FOR AND CORRECT NOP PRECEEDING SPACE COUNT          O122 42000019
*              (NOP WILL HAVE REPLACED 06 OR 0E)                   O122 42100019
*        (IF NOT CORRECTED,NOP WIL ORIENT TRACK ON RECORD 1)       O122 42200019
*******************************************************************O122 42300019
CHKNOP   LR    B,A                     ADDRESS OF ERROR CCW        O122 42400019
RETREAT  S     B,EIGHT                 ADDRESS OF PREVIOUS CCW     O122 42500019
         CLI   0(B),X'03'              IS PREVIOUS CCW A NOP       O122 42600019
         BE    MAKETIC                 YES, MAKE NOP A TIC         O122 42700019
         BR    LINK2                   NO                          O122 42800019
MAKETIC  MVC   0(8,B),TIC              REPLACE WITH TIC TO RCVRCCW O122 42900019
         ST    B,TICADDR               SAVE ADDRESS OF TIC         O122 43000019
         BR    LINK2                                               O122 43100019
         EJECT                                                     O122 43200019
*******************************************************************O122 43300019
*                                                                  O122 43400019
*        SET UP SYNADAF MESSAGE                                    O122 43500019
*                                                                  O122 43600019
*******************************************************************O122 43700019
         SPACE 3                                                   O122 43800019
SYNADAF  L     ENTER,PRNTADR           ADDRESS OF IEHDPRNT         O122 43900019
         BALR  LINK,ENTER              SPACE A LINE                O122 44000019
         LA    MSG,IEH813I             MESSAGE NUMBER              O122 44100019
         LINK  EP=IEHDMSGB                                         O122 44200019
         LA    MSG,OUTIOB              ADDRESS OF IOB FOR SYNADAF  O122 44300019
         SYNADAF ACSMETH=EXCP,PARM1=(MSG)                          O122 44400019
         MVC   MESS+22(78),49(MSG)                               SM4350 44500021
         SYNADRLS                      FREE SYNADAF BUFFER         O122 44600019
         BR    LINK1                                               O122 44700019
         EJECT                                                     O122 44800019
*******************************************************************O122 44900019
*        WRITE MESSAGE IEH842I - DATA CHECK IN COUNT, KEY OR DATA  O122 45000019
*******************************************************************O122 45100019
         SPACE 3                                                   O122 45200019
PRTMSG42 LA    MSG,IEH842I             MESSAGE NUMBER              O122 45300019
         LINK  EP=IEHDMSGB             SET UP MESSAGE              O122 45400019
         MVC   0(5,MSG),0(FIELD)       FIELD IN ERROR              O122 45500019
         UNPK  19(9,MSG),OUTSEEK+3(5)  TRACK ADDRESS               O122 45600019
         MVI   27(MSG),C' '            CLEAR TRASH FROM UNPACK     O122 45700019
         TR    19(8,MSG),IOTAB-240     GRAPHIC TRACK ADDRESS       O122 45800019
         MVC   28(8,MSG),DDNAME1       DIRECT ACCESS DD NAME       O122 45900019
         SPACE 3                                                   O122 46000019
PRTMSG   L     ENTER,PRNTADR           ADDRESS OF IEHDPRNT         O122 46100019
         BALR  LINK,ENTER              GO PRINT MESSAGE            O122 46200019
         BR    LINK1                   RETURN                      O122 46300019
         EJECT                                                     O122 46400019
*******************************************************************O122 46500019
*                                                                  O122 46600019
*        PRINT THE RECORD, FORMATTING THE COUNT FIELD              O122 46700019
*                                                                  O122 46800019
*******************************************************************O122 46900019
         SPACE 3                                                   O122 47000019
PRTRC    L     A,TRACKPT               ADDRESS OF BUFFER           O122 47100019
         L     B,CCWCODE               ADDRESS OF COUNT FIELD      O122 47200019
         SR    ENDATA,ENDATA                                       O122 47300019
         IC    ENDATA,5(B)             KEY LENGTH                  O122 47400019
         AH    ENDATA,6(B)             KEY LENGTH PLUS DATA LENGTH O122 47500019
         LA    ENDATA,8(ENDATA)        LENGTH OF RECORD            O122 47600019
         AR    ENDATA,A                ADDRESS OF END OF RECORD    O122 47700019
         BAL   LINK2,PRINT             PRINT RECORD                O122 47800019
         BR    LINK1                                               O122 47900019
         SPACE 10                                                  O122 48000019
*******************************************************************O122 48100019
*                                                                  O122 48200019
*        PRINT THE COUNT FIELD ONLY                                O122 48300019
*                                                                  O122 48400019
*******************************************************************O122 48500019
         SPACE 3                                                   O122 48600019
PRTCNT   L     B,CCWCODE               ADDRESS OF COUNT            O122 48700019
         L     ENDATA,TRACKPT          BEGINNING OF BUFFER         O122 48800019
         LA    ENDATA,8(ENDATA)        END OF COUNT                O122 48900019
         BAL   LINK2,PRINT             PRINT COUNT FIELD           O122 49000019
         BR    LINK1                                               O122 49100019
         EJECT                                                     O122 49200019
*******************************************************************O122 49300019
*        PRINT PART OF THE TRACK                                   O122 49400019
*******************************************************************O122 49500019
         SPACE 3                                                   O122 49600019
*        SET UP PARAMETERS FOR IEHDAOUT                            O122 49700019
PRINT    LA    TRK,CCHH                POINTER TO TRACK ADDRESS    O122 49800019
         L     PRNT,PRNTADR            ADDRESS OF IEHDPRNT         O122 49900019
         L     ENTER,DAOUTADR          ADDRESS OF IEHDAOUT         O122 50000019
*        PARAMETERS ALREADY ESTABLISHED                            O122 50100019
*              REGISTER  3 - END OF DATA                           O122 50200019
*              REGISTER 10 - ADDRESS OF IEHDBLKS                   O122 50300019
*              REGISTER 12 - ADDRESS OF IEHDWORK                   O122 50400019
*              AOUTSW      - PROPER FORMATTING                     O122 50500019
*              TRACKPT     - BEGINNING OF DATA                     O122 50600019
         SPACE 1                                                   O122 50700019
*        LINK TO IEHDAOUT TO PRINT RECORDS                         O122 50800019
         BALR  LINK,ENTER                                          O122 50900019
         L     ENTER,PRNTADR           ADDRESS OF IEHDPRNT         O122 51000019
         BALR  LINK,ENTER              SPACE A LINE                O122 51100019
         BR    LINK2                                               O122 51200019
         EJECT                                                     O122 51300019
*******************************************************************O122 51400019
*        CALCULATE BEGINNING ADDRESS FOR IEHDAOUT                  O122 51500019
*******************************************************************O122 51600019
         SPACE 3                                                   O122 51700019
MORE     TM    CCWCODE,X'90'           READING R1-RN FIRST PASS    O122 51800019
         BO    BEGINR2                 YES, TELL IEHDAOUT BEGIN R2 O122 51900019
         MVC   TRACKPT(4),8(ERRCCW)    NO, BEGIN NEXT CCW          O122 52000019
         BR    LINK1                                               O122 52100019
BEGINR2  L     A,DATBUFPT              ADDRESS OF BUFFER           O122 52200019
         LA    A,8(A)                  ADDRESS OF R1               O122 52300019
         SR    B,B                                                 O122 52400019
         IC    B,5(A)                  KEY LENGTH OF R1            O122 52500019
         AH    B,6(A)                  KEY + DATA LENGTH OF R1     O122 52600019
         LA    B,8(B)                  LENGTH OF R1                O122 52700019
         AR    A,B                     END OF R1                   O122 52800019
         ST    A,TRACKPT               STORE TO SEE IF DOUBLE WORD O122 52900019
         TM    TRACKPT+3,X'07'         IS PTR ON DOUBLE WORD BNDRY O122 53000019
         BCR   8,LINK1                 YES, RETURN                 O122 53100019
         NI    TRACKPT+3,X'F8'         NO, FORCE TO BOUBLE WORD BNDO122 53200019
         L     A,TRACKPT                                           O122 53300019
         LA    A,8(A)                  NEXT DOUBLE WORD AFTER R1   O122 53400019
         ST A,TRACKPT                  ADDRESS OF R2               O122 53500019
         BR    LINK1                                               O122 53600019
         EJECT                                                     O122 53700019
*******************************************************************O122 53800019
*        PRINT REMAINDER OF TRACK                                  O122 53900019
*******************************************************************O122 54000019
         SPACE 3                                                   O122 54100019
REMTRK   LR    A,ERRCCW                ADDRESS OF CCW              O122 54200019
         BAL   LINK2,CHKNOP            CHECK FOR PRECEEDING NOP    O122 54300019
SPRKD    MVC   RCVRCCWS(16),READTRK    SPACE COUNT AND READ        O122 54400019
*                                      TRACK AS IF ONE RECORD      O122 54500019
         L     A,DATBUFPT              POINTER TO TRACK LENGTH BUFFO122 54600019
         O     A,RCVRCCWS+8            INSERT BUFFER ADDRESS       O122 54700019
         ST    A,RCVRCCWS+8               INTO READ CCW            O122 54800019
         L     B,IODEVCON              LOAC BASE REGISTER          O122 54900019
         USING CONSTANT,B                                          O122 55000019
         LH    A,SACAP                 TRACK CAPACITY              O122 55100019
         DROP  B                                                   O122 55200019
         STH   A,TRKLNGTH+1                                        O122 55300019
         MVC   0(8,ERRCCW),TIC         REPLACE ERROR CCW WITH TIC  O122 55400019
*                                      TO RCVRCCWS                 O122 55500019
         BAL   LINK2,CHKERROR          READ REMAINDER OF TRACK     O122 55600019
*        PRINT REMAINDER OF TRACK                                  O122 55700019
PRTREM   L     ENDATA,RCVRCCWS+12      DATA LENGTH IN READ CCW     O122 55800019
         LA    ENDATA,0(ENDATA)        CLEAR HIGH ORDER BYTE       O122 55900019
         MVC   BYTECNT+2(2),OUTSTAT+6  CSW BYTE COUNT              O122 56000019
         S     ENDATA,BYTECNT          LENGTH OF RECORD READ       O122 56100019
         A     ENDATA,DATBUFPT         ADDRESS OF END OF DATA      O122 56200019
         MVI   AOUTSW,NOFMT            SET SWITCH FOR NO FORMATTINGO122 56300019
         MVC   TRACKPT(4),DATBUFPT                                 O122 56400019
         BAL   LINK2,PRINT             PRINT REMAINDER OF TRACK    O122 56500019
         BR    LINK1                                               O122 56600019
         EJECT                                                     O122 56700019
*******************************************************************O122 56800019
*        GET THE RECORD NUMBER FOR THIS RECORD                     O122 56900019
*              REGISTER A MUST POINT TO ERROR CCW                  O122 57000019
*              RECORD NUMBER RETURNDD IN REGISTER !                O122 57100019
*******************************************************************O122 57200019
         SPACE 3                                                   O122 57300019
GETRECNO CLI   0(A),X'9E'              READ COUNT KEY DATA R1      O122 57400019
         BE    ERR1                    YES                         O122 57500019
         TM    0(A),X'12'              READ COUNT OR RCKD          O122 57600019
         BO    GETFRCNT                YES, GET RECORD NUMBER      O122 57700019
*                                      FROM COUNT FIELD            O122 57800019
         CLI   0(A),X'0E'              READ KEY DATA R2            O122 57900019
         BE    ERR2                    YES                         O122 58000019
*        READ DATA R0                                              O122 58100019
ERR0     SR    B,B                                                 O122 58200019
         BR    LINK1                   RETURN OR GO TO READSUCC    O122 58300019
*        READ COUNT KEY DATA MULTI-TRACK R1                        O122 58400019
ERR1     LA    B,1                                                 O122 58500019
         BR    LINK1                                               O122 58600019
*        READ KEY DATA R2                                          O122 58700019
ERR2     LA    B,2                                                 O122 58800019
         BR    LINK1                   RETURN OR GO TO READSUCC    O122 58900019
*        * RECORD 3                                                O122 59000019
ERR3     LA    B,3                                                 O122 59100019
         BR    LINK1                                               O122 59200019
*        GET RECORD NUMBER FROM COUNT FLD                          O122 59300019
GETFRCNT L     B,0(A)                  ADDRES OF COUNT FIELD       O122 59400019
         IC    B,4(B)                  RECORD NUMBER               O122 59500019
         BR    LINK1                                               O122 59600019
*        RECORD NUMBER IN COUNT FIELD NOT RELIABLE FOR MISSING     O122 59700019
*        ADDRESS MARKER OR DATA CHECK IN COUNT FIELD.  OBTAIN      O122 59800019
*        RECORD NUMBER FROM PREVIOUS RECORD                        O122 59900019
*        (REGISTER A MUST NOT POIN T TO CCWCODE)                   O122 60000019
GTRECNUM CLI   0(A),X'9E'              READ CKD MULTI TRACK R1     O122 60100019
         BE    ERR1                    YES                         O122 60200019
         LR    B,A                                                 O122 60300019
         S     B,EIGHT                 ADDRESS OF PREVIOUS CCW     O122 60400019
         CLI   0(B),X'0E'              IS PREB RECORD R2           O122 60500019
         BE    ERR3                    YES                         O122 60600019
         CLI   0(B),X'03'              IS PREVIOUS CCW NOP         O122 60700019
         BE    LOOKBACK                COULD BE R0, R2             O122 60800019
         CLI   0(B),X'0F'              SPACE COUNT                 O122 60900019
         BE    LOOKBACK                YES                         O122 61000019
*        PREVIOUS CCW IS READ COUNT OR READ COUNT KEY DATA         O122 61100019
         IC    B,4(B)                  RECORD # OF PREC RECORD     O122 61200019
         LA    B,1(B)                  RECORD NUMBER OF THIS RECORDO122 61300019
         BR    LINK1                                               O122 61400019
*        LOOK BACKWARDS TO FIND A KNOWN RECORD NUMBER              O122 61500019
LOOKBACK LA    A,1                                                 O122 61600019
BACKAGAN S     B,EIGHT                 NEXT PREVIOUS RECORD NUMBER O122 61700019
         CLI   0(B),X'08'              IS PREVIOUS CCW A TIC       O122 61800019
         BE    BACKAGAN                YES                         O122 61900019
         CLI   0(B),X'31'              IS PREVIOUS A SEARCH        O122 62000019
         BNE   BACK                    NO                          O122 62100019
         IC    B,OUTSEEK+7             RECORD NUMBER FOR SEARCH IS O122 62200019
*                                      SAME AS FOR 06 OR 0E        O122 62300019
         AR    B,A                     RECNUM FOR THIS RECORD      O122 62400019
         BR    LINK1                                               O122 62500019
BACK     LA    A,1(A)                                              O122 62600019
         CLI   0(B),X'06'                                          O122 62700019
         BE    PREVR0                                              O122 62800019
         CLI   0(B),X'0E'                                          O122 62900019
         BE    PREVR2                                              O122 63000019
         CLI   0(B),X'03'                                          O122 63100019
         BE    BACKAGAN                                            O122 63200019
         CLI   0(B),X'0F'              SPACE COUNT                 O122 63300019
         BE    BACKAGAN                YES                         O122 63400019
         L     B,0(B)                  ADDRESS OF COUNT FIELD      O122 63500019
         IC    B,4(B)                  RECORD NUMBER OF PREVIOUS   O122 63600019
         AR    B,A                     RECNUM FOR THIS RECORD      O122 63700019
         BR    LINK1                                               O122 63800019
PREVR0   SR    B,B                                                 O122 63900019
         AR    B,A                                                 O122 64000019
         BR    LINK1                                               O122 64100019
PREVR2   LA    B,2                                                 O122 64200019
         AR    B,A                                                 O122 64300019
         BR    LINK1                                               O122 64400019
         EJECT                                                     O122 64500019
*******************************************************************O122 64600019
*        I/O ERROR ON SEARCH COMMAND OR MISSING ADDRESS MARKER AND O122 64700019
*        NO RECORD FOUND                                           O122 64800019
*******************************************************************O122 64900019
         SPACE 3                                                   O122 65000019
SRCHERR  BAL   LINK1,SYNADAF           SET UP SYNADAF MESSAGE      O122 65100019
         BAL   LINK1,PRTMSG            PRINT SYNADAF MESSAGE       O122 65200019
         MVC   SAVCCWAD(4),OUTCCWAD    SAVE DCCW ADR FROM IOB      O122 65300019
         LA    A,SPCNT                                             O122 65400019
         ST    A,OUTCCWAD                                          O122 65500019
         BAL   LINK1,SPRKD             READ TRK                    O122 65600019
         MVC   OUTCCWAD(4),SAVCCWAD    RESTORE CCW ADR TO IOB      O122 65700019
         B     RETRN4                                              O122 65800019
         EJECT                                                     O122 65900019
*******************************************************************O122 66000019
*        TEST FOR ALREADY READ THIS RECORD SUCCESSFULLY            O122 66100019
*******************************************************************O122 66200019
         SPACE 3                                                   O122 66300019
TESTRDSC CLI   0(ERRCCW),X'92'         READ COUNT MULTI-TRACK      O122 66400019
         BE    NOTRDSUC                YES, GO PROCESS ERROR       O122 66500019
         LR    A,ERRCCW                                            O122 66600019
         LA    LINK1,COMPNUM                                       O122 66700019
         LA    LINK2,OKRETRN                                       O122 66800019
         CLI   0(A),X'0E'              READ KEY DATA R2            O122 66900019
         BNE   GETFRCNT                NO, CCW IS 1E OR 12         O122 67000019
         CLI   RECNUM,X'02'            HAVE WE ALREADY READ R2     O122 67100019
         BL    NOTRDSUC                NO, GO PROCESS ERROR        O122 67200019
         B     ERR2                                                O122 67300019
COMPNUM  STC   B,RECNO                 PREPARE TO COMPARE REC NUMS O122 67400019
         CLC   RECNUM,RECNO            WAS RECORD READ BEFORE      O122 67500019
         BL    NOTRDSUC                NO                          O122 67600019
READSUCC BAL   LINK1,SYNADAF                                       O122 67700019
         UNPK  MESS+89(3),RECNO        PRINTABLE RECORD NUMBER     O122 67800019
         MVI   MESS+91,C','                                        O122 67900019
         BAL   LINK1,PRTMSG            PRINT SYANDAF MESSAGE       O122 68000019
         BAL   LINK1,PRTMSG        SPACE A LINE                    O122 68100019
         TM    0(A),X'12'              READ COUNT OR RCKD          O122 68200019
         BO    REPLCNT                 YES                         O122 68300019
*        ERROR ON READ KEY DATA                                    O122 68400019
         MVI   0(A),NOP                                            O122 68500019
         BR    LINK2                                               O122 68600019
REPLCNT  L     B,FUCBPTR               ADDRESS OF UCB              O122 68700019
         TM    19(B),X'02'             IS DEVICE A 2301            O122 68800019
         BO    TSTCNTER                YES                         O122 68900019
         ST    LINK2,SAVLNK2           SAVE RETURN REGISTER      A58105 68950021
         BAL   LINK1,SPACECNT                                      O122 69000019
         L     LINK2,SAVLNK2           RESTORE RETURN REGISTER   A58105 69050021
         BR    LINK2                                               O122 69100019
TSTCNTER TM    OUTSENSE+1,X'80'        ERROR IN COUNT ON 2301      O122 69200019
         BO    CANTRCVR                YES, ACN'T RECOVER          O122 69300019
         MVI   0(A),X'12'              NO, REPLACE WITH READ COUNT O122 69400019
         BR    LINK2                                               O122 69500019
         EJECT                                                     O122 69600019
*******************************************************************O122 69700019
*        RETURN TO IEHDEXCP                                        O122 69800019
*******************************************************************O122 69900019
         SPACE 3                                                   O122 70000019
RETRN4   LA    RETCODE,4               RETURN CODE = 4             O122 70100019
         B     RETRN1                                              O122 70200019
CANTRCVR BAL   LINK1,SYNADAF           SET UP SYNADAF MESSAGE      O122 70300019
         BAL   LINK1,PRTMSG            PRINT SYNADAF MESSAGE       O122 70400019
RETRN8   LA    RETCODE,8               RETURN CODE = 8             O122 70500019
         B     RETRN1                                              O122 70600019
OKRETRN  TM    OUTSENSE+1,X'05'        FILE PROTECT OR OVFL INCMPT O122 70700019
         BNZ   RETRN4                  YES, FINISHED THE TRACK     O122 70800019
         SR    RETCODE,RETCODE         RETURN CODE = 0             O122 70900019
         L     A,TICADDR               ADDR OF TIC                 O122 71000019
         LTR   A,A                                                 O122 71100019
         BZ    RETRN1                  NO                          O122 71200019
         ST ERRCCW,0(A)                CHANGE TIC TO RCVRCCWS TO   O122 71300019
         MVI   0(A),X'08'              TIC TO ERROR CCW            O122 71400019
RETRN1   L     SAVEREG,RCVRSAVE+4      RESTORE SAVE ADDRESS        O122 71500019
         RETURN (14,12),T,RC=(15)      RESTORE REGISTERS AND RETURNO122 71600019
         EJECT                                                     O122 71700019
*******************************************************************O122 71800019
*        EQUATES                                                   O122 71900019
*******************************************************************O122 72000019
         SPACE 3                                                   O122 72100019
*        REGISTER EQUATES                                          O122 72200019
         SPACE 1                                                   O122 72300019
*        DESCRIPTION OF LINKAGE REGISTERS                          O122 72400019
*        INTERNAL BRANCHES                                         O122 72500019
*              CHKERROR      LINK2                                 O122 72600019
*              PRINT         LINK2                                 O122 72700019
*              PRTCNT        LINK1                                 O122 72800019
*              PRTRC         LINK1                                 O122 72900019
*              PRTMSG42      LINK1                                 O122 73000019
*              SPACECNT      LINK1                                 O122 73100019
*        EXTERNAL BRANCHES                                         O122 73200019
*              IEHDAOUT      LINK                                  O122 73300019
*              IEHDPRNT      LINK                                  O122 73400019
         SPACE 1                                                   O122 73500019
MSG      EQU   1                       MESSAGE NUMBER              O122 73600019
TRK      EQU   1                       PTR TO TRK ADDR FOR IEHDAOUTO122 73700019
PRNT     EQU   2                       ADDRESS OF IEHDPRNT         O122 73800019
ENDATA   EQU   3                       END OF DATA FOR IEHDAOUT    O122 73900019
LINK1    EQU   4                       INTERNAL LINKAGE REGISTER   O122 74000019
PARM1    EQU   4                       ADDRESS OF IEHDAOUT         O122 74100019
PARM2    EQU   5                       ADDRESS OF IEHDPRNT         O122 74200019
LINK2    EQU   5                       LINKAGE REGISTER            O122 74300019
FIELD    EQU   5                       ADDRESS OF NAME OF DEFECTIVEO122 74400019
*                                      FIELD FOR MESSAGE IEH842I   O122 74500019
IOB      EQU   6                       ADDR OF IOB FOR FROM DEVICE O122 74600019
B        EQU   7                       WORKREGISTER                O122 74700019
ERRCCW   EQU   8                       ADDR OF CCW WITH I/O ERROR  O122 74800019
A        EQU   9                       WORK REGISTER               O122 74900019
BLKPTR   EQU   10                      POINTER TO FUNCBLK          O122 75000019
BASEREG  EQU   11                                                  O122 75100019
AWORK    EQU   12                      POINTER TO IEHDWORK         O122 75200019
*                                      IEHDEXCP, PASSED TO IEHDAOUTO122 75300019
SAVEREG  EQU   13                      ADDRESS OF SAVE AREA        O122 75400019
LINK     EQU   14                      EXTERNAL LINKAGE REGISTER   O122 75500019
ENTER    EQU   15                      ENTRY POINT                 O122 75600019
RETCODE  EQU   15                      RETURN CODE                 O122 75700019
         SPACE 2                                                   O122 75800019
*        MISCELLANEOUS EQUATES                                     O122 75900019
IEH813I  EQU   13                      SYNADAF MESSAGE             O122 76000019
IEH842I  EQU   42                      COUNT,KEY OR DATA MESSAGE   O122 76100019
IEH843I  EQU   43                      COUNT AND KEY OR DATA MESSAGO122 76200019
IEH844I  EQU   44                      MISSING ADDRESS MARKER MESS O122 76300019
NOP      EQU   03                      NO OPERATION CCW CODE       O122 76400019
         EJECT                                                     O122 76500019
*******************************************************************O122 76600019
*        STORAGE ALLOCATION                                        O122 76700019
*******************************************************************O122 76800019
         SPACE 3                                                   O122 76900019
RCVRSAVE DS    18F                SAVE AREA                        O122 77000019
SPCNT    CCW   X'0F',TRKLNGTH,X'60',3  SPACE COUNT TO ORIENT ON R1 O122 77100019
*                                      (MUST IMMEDIATELY PRECEDE   O122 77200019
*                                      RCVRCCWS)                   O122 77300019
RCVRCCWS DC    2D'0'                   CCWS FOR I/O ERROR RECOVERY O122 77400019
COUNTFLD DC    CL5'COUNT'                                          O122 77500019
KEYFLD   DC    CL5'  KEY'                                          O122 77600019
DATAFLD  DC    CL5' DATA'                                          O122 77700019
IOTAB    DC    C'0123456789ABCDEF'                                 O122 77800019
RECNO    DC    X'00'                                               O122 77900019
SAVCCWAD DS    1F                                                  O122 78000019
CCWCODE  DC    D'0'                    SAVE ERROR CCW              O122 78100019
TICADDR  DC    F'0'                    ADDR OF TIC WITH CHANGED AD O122 78200019
         DS    0H                                                  O122 78300019
         DS    1X                                                  O122 78400019
TRKLNGTH DC    X'00FFFF'               KEY AND DATA LENGTH         O122 78500019
*                                      FOR SPACE COUNT             O122 78600019
BYTECNT  DC    F'0'                    BYTE COUNT FROM CSW         O122 78700019
SAVELNK2 DC    F'0'                    SAVE LINK2                  O122 78800019
SAVLNK2  DC    F'0'                    SAVE LINK2                A58105 78850021
EIGHT    DC    F'8'                    LENGTH OF CCW               O122 78900019
DAOUTADR DS    2F                      ADDRESS OF IEHDAOUT AND     O122 79000019
PRNTADR  EQU   DAOUTADR+4              ADDRESS OF IEHDPRNT         O122 79100019
         SPACE 2                                                   O122 79200019
*        CCWS TO BE MOVED INDIVIDUALLY TO RCVRCCWS                 O122 79300019
TIC      CCW   X'08',RCVRCCWS,X'60',1  TIC TO RCVRCCWS             O122 79400019
RD       CCW   X'06',0,X'20',X'FFFF'   READ DATA                   O122 79500019
RC       CCW   X'12',0,X'70',8         READ COUNT                  O122 79600019
READTRK  CCW   X'0F',TRKLNGTH,X'60',3  SPACE COUNT AND             O122 79700019
         CCW   X'0E',0,X'20',X'FFFF'   READ KEY DATA               O122 79800019
         EJECT                                                     O122 79900019
*******************************************************************O122 80000019
*        DSECTS FOR I/O CONTROL BLOCKS AND FUNCTION BLOCK          O122 80100019
*******************************************************************O122 80200019
         SPACE 3                                                   O122 80300019
OUTIOB   DSECT                                                     O122 80400019
*        REGISTER IOB IS USED AS BASE REGISTER                     O122 80500019
OUTFLG   DS    XL2                                                 O122 80600019
OUTSENSE DS    XL2                                                 O122 80700019
OUTECBAD DS    F                                                   O122 80800019
OUTSTAT  DS    2F                                                  O122 80900019
OUTCCWAD DS    F                                                   O122 81000019
OUTDCBAD DS    F                                                   O122 81100019
OUTRESAD DS    F                                                   O122 81200019
OUTBLKCT DS    XL2                                                 O122 81300019
OUTERROR DS    XL2                                                 O122 81400019
OUTSEEK  DS    2F                                                  O122 81500019
CCHH     EQU   OUTSEEK+3               CURRENT TRACK ADDRESS       O122 81600019
         SPACE 2                                                   O122 81700019
OUTECB   DSECT                                                     O122 81800019
*        REGISTER ECB IS USED AS BASE REGISTER                     O122 81900019
         DS    F                                                   O122 82000019
         EJECT                                                     O122 82100019
         IEHDBLKS                                                  O122 82200019
         IEHDWORK                                                  O122 82300019
         END                                                            82400019
./  ADD  SSI=80130049,NAME=IEHDREST
         COPY  LCGASMSW                                                 00102800
*********************************************************************** 00104837
*                  FIXES THIS MODULE                                  * 00104937
*                     LATEST FIRST                                    * 00105037
*********************************************************************** 00105137
*                                                                       00105299
*D 21000                                    SU32 ONLY          @ZA25515 00105399
*C 31550                                    SU32 ONLY          @ZA25515 00105499
*A 314600-314603,699300                     SU32 ONLY          @ZA25515 00105599
*                                                                       00105999
*C 031550                           @ZA18390=@YA16248=@XA16068=@SA75612 00106099
*A 314705,314706                    @ZA18390=@YA16248=@XA16068=@SA75612 00106199
*                                                                       00106299
*A 407685,407691,407792,407798      @ZA18389=@YA16247=@XA16067=@SA75611 00106799
*                                                                       00107299
*  VS2-3 FOR SU32 NO DELETIONS                                 @G32DSPD 00107799
*                                                                       00108299
*C 31600                                     @ZA16473=@YA15361=@XA16061 00108799
*A 510318-510323                             @ZA16473=@YA15361=@XA16061 00109299
*                                                                       00109799
*C 32000,348400                              @XA12893=@YA13102=@ZA07406 00110299
*A 31500-31600,524100                        @XA12893=@YA13102=@ZA07406 00111232
*                                                                       00113232
* FIX S337 ABEND AT END OF 2ND REEL.                           @ZM40467 00116037
*                                                                       00121037
*A 501614,618,644                                              @ZM40033 00126037
*                                                                       00128032
*                                                                       00131037
*  FIX APPLIED IN IEHDRVID          @SA75573=@XA10920=@YA10569=@ZA04433 00136037
*                                                                       00146037
*C 510647,510651,510655             @SA69560=@XA06597=@YA06113=@ZA01235 00148537
*                                                                       00150537
*C 510745,510749                    @SA69553=@YA04792=@XA04172=@ZA01202 00151037
*A 510738-510739,518870             @SA69553=@YA04792=@XA04172=@ZA01202 00156037
*                                                                       00166037
*C532240                                              OZ00102 = VS08412 00171037
*                                                               XM05805 00176037
*217000-228730,406600-407260,531600,535800   SA65560 = OX02864 = OY0265 00181037
*  APAR XA02828 FIXED AND FLAGGED AS OX02864                    XA02828 00186037
*C003071,D003402,A003704-003728,024761-024794,A037020,037920-038044     00191037
* 354900,355400-355920,356500,360500,361000,535900    OX2677 = SA65706  00201037
*                                                     OX1801 = SA61432  00206037
*                                                                     * 00211037
*STATUS CHANGE LEVEL 005                                              * 00216937
*********************************************************************** 00218937
         TITLE 'IEHDREST --- RESTORE FUNCTION'                          00224837
IEHDREST CSECT                                                          00226837
*FUNCTION/OPERATION- THIS ROUTINE HANDLES THE -RESTORE- FUNCTION      * 00228737
*   OF THE IEHDASDR SYSTEM UTILITY PROGRAM. RESTORE CONSISTS OF       * 00234637
*   RESTORING(COPYING) DATA TO A DIRECT ACCESS DEVICE FROM TAPE.      * 00240537
*   THE TAPE MUST HAVE BEEN CREATED EITHER BY -IEHDASDR- OR THE       * 00246437
*   STAND-ALONE DUMP/RESTORE PROGRAM. DATA IS RESTORED ONLY TO A      * 00252337
*   VOLUME RESIDING ON THE SAME DEVICE TYPE FROM WHICH IT WAS         * 00258237
*   DUMPED.                                                           * 00264137
*   RACF AUTHORIZATION IS REQUIRED IN ORDER TO USE THE         @G32DSPD 00270032
*   'CPYVOLID=YES' OPTION ON VOLUME IDS THAT ARE DEFINED TO    @G32DSPD 00280032
*   RACF.                                                      @G32DSPD 00290032
*                                                                     * 00300000
*INPUT-  POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL         * 00302002
*   BLOCK(REGISTER 10).                                               * 00302402
*   THE TAPE HAS THE FOLLOWING FORMAT                                 * 00307137
*                                                                     * 00307502
*   LIMITS RECORD- ALWAYS THE FIRST RECORD AFTER A TAPE MARK ON       * 00309102
*   EACH VOLUME OF TAPE. THIS RECORD IS 24 BYTES IN LENGTH AND        * 00311102
*   CONTAINS THE FOLLOWING INFORMATION.                               * 00311502
*                                                                     * 00311902
*        BYTES 0-3    CCHH OF THE FIRST TRACK DUMPED.                 * 00312102
*        BYTES 4-7    CCHH+1 OF THE LAST TRACK DUMPED.                * 00312202
*        BYTES 8-11   CCHH OF THE FIRST TRACK THIS VOLUME.            * 00312302
*        BYTES 12-19  CODE THAT IDENTIFIES THIS AS BEING A            * 00312402
*                     RESTORE TAPE.                                   * 00313202
*        BYTE  20     FULL DUMP SWITCH -X'F0'=FULL,X'00'=PARTIAL.     * 00313602
*        BYTE  21     DEVICE TYPE CODE AS FOLLOWS.                    * 00314002
*                      CODE 2    2314                                 * 00314402
*                           6    2305-1                               * 00314802
*                           7    2305-2                               * 00314902
*                           9    3330                                 * 00315502
*                           A    3340                                 * 00315902
*                           D    3330-1                               * 00316302
*        BYTE  22     3340 MODEL NUMBER                               * 00316702
*        BYTE  23     RESERVED                                        * 00316902
*                                                                     * 00317502
*   CONTROL RECORD- THIS RECORD IS WRITTEN FOR EACH TRACK DUMPED      * 00317602
*   AND IMMEDIATELY PRECEDES THE DATA RECORD FOR EACH TRACK. IT       * 00318002
*   CONTAINS A CHANNEL PROGRAM USED BY RESTORE TO WRITE ONE TRACK.    * 00318402
*   THE LENGTH OF THIS RECORD DEPENDS ON THE NUMBER OF RECORDS ON     * 00318802
*   THE DUMPED TRACK.                                                 * 00318902
*                                                                     * 00319002
*   TRACK IMAGE RECORD- THIS RECORD CONTAINS THE DATA DUMPED FROM     * 00319202
*   A TRACK AND ALWAYS FOLLOWS A CONTROL RECORD.  IT IS WRITTEN AS    * 00320002
*   ONE MAXIMUM LENGTH PHYSICAL RECORD ON TAPE. IT CONTAINS THE       * 00321402
*   DATA FIELD OF RECORD ZERO AND ALL FIELDS OF OTHER RECORDS THAT    * 00326102
*   WERE ON THE TRACK THAT WAS DUMPED.                                * 00330802
*                                                                     * 00335502
*   TRAILER RECORD- THIS ALWAYS FOLLOWS THE TAPE MARK THAT WAS AT     * 00344902
*   THE END OF THE LAST TRACK IMAGE RECORD. IT IS 24 BYTES IN         * 00349602
*   LENGTH, OF WHICH ONLY THE FIRST 4 BYTES ARE USED. IT INDICATES    * 00354302
*   WHETHER THE RESTORE IS COMPLETE WHEN THE END OF THIS VOLUME       * 00359002
*   IS REACHED.                                                       * 00363702
*                                                                       00372937
*EXITS-NORMAL- A SUCCESSFUL RESTORE RESULTS IN A RETURN TO THE        * 00373102
*   MODULE -IEHDINIT- WITH A RETURN CODE OF 0. A RESTORE COMPLETE     * 00377802
*   MESSAGE IS ALSO PLACED IN THE MESSAGE DATA SET.                   * 00382502
*                                                                     * 00387202
*EXITS-ERROR-  ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROP-       * 00391902
*   IATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER       * 00396602
*   THAN ZERO WILL ALSO BE PASSED BACK TO MODULE -IEHDINIT-.          * 00401302
*                                                                     * 00406002
*EXTERNAL ROUTINES-  THIS ROUTINE ONLY ENTERED FROM THE INITIALIZING  * 00410702
*   ROUTINE (IEHDINIT). ALL MESSAGES ARE BUILT BY -IEHDMSGB-          * 00415402
*   AND WRITTEN OUT BY -IEHDPRNT-. ALL DEVICE CONSTANTS REFERENCED    * 00420102
*   ARE IN -IEHDCONS-.                                                * 00424802
*                                                                     * 00434202
*TABLES/WORK AREAS-  UPON ENTRY, REGISTERS 10 AND 12 POINT TO A       * 00438902
*   FUNCTION BLOCK AND WORK AREA RESPECTIVELY. THEY ARE DESCRIBED     * 00443602
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 00448302
*                                                                     * 00481202
*ATTRIBUTES- SERIALLY REUSABLE,RELOCATABLE                            * 00485902
*                                                                     * 00487902
*********************************************************************** 00489902
         EJECT                                                          00490302
*********************************************************************** 00491902
*                                                                     * 00493902
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                           * 00495302
*                                                                     * 00495702
*********************************************************************** 00497302
         SPACE                                                          00499302
GR0      EQU   0                                                        00500016
GR1      EQU   1                                                        00600016
GR2      EQU   2                                                        00700016
GR3      EQU   3                                                        00800016
GR4      EQU   4                                                        00900016
GR5      EQU   5                                                        01000016
GR6      EQU   6                                                        01100016
GR7      EQU   7                                                        01200016
GR8      EQU   8                                                        01300016
GR9      EQU   9                                                        01400016
GR10     EQU   10                                                       01500016
GR11     EQU   11                                                       01600016
GR12     EQU   12                                                       01700016
GR13     EQU   13                                                       01800016
GR14     EQU   14                                                       01900016
GR15     EQU   15                                                       02000016
UCBPTR   EQU   9                                                        02200016
BASEREG  EQU   11                                                       02300016
WORKBASE EQU   12                                                       02400016
K0       EQU   0                       DISPLACEMENT CONSTANT.    A21395 02402020
         SPACE 3                                                        02405016
*********************************************************************** 02407002
*                                                                     * 02409002
*   MESSAGE REFERENCES.                                               * 02410002
*                                                                     * 02412002
*********************************************************************** 02415016
         SPACE                                                          02417002
MESS6    EQU   6                       MESSAGE IEH806                   02425016
MESS13   EQU   13                      MESSAGE IEH813                   02440016
MESS15   EQU   15                      MESSAGE IEH815                   02450016
MESS16   EQU   16                      MESSAGE IEH816                   02455016
MESS28   EQU   28                      MESSAGE IEH828                   02465016
MESS30   EQU   30                      MESSAGE IEH830                   02470016
MESS31   EQU   31                      MESSAGE IEH831          @ZA06534 02470437
MESS32   EQU   32                      MESSAGE IEH832          @ZA06534 02472437
MESS49   EQU   49                      MESSAGE IEH849                   02474437
MESS50   EQU   50                      MESSAGE IEH850                   02476032
MESS64   EQU   64                      MESSAGE IEH864I         @G32DSPD 02478032
         EJECT                                                          02480016
         SPACE 2                                                        02500016
         USING FUNCBLK,10                                               02600016
         USING IEHREST,BASEREG                                          02700016
         USING WORK,12                                                  02800016
         SPACE 1                                                        02900016
IEHREST  SAVE  (14,12),T,*             SAVE THE REGISTERS.              03000002
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          03100016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA07406 03150037
         DC    C'SU32 OZ25515'         LAST FIX THIS MOD       @ZA25515 03155099
APARNO   LA    GR7,RESTSAVE            SAVE AREA ADDRESS.      @ZA07406 03200037
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      03300016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      03400016
         LR    GR13,GR7                LOAD SAVE AREA ADDRESS.          03500016
         SPACE                                                          03510002
         LA    GR9,BLOCKS              ADDRESSING FOR I/O BLOCKS.       03550002
         L     GR3,PTRCFUNC            PTR TO CURRENT FUNCTION.         03560002
         TM    0(GR3),PROCESS          PREVIOUSLY UNDER WAY?            03570002
         BZ    PROCTAPE                NO, START READING TAPE.          03580002
         L     GR15,FRTNPTR            YES, GET RETURN POINTER.         03590002
         BR    GR15                    TAKE UP WHERE WE LEFT OFF.       03592002
         SPACE 3                                                        03642002
PROCTAPE EQU       *                                                    03692002
         BAL   GR2,CKHEADER            PROCESS HDR RECORD       YL02912 03694437
         TM    SWITCH,EOV              1ST REEL ?               YL02912 03784437
         BO    PRIME1                   NO, PROCESS TAPE        YL02912 03874437
         L     GR1,BUFFPTR1             POINT TO DPASS WORK AREA        03992002
         LINK  EP=IEHDPASS                                              04092002
         LTR   GR15,GR15                GOOD RETURN ?           YL02912 04142002
         BNZ   FINAL4                   NO, EXIT WITH RC 8      YL02912 04192002
         B     PRIME1                   YES, PROCESS TAPE       YL02912 04201037
         EJECT                                                          04292002
*********************************************************************** 22816903
*        THIS SECTION WILL READ THE TAPE HEADER RECORD FROM THE       * 22817302
*        RESTORE TAPE AND VERIFY IT FOR INITIAL AND EOV PROCESSING.   * 22817602
*********************************************************************** 22967737
         USING IOBLOCKS,GR9                                             23017737
CKHEADER LA    GR9,BLOCKS              I/O CONTROL BLOCKS.      US03168 23067737
TAPEIN2  LA    GR3,CONTROL             ADDRESS TO READ CONTROL RECORD.  27150002
         ST    GR3,TAPEREAD            SET UP ADDRESS IN CCW.           27200002
         MVI   TAPEREAD,X'02'          RESET OP CODE.                   27250002
         LA    GR3,TAPEREAD            ADDRESS OF CCWS.                 27300002
         ST    GR3,TCCWAD              STORE IN IOB.                    27350002
READCTRL EXCP  TAPEIOB                 READ IN THE CONTROL RECORD.      27400002
         OI    FIRSTSW,PROCHDR           SET PROCESS HDR SWT     OX2864 27410002
         BAL   GR14,WAITTAPE           AWAIT COMPLETION OF READ.        27450002
         NI    FIRSTSW,X'FF'-PROCHDR     RESET PROCESS HDR SWT   OX2864 27460002
CKCTRL   LA    GR3,TAPECCW1            ADDRESS OF CCWS TO READ TAPE.    27500002
         ST    GR3,TCCWAD              STORE IN IOB.                    27550002
         SR    GR3,GR3                                                  27600002
         AIF   ('&LIB' EQ 'LIB1').WIN02 BRCH IF OS ASSEM        XL03130 27610002
         IC    GR3,CONTROL+D22          GET WINCH MODEL NO.     XL03130 27620002
         STC   GR3,IDEVMOD              STORE MODEL NO.I/P      XL03130 27630002
.WIN02   ANOP                                                   XL03130 27640002
         IC    GR3,CONTROL+21          DEVICE TYPE CODE FROM TAPE       27650002
         LA    GR3,CODES(GR3)          ADDRESS OF UCB DEVICE TYPE CODE. 27700002
         CLC   CONTROL+17(3),SACODE4   IS THIS A RESTORE TAPE.          27710037
         BNE   RMESS2                  NO--                             27780037
         CLC   IODEVCON(1),0(GR3)      DO THE DA DEVICE TYPES MATCH.    27850002
         AIF   ('&LIB' EQ 'LIB1').ICE01 BRCH IF OS ASSEM        XL03145 27860002
         BCR   EQ,GR2                   YES, START PROCESSING.  XL03145 27870002
         CLI   IODEVCON,ICEBERG         IS RECEIVING VOL AN     XL03145 27880002
*                                       ICEBERG DEVICE.         XL03145 27890002
.ICE02   ANOP                                                   XL03145 27892002
         BNE   RMESS1                   NO, ISSUE ERR MSG       XL03145 27894002
         AIF   ('&LIB' EQ 'LIB1').ICE01 BRCH IF OS ASSEM        XL03145 27896002
         CLI   D0(GR3),MERLN            WAS TRANSMITTING VOL A  XL03145 27898002
*                                       MERLIN DEVICE (3330).   XL03145 27898402
         BNE   RMESS1                   NO, GO GIVE ERROR MSG   XL03145 27898802
         OI    FIRSTSW,DOSBIT           FLAG FOR LATER TESTING  XL03145 27899202
.ICE01   ANOP                                                   XL03145 27899602
         BR        GR2       RETURN TO CALLING RTNE.            OX02864 27900002
         EJECT                                                          28010002
*********************************************************************** 28050002
*                                                                     * 28100002
*        START FUNCTION BY FILLING BUFFERS.                           * 28150002
*                                                                     * 28200002
*********************************************************************** 28250002
         SPACE                                                          28300002
PRIME1   LA    GR9,BLOCKS              ADDRESS OF I/O BLOCKS.           28700016
         AIF   ('&LIB' EQ 'LIB1').WIN03 BRCH IF OS ASSEM        XL03130 28810003
         CLI   IODEVCON,WINCH           WINCH DEVICE ?          XL03130 28820003
         BNE   WIN04                    NO, BRCH                XL03130 28830003
         CLC   IDEVMOD,ODEVMOD          COMPARE WINCH MODEL NO. XL03130 28850003
         BE    WIN04                    BRCH IF MODELS EQ       XL03130 28862003
         BH    RMESS1                   BRCH IF I/P BIGGER O/P  XL03130 28870003
         OI    FIRSTSW,DOSBIT           CAUSE F4 DOS-CONTAM-BIT XL03130 28872003
*                                       TO BE SET               XL03130 28874003
WIN04    EQU   *                                                XL03130 28876003
.WIN03   ANOP                                                   XL03130 28880003
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     28900016
         OI    0(GR3),PROCESS          INDICATE FUNCTION IS UNDER WAY.  29000016
RDTAPE1  EXCP  TAPEIOB                 READ INTO BUFFER ONE.            29030037
         BAL   GR14,WAITTAPE           AWAIT COMPLETION.                29130037
         SPACE 1                                                        29230037
START1   L     GR2,BUFFPTR1            BUFFER ONE ADDRESS.              29330037
         BAL   GR14,CONVCCW            SET UP CCWS FOR SYSTEM. @ZA06534 29430037
         BAL   GR2,WRITE               WRITE ON DA FROM BUFFER ONE.     29700016
         CLI   BUFFSW,ON               ARE WE DOUBLE BUFFERED.          29800016
         BNE   RETURN                  NO--CHECK CONCURRENT OR WAIT.    29900016
         SPACE 1                                                        30100016
         LA    GR3,TAPECCW2            READ CCWS FOR BUFFER TWO.        30200016
         ST    GR3,TCCWAD              ADDRESS TO IOB.                  30300016
         EXCP  TAPEIOB                 FILL BUFFER TWO.                 30400016
         SPACE 1                                                        30500016
RETURN   EQU   *                       CHECK IF RETURN TO MONITOR.      30600016
         TM    SW1,MULTIPLE            ANY REASON TO GO BACK TO MONITOR 30730016
         BZ    WAITOUT1                NO--GO TO WAIT.                  30760016
         LA    GR3,WAITOUT1            RETURN ADDRESS.                  30800016
RETURN1  ST    GR3,FRTNPTR             SAVE IN RETURN POINTER.          30900016
         LA    GR15,0                  SET RETURN CODE.                 30950016
         B     FINAL3                  RETURN TO MONITOR.               31000016
         SPACE 1                                                        31200016
WAITOUT1 EQU   *                                                        31300016
         BAL   GR14,WAITDISK           AWAIT OUTPUT OF ONE.             31400016
CHGSERAL EQU   *                                                 M0640  31403020
         TM    FIRSTSW,HEX1            FIRST TIME THROUGH       RESTFIX 31406002
         BO    CHKMORE                 NO                        M0640  31409002
         OI    FIRSTSW,HEX1            SET SWITCH FOR ENTRY     RESTFIX 31412002
         LA    GR3,SRCHKEYR            ADDR OF CCW FOR REC 3     M0640  31415002
         ST    GR3,DCCWAD              SET UP IOB                M0640  31418002
         XC    DSEEK+3(4),DSEEK+3      CLEAR SEEK ADDR           A38120 31419002
         L     GR5,BUFFPTR1            GET BUFFER ADDR           M6350  31419237
         ST    GR5,RDVOLSER            PUT IN READ/WRITE CCW     M6350  31420002
         MVI   RDVOLSER,X'06'          PUT IN READ COMMAND       M6350  31420502
         EXCP  DISKIOB                                           M0640  31421020
         WAIT  ECB=DISKECB                                       M0640  31424020
         CLI   DISKECB,GOOD                                      M0640  31427020
         BNE   IOERR                   GOT AN ERROR              M0640  31430002
         SPACE                                                          31430402
*********************************************************************** 31432002
*                                                                     * 31433002
*        AFTER THE UNITIAL WRITE TO DISK THE VOL SER THAT WAS WRITTEN * 31436002
*       THERE FROM TAPE HAS BEEN PUT INTO RDVOLBUF BY ABOVE CHAN      * 31439002
*        PROG. THIS SER MUST BE SAVED AND REPLACED BY THE ORIGINAL.   * 31442002
*                                                                     * 31445002
*********************************************************************** 31447002
         SPACE                                                          31448002
         L     GR8,TUCBPTR              GET UCB PTR              A42500 31450021
         MVI   RDVOLSER,X'05'           PUT IN WRITE COMMAND     M6350  31452001
         MVC   IDSAVE(6),4(GR5)         SAVE DISK VOLID          M6350  31453020
         MVC   4(6,GR5),28(GR8)         PUT BACK ORIGINAL VOLID. A42500 31457002
*********************************************************************** 31457232
*     THIS SECTION OF CODE PERFORMS RACF CHECKING. IF THE VOLID TO    * 31457432
*  BE COPIED IS DEFINED TO RACF AND THE USER DOES NOT HAVE ALTER      * 31457632
*  ACCESS TO IT, HE WILL BE DENIED EXECUTION OF THE 'CPYVOLID'        * 31457832
*  OPTION.                                                     @G32DSPD 31458032
*********************************************************************** 31458232
         TM    SEQSW,CPYVOLID           COPY VOLID REQUESTED ? @G32DSPD 31458432
         BNO   NOCHECKS                 NO,SKIP RACF CHECKS    @G32DSPD 31458632
         L     GR6,CVTPTR               GET CVT POINTER        @G32DSPD 31458832
         USING CVT,GR6                                         @G32DSPD 31459032
         L     GR6,CVTRAC               GET RACF POINTER       @G32DSPD 31459232
         DROP  GR6                                             @G32DSPD 31459432
         LTR   GR6,GR6                  IS RACF ACTIVE ?       @G32DSPD 31459632
         BZ    NOCHECKS                 NO,SKIP RACF CHECKS    @G32DSPD 31459832
         USING RCVT,GR6                 DO TEST IF RACF IS     @ZA25515 31460099
         TM    RCVTSTA1,RCVTDASD        CURRENT.               @ZA25515 31460199
         BZ    NOCHECKS                 NO DONT DO RACHECK     @ZA25515 31461299
         DROP  GR6                      YES DO RACHECK         @ZA25515 31461399
         MVC   RACVOL(6),IDSAVE         SET VOLID FOR RACHECK  @G32DSPD 31461499
         RACHECK  ATTR=ALTER,ENTITY=RACVOL,CLASS='DASDVOL'     @G32DSPD 31461599
         CLM   GR15,B'0001',RC8         USER AUTHORIZED ?      @G32DSPD 31461699
         BNE   CHECKSOK                 YES,CHECKS OK          @G32DSPD 31461799
         NI    SEQSW,255-CPYVOLID       FORBID COPY VOLID      @G32DSPD 31461899
         OI    FLGBYT2,CPYREJEC         SET CPYVOLID DISALLOWED@G32DSPD 31461999
         BAL   GR4,UNAUTH               GO PRINT MSG           @G32DSPD 31462099
CHECKSOK EQU   *                        USER IS AUTHORIZED     @G32DSPD 31462199
NOCHECKS EQU   *                        RACF NOT ACTIVE        @G32DSPD 31462232
         OC    COPYPTR(4),COPYPTR       ARE THERE ANY COPIES?           31463402
         BZ    GOWRT                    NO, GO WRITE VOLID.             31463802
         L     GR8,COPYPTR              YES, GET COPY BLOCK.            31464202
         USING COPYBLK,8                                         M2888  31466802
LOOPWRT  EQU   *                                                 M2888  31467102
         LA    GR9,CIOBLOCK             ADDRESSING FOR I/O BLOCKS.      31467402
         ST    GR3,DCCWAD               SET UP IOB.                     31467702
         OC    CCOPYPTR(4),CCOPYPTR     ARE THERE MORE COPIES?          31468102
         BZ    GOWRT                    NO, GO WRITE VOLID.             31468302
         L     GR8,CCOPYPTR             YES, GET NEXT COPY BLOCK.       31468602
         DROP  8                                                        31468902
         B     LOOPWRT                  GO UPDATE COPY BLOCK.           31469202
GOWRT    EQU   *                                                        31469502
         LA    GR9,BLOCKS               ADDRESSING FOR PRIMARY BLOCKS.  31469802
         EXCP  DISKIOB                                                  31470102
         WAIT  ECB=DISKECB                                              31470402
         CLI   DISKECB,GOOD                                    @ZA18390 31470500
         BNE   IOERR                                           @ZA18390 31470600
         MVC   DSEEK+3(4),CONTROL+8     RESET IOB SEEK           A38120 31470702
         OC    COPYPTR(4),COPYPTR       ANY COPIES?                     31471002
         BZ    ENDVOLID                 NO, TEST FOR BUFFERS.           31471302
         L     GR8,COPYPTR              YES, GET COPY BLOCK.            31471602
         USING COPYBLK,GR8                                              31471902
COPYIT   LA    GR9,CIOBLOCK             ADDRESSING FOR COPY BLOCKS.     31472202
         XC    DSEEK+3(4),DSEEK+3       CLEAR SEEK ADDRESS       A38120 31472502
         L     GR3,CUCBPTR              GET PTR TO COPY UCB PTR  M2888  31472802
         MVC   4(6,GR5),28(GR3)         PUT BACK ORIGINAL VOLID  M6350  31475802
         EXCP  DISKIOB                                           M2888  31489001
         WAIT  ECB=DISKECB                                       M2888  31490101
         MVC   DSEEK+3(4),CONTROL+8     RESET IOB SEEK           A38120 31491201
         OC    CCOPYPTR(4),CCOPYPTR                              M2888  31492301
         BZ    ENDVOLID                                          M2888  31493401
         L     GR8,CCOPYPTR                                      M2888  31494501
         B     COPYIT                                            M2888  31495601
ENDVOLID LA    GR9,BLOCKS                                        M2888  31496701
CHKMORE  EQU   *                                                 M0640  31497801
         SPACE 1                                                        31500016
         CLI   BUFFSW,ON               ARE THERE TWO BUFFERS.           31600016
         BNE   RDTAPE1                 NO--GO START ON 1 AGAIN.         31700016
         SPACE 1                                                        31800016
         BAL   GR14,WAITTAPE           YES-GO WAIT TO FILL BUFFER TWO.  31900016
         L     GR2,BUFFPTR2            BUFFER TWO ADDRESS.              31910037
         BAL   GR14,CONVCCW            SET UP CCWS FOR SYSTEM. @ZA06534 32010037
         BAL   GR2,WRITE               WRITE ON DA FROM BUFFER TWO.     32200016
         LA    GR3,TAPECCW1            CCWS TO FILL BUFFER ONE.         32400016
         ST    GR3,TCCWAD              STORE IN IOB.                    32500016
         EXCP  TAPEIOB                 FILL BUFFER ONE.                 32600016
         EJECT                                                          32700016
*   LINK BACK TO MONITOR HERE.                                          32800016
         TM    SW1,MULTIPLE            ANY REASON TO GO BACK TO MONITOR 32930016
         BZ    WAITOUT2                NO--GO TO WAIT.                  32960016
         LA    GR3,WAITOUT2            RETURN ADDRESS.                  33000016
         B     RETURN1                 RETURN TO MONITOR.               33100016
         SPACE 2                                                        33300016
WAITOUT2 BAL   GR14,WAITDISK           AWAIT OUTPUT OF BUFFER TWO.      33400016
         BAL   GR14,WAITTAPE           AWAIT INPUT OF BUFFER ONE.       33500016
         B     START1                  GO START OUTPUT OF ONE.          33600016
WRITE    EXCP  DISKIOB                 OUTPUT BUFFER ONE.               33605016
         OC    COPYPTR(4),COPYPTR      ARE WE RESTORING TO MORE DEVICES 33610016
         BCR   8,GR2                   NO--NO COPIES TODAY.             33615016
         L     GR8,COPYPTR             POINTER TO FIRST COPY BLOCK.     33620016
         USING COPYBLK,GR8                                              33625016
MORECOPY LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY      M2888   33627037
         SPACE                                                          33635016
         EXCP  DISKIOB                 WRITE OUT BUFFER ONE TO COPY.    33640016
         SPACE                                                          33645016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           33650016
         BZ    MORE1                   NO--CONTINUE ON.                 33655016
         L     GR8,CCOPYPTR            YES-POINTER TO NEXT COPY BLOCK.  33660016
         B     MORECOPY                GO WRITE ON NEXT DEVICE  M2888   33665002
         SPACE                                                          33670016
MORE1    LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY DEVICES.  33675016
         BR    GR2                     RETURN.                          33680016
         SPACE 1                                                        33700016
WAITTAPE TM    TAPEECB,COMPLETE        IS THE OPERATION COMPLETE.       33800016
         BO    TESTT                   YES-GO TEST THE STATUS.          33900016
         WAIT  ECB=TAPEECB             AWAIT COMPLETION OF TAPE.        34000016
TESTT    EQU   *                                                 M0640  34060020
         CLI   TAPEECB,GOOD            ALL OK                    M0640  34120002
         MVI   TAPEECB,0               CLEAR ECB               @ZA06534 34160037
         BCR   8,GR14                  ALL OKAY//RETURN TO PROCESS.     34170037
         TM    TSTATUS+4,X'01'         WAS A TAPE MARK READ.            34180037
         BZ    IOTERR                   NO--MUST BE ERROR.     @ZA06534 34190037
         TM    FIRSTSW,PROCHDR         READING HDR REC ?        OX2864  34200037
         BNO   NOTHDR                  NO, BRCH                OX2864   34210037
         NI    FIRSTSW,X'FF'-PROCHDR   RESET PROCESS HDR SWT   OX2864   34220037
         EXCP  TAPEIOB                 REISSUE READ         OX2864      34274537
         B      WAITTAPE                                        OX2864  34274637
NOTHDR   EQU   *                                                NUFRNT  34274737
         L     GR3,PTRCFUNC            CURRENT QUEUE SLOT.              34275016
         TM    0(GR3),PROCESS          THIS FUNCTION REALLY STARTED.    34280016
         BZ    RMESS2                  NO--MUST BE EOF ON INITIAL READ. 34285016
         LA    GR3,TAPEDCB             TAPE DCB ADDRESS.                34290016
         USING IHADCB,GR3                                               34310016
         NI    DCBIFLGS,X'3F'          TURN OFF ERROR FLAGS.            34330016
         B     EOFTAPE                  GO HANDLE EOF           MVMPROB 34350002
         SPACE                                                          34351016
WAITDISK BAL   GR4,WAITD               WAIT ON PRIMARY DEVICE.          34352016
         OC    COPYPTR(4),COPYPTR      ARE COPIES BEING MADE.           34352537
         BCR   8,GR14                  NO--RETURN.                      34353537
         L     GR8,COPYPTR             YES-ADDRESS OF FIRST COPY BLOCK. 34355016
         USING COPYBLK,GR8                                              34356016
WAIT1    LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY.             34357016
         BAL   GR4,WAITD               AWAIT THIS COPY.                 34359016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           34361016
         BZ    WAIT2                   NO--GET SET TO RETURN.           34362016
         L     GR8,CCOPYPTR            YES-ADDRESS OF NEXT COPY BLOCK.  34363016
         B     WAIT1                   GO WAIT ON NEXT COPY.            34364016
WAIT2    LA    GR9,BLOCKS              RESET ADDRESSING/PRIMARY DEVICE. 34374016
         BR    GR14                    RETURN.                          34384016
WAITD    TM    DISKECB,COMPLETE        IS THE OPERATION COMPLETE.       34500016
         BO    TESTD                   YES-GO TEST THE STATUS.          34600016
         WAIT  ECB=DISKECB             AWAIT COMPLETION OF DISK.        34700016
TESTD    EQU   *                                                        34800037
         CLI   DISKECB,GOOD            ALL OK ?                         34805037
         BCR   8,GR4                   YES-RETURN.                      34810016
         TM    DSTATUS+4,EOF1          WAS AN EOF ENCOUNTERED.          34820016
         BCR   1,GR4                   RESTORE CHAIN IS          M2888  34826002
*                                       COMPLETE                 M2888  34832020
         TM    DSENSE+1,NRFOPE        NO,NRF OR OPER INCOMPL   @ZA07406 34840037
         BNO   IOERR                  PERMANENT ERROR                   34845037
         EJECT                                                          34851537
*********************************************************************** 34852002
*                                                                     * 34860002
*   THIS CODING USED ONLY WHEN INTERRUPTED WHILE READ-BACK CHECKING   * 34870016
*     A TRACK-OVERFLOW OR END-OF-FILE RECORD.                         * 34880016
*                                                                     * 34890002
*********************************************************************** 34892002
         SPACE                                                          34894002
         L     GR3,TUCBPTR             YES-ADDRESS OF UCB.              34900016
         USING UCB,GR3                                                  34910016
         CLI  UCBTBYT4,ZEUS1            2305-1 DEVICE ?         SA57293 34920001
         BE   YEAZ                      YES, BRCH               SA57293 34922001
         CLI  UCBTBYT4,ZEUS2            2305-2 DEVICE           SA57293 34924001
         BNE  NOZ                       NO, BRCH                SA57293 34926001
YEAZ     EQU  *                                                 SA57293 34928001
         L    GR3,DDCBAD                GET DCB ADDR            SA57293 34928401
         USING IHADCB,GR3                                       SA57293 34928801
         L    GR3,DCBDEBAD              GET DEB ADDR            SA57293 34929201
         L    GR3,T32(GR3)              GET ZEUS UCB EXPOSURE   SA57293 34929601
NOZ      EQU   *                                                SA57293 34931501
         USING UCB,GR3                                          SA57293 34933401
         CLC   CCHH,UCBSEEK             WERE WE SWITCHED        YL02912 34935302
*                                       TO THE NEXT TRACK.      YL02912 34935702
         BL    REIT                     IF LOW REISSUE           M2916  34937201
         L     GR8,COPYPTR              CHECK COPIES             M2916  34939101
NRFLOOP  LTR   GR8,GR8                  ARE THERE COPIES         M2916  34940037
         BZ    IOERR                    PROCESS ERROR.         @ZA06534 34943037
         L     GR3,CUCBPTR              CHECK COPY UCB           M2916  34946701
         CLC   CCHH,UCBSEEK             SAME SEEK ADDRESS       YL02912 34948602
         BL    REIT                     LOW MEANS RETRY          M2916  34950501
         L     GR8,CCOPYPTR             CHECK FOR MORE COPIES    M2916  34952401
         B     NRFLOOP                                           M2916  34954301
REIT     EQU   *                                                 M2916  34956201
         DROP  3                                                        34958101
         SPACE 1                                                        34960016
         LA    GR3,READR0              ADDRESS OF READ R0 CCW.          34970016
         ST    GR3,DCCWAD              RESET STARTING POINT IN IOB.     34981002
         EXCP  DISKIOB                 FINISH THE CCW CHAIN.            35000016
         B     WAITDISK                GO WAIT ON ALL DEVICES.          35020016
         DROP  8                                                        35028016
         EJECT                                                          35030016
EOFTAPE  L     GR3,TCCWAD              ADDRESS OF LAST USED TAPE CCW.   35400016
         L     GR2,TSTATUS              LOAD CSW-CCW PTR        SA53319 35450001
         SH    GR2,EIGHT                EQUALIZE PTRS           SA62856 35452021
         LA    GR3,0(GR3)               ZERO HIGH BYTE          SA62856 35460021
         LA    GR2,0(GR2)               ZERO HIGH BYTE CSW      SA53319 35470001
         CR    GR3,GR2                  EOF ON 1ST CCW ?        SA53319 35480001
         L     GR3,0(GR3)              READ IN AREA.            SA53319 35482001
         BNE   TSTRESTC                GO DO IT                 XM05460 35592003
         SPACE                                                          35594003
         USING RBUFFER,GR3                                              35600016
OLDTAPE  EQU   *                                                OX02677 35650003
         ST    GR3,TAPEREAD            DATA ADDRESS TO CCW.             35700016
         LA    GR2,TAPEREAD            CCW ADDRESS TO READ TRAILER.     35800016
         ST    GR2,TCCWAD              CCW ADDRESS TO IOB.              35900016
         SPACE                                                          36000016
         EXCP  TAPEIOB                 READ TRAILER             OX02677 36100003
         BAL   GR14,WAITTAPE           AWAIT COMPLETION.                36200016
         SPACE                                                          36500016
*   TEST FOR RESTORE BEING COMPLETE HERE.                               36800016
         SPACE 1                                                        36900016
TSTRESTC EQU   *                                                SA53319 36950001
         OC    REELCK(4),RBUFFER       'OR' IN THE TRAILER RECORD.      36960016
         DROP  3                                                        37020016
         CLC   REELCK(4),REELMASK      ARE WE FINISHED.                 37100016
         BNE   VOLCHK                  NO-CHECK FOR MORE TAPES.  A21395 37200020
         EJECT                                                          37300002
*   FINAL PROCESSING ON COPY VOLUMES HERE, IF ANY.                      37303016
         OC    COPYPTR(4),COPYPTR      ARE COPIES BEING MADE.           37306016
         BZ    EXIT1                   NO--ONLY ONE VOLUME.             37309016
         SPACE                                                          37312016
         L     GR5,COPYPTR             POINTER TO FIRST COPY BLOCK.     37315016
         USING COPYBLK,GR5                                              37318016
EXIT     L     GR8,CUCBPTR             POINTER TO UCB FOR COPY.         37321016
         LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY DEVICE.      37322016
         LA    GR7,DDNAME3             DDNAME FOR THIS DEVICE.          37323016
         LA    GR2,CALTDATA            ALTERNATE TRACK INFORMATION.     37323816
         ST    GR5,ADDRBUFF            SAVE COPY BLOCK ADDRESS.         37324616
         BAL   GR5,RDVOLID             GO UPDATE THE ALTERNATE TRACK    37325416
         L     GR5,ADDRBUFF            RESTORE COPY BLOCK ADDRESS.      37326216
*                                        INFORMATION AND VOLID.         37327016
         SPACE                                                          37342016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           37345016
         BZ    EXIT1                   NO--GO PROCESS THE ONE VOLUME.   37348016
         L     GR5,CCOPYPTR            YES-ADDRESS OF NEXT COPY.        37351016
         B     EXIT                    GO PROCESS NEXT COPY.            37354016
         DROP  GR5                                                      37357016
         SPACE                                                          37360016
*   FINAL PROCESSING ON PRIMARY DIRECT ACCESS VOLUME HERE.              37366016
EXIT1    LA    GR9,BLOCKS              MAIN I/O BLOCKS.                 37369016
         L     GR8,TUCBPTR             POINTER TO THIS UCB.             37372016
         LA    GR7,DDNAME2             DDNAME FOR THIS DEVICE.          37373016
         LA    GR2,ALTDATA             ALTERNATE TRACK INFORMATION.     37374016
         BAL   GR5,RDVOLID             GO UPDATE THE ALTERNATE TRACK    37375016
*                                        INFORMATION AND VOLID.         37378016
         L     GR15,RETCODE            GET RETURN CODE.                 37428002
         B     FINALR2                 GO EXIT TO THE MONITOR.          37460016
         EJECT                                                          37500016
*********************************************************************** 37550002
*        THE FOLLOWING CODE IS NECESSARY BECAUSE OF A DUMP/REST  A46379 37600002
*        INCOMPATIABILITY BETWEEN RELEASE 18 AND 20.1.           A46379 37650002
*        THREE TAPE MARKS ARE WRITTEN BETWEEN THE TRAILER LABELS A46379 37700002
*        AND THE IEHDASDR TRAILER RECORD UNDER REL. 18, BUT ONLY A46379 37750002
*        TWO ARE WRITTEN BY REL. 20.1.                           A46379 37800002
*********************************************************************** 37850002
         USING IOBLOCKS,9                                               40600016
EOV1     EQU   *                                                OX2864  40610003
         TM    SWITCH,STDLABEL          SL TAPE ?               OX2864  40650003
         BNO   EOV1B                   NO, NO SPACING NEEDED.   OX02864 40726002
         SPACE                                                          40743402
         LA    GR8,TAPECHK             ADDR OF SPACE FORWD CCW   A46379 40743621
         ST    GR8,TCCWAD              STORE THAT ADDR IN IOB    A46379 40743721
SPACETP  EQU   *                                                OX2864  40747203
         EXCP  TAPEIOB                 EXECUTE THE CCW           A46379 40750903
         WAIT  ECB=TAPEECB             WAIT FOR THE SPACE FWD    A46379 40754403
         TM    TSTATUS+4,EOF1          WAS TAPE EOF ENCOUNTERED  A46379 40757921
         BO    SPACETP                 BRANCH IF YES             OX2864 40767903
         CLI   TAPEECB,GOOD                                    @ZA18389 40768500
         BNE   IOTERR                                          @ZA18389 40769100
         LA    GR8,BACKTAPE            ADDR OF SPACE BKWD CCW    A46379 40769921
         ST    GR8,TCCWAD              STORE THAT ADDR IN IOB    A46379 40771921
         EXCP  TAPEIOB                 EXECUTE THE BSP CCW       A46379 40776621
         WAIT  ECB=TAPEECB             WAIT FOR THE SPACE FWD    A46379 40778621
         CLI   TAPEECB,GOOD                                    @ZA18389 40779200
         BNE   IOTERR                                          @ZA18389 40779800
*        END OF ABOVE MENTIONED COMPATIABILITY CODE.             A46379 40780621
EOV1B    EQU   *                                                   1326 40781321
         LA    GR8,TAPEDCB             DCB ADDRESS.                     40786021
         USING IHADCB,8                                                 40800016
         XC    DCBBLKCT(4),DCBBLKCT    INSURE BLOCK COUNT IS ZERO.      40850016
         NI    DCBOFLGS,X'33'          INSURE BITS 0,1,4,5 ARE ZERO.    40900002
         OI    DCBOFLGS,X'04'          INDICATE TAPE MARK READ   A21395 40906037
         EOV   TAPEDCB                                                  41000016
         OI    SWITCH,EOV              REMEMBER VOLUME CROSSOVER.       41050016
         BAL   GR2,CKHEADER            GO READ/VERIFY HEADER    US03168 41052003
         B     PRIME1                  GO START ON NEXT TAPE.   US03168 41100003
         EJECT                                                          41200016
*********************************************************************** 41300016
*                                                                     * 41400016
*   THE FOLLOWING ROUTINE CONVERTS AND SETS UP THE CCWS THAT WERE     * 41500016
*   READ IN FROM TAPE FOR USE UNDER THE OPERATING SYSTEM. THIS        * 41600016
*   ROUTINE ALSO INCREMENTS THE TRACK ADDRESS AND STORES IT IN        * 41700016
*   THE IOB.                                                          * 41800016
*        REGISTER 2 MUST CONTAIN THE ADDRESS OF THE BUFFER.           * 41900037
*          UPON ENTRY.                                                * 42000016
*        REGISTER 6 IS USED AS A WORK REGISTER.                       * 42100016
*        REGISTER 7 IS A POINTER TO THE CURRENT CCW BEING CHECKED.    * 42200016
*        REGISTER 14 IS THE RETURN REGISTER.                          * 42300016
*********************************************************************** 42500016
         SPACE                                                          42550002
         USING RBUFFER,GR2                                              42700037
CONVCCW  L     GR4,IODEVCON            DEVICE CONSTANT ADDRESS @ZA06534 42900037
         USING CONSTANT,GR4                                    @ZA06534 42970037
         XC    ZERO1,ZERO1             CLR FIRST 8 BYTES OF BUF@ZA06534 43040037
         LR    GR0,GR2                 BUFFER ADDRESS.         @ZA06534 43110037
         AH    GR0,CCWSIZE             DATA SLOT ADDRESS.               43200016
         LA    GR9,BLOCKS              ADDRESS OF I/O CONTROL BLOCKS.   43300016
         USING IOBLOCKS,9                                               43400016
         LA    GR7,SEARIDE             FIRST CCW TO BE CHECKED.         43600016
         TM    SEQSW+D1,RPSFEAT        TODD HAVE RPS                    43620002
         BZ    TESTCCW                 NO                               43640002
         MVC   SETMASK(L8),SETCCW      YES,MOVE SECTOR CCW              43660002
*                                       INTO BUFFER OVER SFM CCW        43680002
TESTCCW  CLI   0(GR7),8                IS THIS A TIC COMMAND.           43700016
         BE    YESTIC                  YES-GO PROCESS.                  43800016
         MVI   TICSW,X'00'             NO--INSURE TIC SWITCH IS CLEAR.  43900016
         CLI   0(GR7),X'31'            IS THIS A SEARCH ID EQUAL.       44000016
         BE    YESSRCH                 YES-GO PROCESS.                  44100016
         CLI   0(GR7),X'1D'            IS THIS A WRITE COUNT-KEY-DATA   44200016
         BNE   NOTWCKD                 NO, CONTINUE CHKING      YM2241  44300002
         CLC   6(2,GR7),TOBIG          MAX BYTE COUNT           YM2241  44350002
         BNE   WRTCKD                  NO, CONTINUE CHK         YM2241  44360002
         MVC   6(2,GR7),DATASIZE       SET CNT TO BUFFSIZE      YM2241  44370002
         B     WRTCKD                  CONTINUE                 YM2241  44380002
NOTWCKD  EQU   *                       CONTINUE CHKING          YM2241  44390002
         CLI   0(GR7),X'05'            IS THIS A WRITE DATA.            44400016
         BE    WRTDATA                 YES-GO PROCESS.                  44500016
         CLI   0(GR7),X'11'            IS THIS AN ERASE CCW.            44600016
         BE    ERASE                   YES-GO PROCESS.                  44700016
         CLC   6(2,GR7),TOBIG          MAX BYTE COUNT           YM3473  44750002
         BNE   NOTRCKD                 NO, CONTINUE CHK         YM3473  44760002
         MVC   6(2,GR7),DATASIZE       SET CNT TO BUFFSIZE      YM3473  44770002
NOTRCKD  EQU   *                       CONTINUE CHKING          YM3473  44780002
         CLI   0(GR7),X'01'            IS THIS A WRITE-SPECIAL CKD.     44800016
         BE    WRTCKD                  YES-GO PROCESS.                  44900016
         TM    4(GR7),X'40'            IS THIS THE END OF CHAIN.        45000016
         BZ    CCWEXIT                 YES-RETURN TO CALLER             45100016
NEXTCCW  LA    GR7,8(GR7)              STEP POINTER TO NEXT CCW.        45200016
         B     TESTCCW                 REPEAT FOR THE NEXT CCW.         45300016
YESTIC   LR    GR6,GR7                                                  45400016
         CLI   TICSW,X'FF'             WAS PREVIOUS CCW A TIC.          45500016
         BE    YES2TICS                YES-SPECIAL CASE/TIC FOLLOWS TIC 45600016
         MVI   TICSW,X'FF'             INDICATE A TIC OPERATION.        45700016
         SH    GR6,EIGHT               POINT TO PREVIOUS CCW.           45800016
SETADDR  ST    GR6,ADDRESS             TEMPORARY STORAGE OF ADDRESS.    45900016
         MVC   1(3,GR7),ADDRESS+1      UPDATE ADDRESS FIELD OF CCW.     46000016
         B     NEXTCCW                 GO CHECK THE NEXT CCW.           46100016
YES2TICS LA    GR6,8(GR6)              POINT TO NEXT CCW.               46200016
         MVI   TICSW,X'00'             CLEAR THE TIC SWITCH.            46300016
         B     SETADDR                 UPDATE THE CCW AND CHECK NEXT.   46400016
YESSRCH  LA    GR6,DSEEK+3             ADDRESS OF SEARCH ID IN IOB.     46600016
         B     SETADDR                 UPDATE CCW AND CHECK NEXT.       46800016
WRTCKD   L     GR6,0(GR7)              DATA ADDRESS FROM THIS CCW.      47000016
         LA    GR6,0(GR6)              CLEAR HIGH ORDER BYTE.           47100016
         SH    GR6,BUFFADDR            GET DISPLACEMENT FROM START.     47200016
         AR    GR6,GR0                 ADD THIS TO OS BUFFER START.     47300016
         B     SETADDR                 GO UPDATE CCW ADDRESS.           47400016
WRTDATA  LR    GR6,GR0                 BUFFER ADDRESS FOR DATA.         47600016
         B     SETADDR                 GO UPDATE THE CCW ADDRESS.       47800016
RDCKD    CLC   6(2,GR7),ZERO           IS THIS AN EOF RECORD.           47820016
         BNE   NEXTCCW                 NO--CONTINUE ON.                 47830016
         MVI   0(GR7),X'12'            CHANGE OP CODE TO READ COUNT.    47840016
         B     NEXTCCW                 CONTINUE ON.                     47850016
ERASE    LR    GR6,GR2                 POINTER TO 8-BYTES OF ZERO.      48000037
         ST    GR6,ADDRESS             TEMPORARY STORAGE OF ADDRESS     48100016
         MVC   1(3,GR7),ADDRESS+1      UPDATE ERASE CCW ADDRESS.        48200016
         AGO   .FIX01                                                   48200237
         USING CONSTANT,2                                               48400016
CCWEXIT  L     GR2,IODEVCON            ADDRESSING FOR DEVICE CONSTANT   48500016
.FIX01   ANOP                                                           48500237
CCWEXIT  EQU   *                                               @ZA06534 48500437
         L     GR3,CONTROL+8           CURRENT CCH ADDRESS.             48550016
         MVC   DSEEK+3(4),CONTROL+8    TRACK ADDRESS TO IOB.            48600016
         LA    GR9,BLOCKS              PRIMARY I/O BLOCKS.              48605016
         USING IOBLOCKS,GR9                                             48610016
         LA    GR7,SEARIDE             START OF CCW CHAIN ADDRESS.      48615016
         TM    SEQSW+D1,RPSFEAT        TODD HAVE RPS                    48616002
         BZ    YO                      NO                               48617002
         LA    GR7,SETMASK             YES,POINT TO SET SECTOR          48618002
YO       EQU   *                        *                               48619002
         ST    GR7,DCCWAD              STORE IN IOB.                    48620016
         OC    COPYPTR(4),COPYPTR      ARE THER COPIES.                 48625016
         BZ    Y2                      NO--GO UPDATE THE TRACK ADDRESS. 48630016
         L     GR6,COPYPTR             ADDRESS OF FIRST COPY BLOCK.     48635016
         USING COPYBLK,GR6                                              48640016
Y1       LA    GR9,CIOBLOCK            COPY I/O BLOCKS.                 48645016
         ST    GR7,DCCWAD              CCW ADDRSSS TO COPY IOB.         48650016
         MVC   DSEEK+3(4),CONTROL+8    SET UP SEEK ADDRESS IN COPY IOB. 48655016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           48660016
         BZ    Y3                      NO--GO UPDATE THE TRACK ADDRESS. 48665016
         L     GR6,CCOPYPTR            ADDRESS OF NEXT COPY BLOCK.      48670016
         B     Y1                      GO PROCESS THIS COPY.            48675016
         DROP  GR6                                                      48680016
Y3       LA    GR9,BLOCKS              RESET ADDRESSING/PRIMARY BLOCKS. 48685016
Y2       CLC   DSEEK+6(1),LASTORIG+3   THIS LAST TRACK OF CYLINDER.     48690016
         BC    4,CCWEXIT1              NO--                             48800016
         A     GR3,CONVCYL             YES-STEP TO NEXT CYLINDER.       48900016
         B     CCWEXIT2                SKIP TRACK INCREMENT.            48950002
CCWEXIT1 AL    GR3,F1                  INCREMENT TO NEXT TRACK.         49800016
CCWEXIT2 ST    GR3,CONTROL+8           SAVE NEW VALUE.                  49900016
         BR    GR14                    RETURN.                          50000016
         DROP  GR2,GR4,GR9                                              50000137
         EJECT                                                          50210016
*********************************************************************** 50220016
*                                                                     * 50230016
*   THIS ROUTINE READS IN THE VOLUME LABEL OF THE DIRECT ACCESS       * 50240016
*     DEVICE. IF THE OLD SERIAL NUMBER IS TO BE RETAINED AND IT IS    * 50250016
*     DIFFERENT FROM THE NEW SERIAL NUMBER,THEN THE VOLUME LABEL IS   * 50260032
*     REWRITTEN WITH THE OLD SERIAL NUMBER. THIS ROUTINE ALSO         * 50270016
*     DSCB. THE ACTUAL SERIAL NO. OF THE VOLUME BEING RESTORED IS     * 50280037
*     ALSO SET UP IN THE COMPLETION MESSAGE FOR SUBSEQUENT PRINTING   * 50286037
*     THE ROUTINE TO ACCOMPLISH THIS IS CALLED BY -IEHDREST- AND  IS  * 50292037
*     NAMED -IEHDRVID-                                                * 50298037
*                                                                     * 50304037
*        REGISTER 8 MUST POINT TO THE UCB FOR THE DA DEVICE.          * 50310016
*        REGISTER 9 MUST POINT TO THE DIRECT ACCESS CONTROL BLOCKS    * 50320016
*        REGISTER 7 MUST POINT TO THE DDNAME UPON ENTRY.              * 50325016
*          UPON ENTRY.                                                * 50330016
*        REGISTER 6 IS A WORK REGISTER.                               * 50335016
*        REGISTER 3 IS A WORK REGISTER.                               * 50340016
*        REGISTER 2 MUST POINT TO THE ALTERNATE TRACK INFORMATION.    * 50346016
*        REGISTER 5 IS THE RETURN REGISTER.                           * 50353016
*                                                                     * 50360016
*********************************************************************** 50370016
         SPACE                                                          50372002
RDVOLID  EQU   *                                                        50390616
         CALL  IEHDRVID                CALL ROUTINE IEHDRVID            50391237
         LTR   GR15,GR15               GOOD RETURN FROM RVID ?          50431237
         BNZ   CHECKRET                NO, CHECK RETURN CODE            50471237
         BR    GR5                     RETURN  TO CALLING RTN           50511237
CHECKRET ST    GR15,RETCODE            SAVE RETURN CODE                 50550032
         CLC   RETCODE(4),UNUSRET      RETURN CODE EQU 4?               50591237
         BNE   UNUSRETX                NO, TERMINATE FUNCTION           50631237
         BR    GR5                     YES, CONTINUE PROCESS            50671237
UNUSRETX EQU   *                                                        50711237
         B     IOERR                   SEND ERROR MESSAGE               50751237
*********************************************************************** 50810002
*                                                                     * 50860002
*   THE FOLLOWING SELECTS MESSAGES TO BE PRINTED.                     * 50870002
*                                                                     * 50910002
*********************************************************************** 50920002
         SPACE                                                          50922002
RMESS1   LA    GR1,MESS15              MESSAGE 815.                     50929016
RMESS1A  BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         50937016
         MVC   0(8,GR1),DDNAME2        MOVE DDNAME TO MESSAGE.          50943016
RMESS1B  BAL   GR9,MSGWRT1             WRITE OUT THE MESSAGE.           50945016
         TM    SWITCH,EOV              DID WE EVER WRITE ON DA VOLUME.  50947016
         BO    UNUSABLE                YES-WE BETTER TELL USER/BEWARE.  50949016
         B     FINAL4                  NO--BETTER EXIT.                 50951016
         SPACE                                                          50955016
RMESS2   LA    GR1,MESS16              MESSAGE 816.                     50961016
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         50964016
         MVC   0(8,GR1),DDNAME1         DDNAME TO MESSAGE.     @ZA06534 50967037
         B     RMESS1B                 WRITE OUT MESSAGE       @ZA06534 50971037
         SPACE 2                                                        50975037
* PRINT MESSAGE NOTIFYING USER THAT 'CPYVOLID' REQUEST DENIED  @G32DSPD 50979032
UNAUTH   LA    GR1,MESS64              GET MESSAGE ID          @G32DSPD 50979432
         BAL   GR9,BUILD               GET MESSAGE TEXT        @G32DSPD 50980632
         MVC   0(L'IDSAVE,GR1),IDSAVE  PUT VOLID IN MESSAGE    @G32DSPD 50981032
         BAL   GR9,MSGWRT1             GO WRITE MESSAGE        @G32DSPD 50981432
         BR    GR4                     RETURN                  @G32DSPD 50981832
         SPACE 2                                                        50982232
         USING IOBLOCKS,GR9                                             50983037
IOTERR   EQU   *                                               @ZA06534 50987037
         LA    GR3,TAPEIOB             IOB ADDRESS//TAPES.              50994037
         B     IOERR1                  GO GIVE ERROR MESSAGE.           50994616
IOERR    LA    GR3,DISKIOB             IOB ADDRESS.                     50995216
         DROP  9                                                        50995816
IOERR1   EQU   *                       PRINT I/O ERROR MESSAGES HERE.   50996716
         LR    GR7,GR14                SAVE RETURN ADDRESS.    @ZA06534 50997037
         LA    GR1,MESS13              MESSAGE 813.                     50997416
         BAL   GR9,BUILD               PLACE MESSAGE HEADING IN BUFFER. 50998216
         LR    GR1,GR3                 IOB ADDRESS.                     50998516
         SYNADAF ACSMETH=EXCP,PARM1=(1)                                 50998816
         MVC   MESS+22(78),49(GR1)     MOVE SYNAD MESS TO BUFFER SM4350 50999121
         SYNADRLS                                                       50999416
         BAL   GR9,MSGWRT1             WRITE OUT I/O ERROR MSG.         50999516
         LR    GR14,GR7                RESTORE RETURN ADDRESS. @ZA06534 50999737
         LA    GR9,BLOCKS              REG 9 MAY HAVE BEEN     @ZA06534 50999937
*                                      DESTROYED BY ERROR RTN. @ZA06534 51000137
         EJECT                                                          51000502
UNUSABLE EQU   *                                                        51002502
         BAL   GR4,WTOR                 TELL OPER TO VARY UNIT  YL02912 51002902
*                                       OFFLINE.                YL02912 51003302
         LA    GR3,DDNAME2             DDNAME FOR MESSAGE.              51004002
         BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MESSAGE.  51005002
         OC    COPYPTR(4),COPYPTR      ANY COPIES.                      51006002
         BZ    FINAL4                  NO--BRANCH.                      51007002
         USING COPYBLK,GR3                                              51008002
         L     GR3,COPYPTR             PTR TO 1ST OR ONLY COPY BLK.     51009002
UNUSE    BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MSG.      51010002
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     51011002
         BZ    FINAL4                  NO--BRANCH.                      51012002
         L     GR3,CCOPYPTR            YES-PTR TO NEXT COPY BLK.        51013002
         B     UNUSE                   CONTINUE PROCESSING.             51014002
         SPACE                                                          51015002
         USING COPYBLK,GR8                                      YL02912 51015102
WTOR     EQU   *                                                YL02912 51015402
         L     GR3,TUCBPTR              GET PRIME TODD UCB      YL02912 51015802
         BAL   GR9,WRTWTOR              TELL OPER PACK IS BAD.  YL02912 51017802
         OC    COPYPTR(L4),COPYPTR      ANY COPIES ?            YL02912 51019902
         BCR   8,GR4                    NO, EXIT                YL02192 51020102
         L     GR8,COPYPTR              PICKUP COPY BLK ADDR    YL02129 51020202
         L     GR3,CUCBPTR              LOAD COPY UCB ADDR      YL02192 51020502
WRTOP    BAL   GR9,WRTWTOR              TELL OPER AGAIN         YL02192 51020902
         OC    CCOPYPTR(L4),CCOPYPTR    MORE COPIES ?           YL02192 51021302
         BCR   8,GR4                    NO, EXIT                YL02192 51022202
         L     GR8,CCOPYPTR             PICKUP COPY BLK ADDR    YL02129 51022302
         B     WRTOP                    WRITE OPER AGAIN        YL02129 51022502
MSGWRTA  LA    GR1,MESS30              MESSAGE 830.                     51023202
         BAL   GR9,BUILD               GO TO SET UP MSG.                51023402
         MVC   0(8,GR1),0(GR3)         DDNAME TO MESSAGE.               51023602
         BAL   GR9,MSGWRT1             GO TO PRINT MSG.                 51023802
         BR    GR4                     RETURN TO CALLER.                51024002
         USING UCB,GR3                                          YL02912 51024202
WRTWTOR  EQU   *                                                YL02912 51024402
         MVC   RESTMSG+NAMEOFF,UCBNAME GET UCB NAME             YL02912 51024602
RESTMSG  WTOR      'IEH856D  RESTORE HAS FAILED FOR CUU, DEVICE SHOULD *51026602
               BE VARIED OFFLINE.',                                    *51030402
               REPLY,1,DSKECB,ROUTCDE=(4),DESC=(2)             YL02912  51031302
         WAIT  1,ECB=DSKECB        WAIT FOR REPLY              @ZA16473 51031837
         XC    DSKECB,DSKECB       CLEAR ECB                   @ZA16473 51032337
         BR    GR9                      RETURN                  YL02192 51032802
         DROP  GR3                                                      51034302
         DROP  GR8                                                      51035802
         SPACE                                                          51037302
         EJECT                                                          51050802
         SPACE 1                                                        51052302
BUILD    LINK  EP=IEHDMSGB                                              51053802
         BR    GR9                     RETURN.                          51055302
         SPACE 2                                                        51056802
MSGWRT1  EQU   *                                                        51058302
         LINK  EP=IEHDPRNT              WRITE OUT THE MESSAGE    M0543  51059802
         BR    GR9 RETURN               RETURN                   M0543  51061302
         SPACE                                                          51062802
VOLCHK   EQU   *                                                 M0543  51064302
         CLI   VOLNUMB,ONE             MORE THAN 1 VOLUME      @ZA01235 51064702
*                                      SPECIFIED IN JCL        @ZA01235 51065102
         BH    EOV1                    YES,PROCESS NXT TAPE    @ZA01235 51065502
         L     GR3,16                   GET CVT POINTER          M0543  51065802
         L     GR3,0(GR3)               GET TCB POINTER          M0543  51067321
         L     GR3,4(GR3)               GET CURRENT TCB          M0543  51069321
         L     GR3,12(GR3)              GET TIOT POINTER         M0543  51071321
         MVC   MESS48+JNOFFS(8),0(GR3)  PUT JOB NAME IN MESSAGE  OX1801 51073302
         MVC   MESS48+SNOFFS(8),8(GR3)  PUT STEP NAME IN MESSAGE OX1801 51073702
         L     GR8,FUCBPTR             LOAD FROM UCB ADR       @ZA01202 51073802
         MVC   MESS48+UNOFFS(3),13(GR8) PUT UNIT NAME IN MSG   @ZA01202 51073902
MESS48   WTOR  'IEH848D  IS ANOTHER TAPE REQUIRED FOR THIS RESTORE JOB?*51074121
               REPLY Y OR N.    JJJJJJJJ,SSSSSSSS,UUU',ANSW,1,         *51074502
               TAPECB,ROUTCDE=(3),DESC=(2)                     @ZA01202 51074902
         TM    TAPECB,COMPLETE         ANSWER TO MSG.            A21395 51075121
         BO    ANSWCHK                 YES-CHECK ANSWER.         A21395 51092421
         WAIT  ECB=TAPECB              NO-WAIT FOR REPLY.        A21395 51109721
ANSWCHK  EQU   *                                                 A21395 51127021
         MVI   TAPECB,OFF              CLEAR ECB STATUS BYTE.    A21395 51144321
         CLI   ANSW,YES                ANOTHER TAPE.             A21395 51161621
         BNE   CHECKNO                  NO, CHECK OTHER RESPONSE XM6320 51171600
         LA    GR1,MESS50               NO, SETUP ERROR MSG      XM6320 51195602
         BAL   GR9,BUILD                GET PROPER MSG           XM6320 51196000
         MVC   0(8,GR1),DDNAME1         MOVE DDNAME TO MSG       XM6320 51196100
         B     MSGWRT                   GO WRITE MSG             XM6320 51201900
CHECKNO  EQU   *                                                 XM6320 51203900
         CLI   ANSW,NO                 ONLY ONE TAPE.            A21395 51207700
         BNE   VOLCHK                  REWIRTE MSG.              A21395 51213521
         LA    GR1,MESS49              YES-ERROR.                A21395 51230802
         BAL   GR9,BUILD               GET PROPER MSG.           A21395 51248121
MSGWRT   EQU   *                       ALL ERRORS EXIT HERE.            51258102
         BAL   GR9,MSGWRT1             GO WRITE OUT THE MESSAGE.        51268102
FINAL4   LA    GR15,8                  SET UP THE RETURN CODE           51278102
         ST    GR15,RETCODE            SAVE THE RETURN CODE             51280102
*   EXIT TO MONITOR HERE.                                               51282102
FINALR2  L     GR3,PTRCFUNC            SLOT FOR THIS CURRENT FUNCTION.  51282502
         MVI   0(GR3),COMPLETE         INDICATE IT IS COMPLETE.         51282602
         TM    FLGBYT2,CPYREJEC        RACF REJECTED CPYVOLID  @G32DSPD 51283532
         BNO   FINAL3                  NO,KEEP R-CODE          @G32DSPD 51284432
         CLM   GR15,B'0001',RC4        R-CODE ALREADY G.E. 4   @G32DSPD 51285332
         BNL   FINAL3                  YES,DONT CHANGE         @G32DSPD 51286232
         LA    GR15,4                  USE R-CODE 4            @G32DSPD 51287132
FINAL3   L     GR13,RESTSAVE+4         RESTORE REGISTER 13.             51288402
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN W/PROPER CODE.    51298402
         EJECT                                                          51300002
*********************************************************************** 51350002
*                                                                     * 51350402
*    DEFINED CONSTANTS.                                               * 51350502
*                                                                     * 51350602
*********************************************************************** 51350702
         SPACE                                                          51367102
F1       DC    F'1'                    USED TO INCREMENT TRACK ADDRESS. 51400016
ZERO     DC    F'0'                                                     51500016
REPLY    DC    F'0'                     ECB FOR WTOR FOR IEH856 YL02912 51510002
DSKECB   DC    F'0'                     ECB FOR WTOR FOR IEH856 YL02912 51520002
FUNCTION DC    C'RESTORE TO'           MESSAGE FILL IN.                 51550016
REELMASK DC    X'FFFFFFFE'             USED TO CHECK FOR LAST REEL TAPE 51600016
TOBIG    EQU   REELMASK                MAX CCW BYTE CNT         YM2241  51650002
EIGHT    DC    H'8'                                                     51700016
UNUSRET  DC    F'4'                    RETURN CODE OF 4.                51860002
BUFFADDR DC    X'3E18'                 STAND ALONE D/R BUFFER ADDRESS.  51870002
PROCHDR  EQU   X'04'                   INDIC IEHDASDR HEADER   OX2864   51880403
*                                       RECORDS ARE BEING PROC. OX2864  51880803
NLBLP    EQU   X'11'                    INDIC NL OR BLP LABELS  OX2864  51881203
JNOFFS   EQU   88                      IEH848D JOBNAME OFFSET    OX1801 51882002
SNOFFS   EQU   97                      IEH848D STEPNAME OFFSET   OX1801 51884002
YES      EQU   X'E8'                   POSITIVE REPLY.           A21395 51885020
UNOFFS   EQU   106                     DISP FOR UNIT NAME      @ZA01202 51887002
NO       EQU   X'D5'                   NEGATIVE REPLY.           A21395 51890020
ONE      EQU   1                                                 XM6320 51899001
GOOD     EQU   X'7F'                   NO ERRORS ON I/O.                51900016
SACODE5  DC    X'63C24D'               CODE THAT IDENTIFIES RESTORE TP. 51990037
ON       EQU   X'FF'                   SWITCH ON.                       52000016
OFF      EQU   X'00'                   SWITCH OFF.                      52100016
BLANK    EQU   C' '                    BLANK CHARACTER.                 52200016
NRF      EQU   X'08'                   NO RECORD FOUND INDICATOR.       52260016
EOF1     EQU   X'01'                   END-OF-FILE INDICATOR.           52320016
HEX1     EQU   X'01'                                            OX03063 52322002
SEARCH   EQU   X'31'                   SEARCH CCW COMMAND CODE          52328002
SWOFF    EQU   X'BF'                   SET RPS SWITCH OFF               52332002
D1       EQU   1                       DISP OF 1                        52336002
EQ       EQU   8                       EQUAL CONDITION.                 52338002
L8       EQU   8                       LENGTH OF 8                      52340002
K6       EQU   6                       DISPLACEMENT CONSTANT.    S20201 52344020
K16      EQU   *                       DISPLACEMENT CONSTANT.    S20201 52348020
K28      EQU   *                       DISPLACEMENT CONSTANT.    S20201 52352020
RPSFEAT  EQU   X'40'                   RPS FEATURE SWITCH               52356002
D16      EQU   16                       DISPL IN TRK-IMAGE REC  SA53319 52356401
X07      EQU   X'07'                    TRK-IMAGE SEEK CMD      SA53319 52356801
T32      EQU   32                       OFFSET INTO DEB TO UCB  SA57293 52358001
ZEUS1    EQU   6                        2305-1 UCB DEV TYPE     SA57293 52358401
ZEUS2    EQU   7                        2305-2 UCB DEV TYPE     SA57293 52358801
L4       EQU   4                                                 A30548 52360019
VOL1L    EQU   96                       VOL1 RECORD LENGTH      YL02912 52370002
RDHA     EQU   X'1A'                    READ HOME-ADDRESS CMD   YL02912 52380002
CCSILI   EQU   X'60'                    CCW CMD-CHNG AND SILI   YL02912 52390002
SILI     EQU   X'20'                    CCW SILI BIT MASK       YL02912 52400002
ALTRK    EQU   X'01'                    HOME ADDR FLAG FOR AN   YL02912 52402002
*                                       ALTERNATE TRACK.        YL02912 52404002
NAMEOFF  EQU   48                       IEH856 UCBNAME OFFSET   YL02912 52405037
VTCDISP  EQU   11                                                       52406437
TWO      EQU   2                                                        52406537
L5       EQU   5                                                        52406837
L6       EQU   6                                                        52406937
N0       EQU   0                                                        52407037
N4       EQU   4                                                        52407137
N5       EQU   5                                                        52407237
UNITTYP  EQU   19                       UNITTYPE OFFSET IN UCB @ZA04433 52408037
NRFOPE   EQU   X'09'                   NRF/OPER INCOMPL IND    @ZA07406 52410037
DWORDFF  DC    X'FFFFFFFF'                                              52413637
IOTAB    DC    C'0123456789ABCDEF'                                      52416237
L9       EQU   9                                                        52418837
FULL     EQU   X'F0'                                                    52421437
ALTER    EQU   82                                                       52437037
MSGCON   DC    C'82,'                                                   52439637
RC8      DC    X'08'                     TEST RACF RETURN CODE @G32DSPD 52440632
RC4      DC    AL1(4)                    TEST RACF RETURN CODE @G32DSPD 52441432
COMMA    EQU   C','                                                     52442237
PERIOD   EQU   C'.'                                                     52444837
         EJECT                                                          52447437
*********************************************************************** 52450002
*                                                                     * 52460002
*   TABLE OF UCB DEVICE TYPE CODES.                                   * 52470002
*                                                                     * 52480002
*********************************************************************** 52490002
         SPACE                                                          52492002
CODES    DC    X'05'                   2321 UCB DEVICE TYPE CODE.       52500016
         DC    X'01'                   2311                             52600016
         DC    X'08'                   2314                             52700016
         DC    X'04'                   2302                             52800016
         DC    X'03'                   2303                             52900016
         DC    X'02'                   2301                             53000016
         DC    X'06'                   2305-1                           53020002
         DC    X'07'                   2305-2                           53040002
         DC    X'00'                   NOT USED                         53060002
         DC    X'09'                   3330                             53080002
         DC    X'0A'                   3340                             53090002
         DC    X'0B'                   MADRID(3350)            MADRID   53092037
         DC    X'0C'                   UNUSED DEVICE TYPE               53094002
         DC    X'0D'                   3330-1                           53096002
D0       EQU   0                        ZERO DISPL.             XL03145 53096403
ICEBERG  EQU   X'0D'                    UCB DEVICE TYPE         XL03145 53096803
MERLN    EQU   X'09'                    MERLIN DEVICE TYPE      XL03145 53097203
DOSCON   EQU   X'80'                    FORMAT 4 DOS CONTAM BIT XL03145 53098003
D14      EQU   14                       FORMAT 4 DSCB OFFSET    XL03145 53098403
D22      EQU   22                       DISPL TO WINCHESTER     XL03145 53098803
*                                       MODEL NO.               XL03145 53099203
WINCH    EQU   X'0A'                    3340 DEVICE TYPE.       XL03145 53099302
L2       EQU   2                                                XL03145 53099603
D18      EQU   18                       F4 DSCB CYL OFFSET      XL03145 53099703
SACODE4  DC    X'63B24D'               CODE THAT IDENTIFIES RESTORE TP. 53100016
         EJECT                                                          53102002
*********************************************************************** 53104002
*                                                                     * 53106002
*        VOLID RETAIN CCW'S                                           * 53112002
*                                                                     * 53118002
*********************************************************************** 53120002
         SPACE                                                          53122002
SRCHKEYR CCW   X'31',SRKEY,X'60',5      SEARCH ID EQ             M2888  53124020
         CCW   8,SRCHKEYR,0,0                                    M0640  53130020
RDVOLSER CCW   X'00',0,X'20',92         READ/WRITE VOL SER       M6350  53140020
TAPEREAD CCW   2,0,X'20',24            USED TO READ IN CONTROL RECORD.  53220016
BACKTAPE CCW   X'27',0,X'30',1         BACKSPACE 1 TAPE RECORD   A46379 53222021
TAPECHK  CCW   X'02',0,X'30',1         FWD SPACE 1 TAPE RECORD  VS08412 53224002
         SPACE                                                          53230020
SETCCW   CCW   X'23',F1,X'40',1         SET SECTOR ZERO                 53242002
SECTIC   CCW   8,0,0,0                                           S20201 53250020
         SPACE                                                          53260020
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      53300016
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              53400016
RDVDATA  CCW   6,0,X'20',96            READ FORMAT 4 DATA.              53500016
RHA      CCW   X'1A',0,X'20',5          READ HA OF VOL1 TRK     YL02912 53510002
READR0   CCW   X'16',0,X'30',16        READ-BACK CHECK R0 ON            53530016
*                                        OVERFLOW TRACKS.               53560016
         SPACE                                                          53580402
*********************************************************************** 53582002
*                                                                     * 53584002
*   DEFINED STORAGE.                                                  * 53586002
*                                                                     * 53588002
*********************************************************************** 53588402
         SPACE                                                          53588802
TAPECB   DC    F'0'                    WAIT OR COMPLETION BITS.  A21395 53590002
RESTSAVE DS    18F                     SAVE AREA FOR CALLED ROUTINES.   53600016
ADDRBUFF DC    F'0'                                                     53900016
CCHHADDR DS    1F                      IPL TRACK ADDRESS.               53950016
RETCODE  DC    F'0'                    RETURN CODE SAVE AREA.           53952002
ANSW     DS    CL1                     OPERATOR REPLY AREA.      A21395 53960002
SRKEY    DC    X'0000000003'           SEARCH ARGUMENT                  54000002
REPLYECB DS    1F                                                       54010032
RACVOL   DS    CL6                     VOLID FOR RACHECK       @G32DSPD 55010032
         TITLE 'IEHDREST - MAINT. AREA '                                56130037
         SPACE 2                                                        56230037
*********************************************************************** 56330037
*           MAINTENANCE AREA - PATCH SPACE                            * 56430037
*                                                                     * 56530037
MAINT    DC    10CL10'PATCH'     EBCDIC FOR EYEBALLING DUMP             56630037
*                                                                     * 56730037
*********************************************************************** 56830037
         SPACE 3                                                        56930037
*********************************************************************** 57030037
         SPACE  4                                                       57130037
*******************  END OF MODULE  *********************************** 57230037
         TITLE 'IEHDREST - RESTORE FUNCTION'                            57330037
         EJECT                                                          58200016
IOBLOCKS DSECT                                                          61702016
*   RESTORE DA WRITE-OUT ECB.                                           61704016
DISKECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   61706016
         SPACE 1                                                        61708016
*   RESTORE DA WRITE-OUT IOB.                                           61710016
DISKIOB  DS    0F                                                       61712016
DISKFLG  DS    CL2                     FLAGS 1 AND 2.                   61714016
DSENSE   DS    CL2                     SENSE BYTES.                     61716016
DECBAD   DS    1F                      ECB ADDRESS.                     61718016
DSTATUS  DS    2F                      CHANNEL STATUS.                  61720016
DCCWAD   DS    1F                      CCW LIST ADDRESS.                61722016
DDCBAD   DS    1F                      DCB ADDRESS.                     61724016
DRESAD   DS    1F                      RESTART ADDRESS.                 61726016
DBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           61728016
DERROR1  DS    CL2                     ERROR COUNT                      61730016
DSEEK    DS    2F                      MBBCCHHR.                        61732016
BB       EQU   DSEEK+1                 BIN ADDRESS.                     61733016
CCHH     EQU   DSEEK+3                 CYLINDER-HEAD ADDRESS.           61734016
R        EQU   DSEEK+7                 RECORD NUMBER.                   61736016
         SPACE 1                                                        61738016
*   RESTORE DA WRITE-OUT DCB.                                           61740016
DISKDCB  DS    18F                                                      61742016
         SPACE 2                                                        61744016
*   RESTORE TAPE READ-IN ECB.                                           61746016
TAPEECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   61748016
         SPACE 1                                                        61750016
*   RESTORE TAPE READ-IN IOB.                                           61752016
TAPEIOB  DS    0F                                                       61754016
TAPEFLG  DS    CL2                     FLAGS 1 AND 2.                   61756016
TSENSE   DS    CL2                     SENSE BYTES.                     61758016
TECBAD   DS    1F                      ECB ADDRESS                      61760016
TSTATUS  DS    2F                      CHANNEL STATUS.                  61762016
TCCWAD   DS    1F                      CCW LIST ADDRESS.                61764016
TDCBAD   DS    1F                      DCB ADDRESS.                     61766016
TRESAD   DS    1F                      RESTART ADDRESS.                 61768016
TBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           61770016
TERROR   DS    CL2                     ERROR COUNT                      61772016
         SPACE 1                                                        61774016
*   RESTORE TAPE READ-IN DCB NUMBER ONE.                                61776016
TAPEDCB  DS    13F                                                      61778016
         SPACE 1                                                        61780016
*   CCWS TO READ-IN RESTORE TAPE.                                       61782016
         DS    0D                      ALIGNMENT.                       61784016
TAPECCW1 DS    CL8                     USED TO READ CCW RECORD.         61786016
TAPEDAT1 DS    CL8                     USED TO READ DATA RECORD.        61788016
TAPECCW2 DS    CL8                     USED TO READ CCW RECORD.         61790016
TAPEDAT2 DS    CL8                     USED TO READ DATA RECORD.        61792016
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           61794016
         SPACE 1                                                        61800016
         IEHDBLKS                                                       62400016
         EJECT                                                          63000016
         IEHDWORK                                                       63600016
         SPACE                                                          63900016
VLABEL   DSECT                                                          64310016
VOLUME   DS    CL3                     LABEL IDENTIFIER.                64320016
VOLNO    DS    CL1                     LABEL NUMBER.                    64330016
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.             64340016
SECURITY DS    CL1                     VOLUME SECURITY.                 64350016
VTOCPTR  DS    CL10                    POINTER TO VTOC                  64360016
         DS    CL20                    RESERVED.                        64370016
OWNER    DS    CL10                    OWNER IDENTIFICATION.            64380016
         DS    CL29                    BLANK.                           64390016
         SPACE                                                          66390016
RBUFFER  DSECT                                                          68900016
ZERO1    DS    CL8                     WILL CONTAIN 8 BYTES OF ZEROS.   69000016
CCWBUFF  EQU   ZERO1                                                    69100016
L1       EQU   1                       LENGTH ATTRIBUTE                 69150002
TICSW    DS    CL1                     'FF' INDICATES PREVIOUS CCW=TIC. 69200016
         DS    CL3                     NOT USED.                        69300016
ADDRESS  DS    CL4                     TEMPORARY ADDRESS HOLDER.        69400016
SEEKCCW  DS    CL8                     SEEK CCW FOR STAND-ALONE.        69500016
SETMASK  DS    CL8                     SET FILE MASK FOR STAND-ALONE.   69600016
SEARIDE  DS    CL8                     SEARCH EQUAL ID CCW.             69700016
         EJECT                                                          69900016
         ICHPRCVT                                              @ZA25515 69930099
         EJECT                                                          69960099
CVT      DSECT                                                          70000016
         CVT                                                            70100032
         EJECT                                                          70200016
UCB      DSECT                                                          70300016
         IEFUCBOB                                                       70400016
         EJECT                                                          70500016
JFCB     DSECT                                                          70600016
         IEFJFCBN                                                       70700016
         EJECT                                                          70800016
         DCBD  DSORG=PS                                                 70900016
         END                                                            71000016
./  ADD  SSI=70880149,NAME=IEHDRVID
         COPY  LCGASMSW                                                 00050000
*                                                               XM05523 00100000
         TITLE 'IEHDRVID --- RESTORE VOLID FOR RESTORE'                 00150000
*                                                                       00200000
*                                                                       00250000
IEHDRVID CSECT                                                          00300000
*                                                                     * 00350000
*FUNCTION/OPERATION- THIS CSECT WAS CREATED BY SPLITTING THE RESTORE  * 00400000
*   FUNCTION OF THE IEHDASDR UTILITY PROGRAM. THE FUNCTION OF THIS    * 00450000
*   CSECT IS TO READ THE VOLUME LABEL OF THE DIRECT ACCESS DEVICE.    * 00500000
*   IF THE OLD SERIAL NUMBER IS TO BE RETAINED AND IT IS DIFFERENT    * 00550000
*   FROM THE NEW SERIAL NUMBER, THEN THE VOLUME LABEL IS REWRITTEN    * 00600000
*   WITH THE OLD SERIAL NUMBER. THIS ROUTINE ALSO UPDATES THE         * 00650000
*   ALTERNATE TRACK INFORMATION FIELDS IN THE FORMAT 4 DSCB. THE      * 00700003
*   ACTUAL SERIAL NUMBER OF THE VOLUME BEING RESTORED IS ALSO SET UP  * 00760003
*   IN TH ECOMPLETION MESSAGE FOR SUBSEQUENT PRINTING.                * 00820003
*                                                                     * 00900000
*INPUT-  POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL         * 00950000
*   BLOCK(REGISTER 10).REGISTER 7 WILL POINT TO THE DDNAME UPON       * 01000000
*   ENTRY AND REGISTER 8 WILL POINT TO THE UCB FOR THE DASD DEVICE.   * 01050000
*                                                                       01100000
*EXITS-NORMAL- A SUCCESSFUL COMPLETION ENDS IN A RETURN TO THE        * 01150000
*   MODULE -IEHDREST- WITH A RETURN CODE OF 0.                        * 01200000
*                                                                     * 01250000
*EXITS-ERROR-  ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROP-       * 01300000
*   IATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER       * 01350000
*   THAN ZERO WILL ALSO BE PASSED BACK TO MODULE -IEHDREST-.          * 01400000
*                                                                     * 01450000
*EXTERNAL ROUTINES-  THIS ROUTINE ONLY ENTERED FROM THE RESTORE       * 01500000
*   ROUTINE (IEHDREST). ALL MESSAGES ARE BUILT BY -IEHDMSGB-          * 01550000
*   AND WRITTEN OUT BY -IEHDPRNT-. ALL DEVICE CONSTANTS REFERENCED    * 01600000
*   ARE IN -IEHDCONS-.                                                * 01650000
*                                                                     * 01700000
*TABLES/WORK AREAS-  UPON ENTRY, REGISTERS 10 AND 12 POINT TO A       * 01750000
*   FUNCTION BLOCK AND WORK AREA RESPECTIVELY. THEY ARE DESCRIBED     * 01800000
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 01850000
*                                                                     * 01900000
*ATTRIBUTES- SERIALLY REUSABLE,RELOCATABLE                            * 01950000
*                                                                     * 02000000
*********************************************************************** 02050000
         EJECT                                                          02100000
*********************************************************************** 02150000
*                                                                     * 02200000
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                           * 02250000
*                                                                     * 02300000
*********************************************************************** 02350000
         SPACE                                                          02400000
GR0      EQU   0                                                        02450000
GR1      EQU   1                                                        02500000
GR2      EQU   2                                                        02550000
GR3      EQU   3                                                        02600000
GR4      EQU   4                                                        02650000
GR5      EQU   5                                                        02700000
GR6      EQU   6                                                        02750000
GR7      EQU   7                                                        02800000
GR8      EQU   8                                                        02850000
GR9      EQU   9                                                        02900000
GR10     EQU   10                                                       02950000
GR11     EQU   11                                                       03000000
GR12     EQU   12                                                       03050000
GR13     EQU   13                                                       03100000
GR14     EQU   14                                                       03150000
GR15     EQU   15                                                       03200000
RCVT     EQU   9                                                        03250000
UCBPTR   EQU   9                                                        03300000
BASEREG  EQU   11                                                       03350000
WORKBASE EQU   12                                                       03400000
K0       EQU   0                       DISPLACEMENT CONSTANT.    A21395 03650000
         SPACE 3                                                        03700000
*********************************************************************** 03750000
*                                                                     * 03800000
*   MESSAGE REFERENCES.                                               * 03850000
*                                                                     * 03900000
*********************************************************************** 03950000
         SPACE                                                          04000000
MESS6    EQU   6                       MESSAGE IEH806                   04050000
MESS28   EQU   28                      MESSAGE IEH828                   04250000
         EJECT                                                          04450000
         SPACE 2                                                        04500000
         USING FUNCBLK,10                                               04550000
         USING IEHRVID,BASEREG                                          04600000
         USING WORK,12                                                  04650000
         SPACE 1                                                        04750000
IEHRVID  SAVE  (14,12),T,*             SAVE THE REGISTERS.              04800000
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          04850000
         LA    GR3,RVIDSAVE            SAVE AREA ADDRESS.               04900000
         ST    GR3,8(GR13)             ADDRESS OF NEW AREA TO OLD.      04950000
         ST    GR13,4(GR3)             ADDRESS OF OLD AREA TO NEW.      05000000
         LR    GR13,GR3                LOAD SAVE AREA ADDRESS.          05050000
         MVI   RETCODE,X'00'           INITIALIZE RETURN CODE           05200003
         MVC   RETCODE+1(3),RETCODE    SET RETCODE TO ZERO              05500003
*********************************************************************** 05850000
*        REGISTER 8 MUST POINT TO THE UCB FOR THE DA DEVICE.          * 05900000
*        REGISTER 9 MUST POINT TO THE DIRECT ACCESS CONTROL BLOCKS    * 05950000
*        REGISTER 7 MUST POINT TO THE DDNAME UPON ENTRY.              * 06000000
*          UPON ENTRY.                                                * 06050000
*        REGISTER 6 IS A WORK REGISTER.                               * 06100000
*        REGISTER 3 IS A WORK REGISTER.                               * 06150000
*        REGISTER 2 MUST POINT TO THE ALTERNATE TRACK INFORMATION.    * 06200000
*        REGISTER 5 IS THE RETURN REGISTER.                           * 06250000
*                                                                     * 06300000
*********************************************************************** 06350000
         SPACE                                                          06400000
         USING UCB,GR8                                                  06450000
         USING IOBLOCKS,9                                               06500000
RDVOLID  EQU   *                                                        06550000
         XC    CCHH(5),CCHH            CLEAR CCHHR.                     06600000
         LA    GR3,CCHH                SEARCH ADDRESS.                  06650000
         ST    GR3,READVTOC            PLACE IN SEARCH CCW.             06700000
         TM    SEQSW+D1,RPSFEAT        TODD                             06750000
         BZ    RDVOLIDA                NO                               06800000
         LA    GR4,SETCCW              YES-SETUP ADDR OF SET            06850000
*                                       SECTOR CCW FOR IOB              06900000
RDVOLIDA EQU   *                                                 S20201 06950000
         MVI   READVTOC,X'31'          SET OP CODE.                     07000000
         LA    GR4,READVTOC            CCWS ADDRESS.                    07050000
         ST    GR4,DCCWAD              CCW ADDRESS TO IOB.              07100000
         L     GR3,BUFFPTR1            READ IN AREA.                    07150000
         ST    GR3,RDVDATA             STORE IN CCW.                    07200000
         MVI   RDVDATA,6               SET FOR READ OP CODE.            07250000
         MVI   R,3                     SET SEARCH FOR RECORD 3.         07300000
         LA    GR3,VOL1L(GR3)           INCRE FOR RD-HA         YL02912 07350000
         ST    GR3,RHA                  STORE ADDR IN CCW       YL02912 07400000
         L     GR3,BUFFPTR1             RELOAD BUFFER PTR       YL02912 07450000
         MVI   RHA,RDHA                 RESET RDHA CMD          YL02912 07500000
         MVI   RDVDATA+L4,CCSILI        SET CMD-CHNG AND SILI   YL02912 07550000
*                                       BITS ON RD-DATA CCW     YL02912 07600000
         EXCP  DISKIOB                 READ IN THE LABEL                07650000
         MVI   RDVDATA+L4,SILI          RESET CCW SILI BIT      YL02912 07700000
         BAL   GR4,WAITD               AWAIT COMPLETION OFI/O.          07750000
         L     GR14,IODEVCON           GET CONSTANTS                    07800000
         USING CONSTANT,GR14                                     M5861  07850000
         USING VLABEL,GR3                                       YL02912 07900000
         L     GR3,BUFFPTR1             RELOAD BUFFER PTR               07950003
         CLC   VOL1L+1(L4,GR3),LASTORIG IN THE ALT AREA?       @ZA04433 08070003
         BH    TRACK0                  YES, PUT OUT IEH828I    @ZA04433 08080003
         DROP  14                                                M5861  08100000
TRACK0R  EQU   *                                                        08150000
         TM    SEQSW,CPYVOLID          MUST WE RETAIN THE OLD SERIAL.   08200000
         BNO   UPDATE4                  NO, UPDATE FORMAT 4 DSCB M2888  08250000
UPDSERNO EQU   *                       UPDATE VOLSER           @Z40RSRB 09150000
         MVC   SERIAL(6),IDSAVE         GET SERIAL               M6350  09200000
         MVI   RDVDATA,5               SET CCW OP CODE TO WRITE.        09250000
         EXCP  DISKIOB                 REWRITE THE LABEL.               09300000
         BAL   GR4,WAITD               AWAIT COMPLETION OFI/O.          09350000
UPDATE4  MVC   CCHH(5),VTOCPTR         SET NEW VTOC IN IOB      M2888   09400000
         MVC   150(6,GR3),SERIAL       SAVE SERIAL FOR LATER    M6350   09450000
         LA    GR6,150(GR3)            ADDRESS OF SERIAL        M6350   09500000
         CLC   CCHH(4),CCHHBEG         VTOC ADDRESS GREATER THAN 1ST    09550000
         BL    WRTMSG                    TRACK OF THIS RESTORE//NO.     09600000
         CLC   CCHH(4),CCHHEND         VTOC ADDRESS LESS THAN UPPER     09650000
         BNL   WRTMSG                    LIMIT//NO-GO GIVE FINAL MSG.   09700000
         MVI   RDVDATA,6               SET CCW CODE TO READ.            09750000
         EXCP  DISKIOB                 READ IN FORMAT 4 DSCB.           09800000
         BAL   GR4,WAITD               AWAIT COMPLETION OF I/O.         09850000
         MVC   8(6,GR3),0(GR2)         MOVE IN THE SAVED ALTERNATE      10000000
*                                        TRACK INFORMATION.             10050000
         EJECT                                                          10100000
*********************************************************************** 10150000
*                                                                     * 10200000
* THIS SECTION REPAIRS FAULTY 2314 DIRECTORY BLOCKS                   * 10250000
*                                                                     * 10300000
*********************************************************************** 10350000
SKPALTR  EQU   *                                                        10400003
         SPACE                                                          10450000
         CLI   IODEVCON,X'08'          IS THIS A 2314                   10500000
         BNE   GOODBLKS                NO, GO AROUND                    10550000
         MVI   31(GR3),X'11'           SET DIRECTORY BLOCKS TO 17       10600000
GOODBLKS EQU   *                                                        10650000
         L     GR4,IODEVCON             TODD DEVICE CONSTANTS   XL03145 10700000
         USING CONSTANT,GR4                                             10750000
         MVC   D18(L2,GR3),CYLNO        MOVE CYL NO. TO F4 DSCB XL03145 10800000
         DROP  4                                                XL03145 10850000
*                                                                    *  10900000
         TM    FIRSTSW,DOSBIT           IS THE DOS-BIT ON       XL03145 10950000
         BNO   NODOS                    NO, DONT SET DOS BIT    XL03145 11000000
         OI    D14(GR3),DOSCON          SET DOS CONTAMINATION   XL03145 11050000
*                                       BIT IN FORMAT 4         XL03145 11100000
NODOS    EQU   *                                                XL03145 11150000
         MVI   RDVDATA,5               SET CCW OP CODE FOR WRITE.       11200000
         EXCP  DISKIOB                 REWRITE FORMAT 4 DSCB.           11250000
         BAL   GR4,WAITD               AWAIT COMPLETION OFI/O.          11300000
WRTMSG   EQU   *                                                        11350000
         LA    GR1,MESS6               MESSAGE 806.                     11400000
         LR    GR4,GR9                 IOBLOCKS ADDRESS.                11450000
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         11500000
         MVC   0(8,GR1),0(GR7)         DDNAME TO MESSAGE.               11550000
         MVC   MESS+9(10),FUNCTION     FUNCTION TYPE TO MESSAGE.        11600000
         MVC   MESS+67(6),0(GR6)       VOLUME SERIAL TO MESSAGE.        11650000
         BAL   GR9,MSGWRT1             GO WRITE OUT THE MESSAGE.        11700000
         LR    GR9,GR4                 RESTORE IOBLOCKS ADDRESS.        11750000
         EJECT                                                          11800000
*********************************************************************** 11850000
*                                                                     * 11900000
*   POST THE UCB HERE.                                                * 11950000
*                                                                     * 12000000
*********************************************************************** 12050000
         SPACE                                                          12100000
         LA    GR1,DSEEK               VTOC POINTER.                    12150000
         ST    GR1,POSTLIST+8          STORE IN PARAMETER LIST.         12200000
         ST    GR8,POSTLIST            UCB ADDRESS TO PARM LIST.        12250000
         ST    GR6,POSTLIST+4          SERIAL ADDRESS TO PARM LIST.     12300000
         MVI   POSTLIST,X'08'          'POST' CODE FOR SVC.             12350000
         MVI   POSTLIST+8,X'80'        LAST ENTRY BIT.                  12400000
         CNOP  0,4                                                      12450000
         BAL   GR1,POST                SET PARAMETER POINTER.           12500000
POSTLIST DC    F'0'                    POST CODE//UCB ADDRESS.          12550000
         DC    F'0'                    SERIAL NO. ADDRESS.              12600000
         DC    F'0'                    POINTER TO VTOC ADDRESS.         12650000
POST     SVC   POSTSER                 GO UPDATE UCBS.                  12700000
POSTSER  EQU   82                      SVC CODE FOR POSTING UCBS.       12750000
         L     GR15,RETCODE            SET RETURN CODE IN GR15 @Z40UAY1 12800000
         B     FINAL3                  RETURN TO CALLING RTN   @Z40UAY1 12801000
         DROP  3,8                                                      12803000
         EJECT                                                          12806000
WAITD    TM    DISKECB,COMPLETE        IS THE OPERATION COMPLETE.       12809000
         BO    TESTD                   YES-GO TEST THE STATUS.          12812000
         WAIT  ECB=DISKECB             AWAIT COMPLETION OF DISK.        12815000
TESTD    EQU   *                                                        12818003
         CLI   DISKECB,GOOD            ALL OK ?                         12828003
         BCR   8,GR4                   YES-RETURN.                      12838003
         LA    GR15,8                  NO, SET RET. CODE TO 8           12848003
         B     FINAL3                  RETURN TO CALLING RTN            12858003
         EJECT                                                          12900000
TRACK0   LA    GR1,MESS28              MESSAGE 828.                     12950000
         LR    GR4,GR9                 SAVE I/O BLOCKS ADDRESSING.      13000000
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         13050000
         MVC   0(8,GR1),0(GR7)         DDNAME TO MESSAGE.               13100000
         BAL   GR9,MSGWRT1             WRITE OUT THE MESSAGE.           13150000
         LR    GR9,GR4                 I/O BLOCKS ADDRESSING.           13200000
         MVC   RETCODE(L4),UNUSRET     SET RETURN CODE=4                13250000
         B     TRACK0R                                                  13300000
         EJECT                                                          13350000
         SPACE 1                                                        13400000
BUILD    LINK  EP=IEHDMSGB                                              13450000
         BR    GR9                     RETURN.                          13500000
         SPACE 2                                                        13550000
MSGWRT1  EQU   *                                                        13600000
         LINK  EP=IEHDPRNT              WRITE OUT THE MESSAGE    M0543  13650000
         BR    GR9 RETURN               RETURN                   M0543  13700000
         SPACE                                                          13750000
FINAL3   L     GR13,RVIDSAVE+4         RESTORE REGISTER 13.             13800000
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN W/PROPER CODE.    13850000
         EJECT                                                          13900000
*********************************************************************** 13950000
*                                                                     * 14000000
*    DEFINED CONSTANTS.                                               * 14050000
*                                                                     * 14100000
*********************************************************************** 14150000
         SPACE                                                          14200000
F1       DC    F'1'                    INCREMENT TRACK ADDR             14220000
FUNCTION DC    C'RESTORE TO'           MESSAGE FILL IN.                 14450000
REELMASK DC    X'FFFFFFFE'             USED TO CHECK FOR LAST REEL TAPE 14500000
TOBIG    EQU   REELMASK                MAX CCW BYTE CNT         YM2241  14550000
UNUSRET  DC    F'4'                    RETURN CODE OF 4.                14650000
GOOD     EQU   X'7F'                   NO ERRORS ON I/O.                15200000
D5       EQU   5                                                        16500003
L3       EQU   3                       LENGTH CONSTANT.                 16580003
SACODE5  DC    X'63C24D'               CODE THAT IDENTIFIES RESTORE TP. 16660003
ALTRK    EQU   X'01'                    HOME ADDR FLAG FOR AN   YL02912 16740003
DOSCON   EQU   X'80'                    FMT4 DOS CONTAM BIT             16820003
EOF1     EQU   X'01'                    END OF FILE INDICATOR           16900003
NRF      EQU   X'08'                    NO RECORD FOUND                 16980003
D14      EQU   14                       FMT4 DSCB OFFSET                17060003
L2       EQU   2                        DISPLACEMENT 2                  17140003
D1       EQU   1                        DISPLACEMENT 1                  17220003
D18      EQU   18                       DISPLACEMENT 18                 17300003
RPSFEAT  EQU   X'40'                    RPS FEATURE                     17380003
VOL1L    EQU   96                       VOL1 RECORD LENGTH              17460003
RDHA     EQU   X'1A'                    READ HOME ADDRESS               17540003
L4       EQU   4                        DISPLACEMENT 4                  17620003
CCSILI   EQU   X'60'                    CCW CMD-CHNG AND SILI           17700003
SILI     EQU   X'20'                    CCW SILI BIT MASK               17780003
D0       EQU   0                        DISPLACEMENT 0                  17860003
*                                       ALTERNATE TRACK.        YL02912 18050000
         EJECT                                                          19050000
*********************************************************************** 19100000
SETCCW   CCW   X'23',F1,X'40',1        SET SECTOR ZERO                  19110000
SECTIC   CCW   8,0,0,0                 TIC BACK TO SETCCW               19120000
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      19150000
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              19200000
RDVDATA  CCW   6,0,X'20',96            READ FORMAT 4 DATA.              19250000
RHA      CCW   X'1A',0,X'20',5          READ HA OF VOL1 TRK     YL02912 19300000
READR0   CCW   X'16',0,X'30',16        READ-BACK CHECK R0 ON            19350000
*                                        OVERFLOW TRACKS.               19400000
*********************************************************************** 19450000
*                                                                     * 19500000
*   DEFINED STORAGE.                                                  * 19550000
*                                                                     * 19600000
*********************************************************************** 19650000
         SPACE                                                          19700000
TAPECB   DC    F'0'                    WAIT OR COMPLETION BITS.  A21395 19750000
RVIDSAVE DS    18F                     SAVE AREA FOR CALLED ROUTINES.   19800000
ADDRBUFF DC    F'0'                                                     19850000
CCHHADDR DS    1F                      IPL TRACK ADDRESS.               20050000
RETCODE  DC    F'0'                    RETURN CODE SAVE AREA.           20100000
ANSW     DS    CL1                     OPERATOR REPLY AREA.      A21395 20150000
SRKEY    DC    X'0000000003'           SEARCH ARGUMENT                  20200000
*********************************************************************** 20250003
*           MAINTENANCE AREA - PATCH SPACE                            * 20310003
*                                                                     * 20370003
MAINT    DC    10CL10'PATCH'     EBCDIC FOR EYEBALLING DUMP             20430003
*                                                                     * 20490003
*********************************************************************** 20550003
         SPACE  4                                                       20610003
*******************  END OF MODULE  *********************************** 20670003
         TITLE 'IEHDRVID - RESTORE VOLID FOR RESTORE'                   20730003
         EJECT                                                          20800000
IOBLOCKS DSECT                                                          20850000
*   RESTORE DA WRITE-OUT ECB.                                           20900000
DISKECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   20950000
         SPACE 1                                                        21000000
*   RESTORE DA WRITE-OUT IOB.                                           21050000
DISKIOB  DS    0F                                                       21100000
DISKFLG  DS    CL2                     FLAGS 1 AND 2.                   21150000
DSENSE   DS    CL2                     SENSE BYTES.                     21200000
DECBAD   DS    1F                      ECB ADDRESS.                     21250000
DSTATUS  DS    2F                      CHANNEL STATUS.                  21300000
DCCWAD   DS    1F                      CCW LIST ADDRESS.                21350000
DDCBAD   DS    1F                      DCB ADDRESS.                     21400000
DRESAD   DS    1F                      RESTART ADDRESS.                 21450000
DBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           21500000
DERROR1  DS    CL2                     ERROR COUNT                      21550000
DSEEK    DS    2F                      MBBCCHHR.                        21600000
BB       EQU   DSEEK+1                 BIN ADDRESS.                     21650000
CCHH     EQU   DSEEK+3                 CYLINDER-HEAD ADDRESS.           21700000
R        EQU   DSEEK+7                 RECORD NUMBER.                   21750000
         SPACE 1                                                        21800000
*   RESTORE DA WRITE-OUT DCB.                                           21850000
DISKDCB  DS    18F                                                      21900000
         SPACE 2                                                        21950000
*   RESTORE TAPE READ-IN ECB.                                           22000000
TAPEECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   22050000
         SPACE 1                                                        22100000
*   RESTORE TAPE READ-IN IOB.                                           22150000
TAPEIOB  DS    0F                                                       22200000
TAPEFLG  DS    CL2                     FLAGS 1 AND 2.                   22250000
TSENSE   DS    CL2                     SENSE BYTES.                     22300000
TECBAD   DS    1F                      ECB ADDRESS                      22350000
TSTATUS  DS    2F                      CHANNEL STATUS.                  22400000
TCCWAD   DS    1F                      CCW LIST ADDRESS.                22450000
TDCBAD   DS    1F                      DCB ADDRESS.                     22500000
TRESAD   DS    1F                      RESTART ADDRESS.                 22550000
TBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           22600000
TERROR   DS    CL2                     ERROR COUNT                      22650000
         SPACE 1                                                        22700000
*   RESTORE TAPE READ-IN DCB NUMBER ONE.                                22750000
TAPEDCB  DS    13F                                                      22800000
         SPACE 1                                                        22850000
*   CCWS TO READ-IN RESTORE TAPE.                                       22900000
         DS    0D                      ALIGNMENT.                       22950000
TAPECCW1 DS    CL8                     USED TO READ CCW RECORD.         23000000
TAPEDAT1 DS    CL8                     USED TO READ DATA RECORD.        23050000
TAPECCW2 DS    CL8                     USED TO READ CCW RECORD.         23100000
TAPEDAT2 DS    CL8                     USED TO READ DATA RECORD.        23150000
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           23300000
         SPACE 1                                                        23350000
         IEHDBLKS                                                       23400000
         EJECT                                                          23450000
         IEHDWORK                                                       23500000
         SPACE                                                          23550000
VLABEL   DSECT                                                          23600000
VOLUME   DS    CL3                     LABEL IDENTIFIER.                23650000
VOLNO    DS    CL1                     LABEL NUMBER.                    23700000
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.             23750000
SECURITY DS    CL1                     VOLUME SECURITY.                 23800000
VTOCPTR  DS    CL10                    POINTER TO VTOC                  23850000
         DS    CL20                    RESERVED.                        23900000
OWNER    DS    CL10                    OWNER IDENTIFICATION.            23950000
         DS    CL29                    BLANK.                           24000000
         SPACE                                                          24050000
RBUFFER  DSECT                                                          24100000
ZERO1    DS    CL8                     WILL CONTAIN 8 BYTES OF ZEROS.   24150000
CCWBUFF  EQU   ZERO1                                                    24200000
L1       EQU   1                       LENGTH ATTRIBUTE                 24250000
TICSW    DS    CL1                     'FF' INDICATES PREVIOUS CCW=TIC. 24300000
         DS    CL3                     NOT USED.                        24350000
ADDRESS  DS    CL4                     TEMPORARY ADDRESS HOLDER.        24400000
SEEKCCW  DS    CL8                     SEEK CCW FOR STAND-ALONE.        24450000
SETMASK  DS    CL8                     SET FILE MASK FOR STAND-ALONE.   24500000
SEARIDE  DS    CL8                     SEARCH EQUAL ID CCW.             24550000
         EJECT                                                          25950000
CVT      DSECT                                                          26000000
         CVT   SYS=MIN                                                  26050000
         EJECT                                                          26100000
UCB      DSECT                                                          26150000
         IEFUCBOB                                                       26200000
         EJECT                                                          26250000
JFCB     DSECT                                                          26300000
         IEFJFCBN                                                       26350000
         EJECT                                                          26400000
         DCBD  DSORG=PS                                                 26450000
         END                                                            26500000
./  ADD  SSI=72060070,NAME=IEHDSCAN
 TITLE   'CARD SCAN ROUTINE-  IEHDSCAN'                                 00300016
         COPY  LCGASMSW                                          SM4351 00581021
IEHDSCAN CSECT                                                          00584821
*********************************************************************** 00592440
*                  FIXES THIS MODULE                                  * 00594440
*                     LATEST FIRST                                    * 00596440
*********************************************************************** 00598440
*                                                                       00600040
*C 142000,772858                    @XA16070,@YA18061,@ZA24160,@SA79721 00600199
*                                                                       00600399
*C 142000,361000                             @XA13633=@YA13305=@ZA07400 00600440
*A 773103                                    @XA13633=@YA13305=@ZA07400 00600840
*                                                                       00601203
*C774244,774340,776457                                         @ZM42083 00608803
*D349600,350200,775062-775295,776485-776499,776527             @ZM42083 00616403
*D379020-381000                                                @ZM42083 00624003
*                                                                       00630940
*C 143000,772706,772738             @XA10392=@SA74492=@YA10561=@ZA04428 00631603
*A 141500-142000,772703-772704,     @XA10392=@SA74492=@YA10561=@ZA04428 00639203
*A 772735-772736                    @XA10392=@SA74492=@YA10561=@ZA04428 00646803
*                                                                       00654403
*A 313500-314500                    @SA69592=@YA04854=@XA05828=@ZA01200 00662003
*                                                                       00669640
*1251689000                                                      M6170  00677203
*1251291000-295000                                               M4974  00684803
*1251421000                                                      M5593  00692420
*                                                                     * 00700020
* STATUS CHANGE LEVEL 000                                             * 00900020
*********************************************************************** 00950040
         EJECT                                                          01000040
* FUNCTION/OPERATION                                                  * 01500020
*      THIS ROUTINE PROCESS THE SYSIN DATA SET FOR IEHDASDR UTILITY   * 01700020
*      PROGRAM.  USING THE QSAM GET MACRO(MOVE MODE), THE INPUT       * 01900020
*      STREAM IS SCANNED ONE EIGHTY BYTE CARD IMAGE AT A TIME. THE    * 02100020
*      INPUT STREAM IS ANALYZED FOR COMMANDS, KEYWORDS, PARAMETERS,   * 02300020
*      AND CONTINUATION CARDS. CONTROL IS RETURNED TO THE MONITOR     * 02500020
*      ROUTINE FOR EACH OF THESE CONDITIONS.                          * 02700020
*                                                                     * 02900020
* ENTRY POINTS                                                        * 03100020
*      IEHDSCAN IS THE ONLY ENTRY POINT. IT RECEIVES CONTROL FROM     * 03300020
*      THE IEHDASDS ROUTINE.                                          * 03500020
*                                                                     * 03700020
* INPUT                                                               * 03900020
*      A POINTER TO THE WORK AREA IN REGISTER 12.                     * 04100020
*                                                                     * 04300020
* EXITS                                                               * 04500020
*      NORMAL - CONTROL IS RETURNED TO THE IEHDASDS ROUTINE AFTER     * 04700020
*        DETECTION OF A COMMAND, A KEYWORD, A PARAMETER, A COMPLETE   * 04900020
*        CARD AND AN END OF FILE CONDITION ON THE SYSIN DATA SET.     * 05100020
*        NO RETURN CODE IS PASSED.                                    * 05300020
*      ERROR - CONTROL IS RETURNED TO THE IEHDASDS ROUTINE FOR        * 05500020
*        ERROR CONDITIONS(INVALID SYNTAX).  THE MONITOR INTERPRETS    * 05700020
*        THESE CONDITIONS BY SWIRCH SETTINGS AND DETERMINES THE       * 05900020
*        NECESSARY MESSAGES.  NO RETURN CODE IS PASSED.               * 06100020
*                                                                     * 06300020
* EXTERNAL REFERENCES                                                 * 06500020
*      NONE                                                           * 06700020
*                                                                     * 06900020
* TABLES/WORK AREAS                                                   * 07100020
*      UPON ENTRY,REGISTER 12 POINTS TO THE WORK AREA, DESCRIBED BY   * 07300020
*      THE DSECT IEHDWORK.                                            * 07500020
*                                                                     * 07700020
* ATTRIBUTES                                                          * 07900020
*      SERIALLY REUSABLE,RELOCATABLE                                  * 08100020
*                                                                     * 08300020
         EJECT                                                          08500020
*                                                                     * 08700020
*                                                                     * 08900020
* REGISTER EQUATE DEFINITIONS                                         * 09100020
*                                                                     * 09300020
*                                                                     * 09500020
         SPACE 1                                                        09700020
GR0      EQU   0                                                        09900020
GR1      EQU   1                                                        10100020
GR2      EQU   2                                                        10300020
GR3      EQU   3                                                        10500020
GR4      EQU   4                                                        10700020
GR5      EQU   5                                                        10900020
GR6      EQU   6                                                        11100020
GR7      EQU   7                                                        11300020
GR8      EQU   8                                                        11500020
GR9      EQU   9                                                        11700020
GR10     EQU   10                                                       11900020
GR11     EQU   11                                                       12100020
GR12     EQU   12                                                       12300020
GR13     EQU   13                                                       12500020
GR14     EQU   14                                                       12700020
GR15     EQU   15                                                       12900020
SS1VAL   EQU   X'01'                    'SS1' PARM SUPPLIED    @Y30LSFY 12950003
         SPACE 2                                                        13100020
         USING WORK,GR12                                                13300020
         USING IEHCDSCN,GR11           ESTABLISH ADDRESSABILITY.        13500020
         USING FUNCBLK,GR10             ADDRESS TO IEHDBLKS             13550021
IEHCDSCN STM   GR14,GR0,K12(GR13)      SAVE REGISTERS.                  13700020
         STM   GR3,GR12,K32(GR13)      SAVE REGISTERS.                  13900020
         LR    GR11,GR15               LOAD BASE REGISTER               14100020
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04428 14150003
         DC    C'IEHDSCAN OZ24160'     LAST APAR FIX THIS MOD  @ZA24160 14200099
APARNO   LA    GR7,SCANSAVE            ADDRESS OF SAVE AREA    @ZA04428 14300003
         ST    GR7,K8(GR13)            ADDRESS OF NEW AREA TO OLD       14500020
         ST    GR13,K4(GR7)            ADDRESS OF OLD AREA TO NEW       14700020
         LR    GR13,GR7                SAVE AREA ADDRESS                14900020
         L     GR3,READ1               DCB ADDRESS                      15100020
         USING IHADCB,GR3                                               15300020
         LA    GR4,FILEND              RETURN ADDRESS ON EOF            15500020
         ST    GR4,DCBEODAD            SAVE IN DCB                      15700020
         B     SKIPHOLD                BYPASS POINTER SAVE.     XM3762  15750002
         DROP  GR3                                                      15900020
         EJECT                                                          16100020
*  DETERMINE FIELD TO BE SCANNED BY SWITCH READINGS.                  * 16300020
         SPACE 1                                                        16500020
* FORMERLY IN THE DASDS ROUTINE, AND HAS BEEN MODIFIED IN THE REPACK    16550021
* TO RETURN TO THIS POINT INSTEAD OF EXITING OUT OF DSCAN AND RETURNING 16600021
         SPACE 1                                                        16650021
SCAN     EQU   *                        REPACK RETURN POINT             16660021
         ST    GR4,HOLD4                SAVE POINTER                    16670021
         ST    GR9,HOLD9                SAVE RETURN POINT               16680021
SKIPHOLD EQU   *                                                        16690002
         L     GR3,STORGR3             ADDRESS OF COL TO SCAN           16700020
         TM    SWITCHRD,ON             FIRST TIME IN SCAN               16900020
         BZ    NEWCD                   YES-READ A CARD                  17100020
         NI    SWITCHRD,GOOD           TURN OFF ERROR SWITCH            17300020
         TM    SWITCHRD,BYPASS         BYPASS THIS CARD                 17500020
         BO    PASCD                   YES-CHECK FOR CONTINUATION       17700020
         TM    SWITCHRD,COMD           COMMAND PROCESSED                17900020
         BO    PREKEY                  YES-LOOKING FOR KEYWORD          18100020
         TM    SWITCHRD,KEY            KEYWORD PROCESSED                18300020
         BO    PARAM                   YES-LOOKING FOR PARAMETER        18500020
         TM    DELIMIN2,X80            WAS PREVIOUS RUN A TODD          18700020
         BZ    CONTA                   NO - CONTINUE                    18900020
         TM    PARENCTR,BPAREN         ONLY ONE PAREN?                  19100020
         BM    TOPARM1                 YES- CONTINUE PROCESSING PARAM   19300020
         MVI   DELIMIN2,K0             RESET                            19500020
         MVI   PARENCTR,ZERO           RESET                            19700020
CONTA    TM    SWITCHRD,PARM           PARAMETER PROCESSED              19900020
         BO    KEYWD                   YES-CHECK FOR MORE KEYWORDS      20100020
NEWCD    EQU   *                                                        20300020
         XC    SWITCHRD(ALL),SWITCHRD  CLEAR BUFFER AND SWITCHES        20500020
         SR    GR2,GR2                 CLEAR REGISTER                   20700020
         BAL   GR9,CDRD                READ A CARD                      20900020
         CLI   SWITCHRD+COL72,BLANK    IS COLUMN 72 BLANK               21100020
         BE    STSCAN                  YES-START SCAN                   21300020
         OI    COL72LG,SPEC1           NO-SET CONTINUATION SWITCH       21500020
         SPACE 1                                                        21700020
*  CHECK NAME FIELD.                                                  * 21900020
         SPACE 1                                                        22100020
STSCAN   EQU   *                                                        22300020
         LA    GR2,K1(GR2)             INCREMENT CNT REGISTER           22500020
         CLI   K0(GR3),BLANK           IS COLUMN BLANK                  22700020
         BE    LENGTH                  YES-CHECK LENGTH                 22900020
         LA    GR3,K1(GR3)             NO-GO TO NEXT COLUMN             23100020
         B     STSCAN                  SEARCH THIS COLUMN               23300020
LENGTH   EQU   *                                                        23500020
         BCTR  GR2,GR0                 DECREMENT BYTE COUNT             23700020
         LTR   GR2,GR2                 BYTE COUNT ZERO                  23900020
         BZ    COMMD                   YES-CHECK COMMAND FIELD          24100020
         LA    GR8,K8                  MAXIMUM LENGTH FOR COMMAND       24300020
         CR    GR2,GR8                 IS NAME TOO LONG                 24500020
         BH    ERRO                    YES-SET ERROR SWITCH             24700020
         SR    GR2,GR2                 CLEAR BYTE COUNT                 24900020
         EJECT                                                          25100020
*  CHECK COMMAND AND KEYWORD FIELDS.                                  * 25300020
         SPACE 1                                                        25500020
COMMD    EQU   *                                                        25700020
         MVI   SWITCHRD,COMD           SET COMMAND SWITCH.              25900020
         BAL   GR9,PASBLANK            CHECK FOR COMMAND.               26100020
         ST    GR3,STORGR3             SAVE STARTING ADDR OF FIELD.     26300020
FIELD    EQU   *                                                        26500020
         LA    GR2,K1(GR2)             INCREASE BYTE COUNT              26700020
         CLI   K0(GR3),BLANK           IS THIS COLUMN BLANK             26900020
         BE    RETURN                  YES-RETURN TO MONITOR            27100020
         LA    GR3,K1(GR3)             NO-GO TO NEXT COLUMN             27300020
         B     FIELD                   CHECK THIS COLUMN                27500020
PASBLANK EQU   *                                                        27700020
         LA    GR3,K1(GR3)             GO TO NEXT COLUMN.               27900020
         LA    GR4,SWITCHRD+COL72      OBTAIN ADDR OF LAST COLUMN.      28100020
         CLI   K0(GR3),BLANK           IS THIS COLUMN BLANK.            28300020
         BNE   K0(K0,GR9)              NO-RETURN TO CALLER.             28500020
         CR    GR3,GR4                 IS THIS THE LAST COLUMN.         28700020
         BNE   PASBLANK                NO-CHECK NEXT COLUMN.            28900020
         B     ERRO                    BRANCH TO ERROR ROUTINE   M4974  29300020
PREKEY   EQU   *                                                        29700020
         BCTR  GR3,GR0                 BACKSPACE ONE COLUMN.            29900020
         BAL   GR9,PASBLANK            SKIP ALL BLANKS.                 30100020
         ST    GR3,STORGR3             SAVE STARTING ADDR OF FIELD.     30300020
KEYWD    EQU   *                                                        30500020
         MVI   COMCD,ZERO              CLEAR CONTINUATION SWITCH.       30700020
         MVI   SWITCHRD,KEY            SET KEYWORD SWITCH.              30900020
         CLI   K0(GR3),BLANK           IS FIRST COLUMN BLANK.           31100020
         BE    CONTIN                  YES-CHECK FOR A CONTINUATION.    31300020
         LA    GR4,SWITCHRD+COL72      ADR OF LAST COL         @ZA01200 31350002
         CR    GR3,GR4                 COL 72?                 @ZA01200 31400002
         BE    CONTIN                  YES. CONTINUATION?      @ZA01200 31450002
         LA    GR4,K9                  NUMBER OF BYTES SCANNING.        31500020
         MVC   DEC(K10),TAB            RESET NUMBER BYTES.              31700020
         TRT   K0(K9,GR3),TAB          CHECK KEYWORD FIELD.             31900020
         LTR   GR2,GR2                 ALL BYTES GOOD.                  32100020
         BZ    ERR1                    YES-INVALID KEYWORD.             32300020
         CLC   K0(SSILN,GR3),SSICODE    SSI PARAM ?            @Y30LSFY 32350003
         BE    FINISH                   YES, CONTINUE          @Y30LSFY 32400003
         CLI   K0(GR1),EQUAL           IS CHARACTER AN EQUAL.           32500020
         BNE   ERR2                    NO-INVALID KEYWORD.              32700020
FINISH   EQU   *                                                        32900020
         LR    GR4,GR1                 SAVE COLUMN ADDRESS              33100020
         SR    GR1,GR3                 LENGTH OBTAINED.                 33300020
         LR    GR2,GR1                 PUT IN COUNT REGISTER            33500020
         LR    GR3,GR4                 ADDRESS OF LAST COL SCANNED      33700020
         B     RETURN                  RETURN TO MONITOR                33900020
         EJECT                                                          34100020
*  CHECK PARAMETER FIELD FOR PROPER KEYWORD.                          * 34300020
         SPACE 1                                                        34500020
PARAM    EQU   *                                                        34700020
         MVI   SWITCHRD,PARM           SET SW FOR PARAMETER             34900020
         TM    DELIMIN,TODDS           IS PARM FOR TODD                 35100021
         BO    TOPARM                  YES-CHECK FOR TODD PARM          35300020
         XC    DEC(K10),DEC            TURN ON NUMBER BYTES             35500020
         TM    DELIMIN,OWNERIS         IS PARM FOR OWNERID              35700021
         BO    OWPARM                  YES-CHECK FOR OWNERID PARM       35900020
         TM    DELIMIN,NEWVOLID        IS PARM FOR NEWVOLID.   @ZA07400 36100040
         BO    NUVOL                   YES - CHECK FOR NEWVOLID PARM.   36300020
         TRT   K0(K11,GR3),TAB         CHECK PARAMETER BYTES            36500020
         LTR   GR2,GR2                 ALL BYTES GOOD                   36700020
         LA    GR4,K11                 SAVE BYTE COUNT                  36900020
         BZ    ERR1                    YES-INVALID PARAMETER            37100020
         CLI   K0(GR1),COMMA           IS LAST BYTE CHECKED A COMMA     37300020
         BNE   ERR2                    NO-INVALID PARAMETER             37500020
ENDCHK   EQU   *                                                        37700020
         B     FINISH                  RETURN TO MONITOR                37900020
         EJECT                                                          37901003
TOPARM   EQU   *                                                        38300020
         MVI   PARENCTR,ZERO           CLEAR PARENTHESIS SW             38500020
         CLI   K0(GR3),LPAREN         IS FIRST BYTE LEFT PARENTHESIS    38700020
         BNE   TOPARM1                 NO-SCAN PARAMETER                38900020
         OI    PARENCTR,WAITING        YES-SET SW FOR LEFT PAREN        39100020
         LA    GR3,K1(GR3)             GO TO NEXT COLUMN                39300020
         ST    GR3,STORGR3             UPDATE POINTER                   39500020
TOPARM1  EQU   *                                                        39700020
         XC    DEC(K10),DEC            TURN ON NUMBER BYTES             39900020
         SR    GR2,GR2                 CLEAR REG                        40100020
         MVI   DELIMIN2,X80            SET TODD AS OP                   40300020
         MVI   TABSL,ZERO              TURN ON SLASH BYTE               40500020
         TRT   K0(K9,GR3),TAB          CHECK PARAMETER                  40700020
         OI    TABSL,ONE               RESET SLASH BYTE                 40900020
         LR    GR4,GR1                 YES-SAVE COLUMN ADDRESS.         41100020
         SR    GR4,GR3                 LENGTH BETWEEN COMMAS            41300020
         LA    GR8,K1                  MINIMUM LENGTH FOR TODD PARM     41500020
         CR    GR4,GR8                 IS LENGTH LESS THAN ONE OR EQUAL 41700020
         BL    ERR1                    YES - BRANCH LT ONE              41900020
         LTR   GR2,GR2                 ARE ALL BYTES TESTED GOOD        42300020
         BZ    ERR1                    YES-INVALID PARAMETER            42500020
         CLI   K0(GR1),COMMA           IS LAST BYTE SCANNED A COMMA     42700020
         BE    FINISH01                YES-CHECK PAREN COUNTER          42900020
         CLI   K0(GR1),RPAREN          IS LAST BYTE RIGHT PAREN.        43100020
         BE    PARNCHK                 SET PAREN SWITCH                 43300020
         CLI   K0(GR1),BLANK           IS IT A BLANK                    43500020
         BNE   ERR2                    NO-INVALID PARAMETER             43700020
         B     FINISH02                RETURN                           43900020
PARNCHK  EQU   *                                                        44100020
         OI    PARENCTR,ONE            YES-SET SW FOR RIGHT PAREN       44300020
PARNCHK1 EQU   *                                                        44500020
         TM    PARENCTR,WAITING        PARENTHISIS EXPECTED?            44700020
         BZ    ERR1                    NO - ERROR                       44900020
         LR    GR2,GR1                 LOAD ADDR OF LAST COL SCANNED    45100020
         SR    GR2,GR3                 GET COUNT                        45300020
         LA    GR8,K1                  LOWER LIMIT                      45500020
         CR    GR2,GR8                 TOO FEW?                         45700020
         BNH   ERR1                    YES - ERROR                      45900020
         CLI   K1(GR1),COMMA           COMMA FOLLOWING )                46100020
         BNE   KOMA                    NO - CHECK BLANK                 46300020
         LA    GR3,K1(GR1)             RESET GR3                        46500020
         B     RETURN                  RETURN                           46700020
         EJECT                                                          46900020
FINISH01 EQU   *                                                        47100020
         TM    PARENCTR,WAITING        PARENTHISIS EXPECTED             47300020
         BO    FINISH                  YES - NORMAL COMPLETION          47500020
         MVI   DELIMIN2,K0             RESET TODD SW                    47700020
         B     FINISH                  CONTINUE                         47900020
FINISH02 EQU   *                                                        48100020
         TM    PARENCTR,WAITING        PARENTHISIS EXPECTED             48300020
         BO    ERR1                    YES - BLANK MEANS ERROR          48500020
         OI    SWITCHRD,BYPASS         BYPASS REMAINDER OF CARD XM3741  48550002
         MVI   DELIMIN2,K0             RESET TODD SW                    48700020
         B     FINISH                  CONTINUE                         48900020
KOMA     EQU   *                                                        49100020
         LR    GR3,GR1                 UPDATE POINTER                   49300020
         CLI   K1(GR1),BLANK           IS IT A BLANK?                   49500020
         BE    RETURN                  YES - GOOD RETURN                49700020
         B     ERR1                    NO - ERROR                       49900020
         EJECT                                                          50100020
OWPARM   EQU   *                                                        50300020
         MVI   TABSL,ZERO              TURN ON SLASH BYTE.              50500020
         MVI   TABPR,ZERO              TURN ON PERIOD BYTE              50700020
OWPARM1  EQU   *                                                        50900020
         NI    TABHY,ZERO              TURN ON HYPHEN BYTE              51100020
         TRT   K0(K11,GR3),TAB         SCAN THE PARAMETER               51300020
         OI    TABSL,ONE               RESET SLASH BYTE.                51500020
         OI    TABHY,ONE               RESET HYPHEN BYTE                51700020
         OI    TABPR,ONE               RESET PERIOD BYTE                51900020
         LTR   GR2,GR2                 ARE ALL BYTES GOOD               52100020
         LA    GR4,K11                 SAVE BYTE COUNT                  52300020
         BZ    ERR1                    YES-INVALID PARM LENGTH          52500020
         CLI   K0(GR1),COMMA           IS BYTE A COMMA                  52700020
         BNE   ERR2                    NO-INVALID PARM                  52900020
         B     ENDCHK                  RETURN TO MONITOR                53100020
NUVOL    EQU   *                                                        53300020
         CLI   K0(GR3),PRIME           IS THE FIRST CHAR A PRIME.       53500020
         BNE   OWPARM1                 NO - GO TO NORMAL PARM TEST.     53700020
         LA    GR3,K1(GR3)             YES - CHECK FOR SPECIAL PARM.    53900020
         OI    PARENCTR,WAITING        SET LEFT PRIME SWITCH.           54100020
         LR    GR1,GR3                 SAVE BEGINNING ADDR OF FIELD.    54300020
         LA    GR2,K7                  MAXIMUM LENGTH OF FIELD.         54500020
NUVOL1   EQU   *                                                        54700020
         CLI   K0(GR1),PRIME           IS THIS CHARACTER A PRIME.       54900020
         BE    PRIMECHK                YES - CHECK LENGTH OF PARAMETER. 55100020
         LA    GR1,K1(GR1)             NO - GO TO NEXT COLUMN.          55300020
         BCT   GR2,NUVOL1              DECREMENT FIELD LENGTH.          55500020
         B     ERR2                    ERROR - PARM FIELD TOO LONG.     55700020
PRIMECHK EQU   *                                                        55900020
         LR    GR4,GR1                 SAVE FIELD ADDRESS.              56100020
         SR    GR1,GR3                 OBTAIN LENGTH OF FIELD.          56300020
         BCTR  GR1,GR0                 DECREMENT BYTE COUNT.            56500020
         LTR   GR1,GR1                 IS BYTE COUNT ZERO.              56700020
         LR    GR1,GR4                 RESTORE FIELD ADDRESS.           56900020
         BZ    ERR2                    YES - INVALID LENGTH.            57100020
         B     FINISH                  NO - RETURN TO MONITOR.          57300020
         EJECT                                                          57500020
*  DETERMINE THE CONTINUATION CARD STATUS.                            * 57700020
         SPACE 1                                                        57900020
CONTIN   EQU   *                                                        58100020
         TM    COL72LG,SPEC1           IS COLUMN 72 BLANK               58300020
         BZ    FINCD                   YES-CARD COMPLETED               58500020
         BCTR  GR3,GR0                 GO BACK ONE COLUMN               58900020
         CLI   K0(GR3),COMMA           NO-IS THERE A COMMA              59100020
         BNE   COMMTCD                 NO-COMMENT CONTINUATION          59300020
         MVI   COMCD,WAITING           SET SW FOR CONTROL CARD          59500020
COMMTCD  EQU   *                                                        59700020
         BAL   GR9,CDRD                GET A CARD                       59900020
         MVI   COL72LG,ZERO            RESET SWITCH              A58684 59950021
         CLC   K0(K15,GR3),CLEAR       ARE THE FIRST 15 COLS BLANK      60100020
         LA    GR4,K15                 SAVE BYTE COUNT                  60300020
         BNE   ERR1                    NO-INVALID CONTINUATION CARD     60500020
         CLI   SWITCHRD+COL72,BLANK    IS COLUMN 72 BLANK               60700020
         BE    CONT1                   YES-CONTINUE CHECK               60900020
         OI    COL72LG,SPEC1           NO-TURN ON CONTINUATION SW       61100020
CONT1    EQU   *                                                        61300020
         LA    GR3,K15(GR3)            GO TO FIRST VALID COLUMN         61500020
         ST    GR3,STORGR3           SAVE ADDRESS OF LAST COL SCANNED.  61700020
         CLI   K0(GR3),BLANK           IS THIS COLUMN BLANK             61900020
         BE    ERRO                    YES-INVALID CONTINUATION CARD    62100020
         TM    COMCD,WAITING           IS THIS A CONTINUED CONTROL CD   62300020
         BO    KEYWD                   YES-CHECK FOR KEYWORD            62500020
         B     PASCD1                   NO - BYPASS IT                  62700020
         SPACE 1                                                        62900020
*  RETURNING CONTROL TO MONITOR WITH PROPER SWITCH SETTINGS.          * 63100020
         SPACE 1                                                        63300020
ERR1     EQU   *                                                        63500020
         AR    GR3,GR4                 ADD BYTES SCANNED.               63700020
         BCTR  GR3,GR0                 POINT TO LAST COL SCANNED.       63900020
         B     ERRO                    SET ERROR SWITCH                 64100020
ERR2     EQU   *                                                        64300020
         LR    GR4,GR1                 SAVE COLUMN ADDRESS.             64500020
         SR    GR1,GR3                 OBTAIN BYTE COUNT.               64700020
         LTR   GR1,GR1                 IS BYTE COUNT ZERO.              64900020
         BZ    ERRO                    YES-VALID ERROR                  65100020
         LR    GR2,GR1                 UPDATE COUNT                     65300020
         LR    GR3,GR4                 ADDRESS OF BYTES SCANNED         65500020
         CLI   K0(GR4),BLANK           IS LAST COL SCANNED BLANK.       65700020
         BE    RETURN40                PROCESS FOR BLANK                65900020
ERRO     EQU   *                                                        66100020
         OI    SWITCHRD,ERROR          SET ERROR SWITCH                 66300020
         B     RETURN                  RETURN TO MONITOR.               66500020
         EJECT                                                          66700020
FINCD    EQU   *                                                        66900020
         LA    GR4,K1                  BYTE COUNT SCANNED        M5593  67000020
         BCTR  GR3,K0                  DECREMENT PTR                    67100020
         CLI   K0(GR3),COMMA           COMMA DELIMETER                  67300020
         BE    ERR1                    YES - ERROR NO CONTINUATION      67500020
SETBY    EQU   *                                                        67700020
         MVI   SWITCHRD,BYPASS         SET FINISHED CARD SWITCH.        67900020
         B     RETURN                  RETURN TO MONITOR.               68100020
FILEND   EQU   *                                                        68300020
         MVI   SWITCHRD,EOF            SET END OF FILE INDICATOR M6170  68400020
         TM    COL72LG,SPEC1           IS ANOTHER CARD NEEDED.          68500020
         BO    ERRO                    YES-NO MORE AVAILABLE.           68700020
RETURN   EQU   *                                                        69100020
         MVI   DELIMIN,ZERO            CLEAR PARAMETER SWITCH.          69300020
         L     GR1,STORGR3             STARTING ADDR OF FIELD.          69500020
         LA    GR3,K1(GR3)             GO TO NEXT COLUMN.               69700020
         ST    GR3,STORGR3             SAVE ADDR OF THIS COLUMN.        69900020
* GO TO THE REPACK AREA...CODE THAT CAME OUT OF DASDS                   69950021
         B     REPAC                    DO FORMER DASDS CODE            70000021
REPACX   EQU   *                        EXIT FROM THE DASDS CODE        70050021
*                                                                       70060021
         L     GR13,SCANSAVE+K4        ADDR OF MONITOR SAVE AREA.       70100020
         LM    GR14,GR0,K12(GR13)      RESTORE THE REGISTERS.           70300020
         LM    GR3,GR12,K32(GR13)      RESTORE THE REGISTERS.           70500020
         BR    GR14                    RETURN TO MONITOR.               70700020
         SPACE 2                                                        70900020
RETURN40 EQU   *                                                        71100020
         BCTR  GR3,K0                  POINT TO BLANK ON EXIT           71300020
         B     RETURN                  RETURN                           71500020
         SPACE 2                                                        71700020
CDRD     EQU   *                                                        71900020
         L     GR1,READ1               ADDRESS OF SYSIN DCB             72100020
         LA    GR0,CARDBUFF            ADDRESS OF INPUT BUFFER          72300020
         GET   (GR1),(GR0)             READ IN A CARD                   72500020
         MVC   MSGWTR+K1(K80),CARDBUFF PUT CARD IN PRINTER BUFFER       72700020
         LINK  EP=IEHDPRNT             PRINT CARD                       72900020
         LA    GR3,CARDBUFF            ADDRESS OF FIRST COLUMN          73100020
         BR    GR9                     RETURN TO CALLER                 73300020
         SPACE 1                                                        73500020
PASCD    EQU   *                                                        73700020
         TM    COL72LG,SPEC1           IS A CONTINUATION CARD NEEDED    73900020
         BZ    NEWCD                    NO - BYPASS THIS CARD           74100020
         BAL   GR9,CDRD                GET A NEW CARD                   74300020
         CLI   SWITCHRD+COL72,BLANK    IS A CONTINUATION CARD NEEDED.   74500020
         BE    NEWCD                   NO - PROCESS A NEW CARD.         74700020
         OI    COL72LG,SPEC1           YES - SET CONTINUATION SW.       74900020
         B     PASCD                   OBTAIN CONTINUATION CARD.        75100020
PASCD1   EQU   *                                                        75300020
         TM    COL72LG,SPEC1            CONTINUATION                    75500020
         BZ    SETBY                    NO - BYPASS SW                  75700020
PASCD1A  EQU   *                                                        75900020
         BAL   GR9,CDRD                 READ CONTINUATION CARD          76100020
         CLI   SWITCHRD+COL72,BLANK     CONTINUATION                    76300020
         BNE   PASCD1A                  YES - GET NEXT CD               76500020
         B     SETBY                    SET BYPASS SW                   76700020
         EJECT                                                          76750021
* THE FOLLOWING INSTRUCTIONS ARE TAKEN FROM THE IEHDASDS MODULE         76760021
* AND REPACKED INTO THIS MODULE, WITH SOME MINOR CHANGES.               76770021
* ALL LABELS WERE TAKEN INTACT, AND IN SOME CASES THE BRANCHES          76780021
* TO A LABEL WAS LEFT WITH THE SAME NAME, AND A EXIT TYPE OF            76790021
* ROUTINE CREATED. THIS WAS TO FACILITATE DEBUGGING, BY                 76792021
* MAINTAINING COMPATABILITY WITH THAT CODE THAT WAS BEING               76794021
* REPACKED.                                                             76796021
REPAC    EQU   *                        START OF REPACK AREA            76798021
         L     GR4,HOLD4                RESTORE POINTER                 76798421
         L     GR9,HOLD9                RESTORE RETURN ADDRESS          76798821
         TM    SWITCHRD,ERROR          WAS THERE AN ERROR.              76800021
         BO    MSGPRT                  YES,GO GIVE A MESSAGE.           76850021
         SPACE 1                                                        76860021
         TM    SWITCHRD,COMD           IS THIS A COMMAND.               76870021
         BO    OPRLUP                  YES-GO TEST VALIDITY AND PROCESS 76880021
         SPACE 1                                                        76890021
         TM    SWITCHRD,KEY            IS THIS A KEYWORD.               76892021
         BO    KEYLUP                  YES-GO TEST VALIDITY AND PROCESS 76894021
         SPACE                                                          76896021
         TM    SWITCHRD,EOF            WAS AN EOF READ.                 76898021
         BO    CHECK                   YES-GO SEE IF FINISHED.          76898421
         SPACE                                                          76898821
         TM    SWITCHRD,PARM           THIS A PARAMETER.                76899221
         BZ    SCAN3                   NO--GO MAKE MORE TESTS.          76899621
         TM    SW1,DD1OK               MULTIPLE PARMS ALLOWED.          76899721
         BCR   K1,GR9                  YES-PROCESS PARAMETER.           76899821
         TM    SW1,PARMXY              NO--ANY PREVIOUS PARMS.          76899921
         BO    INVALP1                 YES-THEN THIS PARAMETER INVALID. 76949921
         OI    SW1,PARMXY              REMEMBER THIS PARAMETER.         76959921
         BR    GR9                     PROCESS THIS PARAMETER.          76969921
         SPACE                                                          76979921
SCAN3    EQU   *                                                        76981921
         TM    SWITCHRD,BYPASS         IS THIS CARD FINISHED.           76989921
         BZ    SCAN                    NO--CONTINUE SCAN//THIS CARD.    76991921
         SPACE                                                          76993921
         B     SCAN1                    GO TO START PROCESSING          76995921
         SPACE                                                          77096121
SCANTBL  STC   LENGT2,SAVLGTH          STORE LENGTH.                    77186221
         CLI   SAVLGTH,8               IS LENGTH EIGHT OR LESS.         77188221
         BH    MSGPRT                  YES-CONTROL STATEMENT ERROR.     77190221
         LA    GR4,12                  TABLE INCREMENTING VALUE.        77192221
         MVI   WURK,C' '               CLEAR SEARCH AREA.               77194221
         MVC   WURK+1(7),WURK          CLEAR REMAINING ARGUMENT AREA.   77194621
         BCTR  LENGT2,0                DECREMENT LENGTH FOR EXECUTE.    77195021
         EX    LENGT2,OPRLUP3           MOVE PARAMETER TO STORGE AREA   77195421
OPRCMP   CLC   WURK(8),0(GR3)          CHK IF SEARCH ARGUMENT IN TABLE. 77195821
         BNE   OPRLUP2                 NO--CONTINUE SCAN OF TABLE.      77195921
         LA    GR3,8(GR3)              POINT TO BRANCH ADDRESS.         77196021
         NI    SW1,X'FF'-COMMAND-SPEC1   RESET INDICATORS.              77196121
         BR    GR3                     ENTER PROPER ROUTINE.            77212821
OPRLUP2  BXLE  GR3,GR4,OPRCMP          LOOP TO CONTINUE SEARCH.         77222821
         TM    SW1,COMMAND             ERROR WHILE LOOKING FOR COMMAND. 77224821
         BZ    INVALKEY                YES--INVALID KEYWORD.            77226821
         NI    SW1,X'FF'-COMMAND       RESET COMMAND INDICATOR.         77228821
         B     INVALCOM                MUST BE INVALID COMMAND.         77229221
OPRLUP3  MVC   WURK(1),0(SCANADR)      MOVE IN ARGUMENT.                77229321
*   KEYWORD LOOKUP ROUTINE.                                             77229421
         SPACE 1                                                        77235021
KEYLUP   LA    GR3,KEYTAB              START OF KEYWORD TABLE.          77237021
         LA    GR5,KEYEND              END OF VALID KEYWORDS.           77239021
         NI    SW1,X'FF'-DD1OK-PARMXY  RESET PARM SWITCHES.             77239421
         B     SCANTBL                 GO FIND THIS KEYWORD.            77239821
* SET THE BRANCH TABLE ADDRESSES FOR DASDS                              77239921
CHECK    TM    SW1,TEXTIN               IPL TEXT?                       77240021
         BO    NOIPLMSG                 YES - ERR MESSAGE               77244421
         MVI   GOVAL,GOCHECK            SET BRANCH TO CHECK             77246421
         B     REPACX                   EXIT DSCAN                      77246821
SCAN1    MVI   GOVAL,GOSCAN1            SET BRANCH TO SCAN1             77248421
         B     REPACX                   EXIT DSCAN                      77248821
OPRLUP   MVI   GOVAL,GOOPRL             SET BRANCH TO OPRLUP            77251821
         B     REPACX                   EXIT DSCAN                      77252221
GETCOPY  MVI   GOVAL,GOCOPY             SET BRANCH TO GETCOPY           77252321
         B     REPACX                   EXIT DSCAN                      77252621
MSGWRT2  MVI   GOVAL,GOWRT2             SET BRANCH TO MSGWRT2           77252721
         B     REPACX                   EXIT DSCAN                      77252821
         EJECT                                                          77253021
*********************************************************************** 77253421
*                                                                     * 77253821
*   THE FOLLOWING TABLE IS A LIST OF THE REQUIRED KEYWORDS            * 77254221
*     FOR EACH FUNCTION.                                              * 77254621
*                                                                     * 77255021
*********************************************************************** 77255421
KCODES   EQU   *                                                        77255821
         DC    AL1(0)                  DUMMY                            77256221
         DC    AL1(FROMDD+TODD)        DUMP                             77256621
         DC    AL1(FROMDD+TODD)        RESTORE                          77257021
         DC    AL1(TRACK+TODD)         GETALT                           77257421
         DC    AL1(NEWVOLID+TODD)      LABEL                            77257821
         DC    AL1(TODD+EXTENT+VTOC)   ANALYZE                          77258221
         DC    AL1(TODD+EXTENT+VTOC)   FORMAT                           77258621
         DC    AL1(FROMDD+TODD)        IPLPROG                          77259021
         DC    AL1(0)                                                   77259421
         SPACE 3                                                        77259821
*********************************************************************** 77260221
*                                                                     * 77260621
*   THE FOLLOWING TABLE INDICATES THE BIT SWITCH SETTINGS FOR THE     * 77261021
*     -SEQSW-. ALL THE VARIOUS KEYWORDS ARE LISTED WITH THE           * 77261421
*     SUPPORTED FUNCTIONS.                                            * 77261821
*                                                                     * 77262221
*********************************************************************** 77262621
****                                                               **** 77263021
* (BITS) *   0    .  1 .   2    .  3  .  4  .   5   .   6    .  7     * 77263421
* DUMP   * FROMDD .TODD.CPYVOLID.BEGIN. END .       .        .        * 77263821
*        *        .    .        .     .     .       .        .        * 77264221
* RESTORE* FROMDD .TODD.CPYVOLID.     .     .       .        .        * 77264621
*        *        .    .        .     .     .       .        .        * 77265021
* GETALT * TRACK  .TODD.        .     .     .       .        .        * 77265421
*        *        .    .        .     .     .       .        .        * 77265821
* LABEL  *NEWVOLID.TODD.        .     .     .OWNERID.        .        * 77266221
*        *        .    .        .     .     .       .        .        * 77266621
* ANALYZE*NEWVOLID.TODD.EXTENT  .VTOC .IPLDD.OWNERID.FLAGTEST.PASSES  * 77267021
*        *        .    .        .     .     .       .        .        * 77267421
* FORMAT *NEWVOLID.TODD.EXTENT  .VTOC .IPLDD.OWNERID.        .        * 77267821
*        *        .    .        .     .     .       .        .        * 77268221
* IPLPROG* FROMDD .TODD.        .     .     .       .        .        * 77268621
*        *        .    .        .     .     .       .        .        * 77269021
*********************************************************************** 77269421
         EJECT                                                          77269821
*   HANDLE ALL KEYWORDS HERE.                                           77270221
FROMANAL TM    SEQSW,FROMDD            FROMDD SPECIFIED BEFORE @ZA04428 77270303
         BO    INVALKEY                YES WRTE IEH802I TERM   @ZA04428 77270403
         CLI   FUNCSW,IPLPROG          THIS IPLPROG FUNCTION?  @ZA04428 77270603
         BE    FROMAN                  YES- BRANCH                      77271021
         CLI   FUNCSW,RESTORE          IS THIS DUMP OR RESTORE?         77271421
         BH    INVALKEY                NO--INVALID KEYWORD.             77271821
FROMAN   OI    SEQSW,FROMDD            INDICATE FROMDD DKEYWORD.        77272221
         LA    GR4,DDNAME1             RETURN TO SCAN FOR PARAMETER.    77272621
         B     GETPARM1                GO PROCESS THE PARAMETER.        77273021
         SPACE                                                          77273421
TODDANAL TM    SEQSW,TODD              TODD SPECIFIED BEFORE   @ZA04428 77273503
         BO    INVALKEY                YES WRTE IEH802I TERM   @ZA04428 77273603
         OI    SEQSW,TODD              SET TODD KEY PRESENT.   @ZA04428 77273803
         OI    DELIMIN,X'01'           TELL SCAN '/' IS OK IN PARAMETER 77274221
         OI    SW1,DD1OK               INDICATE MULTIPLE PARMS OK.      77274621
         LA    GR4,DDNAME2             ADDRESS TO STORE TODD DDNAME.    77275021
         SPACE                                                          77275421
GETPARM1 LA    GR3,8                   MAXIMUM PARAMETER LENGTH.        77275821
GETPARM  BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETER.    77276221
SLSHSWT  NI    DELIMIN2,X'FE'          RESET SLASH SWITCH.      SA53297 77276621
DDNFIND  EQU   *                                                 A50288 77277021
         L     GR7,CVTPTR              ADDRESS OF CVT.           XM3762 77277402
         USING CVT,GR7                                           XM3762 77277802
         L     GR15,CVTTCBP            TCB DOUBLE WORD.          A50288 77278221
         L     GR15,4(GR15)            PICK UP TCB ADDRESS.      A50288 77279021
         L     GR15,12(GR15)           PICK UP TIOT ADDRESS.     A50288 77279421
         LA    GR15,24(GR15)           PICK UP DD ENTRY ADDRESS. A50288 77279821
         SR    GR3,GR3                  ZERO WORK REG            A50288 77280221
FINDDN   IC    GR3,0(GR15)             LOAD DD ENTRY LENGTH.     A50288 77280621
         LTR   GR3,GR3                 TEST FOR END OF TIOT.     A50288 77281021
         BZ    LABANAL                 END OF TABLE/NO DDNAME.   A50288 77281421
         BCTR  GR2,0                    DECRE LEN FOR EXECUTE    A50288 77281821
         EX    GR2,CHKTODD              COMPARE TODD DDNAME      A50288 77282221
         LA    GR2,1(GR2)               RESET LENGTH             A50288 77282621
         LA    GR15,0(GR3,GR15)         SETUP FOR NEXT ENTRY     A50288 77283021
         BNE   FINDDN                   NO MATCH - LOOP BACK     A50288 77283421
         B     FNDDN                    DDNAME FOUND IN TIOT     A50288 77283821
LABANAL  EQU   *                                                 A50288 77284221
         CLI   FUNCSW,ANALYSIS          ANALYZE FUNCTION         A50288 77284621
         BE    TSTLNG                   YES - GO TEST LENGTH     A50288 77285021
         CLI   FUNCSW,LABEL             LABEL FUNCTION           A50288 77285421
         BNE   FNDDN                    NO - INVALID PARAM     @ZA24160 77285899
TSTLNG   EQU   *                                                 A50288 77286221
         CH    GR2,FIVE                 TODD FRO 2321            A50288 77286621
         BE    TSTCHAR                  YES, OFFLINE 2321        A50288 77287021
         CH    GR2,THREE                TODD FOR DASD            A50288 77287421
         BNE   INVALP1                  NO                       A50288 77287821
TSTCHAR  EQU   *                                                 A50288 77288221
         TM    0(GR1),X'F0'             1ST CHAR NUMERIC         A50288 77288621
         BO    SPECIALA                 YES                      A50288 77289021
         CLI   0(GR1),C'F'              1ST CHAR ALPHA F         A50288 77289421
         BNH   SPECIALA                 IF CHANNEL A-F, BRCH     A50288 77289821
         B     INVALP1                  BAD TODD PARAM           A50288 77290221
FNDDN    EQU   *                                                 A50288 77290621
         LA    GR3,8                    RESET MAX PARAM LENGTH   A50288 77291021
         TM    SW1,SPEC1               PREVIOUS UNLABELED REQUEST.      77291421
         BO    INVALP1                 YES-INVALID PARAMETER.           77291821
         CLR   GR2,GR3                 IS THE LENGTH VALID.             77292221
         BCTR  GR2,0                   DECREMENT LENGTH BY ONE.         77292621
         BH    INVALPAR                YES-INVALID PARAMETER.           77293021
         CLI   0(GR4),BLANK            YES-ANY PROCESSED PRIOR.         77293421
         BNE   GETCOPY                 YES-GO BUILD A COPY BLOCK.       77293821
MOVEP    EX    GR2,PMOVE               NO--MOVE DDNAME TO FUNCTION BLK. 77294221
         B     SCAN3                   CONTINUE SCAN OF CARD.           77294621
*                                        PARAMETERS OR OTHER KEYWORDS.  77295021
         SPACE                                                          77295421
SPECIAL  EQU   *                                                        77295821
         CLI   FUNCSW,ANALYSIS         THIS AN ANALYZE FUNCTION.        77296221
         BE    SPECIALA                YES-VALID PARAMETER.        O122 77296621
         CLI   FUNCSW,LABEL            THIS A LABEL FUNCTION.      O122 77297021
         BNE   INVALP1                 NO--INVALID PARAMETER.           77297421
SPECIALA EQU   *                                                   O122 77297821
         CLI   DDNAME2,BLANK           ANY DDNAMES PROCESSED PRIOR.     77298221
         BNE   INVALP1                 YES-INVALID PARAMETER.           77298621
         STC   GR2,WURK                SAVE THE LENGTH.                 77299021
         BCTR  GR2,0                   DECREMENT FOR EXECUTE.           77299421
         CLI   WURK,3                   ACTUAL LENGTH EQUAL 3.          77299821
         BE    ALLSET                  PARAMETER IS OKAY.               77300221
         CLI   3(GR1),C'/'             FOURTH BYTE A SLASH.             77300621
         BNE   INVALPAR                 NO--MUT BE INVALID PARAMETE@.   77301099
         CLI   WURK,5                   ACTUAL LENGTH EQUAL 5.          77301399
         BNE   INVALPAR                NO--MUST BE INVALID PARAMETE@.   77301699
         TM    4(GR1),X'F0'            VALID BIN NO.                    77302221
         BZ    INVALPAR                NO--INVALID PARAMETER.           77302621
ALLSET   EQU   *                                                        77303021
         TM    SW1,SPEC1               PREVIOUS UNLABELED REQUEST.      77303421
         BO    GETCOPY                 YES-GO BUILD A COPY BLOCK.       77303821
         OI    SW1,SPEC1               NO--GO INDICATE OFF-LINE REQUEST 77304221
ALLSET1  LA    GR4,1(GR4)              PARAMETER MOVE TO ADDRESS.       77304621
         B     MOVEP                   GO STORE THE PARAMETER.          77305021
OLDLANAL CLI   FUNCSW,RESTORE          IS THIS DUMP OR RESTORE.         77305421
         BH    INVALKEY                NO--INVALID KEYWORD.             77305821
         BAL   GR9,SCAN                GO SCAN FOR PARAMETER.           77306221
         CLC   0(2,GR1),NO             IS PARAMETER A 'NO'.             77306621
         BE    SCAN3                   YES-CONTINUE SCAN OF CARD.       77307021
         CLC   0(3,GR1),YES            IS PARAMETER A YES.              77307421
         BNE   INVALP1                 NO--MUST BE INVALID PARAMETER.   77307821
         OI    SEQSW,CPYVOLID          INDICATE MUST USE NEW SERIAL NO. 77308221
         B     SCAN3                   CONTINUE SCAN OF CARD.           77308621
         SPACE                                                          77309021
NEWLANAL CLI   FUNCSW,LABEL            THIS FORMAT/ANALYZE/LABEL.       77309421
         BL    INVALKEY                NO--INVALID KEYWORD.             77309821
         OI    SEQSW,NEWVOLID          INDICATE NEWVOLID KEYWORD.       77310221
         OI    DELIMIN,NEWVOLID         ''  NEWVOLID KEYWORD   @ZA07400 77310340
         BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETERS    77310621
         MVI   SERNO,BLANK             BLANK 1ST BYTE.                  77311021
         MVC   SERNO+1(5),SERNO        INSURE PADDED WITH BLANKS.       77311421
         LA    GR4,SERNO               ADDRESS TO MOVE IN SERIAL NO.    77311821
         LA    GR3,6                   LENGTH COMPARE CONSTANT.         77312221
         CLR   GR2,GR3                 IS THE LENGTH VALID.             77312621
         BCTR  GR2,0                   DECREMENT FOR EXECUTE.           77313021
         BH    INVALPAR                NO--INVALID LENGTH.              77313421
MOVEP1   EX    GR2,PMOVE               MOVE PARAMETER TO FUNCTION BLOCK 77313821
         B     SCAN3                   CONTINUE SCAN OF CARD.           77314221
         SPACE                                                          77314621
VTOCANAL CLI   FUNCSW,ANALYSIS         IS THIS FORMAT OR ANALYZE.       77315021
         BL    INVALKEY                NO--INVALID KEYWORD.             77315421
         OI    SEQSW,VTOC              INDICATE VTOC KEYWORD.           77315821
         LA    GR4,FVTOCPTR+4          ADDRESS TO STORE PARAMETER.      77316221
         LA    GR3,5                   COMPARE CONSTANT.                77316621
VTOC1    BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETER.    77317021
         NI    DELIMIN,X'FD'       TURN OFF .- SWITCH            A27508 77317421
         CLR   GR2,GR3                 IS THE LENGTH VALID.             77327421
         BCTR  GR2,0                   DECREMENT FOR EXECUTE.           77329421
         BH    INVALPAR                NO--INVALID LENGTH.              77331421
         CLI   OWNID+9,BLANK           IS THIS AN OWNERID REQUEST.      77331821
         BE    VTOC1A                  YES-BYPASS DIGIT TEST.           77332221
         BAL   GR14,TESTDEC            GO TEST FOR ALL DECIMAL DIGITS.  77332621
VTOC1A   SR    GR4,GR2                 SUBTRACT LENGTH FOR RIGHT ADJUST 77332721
         B     MOVEP1                  PROCESS PARM//CONTINUE SCAN.     77334021
         SPACE                                                          77336021
EXTNANAL CLI   FUNCSW,ANALYSIS         IS THIS FORMAT OR ANALYZE        77336421
         BL    INVALKEY                NO--INVALID KEYWORD.             77336521
         OI    SEQSW,EXTENT            INDICATE EXTENT KEYWORD          77339421
         LA    GR4,FEXTENT+4           ADDRESS TO STORE PARAMETER.      77341421
         LA    GR3,5                   LENGTH COMPARE CONSTANT.         77343421
         B     VTOC1                   GO PROCESS THE PARAMETER.        77343821
         SPACE                                                          77344221
FLAGANAL CLI   FUNCSW,ANALYSIS         IS THIS AN ANALYSIS FUNCTION.    77344621
         BNE   INVALKEY                NO--INVALID KEYWORD.             77345021
         BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETER.    77345121
         CH    GR2,THREE               IS THE LENGTH VALID.             77347221
         BH    INVALP1                 NO--MUST BE INVALID PARAMETER.   77349221
         CLC   0(3,GR1),YES            IS PARAMETER A 'YES'.            77351221
         BE    SCAN3                   YES-CONTINUE SCAN OF CARD.       77351621
         CLC   0(2,GR1),NO             IS PARAMETER A 'NO'.             77354321
         BNE   INVALP1                 NO--MUST BE INVALID PARAMETER.   77356321
         OI    SEQSW,FLAGTEST          YES-SET INDICATOR/NO FLAGTEST.   77358321
         B     SCAN3                   CONTINUE SCAN OF CARD.           77358721
SS1CODE  EQU   *                                               @Y30LSFY 77358803
         OI    SEQSW+K1,SS1VAL          INDIC SS1 PARM SUPPLIED@Y30LSFY 77358903
         CLI   FUNCSW,ANALYSIS          ANALYSIS SWITCH        @Y30LSFY 77359003
         BNE   INVALKEY                 NO, EXIT WITH ERROR    @Y30LSFY 77360603
         L     GR3,STORGR3              GET LAST COLUMN SCANNED@Y30LSFY 77361103
         BCTR  GR3,GR0                  BACK UP ONE COLUMN     @Y30LSFY 77361603
         CLI   K0(GR3),BLANK            IS COLUMN BLANK        @Y30LSFY 77362103
         BE    CONTIN                   YES-CHECK FOR CONT.    @Y30LSFY 77362603
         L     GR3,STORGR3              LOAD NEXT KEYWORD ADDR @Y30LSFY 77370603
         B     KEYWD                    CONTINUE SCAN          @Y30LSFY 77377803
         SPACE                                                          77379203
PASSANAL CLI   FUNCSW,ANALYSIS         IS THIS AN ANALYSIS FUNCTION.    77379603
         BNE   INVALKEY                NO--INVALID KEYWORD.             77381203
         OI    SEQSW,PASSES            INDICATE PASSES KEYWORD.         77382803
         BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETER.    77384403
         CH    GR2,THREE               IS THE PARAMETER LENGTH VALID.   77386003
         BCTR  GR2,0                   DECREMENT FOR EXECUTE.           77387603
         BH    INVALPAR                NO--INVALID PARAMETER.           77389203
         BAL   GR14,TESTDEC            GO TEST FOR ALL DECIMAL DIGITS.  77390803
         XC    WURK(8),WURK            CLEAR WORK SLOT.                 77392403
         LA    GR4,WURK+7              ADDREES TO MOVE IN PARAMETER.    77394003
         SR    GR4,GR2                 SET ADDRESS FOR RIGHT ADJUST.    77395603
         EX    GR2,PMOVE               MOVE PARAMETER TO WORK SLOT.     77397203
         PACK  WURK(8),WURK+4(4)       REMOVE THE ZONES.                77398803
         CVB   GR4,WURK                CHANGE TO BINARY.                77400403
         CH    GR4,TWO56               IS COUNT MORE THAN 255.          77402003
         BNL   INVALPAR                YES-INVALID PARAMETER.           77403603
         STH   GR4,PASSCNT             NO--STORE IN FUNCTION BLOCK.     77405203
         STH   GR4,COUNT               ALSO SET CURRENT COUNT.          77406803
         B     SCAN3                   CONTINUE SCAN OF CARD.           77408403
         SPACE                                                          77410003
IPLDANAL CLI   FUNCSW,ANALYSIS         IS THIS ANALYZE OR FORMAT.       77411603
         BL    INVALKEY                NO--INVALID KEYWORD.             77413203
         OI    SEQSW,IPLDD             INDICATE IPLDD KEYWORD.          77414803
         MVC   WORKD8(8),DDNAME2       SAVE TODD PARAMETER.      A32162 77416403
         LA    GR4,DDNAME1             ADDRESS TO STORE IPLDD DDNAME.   77418003
         B     GETPARM1                GO PROCESS THE PARAMETER.        77419603
         SPACE                                                          77421203
         SPACE                                                          77422803
BEGNANAL CLI   FUNCSW,DUMP             THIS A DUMP/REST FUNCT  @ZM42083 77424403
         BNE   INVALKEY                NO--INVALID KEYWORD.             77425403
         OI    SEQSW,BEGIN             INDICATE BEGIN KEYWORD SPECIFIED 77427603
         LA    GR5,CCHHBEG             PARAMETER TARGET ADDRESS.        77429203
         B     PROCTRAK                GO PROCESS THE PARAMETER.        77430803
         SPACE                                                          77432403
ENDDANAL CLI   FUNCSW,DUMP             THIS A DUMP/REST FUNCT  @ZM42083 77434003
         BNE   INVALKEY                NO--INVALID KEYWORD.             77435003
         OI    SEQSW,END               INDICATE END ADDRESS KEYWORD     77437203
         LA    GR5,CCHHEND             PARAMETER TARGET ADDRESS.        77438803
         B     PROCTRAK                GO PROCESS THE PARAMETER.        77440403
         SPACE                                                          77442003
OWNRANAL CLI   FUNCSW,LABEL            THIS FORMAT/ANALYZE/LABEL.       77443603
         BL    INVALKEY                NO--INVALID KEYWORD.             77445203
         OI    SEQSW,OWNERID           INDICATE OWNER KEYWORD SPEC.     77446803
         LA    GR3,10                  LENGTH COMPARE CONSTANT.         77448403
         OI    DELIMIN,X'02'       TELL SCAN THAT '.' AND '-' OK A27508 77450003
         MVI   OWNID,BLANK             BLANK FIRST BYTE.                77451603
         MVC   OWNID+1(9),OWNID        INSURE PADDED WITH BLANKS.       77453203
         LA    GR4,OWNID+9             ADDRESS TO STORE PARAMETER-      77454803
*                                        RIGHT ADJUSTED.                77456403
         B     VTOC1                   GO PROCESS PARAMETER.            77458003
         SPACE                                                          77459603
TRACANAL CLI   FUNCSW,GETALT           IS THIS A GET ALT FUNCTION       77461203
         BNE   INVALKEY                NO--INVALID KEYWORD.             77462803
         OI    SEQSW,TRACK             INDICATE TRACK KEYWORD PRESENT.  77464403
         LA    GR5,GTRACK              PARAMETER TARGET ADDRESS.        77466003
PROCTRAK LA    GR4,WURK                ADDRESS OF WORK SLOT.            77467603
         BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETER.    77469203
         CH    GR2,EIGHT               IS LENGHT EIGTH.                 77470803
         BCTR  GR2,0                   DECREMENT FOR EXECUTE.           77472403
         BNE   INVALPAR                NO--INVALID PARAMETER.           77474003
         EX    GR2,PMOVE               MOVE PARAMETER TO WORK SLOT.     77475603
         OC    WURK(8),CTOEMASK        CHANGE ALL C ZONES TO E.         77477203
         TR    WURK(8),ALTTT-225       CONVERT TO HEX.                  77478803
         PACK  0(5,GR5),WURK(9)        REMOVE ZONES.                    77480403
         B     SCAN3                   CONTINUE SCAN OF CARD.           77482003
         SPACE                                                          77483603
PURGANAL EQU   *                       PROCESS PURGE KEYWORD HERE.      77485203
         CLI   FUNCSW,RESTORE          IS THIS DUMP OR RESTORE.         77486803
         BNH   PURGE1                  YES--A/OK.                       77488403
         CLI   FUNCSW,ANALYSIS         IS THIS FORMAT OR ANALYZE        77490003
         BL    INVALKEY                NO--INVALID KEYWORD.             77491603
PURGE1   BAL   GR9,SCAN                RETURN TO SCAN FOR PARAMETER.    77493203
         CH    GR2,THREE               IS THE LENGTH VALID.             77494803
         BH    INVALP1                 NO--MUST BE INVALID PARAMETER.   77496403
         CLC   0(2,GR1),NO             IS PARAMETER A 'NO'.             77498003
         BE    SCAN3                   YES-RETURN TO SCAN.              77499603
         CLC   0(3,GR1),YES            IS PARAMETER A 'YES'.            77501203
         BNE   INVALP1                 NO--MUST BE INVALID.             77502803
         OI    SEQSW+1,PURGE           INDICATE PURGE REQUESTED.        77504403
         B     SCAN3                   CONTINUE SCAN OF CARD.           77506003
         SPACE 1                                                        77506103
         SPACE                                                          77530903
TESTDEC  LA    GR15,1(GR2)             LENGTH OF PARAMETER.             77532303
         LR    GR3,GR1                 ADDRESS OF PARAMETER.            77533703
TESTDEC1 TM    0(GR3),X'F0'            THIS A DECIMAL DIGIT.            77535103
         BC    12,INVALPAR             NO--GO GIVE MESSAGE.             77536503
         LA    GR3,1(GR3)              STEP TO NEXT DIGIT.              77537903
         BCT   GR15,TESTDEC1           CHECK MORE DIGITS, IF ANY.       77539303
         BR    GR14                    RETURN.                          77540703
MSGPRT   EQU   *                                                        77542103
         TM    SW1,TEXTIN              ARE WE LOOKING FOR IPL TEXT.     77543503
         BO    NOIPLMSG                YES-GIVE PROPER MESSSAGE.        77544903
         LA    GR1,MESS0               MESSAGE NUMBER.                  77546303
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       77547703
         L     GR3,STORGR3             LAST ADDRESS SCANNED.            77549103
         LA    GR4,CARDBUFF            START OF CONTROL STATEMENT.      77550503
         SR    GR3,GR4                 NO. OF COLUMNS SCANNED.          77551903
         CVD   GR3,WURK                CONVERT TO DECIMAL               77553303
         UNPK  WURK(2),WURK+6(2)       UNPACK FOR PRINTING.             77554703
         OI    WURK+1,X'F0'            SET PROPER ZONE.                 77556103
         TR    WURK(2),IOTAB-240       CONVERT TO EBCDIC FOR PRINTING.  77557503
         MVC   0(2,GR1),WURK           PLACE ANSWER IN MESSAGE.         77558903
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        77560303
         SPACE                                                          77561703
INVALCOM LA    GR1,MESS1               MESSAGE NUMBER 801.              77563103
INV1     BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       77564503
         MVC   0(8,GR1),WURK           MOVE INVALID PORTION TO MESSAGE. 77565903
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        77567303
INVALKEY LA    GR1,MESS2               MESSAGE NUMBER 802.              77568703
         B     INV1                    BUILD AND WRITE OUT THE MESSAGE. 77570103
INVALP1  BCTR  GR2,0                   DECREMENT LENGTH FOR EXECUTE.    77571503
INVALPAR LR    GR5,GR1                 SAVE ADDRESS OF PARAMETER.       77572903
         LA    GR1,MESS3               MESSAGE NUMBER 803.              77574303
         BAL   GR9,BUILD               GO BUILD THE MESSAGE.            77575703
         LR    GR4,GR1                 ADDRESS TO MOVE IN PARAMETER.    77577103
         LR    GR1,GR5                 ADDRESS OF PARAMETER.            77578503
         EX    GR2,PMOVE               PARAMETER TO OUTPUT BUFFER.      77579903
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        77581303
         SPACE                                                          77582703
KEYMISS  LA    GR1,MESS4               MESSAGE NUMBER 804.              77584103
         BAL   GR9,BUILD               GO MOVE MESSAGE TO BUFFER.       77585503
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        77586903
*   BUILD ALL MESSAGES HERE.                                            77588303
BUILD    LINK  EP=IEHDMSGB                                              77589703
         BR    GR9                     RETURN.                          77591103
NOIPL    MVI   SWITCHRD,EOF            INDICATE EOF ENCOUNTERED.        77592503
NOIPLMSG LA    GR1,MESS26              MESSAGE NUMBER 826.              77593903
         NI    SW1,X'FF'-TEXTIN        INSURE SWITCH IS OFF.            77595303
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         77596703
         MVC   0(8,GR1),WORKD8         DDNAME TO MESSAGE.        A32162 77598103
         B     MSGWRT2                 GO WRITE OUT THE MESSAGE.        77599503
*   KEYWORD LOOKUP TABLE                                                77600903
         DS    0F                                                       77602303
KEYTAB   DC    C'TODD    '             TABLE OF VALID KEYWORDS.         77603703
         B     TODDANAL                ADDRESS OF KEYWORD ANALYSIS.     77605103
         DC    C'FROMDD  '                                              77606503
         B     FROMANAL                                                 77607903
         DC    C'NEWVOLID'                                              77609303
         B     NEWLANAL                                                 77610703
         DC    C'VTOC    '                                              77612103
         B     VTOCANAL                                                 77613503
         DC    C'EXTENT  '                                              77614903
         B     EXTNANAL                                                 77616303
         DC    C'FLAGTEST'                                              77617703
         B     FLAGANAL                                                 77619103
         DC    C'PASSES  '                                              77620503
         B     PASSANAL                                                 77621903
         DC    C'IPLDD   '                                              77623303
         B     IPLDANAL                                                 77624703
         DC    C'CPYVOLID'                                              77626103
         B     OLDLANAL                                                 77627503
         DC    C'BEGIN   '                                              77628903
         B     BEGNANAL                                                 77630303
         DC    C'END     '                                              77631703
         B     ENDDANAL                                                 77633103
         DC    C'OWNERID '                                              77634503
         B     OWNRANAL                                                 77635903
SSICODE  DC    C'MSS     '                                     @Y30LSFY 77640103
         B     SS1CODE                                         @Y30LSFY 77641503
         DC    C'PURGE   '                                              77642903
         B     PURGANAL                                                 77644303
KEYEND   DC    C'TRACK   '                                     @ZM42083 77645703
         B     TRACANAL                                                 77647103
         EJECT                                                          77651303
*  EQUATE DEFINITIONS                                                 * 77654121
         SPACE 1                                                        77669421
K0       EQU   0                       DISPLACEMENT CONSTANTS.          77684721
K1       EQU   1                                                        77700020
K2       EQU   2                                                        77750021
K3       EQU   3                                                        77800021
K4       EQU   4                                                        77900020
K5       EQU   5                                                        77950021
K6       EQU   6                                                        78000021
K7       EQU   7                                                        78100020
K8       EQU   8                                                        78300020
K9       EQU   9                                                        78500020
K10      EQU   10                                                       78700020
K11      EQU   11                                                       78900020
K12      EQU   12                                                       79100020
K15      EQU   15                                                       79300020
K16      EQU   16                                                       79500020
K24      EQU   24                                                       79550021
K32      EQU   32                                                       79700020
K80      EQU   80                                                       79900020
K225     EQU   225                                                      79950021
K240     EQU   240                                                      80000021
X01      EQU   X'01'                                                    80050021
X02      EQU   X'02'                                                    80060021
XF0      EQU   X'F0'                                                    80070021
X80      EQU   X'80'                                                    80100020
ALL      EQU   140                                                      80300020
COL72    EQU   72                                                       80500020
COL71    EQU   71                                               SA54610 80550002
SSILN    EQU   3                        LENGTH OF SSI PARAM    @Y30LSFY 80600003
BLANK    EQU   X'40'                   HEX FOR BLANK SPACE.             80700020
BPAREN   EQU   X'11'                   SW SETTING FOR BOTH PAREN.       80900020
COMMA    EQU   C','                    HEX FOR COMMA.                   81100020
EQUAL    EQU   C'='                    HEX FOR EQUAL.                   81300020
GOOD     EQU   X'7F'                   RESET ERROR SWITCH VALUE.        81500020
LPAREN   EQU   C'('                    HEX FOR LEFT PAREN.              81700020
NEWVOLIS EQU   X'80'                   SW SETTING FOR NEWVOLID.         81900021
ON       EQU   X'FF'                   FIRST ENTRY SWITCH VALUE.        82100020
ONE      EQU   X'01'                   BYTE OFF SETTING.                82300020
OWNERIS  EQU   X'02'                   SW SETTING FOR OWNERID.          82500021
PRIME    EQU   X'7D'                   HEX FOR PRIME (').               82700020
RPAREN   EQU   C')'                    HEX FOR RIGHT PAREN.             82900020
TODDS    EQU   X'01'                   SW SETTING FOR TODD.             83100021
ZERO     EQU   X'00'                   CLEAR SWITCH SETTING.            83300020
         SPACE 2                                                        83500020
*  WORKAREA AND TABLES                                                * 83700020
         SPACE 1                                                        83900020
CLEAR    DC    CL15' '                 CONTINUATION BYTE CHECK.         84100020
COMCD    DC    X'00'                 SWITCH FOR CONTINUED CONTROL CARD. 84300020
SCANSAVE DS    18F                     CALLED PROGRAM SAVE AREA         84500020
TAB      DS    0D                      ARGUMENT TABLE                   84700020
         DC    91X'01'                                                  84900020
         DC    X'00'                                                    85100020
         DC    31X'01'                                                  85300020
         DC    2X'00'                                                   85500020
         DC    68X'01'                                                  85700020
         DC    9X'00'                                                   85900020
         DC    7X'01'                                                   86100020
         DC    9X'00'                                                   86300020
         DC    8X'01'                                                   86500020
         DC    8X'00'                                                   86700020
         DC    22X'01'                                                  86900020
DEC      EQU   TAB+240                 NUMERIC FIELD.                   87100020
TABSL    EQU   TAB+97                  SLASH BYTE.                      87300020
TABHY    EQU   TAB+96                  HYPHEN BYTE.              A61555 87500001
TABPR    EQU   TAB+75                  PERIOD BYTE.                     87700020
* CONSTANTS AND EQUATES ETC. MOVED FROM DASDS IN THE REPACK             87710021
PMOVE    MVC   0(1,GR4),0(GR1)          MOVE DDNAME PARAMETERS          87720021
CHKTODD  CLC   4(0,GR15),0(GR1)         COMPARE DDN                     87730021
TWO56    DC    H'256'                   COMPARE CONSTANT                87740021
EIGHT    DC    H'8'                     COMPARE CONSTANT                87741003
THREE    DC    H'3'                     COMPARE CONSTANT                87744021
FIVE     DC    H'5'                     COMPARE CONSTANT                87746021
SAVLGTH  DS    1C                                                       87748021
YES      DC    C'YES'                                                   87748421
NO       DC    C'NO'                                                    87748821
CTOEMASK DC    X'2020202020202020'      USED TO CHANGE ZONES            87749221
ALTTT    DC    X'0A0B0C0D0E0FDDDDDD'    TABLE - CONVERT TO HEX          87749621
         DC    X'DDDDDDDDDDDD'                                          87749721
         DC    X'00010203040506070809'                                  87749821
IOTAB    DC    C'0123456789ABCDEF'      TRANSLATE TABLE                 87749921
* THE FOLLOWING ARE USED TO SET UP VALUES FOR BRANCHING IN DASDS        87751921
GONORM   EQU   X'00'                    DO NORMAL DASDS INSTRUCTIONS    87759921
GOCHECK  EQU   X'04'                    GO SEE IF FINISHED              87761921
GOSCAN1  EQU   X'08'                    START PROCESSING                87763921
GOOPRL   EQU   X'0C'                    TEST COMMAND VALIDITY           87765921
GOCOPY   EQU   X'10'                    PROCESS TODD COPIES             87766321
GOWRT2   EQU   X'14'                    GO WRITE MESSAGE                87766421
*                                                                       87766521
MESS0    EQU   0                        MESSAGE NUMBER 800              87766621
MESS1    EQU   1                        MESSAGE NUMBER 801              87776621
MESS2    EQU   2                        MESSAGE NUMBER 802              87778621
MESS3    EQU   3                        MESSAGE NUMBER 803              87780621
MESS4    EQU   4                        MESSAGE NUMBER 804              87782621
MESS26   EQU   26                       MESSAGE NUMBER 826              87783021
SCANADR  EQU   1                        REGISTER ASSIGNMENT             87783121
LENGT2   EQU   2                        CALLED LENGTH IN DASDS          87792621
*                                                                       87802521
         SPACE 2                                                        87831021
         IEHDBLKS                                                       87840521
         SPACE 2                                                        87850021
CVT      DSECT                                                          87860021
         CVT   SYS=MIN                                                  87870021
         SPACE 2                                                        87900020
         IEHDWORK                                                       88100020
         DCBD  DSORG=PS                                                 88300020
         END                                                            88500020
$ END                                                                   88700020
./  ADD  SSI=70880151,NAME=IEHDVTOC
         TITLE  'IEHDVTOC  VTOC CONSTRUCTION MODULE'                    00100016
         COPY  LCGASMSW                                          SM4351 00150021
IEHDVTOC CSECT                                                          00200016
*A 039182,208,478040                                           @VS40037 00201003
* SCAN ALTERN. TRKS WHEN BUILDING ONLINE VTOC.                 @VS40452 00201503
* FIX @VS40452 PROBLEM.                                        @ZA06534 00202503
*D 418000,419000                     NOT OS  @YA04836=@XA05835=@ZA01205 00203502
*A 417400,417500                     NOT OS  @YA04836=@XA05835=@ZA01205 00205502
***************************************************************@ZA01205 00205902
*3506487000,488000,498400,600700                                 M2888  00207202
* 040004-040005                                                  YM0911 00208802
*        RELEASE 23 DELETIONS                                         * 00210402
*                                                               XM4389  00212002
*        RELEASE 22 DELETIONS                                         * 00213602
*        RELEASE 21 DELETIONS                                         * 00215202
*                                                                Y21107 00216802
*        RELEASE 20 DELETIONS                                         * 00218402
*3506055000-056000,065100-066100,482000,487000,498100-498700,    S20201 00220002
*3506577500,579500,582500-583500,600700,604000,613500            S20201 00221602
*3506479500                                                      M5900  00223202
*3506064300-069000,479000,583000,601000,605000                   JUDITH 00224802
*3506240880                                                      A32162 00226402
*3506039009                                                      A35837 00228002
*3506063000-064000,482000,487000,494000                          A34946 00229602
*3506039009,039252,039255,039258,039261,039360,039432,039435,    S20201 00231202
*3506039477                                                      S20201 00232802
*3506479460-479520                                               M6129  00234402
*        RELEASE 19 DELETIONS                                           00236002
*037000,448000-449900                                            O122   00237602
*        RELEASE 18 DELETIONS                                           00239202
*3109417600                                                      3649   00240802
*                                                                       00242402
*STATUS CHANGE LEVEL 004                                                00244002
*                                                                     * 00245602
*FUNCTION/OPERATION- THIS ROUTINE FORMATS THE VTOC,WRITES VOLUME      * 00247202
*   LABEL,IPL TEXT AND IPL BOOTSTRAP RECORDS. IT ALSO READS IPL TEXT  * 00248802
*   FROM EXTERNAL STORAGE WHEN SO REQUESTED.                          * 00250402
*   THIS ROUTINE FORMATS THE VTOC BY WRITING A FORMAT 4 DSCB THAT     * 00252002
*   DESCRIBES THE DEVICE CHARACTERISTICS OF THIS VOLUME. IT ALSO      * 00253602
*   CALCULATE THE TRACKS AVAILABLE FOR ALLOCATION AND CONSTRUCTS      * 00255202
*   A FORMAT 5 DSCB FROM THIS CALCULATION. THESE TWO DSCB ARE WRITTEN * 00256802
*   AND THE REMAINDER OF THE VTOC WITH FORMAT 0 DSCBS.                * 00258402
*                                                                     * 00260002
*ENTRY POINT- THE ONLY ENTRY POINT IS -IEHDVTOC- AND THIS MODULE IS   * 00261602
*   INVOKED ONLY BY IEHDANAL.                                         * 00263202
*                                                                     * 00264802
*INPUT- UPON ENTRY REGISTER 1 POINTS TO IEHDANAL WORKAREA,REGISTER 10 * 00266402
*   POINTS TO A FUNCTION BLOCK, REGISTER 12 POINTS TO A COMMUNCIATION * 00268002
*   WORKAREA,REGISTER 13 HAS A POINTER TO A REGISTER SAVE AREA,AND    * 00269602
*   REGISTER 14 CONTAIN A RETURN ADDRESS.                             * 00271202
*                                                                     * 00272802
*EXITS-NORMAL- ON  SUCCESSFUL COMPLETION -IEHDVTOC- RETURNS TO        * 00274402
*   -IEHDANAL- WITH A RETURN CODE OF 0 IN REGISTER 15.                * 00276002
*                                                                     * 00277602
*EXITS-ERROR- ON UNSUCCESSFUL COMPLETION -IEHDVTOC- RETURNS TO        * 00279202
*    -IEHDANAL- WITH A RETURN CODE OF 8 IN REGISTER 15 AND A MESSAGE  * 00280802
*    DESCRIBING THE ERROR IN THE MESSAGE DATA SET.                    * 00282402
*                                                                     * 00284002
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS INVOKED BY -IEHDANAL-.     * 00285602
*    IT IN TURNS INVOKES IEHDMSGB AND IEHDPRNT TO CONSTRUCT AND WRITE * 00287202
*    MESSAGES INTO THE MESSAGE DATA SET.                              * 00288802
*                                                                     * 00290402
*TABLES/WORKAREA- UPON ENTRY REGISTERS 1,10 AND 12 POINT TO  IEHDANAL * 00292002
*    WORKAREA,FUNCTION BLOCK AND A COMMUNICATION WORKAREA RESPECT-    * 00293602
*    IVELY. THEY ARE DESCRIBED BY DSECTS CALLED WORKAREA,FUNCBLK AND  * 00295202
*    WORK.                                                            * 00296802
         SPACE 3                                                        00298402
REG0     EQU   0                  PARAMETER REG.                        00300016
REG1     EQU   1                  PARAMETER LIST POINTER REG.           00400016
REG2     EQU   2                  REGS                                  00500016
REG3     EQU   3                       TWO                              00600016
REG4     EQU   4                           THRU                         00700016
REG5     EQU   5                                SEVEN                   00800016
REG6     EQU   6                                      WORK              00900016
REG7     EQU   7                                           REGS.        01000016
REG8     EQU   8                  PROGRAM BASE REG.                     01100016
REG9     EQU   9                  COPY BLOCK BASE REG.                  01200016
REGA     EQU   10                 FUNCTION BLOCK BASE REG.              01300016
REGB     EQU   11                 WORK AREA BASE REG.                   01400016
REGC     EQU   12                 COMMON WORK AREA REG.                 01500016
REGD     EQU   13                 SAVE AREA POINTER REG.                01600016
REGE     EQU   14                 RETURN ADDRESS REG/UCB BASE REG.      01700016
REGF     EQU   15                 ENTRY POINT REG.                      01800016
         USING IHADCB,REG7                                              01900016
         USING *,REG8                                                   02000016
         USING WORKAREA,REG5                                   @Y30LSFY 02100003
         USING FUNCBLK,REGA                                             02200016
         USING COPYBLK,REG9                                             02300016
         USING WORK,REGC                                                02400016
         USING UCBOB,REG6                                               02500016
         USING CONSTANT,REGE                                            02600016
         SAVE  (14,12),T,*        SAVE REGISTERS IN CALLER'S AREA       02700016
         LR    REG8,REGF          ESTABLISH PROGRAM BASE REGISTER.      02800016
         LR    REG5,REG1          ESTABLISH BASE FOR WORKAREA. @Y30LSFY 02900003
         LA    REGF,SAVEVTOC                                            03000016
         ST    REGF,8(REGD)       SAVE POINTER TO IEHDVTOC SAVE AREA.   03100016
         LA    REG7,FBLOCKS                                             03300016
         ST    REGD,SAVEVTOC+4     STORE PTR TO YOUR SAVEAREA IN MINE.  03400016
         LR    REGD,REGF               POINT TO MY SAVEAREA.   @Y30LSFY 03500003
         XC    DEXTNTS-D2(L6),DEXTNTS-D2  CLEAR BB OF BBCCHH.  @Y30LSFY 03550003
         L     REGE,IODEVCON           RESTORE DEV CONSTANT PTR@Y30LSFY 03600003
         STM   REG9,REG2,PRGSAVE       SAVE VOLATILE REGISTERS.@Y30LSFY 03650003
         LA    REG1,DDEB               POINT TO DUMMY DEB.     @Y30LSFY 03700003
         LA    REG2,RCD1CNT            POINT TO CCHH.          @Y30LSFY 03710003
         USING CVT,REGF                                        @Y30LSFY 03720003
         L     REGF,CVTPTR             GET CVT BASE.           @Y30LSFY 03730003
         XC    RCD1CNT(L8),RCD1CNT                             @Y30LSFY 03740003
         MVC   RCD1CNT+D3(L4),LASTORIG SET UP MBBCCHHR.        @Y30LSFY 03742003
         L     REGF,CVTPRLTV           GET ENTRY TO CNVRT RTNE.@Y30LSFY 03744003
         BALR  REGE,REGF          LINK TO CONVERT ROUTINE.     @Y30LSFY 03746003
         SRL   REG0,16                                         @Y30LSFY 03748003
         STH   REG0,RTAVTOCS      SAVE RTA FOR IEHDVTOC.       @Y30LSFY 03748403
         LM    REG9,REG2,PRGSAVE  RESTORE VOLATILE REGISTERS.  @Y30LSFY 03748803
         DROP  REG5                                            @Y30LSFY 03749003
         USING WORKAREA,REGB                                   @Y30LSFY 03749203
         LR    REGB,REG5          REESTABLISH WORKAREA BASE    @Y30LSFY 03749403
         XC    ZEROS(5),ZEROS       INITIALIZE ZEROS.                   03750016
         NI    IPLTRK1,X'00'      TURN IPL TEXT ON TRACK 1 BIT OFF.     03800016
         L     REG6,TUCBPTR       GET POINTER TO PRIMARY UCB.           03900016
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 03901103
         BNE   NO3340                  NO, CHECK OTHER DEVICES.  XM5465 03901203
         MVI   PASSCNT+D1,ONE          FORCE ONE PASS ON 3340.   XM5465 03901303
         TM    SEQSW,FLAGTEST          IS FLAGTEST = NO?         XM5465 03901803
         BO    RDALTS                  YES, TEST FOR PASSES.   @ZA06534 03911803
NO3340   EQU   *                                                 XM5465 03918803
         TM    SEQSW+D1,SS1VAL         SS/1 CONVERSION?        @Y30LSFY 03925803
         BO    TEXTCHK                 YES - PASSES=1          @ZA06534 03932803
         CLI   UCBTBYT4,FACTPACK        IS THIS 3330 DEV TYPE?  XL03145 03939803
         BL    RDALTS                   NO, PASS COUNT IS OK.  @ZA06534 03946803
         CLI   FUNCSW,ANALYSIS         IS THIS AN ALNALYZE       A51175 03953803
         BNE   RDALTS                  NO                      @ZA06534 03960803
         CLI   UCBTBYT4,D3350          3350 DEVICE ?           @VS40037 03967803
         BE    RDALTS                  YES, BRCH               @ZA06534 03974803
         OI    SEQSW,PASSES            FORCE PASSES              A51175 03981803
         TM    FLGBYT1,EMU             EMULATION ACTIVE ?      @VS40037 03988803
         BO    RDALTS                  ALLOW PASSES            @ZA06534 03995803
         XC    PASSCNT(2),PASSCNT      ZERO PASSCNT AND COUNT    A51175 04002803
* SET UP CHANNEL PROGRAM TO READ HOME ADDRESS AND R0 OF            O122 04010402
*ALTERNATE TRACKS                                                  O122 04011202
RDALTS   EQU  *                                                @ZM43013 04012003
         LA    REG7,FBLOCKS             GET POINTER TO PRIMARY     O122 04012603
         DROP  REG6                                              S20201 04012802
         USING BUFFREAD,REG6                                     S20201 04013602
         L     REG6,FBUFFPTR                                     S20201 04014402
         L     REGE,IODEVCON            GET ADDRESS OF DEVICE      O122 04015202
         LA    REG4,COMND1              GET CCW AREA ADDR      @ZM43013 04015403
         ST    REG4,CCWPTR              UPDATE IOBCCW PTR      @ZM43013 04015603
*                                          CONSTANTS TABLE         O122 04016002
         L     REG3,LASTORIG            GET LAST PRIMARY TRACK ADDRO122 04016802
         A     REG3,CONVCYL             UPDATE TO FIRST ALTERNATE  O122 04017602
         ST    REG3,SKADDR              SAVE ADDRESS               O122 04018402
         MVC   SEEKADDR+3(4),SKADDR     STORE IT IN SEEK ADDRESS   O122 04019202
         XC    SEEKADDR+7(1),SEEKADDR+7 CLEAR R OF SEEK ADDRESS    O122 04020002
         MVC   NOALT(2),TOTALALT        SAVE MAXIMUM NUMBER ALTS   O122 04020802
         XC    TRKSW(1),TRKSW           SET SWITCH TO ZERO         O122 04021602
         LM    REG0,REG3,CCW01          LOAD READ CCW'S            O122 04022402
         ALR   REG0,REG6                ADJUST DISPLACEMENT        O122 04023202
         ALR   REG2,REG6                *                          O122 04024002
         STM   REG0,REG3,COMND1         STORE CCW'S                O122 04024802
         BAL   REG5,FACTCHK             READ FROM ALTERNATE TRACK  O122 04025602
         B     CHKALT                   CHECK ALTERNATE TRACK      O122 04026402
*                                                                  O122 04027202
FACTCHK  EQU   *                                                   O122 04028002
         EXCP  WKAIOB                   EXECUTE CHANNEL PROGRAM    O122 04028802
         WAIT  1,ECB=WKAECB             WAIT FOR I/O TO COMPLETE   O122 04029602
         CLI   WKAECB,X'7F'             I/O SUCCESSFUL             O122 04030402
         BE    GOOK                     YES, OK                    O122 04031202
         CLI   WKAECB,X'41'             CSW CONTENTS USEFUL IN IOB O122 04032002
         BNE   IOERROR2                 NO, PUT OUT MESSAGE        O122 04032802
         CLI   IOBCSWST,UE              UNIT EXCEPTION             O122 04033602
         BNE   IOERROR2                 NO, PUT OUT MESSAGE        O122 04034402
GOOK     BR    REG5                     RETURN                     O122 04035202
CHKALT   EQU   *                                                   O122 04036002
         TM    ALTHA,X'02'              IS TRACK DEFECTIVE         O122 04036802
         BO    UPDATE                   YES, UPDATE ALT TRACK      O122 04037602
*                                          INFORMATION             O122 04038402
         CLC   ALTHA+1(4),ALTR0         IS TRACK ASSIGNED          O122 04039202
         BNE   UPDATE                   YES, UPDATE ALT TRK INFO   O122 04040002
         TM    TRKSW,TRKFND             HAS FIRST AVAILABLE ALTER- O122 04040802
*                                          NATE BEEN FOUND         O122 04041602
         BO    UPCCHH                   YES, CHECK FOR LAST        O122 04042402
*                                          ALTERNATE TRACK         O122 04043202
         OI    TRKSW,TRKFND             SET SWITCH FOR FIRST AVAIL-O122 04044002
*                                          ABLE ALTERNATE FOUND    O122 04044802
         MVC   ALTINFO(4),ALTHA+1       SET ADDR OF FIRST          O122 04046402
*                                          AVAILABLE ALTERNATE     O122 04047202
UPCCHH   EQU   *                                                   O122 04048002
         CLC   ALTHA+1(4),LASTALT       WAS LAST ALTERNATE CHECKED O122 04048802
         BNL   CHKCOPY                  YES, CHECK FOR MORE COPIES O122 04049602
         MVC   SAVECCHH(4),ALTHA+1      GET CURRENT CCHH           O122 04050402
         L     REG3,SAVECCHH            *                          O122 04051202
         CLC   SEEKADDR+6(1),LASTORIG+3 LAST TRACK OF CYLINDER     O122 04052002
         BC    4,UPCCHH1                NO --                      O122 04052802
         A     REG3,CONVCYL             INCREMENT CYLINDER         O122 04053602
         AIF   ('&LIB' EQ 'LIB2').X227320                       XL03912 04054003
CK2321   EQU   *                                                   O122 04054402
         CLI   SEEKADDR+5,X'04'         IS THIS A 2321 AND LAST CYLO122 04055202
         BC    7,UPCCHH2                NO --                      O122 04056002
         AL    REG3,STC2321             INCREMENT STRIP            O122 04056802
         CLI   SEEKADDR+4,X'09'         THIS LAST STRIP            O122 04057602
         BC    7,UPCCHH2                NO --                      O122 04058402
         AL    REG3,SCC2321             INCREMENT SUBCELL          O122 04059202
.X227320 ANOP                                                   XL03912 04059603
         B     UPCCHH2                  STORE VALUE                O122 04060002
UPCCHH1  AH    REG3,HA1                 INCREMENT TO NEXT TRACK    O122 04060802
UPCCHH2  ST    REG3,SAVECCHH            STORE UPDATED CCHH         O122 04061602
         MVC   SEEKADDR+3(4),SAVECCHH   UPDATE SEEK ADDRESS        O122 04062402
         BAL   REG5,FACTCHK             READ HA AND R0 OF NEXT     O122 04063202
*                                          TRACK                   O122 04064002
         B     CHKALT                   CHECK ALTERNATE TRACK      O122 04064802
UPDATE   EQU   *                        UPDATE NUMBER ALTS AVAIL-  O122 04065602
*                                          ABLE                    O122 04066402
         LH    REG3,NOALT               PICK UP CURRENT NUMBER     O122 04067202
         SH    REG3,HA1                 DECREMENT BY 1             O122 04068002
         STH   REG3,NOALT               SAVE CURRENT NUMBER        O122 04068802
         B     UPCCHH                   CHECK FOR LAST ALT         O122 04069602
*                                                                  O122 04070402
*                                                                  O122 04071202
CHKCOPY  EQU   *                                                   O122 04072002
         TM    TRKSW,TRYCOPY            GET ADDRESS OF COPY BLOCK  O122 04072802
*                                          FROM FUNCTION BLOCK     O122 04073602
         BO    GETCOPY                  NO, GET FROM COPY BLOCK    O122 04074402
         OI    TRKSW,TRYCOPY            SET FOR PRIMARY COPY DONE  O122 04075202
         MVC   FALTDATA(6),ALTINFO      SAVE ALTERNATE TRACK       O122 04076002
*                                          INFORMATION             O122 04076802
         L     REG9,COPYPTR             PICK UP POINTER FOR COPY   O122 04077602
         B     CHKIT                    CHECK FOR POINTER          O122 04078402
GETCOPY  EQU   *                                                   O122 04079202
         MVC   CALTDATA(6),ALTINFO      SAVE ALTERNATE TRACK       O122 04080002
*                                          INFORMATION             O122 04080802
         L     REG9,CCOPYPTR            PICK UP POINTER FOR COPY   O122 04081602
*                                          ALTERNATES AVAILABLE    O122 04082402
CHKIT    EQU   *                                                   O122 04083202
         LTR   REG9,REG9                WAS THIS LAST COPY         O122 04084002
         BZ    GETREADY                 YES, RESET REGISTERS       O122 04084802
         LA    REG7,CIOBLOCK            GET POINTER TO I/O BLOCKS  O122 04085602
         MVC   SEEKADDR+3(4),SKADDR     UPDATE SEEK ADDR FOR COPY  O122 04086402
         XC    SEEKADDR+7(1),SEEKADDR+7    VOLUME                  O122 04087202
         MVC   NOALT(2),TOTALALT        REINITIALIZE NUMBER OF     O122 04088002
*                                          ALTERNATES              O122 04088802
         NI    TRKSW,X'FE'              TURN OFF BIT FOR FIRST     O122 04089602
*                                          AVAILABLE ALTERNATE     O122 04090402
         BAL   REG5,FACTCHK             START READING HOME ADDRESS O122 04091202
*                                          AND R0 FROM ALTERNATES  O122 04092002
         B     CHKALT                   GO CHECK ALTERNATE         O122 04092802
GETREADY EQU   *                                                   O122 04093602
         DROP REG6                                                 O122 04094402
         USING UCBOB,REG6                                          O122 04095202
TEXTCHK  EQU   *                                                   O122 04096002
         LA    REG7,FBLOCKS             RESTORE DCB ADDRESS        O122 04096802
         L     REG6,TUCBPTR             RESTORE UCB POINTER        O122 04097602
         LA    REG1,RCOUNT1N   PT. TO WAIT STATE RCD FOR NON-IPL   O122 04098402
         TM    SEQSW,IPLDD        IPL TEXT REQUESTED.                   04099202
         BZ    NONIPL             NO-BUILD NON-IPL RECORD.              04100016
         L     REGF,FIPLPTR       GET POINTER TO IPL TEXT FROM FUNCBLK. 04200016
         LTR   REGF,REGF          WAS IPL TEST POINTER SUPPLIED.        04300016
         BNZ   TESTDEV            YES-BUILD IPL RECORD.                 04400016
         MVI   FIPLPTR,X'80'      SET UP MY IPL POINTER INDICATOR.      04450016
         CLC   DDNAME1(8),SYSINDD IS IPL TEXT ENTERED THRU SYSIN.       04500016
         BNE   OPENIPL            NO-MUST READ IPL.                     04600016
         MVC   FIPLPTR+1(3),WIPLPTR+1  YES-MOVE PTR TO FUNCBLK.         04700016
TESTDEV  EQU   *                                                        04800016
         L     REG6,TUCBPTR       RESTORE UCB POINTER.                  04850016
         AIF   ('&LIB' EQ 'LIB2').X227321                       XL03912 04870003
         CLI   UCBID,X'FF'        IS THIS A 2321.                       04900016
         BNE   IPLWARN            YES- WARN USER IPL TEXT NOT ALLOWED.  05000016
.X227321 ANOP                                                   XL03912 05010003
         TM    UCBTBYT2,UCB2OPT3   DO WE HAVE CARNY              S20201 05020003
         BZ    NOCARN              NO                            S20201 05040020
         OI    SEQSW+D1,RPSS       YES                          XM4389  05060003
NOCARN   EQU   *                                                 S20201 05080020
         AIF   ('&LIB' EQ 'LIB2').X227322                       XL03912 05090003
         CLI   UCBTBYT4,X'04'         IS THIS A 2302.                   05100016
         BE    IPLWARN            YES- WARN USER IPL TEXT NOT ALLOWED.  05200016
         CLI   UCBTBYT4,X'02'         IS THIS A 2301.                   05300016
         BE    BLIPLRCD           YES-BUILD CCW FOR IPL ON TRACK 0.     05400016
         CLI   UCBTBYT4,X'06'           DEVICE CODE LESS THAN    S20201 05460020
*                                       2305                     S20201 05520020
         BL    IPLON1                   YES - IPLTEXT ON TRACK   S20201 05580020
*                                       ONE                      S20201 05640020
.X227322 ANOP                                                   XL03912 05670003
BLIPLRCD EQU   *                                                        05700016
         LA    REG1,RCOUNT1I      POINT TO IPLABLE RECORD 1.            05800016
         LA    REG7,FBLOCKS             GET ADDR OF I/O BLOCKS     O122 05850019
* RECORDS ONE THRU THREE ARE CONSTRUCTED HERE.                          05900016
NONIPL   EQU   *                                                        06000016
         MVI   VVTOCPTR,X'40'                                           06100016
         MVC   VVTOCPTR+1(69),VVTOCPTR BLANK VOL LABEL RESERVED FIELDS. 06200016
         MVC   RCD1CNT(36),0(REG1) MOVE RECORD1 TO OUTPUT AREA.  A34946 06270020
         MVC   RCD2CNT(44),RCOUNT2N MOVE RECORD2 TO OUTPUT AREA  A34946 06340020
         XC    IPLSEEK(16),IPLSEEK     CLEAR SEEK AND SEARCH ADDRS.9581 06410017
         MVC   RCD3CNT(16),RCOUNT3N COUNT KEY AND PART OF DATA   S20201 06610020
         MVC   VVTOCPTR(4),MBBCCHH1                                     07000016
         MVI   VVTOCPTR+4,1       INSERT POINTER TO VTOC INTO LABEL.    07100016
         MVC   VOLSERNO(6),FSERNO    ASSUME SAME VOLID-                 07200016
         MVI   VOLSECTY,X'F0'           SET SECURITY BYTE        S20201 07220020
         TM    SEQSW,NEWVOLID     TEST FOR NEW VOLID ID                 07300016
         BO    NUSERIAL           BRANCH IF NEW VOLID REQUESTED.        07360016
         L     REG6,TUCBPTR       PICK UP POINTER TO UCB.               07420016
         AIF   ('&LIB' EQ 'LIB2').X227323                       XL03912 07460003
         CLI   UCBID,X'FF'        IS THIS A 2321 DATA CELL.             07500016
         BNZ   DA2321             YES-GET VOLID FROM SUBUCB.            07600016
.X227323 ANOP                                                   XL03912 07650003
         MVC   VOLSERNO(6),SRTEVOLI    INSERT OLD VOLID INTO LABEL.     07700016
NUSERIAL EQU   *                                                        07800016
         TM    SEQSW,OWNERID      OWNER IDENTIFICATION REQUESTED.       07900016
         BZ    BLDCCWS            NO-BRANCH AND BUILD CHANNEL PROGRAM.  08000016
         MVC   VOLOWNER(10),FOWNID PLACE OWNER ID INTO VOLUME LABEL.    08100016
BLDCCWS  EQU   *   HERE WE CONSTRUCT THE CHANNEL PROGRAM TO WRITE       08200016
*                  TRACK ZERO RECORDS 1 THRU 3. WE ASSUME NO-IPL TEXT   08300016
*                  WAS REQUESTED                                        08400016
         LM    REG0,REG5,CCW1     GET THE FIRST THREE CCWS.             08500016
         ALR   REG0,REGB          SEARCH ID EQ TO (CCHHR=00000).        08600016
         ALR   REG2,REG7               TIC TO CCW1.                     08700016
         LA    REG6,RCD1CNT                                             08800016
         ALR   REG4,REG6          WRITE COUNT KEY DATA RECORD 1.        08900016
         LA    REG9,CC1COUNT       GET LENGTH OF RECORD 1.              08930016
         ALR   REG5,REG9           PLACE COUNT INTO CCW.                08960016
         STM   REG0,REG5,CCMND1   STORE SID EQ-IIC-WRITE CKD CCWS.      09000016
         LA    REG6,CCMND6-CCMND1 GET DISPLACEMENT OF CCWT=CCW1         09100016
         SR    REGF,REGF          CLEAR REGF.                           09150016
         LA    REGE,X'01'                                               09230016
         SRDL  REGE,8                                                   09310016
         ALR   REG4,REGF          SET READ COMMAND FOR WRITE CHECK.     09400016
         ALR   REG2,REG6          SET UP PROPER TIC ADDRESS.            09500016
         STM   REG0,REG5,CCMND6   STORE SID EQ-TIC-READ CKD CCWS.       09600016
         LA    REG6,RCD2CNT-RCD1CNT   GET DISPLACEMENT RECORD 2 COUNT.  09700016
         ALR   REG4,REG6          SET READ CMND FOR RCD2 WRITE CHECK.   09800016
         LA    REG9,CC2COUNT-CC1COUNT                                   09830016
         ALR   REG5,REG9           COMPUTE LENGTH OF RECORD 2.          09860016
         STM   REG4,REG5,CCMND9   STORE READ CCW.                       09900016
         SR    REG4,REGF          CHANGE READ TO WRITE.                 10000016
         STM   REG4,REG5,CCMND4   STORE WRITE CCW.                      10100016
         LA    REG6,RCD3CNT-RCD2CNT   GET DISPLACEMENT OF RCD3-RCD2     10200016
         ALR   REG4,REG6          SET WRITE CMND FOR RCD3.              10300016
         LA    REG9,CC3COUNT-CC2COUNT                                   10330016
         ALR   REG5,REG9           COMPUTE LENGTH OF RECORD 3.          10360016
         STM   REG4,REG5,CCMND5   STORE RECORD3 WRITE CCW               10400016
         AR    REG4,REGF           CHANGE WRITE TO READ COMMAND         10500016
         STM   REG4,REG5,CCMNDA   STORE READ CMND FOR WRITE CHECK.      10600016
         MVI   CCMNDA+4,X'30'      TURN OFF CONMAND CHAIN.              10630016
         L     REG9,COPYPTR        RESTORE COPY BLOCK POINTER.          10660016
         AIF  ('&LIB' EQ 'LIB2').X304700                         XM3645 10670003
*  THE CHANNEL IS COMPLETED HERE IF NO IPL TEXT IS REQUESTED,OR IF      10700016
*  THIS DEVICE IS NOT A 2301 OR 2314                                    10800016
         L     REG6,TUCBPTR       GET UCB ADDRESS                       10900016
.X304700 ANOP                                                    XM3645 10950003
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               11000016
         BZ    COMPCCW            NO-CHANNEL PROGRAM IS COMPLETE.       11100016
         AIF  ('&LIB' EQ 'LIB1').X304701                         XM3645 11150003
         B    BUILDIPL            BUILD IPL CCWS.                XM3645 11160003
         AGO  .X304702                                           XM3645 11162003
.X304701 ANOP                                                    XM3645 11170003
         TM    IPLTRK1,X'01'      IS IPL TEXT ON TRACK 1 BIT ON.        11200016
         BZ    BUILDIPL           NO CONSTRUCT CHANNEL PROGRAM FOR IPL. 11300016
         LA    REG7,FBLOCKS       GET POINTER TO ACTIVE CONTROL BLKS.   11500016
         MVC   IPLSEEK+2(4),UCBSKA+3   INSERT CORRECT CCHH OF IPL       11600016
         MVC   IPLSURCH(4),UCBSKA+3     TEXT INTO RECORD2 SEEK/SEARCH.  11700016
         XC    SEEKADDR+3(5),SEEKADDR+3  ZERO SEEK ADDR IN IOB.         11730016
         MVI   IPLSURCH+4,1       SET UP RECORD NO FOR IPL TEXT.        11760016
         BAL   REG5,EXCPIPL       LINK TO EXCP TO WRITE IPL RECORD.     11800016
         L     REG9,COPYPTR       GET COPY POINTER.                     11900016
IPLLOOP1 EQU   *                                                        12000016
         LTR   REG9,REG9          IS THERE ANOTHER COPY.                12100016
         BZ    BUILDF4            NO-CONSTRUCT VTOC.                    12200016
         L     REG6,CUCBPTR       GET POINTER TO COPY UCB .             12300016
         MVC   IPLSEEK+2(4),UCBSKA+3 SET CORRECT CCHH OF IPL TEXT INTO  12400016
         MVC   IPLSURCH(4),UCBSKA+3    RECORD2 SEEK/SEARCH ADDRESS.     12500016
         TM    SEQSW,NEWVOLID     IS NEW VOL SPECIFIED.                 12600016
         BO    KEEPSERL           YES-RETAIN THE SAME VOLID FOR COPY.   12700016
         MVC   VOLSERNO(6),SRTEVOLI  INSERT VOLID FOR THIS COPY.        12800016
KEEPSERL EQU   *                                                        12900016
         LA    REG7,CIOBLOCK      POINT TO COPY I/O CONTROL BLOCKS.     13000016
         XC    SEEKADDR+3(5),SEEKADDR+3 CLEAR SEEK ADDRESS         O122 13050019
         BAL   REG5,EXCPIPL       LINK TO EXCP TO WRITE IPL RECORD.     13100016
         L     REG9,CCOPYPTR            GET ADDR OF COPY BLOCK     O122 13150019
         B     IPLLOOP1           LOOP UNTIL FINISH.                    13200016
.X304702 ANOP                                                    XM3645 13250003
EXCPIPL  EQU   *                                                        13300016
         EXCP  WKAIOB             INITIATE CHANNEL PROGRAM.             13400016
         TM    WKAECB,COMPLETE    IS I/O COMPLTE.                       13500016
         BO    DONTWAIT           YES- BYPASS WAIT SVC.                 13600016
         WAIT  1,ECB=WKAECB       WAIT FOR I/O COMPLETION.              13700016
DONTWAIT EQU   *                                                        13800016
         CLI   WKAECB,X'7F'       WAS I/O SUCCESSFULLY COMPLETED.       13900016
         BCR   8,REG5              YES-RETURN.                          14000016
IOERROR1 EQU   *                                                        14100016
         CLC   SEEKADDR+3(4),ZEROS   WAS ERROR ON TRACK ZERO.           14200016
         BE    MSGZERO            YES- PRINT MESSAGE AND TERMINATE.     14300016
IOERROR2 EQU   *                                                        14450016
         LA    REG1,13            GET MESSAGE NUMBER.                   14500016
         BAL   REG5,MSGLINK       LINK TO MESSAGE ROUTINE.              14600016
         BAL   REG5,SYNADERR      NO-SYNAD ERROR RETURN.                14650016
EXIT     EQU   *                                                        14700016
         BAL   REG5,MSGPRINT      WRITE MESSAGE.                        14800016
         LA    REGF,8              SET UP RETURN CODE FOR MINITOR.      14900016
EXITFINL EQU   *                                                        15000016
         CLI   FIPLPTR,X'80'      WAS IPL TEXT POINTER PASSED.          15020016
         BNE   PTROKAY            YES-LEAVE POINTER FOR MONITOR.        15040016
         XC    FIPLPTR(4),FIPLPTR NO-CLEAR IT.                          15060016
PTROKAY  EQU   *                                                        15080016
         L     REGD,SAVEREGD       GET POINTER TO IEHDANAL SAVE AREA.   15100016
         RETURN (14,12),T,RC=(15) RESTORE REGS AND RETURN.              15200016
BUILDIPL EQU   *                                                        15300016
         USING BUFFER,REG9                                              15320016
         MVI   CCMNDA+4,X'40'      TURN ON COMMAND CHAIN.               15340016
         L     REG9,FIPLPTR  POINT TO IPL COUNT FIELD.                  15360016
         LA    REG9,0(REG9)  CLEAR HIGH ORDER BYTE OF IPL POINTER.      15380016
         LM    REG0,REG5,CCMND8   HERE                                  15400016
         STM   REG0,REG5,CCMND9        WE                               15500016
         LA    REG6,SEEKADDR+3            MODIFY                        15600016
         LM    REG0,REG1,CCW1FMT                 THE                    15700016
         ALR   REG0,REG6                                                15800016
         LM    REG2,REG3,CCMND7                     CHANNEL             15900016
         LA    REG6,CCMND7-CCMND6                           PROGRAM     16000016
         ALR   REG2,REG6          TO                                    16100016
         STM   REG0,REG3,CCMND7      WRITE                              16200016
         LM    REG0,REG1,CCW3              THE                          16300016
         L     REGE,FIPLPTR                        RECORD               16400016
         LA    REGE,0(REGE)       CLEAR HIGH ORDER BIT IN REG.          16420016
         AIF   ('&LIB' EQ 'LIB2').X0001                          X02912 16430002
         LA    REG6,3625                                                16440016
         AGO   .X0002                                            X02912 16450002
.X0001   ANOP                                                    X02912 16452002
         L     REG6,IPLMAX        GET MAX RECORD SIZE FOR IPLTXT X02912 16460002
.X0002   ANOP                                                    X02912 16462002
         ST    REG6,IPL1CNT+4     STORE DATA LNGTH IN COUNT OF IPLTEXT. 16470016
         LM    REG0,REG1,CCW3                               TRACK       16500016
         ALR   REG1,REG6          SET UPLNGTH OF IPL TEXT IN CCW.       16550016
         ALR   REG0,REGE                                                16600016
         STM   REG0,REG1,CCMND6                                  ZERO.  16700016
         AR    REG0,REGF          MODIFY WRITE CCW TO READ.             16800016
         STM   REG0,REG1,CCMNDC                                         16900016
         MVI   CCMNDC+4,X'10'                                           17000016
         MVI   IPL1CNT+4,4        INSERT RECORD NUMBER INTO IPL COUNT.  17100016
         MVC   IPL1CNT(4),RCD1CNT  INSERT CCHH FOR IPL RECORD.          17200016
         MVC   IPLSURCH(5),IPL1CNT     SET UP IPL SEARCH                17230016
         XC    IPLSEEK(6),IPLSEEK      AND SEEK ADDRESS.                17260016
COMPCCW  EQU   *                                                        17300016
         DROP  REG9                                                     17330016
         USING COPYBLK,REG9                                             17360016
         XC    SEEKADDR+3(5),SEEKADDR+3  SET UP JOB FOR TRACK ZERO.     17400016
CARNIVAL EQU   *                                                 S20201 17409020
         TM    SEQSW+D1,RPSS       DO WE HAVE CARNY             XM4389  17418003
         BZ    NOTCARN             NO                            S20201 17427020
         LA    REG0,SETSECCW       YES, DO A SET SECTOR          S20201 17436020
         ST    REG0,CCWPTR                                       S20201 17445020
         LA    REG0,CCMND1         GET CHAN PROG                 S20201 17454020
         ST    REG0,TEMP           SET IT IN TIC                 S20201 17463020
         MVC   TICADD(K3),TEMP+K1                                S20201 17472020
         B     LOADCOPY            CHECK FOR COPIES              S20201 17481020
NOTCARN  EQU   *                                                 S20201 17490020
         LA    REG0,CCMND1                                              17500016
         ST    REG0,CCWPTR        INSERT POINTER TO CCWS INTO IOB.      17600016
LOADCOPY EQU   *                                                 S20201 17650020
         L     REG9,COPYPTR       GET POINTER TO COPY BLOCK             17700016
COPYLOOP EQU   *                                                        17800016
         LTR   REG9,REG9     IS THIS THE LAST COPY.                     17900016
         BZ    STRTEXCP      YES-PREPARE TO INITIATE EXCP.              18000016
         MVC   CIOBLOCK+72(44),FBLOCKS+72  MOVE CONTOOL BLKS TO COPY.   18100016
         LA    REG7,CIOBLOCK      POINT TO COPY CONTROL BLOCKS.         18200016
         ST    REG7,DCBADD        UPDATE DCB POINTER IN IOB.            18300016
         LA    REG0,WKAECB-IHADCB(REG7)  GET PTR TO ECB.                18330016
         ST    REG0,ECBADD-IHADCB(REG7)  GET PTR TO ECB.                18360016
         L     REG9,CCOPYPTR      GET NEXT COPYBLK POINTER.             18400016
         B     COPYLOOP           LOOP UNTIL ALL COPIES ARE BUILT.      18500016
OPENIPL  EQU   *                                                        18600016
         LA    REG7,INPUTDCB      GET POINTER TO IPL DCB.               18700016
         MVC   DCBDDNAM(8),DDNAME1     INSERT IPL DDNAME.               18800016
         OPEN  (INPUTDCB,INPUT)   OPEN IPL DATA SET OR MEMBER.          18900016
         TM    DCBOFLGS,X'10'     WAS DCB OPENED.                       19000016
         BZ    NOTOPEN            NO-SET UP ERROR AND TERMINATE.        19100016
GETLOOP2 EQU   *                                                        19150016
         L     REG6,FBUFFPTR      GET POINTER TO OUTPUT AREA.           19200016
         LA    REG6,8(REG6)       SAVE SPACE FOR COUNT FIELD.           19300016
         AIF   ('&LIB' EQ 'LIB2').X0003                          X02912 19350002
         LA    REG3,3624(REG6)    POINT TO END OF BUFFER AREA.          19400016
         AGO   .X0004                                            X02912 19450002
.X0003   ANOP                                                    X02912 19452002
         LR    REG3,REG6                START OF READIN AREA     X02912 19460002
         LA    REG3,0(REG3)             CLEAR HIGH ORDER BYTE    X02912 19470002
         A     REG3,IPLMAX              POINT TO END OF BUFFER   X02912 19480002
         BCTR  REG3,0                                            X02912 19490002
.X0004   ANOP                                                    X02912 19492002
         SR    REG2,REG2          CLEAR EXECUTE REGISTER.               19500016
         LA    REG7,FBLOCKS       RESET I/O CONTROL BLOCK PTR.          19550016
GETLOOP1 EQU   *                                                        19600016
         GET   INPUTDCB           GET LOGICAL RECORD.                   19700016
         CLC   1(3,REG1),TEXTCARD IS THIS A TEXT RECORD.                19800016
         BNE   GETLOOP1           NO-DISCARD IT AND GET ANOTHER.        19900016
         IC    REG2,11(REG1)      GET NO OF BYTES IN THIS RECORD.       20000016
         L     REGF,4(REG1)       GET DISPLACEMENT OF TEXT CARD.        20010016
         LA    REGF,0(REGF)       CLEAR HIGH ORDER BYTE OF DISP REG.    20020016
         AR    REG6,REGF          GET ADDRESS OF THIS RECORD.           20030016
         LR    REGF,REG6          SAVE POINTER TO ADDR OF THIS TEXT.    20040016
         AR    REGF,REG2          GET POINTER TO END OF TRACK BUFFER.   20050016
         CR    REGF,REG3          WILL TEXT RECORD FIT IN BUFFER.       20060016
         BNH   MOVETEXT           YES-MOVE RECORD INTO OUTPUT BUFFER.   20070016
IPLMSG2  EQU   *                                                        20110016
         CLOSE INPUTDCB           CLOSE INPUT IPL DCB.                  20130016
         FREEPOOL  INPUTDCB       FREE QAAM BUFFERS.                    20140016
NOTOPEN  EQU   *                                                        20160016
         B     IPLWARN            INDICATE IPL TEXT WAS NOT FOUND.      20360016
MOVETEXT EQU   *                                                        20700016
         OI    IPLTRK1,X'02'      INDICATE IPL TEXT WAS FOUND.          20720016
         BCTR  REG2,0                                                   20800016
         EX    REG2,MOVE1         MOVE TEXT DATA TO OUTPUT AREA.        20900016
         B     GETLOOP2           GET ANOTHER RECORD.                   21000016
MOVE1    EQU   *                                                        21100016
         MVC   0(1,REG6),16(REG1)     EXECUTE TO MOVE DATA TO OUTPUT.   21200016
TSTBLKSI EQU   *             THIS IS THE DCB EXIT ROUTINE.              21300016
         LH    REG0,DCBBLKSI      PICK UP BLOCK SIZE.                   21400016
         LTR   REG0,REG0          WAS BLOCK SIZE SPECIFIED.             21500016
         BCR   7,REGE             YES-RETURN TO OPEN.                   21600016
         MVI   DCBBLKSI+1,80      NO-DEFAULT TO 80.                     21700016
         BR    REGE               RETURN TO OPEN.                       21800016
CONVERT  EQU   *                                                        21900016
         STH   REG1,STRTRACK           SAVE STARTING RTA.               22000016
         SR    REG0,REG0                                                22100016
         LR    REG4,REG0          CLEAR HIGH ORDER DIVIDEND REGISTERS.  22200016
         DR    REG0,REGF          CONVERT LO EXTENT TO CYLS-TRKS.       22300016
         DR    REG4,REGF          CONVERT HI EXTENT TO CYLS-TRKS.       22400016
         SR    REG4,REG0          GET DIFFERENCE IN EXCESS TRKS.        22500016
         SR    REG5,REG1          GET DIFFERENCE IN CYLINDERS.          22600016
         LTR   REG5,REG5               IS CYLINDER ZERO.                22700016
         BZ    STOREXT            YES-THEN EXTENT IS CONVERTED.         22800016
         LTR   REG0,REG0          WAS BEGINNING EXTENT CYL ALIGNED.     22900016
         BZ    STOREXT            YES-THEN EXTENT IS CONVERTED.         23000016
         AR    REG4,REGF          ADD TRACK CONSTANT.                   23100016
         BCTR  REG5,0                  DECREMENT NO OF CYLINDERS.       23200016
STOREXT  EQU   *                                                        23300016
         STH   REG5,FULLCYLS      STORE NUMBER OF CYLINDERS.            23400016
         STC   REG4,EXTRACKS      STORE NUMBER OF EXCESS TRACKS.        23500016
         MVC   12(5,REG6),STRTRACK INSERT FORMAT 5 EXTENT.              23600016
         LA    REG6,5(REG6)       POINT TO NEXT EXTENT.                 23700016
         BR    REGE                    RETURN.                          23800016
CLOSE1   EQU   *             THIS IS THE EODAD EXIT ROUTINE.            23900016
         DROP  REG6                                                     24000016
         CLOSE INPUTDCB           CLOSE INPUT IPL DCB.                  24008016
         FREEPOOL  INPUTDCB       FREE QSAM BUFFERS.                    24012016
         MVC   FIPLPTR+1(3),FBUFFPTR+1 SET UP POINTER TO IPL TEXT.      24016016
         TM    IPLTRK1,X'02'      WAS AN IPL TEXT RECORD FOUND.         24018016
         BZ    IPLWARN         NO-INDICATE IPL TEXT WAS NOT FOUND.      24020016
         B     TESTDEV                                                  24024016
IPLWARN  EQU   *                                                        24032016
         LA    REG1,26                                                  24040016
         BAL   REG5,MSGLINK       GET PROPER MESSAGE.                   24048016
         MVC   0(8,REG1),DDNAME2  INSERT PROPER DDNAME.                 24056016
         BAL   REG5,MSGPRINT      PRINT PORPER MESSAGE.                 24064016
         XI    SEQSW,IPLDD        TURN OFF IPL INDICATOR.               24072016
         OI    IPLTRK1,IPLDD      SET NONIPLABLE DEVICE INDICATOR.      24080016
         LA    REG1,RCOUNT1N      POINT TO NON-IPL RECORD.              24084016
         B     FINISH                  ABNORMAL TERMINATION      A32162 24092020
         AIF   ('&LIB' EQ 'LIB2').X227324                       XL03912 24096003
         USING DATACELL,REG6                                            24100016
DA2321   EQU   *                                                        24200016
         MVC   VOLSERNO(6),DCELVOLI INSERT VOLUME SERIAL INTO LABEL.    24300016
         MVC   SEEKADDR+1(2),DCELBBNR  SET UP BIN NUBER INTO IOB.       24400016
         B     NUSERIAL                                                 24500016
VOL2321  EQU   *                                                        24600016
         MVC   VOLSERNO(6),DCELVOLI   INSERT SERIAL NUMBER.             24700016
         B     STARTCHP           WRITE TRACK ZERO.                     24800016
         DROP  REG6                                                     24900016
.X227324 ANOP                                                   XL03912 24950003
         USING UCBOB,REG6                                               25000016
*                                                                       25100016
**********************************************************************  25200016
*                                                                       25300016
EXCPLOOP EQU   *                                                        25400016
         EXCP  WKAIOB             INITIATE EXCP.                        25500016
         LTR   REG9,REG9          IS THERE ANOTHER COPY                 25600016
         BZ    WAITLOOP           NO-WAIT FOR I/O COMPLETION            25700016
         LA    REG7,CIOBLOCK      GET POINTER TO COPY DCB               25800016
         L     REG9,CCOPYPTR      GET POINTER TO NEXT COPY BLOCK.       25900016
         B     EXCPLOOP           LOOP UNTIL ALL I/O IS STARTED.        26000016
WAITLOOP EQU   *                                                        26100016
         LA    REG7,FBLOCKS       RESET CONTROL BLOCKS POINTER.         26200016
         L     REG9,COPYPTR       POINT TO 1ST COPY BLOCK.              26300016
WAITCOPY EQU   *                                                        26400016
         TM    WKAECB,COMPLETE    IS I/O COMPLETE.                      26500016
         BO    BYWAIT1            YES-BYPASS WAIT ECB.                  26600016
         WAIT  ,ECB=WKAECB        WAIT FOR I/O COMPLETION.              26700016
BYWAIT1  EQU   *                                                        26800016
         CLI   WKAECB,X'7F'       WAS I/O SUCCESSFUL                    26900016
         BNE   IOERROR1           NO-PREPARE FOR ERROR EXIT             27000016
         LTR   REG9,REG9          IS THERE ANOTHER COPY.                27100016
         BCR   8,REG5             RETURN AFTER ALL I/O IS COMPLETED.    27200016
         LA    REG7,CIOBLOCK      YES-POINT TO NEXT COPY CONTROL BLKS.  27300016
         L     REG9,CCOPYPTR      GET POINTER TO NEXT COPY BLOCK        27400016
         B     WAITCOPY           LOOP UNTIL ALL I/O IS COMPLETE.       27500016
*                                                                       27600016
**********************************************************************  27700016
*                                                                       27800016
STRTEXCP EQU   *                                                        27900016
         L     REG9,COPYPTR                                             28000016
         LA    REG7,FBLOCKS       POINT TO FUNCTION DCB                 28100016
         TM    SEQSW,NEWVOLID     WAS NEW VOLUME SERIAL REQUESTED.      28200016
         BO    VOLOKAY            KEEP SAME SERIAL FOR ALL COPIES.      28300016
         BAL   REG5,EXCPIPL       WRITE TRACK ZERO SERIALLY.            28400016
NOIPLOOP LTR   REG9,REG9          WAS THIS THE LAST COPY.               28500016
         BZ    BUILDF4            YES-CONSTRUCT AND WRITE VTOC.         28600016
         LA    REG7,CIOBLOCK      POINT TO COPY I/O BLOCKS.             28700016
         L     REG6,CUCBPTR       GET COPY UCB POINTER.                 28800016
         AIF   ('&LIB' EQ 'LIB2').X227325                       XL03912 28850003
         CLI   UCBID,X'FF'        IS THIS A 2321 .                      28900016
         BNZ   VOL2321            YES-GET SERIAL FROM SUBUCB.           29000016
.X227325 ANOP                                                   XL03912 29050003
         MVC   VOLSERNO(6),SRTEVOLI    MOVE IN SERIAL NUMBER.           29100016
STARTCHP EQU   *                                                        29200016
         BAL   REG5,EXCPIPL       WRITE EACH COPY SERIALLY.             29300016
         L     REG9,CCOPYPTR      GET POINTER TO NEXT COPY.             29400016
         B     NOIPLOOP           LOOP UNTIL ALL COPIES.ARE FINISH.     29500016
VOLOKAY  EQU   *                                                        29600016
         BAL   REG5,EXCPLOOP      START CHANNEL PROGRAM EXECUTION.      29700016
         AIF   ('&LIB' EQ 'LIB2').X227326                        XM3645 29750003
WAITCMPL EQU   *                                                        29800016
         L     REG6,TUCBPTR       GET BASE REGISTER FOR UCB.            29900016
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               30000016
         BZ    BUILDF4            NO-CONSTRUCT FORMAT 4 DSCB.           30100016
         CLI   UCBTBYT4,X'01'     IS THIS A 2311 DEVICE.                30200016
         BE    IPLON1             YES-BUILD CHNL PRGM FOR IPL ON TRK1.  30300016
         CLI   UCBTBYT4,X'03'     IS THIS A 2303 DEVICE.                30400016
         BNE   BUILDF4            NO-CONSTRUCT FORMAT 4 DSCB.           30500016
*                                                                       30600016
**********************************************************************  30700016
*                                                                       30800016
*        THE CHANNEL PROGRAN THAT WRITES IPL ON TRACK ONE IS            30900016
*              CONSTRUCTED HERE.                                        31000016
*                                                                       31100016
**********************************************************************  31200016
*                                                                       31300016
IPLON1   EQU   *                                                        31400016
         LM    REG0,REG1,CCW1FMT   PICK UP CCW ONE.                     31460016
         LM    REG2,REG5,CCW2     GET CCWS TWO THRU FIVE.               31520016
         XC    SEEKADDR+3(5),SEEKADDR+3 C6EAR SEEK ADDRESS IN IOB.      31600016
         MVI   SEEKADDR+6,1       SET SEEK ADRESS FOR TRACK ONE.        31700016
         LA    REG6,SEEKADDR+3                                          31900016
         ALR   REG0,REG6          SET UP SEARCH ARG ADDR IN CCW.        32000016
         ALR   REG2,REG7               SET UP CORRECT TIC ADDRESS.      32100016
         L     REG6,FIPLPTR       GET POINTER TO IPL TEXT.              32200016
         LA    REG6,0(REG6)       CLEAR HIGH ORDER BIT IN REG.          32230016
         MVC   0(8,REG6),IPLCOUNT  SET UP IPL COUNT FIELD.              32260016
         ALR   REG4,REG6          POINT TO IPL RECORD FROM WCKD CCW.    32300016
         LA    REG6,3625                                                32330016
         ALR   REG5,REG6     SET UP LENGTH OF IPL TEXT IN CCWS.         32360016
         STM   REG0,REG5,CCMND1   STORE UPDATED CCWS IN WORKAREA.       32400016
         LA    REG6,CCMND4-CCMND1 GET DISPLACEMENT OF CW4 IN WORKAREA.  32500016
         ALR   REG2,REG6          UPDATE ADDRESS IN TIC CCW.            32600016
         STM   REG0,REG5,CCMND4   STORE UPDATED CCWS FOR WRITE CHECK.   32700016
         MVI   CCMND6,X'1E'       MODIFY OP TO READ COUNT KEY AND DATA. 32800016
         MVI   CCMND6+4,X'30'     SET SKIPAND SILI FLAGS ON.            32900016
         LA    REG7,FBLOCKS       GET POINTER TO FUNCTION BLOCK.        32920016
CARNIV1  EQU   *                                                 S20201 32921020
         TM    SEQSW+D1,RPSS       DO WE HAVE CARNY             XM4389  32922003
         BZ    NOTCARN1            NO                            S20201 32923020
         LA    REG0,SETSECCW       YES DO SET SECTOR             S20201 32924020
         ST    REG0,CCWPTR         PUT IN IOB                    S20201 32925020
         LA    REG0,CCMND1         GET CHAN PROG                 S20201 32926020
         ST    REG0,TEMP           STORE IN TIC PTR              S20201 32927020
         MVC   TICADD(K3),TEMP+K1                                S20201 32928020
         ST    REG0,TEMP           SET IT IN TIC                 S20201 32929020
         B     COPY1               PROCESS COPIES                S20201 32930020
NOTCARN1 EQU   *                                                 S20201 32931020
         LA    REG9,CCMND1        GET POINTER TO  CCW.                  32940016
         ST    REG9,CCWPTR        STORE CWW POINTER INTO IOB.           32960016
COPY1    EQU   *                                                 S20201 32980020
         L     REG9,COPYPTR       POINT TO FIRST COPY BLOCK.            33000016
IPLOOP   EQU   *                                                        33100016
         LTR   REG9,REG9          IS THIS THE LAST COPY.                33200016
         BZ    WRITEIPL           YES-BRANCH AND WRITE IPL RECORD.      33300016
         MVC   CIOBLOCK+72(44),FBLOCKS+72                               33400016
         LA    REG7,CIOBLOCK      POINT TO COPY CONTROL BLOCKS.         33500016
         LA    REG0,WKAECB                                              33600016
         ST    REG0,ECBADD        UPDATE ECB POINTER IN IOB.            33700016
         ST    REG7,DCBADD        UPDATE DCB POINTER IN IOB.            33800016
         L     REG9,CCOPYPTR      GET ADDRESS OF NEXT COPY BLOCK.       33900016
         B     IPLOOP             LOOP UNTIL FINISH.                    34000016
WRITEIPL EQU   *                                                        34100016
         OI    IPLTRK1,1          SET IPL ON TRACK ONE INDICATOR.       34150016
         LA    REG7,FBLOCKS       POINT TO THE CNTRL BLKS IN FUNCBLKS.  34200016
         L     REG9,COPYPTR       GET ADDRESS OF FIRST COPY BLOCK.      34300016
         BAL   REG5,EXCPLOOP      START CHANNEL PROGRAM EXECUTION.      34400016
         B     BLIPLRCD           CONSTRUCT AND WRITE BOOTSTRAP RECORD. 34500016
.X227326 ANOP                                                    XM3645 34550003
BUILDF4  EQU   *                                                        34600016
         LA    REG7,FBLOCKS       POINT TO PRIMARY CNTRL BLKS.          34620016
         MVC   SEEKADDR+3(4),VVTOCPTR  INSERT VTOC ADDRESS INTO IOB.    34650016
         L     REGE,IODEVCON      GET ADDRESS OF CONSTANT TABLE.        34700016
         L     REG6,FBUFFPTR      GET POINTER TO BUFFER AREA.           34800016
         SR    REG0,REG0                                                34900016
         IC    REG0,DSCBTRK       GET NUMBER OF DSCBS/TRACK.            35000016
         LA    REG1,148                                                 35100016
         MR    REG0,REG0          COMPUTE SIZE NECCESSARY FOR DSCBS.    35200016
         AR    REG1,REG6          GET  ADDRESS OF FIRST CCW.            35300016
         LA    REG1,16(REG1)                                            35320016
         SRL   REG1,3                                                   35340016
         SLL   REG1,3             ALIGN CCWS ON DOUBLE WORD BOUNDARY.   35360016
CARNIV2  EQU   *                                                 S20201 35364020
         TM    SEQSW+D1,RPSS       ARE WE CARNY                 XM4389  35368003
         BZ    NOTCARN2                                          S20201 35372020
         LA    REG0,SETSECCW       YES SET SECTOR CMD            S20201 35376020
         ST    REG0,CCWPTR         INT IOB                       S20201 35380020
         ST    REG1,TEMP                                         S20201 35384020
         MVC   TICADD(K3),TEMP+K1                                S20201 35388020
         B     CARNY2              CONT PROCESS                  S20201 35392020
NOTCARN2 EQU   *                                                 S20201 35396020
         ST    REG1,CCWPTR        STORE CCW  ADDRESS INTO I/OB          35400016
CARNY2   EQU   *                                                 S20201 35450020
         LM    REG2,REG5,CCW1FMT  PICK UP DUMMY CCWS.                   35500016
         LA    REG0,SEEKADDR+3                                          35600016
         ALR   REG2,REG0          SET UP SEARCH ID EQ ADDRESS.          35700016
         ALR   REG4,REG1          SET UP TRANSFER IN CHANNEL ADDRESS.   35800016
         STM   REG2,REG5,0(REG1)  STORE UPDATED CCWS IN WORKAREA.       35900016
         SR    REG0,REG0                                                36000016
         LR    REG2,REG6          GET POINTER TO FIRST DSCB.            36100016
         IC    REG0,DSCBTRK       GET NO OF DSCBS/TRACK.                36200016
         LM    REG3,REG4,CCW3FMT  GET DUMMY CCW (WRITE COUNT-KEY-DATA)  36300016
         LA    REG1,16(REG1)      UPDATE CCW POINTER.                   36400016
CCWLOOP1 EQU   *                                                        36500016
         ALR   REG3,REG2          SET UP ADRESS OF PROPER DSCB.         36600016
         STM   REG3,REG4,0(REG1)  STORE UPDATED CCWS.                   36700016
         LA    REG2,148           GET CCW ADDRESS INCREMENT.            36800016
         LA    REG1,8(REG1)       UPDATE CCW POINTER.                   36900016
         BCT   REG0,CCWLOOP1      LOOP UNTIL ALL WRITE CCWS ARE BUILT.  37000016
         LM    REG3,REG4,CCW4FMT  GET DUMMY READ R0 CCW.                37100016
         STM   REG3,REG4,0(REG1)  STORE READ R0 CCW.                    37200016
         IC    REG0,DSCBTRK       GET NUMBER OF DSCBS/TRACK.            37300016
         LM    REG3,REG4,CCW5FMT  GET WRITE CHECK DUMMY CCW.            37400016
         MVC   0(5,REG6),SEEKADDR+3 INSERT VTOC ADDRESS IN RCD CNT.     37500016
         MVC   5(3,REG6),DSCBCNT  MOVE KEY AND DATA LENGTH TO R1 CNT.   37600016
         B     CCWSTART           BYPASS FIRST UPDATE.                  37700016
CCWLOOP2 EQU   *                                                        37800016
         MVC   148(8,REG6),0(REG6)  INSERT NEXT RECORD COUNT.           37900016
         ALR   REG6,REG2               UPDATE DSCB POINTER.             37950016
CCWSTART EQU   *                                                        38000016
         IC    REGF,4(REG6)                                             38100016
         LA    REGF,1(REGF)       INCREMENT RECORD NUMBER.              38200016
         STC   REGF,4(REG6)       STORE UPDATED CCHHR .                 38300016
         STM   REG3,REG4,8(REG1) STORE WRITE CHECK CWW.                 38400016
         XC    8(140,REG6),8(REG6) CLEAR DSCB AREA.                     38500016
         LA    REG1,8(REG1)       UPDATE CCW POINTER.                   38700016
         BCT   REG0,CCWLOOP2      LOOP UNTIL DSCBS/CCWS ARE BUILT       38800016
         LM    REG3,REG4,CCW6FMT   GET READ R0 CCW.                     38820016
         STM   REG3,REG4,8(REG1)       READ R0 CCW.                     38860016
         L     REG6,FBUFFPTR       RESET BUFFER ADDRESS.                38900016
         DROP  REG6                                                     39000016
         USING BUFFER,REG6                                              39100016
         L     REGE,IODEVCON      GET ADDRESS OF CONSTANT TABLE.        39200016
         MVI   8(REG6),4                                                39300016
         MVC   9(43,REG6),8(REG6) SET UP FORMAT 4 DSCB KEY.             39400016
         MVI   DS4IDFMT,X'F4'     INSERT IDENTIFIER.                    39500016
         MVC   DS4HPCHR(5),148(REG6)  SET UP HIGH PRIME CCHHR.          39600016
         MVC   DS4HCCHH(6),FALTDATA SET UP ALTERNATE DATA IN DSCB.      39700016
         MVI   DS4NOEXT,1         SET UP NUMBER IF EXTENTS IN VTOC.     39800016
         MVC   DS4DEVCT(14),CYLNO      SET UP DEVICE CONSTANTS.         39900018
         MVC   DS4VTOCE+2(8),MBBCCHH1  SET UP VTOC EXTEMTS.             40000016
         MVI   DS4VTOCE,1         SET UP EXTENT TYPE.                   40100016
         IC    REG0,DSCBTRK                                             40200016
         MH    REG0,WKBUFPTR+2    COMPUTE NO OF DSCBS IN VTOC.          40300016
         BCTR  REG0,0             SUBTRACT 1 FOR FORMAT 4 DSCB.         40400016
         BCTR  REG0,0             SUBTRACT 1 FOR FORMAT 5 DSCB.         40500016
         STH   REG0,DS4DSREC      STORE NO OF AVAILABLE DSCBS IN VTOC.  40600016
         LA    REG6,148(REG6)     UPDATE DSCB POINTER TO THE FORMAT 5.  40700016
         MVI   8(REG6),5                                                40800016
         MVC   9(3,REG6),8(REG6)  SET UP FORMAT 5 KEY IDENTIFICATION.   40900016
         MVI   52(REG6),X'F5'     SET UP FORMAT IDENTIFIER.             41000016
         TM    SEQSW+D1,SS1VAL    SS/1 CONVERSION              @Y30LSFY 41050003
         BZ    SETD5              NO                           @Y30LSFY 41060003
*        FORMAT 5 DSCB WILL INDICATE ONLY TRACKS 3-19 ARE FREE @Y30LSFY 41070003
         MVC   STRTRACK(L5),SS1AVEXT SET AVAIL. EXTENT         @Y30LSFY 41080003
         MVC   D12(L5,REG6),STRTRACK INSERT FORMAT 5 EXTENT    @Y30LSFY 41090003
         B     NOHIRTA            SKIP EXTENT CONSTRUCTION     @Y30LSFY 41092003
SETD5    EQU   *                                               @Y30LSFY 41094003
         LA    REG1,1             ASSUME TRACK 1 IS AVAILABLE.          41100016
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               41200016
         BZ    TRKAVAIL           NO- THEN TRACK 1 IS AVAILABLE.        41300016
         AIF   ('&LIB' EQ 'LIB2').X227327                       XL03912 41310003
         USING UCBOB,REG5                                               41330016
         L     REG5,TUCBPTR       GET POINTER TO UCB.                   41360016
         CLI   UCBTBYT4,1         IS THIS AN IPLABLE 2311.              41400016
         BE    UPTRACK            YES- THEN TRK 1 IS NOT AVAILBLE.      41500016
         CLI   UCBTBYT4,3         IS THIS AN IPLABLE 2303.              41600016
         BNE   TRKAVAIL           NO-THEN TRACK 1 IS AVAILABLE.         41700016
         USING BUFFER,REG6                                              41730016
UPTRACK  EQU   *                                               @ZA01205 41740002
         LA    REG1,2             MAKE TRACK THE 1ST AVAILABLE.@ZA01205 41750002
.X227327 ANOP                                                   XL03912 41760003
TRKAVAIL EQU   *                                                        42000016
         LH    REG5,RTAVTOCS+2    GET BEGINNING RTA OF VTOC.            42100016
         LH    REGF,TRKCYL        GET TRACK CONSTANT.                   42200016
         CR    REG1,REG5          DOES VTOC START AT BEGINNING OF VOL.  42400016
         BNL   NOLORTA            YES-BYPASS LOW EXTENT CONVERSION.     42500016
         BAL   REGE,CONVERT       NO-CONVERT RTA TO DSCB FORMAT.        42600016
NOLORTA  EQU   *                                                        42700016
         LH    REG1,RTAVTOCE+2    GET ENDING RTA OF VTOC.               42800016
         LH    REG5,RTAVTOCS      GET RTA OF LAST PRIMARY TRACK.        42900016
         CR    REG1,REG5          IS LAST TRACK ALLOCATED TO VTOC.      43000016
         BNL   NOHIRTA            YES-BYPASS HIGH EXTENT CONVERSION.    43100016
         LA    REG1,1(REG1)       UPDATE RTA TO 1ST AVAILABLE.          43200016
         LA    REG5,1(REG5)       UPDATE RTA TO 1ST ALTERNATE           43300016
         BAL   REGE,CONVERT       CONVERT RTA TO DSCB FORMAT.           43400016
NOHIRTA  EQU   *                                                        43500016
         LA    REG7,FBLOCKS       GET POINTER TO PRIMARY I/O BLOCKS.    43600016
         L     REG9,COPYPTR       GET FIRST COPY BLOCK POINTER .        43700016
         L     REG2,CCWPTR        GET PTR TO CCW FROM FUNCBLK.          43750016
         BAL   REG5,EXCPIPL       WRITE FIRST TRACK SERIALLY.           43800016
WRITEF4  EQU   *                                                        43900016
         LTR   REG9,REG9          WAS THIS LAST COPY.                   44000016
         BZ    NEXTRK             YES-WRITE OTHERS TRKS IN PARALLEL     44100016
         L     REG6,FBUFFPTR      RESTORE BUFFER AREA BASE.             44150016
         MVC   DS4HCCHH(6),CALTDATA INSERT ALTERNATE DATA INFO.         44200016
         LA    REG7,CIOBLOCK  POINT TO COPY I/O CONTROL BLOCK.          44300016
         ST    REG2,CCWPTR        STORE PTR TO CCW IN COPY BLOCK.       44350016
         MVC   SEEKADDR+3(4),VVTOCPTR  INSERT CCHH INTO IOB SEEKADDR.   44370016
         BAL   REG5,EXCPIPL   INITIATE I/O ON TRK 1 OF COPY DEVICE.     44400016
         L     REG9,CCOPYPTR      GET NEXT COPY POINTER.                44600016
         B     WRITEF4   LOOP UNTIL ALLL ARE COMPLETED.                 44700016
TTRCONV  EQU   *                                                   O122 44710019
         L     REGF,FBUFFPTR            POINTER TO BUFFER          O122 44720019
         USING CVT,REGF                                            O122 44730019
         STM   REG9,REG2,12(REGD)       SAVE REGS FOR CONVERT RTN  O122 44750019
         LR    REG3,REGD                SAVE PTR TO SAVE AREA      O122 44760019
         LA    REG2,8(REGF)             POINT TO MBBCCHHR AREA     O122 44770019
         LA    REG1,DDEB                POINT TO DUMMY DEB         O122 44780019
         L     REGF,CVTPTR              GET ADDRESS OF CVT         O122 44790019
         L     REGF,CVTPCNVT            GET ENTRY PT TO CONVERT RTNO122 44800019
         BALR  REGE,REGF                LINK TO CONVERT RTN        O122 44810019
         LM    REG9,REG2,12(REG3)       RESTORE MY REGISTERS       O122 44820019
         BR    REG5                     RETURN TO CALLING RTN      O122 44830019
NEXTRK   EQU   *                                                   O122 44840019
         LA    REG7,FBLOCKS             PTR TO I/O BLOCKS.       XM1383 44842002
         LA    REG0,1                   PUT A 1 IN REG 0           O122 44850019
         AH    REG0,RTAVTOCS+2          COMPUTE TTR OF NEXT TRACK  O122 44860019
         STH   REG0,RTAVTOCS+2          SAVE UPDATED TTR IN WORK   O122 44870019
*                                          AREA                    O122 44880019
         SLL   REG0,16                  POSITION TT IN HIGH ORDER  O122 44890019
*                                          BYTES                   O122 44900019
         BAL   REG5,TTRCONV             SET SEEK ADDRESS           O122 44910019
         MVC   SEEKADDR+3(5),11(REGF)   INSERT CCHHR INTO IOB      O122 44920019
         XC    8(140,REGF),8(REGF)   CLEAR FORMAT 4 DSCB AREA.          45000016
         XC    156(140,REGF),156(REGF) CLEAR FORMAT 5 DSCB AREA.        45050016
UPCOUNT2 EQU   *                                                        45100016
         SR    REG1,REG1          CLEAR REG1.                           45150016
         L     REGE,IODEVCON      GET ADDRESS OF CONSTANT TABLE.        45200016
         IC    REG1,DSCBTRK       GET NO OF DSCB PER TRACK.             45300016
UPCOUNT1 EQU   *                                                        45400016
         MVC   0(4,REGF),SEEKADDR+3    UP CCHH IN DSCB                  45500016
         LA    REGF,148(REGF)     POINT TO NEXT DSCB IN CORE.           45600016
         BCT   REG1,UPCOUNT1    LOOP UNTIL PTRS ARE UPDATED.            45700016
         CLC   RTAVTOCS+2(2),RTAVTOCE+2 IS THIS END OF VTOC.            45800016
         BH    FINISH      YES PREPARE TO RETURN TO MONITOR.            45900016
         LA    REG7,FBLOCKS   GET PRIMARY BLOCK POINTRR.                46000016
         L     REG9,COPYPTR       POINT TO FIRST COPY.                  46100016
         LR    REGF,REG7     SAVE PTR TO FUNCTION I/O BLOCKS.           46108016
CCHHLOOP EQU   *                                                        46116016
         LTR   REG9,REG9          IS THIS THE LAST COPY BLOCK.          46124016
         BZ    EXCPLINK           YES- LINK TO EXCP.                    46132016
         LA    REG7,CIOBLOCK      POINT TO COPY I/O BLOCK.              46140016
         MVC   SEEKADDR+3(4),SEEKADDR+3-IHADCB(REGF) PUT CCHH IN COPY.  46148016
         L     REG9,CCOPYPTR      GET NEXT COPY BLOCK POINTER.          46156016
         B     CCHHLOOP           LOOP UNTIL COPIES ARE COMPLETE.       46164016
EXCPLINK EQU   *                                                        46172016
         LR    REG7,REGF          RESTORE FUNCTION I/O BLOCK PTR.       46180016
         L     REG9,COPYPTR            POINT TO FIRST COPY BLOCK.       46188016
         BAL   REG5,EXCPLOOP     WRITE ALL COPIES IN PARALLEL.          46200016
         B     NEXTRK             LOOP UNTIL VTOC IS FINISH.            46230016
FINISH   EQU   *                                                        46260016
         LA    REGF,8             SET UP ABNORMAL COMPLETION CODE.      46290016
         TM    IPLTRK1,IPLDD      IS NONIPLABLE BIT SET.                46320016
         BO    RETOKAY            YES-RETURN WITH A CODE 4.             46350016
         SR    REGF,REGF                                                46400016
RETOKAY  EQU   *                                                        46450016
         B     EXITFINL                                                 46500016
MSGLINK  EQU   *                                                        46600016
         LINK  EP=IEHDMSGB        GET PROPER MESSAGE.                   46700016
         BR    REG5                                                     46800016
MSGPRINT EQU   *                                                        46900016
         LINK  EP=IEHDPRNT                                              47000016
         BR    REG5                                                     47100016
SYNADERR EQU   *                                                        47200016
         SYNADAF ACSMETH=EXCP,PARM1=WKAIOB                              47300016
         MVC   MESS+22(78),49(REG1)    SET MSG IN OUTPUT BUFFER. SM4350 47370021
         SYNADRLS                                                       47450016
         BR    REG5                                                     47500016
NOIPLDS  EQU   *                                                        47540016
         LA    REG1,13                                                  47550016
         BAL   REG5,MSGLINK       BUILD I/O ERROR MESSAGE IN BUFFER.    47560016
         SYNADAF   ACSMETH=QSAM                                         47580016
         MVC   MESS+22(78),49(REG1)    SET MSG IN OUTPUT BUFFER. SM4350 47610021
         SYNADRLS                                                       47640016
         BAL   REG5,MSGPRINT      PRINT I/O ERROR MSG.                  47660016
         B     IPLMSG2            PRINT NEXT MSG,CLOSE DCB AND EXIT.    47680016
MSGZERO  EQU   *                                                        47700016
         LA    REG1,28            PICK UP MESSAGE NUMBER.               47710016
         BAL   REG5,MSGLINK       GET MESSAGE INTO OUTPUT BUFFER.       47720016
         MVC   0(8,REG1),DDNAME2  ASSUME THIS IS A PRIMARY FUNCTION.    47730016
         LA    REG0,FBLOCKS       GET POINTER TO PRIMARY I/O BLOCKS.    47740016
         CR    REG0,REG7          TEST FOR PRIMARY.                     47750016
         BE    EXIT               EXIT IF THIS WAS A PRIMARY FUNCTION.  47760016
         MVC   0(8,REG1),DDNAME3  GET DDNAME FROM COPY BLOCK.           47770016
         B     EXIT               EXIT                                  47780016
*                                 CONSTANTS                             47800016
RPSS     EQU   X'40'                    INDIC RPS ON DASD VOL   XM4389  47802003
D3350    EQU   X'0B'                   3350 DEVICE TYPE        @VS40037 47804003
FACTPACK EQU   9                                                 S20201 47810020
ZEUS1    EQU   6                                                 S20201 47820020
ZEUS2    EQU   7                                                 S20201 47830020
D1       EQU   1                                                 S20201 47860020
D2       EQU   2                  DISPLACEMENT CONSTANT        @Y30LSFY 47860403
D3       EQU   3                  DISPLACEMENT CONSTANT        @Y30LSFY 47860803
SS1VAL   EQU   X'01'              SS/1 CONVERSION              @Y30LSFY 47862003
L4       EQU   4                  LENGTH CONSTANT              @Y30LSFY 47862403
L5       EQU   5                  LENGTH CONSTANT              @Y30LSFY 47864003
L6       EQU   6                  LENGTH CONSTANT              @Y30LSFY 47864403
L8       EQU   8                  LENGTH CONSTANT              @Y30LSFY 47864803
D12      EQU   12                 DISPLACEMENT CONSTANT        @Y30LSFY 47866003
SS1AVEXT DC    X'0003000011'      TRACKS 3-19 AVAIL.           @Y30LSFY 47868003
F1       DC    F'1'                                              S20201 47870020
TEMP     DC    F'0'                                              S20201 47880020
         DC    C'MAINTENANCE AREA'                                      47880402
MAINT    DS    50F                      MAINT AREA              XL02912 47880802
         AIF   ('&LIB' EQ 'LIB1').X0005                          X02912 47882002
WIN      EQU   X'0A'                                             XM5465 47882403
ONE      EQU   1                                                 XM5465 47882803
IPLMAX   DC    F'6496'                  MAX IPLTXT RECORD SIZE   X02912 47884002
.X0005   ANOP                                                    X02912 47886002
K1       EQU   D1                                                S20201 47890020
K3       EQU   3                                                 S20201 47900020
K8       EQU   8                       2314 DEVICE TYPE         SA54550 47902021
ZERO     EQU   X'0000'                                           S20201 47910020
DEV2321  EQU   X'05'                   2321 DEVICE TYPE                 47912000
*                                                                       47920020
*   CARNIVAL CCW'S                                                      47930020
*                                                                       47940020
SETSECCW CCW   X'23',F1,X'40',1                                  M6129  47950020
TICCW    EQU   *                                                 S20201 47960020
         DC    X'08'                                             S20201 47970020
TICADD   DC    AL3(0)                                            S20201 47980020
         DC    F'0'                                              S20201 47990020
RCOUNT1N DC    F'0'                                                     48000016
         DC    X'01'                                                    48100016
         DC    X'04'                   KEY LENGTH.               A34946 48150020
         DC    AL2(CC1COUNT-4)     DATA LENGTH                   S20201 48200020
         DC    CL4'IPL1'              KEY DATA.                  A34946 48250020
REC1PSWN DC    X'000600000000000F'     WAIT STATE PSW (NON-IPL)         48300016
RD1CCWIN DC    X'0300000000000001'     NOP CCW.                         48400016
RD1CCW2N DC    X'0000000000000000'     DUMMY CCW.                       48500016
RCOUNT1I DC    F'0'               COUNT FIELD FOR RECORD 1 (IPL)        48600016
         DC    X'01'                                             M2888  48620020
         DC    X'04'                   KEY LENGTH.               A34946 48650020
         DC    AL2(CC1COUNT-4)          DATA LENGTH.             S20201 48700020
         DC    CL4'IPL1'               KEY DATA.                 A34946 48750020
REC1PSWI DC    X'0000000000000000'     PSW (IPL)                        48900016
RD1CCW1I DC    X'06003A9860000060'       READ RECORD 2.                 49000016
RD1CCW2I DC    X'08003A9800000000'    TIC TO CCW JUST READ IN.          49100016
RCOUNT2N DC    F'0'               COUNT FIELD FOR RECORD 2.             49200016
         DC    X'02'                                                    49300016
         DC    X'04'                   KEY LENGTH.               A34946 49350020
         DC    AL2(CC4COUNT)           DATA LENGTH.              A34946 49400020
         DC    CL4'IPL2'               KEY DATA.                 A34946 49450020
RCD2CCW1 DC    X'07003AB840000006'     SEEK TO IPL TRACK.               49500016
RCD2CCW2 DC    X'31003ABE40000005'     SEARCH FOR IPL RECORD.           49600016
RCD2CCW3 DC    X'08003AA000000000'                                      49700016
         AIF   ('&LIB' EQ 'LIB2').X0006                          X02912 49750002
RCD2CCW4 DC    X'0600000020000E29'     READ IPL RECORD INTO CORE.       49800016
         AGO   .X0007                                            X02912 49802002
.X0006   ANOP                                                    X02912 49804002
RCD2CCW4 DC    X'0600000020001960'     READ IPL REC 3 INTO CORE. X02912 49806002
.X0007   ANOP                                                    X02912 49808002
RCOUNT3N DC    F'0'                COUNT FIELD REC 3             S20201 49810020
         DC    X'03'                                             S20201 49820020
         DC    X'04'               KEY FIELD                     S20201 49830020
         DC    AL2(CC3COUNT-4)    DATA LENGTHAND COUNT FIELD     S20201 49840020
         DC    C'VOL1'             KET FIELD REC 3               S20201 49850020
         DC    C'VOL1'             START OF DATA FIELD           S20201 49860020
INPUTDCB EQU   *                                                        49900016
         DCB   DSORG=PS,MACRF=GL,RECFM=FB,LRECL=80,EXLST=LIST,         *50000016
               SYNAD=NOIPLDS,EODAD=CLOSE1                               50100016
LIST     EQU   *                                                        50200016
         DC    X'85'                                                    50300016
         DC    AL3(TSTBLKSI)                                            50400016
IPLCOUNT DC    F'1'                                                     50500016
         DC    X'01'                                                    50600016
         DC    AL3(3625)                                                50700016
CCW1     EQU   *                                                        50800016
         DC    X'31'                                                    50900016
         DC    AL3(ZEROS-WORKAREA)                                      51000016
         DC    X'40000005'                                              51100016
CCW2     EQU   *                                                        51200016
         DC    X'08'                                                    51300016
         DC    AL3(CCMND1-IHADCB)                                       51400016
         DC    F'0'                                                     51450016
CCW3     EQU   *                                                        51500016
         DC    X'1D'                                                    51600016
         DC    AL3(0)                                                   51700016
         DC    X'60000008'                                         9581 51800017
CCW4     EQU   *                                                        51900016
         DC    X'1E'                                                    52000016
         DC    AL3(0)                                                   52100016
         DC    X'30000000'                                              52200016
CCW1FMT  DC    X'31'               DUMMY CCWS TO CONSTRUCT VTOC.        52300016
         DC    AL3(0)                                                   52400016
         DC    X'40000005'                                              52500016
CCW2FMT  DC    X'08'                                                    52600016
         DC    AL3(0)                                                   52700016
         DC    F'0'                                                     52800016
CCW3FMT  DC    X'1D'                                                    52900016
         DC    AL3(0)                                                   53000016
         DC    X'40000094'                                              53100016
CCW4FMT  DC    X'16'                                                    53200016
         DC    AL3(0)                                                   53300016
         DC    X'70000005'                                              53400016
CCW5FMT  DC    X'1E'                                                    53500016
         DC    AL3(0)                                                   53600016
         DC    X'50000094'                                              53700016
CCW6FMT  DC    X'1A'                                                    53800016
         DC    AL3(0)                                                   53900016
         DC    X'30000005'                                              54000016
DSCBCNT  DC    X'2C0060'                                                54100016
TEXTCARD DC    C'TXT'                                                   54200016
         DS    0D                                                  O122 54203019
CCWA     DC    X'31'                    SEARCH FOR FORMAT 4 DSCB   O122 54206019
         DC    AL3(0)                                              O122 54209019
         DC    X'40000005'                                         O122 54212019
CCWB     DC    X'08'                    TIC TO SEARCH              O122 54215019
         DC    AL3(0)                                              O122 54218019
         DC    F'0'                                                O122 54221019
CCWC     CCW   X'0E',8,X'20',144 READ DATA FORMAT 4    PTMFIX           54224003
CCW01    EQU   *                        READ HOME ADDRESS          O122 54227019
         DC    X'1A'                                               O122 54230019
         DC    AL3(ALTHA-BUFFREAD)                                 O122 54233019
         DC    X'40000005'                                         O122 54236019
CCW02    EQU   *                        READ RECORD ZERO           O122 54239019
         DC    X'16'                                               O122 54242019
         DC    AL3(ALTR0-BUFFREAD)                                 O122 54245019
         DC    X'20000008'                                         O122 54248019
CCWSRCH  DC    X'31'                    SEARCH ON RECORD 3         O122 54251019
         DC    AL3(0)                                              O122 54254019
         DC    X'40000005'                                         O122 54257019
CCWBCK   DC    X'08'                    TIC TO SEARCH              O122 54260019
         DC    AL3(COMND1-BUFFREAD)                                O122 54263019
         DC    F'0'                                                O122 54266019
CCWRD    DC    X'06'                    READ DATA OF VOLUME LABEL  O122 54269019
         DC    AL3(VOLABEL-BUFFREAD)                               O122 54272019
         DC    X'10000050'                                         O122 54275019
         AIF   ('&LIB' EQ 'LIB2').X227328                       XL03912 54276003
SCC2321  DC    X'00F60000'              INCREMENT TO NEXT SUBCELL  O122 54278019
STC2321  DC    X'0000FB00'              INCREMENT TO NEXT STRIP    O122 54281019
.X227328 ANOP                                                   XL03912 54282003
HA1      DC    H'1'                     ONE                        O122 54284019
HA32     DC    H'32'                    32                         O122 54287019
HA24     DC    H'24'                    24                         O122 54290019
*                                                                       54300016
CVT      DSECT                                                          54330016
         CVT   SYS=MIN                                                  54360016
         DCBD  DSORG=PS           DATA CONTROL BLOCK.                   54400016
         ORG   IHADCB+72                                                54450016
*                                                                       54500016
*                                                                       54600016
WKAECB   DS    F                  EVENT CONTROL BLOCK.                  54700016
*                                                                       54800016
*                                                                       54900016
WKAIOB   DS    F                  INPUT/OUTPUT BLOCKS.                  55000016
IOBSENS1 EQU   WKAIOB+3                 SENSE BYTE 1 OF IOB        O122 55030019
NOREC    EQU   X'08'                    NO RECORD FOUND            O122 55060019
ECBADD   DS    F                  EVENT CONTROL BLOCK POINTER.          55100016
         DS    F                                                        55200016
CSWORD   DS    F                  CHANNEL STATUS WORD.                  55300016
IOBCSWST EQU   WKAIOB+12                IOB STATUS                 O122 55330019
UE       EQU   X'01'                    UNIT EXCEPTION             O122 55360019
CCWPTR   DS    F                  CHANNEL PROGRAM POINTER.              55400016
DCBADD   DS    F                  DATA CONTROL BLOCK POINTER            55500016
         DS    F                                                        55550016
BLKERRCT DS    F                                                        55600016
SEEKADDR DS    2F                                                       55700016
         DS    F                                                        55800016
*                                                                       55900016
*                                                                       56000016
CCOMMAND DS    0D                 CHANNEL COMMAND WORDS                 56100016
CCMND1   DS    D                                                        56200016
CCMND2   DS    D                                                        56300016
CCMND3   DS    D                                                        56400016
CCMND4   DS    D                                                        56500016
CCMND5   DS    D                                                        56600016
CCMND6   DS    D                                                        56700016
CCMND7   DS    D                                                        56800016
CCMND8   DS    D                                                        56900016
CCMND9   DS    D                                                        57000016
CCMNDA   DS    D                                                        57100016
CCMNDB   DS    D                                                        57200016
CCMNDC   DS    D                                                        57300016
         EJECT                                                 @Y30LSFY 57400003
WORKAREA DSECT                                                          57500016
RCD1CNT  DC    CL8'CCHHRKDL'      COUNT FIELD RECORD 1  C'00001024'.    57600016
RECORD1  DS    CL24               RECORD NUMBER 1 IPL/NON-IPL.          57700016
IPLKEY1  DC    CL4'IPL1'                                         S20201 57750020
RCD2CNT  DC    CL8'CCHHRKDL'      COUNT FIELD RECORD 2  C'00002032'.    57800016
RECORD2  DS    CL32               RECORD NUMBER 2.                      57900016
IPLKEY2  DC    CL4'IPL2'                                         S20201 57950020
IPLSEEK  DS    CL6                      SEEK ADDRESS FOR IPL RECORD.    58000016
IPLSURCH DS    CL5                                                      58100016
         DS    CL5                                                      58150016
RCD3CNT  DC    CL8'CCHHRKDL'      COUNT FIELD RECORD 3  C'00003080'.    58200016
VOLLABEL DS    0CL84               VOL LABEL REC 3               S20201 58260020
VOLKEY   DC    CL4'VOL1'           KEY FOR REC 3                 S20201 58320020
VOLIDENT DC    C'VOL'                  VOLUME LABEL IDENTIFIER.         58400016
VOLNUMBR DS    XL1                     VOLUME LABEL NUMBER.             58500016
VOLSERNO DS    CL6                     VOLUME SERIAL NUMBER.            58600016
VOLSECTY DS    XL1                     VOLUME SECURITY INDICATOR.       58700016
VVTOCPTR DS    CL10                    VTOC POINTER C'CCHHRRESVR'.      58800016
VOLRESV1 DS    CL10                    RESERVED FOR MANUFACTURERS USE.  58900016
VOLRESV2 DS    CL10                    RESERVED                         59000016
VOLOWNER DS    CL10                    OWNER NAME AND ADDRESS CODE      59100016
VOLRESV3 DS    CL29                    RESERVED                         59200016
VOLEND   EQU   *                                                        59300016
CC1COUNT EQU   RCD2CNT-RECORD1         RECORD 1 DATA LENGTH.            59900016
CC2COUNT EQU   RCD3CNT-RECORD2         RECORD 2 DATA LENGTH.            60000016
CC3COUNT EQU   VOLEND-VOLKEY      RECORD 3 LENGTH                S20201 60070020
CC4COUNT EQU   144                                                 9581 60150017
CC3      EQU   CC3COUNT+8                                               60200016
         ORG   WORKAREA+188                                      S20201 60400020
UNASGBT  DS    CL1                     USED BY IEHDANAL        @Y30LSFY 60450003
         DS    CL3                     RESERVED                @Y30LSFY 60500003
SAVEAREA  DS    0F                                                      60600016
PL1WORD  DS    F                  THIS WORD IS USED BY PL/1.            60700016
OLDSAPTR DS    F                  POINTER TO PREVIOUS SAVE AREA.        60800016
NEWSAPTR DS    F                  POINTER TO NEXT SAVE AREA.            60900016
RETADREG DS    F                  (REG14)-RETURN ADDRESS REGISTER.      61000016
ENTRYPTR DS    F                  (REG15)-ENTRY POINT REGISTER.         61100016
REG0TO12 DS    13F                REGISTERS 0 THROUGH 12.               61200016
SAVEVTOC DS    8F                                                       61300016
ANALTEMP DS    F                       USED                    @Y30LSFY 61310003
SAVCCHHR DS    F                         BY                    @Y30LSFY 61320003
SAVCCWPT DS    F                           IEHDANAL            @Y30LSFY 61330003
         DS    0D                                                S20201 61350020
PRGSAVE  DS    10F                                                      61400016
RTAVTOCS DS    F                                                        61500016
RTAVTOCE DS    F                                                        61600016
         ORG   *-16                                                     61700016
DDEB     DS    0F                 FAKE DEB FOR CONVERT ROUTINE.         61800016
         ORG   *+16                                                     61900016
DEXTNTNO DS    CL1                DUMMY EXTNT NUMBER.                   62000016
MBBCCHH1 DS    CL7                SAVE AREA FOR VTOC EXTENT.            62100016
MBBCCHH2 DS    CL8                                                      62200016
DUCBPTR  DS    F                  FAKE UCB POINTER.                     62300016
HALFWD   DS    H                  HALF WORD WORK SPACE.                 62400016
DEXTNTS  DS    HL4                DUMMY STARTING CCHH(000000)           62500016
DEXTNTE  DS    HL4                DUMMY ENDING CCHH.                    62600016
DEXTNTR  DS    H                  DUMMY NO TRACKS.                      62700016
WKBUFPTR DS    F                                                        62800016
WKBUFSI  DS    F                                                        62900016
PARMLST  DS    0F                                                       63000016
PARMUCB  DS    F                                                        63100016
PARMDCB  DS    F                                                        63200016
PARMCCHH EQU   PARMDCB                                                  63300016
PARMALTD DS    F                                                        63400016
STRTRACK DS    H                                                        63480016
FULLCYLS DS    H                                                        63560016
EXTRACKS DS    C                                                        63640016
ZEROS    DS    CL5                                                      63720016
IPLTRK1  DS    CL1                                                      63800016
WKAEND   DS    0D                                                       63900016
SAVEREGD EQU   SAVEVTOC+4                                               64000016
SIZE     EQU   WKAEND-RCD1CNT                                           64100016
*                                                                       64200016
**********************************************************************  64300016
BUFFREAD DSECT                                                     O122 64304019
         DS    0F                                                  O122 64308019
ALTHA    DS    CL5                      AREA TO READ HOME ADDRESS  O122 64312019
         DS    CL3                                                 O122 64316019
ALTR0    DS    2F                       AREA TO READ RECORD ZERO   O122 64320019
TRKSW    DS    CL1                      SWITCH FOR ALTERNATE       O122 64324019
*                                          TRACKS                  O122 64328019
TRKCLR   EQU   X'00'                    CLEAR SWITCH               O122 64332019
TRKFND   EQU   X'01'                    FIRST ALTERNATE TRACK HAS  O122 64336019
*                                          BEEN FOUND              O122 64340019
TRYCOPY  EQU   X'10'                    PRIMARY COPY DONE          O122 64344019
SKADDR   DS    1F                       SAVE AREA FOR SEEK ADDR    O122 64348019
SAVECCHH DS    1F                       SAVE AREA FOR CCHH         O122 64352019
ALTINFO  DS    1F                       ALTERNATE TRACK INFO       O122 64356019
NOALT    DS    CL1                      NUMBER OF ALTERNATES       O122 64360019
         DS    0D                                                  O122 64364019
COMND1   DS    1D                       QUICK DASDI CHANNEL        O122 64368019
COMND2   DS    1D                          PROGRAM AREA            O122 64372019
COMND3   DS    1D                                                  O122 64376019
VOLABEL  DS    1F                       FOR VOLUME LABEL           O122 64380019
BUFFER   DSECT                                                          64400016
F4COUNT  DS    CL8                                                      64430016
         ORG   F4COUNT+52                                               64460016
         IECSDSL1 (4)                                                   64500016
F5COUNT  DS    CL8                                                      64550016
         IECSDSL1 (5)                                                   64600016
F0COUNT  DS    CL8                                                      64650016
         ORG   BUFFER                                                   64700016
IPL1CNT  DC    CL8'CCHHRKDL'                                            64800016
         DS    CL3625                                                   64900016
KENUCB   DSECT                                                          64950016
         IEFUCBOB                                                       65000016
         IEHDBLKS                                                       65100016
         IEHDWORK                                                       65200016
         END                                                            65300016
./  ADD  SSI=70880152,NAME=IGC0008B
         TITLE 'IGC0008B --- SVC 82 FOR IEHDASDR UTILITY'               00200421
         COPY  LCGASMSW                                          SM4351 00202021
IGC0008B CSECT                                                          00210000
*                                                                       00212003
*C 276100                           @SA74452=@YA09634=@XA09732=@ZA04363 00214003
*A 276020-276040,901600             @SA74452=@YA09634=@XA09732=@ZA04363 00216003
*                                                                       00218003
*                                                              @Y30LSFY 00220003
* ELIMINATE IEH813I MSG FOR SVC 82 FOR EMUL DEVICES.           @ZM40451 00230003
*098765,098432                                                VS06562   00260002
*                                                               YM04695 00270402
*                                                               VS02889 00320402
*                                                               YM03870 00430002
*                                                               YM03804 00480002
*STATUS CHANGE LEVEL 004    VS2/2 (MVM)                         YL02912 00600002
*A                                                             @Z30RSAG 00650003
*C                                                             @Z30RSAG 00700003
*D                                                             @Z30RSAG 00750003
*                                                                     * 00800016
*FUNCTION/OPERATION-  SVC 82 PERFORMS THE FOLLOWING FUNCTIONS FOR     * 01000016
*   THE -IEHDASDR- UTILITY PROGRAM//TYPE 4 SVC WITH EXTENDED SVRB.    * 01200016
*                                                                     * 01400016
*     1) IN PREPARATION FOR SURFACE ANALYSIS FOR OFF-LINE VOLUMES.    * 01600016
*        -ASK FOR OPERATORS PERMISSION TO INITIALIZE A SPECIFIC VOL.  * 01800016
*        -IF OPERATOR REPLIES WITH A 'T', RETURN TO CALLER.RC=8.      * 02000016
*        -IF OPERATOR REPLIES WITH A 'U', BUILDS A DEB, LOADS IN      * 02200016
*         THE ABNORMAL-END APPENDAGE(IGG019P9), AND RETURNS TO        * 02400016
*         CALLER.RC=0.                                                * 02600016
*                                                                     * 02800016
*     2) ALTERNATE TRACK ASSIGNMENT REQUEST FOR GETALT FUNCTION.      * 03000016
*        -GETS CORE FOR A WORKAREA, BUILDS A DEB WITHIN THIS CORE,    * 03200016
*         AND PASSES CONTROL VIA A XCTL TO -IGC0108B- FOR THE         * 03400016
*         ACTUAL ALTERNATE TRACK ASSIGNMENT.                          * 03600016
*                                                                     * 03800016
*     3) ALTERNATE TRACK REQUEST BY FORMAT/ANALYZE FUNCTION.          * 04000016
*        -SAME AS OPERATION 2 ABOVE.                                  * 04200016
*                                                                     * 04400016
*     4) POST UCB REQUEST.                                            * 04600016
*        -PASSES CONTROL VIA A XCTL TO -IGC0208B-.                    * 04800016
*                                                                     * 05000016
*                                                                     * 05200016
*     5) SPECIAL POST UCB REQUEST.                                    * 05400016
*        -DELETES THE ABNORMAL-END APPENDAGE.                         * 05600016
*        -FREES THE CORE FOR THE DEB.                                 * 05800016
*        -PASSES CONTROL TO -IGC0208B-.                               * 06000016
*                                                                     * 06200016
         AIF   ('&LIB' EQ 'LIB1').X227900                        YM3475 06220002
*     6) DELETE DEB REQUEST.                                          * 06240002
*        -DELETES THE ABNORMAL-END APPENDAGE.                         * 06260002
*        -FREES THE CORE FOR THE DEB.                                 * 06280002
*                                                                     * 06300002
*     7) ISSUE SENSE FOR WINCHESTER DEVICES.                    XL03130 06310003
*        -ISSUE SENSE AND RETURN WINCHESTER MODEL NUMBER IN     XL03130 06310102
*         USERS' PARAMETER LIST + 4 :                           XL03130 06310202
*              MODEL 1 = F'01'                                  XL03130 06310302
*              MODEL 2 = F'02'                                  XL03130 06310802
*                                                                     * 06311202
*     8) ONLINE ENQ REQUEST.                                          * 06311902
*        -ENQ'S ON VOLID OF 'TODD' VOLUME.                      YL02912 06312402
*                                                                     * 06316102
.X227900 ANOP                                                    YM3475 06320002
*ENTRY POINT-  THE ONLY ENTRY POINT IS -IGC0008B-.                    * 06400016
*                                                                     * 06600016
*INPUT-  A PARAMETER LIST POINTED TO BY REGISTER 1 FOR THE ABOVE      * 06800016
*   DESCRIBED FUNCTIONS.                                              * 07000016
*                                                                     * 07200016
*     1) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=8F.                  * 07400016
*        -2ND WORD-   PTR TO DCB,HIGH ORDER BYTE=80.                  * 07600016
*                                                                     * 07800016
*     2) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=1F.                  * 08000016
*        -2ND WORD-   CCHH OF DEFECTIVE TRACK.                        * 08200016
*        -3RD WORD-   PTR TO DATA BUFFER                       @Z30RSAG 08250003
*                                                                     * 08400016
*     3) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=00.                  * 08600016
*        -2ND WORD-   CCHH OF DEFECTIVE TRACK.                        * 08800016
*        -3RD WORD-   PTR TO 6-BYTES OF ALT. TRACK INFO.              * 09000016
*                     HIGH ORDER BYTE WILL CONTAIN A X'01'     @Y30LSFY 09050003
*                     FOR SS1 CONVERSION.                      @Y30LSFY 09100003
*                                                                     * 09200016
*     4) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=08.                  * 09400016
*        -2ND WORD-   PTR TO 6-BYTE SERIAL NO, IF OVERWRITTEN.        * 09600016
*        -3RD WORD-   PTR TO MBBCCHHR FOR NEW VTOC.                   * 09800016
*                                                                     * 10000016
*     5) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=88.                  * 10200016
*        -2ND WORD-   PTR TO 6-BYTE SERIAL NO, IF OVERWRITTEN.        * 10400016
*        -3RD WORD-   PTR TO MBBCCHHR FOR NEW VTOC.                   * 10600016
*        -4TH WORD-   PTR TO DEB.                                     * 10800016
*                                                                     * 11000016
         AIF   ('&LIB' EQ 'LIB1').X227901                        YM3475 11020002
*     6) -1ST WORD-   RESERVED, HIGH ORDER BYTE=F8.                   * 11040002
*        -2ND WORD-   RESERVED.                                       * 11060002
*        -3RD WORD-   RESERVED.                                       * 11080002
*        -4TH WORD-   PTR TO DEB.                                     * 11100002
*                                                                     * 11120002
*     7) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=F1.            XL03130 11130003
*        -2ND WORD-   HIGH ORDER BYTE=80.                       XL03130 11130502
*                                                                     * 11130902
*     8) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=04.            YL02912 11131502
*        -2ND WORD-   ADDR OF FUNCBLK, HIGH ORDER BYTE=80.     @Z30RSAG 11132003
*     9) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=44.            YL02912 11132102
*                                                                     * 11134102
.X227901 ANOP                                                    YM3475 11140002
*EXITS-NORMAL-  RETURN TO CALLER VIA REG 14. RETURN CODE=0.           * 11200002
*                                                                     * 11400016
*EXITS-ERROR-   RETURN TO CALLER VIA REG 14. RETURN CODE=8.           * 11600002
*                                                                     * 11800016
*EXTERNAL ROUTINES- SVC IS ISSUED FOR THE FOLLOWING FUNCTIONS FROM    * 12000016
*                                                                     * 12200016
*   THE FOLLOWING MODULES.                                            * 12400016
*                                                                     * 12600016
*     1) IHEDANAL.                                                    * 12800016
*                                                                     * 13000016
*     2) IEHDGETA.                                                    * 13200016
*                                                                     * 13400016
*     3) IEHDANAL,IEHDCELL.                                           * 13600016
*                                                                     * 13800016
*     4) IEHDLABL,IEHDANAL,IEHDREST,IEHDDUMP                          * 14000016
*                                                                     * 14200016
*     5) IEHDANAL                                                     * 14400016
*                                                                     * 14600016
         AIF   ('&LIB' EQ 'LIB1').X227902                        YM3475 14640002
*     6) IEHDANAL,IEHDLABL.                                           * 14680002
*                                                                     * 14720002
*     7) IEHDASDS                                               XL03130 14730003
*                                                                     * 14732502
*     8) IEHDASDS, FOR ENQING ON THE TODD UCBS' VOLID.          YL02912 14737602
*                                                                     * 14740102
.X227902 ANOP                                                    YM3475 14760002
*SUPERVISOR MACROS-  GETMAIN,FREEMAIN,WTOR,WTO,LOAD,XCTL.             * 14800016
*                                                                     * 15000016
*TABLES/WORKAREAS-  OBTAINS A WORKAREA FOR -IGC0108B- WHICH IS        * 15200016
*   DESCRIBED BY THE DSECT -IOBLOCKS-.                                * 15400016
*                                                                     * 15600016
*OUTPUT-                                                              * 15800016
*     1) FOR FUNCTION NO. 1,BUILDS A PROPER DEB AND LOADS IN THE      * 16000016
*        ABNORMAL-END APPENDAGE.                                      * 16200016
*                                                                     * 16400016
*     -FOR ALL OTHER FUNCTIONS, SEE  -IGC0108B- OR -IBC0208B.         * 16600016
*                                                                     * 16800016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,PRIVILEGED,ENABLED.               * 17000016
*                                                                     * 17200016
*********************************************************************** 17250002
         EJECT                                                          17400002
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             17600016
PARMPTR  EQU   1                       POINTER TO INPUT PARAMETERS.     17800016
R0       EQU   0                                                        18000016
R1       EQU   1                                                        18200016
R2       EQU   2                                                        18400016
R3       EQU   3                                                        18600016
R4       EQU   4                                                        18800016
R6       EQU   6                                                        19000016
R7       EQU   7                                                 Y01021 19100000
R8       EQU   8                       TCB ADDRESS.                     19200016
R9       EQU   9                                                        19400016
R11      EQU   11                      POINTER TO INPUT PARAMETERS.     19600016
R14      EQU   14                      LINK REGISTER.                   19800016
R15      EQU   15                                                       20000016
GR0      EQU   0                                                        20200016
GR1      EQU   1                                                        20400016
GR2      EQU   2                       INDEX TO UCB TABLE ENTRIES.      20600016
GR3      EQU   3                       POINTER TO TABLE UCB.            20800016
GR4      EQU   4                       POINTER TO NEW SERIAL.           21000016
GR5      EQU   5                       POINTER TO TABLE UCB  SERIAL.    21200016
GR6      EQU   6                       POINTER TO INPUT UCB.            21400016
GR7      EQU   7                                                        21600016
GR8      EQU   8                                                        21800016
GR9      EQU   9                                                        22000016
GR10     EQU   10                                                       22200016
GR11     EQU   11                                                       22400016
GR12     EQU   12                                                       22600016
GR14     EQU   14                      LINK REGISTER.                   22800016
BASEREG  EQU   12                      BASE REGISTER.                   23000016
GR15     EQU   15                                                       23200016
         SPACE                                                          23400016
DYNALT   EQU   X'1F'                   GETALT ASSIGNMENT.               23600016
SENS     EQU   X'F1'                    SENSE REQUEST FOR WINCH XL03130 23650003
*                                                                       23700003
NEWVOL   EQU   X'8F'                   NEW VOLUME INPUT.                23800016
COMMA    EQU   C','                    EBCDIC COMMA.                    24000016
SLASH    EQU   C'/'                    2321 BIN SEPARATOR.              24200016
WSIZE    EQU   52                      CONSOLE MESSAGE SIZE.            24400016
DA2321   EQU   X'05'                   UCB DEVICE TYPE CODE FOR 2321.   24600016
LASTBIN  EQU   X'09'                   LAST BIN NO. FOR SUB-UCBS.       24800016
SUBLNG   EQU   16                      LENGTH OF EACH SUB-UCB.          25200016
MAINUCB  EQU   X'FF'                   PRIMARY UCB IDENTIFIER.          25400016
NOTREADY EQU   X'40'                   UCB NOT READY BIT.               25600016
PGFIXBIT EQU   X'80'                   PAGE FIX APPENDAGE PRESENT       25650000
         SPACE                                                          25800016
INIT     EQU   X'00'                   ANALYZE/FORMAT REQUEST.          26000016
POSTSPEC EQU   X'88'                   POST REQUEST FOR NEW VOLUMES.    26200016
POST     EQU   X'08'                   POST INDICATOR.                  26400016
RETURN   EQU   3                       RETURN SVC CODE.                 26800016
X06      EQU   X'06'                    HEX CONSTANT             S20201 26860020
X07      EQU   X'07'                    HEX CONSTANT             S20201 26920020
E0       EQU   0                        CONSTANT OF 0            Y01021 26930000
E3       EQU   3                        CONSTANT OF 3            Y01021 26940000
E4       EQU   4                        CONSTANT OF 4            Y01021 26950000
E5       EQU   5                        CONSTANT OF 5            Y01021 26960000
E8       EQU   8                        CONSTANT OF 8            Y01021 26970000
E12      EQU   12                       CONSTANT OF 12           Y01021 26972000
E44      EQU   44                       CONSTANT OF 44           Y01021 26980000
E45      EQU   45                       CONSTANT OF 45           Y01021 26990000
D3340    EQU   X'0A'                   3340 DEVICE TYPE        @Z30RSAG 26997403
EMUL     EQU   X'08'                   SNS BYTE 2 EMULATE BIT  @Z30RSAG 26997803
FOXES    EQU   X'FF'                    END OF P.L. FLAG FOR ENQ SJ0054 27004002
D0       EQU   0                        ZERO DISPLACEMENT.      YL02912 27018002
D1       EQU   1                        DISPL. OF ONE.          YL02912 27020002
D3       EQU   3                        DISPL. OF THREE         YM04695 27028002
HEX0     EQU   X'00'                    WILL ZERO ENQ R.C.      YM04695 27030402
L3       EQU   3                        LENGTH OF THREE.        YL02912 27032002
K36      EQU   36                       CONSTANT OF 36.         YL02912 27046002
PTRCVT   EQU   16                      CVT PTR ADDR              Y01021 27060002
         AIF   ('&LIB' EQ 'LIB1').X227903                        YM3475 27074002
DELDEB   EQU   X'F8'                    DEB DELETE REQUEST.      YM3475 27088002
NALOCOFF EQU   X'FB'                    MASK TO RESET UCBNALOC  YL02912 27102002
EIGHT    EQU   8                        RETURN CODE FROM ENQ    YL02912 27116002
ENQ      EQU   X'04'                    ONLINE ENQ FUNC BYTE    YL02912 27130002
DEQ      EQU   X'44'                    ONLINE DEQ FUNC BYTE    YL02912 27144002
ONE      EQU   GR1                      CONSTANT                YL02912 27158002
OFFLINE  EQU   X'88'                    OFFLINE LABEL IND.      YL02912 27168002
SS1LD    EQU   X'20'                   TRANSFER TO SS/1 LOAD   @Y30LSFY 27170003
.X227903 ANOP                                                    YM3475 27172002
         EJECT                                                          27186002
         BALR  BASEREG,0               SET UP ADDRESSING.               27200016
         USING *,BASEREG                                                27400016
         SPACE                                                          27600016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04363 27602003
         DC    C'IGC0008B OZ04363'     LAST FIX THIS MOD       @ZA04363 27604003
APARNO   LR    GR10,PARMPTR            GET PARAMETER POINTER.  @ZA04363 27610003
         SPACE                                                          27650002
*********************************************************************** 27710002
*                                                                     * 27770002
*  THE CALLERS PARAMETER LIST WILL BE PLACED INTO A FIVE WORD BLOCK   * 27830002
*   OF GOTTEN CORE OF THE SVC'S KEY. THE FIRST FOUR WORDS WILL BE A   * 27890002
*   COPY OF THE CALLER'S LIST AND THE LAST WORD WILL CONTAIN THE KEY  * 27950002
*   OF THE CALLER IN THE FIRST BYTE AND THE ADDRESS OF THE CALLER'S   * 28010002
*   LIST IN THE LAST THREE BYTES.                                     * 28070002
*                                                                     * 28130002
*********************************************************************** 28190002
         LR    GR8,GR4                 LOAD TCB PTR             XL03130 28220003
         SPACE                                                          28250102
         USING PARMLIST,R11                                     YL02912 28310102
         USING RBBASIC,GR5                                      YL02912 28370002
         MODESET EXTKEY=SUPR                                    YL02912 28380002
         ST    GR14,RBEXSAVE+K36        SAVE RETURN ADDRESS.    YL02912 28420002
         MODESET EXTKEY=DATAMGT                                 YL02912 28430002
         LA    R2,ENDLIST-PARMLIST      CORE FOR PARM LIST.     YL02912 28490002
         GETMAIN R,LV=(2),SP=229        FOR CALLER'S PARAMETER. YL02912 28550002
         LR    R11,R1                   SAVE NEW PARM POINTER.  YL02912 28610002
         ST    GR10,PRMPTR              SAVE OLD PARM POINTER.  YL02912 28670002
         LR    R8,R4                    GET ADDR OF CURRENT TCB.YL02912 28910002
         USING TCB,R8                                           YL02912 28970002
         SPACE                                                          29030002
         MODESET EXTKEY=RBT234,WORKREG=3  GET CALLER'S KEY.     YL02912 29090002
         LM    R1,R4,E0(GR10)           GET CALLER'S PARM LIST. YL02912 29150002
         MODESET EXTKEY=DATAMGT,SAVEKEY=KEY,WORKREG=15          YL02912 29210002
         STM   R1,R4,PARMLIST           CALLER'S LIST TO MINE.  YL02912 29270002
*********************************************************************** 29390002
*                                                                     * 29450002
*   DETERMINE THE FUNCTION TO BE PERFORMED.                           * 29510002
*                                                                     * 29570002
*********************************************************************** 29630002
         SPACE                                                          29690002
         AIF   ('&LIB' EQ 'LIB1').NOWIN BRCH IF OS ASSEM        XL03130 29740002
.NOWIN   ANOP                                                   XL03130 29740802
         CLI   FUNCTION,SENS           IS THIS A SENSE REQUEST. XL03130 29742002
         BE    SENSIT                  YES, GO ISSUE SENSE CMD  XL03130 29742402
         SPACE                                                          29744002
         CLI   FUNCTION,NEWVOL          NEW VOLUME REQUEST?     YL02912 29750002
         BE    NEWPACK                  YES, GO BUILD DEB.      YL02912 29810002
         SPACE                                                          29870002
         CLI   FUNCTION,DYNALT          DYNAMIC ALT TRK REQUEST?YL02912 29930002
         BE    ASSGALT                  YES, ASSIGN ALTERNATE.  YL02912 29990002
         SPACE                                                          30050002
         CLI   FUNCTION,INIT            ANALYZE/FORMAT REQUEST? YL02912 30110002
         BE    ASGALT1                  YES, PROCESS TRACK.     YL02912 30170002
         SPACE                                                          30230002
         CLI   FUNCTION,POST            POST UCB REQUEST?       YL02912 30290002
         BE    CKUCBS                   YES, UPDATE UCBS.       YL02912 30350002
         SPACE                                                          30410002
         CLI   FUNCTION,POSTSPEC        OFFLINE POST REQUEST?   YL02912 30470002
         BE    SPECPOST                 YES, UPDATE UCB.        YL02912 30530002
         SPACE                                                          30590002
         CLI   FUNCTION,DELDEB          DEB DELETE REQUEST?     YL02912 30650002
         BE    SPECPOST                 YES DELETE DEB.         YL02912 30710002
         SPACE                                                          30720002
         CLI   FUNCTION,ENQ             ENQUEUE REQUEST?        YL02912 30760002
         BE    ENQUE                    YES, UPDATE UCB.        YL02912 30762002
         SPACE                                                          31010003
         CLI   FUNCTION,SS1CONV         THIS AN ANALYZE REQUEST@Y30LSFY 31012003
*                                      TO ASSIGN AN ALTERNATE  @Y30LSFY 31012803
*                                      ON AN SS1 SPOOL PACK.   @Y30LSFY 31013203
         BE    ASGALT1                 YES-GO PROCESS.         @Y30LSFY 31014003
         TM    FUNCTION,SS1LD          TRANSFER TO SS/1 LOAD   @Y30LSFY 31014503
         BZ    XIT                     NO                      @Y30LSFY 31015003
*        TRANSFER TO THE SS/1 LOAD OF SVC 82                   @Y30LSFY 31015503
         LR    GR1,GR11                PARM LIST POINTER       @ZM31081 31016003
         LR    GR2,GR5                 RBBASIC POINTER         @ZM31081 31016503
         MODESET EXTKEY=SUPR                                   @Y30LSFY 31017003
         L     GR3,RBEXSAVE+K36        RETURN ADDRESS          @ZM31081 31017503
         STM   GR1,GR3,RBEXSAVE+K16    STORE LOAD LIST         @ZM31081 31018003
         LA    GR1,RBEXSAVE+K16        LIST ADDRESS FOR LOAD   @Y30LSFY 31018503
         LA    GR4,XCTL3               XCTL FOR NEXT LOAD      @Y30LSFY 31019003
         B     NEXTLOAD                GET NEXT LOAD           @Y30LSFY 31019503
         SPACE                                                          31120002
XIT      EQU   *                                                XL03130 31170003
         B     EXIT                     UNSUPPORTED FUNCTION.   YL02912 31200002
         EJECT                                                          31400016
         AIF   ('&LIB' EQ 'LIB1').NOWIN1 BRCH IF OS ASSEM       XL03130 31402003
**********************************************************************  31410003
*        THE FOLLOWING ROUTINE WILL ISSUE A 'SENSE' CMD TO THE          31420003
*        333X AND 3340 DEVICE BEING PROCESSED BY IEHDASDS. THE          31430003
*        SENSE WILL DETERMINE WINCHESTER MODEL BEING USED,     @Z30RSAG 31440003
*        AND/OR IF EMULATION IS OCCURRING.                     @Z30RSAG 31440403
**********************************************************************  31442003
         SPACE                                                          31444003
SENSIT   EQU   *                                                XL03130 31450003
         GETMAIN R,LV=88,SP=229         CORE FOR EXCP CTL BLKS  YL02130 31500002
         USING CTLBLKS,GR2                                      XL03130 31560003
         LR    GR2,GR1                  SAVE AREA ADDR          XL03130 31570003
         L     GR1,CVTPTR               GET CVT ADDR            XL03130 31570403
         USING CVT,GR1                                                  31570803
         LA    GR4,BUMP                 DCBORG                  XL03130 31572003
         XC    DCBORG(L88),DCBORG       CLEAR CTL BLKS          XL03130 31580003
         SR    GR2,GR4                  RESET DSECT BASE        XL03130 31582003
         L     GR3,UCBPTR               GET UCB ADDR            XL03130 31590002
         USING UCB,GR3                                          XL03130 31590403
         MODESET EXTKEY=SUPR                                     YM5769 31591302
         NI    UCBFL1,MASK-UCBNOTRD    TURN OFF NOT-READY BIT   XL03130 31591603
         MODESET EXTKEY=DATAMGT                                  YM5769 31594802
         ST    GR3,DEBUCB               STORE UCB IN DEB        XL03130 31601902
         MVI   DEBUCB,INIT              ZERO FILE MASK          XL03130 31605102
         LA    GR3,ECB1                 GET ECB ADDR            XL03130 31608302
         ST    GR3,IOBECB               STORE IT IN IOB         XL03130 31611502
         MVC   CCW,SENSCCW              MOVE SKELTON CCW        XL03130 31614702
         LA    GR4,CCW                  GET CCW ADDR            XL03130 31617902
         ST    GR4,IOBCCW               STORE IN IOB            XL03130 31621102
         LA    GR4,SENSE                GET AREA ADDR           XL03130 31624302
         ST    GR4,CCW                  SETUP SENSE CCW         XL03130 31627502
         MVI   CCW,SENSEOP              RESET OP CODE           XL03130 31630702
         ST    GR2,DEBDCB               PUT DCB ADDR IN DEB     XL03130 31633902
         MVC   DEBAPP(L4),CVTXAPG       APPDGE VECTOR TABL ADDR XL03130 31637102
         ST    GR2,IOBDCB               DCB ADDR IN IOB         XL03130 31640302
         LA    GR4,DEBORG               LOAD DEB ADDR           XL03130 31643502
         ST    GR4,DCBDEB               STORE IT IN DCB         XL03130 31646702
         MVC   DEBDCB(L1),TCBPKF        MOVE TCB KEY TO DEB     XL03130 31649902
         OI    DEBDCB,DEBID             SET DEB ID              XL03130 31659903
         EXCP  IOB1                     ISSUE SENSE CMD         XL03130 31669903
         WAIT  ECB=ECB1                 WAIT FOR SENSE          XL03130 31679903
         L     GR3,UCBPTR              GET UCB ADDR            @Z30RSAG 31681903
         CLI   ECB1,GOODRT              SUCCESSFUL SENSE ?      XL03130 31689903
         BNE   FREEIT                   NO, DONT SET MODEL NO.  XL03130 31691903
         CLI   UCBTBYT4,D3340          THIS A 3340 ?           @Z30RSAG 31693903
         BNE   INTSNS                  NO, GO LOOK AT SNS      @Z30RSAG 31694303
         TM    SENSE+L2,MOD1            36MEG WINCH. ?          XL03130 31695903
         BO    STORE1                   YES, GO STORE X'01'     XL03130 31696303
         TM    SENSE+L2,MOD2            72 MEG WINCH            XL03130 31696403
         BNO   FREEIT                   NO, EXIT                XL03130 31696503
         MVI   WINMOD,MOD2              MOVE MODEL NO TO PL     XL03130 31699202
         B     FREEIT                   EXIT                    XL03130 31701203
STORE1   EQU   *                                                XL03130 31702403
         MVI   WINMOD,MOD1              MOVE MODEL NO TO PL     XL03130 31704402
FREEIT   EQU   *                                                XL03130 31705103
         LA    GR2,BUMP(GR2)            RESET CORE PTR          XL03130 31707803
         FREEMAIN R,LV=88,A=(GR2),SP=229 FREE CTL BLK CORE      YL02130 31710502
         L     GR4,PRMPTR               CALLER'S LIST ADDR.     YL02912 31712502
         IC    GR9,WINMOD              GET WINCH MODEL NO.      VS02889 31712902
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.       YL02912 31714502
         STC   GR9,L7(GR4)             STORE MODEL NO. IN P.L.  VS02889 31714902
         MODESET EXTKEY=DATAMGT                                 YL02912 31715002
         CLI   WINMOD,INIT              WAS SENSE GOOD ?        XL03130 31715202
         BNE   EXIT                     YES, EXIT               XL03130 31715602
         BAL   R9,FREEPARM              GO FREE PARM LIST.              31720302
         LA    GR15,GR15                NO, SET NON-ZERO R.C.   XL03130 31725002
         B     EXIT2                    RETURN TO 'DASDS        XL03130 31729702
         DROP GR1                                                       31734402
         USING FUNCBLK,GR3                                     @Z30RSAG 31736403
INTSNS   EQU   *                                               @Z30RSAG 31738603
         L     GR3,SENSFB              LOAD FUNCBLK PTR        @Z30RSAG 31739003
         TM    SENSE+L2,EMUL           THIS DEV EMULATED ?     @Z30RSAG 31745803
         BNO   STORE1                  NO EXIT THIS RTNE       @ZM40451 31747803
         MODESET KEYADDR=KEY,WORKREG=15                        @ZM40430 31748203
         OI    FLGBYT1,EMU             YES, TURN ON FLAG       @Z30RSAG 31749803
         MODESET EXTKEY=DATAMGT                                @ZM40430 31750203
         B     STORE1                  EXIT TO IEHDASDS        @ZM40451 31751803
         DROP GR3                                              @Z30RSAG 31752203
         EJECT                                                          31752603
.NOWIN1  ANOP                                                   XL03130 31759403
SPECPOST EQU   *                                                        31779703
         DELETE EP=IGG019P9            FREE UP CORE USED BY APPENDAGE.  31800016
         AIF   ('&LIB' EQ 'LIB1').WM004                                 31810000
         DELETE EP=IGG019P7            FREE UP CORE USED BY      YM3011 31850000
*                                          APPENDAGE.                   31860000
.WM004   ANOP                                                           31900000
         L     GR6,DEBPTR               ADDRESS OF DEB.         YL02912 32000002
         LA    GR0,DEB-MYDEB           OFFSET FORM WORKAREA START.      32200016
         SR    GR6,GR0                 START OF WORK AREA.      YL02912 32400002
         USING MYDEB,GR6                                        YL02912 32600002
         AIF   ('&LIB' EQ 'LIB1').WM008                                 32602000
         L     GR4,DEBUCBAD-ONE         GET UCB ADDR            YL02912 32604002
         USING UCB,GR4                                          YL02912 32606002
         MODESET EXTKEY=SUPR                                    YL02912 32606402
         NI    UCBFL5,NALOCOFF          SET BIT OFF             YL02912 32608002
         MODESET EXTKEY=DATAMGT                                 YL02912 32608402
         L     GR4,DEBDEBID             GET DCB ADDR             Y01021 32610000
         LA    GR4,E0(GR4)              CLEAR HIGH ORDER BYTE    Y01021 32620000
         DEBCHK (GR4),TYPE=DELETE,AM=EXCP                       YL02912 32622002
         EJECT                                                          32622402
*********************************************************************** 32624002
*                                                                     * 32626002
*    TAKE DEB OFF TCB DEB CHAIN.                                      * 32628002
*                                                                     * 32630002
*********************************************************************** 32630402
         SPACE                                                          32630802
         LA    GR9,DEBDEBAD             GET ADDRESS OF NEXT DEB.YL02912 32632002
         CLC   TCBDEB+D1(L3),DEBPTR+D1  TCB POINT TO MY DEB?    YL02912 32642002
         BNE   GETDEB                   NO,SEARCH DEB CHAIN.    YL02912 32644002
         MODESET EXTKEY=SUPR                                    YL02912 32644102
         MVC   TCBDEB+D1(L3),D0(GR9)    YES, UNCHAIN DEB.       YL02912 32644402
         MODESET EXTKEY=DATAMGT                                 YL02912 32644602
         B     FREEDEB                  GO FREE DEB AREA.       YL02912 32645002
         SPACE                                                          32645202
GETDEB   EQU   *                                                YL02912 32645402
         L     GR4,TCBDEB               GET DEB CHAIN POINTER.  YL02912 32645602
         USING DEB,GR4                                          YL02912 32645802
CHKDEB   EQU   *                                                YL02912 32646002
         CLC   DEBDEBAD(L3),DEBPTR+D1   DEB POINT TO MY DEB?    YL02912 32647602
         BE    OURDEB                   YES, GO UNCHAIN.        YL02912 32648002
         L     GR4,DEBDEBAD-D1          NO, GET NEXT DEB.       YL02912 32648402
         B     CHKDEB                   CHECK NEXT DEB.         YL02912 32648502
         SPACE                                                          32648602
OURDEB   EQU   *                                                YL02912 32648702
         MVC   DEBDEBAD(L3),D0(GR9)     UNCHAIN MY DEB.         YL02912 32648802
         B     FREEDEB                  GO FREE DEB AREA.       YL02912 32648902
         DROP  GR4                                              YL02912 32649002
         EJECT                                                          32649102
*********************************************************************** 32649302
*        THE FOLLOWING ROUTINE WILL CAUSE THE DASDI DEVICE TO BE ENQ'ED 32649402
*        UPON, VIA ITS' VOLID. THE INITIATORS' TCB WILL BE USED IN      32649502
*        THE EVENT IEHDASDR SHOULD ABEND BEFORE DEQ'ING.                32649602
*********************************************************************** 32649902
         SPACE                                                          32650202
ENQUE    EQU   *                                                YL02912 32650502
         L     GR6,UCBPTR               GET UCB ADDR YL02912            32651102
         USING UCB,GR6                                          YL02912 32651402
         LA    GR7,UCBVOLI              GET ADDR OF VOLID  YL02912      32651702
         L     GR9,TCBOTC               LOAD MOTHER TCB ADDR    YM03804 32652002
         MVC   ENQLIST(SYSQ-ENQLISTF),ENQLISTF MOVE LIST TO W/A YM03804 32652402
*                                                                       32652602
         ENQ   (,(GR7),E,6,SYSTEM),RET=USE,TCB=(GR9),           YM03804*32652902
               MF=(E,ENQLIST)                                   YM03804 32653202
*                                                                       32653502
         LTR   GR15,GR15                HAVE WE GOT THE RESR ?  YL02912 32653802
         BZ    EXIT                     YES, BRCH               YL02912 32654102
         LA    GR15,D3(GR15)            INCRE TO R.C.           YL02912 32654402
         CLI   0(GR15),EIGHT            RC = 8 ?                YL02912 32654702
         BE    ENQAGN                   YES, RE-ENQ             YL02912 32655002
         BAL   R9,FREEPARM              FREE PARAMETER LIST.    YL02912 32655302
         LA    GR15,NOGO                SOMEONE ELSE HAS RESRC  YL02912 32655602
         B     EXIT2                    RETURN TO 'DASDS        YL02912 32655902
ENQAGN   EQU   *                                                YL02912 32656202
*                                                                       32656802
         MVI   ENQLIST+D3,HEX0          ZERO R.C.               YM04695 32656902
         ENQ   (,(GR7),E,6,SYSTEM),RET=CHNG,TCB=(GR9),          YM03804*32657102
               MF=(E,ENQLIST)                                   YL02912 32657402
*                                                                       32657702
         LTR   GR15,GR15                HAVE WE GOT THE RESRC?  YL02912 32658002
         BZ    EXIT                     YES, RETURN TO 'DASDS   YL02912 32658302
         LA    GR15,D3(GR15)            INCRE TO R.C.           YL02912 32658602
         CLI   0(GR15),EIGHT            RC = 8 ?                YL02912 32658902
         BE    ENQUE                    ENQ WITH RET=USE        YL02912 32659202
         BAL   R9,FREEPARM              FREE PARAMETER LIST.    YL02912 32659502
         LA    GR15,NOGO                SOMEONE ELSE HAS RESRC  YL02912 32659902
         B     EXIT2                                            YL02912 32660302
FREEDEB  EQU   *                        CONTINUE                 YM2646 32686500
         LR    GR1,GR6                  GET DEB ADDRESS.        YL02912 32686602
         USING MYDEB,GR1                                        YL02912 32686902
         L     GR4,DEBDEBID             GET DCB ADDRESS.         YM3475 32687302
         L     GR6,BLANKS               GET BLANK DDNAME.        YM3475 32687702
         MODESET KEYADDR=KEY,WORKREG=2  GET CALLER'S KEY.       YL02912 32687902
         ST    GR6,E44(GR4)             SET BLANKS IN DCB DDNAME.YM3475 32688102
         MODESET EXTKEY=DATAMGT                                 YL02912 32688302
.WM008   ANOP                                                           32723400
         LA    R3,DEBEND-MYDEB          SIZE OF DEB WORKAREA.   YL02912 32725602
         FREEMAIN R,LV=(3),A=(1),SP=230                          YM4604 32737802
         LR    GR1,GR11                RESTORE PARM POINTER.            32750000
         AIF   ('&LIB' EQ 'LIB1').X227102                        YM3475 32751002
         CLI   FUNCTION,DELDEB          DEB DELETE REQUEST?     YL02912 32752002
         BNE   CKUCBS                   NO, GO POST UCBS.        YM3475 32753002
EXIT     EQU   *                                                YL02912 32753402
         BAL   R9,FREEPARM              GO FREE PARM LIST.      YL02912 32753502
         SR    R15,R15                  SET RETURN CODE ZERO.   YL02912 32753902
EXIT2    EQU   *                                                YL02912 32757102
         L     R14,RBEXSAVE+K36         GET RETURN ADDRESS.     YL02912 32759102
         MODESET EXTKEY=SUPR                                    SJ0054  32759502
         BR    R14                      RETURN.                 YL02912 32760402
.X227102 ANOP                                                    YM3475 32763602
         SPACE                                                          32766802
CKUCBS   EQU   *                                                        32770000
         MODESET EXTKEY=SUPR                                    YL02912 32820002
         ST    GR11,RBEXSAVE+K16       SAVE PARM POINTER.       YL02912 33800002
         LR    GR1,GR5                 ADDRESS OF EXTENTED SAVE AREA.   34000016
         LA    GR4,XCTL1               ADDRESS OF XCTL LIST.            34200016
         B     NEXTLOAD                GO BRING IN NEXT LOAD.           34400016
         SPACE 2                                                        34600016
         USING IOBLOCKS,R2                                              36000016
FREEPARM EQU   *                                                YL02912 36050002
         LA    R3,ENDLIST-PARMLIST      SIZE OF PARM LIST.      YL02912 36100002
         LR    R1,R11                   ADDRESS OF PARM LIST.   YL02912 36150002
FREECORE EQU   *                       RELEASE THE CORE HERE.           36200016
         FREEMAIN R,LV=(3),A=(1),SP=229 FREE THE WORK AREA.     YL02912 36400002
         BR    R9                      RETURN.                          36600016
         EJECT                                                          36800016
*********************************************************************** 37000016
*                                                                     * 37200016
*   ASK FOR PERMISSION TO INITIALIZE THIS VOLUME HERE.                  37400016
*                                                                     * 37600016
*********************************************************************** 37800016
NEWPACK  EQU   *                       BUILD A DEB FOR A NEW VOLUME.    38000016
         LA    R2,WTORP1-MSG           SIZE OF GETMAIN AREA.            38400002
         GETMAIN R,LV=(2),SP=229       CORE FOR MESSAGE AREA.   YL02912 38600002
         LR    R2,R1                   SAVE ADDRESS OF WORKAREA.        38800016
         USING MSG,R2                                                   39000016
TRYAGAIN EQU   *                                                        39200016
         XC    MSG(WTORP1-MSG),MSG     CLEAR AREA TO ZERO.              39400016
         MVC   MSG(WTOREND-WTORP),WTORP PLACE MESSAGE IN WORKAREA.      39600016
         SPACE                                                          39800016
         USING UCB,R6                                                   40000016
         L     R6,UCBPTR                UCB ADDRESS.            YL02912 40200002
         AIF  ('&LIB' EQ 'LIB2').X301001                        XL03912 40250003
         CLI   UCBID,MAINUCB           THIS A 2321.                     40400016
         BNE   W2321                   YES-GO PROCESS.                  40600016
         SPACE                                                          40800016
FIXMSG   EQU   *                                                        41000016
.X301001 ANOP                                                   XL03912 41050003
         MODESET EXTKEY=SUPR                                    YL02912 41100002
         NI    UCBFL2,X'FF'-X'40'  *** TURN-OFF NOT READY BUT.  ******* 41200016
         MODESET EXTKEY=DATAMGT                                 YL02912 41300002
         MVC   MSG6(3),UCBNAME         EBCDIC NAME TO MESSAGE.          41400016
         LA    GR4,INITIAL                                         O122 41430019
         CLI   DCBPTR,OFFLINE          OFFLINE LABEL REQUEST?   YL02912 41460002
         BNE   FIXMSGA                 NO-ANALYZE-ALL SET.         O122 41490019
         LA    GR4,LABELL              YES-POINT TO LABEL WORD.@Z30RSAG 41520003
FIXMSGA  MVC   MSG5+34(10),0(GR4)      FINISH SETTING UP MESSAGE.  O122 41550019
         SPACE                                                          41600016
         LA    R4,REPLY                REPLY ADDRESS.                   41800016
         LA    R3,WECB                 ECB ADDRESS FOR WTOR.            42000016
         LR    R1,R2                   INSURE ADDRESS IS SET FOR LIST.  42200016
         WTOR  ,(4),1,(3),MF=(E,(1))   ASK FOR PERMISSION TO INITIALIZE 42400016
*                                                                     * 42600016
         WAIT  ECB=WECB                AWAIT FOR REPLY.                 42800016
         CLI   REPLY,C'U'              DOES REPLY INDICATE 'USE'.       43000016
         BE    USE                     YES-GO BUILD A DEB.              43200016
         CLI   REPLY,C'T'              DOES REPLY INDICATE TERMINATE.   43400016
         BE    NOUSE                   YES--EXIT NOW.                   43600016
         MVC   MSG(WTOEND-WTO),WTO     MESSAGE TO BUFFER.               43800016
         LR    R1,R2                   ISURURE LIST ADDRESS IS SET.     44000016
         WTO   ,MF=(E,(1))             TELL OPERATOR ABUOT ERROR.       44200016
         B     TRYAGAIN                REPEAT THE REQUEST.              44400016
*                                                                     * 44600016
NOUSE    EQU   *                       DEB BUILDING TERMINATED.         44800016
         LA    R3,WTORP1-MSG           LENGTH OF WORK AREA.             45000002
         LR    R1,R2                   ADDRESS OF WORKAREA.             45200016
         BAL   GR9,FREECORE            GO FREE THE WORKAREA.            45400016
         BAL   R9,FREEPARM              GO FREE PARM LIST.      YL02912 45500002
         LA    R15,8                   SET RETURN CODE.                 45600016
         B     EXIT2                    RETURN TO CALLER.       YL02912 45800002
         EJECT                                                          46000002
OFFLENQ  EQU   *                                                YL02912 46010002
         LA    GR4,SYSQ                 ADDR OF QNAME HDR       YL02912 46020002
         LA    GR6,Q4                   ADDR OF RNAME ID        YL02912 46030002
         L     GR7,TCBOTC               GET MOTHER' TCB ADDR    YM03804 46040002
         MVC   ENQLIST(SYSQ-ENQLISTF),ENQLISTF MOVE LIST TO W/A YM03804 46040402
*                                                                       46042002
         ENQ   ((GR4),(GR6),E,2,SYSTEM),RET=USE,TCB=(GR7),             *46044002
               MF=(E,ENQLIST)                                           46046002
*                                                                       46048002
         L     GR1,UCBPTR               DEQ'ED UCB ADDR         YL02912 46048402
         USING UCB,GR1                                                  46048802
         TM    UCBSTAT,UCBONLI          THIS UCB STILL OFFLINE? YL02912 46049202
         BO    ERR                      NO, DEQ AND LEAVE.      YL02912 46049602
         MODESET EXTKEY=SUPR                                    YL02912 46049702
         OI    UCBFL5,UCBNALOC          SET FLAG FOR DEV ALLOC  YL02912 46049802
*                                       AND VARY PROCESSOR.     YL02912 46074902
         MODESET EXTKEY=DATAMGT                                 YL02912 46084902
DEQU     EQU   *                                                YL02912 46087402
         DEQ   ((GR4),(GR6),2,SYSTEM),RET=HAVE,TCB=(GR7),       YL02912*46099902
               MF=(E,ENQLIST)                                           46109902
*                                                                       46119902
         BR    GR9                      EXIT                    YL02912 46129902
ERR      EQU   *                                                YL02912 46139902
         LA    GR9,ERREXIT              SVC RETURN CODE SET     YL02912 46141902
         B     DEQU                     DEQUEUE FROM SYSQ HDR   YL02912 46143902
ERREXIT  EQU   *                                                YL02912 46145902
         BAL   R9,FREEPARM              GO FREE PARM LIST.      YL02912 46146302
         LA    GR15,NOGO                SETUP SVC RETURN CODE   YL02912 46147902
         B     EXIT2                    EXIT TO DASDS           YL02912 46148302
         EJECT                                                  YL02912 46148702
         AIF  ('&LIB' EQ 'LIB2').X301002                        XL03912 46149902
         USING DATACELL,GR6                                             46200016
W2321    MVC   MSG6+4(1),DCELBBNR+1    BIN NO. TO MESSAGE.              46400016
         OI    MSG6+4,X'F0'            SET ZONE BITS.                   46600016
         MVI   MSG6+3,SLASH            BIN SEPARATOR.                   46800016
         BAL   GR14,CONV2321           FIND MAIN UCB ADDRESS.           47000016
         B     FIXMSG                  GO COMPLETE THE MESSAGE.         47200016
.X301002 ANOP                                                   XL03912 47250003
*********************************************************************** 47600016
*                                                                     * 47800016
*   BUILD A DEB FOR A NEW VOLUME HERE.                                * 48000016
*                                                                     * 48200016
*********************************************************************** 48400016
USE      EQU   *                       OKAY TO BUILD A DEB.             48800016
         LA    R3,WTORP1-MSG           LENGTH OF WORK AREA.             49000002
         LR    R1,R2                   ADDRESS OF WORKAREA.             49200016
         BAL   GR9,FREECORE            GO FREE THE WORKAREA.            49400016
         L     R3,DCBPTR                DCB ADDRESS.            YL02912 49600002
         LA    R2,DEBEND-MYDEB         SIZE OF DEB.                     49800016
         USING MYDEB,GR1                                         YM4604 49850002
         GETMAIN R,LV=(2),SP=230                                 YM4604 50010002
         LR    R2,R1                   SAVE AREA ADDRESS.        YM4604 50020002
         XC    MYDEB(DEBEND-MYDEB),MYDEB  CLEAR DEB TO ZER.      YM4604 50030002
         BAL   GR9,OFFLENQ              ENQ FOR OFFLINE UCB     YL02912 50050002
         BAL   R9,BUILDDEB             GO BUILD A DEB.                  50200016
         AIF   ('&LIB' EQ 'LIB2').WM007                                 50250000
         ST    R4,44(R3)                DEB ADDRESS TO DCB              50300000
.WM007   ANOP                                                           50350000
         USING IOBLOCKS,GR2                                             50600016
         L     R4,DEBAPPAD-1           ADDRESS OF APPENDAGE TABL5#      50800016
         MVC   DEBEOEA(20),0(R4)       PLACE IN DEB.                    51000016
         LA    R4,DEBEOEA              ADDRESS OF NEW TABLE.            51200016
         ST    R4,DEBAPPAD-1           SAVE ADDRESS IN DEB.             51400016
         MVZ   DEBDEBID(L1),TCBPKF      PROTECT KEY TO DEB.     YL02912 51600002
         CLI   FUNCTION,POSTSPEC        OFFLINE LABEL REQUEST?  YL02912 51700002
         BE    EXIT                     YES, NOT NEED APPENDAGE.YL02912 51800002
         EJECT                                                          51900002
*********************************************************************** 52000016
*                                                                     * 52200016
*   LOAD IN THE ABNORMAL END APPENDAGE HERE.                          * 52400016
*                                                                     * 52600016
*********************************************************************** 52800016
         USING CVT,1                                                    53200016
         L     GR1,CVTPTR              CVT ADDRESS.                     53400016
         L     GR4,CVTSVDCB            DCB ADDRESS.                     53600000
         LOAD  EP=IGG019P9,DCB=(4)                                      53800000
         ST    R0,DEBXCEA              PLACE ADDRESS IN DEB.            54000016
         AIF   ('&LIB' EQ 'LIB1').WM001                                 54050000
         SRL   GR1,7(0)                SAVE SIZE OF MODULE       M4873  54060000
         LA    GR1,1(GR1)              IN 2K BYTES IN            M4873  54080000
         STC   GR1,DEBXCEA             AVT TABLE                 M4873  54090000
         LOAD  EP=IGG019P7,DCB=(4)     LOAD PAGE FIX APPENDAGE   M5431  54092000
         ST    R0,DEBSIOA              PLACE ADDRESS IN DEB       M5431 54094000
         SRL   GR1,7(0)                SAVE SIZE OF MODULE        M5431 54096000
         LA    GR1,1(GR1)              IN 2K BYTES IN             M5431 54098000
         STC   GR1,DEBSIOA             AVT TABLE                  M5431 54098400
         OI    DEBSIOA,PGFIXBIT        SHOW APPENDAGE IS PAGE FIX M5431 54098800
.WM001   ANOP                                                           54099200
         B     EXIT                     RETURN TO CALLER.       YL02912 54100002
         DROP  2                                                        54600016
         EJECT                                                          54800016
*********************************************************************** 55000016
*                                                                     * 55200016
*   ASSIGN ALTERNATE TRACKS HERE.                                     * 55400016
*        1)    GETALT REQUEST(MUST READ IN FORMAT4 DSCB)              * 55600016
*        2)    ANALYZE/FORMAT REQUEST.                                * 55800016
*                                                                     * 56000016
*********************************************************************** 56200016
         SPACE 3                                                        56400016
ASSGALT  EQU   *                       GETALT/DYNAMIC TRACK ASSIGN.     56600016
         LA    R2,IOEND-MYDEB          SIZE OF GETMAIN AREA.            56800016
         LR    R4,R2                   SIZE OF AREA.             YM6524 56850002
         BAL   R9,GETMAIN              OBTAIN A WORK AREA.       YM6524 56900002
         USING IOBLOCKS,R2                                       YM6524 56950002
         XC    IOEND1(IOEND-IOEND1),IOEND1    CLEAR EXTENSION.   YM6524 56960002
         B     CLEAR                   GO TO CLEAR REST.         YM6524 57000002
         SPACE 3                                                        57200016
         USING MYDEB,GR1                                         YM6524 57250002
GETMAIN  EQU   *                                                 YM6524 57300002
         GETMAIN R,LV=(2),SP=229                                 YM6524 57350002
         LR    R2,R1                   SAVE AREA ADDRESS.        YM6524 57360002
         XC    MYDEB(DEBEND-MYDEB),MYDEB  CLEAR DEB TO ZER.      YM6524 57370002
         BR    R9                      RETURN.                   YM6524 57380002
         SPACE 3                                                 YM6524 57390002
ASGALT1  EQU   *                                                        57400016
         LA    R2,IOEND1-MYDEB         SIZE OF GETMAIN AREA.            57600016
         LR    R4,R2                   SIZE OF AREA.                    58000016
         BAL   R9,GETMAIN              OBTAIN A WORK AREA.       YM6524 59260002
CLEAR    STH   R4,SIZE                 REMEMBER THE SIZE.        YM6524 59310002
         XC    ECB(IOEND1-ECB),ECB     CLEAR PART OF WORK AREA.  YM6524 59360002
         LA    GR3,DCB-44              DCB ADDRESS.                     59400016
         BAL   R9,BUILDDEB             GO BUILD A DEB.                  59600016
         ST    R4,DCB                  DEB ADDRESS TO DCB.              59800016
         LR    GR3,GR11                PARM LIST POINTER.               60000016
         LR    GR4,GR2                 WORKAREA POINTER.                60200016
         L     GR7,UCBPTR               ADDRESS OF UCB.         YL02912 60220002
         USING UCB,GR7                                           S20201 60240020
         MODESET EXTKEY=SUPR                                    YL02912 60250002
         CLI   UCBTBYT4,X06             IS THIS A 2305 MOD 1.    S20201 60260020
         BE    ASGALT3                  YES                      S20201 60280020
         CLI   UCBTBYT4,X07             IS THIS A 2305 MOD 2.    S20201 60300020
         BE    ASGALT3                                           S20201 60320020
         STM   GR3,GR5,RBEXSAVE+K16     STORE 2ND LOAD LIST.    YL02912 60400002
         LA    GR1,RBEXSAVE+K16         LIST ADDR FOR 2ND LOAD. YL02912 60600002
         LA    GR4,XCTL                XCTL LIST FOR NEXT LOAD.         60800016
         B     NEXTLOAD                                          S20201 60820020
ASGALT3  EQU   *                                                 S20201 60840020
         DROP  GR7                                               S20201 60860020
         STM   GR3,GR5,RBEXSAVE+K16     STORE 4TH LOAD LIST.    YL02912 60880002
         LA    GR1,RBEXSAVE+K16         LIST ADDR FOR 4TH LOAD. YL02912 60900002
         LA    GR4,XCTL2                                         S20201 60920020
         SPACE 2                                                        61000016
NEXTLOAD EQU   *                       MUST BRING IN THE NEXT LOAD.     61200016
         MVC   RBEXSAVE(XCTLEND-XCTL),E0(GR4)  GET XCTL LIST.   YL02912 61400002
         LA    GR15,RBEXSAVE            ADDR OF EXTENDED AREA.  YL02912 61600002
         LA    GR6,8(GR15)             ADDRESS OF ENTRY POINT.          61800016
         ST    GR6,0(GR15)             STORE IN LIST LIST.              62000016
         MODESET EXTKEY=DATAMGT                                  YM1315 62050002
         XCTL  ,MF=(E,(1)),SF=(E,(15))                          YM03870 62200002
         EJECT                                                          62400016
*********************************************************************** 62600016
*                                                                     * 62800016
*   BUILD A DEB HERE.                                                 * 63000016
*        R3 CONTAINS THE DCB ADDRESS UPON INPUT.                        63200016
*        R4 CONTAINS THE DEB ADDRESS UPON EXIT.                         63400016
*        R9 IS THE RETURN REGISTER.                                     63600016
*                                                                     * 63800016
*********************************************************************** 64000016
BUILDDEB EQU   *                                                        64200016
         MVI   DEBNMEXT,1              SET NO. OF EXTENTS.              64400016
         MVI   DEBENDCC,X'7F'          SET UPPER EXTENT LIMIT.          64600016
         MVI   DEBNMTRK,X'7F'          SET NO. OF TRACKS.               64800016
         ST    R3,DEBDCBAD-1           DCB ADDRESS TO DEB.              65000016
         MVI   DEBDEBID,X'0F'          PROTECT KEY//ID.                 65200016
         AIF  ('&LIB' EQ 'LIB2').X301003                        XL03912 65250003
         L     GR4,UCBPTR               ADDRESS OF UCB.         YL02912 65400002
         USING UCB,GR4                                                  65600016
         CLI   UCBTBYT4,X06             IS THIS A 2305-1.        S20201 65620020
         BE    SW2305                   SET 2305 SWITCH.         S20201 65640020
         CLI   UCBTBYT4,X07             IS THIS A 2305-2.        S20201 65660020
         BNE   CHK2321                  NO-CHECK FOR 2321        S20201 65680020
SW2305   EQU   *                                                 S20201 65700020
         OI    DEVTYP,MAINUCB           YES-SET DEVICE BYTE.     S20201 65720020
         B     BUILD                    CONTINUE PROCESS         S20201 65740020
CHK2321  EQU   *                                                 S20201 65760020
         CLI   UCBID,MAINUCB           THIS A 2321.                     65800016
         DROP  GR4                                                      66000016
         BNE   DEB2321                 YES-GO PROCESS                   66200016
BUILD    EQU   *                        *                        S20201 66300020
.X301003 ANOP                                                   XL03912 66350003
         MVC   DEBUCBAD(L3),UCBPTR+D1   UCB ADDRESS TO DEB.     YL02912 66400002
BUILD1   MVI   DEBDVMOD,X'C0'          SET THE FILE MASK.               66600016
         L     R4,CVTPTR               ADDRESS OF CVT.                  66800016
         USING CVT,R4                                                   67000016
         L     R4,CVTXAPG              APPENDAGE TABLE ADDRESS.         67200016
         DROP  R4                                                       67400016
         ST    R4,DEBAPPAD-1           STORE IN DEB.                    67600016
         LA    R4,DEB                  DEB ADDRESS.                     67800016
         AIF   ('&LIB' EQ 'LIB1').WM006                                 67810000
         CLI   FUNCTION,NEWVOL          NEW VOLUME REQUEST?     YL02912 67820002
         BNE   NOCHK4                   NO, DEB WILL NOT BE      Y01021 67860000
*                                       VALIDATED                Y01021 67880000
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLERS KEY.        YL02912 67885002
         ST    R4,E44(R3)               DEB ADDR TO DCB          Y01021 67890000
         MODESET EXTKEY=DATAMGT                                 YL02912 67891002
         EJECT                                                          67891402
**********************************************************************  67892000
*        PLACE DEB ON TCB DEB CHAIN                                  *  67894000
**********************************************************************  67896000
         SPACE                                                          67896402
         USING DEB,GR4                                          YL02912 67897602
         ST    R8,DEBTCBAD-D1           PUT TCB PTR IN DEB      YL02912 67898002
         L     R7,TCBDEB                GET DEB PTR FROM TCB    YL02912 67898402
         ST    R7,DEBDEBAD-D1           DEB CHAIN PTR TO MY DEB.YL02912 67908002
         MODESET EXTKEY=SUPR                                    YL02912 67908402
         ST    R4,TCBDEB                CHAIN MY DEB.           YL02912 67910002
         MODESET EXTKEY=DATAMGT                                 YL02912 67912002
         DEBCHK (R3),TYPE=ADD,AM=EXCP                            YM0960 67913300
         LR    GR1,GR11                 RESTORE PARM POINTER     YM2646 67915300
NOCHK4   EQU   *                                                 Y01021 67920000
.WM006   ANOP                                                           67970000
         BR    R9                      RETURN.                          68000016
         AIF  ('&LIB' EQ 'LIB2').X301004                        XL03912 68050003
         SPACE                                                          68200016
         USING DATACELL,GR6                                             68400016
DEB2321  LR    GR6,GR4                 SUB-UCB ADDRESS.                 68600016
         MVC   DEBBINNO(2),DCELBBNR    BIN NO. TO DEB.                  68800016
         BAL   GR14,CONV2321           CONVERT SUB TO MAIN UCB ADDRESS. 69000016
         ST    GR6,DEBUCBAD-1          MAIN UCB ADDRESS TO DEB.         69200016
         B     BUILD1                  GO FINISH THE DEB.               69400016
         DROP  6                                                        69600016
         SPACE 3                                                        69800016
CONV2321 LH    GR10,0(GR6)             PICK UP BIN NO.                  70000016
         SLA   GR10,4                  TIMES SIXTEEN.                   70200016
         LA    GR10,DATACELL-UCBOB(GR10)  ADD LENGTH OF MAIN.           70400016
         LCR   GR10,GR10               NEGATE.                          70600016
         AR    GR6,GR10                ADDRESS OF MAIN.                 70800016
         BR    GR14                    RETURN.                          71000016
.X301004 ANOP                                                   XL03912 71050003
         EJECT                                                          71200016
         AIF   ('&LIB' EQ 'LIB1').WM005                                 71250000
.WM005   ANOP                                                           71350000
         DROP  R2                                                       71600016
XCTL     XCTL  EP=IGC0108B,SF=L        LIST FORM .                      71800016
XCTLEND  DS    0C                      END OF XCTL LIST.                72000016
XCTL1    XCTL  EP=IGC0208B,SF=L        LIST FORM.  2ND LOAD.            72200016
XCTL2    XCTL  EP=IGC0308B,SF=L         LIST FORM. 3RD LOAD.     S20201 72250020
XCTL3    XCTL  EP=IGC0408B,SF=L         LIST FORM. SS/1 LOAD.  @Y30LSFY 72250503
DEVTYP   DC    X'00'                    DEVICE TYPE SWITCH.      S20201 72300003
K16      EQU   16                       DISPLACEMENT CONSTANT    S20201 72350020
         SPACE 1                                                        72400016
WTORP    WTOR  'IEH841D        CONFIRM REQUEST TO           ',0,1, O122X72600019
               0,ROUTCDE=(4),DESC=(2),MF=L                         MC0I 72800018
WTOREND  DS    0C                      END OF WTOR.                     73000016
         SPACE                                                          73200016
WTO      WTO   'IEH808I REPLY IN ERROR. REPLY WITH U OR T',        MC0IX73300018
               ROUTCDE=(4),DESC=(5),MF=L                           MC0I 73400018
WTOEND   DS    0C                                                       73600016
DEBLEN   DS    0F                                                A34646 73650020
         DC    X'E5'                    SUB POOL NUMBER.        YL02912 73700002
         DC    AL3(DEBEND-MYDEB)        LENGTH OF DEB FOR        Y01021 73750000
*                                       VALIDATION               Y01021 73770000
MAINT    DS    10F                      MAINTENANCE AREA        XL02912 73772002
         AIF   ('&LIB' EQ 'LIB1').X227904                        YM3475 73777002
BLANKS   DC    X'40404040'              OFFLINE DDNAME END.      YM3475 73784002
.X227904 ANOP                                                    YM3475 73791002
SS1CONV  EQU   X'01'                   INDIC SS1 CONVERSION    @Y30LSFY 73793003
LABELL   DC    C'LABEL     '           USED FRO LABEL OFFLINE.     O122 73860003
INITIAL  DC    C'INITIALIZE'           USED FOR OFFLINE DASDI.     O122 73920019
ENQLISTF ENQ   (QHDR,,E,6,SYSTEM),TCB=,RET=USE,MF=L             YM03804 73970002
SYSQ     DC    C'SYSIEFSD'              ENQ/DEQ QNAME HEADER    YL02912 73972002
QHDR     DC    C'SYSZVOLS'             ONLINE ENQ HEADER        YM03804 73972402
Q4       DC    C'Q4'                    ENQ/DEQ RNAME HEADER    YL02912 73974002
NOGO     EQU   8                        ENQ FAILED RETURN CODE. YL02912 73980002
         SPACE                                                          74000016
SENSCCW  CCW   4,SENSCCW,X'20',6        SENSE CMD               XL03130 74002003
MAINTNC  DS    50D                      MAINTENANCE AREA        XL03130 74004003
GOODRT   EQU   X'7F'                    GOOD ECB RETURN CODE    XL03130 74010003
MASK     EQU   X'FF'                    'AND' MASK              XL03130 74012003
TCBKOFST EQU   28                       OFFSET TO TCB KEY       XL03130 74020003
MOD1     EQU   X'01'                    MODEL ONE SENSE VAL     XL03130 74022003
MOD2     EQU   X'02'                    MODEL TWO SENSE VAL     XL03130 74024003
L1       EQU   1                                                XL03130 74030003
L4       EQU   4                                                XL03130 74032003
L2       EQU   2                                                XL03130 74040003
DEBID    EQU   X'0F'                    DEB ID                  XL03130 74042003
L7       EQU   7                        OFFSET TO USERS' R.C.   XL03130 74044003
SENSEOP  EQU   X'04'                    SENSE OP CODE           XL03130 74048403
L88      EQU   88                       LENGTH OF EXCP CTL BLKS XL03130 74048803
BUMP     EQU   X'28'                    ADDR ADJUSTMENT         XL03130 74049203
CTLBLKS  DSECT                                                  XL03130 74050003
DCBORG   DS    7F                       DCB                     XL03130 74100003
DEBORG   DS    3F                       DEB                     XL03130 74150003
ECB1     DS    1F                       ECB                     XL03130 74160003
DCBDEB   DS    A                        DCB+2C                  XL03130 74170003
DEBPURG  DS    F                        DEB+14                  XL03130 74180003
DEBDCB   DS    A                        DEB+18                  XL03130 74190003
DEBAPP   DS    F                        DEB+1C                  XL03130 74192003
DEBUCB   DS    A                        DEB+20                  XL03130 74194003
DEBSKA   DS    2F                       DEB                     XL03130 74196003
IOB1     DS    F                        IOB                     XL03130 74198003
IOBECB   DS    A                        IOB+4                   XL03130 74198403
         DS    2F                       FILL                    XL03130 74198803
IOBCCW   DS    A                        IOB+10                  XL03130 74199203
IOBDCB   DS    A                        IOB+14                  XL03130 74199603
SENSE    DS    2F                       INPUT BUFFER            XL03130 74199703
IOBSKA   DS    2F                       IOB+20                  XL03130 74199803
CCW      DS    D                        SENSE CMD               XL03130 74199903
MSG      DSECT                                                          74200016
         DS    0D                                                       74400016
MSG1     DS    CL1                     REPLY LENGTH.                    74600016
MSG2     DS    CL3                     REPLY ADDRESS.                   74800016
MSG3     DS    CL4                     ECD ADDRESS.                     75000016
MSG4     DS    CL2                     MESSAGE LENGTH.                  75200016
         DS    CL2                                                      75400016
MSG5     DS    CL44                    MESSAGE BODY                MC0I 75600018
MSG55    DS    CL4                     MCS FLAGS/CODES.            MC0I 75700018
MSG6     EQU   MSG5+8                  CUU OR CUU/B                MC0I 75800018
WECB     DS    CL4                     ECB FOR WTOR.                    76000016
REPLY    DS    CL1                     REPLY AREA.                      76200016
WTORP1   DS    0C                                                       76400016
         EJECT                                                          76600016
IOBLOCKS DSECT                                                          76800016
MYDEB    EQU   *                       DEB DEFINITION.                  77000016
DEBEOEA  DS    1F                      END-OF-EXTENT.                   77200016
DEBSIOA  DS    1F                      START I/O.                       77400016
DEBPCIA  DS    1F                      PCI.                             77600016
DEBCEA   DS    1F                      CHANNEL END.                     77800016
DEBXCEA  DS    1F                      ABNORMAL END.                    78000016
         DS    CL12                                                     78200016
DEBLNGTH DS    CL1                     DEB LENGTH(DOUBLE WORDS)         78400016
         DS    CL3                                                      78600016
DEB      EQU   *                       DEB PROPER                       78800016
DEBNMSUB DS    CL1                     OPEN SUBROUTINES.                79000016
DEBTCBAD DS    CL3                     TCB ADDRESS.                     79200016
DEBAMLNG DS    CL1                     LENGTH ACCESS METHOD.            79400016
DEBDEBAD DS    CL3                     NEXT DEB ADDRESS.                79600016
DEBOFLGS DS    CL1                     DATA SET FLAGS.                  79800016
DEBIRBAD DS    CL3                     IRB ADDRESS.                     80000016
DEBOPATB DS    CL1                     TYPE OF I/O.                     80200016
DEBSYSPG DS    CL3                     IOB PURGE ADDRESS.(SYSTEM)       80400016
DEBNMEXT DS    CL1                     NO. OF EXTENTS.                  80600016
DEBUSRPG DS    CL3                     IOB USER PURGE ADDRESS.          80800016
DEBPRIOR DS    CL1                     ZERO                             81000016
DEBECBAD DS    CL3                     PURGE ECB.                       81200016
DEBDEBID DS    CL1                     PROTECT KEY//ID.                 81400016
DEBDCBAD DS    CL3                     DCB ADDRESS.                     81600016
DEBEXSCL DS    CL1                     EXTENT SCALE.                    81800016
DEBAPPAD DS    CL3                     APPENDAGE VECTOR TABLE.          82000016
DEBDVMOD DS    CL1                     FILE MASK.                       82200016
DEBUCBAD DS    CL3                     UCB ADDRESS.                     82400016
DEBBINNO DS    CL2                     BIN NO. FOR 2321.                82600016
DEBSTRCC DS    CL2                     CYLINDER START.                  82800016
DEBSTRHH DS    CL2                     HEAD START.                      83000016
DEBENDCC DS    CL2                     CYLINDER END.                    83200016
DEBENDHH DS    CL2                     HEAD END.                        83400016
DEBNMTRK DS    CL2                     NUMBER OF TRACKS.                83600016
         DS    CL20                                                     83800016
DEBEND   DS    0C                      END OF DEB.                      84000016
         EJECT                                                          84200016
ECB      DS    1F                      ECB HERE.                        84400016
IOB      EQU   *                       IOB HERE.                        84600016
IOBFLAG1 DS    CL1                     FLAG1                            84800016
IOBFLAG2 DS    CL1                     FLAG2.                           85000016
IOBSENS0 DS    CL1                     SENSE BYTE ZERO.                 85200016
IOBSENS1 DS    CL1                     SENSE BYTE ONE.                  85400016
IOBECBAD DS    CL4                     ADDRESS OF ECB.                  85600016
IOBCSW   DS    CL8                     STATUS WORDS.                    85800016
IOBSTART DS    CL4                     CHANNEL PROGRAM ADDRESS.         86000016
IOBDCBPT DS    CL4                     ADDRESS OF DCB.                  86200016
IOBRESTR DS    CL4                     RESTART ADDRESS.                 86400016
IOBINCAM DS    CL2                     BLOCK COUNT.                     86600016
IOBERRCT DS    CL2                     ERROR COUNT.                     86800016
IOBSEEK  DS    CL8                     SEEK ADDRESS.                    87000016
CCHHR    EQU   IOBSEEK+3               SEARCH ADDRESS.                  87200016
DCB      DS    1F                      DEB ADDRESS.                     87400016
ALTINFO  DS    1D                      KEEP ALTERNATE TRACK INFO HERE.  87600016
         AIF  ('&LIB' EQ 'LIB1').X302300                        XL03130 87650003
SCHHA    DS    1D                      SEARCH HOME ADDR.        XL03130 87700003
TICSRCH  DS    1D                      TIC ON SEARCH.           XL03130 87710003
.X302300 ANOP                                                   XL03130 87750003
WRTHA    DS    1D                      WRITE HOME ADDRESS.              87800016
WRTR0    DS    1D                      WRITE RECORD ZERO.               88000016
R0DATA   DS    1D                                              @Z30RSAG 88050003
RDHA     DS    1D                      READ HOME ADDRESS.               88200016
READR0   DS    1D                      READ RECORD ZERO.                88400016
         AIF   ('&LIB' EQ 'LIB1').X227800                       XL03130 88450003
         DS    CL6                      RESERVED.               XL03130 88500003
MADSD    DS    CL4                  3350 ADDITIONAL SD BYTES   @X50RSPC 88510003
WINHA    DS    CL2                      3340 HOME ADDRESS.      XL03130 88550003
.X227800 ANOP                                                   XL03130 88560003
HA       DS    CL5                     HOME ADDRESS.                    88600016
SW       DS    CL1                     SWITCH.                          88800016
D2314    EQU   X'80'                   2314 DEVICE.                     89000016
D2321    EQU   X'40'                   2321 DEVICE.                     89200016
SIZE     DS    CL2                     SIZE OF GETMAIN AREA.            89600016
R0COUNT  DS    1D                      RECORD ZERO COUNT FIELD.         89800016
         DS    1D                      RECORD ZERO DATA  FIELD.@X50RSPC 90000003
         AIF   ('&LIB' EQ 'LIB1').X322203                        XM4405 90050003
SNSBYTES DS    CL24                    3340 SENSE BYTE AREA.     XM4405 90100003
.X322203 ANOP                                                    XM4405 90150003
RETSW    DS    CL1                     RETRY SW USED IN 108B   @ZA04363 90160003
IOEND1   DS    0C                      END OF BASIC I/O BLOCKS.         90200016
*   EXTENSION FOR GETALT//DYNAMIC TRACK REQUEST.                        90400016
SEARCH   DS    1D                      SEARCH CCW.                      90600016
TIC      DS    1D                      REPEAT UNTIL FOUND.              90800016
WRTRD    DS    1D                      WRITE OR READ DATA.              91000016
FORMAT4  DS    CL96                    FORMAT4 DSCB READ IN AREA.       91200016
VTOCCCHH EQU   FORMAT4+63              CCHH START OF VTOC.              91600016
IOEND    DS    0C                                                       91800016
         EJECT                                                          91809002
*********************************************************************** 91818002
*                                                                     * 91827002
*   PARAMETER LIST DSECT                                              * 91836002
*                                                                     * 91845002
         IEHDBLKS                                              @Z30RSAG 91850003
*********************************************************************** 91854002
         SPACE 2                                                        91863002
PARMLIST DSECT                                                  YL02912 91872002
FUNCTION DS    0F                       CALLER'S FUNCTION.      YL02912 91881002
UCBPTR   DS    F                        UCB POINTER.            YL02912 91890002
DCBPTR   DS    F                        DCB POINTER OR          YL02912 91899002
CCHHPARM EQU   DCBPTR                   ADDR OF TRACK OR        YL02912 91908002
SERPTR   EQU   DCBPTR                   ADDR OF VOL SER.        YL02912 91917002
WINMOD   EQU   DCBPTR+3                 3340 MODEL NO.          YL02912 91919002
SENSFB   EQU   DCBPTR                   FUNCTION BLK ADDR      @Z30RSAG 91921003
ALTPTR   DS    F                        ADDR OF ALTINFO OR      YL02912 91926002
NEWCCHH  EQU   ALTPTR                   NEW TRACK ADDRESS.      YL02912 91935002
DEBPTR   DS    F                        DEB POINTER OR          YL02912 91944002
DEVMODP  EQU   DEBPTR                   ADDR OF 3340 MODEL NO.  YL02912 91953002
PRMPTR   DS    F                        ADDR OF CALLER'S LIST.  YL02912 91962002
KEY      EQU   PRMPTR                   KEY OF CALLER.          YL02912 91971002
EDQLIST  DS    4F                       ENQ/DEQ PARAM LIST      SJ0054  91971402
ENQLIST  EQU   EDQLIST+4                                        SJ0054  91971802
ENDLIST  EQU   *                        PARAMETER LIST END.     YL02912 91980002
         EJECT                                                          92000016
CVT      DSECT                                                          92200016
         CVT   SYS=MIN                                                  92400016
         IKJTCB LIST=YES                                                92450002
         EJECT                                                          92500002
         IHARB DSECT=YES                                                92550002
         EJECT                                                          92600016
UCB      DSECT                                                          92800016
         IEFUCBOB                                                       93000016
         END                                                            93200016
./  ADD  SSI=70880153,NAME=IGC0108B
         TITLE 'IGC0108B --- ASSIGNS ALTERNATE TRACKS'                  00100421
         COPY  LCGASMSW                                          SM4351 00100821
IGC0108B CSECT                                                          00102021
*C383953                                                      @VS40037  00103003
*                                                                       00112003
*A273500                                                      @VS40433  00113003
* FIX 3350 ALT TO ALT ASSIGNMENT.                             @ZM40450  00114003
*A383943,384821,822                                           @ZM43013  00118003
*C 84000,419000,423000              @SA74452=@YA09634=@XA09732=@ZA04363 00122003
*A 83500-83600,95500,505900         @SA74452=@YA09634=@XA09732=@ZA04363 00132003
*                                                                       00142003
*                                                             @Y30LSFY  00152003
*STATUS CHANGE LEVEL 004                                                00240021
*                                                                     * 00300016
*FUNCTION/OPERATION-  THIS LOAD OF SVC 82 PERFORMS ALTERNATE          * 00400016
*   TRACK ASSIGNMENT FOR EITHER OF TWO CASES.                         * 00500016
*                                                                     * 00600016
*     1) VOLUMES IN A STATE OF BEING INITIALIZED.                     * 00700016
*     2) PRE-INITIALIZED VOLUMES(THEY HAVE A FORMAT 4 DSCB).          * 00800016
*                                                                     * 00900016
*   IF THE SPECIFIED DEFECTIVE TRACK IS AN UNASSIGNED ALTERNATE, IT   * 01000016
*     IS FLAGGED TO PREVENT ITS EVER BEING ASSIGNED.                  * 01100016
*                                                                     * 01200016
*   IF THE SPECIFIED DEFECTIVE TRACK IS AN ASSIGNED ALTERNATE, THE    * 01300016
*     NEXT AVAILABLE ALTERNATE IS ASSIGNED TO THE ORIGINAL PRIMARY    * 01400016
*     TRACK.                                                          * 01500016
*                                                                     * 01600016
*   IF THE SPECIFIED DEFECTIVE TRACK IS A PRIMARY TRACK, THE NEXT     * 01700016
*     GOOD AVAILABLE ALTERNATE TRACK IS ASSIGNED TO IT.               * 01800016
*                                                                     * 01900016
*ENTRY POINT-  THE ONLY ENTRY POINT IS -IGC0108B-.                    * 02000016
*                                                                     * 02100016
*INPUT-  REGISTER 1 POINTS TO 3-FULL WORDS AS FOLLOWS.                * 02200016
*        WORD1-  INPUT PARM LIST POINTER PASSED TO IGC0008B.          * 02300016
*        WORD2-  WORKAREA ADDRESS- DESCRIBED BY -IOBLOCKS- DSECT.     * 02400016
*        WORD3-  POINTER TO SVRB EXTENDED SAVEAREA.                   * 02500016
*                                                                     * 02600016
*EXITS-NORMAL-  THE 2ND WORD OF THE INPUT PARM LIST CONTAINS THE      * 02700016
*   CCHH OF THE ASSIGNED ALTERNATE TRACK, IF ANY. THE 2ND WORD        * 02800016
*   CONTAINS ZEROS IF NO ALTERNATE NEED BE ASSIGNED.RC=0.             * 02900016
*   -THE 6-BYTES OF ALTERNATE TRACK INFORMATION IS UPDATED(EITHER IN  * 03000016
*   THE FORMAT 4 DSCB OR POINTED TO BY THE INPUT PARM LIST.           * 03100016
*                                                                     * 03200016
*EXITS-ERROR-  RETURN CODE=12//IO ERROR ENCOUNTERED.                  * 03300016
*              RETURN CODE=16//NO MORE ALTERNATES AVAILABLE.          * 03400016
*   RETURN TO CALLER VIA SVC 3.                                       * 03500016
*                                                                     * 03600016
*SUPERVISOR MACROS-  EXCP,WAIT,FREEMAIN.                              * 03700016
*                                                                     * 03800016
*TABLES/WORKAREA-  USES THE WORKAREA DESCRIBED BY DSECT -IOBLOCKS-.   * 03900016
*                                                                     * 04000016
*OUTPUT-  SEE EXIT DESCRIPTION.                                       * 04100016
*                                                                     * 04200016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,PRIVILEGED,ENABLED.               * 04300016
*                                                                     * 04400016
*********************************************************************** 04450002
         EJECT                                                          04500002
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             04600016
R0       EQU   0                                                        04700016
R1       EQU   1                                                        04800016
R2       EQU   2                                                        04900016
R3       EQU   3                                                        05000016
R4       EQU   4                                                        05100016
R5       EQU   5                                                        05200016
R6       EQU   6                                                        05300016
R7       EQU   7                                                        05400016
R8       EQU   8                                                        05500016
R9       EQU   9                                                        05600016
R10      EQU   10                                                       05700016
R11      EQU   11                                                       05800016
R14      EQU   14                      LINK REGISTER.                   05900016
R15      EQU   15                                                       06000016
PARMPTR  EQU   1                       POINTS TO INPUT PARAMETERS.      06100016
BASEREG  EQU   12                      BASE REGISTER.                   06200016
         SPACE 3                                                        06300016
*   EQUATE DEFINITIONS.                                                 06400016
RBEXSAVE EQU   96                      EXTENDED SAVE AREA FOR SVRB.     06500016
LAST     EQU   X'80'                   LAST PARAMETER INDICATOR.        06600016
GOOD     EQU   X'7F'                   I/O GOOD COMPLETION BIT.         06700016
COMPLETE EQU   X'40'                   I/O COMPLETE BIT.                06800016
SKIP     EQU   X'10'                   SKIP DATA TRANSFER.              06900016
CHAIN    EQU   X'40'                   COMMAND CHAIN CCWS.              07050003
CHAINSD  EQU   X'50'                   COMMAND CHAIN +SKIP CCWS  XM4405 07100003
SILI     EQU   X'20'                   SUPPRESS INCORRECT LENGTH.       07200016
ALT      EQU   X'01'                   ALTERNATE TRACK FLAG.            07300016
DEFECT   EQU   X'02'                   DEFECTIVE TRACK FLAG.            07400016
MOVEHA   EQU   X'40'                   MOVE HA DOWN THE TRACK.          07500016
UE       EQU   X'01'                   UNIT EXCEPTION.                  07600016
MAINUCB  EQU   X'FF'                   ID FOR PRIMARY UCB.              07700016
DA2321   EQU   X'05'                   UCB TYPE CODE FOR 2321.          07800016
DA2314   EQU   X'08'                   2314 UCB TYPE CODE.              07900016
ANALYZE  EQU   X'00'                   ANALYZE FUNCTION CODE.   YL02912 07902002
D0       EQU   0                        ZERO DISPLACEMENT               07910003
D4       EQU   4                        DISPLACEMENT OF 4.      YL02912 07912002
K36      EQU   36                       CONSTANT OF 36.         YL02912 07914002
         AIF   ('&LIB' EQ 'LIB1').X226605                       XL03130 07920003
SS1CONV  EQU   X'01'                    CODE FOR SS1 CONV      @Y30LSFY 07930003
ICEBERG  EQU   X'0D'                    UCB DEVICE TYPE 3330-1 @Y30LSFY 07932003
WIN      EQU   X'0A'                    UCB DEVICE TYPE 3340.   XL03130 07940003
D3350    EQU   X'0B'                   UCB DEVICE TYPE 3350    @Z30RSAG 07950003
L16      EQU   16                      R0 CCW LENGTH           @Z30RSAG 07952003
.X226605 ANOP                                                   XL03130 07960003
         EJECT                                                          08000016
         LR    BASEREG,R15             ESTABLISH ADDRESSING.            08100016
         USING IGC0108B,BASEREG                                         08200016
         USING PARMLIST,R11                                     YL02912 08250002
         SPACE                                                          08300016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04363 08350003
         DC    C'IGC0108B OZ04363'     LAST FIX THIS MOD       @ZA04363 08360003
APARNO   L     R11,0(R1)               PARM LIST POINTER.      @ZA04363 08400003
         L     R2,4(R1)                WORKAREA ADDRESS.                08500016
         L     R5,8(R1)                SVRB EXTENDED AREA.              08600016
         SPACE 2                                                        08700016
*********************************************************************** 08800016
*                                                                     * 08900016
*   INITIALIZE THE IOB.                                               * 09000016
*                                                                     * 09100016
*********************************************************************** 09200016
         SPACE 2                                                        09300016
         USING IOBLOCKS,R2                                              09400016
INITIOB  MVI   IOBFLAG1,X'42'          SET PROPER FLAGS.                09500016
         MVI   RETSW,X'00'             CLEAR RETRY SW          @ZA04363 09550003
         LA    R3,ECB                  ECB ADDRESS.                     09600016
         ST    R3,IOBECBAD             STORE IN IOB.                    09700016
         MVI   IOBINCAM+1,1            BLOCK COUNT.                     09800016
         LA    R3,DCB-44               DCB ADDRESS.                     09900016
         ST    R3,IOBDCBPT             STORE IN IOB.                    10000016
         L     R4,UCBPTR               UCB ADDRESS.             YL02912 10100002
         USING UCB,R4                                                   10200016
         CLI   UCBID,MAINUCB           THIS A PRIMARY UCB.              10300016
         BE    TESTF                   GO TEST THE FUNCTION.            10400016
         OI    SW,D2321                SET 2321 SWITCH.                 10500016
         MVC   IOBSEEK+1(2),0(R4)      BIN NO. TO IOB.                  10600016
         DROP  4                                                        10700016
         SPACE 2                                                        10800016
TESTF    EQU   *                                                        10900002
         CLI   FUNCTION,X'00'           ANALYZE/FORMAT REQUEST? YL02912 10950002
         BE    ASSG2                   YES--GO HANDLE.                  11000016
         CLI   FUNCTION,SS1CONV        THIS A SS1 CONV REQUEST @Y30LSFY 11050003
         BE    ASSG2                   YES--GO HANDLE.         @Y30LSFY 11060003
         EJECT                                                          11100016
*   BUILD CCWS FOR READING FORMAT 4 DSCB HERE.                          11200016
         USING IOBLOCKS,R2                                              11300016
FORM4    EQU   *                                                        11400016
         LA    R3,FORMAT4              FORMAT 4 READ-IN AREA.           11500016
         ST    R3,WRTRD                STORE IN READ-DATA CCW.          11600016
         MVI   WRTRD,X'06'             SET OP CODE.                     11700016
         MVI   WRTRD+7,96              SET COUNT.                       11800016
         LA    R3,SEARCH               SEARCH CCW ADDRESS.              11900016
         ST    R3,TIC                  STORE IN TIC.                    12000016
         MVI   TIC,8                   SET TIC OP CODE.                 12100016
         LA    R3,CCHHR                SEARCH ADDRESS.                  12200016
         ST    R3,SEARCH               STORE IN SEARCH CCW.             12300016
         MVI   SEARCH+4,X'40'          COMMAND CHAIN ON.                12400016
         MVI   SEARCH+7,5              SET COUNT.                       12500016
         MVI   SEARCH,X'31'            SET SEARCH OP CODE.              12600016
         SPACE 2                                                        12700016
         LA    R3,SEARCH               SEARCH CCW ADDRESS.              12800016
         ST    R3,IOBSTART             SET IN IOB.                      12900016
         SPACE                                                          13000016
*   STORE CCHHR OF VTOC IN IOB HERE.                                    13100016
         L     R3,UCBPTR                UCB ADDRESS.            YL02912 13200002
         USING UCB,R3                                                   13300016
         AIF   ('&LIB' EQ 'LIB2').X229300                       XL03912 13350003
         CLI   UCBID,MAINUCB           THIS A 2321.                     13400016
         BNE   P2321                   YES-GO PROCESS.                  13500016
.X229300 ANOP                                                   XL03912 13550003
         L     R0,SRTEFSCT             TTR OF VTOC.                     13600016
         SPACE                                                          13700016
FINDCCHH LA    R3,RBEXSAVE(R5)         EXTENTED SVRB SAVE AREA.         13800016
         L     R10,K36(R3)             GET RETURN ADDRESS.      YL02912 13850002
         MODESET EXTKEY=SUPR                                     YM1315 13860002
         STM   1,12,0(R3)              SAVE THE REGISTERS.              13900016
         MODESET EXTKEY=DATAMGT                                  YM1315 13950002
         SPACE                                                          14000016
         USING CVT,R15                                                  14100016
         L     R15,CVTPTR              CVT ADDRESS.                     14200016
         L     R15,CVTPCNVT            CONVERT ROUTINE ADDRESS.         14300016
         DROP  15                                                       14400016
         LA    R1,DEB                  ADDDRESS OF DEB.                 14500016
         LA    R2,IOBSEEK              TARGET AREA FOR MBBCCHHR.        14600016
         BALR  R14,R15                 CONVERT TTR TO MBBCCHHR.         14700016
         LM    1,12,0(R3)              RESTORE THE REGISTERS.           14800016
         SPACE                                                          14900016
*   READ IN THE FORMAT 4 DSCB HERE.                                   * 15000016
         BAL   R9,WRTREAD              READ IN FORMAT4 DSCB DATA FIELD. 15100016
         BAL   R9,WAIT                 AWAIT COMPLETION.                15200016
         MVC   ALTINFO(6),ALTDATA      CCHH NEXT ALT. AND COUNT LEFT.   15300016
         SPACE                                                          15400016
ASSG1    CLC   ALTINFO+4(2),ZERO       ANY ALTERNATES LEFT.             15500016
         BNE   TESTALT                 YES-                             15600016
         SPACE                                                          15700016
EXIT16   BAL   R9,FREECORE             FREE THE WORK AREA.              15800016
         LA    R15,16                  SET RETURN CODE.                 15900016
         B     RETURN                  RETURN TO CALLER.        YL02912 16000002
         SPACE                                                          16100016
         AIF   ('&LIB' EQ 'LIB2').X229301                       XL03912 16150003
         USING DATACELL,R3                                              16200016
P2321    L     R0,DCELVTOC             TTR OF VTOC---2321.              16300016
         B     FINDCCHH                CONVERT TO CCHH.                 16400016
         DROP  R3                                                       16500016
         SPACE 2                                                        16600016
.X229301 ANOP                                                   XL03912 16650003
ASSG2    EQU   *                       SET UP ALTERNATE INFORMATION.    16700016
         L     R4,ALTPTR                PTR TO ALT INFO.        YL02912 16800002
         BAL   R14,CALLKEY              EXEC NEXT INSTR IN      YL02912 16820002
*                                        KEY OF CALLER.         YL02912 16840002
         LM    R6,R7,D0(R4)             GET ALTERNATE INFO.     YL02912 16860002
         STM   R6,R7,ALTINFO            SAVE ALTERNATE INFO.    YL02912 16900002
         B     ASSG1                   GO PROCESS THIS TRACK.           17000016
         SPACE                                                          17100016
TESTALT  EQU   *                                                YL02912 17200002
         L     R3,CCHHPARM              SELECTED TRACK ADDRESS. YL02912 17250002
         SPACE                                                          17300016
         USING UCB,R4                                                   17400016
         L     R4,UCBPTR                UCB ADDRESS.            YL02912 17500002
         SPACE                                                          17600016
         AIF   ('&LIB' EQ 'LIB2').X229303                       XL03912 17650003
         CLI   UCBID,MAINUCB           THIS A PRIMARY UCB.              17700016
         BE    TEST1                   YES-GET DEVICE TYPE CODE.        17800016
         LA    R6,DA2321               NO--MUST BE 2321.                17900016
         B     TEST2                   GO INDEX TO DEVICE CONSTANTS.    18000016
         SPACE                                                          18100016
.X229303 ANOP                                                   XL03912 18150003
TEST1    SR    R6,R6                   CLEAR                            18200016
         IC    R6,UCBTBYT4             DEVICE TYPE CODE.                18300016
         AIF   ('&LIB' EQ 'LIB1').X226602                       XL03130 18350003
         CLI   UCBTBYT4,WIN             IS THIS 3340?           XL03130 18360003
         BNE   TEST3                    NO, GO TEST MORE        XL03130 18370003
         L     R7,DEVMODP               ADDRESS OF DEV MOD NO.  YL02912 18372002
         BAL   R14,CALLKEY              EXECUTE NEXT INST       YL02912 18374002
*                                        IN THE KEY OF CALLER.  YL02912 18376002
         IC    R6,0(R7)                 YES, GET 3340 MOD NO.   XL03130 18380003
TEST3    EQU   *                                                XL03130 18392003
         LR    R7,R4                    SAVE UCB ADDRESS.       XM3801  18392403
.X226602 ANOP                                                   XL03130 18394003
         CLI   UCBTBYT4,DA2314         THIS A 2314.                     18400016
         BNE   TEST2                   NO--                             18500016
         OI    SW,D2314                YES-REMEMBER THIS.               18600016
         DROP  R4                                                       18700016
         SPACE                                                          18800016
TEST2    LA    R4,FIRSTALT-8           TABLE-8.                         18900016
         SLA   R6,3                    UCB CODE TIME 8.                 19000016
         LA    R6,0(R6,R4)             ADDRESS OF CONSTANTS/THIS DEVICE 19100016
         SPACE                                                          19200016
         USING UCB,R7                                          @Y30LSFY 19210003
         CLI   FUNCTION,SS1CONV         SS1 CONVERSION ?       @Y30LSFY 19250003
         BNE   NOTSSC                   NO, BRCH               @Y30LSFY 19260003
         LA    R6,SS1CONM              YES, LOAD SS1 ALT INFO. @Y30LSFY 19270003
         CLI   UCBTBYT4,ICEBERG         3330-1 DEVICE          @Y30LSFY 19272003
         BNE   NOTSSC                   NO - USE 3330 CONSTANT @Y30LSFY 19274003
         LA    R6,SS1CONI               SET ICEBERG ALT INFO   @Y30LSFY 19276003
         DROP  R7                                              @Y30LSFY 19278003
NOTSSC   EQU   *                                               @Y30LSFY 19280003
         CL    R3,0(R6)                INPUT CCHH IN ALTERNATE AREA.    19300016
         BNH   NOTALT                  NO--MUST BE PRIMARY TRACK.       19400016
         SPACE 2                                                        19500016
YESALT   EQU   *                       INPUT TRACK IS IN ALTERNATE AREA 19600016
         ST    R3,R0COUNT              INPUT CCHH//TEMPORARY STORAGE.   19700016
         MVC   CCHHR(4),R0COUNT        SEEK ADDRESS IN IOB.             19800016
         LA    R4,RDHA                 READ HA CCW.                     19900016
         ST    R4,IOBSTART             STORE ADDRESS IN IOB.            20000016
         LA    R4,HA                   READ-IN HA AREA.                 20100016
         ST    R4,RDHA                 STORE IN CCW.                    20200016
         MVI   RDHA,X'1A'              RESET OP CODE.                   20300016
         MVI   RDHA+7,5                SET CORRECT COUNT.               20400016
         AIF   ('&LIB' EQ 'LIB1').X322201                        XM4405 20550003
         BAL   R9,SAVESD               SEE IF SD BYTES.          XM4405 20560003
.X322201 ANOP                                                    XM4405 20570003
         MVI   RDHA+4,CHAIN            CHAIN BIT ON.           @ZM40450 20571003
         LA    R4,R0COUNT              COUNT READ-IN AREA.              20600016
         ST    R4,READR0               STORE IN CCW.                    20700016
         MVI   READR0,X'16'            RESET OP CODE.                   20800016
         MVI   READR0+7,4              SET COUNT IN CCW.                20900016
         MVI   READR0+4,SILI           SUPPRESS INCORRECT LENGTH.       21000016
         BAL   R9,WRTREAD              READ IN HA/R0 RECORDS.           21100016
         BAL   R9,WAIT                 AWAIT COMPLETIOM.                21200016
         CLC   HA+1(4),R0COUNT         HA AND R0 SAME CCHH.             21300016
         L     R3,R0COUNT              PRIMARY TRACK ADDRESS.           21400016
         BE    A                       TRACK NOT ASSIGNED.         1057 21470018
         OI    SW,DEFALT               SET DEFECTIVE ALTERNATE SW  1057 21540018
A        EQU   *                                                   1057 21610018
         BAL   R9,DOSA                 CHK TRK VIA S.A.        @ZM40450 21611003
         MVC   WRTHA(16),RDHA          REPOSITION THE CCWS.             21700016
         MVI   WRTHA,X'19'             SET WRITE HA OP CODE.            21800016
         MVI   WRTR0,X'15'             SET WRITE R0 OP CODE.            21900016
         MVI   WRTR0+4,CHAIN           SET CHAIN FLAG ON.               22000016
         MVI   WRTR0+7,16              SET COUNT IN CCW.                22100016
         MVI   R0COUNT+7,8             SET COUNT IN COUNT FIELD.        22200016
*                                                                       22250003
         LA    R4,RDHA                  MODIFY THE UNUSED CCW  @Z30RSAG 22260003
         ST    R4,R0DATA                TO A                   @Z30RSAG 22270003
         MVI   R0DATA,TICCMD            TIC CCW.               @Z30RSAG 22280003
*                                                                       22290003
         MVI   RDHA+4,CHAIN+SKIP       SKIP DATA TRANSFER.              22300016
         MVI   READR0+4,SKIP+SILI      SKIP DATA TRANSFER.              22400016
         OI    HA,DEFECT+ALT           INDICATE DEFECTIVE ALT. IN FLAG. 22500016
         SPACE                                                          22600016
         LA    R4,WRTHA                CHANNEL PROGRAM START.           22700016
         ST    R4,IOBSTART             SET CCW ST ART IN IOB.           22800016
         AIF   ('&LIB' EQ 'LIB1').X228301                       XL03130 22820003
         BAL   R9,WRTWIN                TEST IF 3340.           XL03130 22840003
.X228301 ANOP                                                   XL03130 22860003
         SPACE                                                          22900016
         BAL   R9,WRTREAD              FLAG THIS TRACK DEFECTIVE.       23000016
         BAL   R9,WAIT                 AWAIT I/O COMPLETION.            23100016
         MVI   RDHA+4,CHAIN            COMMAND CHAIN FLAGS TO CCW  1057 23120018
         MVI   READR0+4,SILI           SUPPRESS LENGTH IND. TO CCW 1057 23140018
         TM    SW,DEFALT               DEFECTIVE ALTERNATE SW SET  1057 23160018
         BO    NOTALT                  YES-GO SEE IF GOOD ALTERNATE1057 23180018
         SPACE                                                          23200016
         L     R10,PRMPTR               GET CALLER'S PARM PTR.  YL02912 23300002
         SR    R8,R8                    SET ZERO                YL02912 23340002
         BAL   R14,CALLKEY              EXECUTE NEXT INST       YL02912 23380002
*                                        IN THE KEY OF CALLER.  YL02912 23420002
         ST    R8,D4(R10)               IND NO ALT. ASSIGNED.   YL02912 23460002
         B     EXIT0                   RETURN TO CALLER.                23500016
         EJECT                                                          23505002
*********************************************************************** 23510002
*                                                                     * 23515002
*   THIS ROUTINE WILL OBTAIN THE KEY OF THE CALLER, EXECUTE THE       * 23520002
*   INSTRUCTION AFTER THE BRANCH AND LINK INSTRUCTION TO THIS         * 23525002
*   ROUTINE, RETURN TO DATA MANAGEMENT KEY AND FINALLY RETURN TO      * 23530002
*   ONE INSTRUCTION PAST THE ONE EXECUTED BY THIS ROUTINE.            * 23535002
*                                                                     * 23540002
*********************************************************************** 23545002
         SPACE 3                                                        23550002
CALLKEY  EQU   *                                                YL02912 23555002
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.       YL02912 23560002
         SPACE                                                          23565002
         EX    0,D0(R14)                DO INST PAST BAL.       YL02912 23570002
         SPACE                                                          23575002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY.    YL02912 23580002
         LA    R14,D4(R14)             SET BR REG TO INST+1.    YL02912 23582002
         BR    R14                      GO TO OBJECT INST+1.    YL02912 23585002
         EJECT                                                          23600016
*********************************************************************** 23700016
*                                                                     * 23800016
*   TEST IF THIS ALTERNATE TRACK IS A GOOD ONE.                         23900016
*                                                                     * 24000016
*********************************************************************** 24100016
         SPACE 2                                                        24200016
NOTALT   MVC   CCHHR(4),ALTINFO        CCHH OF NEXT ALT TO IOB.         24300016
         LA    R4,RDHA                 CCW ADDRESS.                     24400016
         ST    R4,IOBSTART             STORE IN IOB.                    24500016
         LA    R4,HA                   READ IN AREA.                    24600016
         ST    R4,RDHA                 STORE IN CCW.                    24700016
         MVI   RDHA,X'1A'              RESET OP CODE.                   24800016
         MVI   RDHA+7,5                SET COUNT IN CCW.                24900016
         SPACE                                                          25000016
         BAL   R9,WRTREAD              READ IN HOME-ADDRESS/ALTERNATE.  25100016
         BAL   R9,WAIT                 AWAIT COMPLETION.                25200016
         SPACE                                                          25300016
         TM    HA,DEFECT               THIS A GOOD ALTERNATE.           25400016
         BZ    WRTPRIM                 YES-GO USE IT.                   25500016
         SPACE 2                                                        25600016
*********************************************************************** 25700016
*                                                                     * 25800016
*   THE NEXT AVAILABLE TRACK WAS DEFECTIVE. MUST FIND ANOTHER ONE.    * 25900016
*                                                                     * 26000016
*********************************************************************** 26100016
         SPACE 2                                                        26200016
GETNEXT  EQU   *                       FIND NEXT ALTERNATE TRACK.       26300016
         BAL   R9,UPCCHH               GET ADDRESS OF NEXT ALTERNATE.   26400016
         LTR   R4,R4                   BETTER TEST FOR ZERO HERE.       26500016
         BZ    EXIT16                  NONE LEFT---BETTER LEAVE.        26600016
         B     NOTALT                  GO SEE IF NEXT ALTERNATE IS GOOD 26700016
         EJECT                                                          26800016
*********************************************************************** 26900016
*                                                                     * 27000016
*   WRITE HOME ADDRESS/RECORD ZERO ON THE PRIMARY TRACK HERE.         * 27100016
*                                                                     * 27200016
*********************************************************************** 27300016
WRTPRIM  ST    R3,R0COUNT              TEMPORARY STORAGE.               27400016
         MVC   CCHHR(4),R0COUNT        PRIMARY CCHH TO IOB.             27500016
         AIF   ('&LIB' EQ 'LIB1').X322200                        XM4405 27550003
         BAL   R9,SAVESD               SEE IF SD BYTES.          XM4405 27560003
.X322200 ANOP                                                    XM4405 27570003
         MVC   HA+1(4),R0COUNT         SET IN CCHH OF HA.               27600016
         BAL   R9,DOSA                 GO DO SURFACE ANALYSIS  @Z30RSAG 27661003
         MVI   HA,DEFECT               SET FLAG IN HA.                  27700016
         MVC   R0COUNT(4),ALTINFO      CCHH OF ALT TO PRIMARY R0.       27800016
         SPACE                                                          27900016
         LA    R4,HA                   WRITE-OUT AREA.                  28000016
         ST    R4,WRTHA                STORE IN CCW.                    28100016
         MVI   WRTHA,X'19'             SET OP CODE.                     28200016
         MVI   WRTHA+4,CHAIN           CHAIN BIT ON.                    28300016
         MVI   WRTHA+7,5               SET COUNT IN CCW.                28400016
         SPACE                                                          28500016
         LA    R4,R0COUNT              COUNT FIELD ADDRESS.             28600016
         ST    R4,WRTR0                STORE IN CCW.                    28700016
         MVI   WRTR0,X'15'             RESET OP CODE.                   28800016
         MVI   WRTR0+4,CHAIN           CHAIN BIT ON.                    28900016
         MVI   WRTR0+7,16               SET COUNT TO 16          M0492  28960021
         MVI   READR0+7,16                IN CCW'S               M0492  29020021
         SPACE                                                          29022003
         LA    R4,RDHA                 PREPARE TO SETUP TIC    @Z30RSAG 29024003
         ST    R4,R0DATA               CHG CCW DATA ADDR       @VS40034 29026003
         MVI   R0DATA,TICCMD           RESET OPCODE            @Z30RSAG 29028003
         SPACE                                                          29100016
         MVC   RDHA(16),WRTHA          MOVE WRITE CCWS OVER READS.      29200016
         MVI   RDHA,X'1A'              SET READ HA OP CODE.             29300016
         OI    RDHA+4,SKIP             SKIP DATA TRANSFER.              29400016
         MVI   READR0,X'16'            SET READ R0 OP CODE.             29500016
         MVI   READR0+4,SKIP+SILI      SKIP DATA TRANSFER.              29600016
         SPACE                                                          29700016
         LA    R4,WRTHA                CHANNEL PROGRAM START.           29800016
         ST    R4,IOBSTART             STORE IN IOB.                    29900016
         MVC   R0COUNT+K4(K4),ROLENGTH  SET R0 COUNT             S21041 29950021
         AIF   ('&LIB' EQ 'LIB1').X226606                       XL03130 29960003
         BAL   R9,WRTWIN               TEST IF 3340/3350       @Z30RSAG 29970003
.X226606 ANOP                                                   XL03130 29980003
         SPACE 2                                                        30000016
         BAL   R9,WRTREAD              WRITE HA/R0 ON PRIMARY.          30100016
         BAL   R9,WAIT                 AWAIT COMPLETION.                30200016
         SPACE                                                          30300016
         L     R10,PRMPTR               GET CALLER'S PARM PTR   YL02912 30400002
         L     R8,ALTINFO               GET CCHH OF ALTERNATE   YL02912 30420002
         BAL   R14,CALLKEY              EXECUTE NEXT INST.      YL02912 30440002
*                                        IN THE KEY OF CALLER.  YL02912 30460002
         ST    R8,D4(R10)               SET CCHH IN PARM LIST.  YL02912 30480002
         MVI   HA,ALT                  SET FLAG TO SHOW ALTERNATE.      30500016
         EJECT                                                          30600016
*********************************************************************** 30700016
*                                                                     * 30800016
*   WRITE RECORD ZERO ON THE ALTERNATE TRACK HERE.                    * 30900003
*                                                                     * 31000016
*********************************************************************** 31100016
         SPACE 3                                                        31200016
WRTALT   MVC   CCHHR(4),ALTINFO        SEEK ADDRESS OF ALT. TO IOB.     31300016
         MVC   HA+1(4),ALTINFO         CCHH OF ALTERNATE.               31400016
         SPACE                                                          31500016
         ST    R3,R0COUNT              PRIMARY CCHH TO RECORD ZERO.     31600016
         MVI   R0COUNT+7,8             SET DATA LENGTH FOR EIGHT.       31700016
         MVI   WRTR0+7,16              SET CCW COUNT FOR 16.            31800016
         AIF   ('&LIB' EQ 'LIB1').X227910                       XL03130 31810003
         SPACE                                                          31820003
         LA    R4,HA+1                  GET SEARCH ADDR.        XL03130 31852003
         ST    R4,SCHHA                 SEARCH ADDR TO CCW.     XL03130 31854003
         MVI   SCHHA,SRCH               SET SEARCH HA.          XL03130 31860003
         MVI   SCHHA+4,CHAIN            CHAIN BIT ON.           XL03130 31862003
         MVI   SCHHA+7,C4               SET COUNT TO 4.         XL03130 31870003
         LA    R4,SCHHA                 SEARCH CCW ADDRESS.     XL03130 31880003
         ST    R4,IOBSTART              CCW ADDRESS TO IOB.     XL03130 31882003
         ST    R4,TICSRCH               SET TIC ADDRESS.        XL03130 31884003
         MVI   TICSRCH,TICCMD           SET TIC COMMAND.        XL03130 31886003
         L     R4,D0(R11)               GET UCB                 XL03130 31886103
         USING UCB,R4                                           XL03130 31886203
         CLI   UCBTBYT4,ICEBERG         IS THIS A 3330-1       @Z30RSAG 31886303
         BE    SKIPWIN                  NO, NEED TO FLAG ALT.   XL03130 31887803
         CLI   UCBTBYT4,WIN             IS THIS A 3340/3350?    XL03130 31889503
         BL    SKIPWIN                  NO, NEED TO FLAG ALT.   XL03130 31891003
         LA    R4,WRTR0                 GET WRITE R0 CCW ADDR.  XL03130 31892503
         ST    R4,WRTHA                 SET TIC ADDRESS.        XL03130 31894003
         MVI   WRTHA,TICCMD             CHANGE WRITE TO TIC.    XL03130 31895503
SKIPWIN  EQU   *                                                XL03130 31897003
.X227910 ANOP                                                   XL03130 31898503
         BAL   R9,WRTREAD              WRITE HA/R0 ON ALTERNATE.        32000016
         BAL   R9,WAIT                 AWAIT COMPLETION.                32100016
TESTREQ  EQU   *                                               @Y30LSFY 32150003
         CLI   FUNCTION,SS1CONV        SSI CONVERSION ?        @Y30LSFY 32160003
         BE    NOUPF4                   YES, BRCH              @Y30LSFY 32170003
         CLI   FUNCTION,ANALYZE         ANALYZE/FORMAT REQUEST? YL02912 32250002
         BNE   UPF4                    NO--NEED TO UPDATE FORMAT4 DSCB. 32300016
         SPACE                                                          32400002
NOUPF4   EQU   *                                               @Y30LSFY 32450003
         BAL   R9,UPCCHH               INCREMENT TO NEXT TRACK.         32500016
         L     R4,ALTPTR                GET ADDR OF ALT INFO.   YL02912 32600002
         MODESET EXTKEY=SUPR           ALLOW FETCH OF ALT INFO   YM4604 32650002
         MVC   0(6,R4),ALTINFO         UPDATE ALTERNATE TRACK INFO.     32700016
         MODESET EXTKEY=DATAMGT                                 YL02912 32750002
         SPACE                                                          32800002
EXIT0    BAL   R9,FREECORE             FREE THE WORKAREA.       YL02912 32900002
         SR    R15,R15                 SET RETURN CODE ZERO.    YL02912 33000002
RETURN   L     R14,RBEXSAVE+K36(R5)    GET  RETURN ADDRESS.     YL02912 33100002
         MODESET EXTKEY=SUPR                                    YM1315  33110102
         BR    R14                     RETURN TO CALLER.        YL02912 33150102
         EJECT                                                          33152102
         AIF   ('&LIB' EQ 'LIB1').X226607                       XL03130 33154102
*********************************************************************** 33160003
*                                                                     * 33170003
*   THIS ROUTINE WILL READ THE SKIP DISPLACEMENT BYTES OF A           * 33180003
*   DEFECTIVE TRACK ON 3340/3350 DEVICES.                      @Z30RSAG 33182003
*                                                                     * 33190003
*********************************************************************** 33192003
         SPACE 2                                                        33194003
SAVESD   EQU   *                                                 XM4405 33196003
         USING UCB,R7                                            XM4405 33198003
         CLI   UCBTBYT4,D3350          IS THIS A 3350 ?        @Z30RSAG 33198103
         BE    MADRID                  YES                     @Z30RSAG 33198203
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM4405 33198403
         BCR   NE,R9                   NO, RETURN.               XM4405 33198803
         SPACE                                                          33199203
MADRID   EQU   *                                               @Z30RSAG 33199303
         LA    R4,SNSBYTES             GET ADDR FOR SNS INFO.    XM4405 33205603
         ST    R4,READR0               SET IN CCW.               XM4405 33206703
         MVI   READR0,SENSE            SET CCW TO SENSE CMD.     XM4405 33207803
         MVI   READR0+C7,L24           SET FOR 24 SENSE BYTES.   XM4405 33208903
         SPACE                                                          33210003
         MVI   RDHA+K4,CHAINSD         CHAIN READ HA TO SENSE.   XM4405 33211103
         SPACE                                                          33212203
         EXCP  IOB                     GET SKIP DISPLACEMENT.    XM4405 33213303
         TM    ECB,COMPLETE            OPERATION COMPLETE?       XM4405 33214403
         BO    CKRTN                   YES, CHECK CONDITION.     XM4405 33215503
         WAIT  ECB=ECB                 NO, PAUSE.                XM4405 33216603
         SPACE                                                          33217703
CKRTN    EQU   *                                                 XM4405 33218803
         CLI   ECB,GOOD                GOOD COMPLETION?          XM4405 33219903
         BCR   EQ,R9                   YES, GOT BYTES, RETURN.   XM4405 33221003
         XC    SDBYTES(L2),SDBYTES     NO, INSURE ZERO SD.       XM4405 33222103
         BR    R9                      NOW RETURN.               XM4405 33223203
         EJECT                                                          33224303
*********************************************************************** 33233803
*                                                                     * 33234003
*   WRITE HOME ADDRESS/RECORD ZERO ON A DEFECTIVE TRACK FOR A 3340.   * 33234203
*        OR FOR A 3350.                                        @X50RSAG 33235403
*                                                                     * 33237403
*********************************************************************** 33239403
         SPACE 2                                                        33239803
WRTWIN   EQU   *                                                XL03130 33240603
         USING UCB,R7                                           XL03130 33243003
         CLI   UCBTBYT4,D3350          IS IT 3350 ?            @X50RSAG 33245403
         BE    MAD                     YES                     @X50RSAG 33247803
         CLI   UCBTBYT4,WIN             IS THIS A 3340?         XL03130 33250203
         BCR   NE,R9                    NO, RETURN.             XL03130 33252603
         MVC   WINHA,SDBYTES            SET SKIP DISPLACEMENT.   XM4405 33255003
         LA    R4,WINHA                 WRITE HA OUT AREA.      XL03130 33257403
         ST    R4,WRTHA                 STORE IN CCW.           XL03130 33259803
         MVI   WRTHA+7,C7               SET COUNT IN CCW.       XL03130 33262203
         MVI   WRTHA,WRITE              RESTORE WRITE COMMAND.  XL03130 33264603
         BR    R9                       RETURN.                 XL03130 33267003
MAD      EQU   *                                               @X50RSAG 33269403
         LA    R4,MADSD                POINT TO AREA FR 3350   @X50RSAG 33271803
         ST    R4,WRTHA                STORE IN WRTHA          @X50RSAG 33274203
         MVI   WRTHA+C7,11             SET COUNT FOR 3350      @X50RSPC 33276603
         MVI   WRTHA,WRITE             SET COMMAND             @X50RSAG 33279003
         BR    R9                      RETURN                  @X50RSAG 33281403
         SPACE 2                                                        33283803
WINERR   EQU   *                        SKIP DISPLACEMENT IS    XL03130 33286203
*                                       DETERMINED HERE.        XL03130 33288603
         L     R4,IOBCSW                GET CCW ADDR FROM IOB.  XL03130 33291003
         SL    R4,CCWLEN                BACKUP TO LAST CCW.     XL03130 33293403
         SPACE 2                                                        33295803
         LR    R3,R9                    SAVE R9 CONTENTS       @ZM42054 33297803
         BAL   R9,WRTWIN                CHK FOR WRHA IN CHN    @ZM42054 33298203
*                                       RETURN HERE IF WRHA EXISTS      33300603
         LR    R9,R3                    RELOAD R9 CONTENTS     @ZM42054 33300703
         LA    R3,HASD                  HOME ADDR SKIP DISP.    XL03130 33300803
         CLI   0(R4),RDHACOM            WAS IT A HA ERROR?      XL03130 33307003
         BE    SETSD                    YES, GO SET SKIP DISP.  XL03130 33313203
         SPACE 2                                                        33319403
         LA    R3,RZCSD                 REC ZERO CNT SKIP DISP. XL03130 33325603
         CLI   IOBCSW+7,C8              RESIDUAL COUNT EQ 8?    XL03130 33331803
         BE    SETSD                    YES, GO SET SKIP DISP.  XL03130 33338003
         SPACE 2                                                        33344203
         LA    R3,RZDSD                 NO, SET R0 DATA SKIP.   XL03130 33350403
SETSD    EQU   *                                                XL03130 33356603
         STH   R3,WINHA                 SET SKIP DISPLACEMENT.  XL03130 33362803
         SPACE 2                                                        33369003
         B     REWRITE                  WRITE HA/R0 AGAIN.      XL03130 33375203
TRKRECL  EQU   *                                               @Z30RSAG 33377203
         BAL   R9,FREECORE             FREE IT                 @Z30RSAG 33379203
         LA    R15,8                   CODE=RECLAIMED          @Z30RSAG 33381203
         B     RETURN                                          @VS40037 33381303
         SPACE 2                                                        33383303
MADERR   EQU   *                        SKIP DISPLACEMENT IS    XL03130 33383703
*                                       DETERMINED HERE.        XL03130 33384103
         L     R4,IOBCSW                GET CCW ADDR FROM IOB.  XL03130 33384503
         SL    R4,CCWLEN                BACKUP TO LAST CCW.     XL03130 33384903
         SPACE 2                                                        33385003
         LR    R3,R9                    SAVE R9 CONTENTS       @ZM42054 33387003
         BAL   R9,WRTWIN                CHK FOR WRHA IN CHN    @ZM42054 33391003
*                                       RETURN HERE IF WRHA EXISTS      33393003
         LR    R9,R3                    RELOAD R9 CONTENTS     @ZM42054 33395003
         LA    R3,MHASD                 HOME ADDR SKIP DISP.    XL03130 33398003
         CLI   0(R4),RDHACOM            WAS IT A HA ERROR?      XL03130 33404003
         BE    SETIT                    YES, GO SET SKIP DISP.  XL03130 33410003
         SPACE 1                                                        33416003
         LA    R3,MRZCSD                REC ZERO CNT SKIP DISP. XL03130 33422003
         CLI   IOBCSW+7,C8              RESIDUAL COUNT EQ 8?    XL03130 33428003
         BE    SETSD                    YES, GO SET SKIP DISP.  XL03130 33434003
         SPACE 2                                                        33440003
         LA    R3,MRZDSD                NO, SET R0 DATA SKIP.   XL03130 33446003
SETIT    EQU   *                                                XL03130 33452003
         STH   R3,WINHA                 SET SKIP DISPLACEMENT.  XL03130 33458003
         SPACE 2                                                        33464003
         B     REWRITE                  WRITE HA/R0 AGAIN.      XL03130 33470003
         EJECT                                                          33476003
.X226607 ANOP                                                   XL03130 33482003
*********************************************************************** 33488003
*                                                                     * 33494003
*   UPDATE THE FORMAT 4 DSCB HERE.                                    * 33500016
*                                                                     * 33600016
*********************************************************************** 33700016
         SPACE 3                                                        33800016
UPF4     EQU   *                       UPDAYE THE FORMAT 4 DSCB HERE.   33900016
         BAL   R9,UPCCHH               UPDATE TRACK ADDRESS.            34000016
         MVC   ALTDATA(6),ALTINFO      UPDATE ALTERNATE INFORMATION.    34100016
         LA    R3,SEARCH               CHANNEL PROGRAM ADDRESS.         34200016
         ST    R3,IOBSTART             STORE IN IOB.                    34300016
         MVI   WRTRD,X'05'             SET OP CODE FOR WRITE.           34400016
         MVC   CCHHR(4),VTOCCCHH       SEEK//SEARCH ADDRESS.            34500016
         BAL   R9,WRTREAD              WRITE OUT NEW FORMAT 4 DSCB DATA 34600016
         BAL   R9,WAIT                 AWAIT COMPLETION.                34700016
         MVI   WRTRD,X'06'             SET OP CODE FOR READ.            34800016
         OI    WRTRD+4,SKIP            SKIP DATA TRANSFER.              34900016
         BAL   R9,WRTREAD              READ BACK CHECK DATA.            35000016
         BAL   R9,WAIT                 AWAIT COMPLETION.                35100016
         B     EXIT0                   GO RETURN TO CALLER.             35200016
         SPACE                                                          35300016
*********************************************************************** 35400016
*                                                                     * 35500016
*   INCREMENT TO THE NEXT SEQUENTIAL TRACK HERE.                      * 35600016
*                                                                     * 35700016
*********************************************************************** 35800016
         SPACE 3                                                        35900016
UPCCHH   L     R4,ALTINFO              ALTERNATE TRACK USED.            36000016
         CLC   ALTINFO+3(1),3(R6)      THIS LAST TRACK OF CYLINDER.     36100016
         BC    4,CEXIT                 NO--                             36200016
         SPACE                                                          36300016
         A     R4,4(R6)                YES-ADD CYLINDER CONVERSION.     36400016
         AIF   ('&LIB' EQ 'LIB2').X228300                       XL03912 36450003
         CLI   ALTINFO+2,X'04'         2321 AND LAST CYLINDER.          36500016
         BC    7,CEXIT2                NO--                             36600016
         AL    R4,STC2321              YES-INCREMENT STRIP.             36800016
         CLI   ALTINFO+1,X'09'         LAST STRIP                       37000016
         BC    7,CEXIT2                NO--                             37100016
         AL    R4,SCC2321              YES--INCREMENT SUBCELL.          37200016
.X228300 ANOP                                                   XL03912 37250003
         B     CEXIT2                  GO STORE VALUE AND RETURN.       37300016
CEXIT    AL    R4,F1                   INCREMENT TO NEXT TRACK.         37500016
CEXIT2   ST    R4,ALTINFO              SAVE THIS INFORMATION.           37600016
         LH    R4,ALTINFO+4            CURRENT ALTERNATE COUNT.         37800016
         BCTR  R4,0                    DECREMENT BY ONE.                37900016
         STH   R4,ALTINFO+4            SAVE UPDATED COUNT.              38000016
         BR    R9                      RETURN.                          38100016
         EJECT                                                          38200016
DATACHN  EQU   X'80'                                           @Z30RSAG 38201003
*************************************************************  @Z30RSAG 38250003
*                                                              @Z30RSAG 38260003
*   THIS SECTION PERFORMS SURFACE ANALYSIS ON 3350 DEVICES     @Z30RSAG 38270003
*                                                              @Z30RSAG 38280003
*************************************************************  @Z30RSAG 38290003
         SPACE 2                                               @Z30RSAG 38292003
DOSA     EQU   *                                               @Z30RSAG 38294003
         USING UCB,R7                                          @ZM40450 38295003
         CLI   UCBTBYT4,D3350           3350 DEVICE ?          @ZM40450 38296003
         BNER  R9                       NO, BYPASS S.A.        @ZM40450 38297003
         DROP  R7                                              @ZM40450 38298003
         CLI   0(R11),X'1F'             GETALT REQUEST?        @ZM42054 38301603
         BNER  R9                       NO, EXIT               @ZM42054 38303603
         MVC   MADSD(L6),MADSDB        SAVE SD BYTES           @X50RSPC 38308703
         MVI   HA,X'00'                CLEAR HA FLAG BYTE      @X50RSAG 38312203
*   SET UP SEARCH HA                                           @X50RSAG 38315703
         LA    R4,HA+1                 POINT TO HA AREA        @X50RSAG 38319203
         ST    R4,SCHHA                STORE ADR IN SRCH       @X50RSAG 38322703
         MVI   SCHHA,SRCH              SET SRCH HA CMND        @X50RSAG 38326203
         LA    R4,4                                            @X50RSAG 38329703
         ST    R4,SCHHA+L4             SET CCW DATA LENGTH     @Z30RSAG 38333203
         MVI   SCHHA+L4,CHAIN          SET CMND CHAINING       @Z30RSAG 38343203
*   SET UP TIC                                                 @Z30RSAG 38353203
         LA    R4,SCHHA                                        @Z30RSAG 38363203
         ST    R4,IOBSTART             UPDATE IOBCCW PTR       @Z30RSAG 38365203
         ST    R4,TICSRCH               AND TIC ADR            @Z30RSAG 38365603
         MVI   TICSRCH,X'08'           SET COMMAND             @Z30RSAG 38366003
*   SET UP WRITE HA                                            @Z30RSAG 38366403
         LA    R4,MADSD                GET THE ADDRESS         @Z30RSAG 38366503
         ST    R4,WRTHA                STORE IN COMMAND        @Z30RSAG 38366603
         MVI   WRTHA,X'19'             SET COMMAND             @Z30RSAG 38377703
         LA    R4,11                   COUNT FOR 3350          @VS40430 38387703
         STH   R4,WRTHA+L6             UPDATE LENGTH           @Z30RSAG 38387803
         MVI   WRTHA+L4,CHAIN          SET CMND CHAINING       @Z30RSAG 38388103
*   SET UP WRITE R0 MAX                                        @Z30RSAG 38388503
         LA    R3,R0COUNT              MOVE IN R0 COUNT FIELD  @Z30RSAG 38388603
         ST    R3,WRTR0                                        @Z30RSAG 38388803
         MVI   WRTR0,X'15'             SET COMMAND             @Z30RSAG 38392503
         LA    R4,8                                            @Z30RSAG 38392903
         ST    R4,WRTR0+L4                                     @Z30RSAG 38393303
         MVI   WRTR0+L4,DATACHN                                @Z30RSAG 38393703
         L     R3,8(R11)               GET BIT PATTERN ADDRESS @Z30RSAG 38394103
         ST    R3,R0DATA               SET UP CCW DATA ADDRESS @Z30RSAG 38394203
         L     R3,R0COUNT              RELOAD PRIMARY CCHH     @ZM43013 38394303
         MVI   R0DATA,X'15'            SET CCW OPCODE          @Z30RSAG 38394403
         LH    R4,MADCAP               3350 TRACK SIZE         @Z30RSAG 38394503
         ST    R4,R0DATA+L4            SET CCW DATA LENGTH     @Z30RSAG 38394903
         ST    R4,R0COUNT+L4           SET CCW DATA LENGTH     @Z30RSAG 38395303
         MVI   R0DATA+L4,CHAIN         SET CMND CHAINING       @Z30RSAG 38395703
*   SET UP READ HA                                             @Z30RSAG 38396103
         MVC   RDHA(L8),WRTHA          COPY CCW                @Z30RSAG 38396203
         MVI   RDHA,X'1A'              SET COMMAND             @Z30RSAG 38422103
         MVI   RDHA+C7,5                RESET DATA LEN         @Z30RSAG 38424103
         MVI   RDHA+L4,CHAINSD+SILI     RESET FLAGS            @Z30RSAG 38426103
*   SET UP READ R0 MAX                                         @Z30RSAG 38432103
         MVC   READR0(L8),WRTR0        COPY CCW                @Z30RSAG 38442103
         MVI   READR0,X'16'            SET COMMAND             @Z30RSAG 38444103
         MVI   READR0+L4,SILI+SKIP     STOP COMMAND CHAIN      @Z30RSAG 38446103
*   EXECUTE THE CHANNEL PROGRAM                                @Z30RSAG 38448103
         MODESET EXTKEY=SUPR                                            38450103
         EXCP  IOB                                             @Z30RSAG 38456703
         MODESET EXTKEY=DATAMGT                                         38457103
         WAIT  ECB=ECB                                         @Z30RSAG 38458703
         CLI   ECB,GOOD                OK ?                    @Z30RSAG 38460703
         BNER  R9                      NO                      @Z30RSAG 38462703
         LA    R4,R0COUNT                                      @Z30RSAG 38480003
         STCM  R4,R7,WRTR0+1           STORE COUNT IN CMND     @VS40037 38482003
         LA    R4,8                    SET DATA LENGTH FOR R0  @ZM43013 38482103
         ST    R4,R0COUNT+4            STORE IN COUNT FLD      @ZM43013 38482203
         MVI   WRTR0+R7,L16            RESET CCW LENGTH        @Z30RSAG 38482403
         MVI   WRTR0+L4,SILI           STOP CHAIN              @Z30RSAG 38482503
         XC    ECB,ECB                 CLEAR IT                @Z30RSAG 38482603
         MVI   IOB,X'42'                                       @Z30RSAG 38482703
         EXCP  IOB                                             @Z30RSAG 38506103
         WAIT  ECB=ECB                                         @Z30RSAG 38516103
         B     TRKRECL                 EXIT WITH 823I MSG      @Z30RSAG 38526103
         EJECT                                                 @Z30RSAG 38528103
*********************************************************************** 38529803
*                                                                     * 38553203
*   DEVICE CONSTANTS---ORDERED BY UCB TYPE CODES.                       38576603
*                                                                     * 38600016
*********************************************************************** 38700016
         SPACE 3                                                        38800016
         DS    0F                                                       38900016
         AIF   ('&LIB' EQ 'LIB1').X226603                       XL03130 38906003
FIRSTALT DC    X'015B000B'              3340 MOD 1 LAST PRIMARY XL03130 38930003
         DC    X'0000FFF5'              3340 CYLINDER CONVERT   XL03130 38936003
         SPACE                                                          38942003
         DC    X'02B7000B'              3340 MOD 2 LAST PRIMARY XL03130 38948003
         DC    X'0000FFF5'              3340 CYLINDER CONVERT   XL03130 38954003
         SPACE                                                          38960003
         DS    10F                      CODES 3 THRU 7 NOT USED.XL03130 38966003
*                                       2305 SUPPORT IS 308B.   XL03130 38972003
         AGO   .X226604                                         XL03130 38978003
.X226603 ANOP                                                   XL03130 38984003
FIRSTALT DC    X'00C70009'             2311 LAST PRIMARY.               39000016
CONVCYL  DC    X'0000FFF7'             2311 CYLINDER CONVERSION.        39100016
         SPACE 1                                                        39200016
         DS    4F                      2301/2303 NOT APPLICABLE.        39300016
         SPACE                                                          39400016
         DC    X'00F5002D'             2302 LAST PRIMARY.               39500016
         DC    X'0000FFD3'             2302 CYLINDER CONVERSION.        39600016
         SPACE 1                                                        39700016
         DC    X'13050413'             2321 LAST PRIMARY.               39800016
         DC    X'000000ED'             2321 CYLINDER CONVERSION.        39900016
         SPACE                                                          40000016
         DS    4F                      CODES 6 AND 7 NOT USED.          40100016
*                             2305 SUPPORT IS HANDLED IN 308B    X02114 40150021
.X226604 ANOP                                                           40170003
         SPACE                                                          40200016
         DC    X'00C70013'             2314 LAST PRIMARY.               40300016
         DC    X'0000FFED'             2314 CYLINDER CONVERSION.        40400016
         SPACE                                                          40420020
         DC    X'01930012'              CCHH AT LAST PRIMARY     M5448  40440020
         DC    X'0000FFEE'              CYL INCREMENT            M5448  40460020
         SPACE                                                          40500016
         AIF   ('&LIB' EQ 'LIB1').X227911                       XL03145 40510003
         DS    2F                      CODE A NOT USED         @Z30RSAG 40520003
         SPACE                                                          40530003
         DC    X'022A001D'             3350 LAST PRIMARY       @Z30RSAG 40532003
         DC    X'0000FFE3'             3350 CYL CONVERSION     @Z30RSAG 40534003
         SPACE 1                                               @Z30RSAG 40536003
         DS    2F                      CODE C NOT USED         @Z30RSAG 40538003
         DC    X'03270012'             3330-1 LAST PRIMARY.     XL03145 40540003
         DC    X'0000FFEE'             3330-1 CYL CONVERSION.   XL03145 40550003
         SPACE                                                          40560003
*        SS/1 ALTERNATE TRACK INFORMATION                      @Y30LSFY 40562003
SS1CONM  DC    X'01980012'              CCHH AT LAST PRIMARY   @Y30LSFY 40564003
         DC    X'0000FFEE'              CYL INCREMENT          @Y30LSFY 40566003
SS1CONI  DC    X'03280012'              CCHH AT LAST PRIMARY   @Y30LSFY 40568003
         DC    X'0000FFEE'              CYL INCREMENT          @Y30LSFY 40568403
         AGO   .X227912                                         XL03145 40570003
.X227911 ANOP                                                   XL03145 40580003
SCC2321  DC    X'00F60000'             INCREMENT TO NEXT SUBCELL.       40600016
STC2321  DC    X'0000FB00'             INCREMENT TO NEXT STRIP.         40700016
.X227912 ANOP                                                   XL03145 40750003
         EJECT                                                          40800016
WRTREAD  EXCP  IOB                     START THE I/O OPERATION.         40900016
         BR    R9                      RETURN.                          41000016
         SPACE                                                          41100002
WAIT     TM    ECB,COMPLETE            THIS OPERATION COMPLETE.         41200016
         BO    TEST                    YES-TEST ITS STATUS.             41300016
         WAIT  ECB=ECB                 NO--AWAIT COMPLETION.            41400016
TEST     CLI   ECB,GOOD                EVERYTHING A-OK.                 41500016
         BCR   8,R9                    YES-RETURN.                      41600016
         TM    IOBCSW+4,UE             THIS A UNIT EXCEPTION.           41700016
         BCR   1,R9                    YES-//THIS IS OKAY.              41800016
         TM    RETSW,MOVEHA            THIS THE 2ND ATTEMPT.   @ZA04363 41900003
         BO    IOERR                   YES--CANNOT TRY AGAIN.           42000016
         AIF   ('&LIB' EQ 'LIB1').X227601                               42210003
         CLI   UCBTBYT4,D3350           IS THIS A 3350?         XL03130 42212003
         BE    MADERR                   YES GO FIND SKIP DISP.  XL03130 42214003
         CLI   UCBTBYT4,WIN             IS THIS A 3340?         XL03130 42220003
         BE    WINERR                   YES GO FIND SKIP DISP.  XL03130 42230003
.X227601 ANOP                                                           42250003
REWRITE  EQU   *                                               @ZM42054 42260003
         OI    RETSW,MOVEHA            SET FLG,MOVE DOWN TRK.  @ZA04363 42300003
         EXCP  IOB                     REPEAT THE REQUEST.              42400016
         B     WAIT                    AWAIT COMPLETION.                42500016
         SPACE                                                          42600002
FREECORE EQU   *                       RELEASE THE CORE HERE.           42700016
         LH    R3,SIZE                 SIZE OF AREA TO RELEASE.         42800016
         FREEMAIN R,LV=(3),A=(2),SP=229                         YL02912 42900002
         LA    R3,ENDLIST-PARMLIST      SIZE OF PARM LIST.      YL02912 42930002
         FREEMAIN R,LV=(3),A=(11),SP=229 FREE PARM LIST.        YL02912 42960002
         BR    R9                      RETURN.                          43000016
         SPACE                                                          43100016
IOERR    EQU   *                                                        43200016
         BAL   R9,FREECORE              RELEASE GOTTEN CORE.    YL02912 43250002
         LA    R15,12                  SET RETURN CODE.                 43300016
         B     RETURN                  RETURN TO CALLER.        YL02912 43400002
         EJECT                                                          43450002
F1       DC    F'1'                    TRACK INCREMENT CONSTANT.        43600016
MADCAP   DC    1H'19069'               3350 TRACK SIZE         @X50RSPC 43710003
ROLENGTH DC    1F'8'                    R0 KEY DATA L            S21041 43730021
ZERO     DC    1H'0'                   COMPARE CONSTANT.        YL02912 43740002
MAINT    DS    60X                      ZAP FIX AREA.           YL02912 43750002
K4       EQU   4                        DISPLACEMENT CON         S21041 43760021
         AIF   ('&LIB' EQ 'LIB1').X227602                               43763003
C4       EQU   X'04'                    COUNT FOR SEARCH.       XL03130 43766003
EQ       EQU   X'08'                    EQUAL CONDITION.         XM4405 43768003
NE       EQU   X'07'                    NOT EQUAL CONDITION.    XL03130 43769003
C7       EQU   X'07'                    COUNT FOR 3340 WRT HA.  XL03130 43772003
C8       EQU   X'08'                    COUNT COMPARAND.        XL03130 43775003
L2       EQU   2                        LENGTH CONSTANT.         XM4405 43783903
L4       EQU   4                        LENGTH CONSTANT        @Z30RSAG 43785903
L6       EQU   6                        LENGTH CONSTANT        @Z30RSAG 43786303
L8       EQU   8                        LENGTH CONSTANT        @Z30RSAG 43787903
L24      EQU   24                       LENGTH CONSTANT.         XM4405 43793203
HASD     EQU   110                      HOME ADDR SKIP DISP.    XL03130 43793302
RZCSD    EQU   200                      REC ZERO CNT SKIP DISP. XL03130 43793602
RZDSD    EQU   285                      REC ZERO DATA SKIP DISP XL03130 43794002
MHASD    EQU   124                      HOME ADDR SKIP DISP.   @Z30RSAG 43794203
MRZCSD   EQU   200                      REC ZERO CNT SKIP DISP @Z30RSAG 43794303
MRZDSD   EQU   310                      REC ZERO DATA SD       @Z30RSAG 43794603
CCWLEN   EQU   ROLENGTH                 CCW LENGTH.             XL03130 43794903
SENSE    EQU   X'04'                    SENSE COMMAND.           XM4405 43795202
WRITE    EQU   X'19'                    WRITE HA COMMAND.       XL03130 43795602
SRCH     EQU   X'39'                    SEARCH HA COMMAND.      XL03130 43796002
RDHACOM  EQU   X'1A'                    READ HA COMMAND.        XL03130 43796202
TICCMD   EQU   X'08'                    TIC COMMAND.            XL03130 43798602
         SPACE 3                                                        43800602
*********************************************************************** 43800802
*                                                                     * 43801402
*   PARAMETER LIST DSECT                                              * 43802002
*                                                                     * 43802602
*********************************************************************** 43803202
         SPACE 2                                                        43803802
PARMLIST DSECT                                                  YL02912 43804402
FUNCTION DS    0F                       CALLER'S FUNCTION.      YL02912 43805002
UCBPTR   DS    F                        UCB POINTER.            YL02912 43805602
DCBPTR   DS    F                        DCB POINTER OR          YL02912 43806202
CCHHPARM EQU   DCBPTR                   ADDR OF TRACK OR        YL02912 43806802
SERPTR   EQU   DCBPTR                   ADDR OF VOL SER.        YL02912 43807402
ALTPTR   DS    F                        ADDR OF ALTINFO OR      YL02912 43808002
NEWCCHH  EQU   ALTPTR                   NEW TRACK ADDRESS.      YL02912 43808602
DEBPTR   DS    F                        DEB POINTER OR          YL02912 43809202
DEVMODP  EQU   DEBPTR                   ADDR OF 3340 MODEL NO.  YL02912 43809802
PRMPTR   DS    F                        ADDR OF CALLER'S LIST.  YL02912 43810402
KEY      EQU   PRMPTR                   KEY OF CALLER.          YL02912 43811002
IGCRESV  DS    4F                       RESERVED                 YM1129 43823402
ENDLIST  EQU   *                        PARAMETER LIST END.     YL02912 43849002
         EJECT                                                          43874502
.X227602 ANOP                                                   XL03130 43882203
         EJECT                                                          43891103
IOBLOCKS DSECT                                                          43900016
MYDEB    EQU   *                       DEB DEFINITION.                  44000016
DEBEOEA  DS    1F                      END-OF-EXTENT.                   44100016
DEBSIOA  DS    1F                      START I/O.                       44200016
DEBPCIA  DS    1F                      PCI.                             44300016
DEBCEA   DS    1F                      CHANNEL END.                     44400016
DEBXCEA  DS    1F                      ABNORMAL END.                    44500016
         DS    CL12                                                     44600016
DEBLNGTH DS    CL1                     DEB LENGTH(DOUBLE WORDS)         44700016
         DS    CL3                                                      44800016
DEB      EQU   *                       DEB PROPER                       44900016
DEBNMSUB DS    CL1                     OPEN SUBROUTINES.                45000016
DEBTCBAD DS    CL3                     TCB ADDRESS.                     45100016
DEBAMLNG DS    CL1                     LENGTH ACCESS METHOD.            45200016
DEBDEBAD DS    CL3                     NEXT DEB ADDRESS.                45300016
DEBOFLGS DS    CL1                     DATA SET FLAGS.                  45400016
DEBIRBAD DS    CL3                     IRB ADDRESS.                     45500016
DEBOPATB DS    CL1                     TYPE OF I/O.                     45600016
DEBSYSPG DS    CL3                     IOB PURGE ADDRESS.(SYSTEM)       45700016
DEBNMEXT DS    CL1                     NO. OF EXTENTS.                  45800016
DEBUSRPG DS    CL3                     IOB USER PURGE ADDRESS.          45900016
DEBPRIOR DS    CL1                     ZERO                             46000016
DEBECBAD DS    CL3                     PURGE ECB.                       46100016
DEBDEBID DS    CL1                     PROTECT KEY//ID.                 46200016
DEBDCBAD DS    CL3                     DCB ADDRESS.                     46300016
DEBEXSCL DS    CL1                     EXTENT SCALE.                    46400016
DEBAPPAD DS    CL3                     APPENDAGE VECTOR TABLE.          46500016
DEBDVMOD DS    CL1                     FILE MASK.                       46600016
DEBUCBAD DS    CL3                     UCB ADDRESS.                     46700016
DEBBINNO DS    CL2                     BIN NO. FOR 2321.                46800016
DEBSTRCC DS    CL2                     CYLINDER START.                  46900016
DEBSTRHH DS    CL2                     HEAD START.                      47000016
DEBENDCC DS    CL2                     CYLINDER END.                    47100016
DEBENDHH DS    CL2                     HEAD END.                        47200016
DEBNMTRK DS    CL2                     NUMBER OF TRACKS.                47300016
         DS    CL20                                                     47400016
DEBEND   DS    0C                      END OF DEB.                      47500016
         EJECT                                                          47600016
ECB      DS    1F                      ECB HERE.                        47700016
IOB      EQU   *                       IOB HERE.                        47800016
IOBFLAG1 DS    CL1                     FLAG1                            47900016
IOBFLAG2 DS    CL1                     FLAG2.                           48000016
IOBSENS0 DS    CL1                     SENSE BYTE ZERO.                 48100016
IOBSENS1 DS    CL1                     SENSE BYTE ONE.                  48200016
IOBECBAD DS    CL4                     ADDRESS OF ECB.                  48300016
IOBCSW   DS    CL8                     STATUS WORDS.                    48400016
IOBSTART DS    CL4                     CHANNEL PROGRAM ADDRESS.         48500016
IOBDCBPT DS    CL4                     ADDRESS OF DCB.                  48600016
IOBRESTR DS    CL4                     RESTART ADDRESS.                 48700016
IOBINCAM DS    CL2                     BLOCK COUNT.                     48800016
IOBERRCT DS    CL2                     ERROR COUNT.                     48900016
IOBSEEK  DS    CL8                     SEEK ADDRESS.                    49000016
CCHHR    EQU   IOBSEEK+3               SEARCH ADDRESS.                  49100016
DCB      DS    1F                      DEB ADDRESS.                     49200016
ALTINFO  DS    1D                      KEEP ALTERNATE TRACK INFO HERE.  49300016
         AIF   ('&LIB' EQ 'LIB1').X302301                       XL03130 49350003
SCHHA    DS    1D                      SEARCH HOME ADDRESS.     XL03130 49360003
TICSRCH  DS    1D                       TIC CCW.                XL03130 49362003
.X302301 ANOP                                                   XL03130 49370003
WRTHA    DS    1D                      WRITE HOME ADDRESS.              49400016
WRTR0    DS    1D                      WRITE RECORD ZERO.               49500016
R0DATA   DS    1D                                              @Z30RSAG 49550003
RDHA     DS    1D                      READ HOME ADDRESS.               49600016
READR0   DS    1D                      READ RECORD ZERO.                49700016
         AIF   ('&LIB' EQ 'LIB1').X227800                       XL03130 49750003
         DS    CL6                      RESERVED.               XL03130 49760003
MADSD    DS    CL4                     ADTL 3350 SD BYTES      @X50RSPC 49762003
WINHA    DS    CL2                      3340 HOME ADDRESS.      XL03130 49770003
.X227800 ANOP                                                   XL03130 49780003
HA       DS    CL5                     HOME ADDRESS.                    49800016
SW       DS    CL1                     SWITCH.                          49900016
D2314    EQU   X'80'                   2314 DEVICE.                     50000016
D2321    EQU   X'40'                   2321 DEVICE.                     50100016
DEFALT   EQU   X'02'                                               1057 50150018
RETRY    EQU   X'01'                   GIVE IT ONE MORE TRY.            50200016
SIZE     DS    CL2                     SIZE OF GETMAIN AREA.            50300016
R0COUNT  DS    1D                      RECORD ZERO COUNT FIELD.         50400016
         DS    1D                      RECORD ZERO DATA  FIELD.@Z30RSAG 50500003
         AIF   ('&LIB' EQ 'LIB1').X322202                        XM4405 50550003
SNSBYTES DS    CL24                    SNS BYTE READ IN AREA.    XM4405 50560003
MADSDB   EQU   SNSBYTES+18             ADTL 3350 SD BYTES      @X50RSPC 50562003
SDBYTES  EQU   SNSBYTES+22             SKIP DISP IN SENSE AREA.  XM4405 50570003
.X322202 ANOP                                                    XM4405 50580003
RETSW    DS    CL1                     RETRY SW                @ZA04363 50590003
IOEND1   DS    0C                      END OF BASIC I/O BLOCKS.         50600016
*   EXTENSION FOR GETALT//DYNAMIC TRACK REQUEST.                        50700016
SEARCH   DS    1D                      SEARCH CCW.                      50800016
TIC      DS    1D                      REPEAT UNTIL FOUND.              50900016
WRTRD    DS    1D                      WRITE OR READ DATA.              51000016
FORMAT4  DS    CL96                    FORMAT4 DSCB READ IN AREA.       51100016
ALTDATA  EQU   FORMAT4+8               ALTERNATE TRACK INFORMATION.     51200016
VTOCCCHH EQU   FORMAT4+63              CCHH START OF VTOC.              51300016
IOEND    DS    0C                                                       51400016
         EJECT                                                          51500016
UCB      DSECT                                                          51600016
         IEFUCBOB                                                       51700016
         EJECT                                                          51800016
CVT      DSECT                                                          51900016
         CVT   SYS=MIN                                                  52000016
         END                                                            52100016
./  ADD  SSI=80940015,NAME=IGC0208B
         TITLE 'IGC0208B --- UPDATES UCBS FOR IEHDASDR UTILITY'         00202021
         COPY  LCGASMSW                                          SM4351 00204021
IGC0208B CSECT                                                          00210021
*********************************************************************** 00210299
*                  FIXES THIS MODULE                                  * 00210499
*                    LATEST FIRST                                     * 00210699
*********************************************************************** 00210899
*                                                                       00211099
*A 240020                     MVS 037 ONLY                     @ZA31271 00211299
*                                                                       00211399
*C 185000                           @YA16250=@XA19110=@ZA24230=@SA79732 00211499
*A 534000-534500                    @YA16250=@XA19110=@ZA24230=@SA79732 00211599
*                                                                       00212000
*C 186000,490000,576000,580000               @XA14188=@YA13317=@ZA07401 00220040
*A 184100-185000,572500-573700,592100        @XA14188=@YA13317=@ZA07401 00230040
*                                                                       00260003
*C193000                                                        @30AAAG 00270040
*A196500,197000,198500,199000,500,600                           @30AAAG 00310040
*                                                                       00360003
*STATUS- CHANGE LEVEL 000                                             * 00400016
*                                                                     * 00600016
*********************************************************************** 00650099
         EJECT                                                          00700099
*FUNCTION/OPERATION-  THIS LOAD OF SVC 82 -POSTS- THE UCBS FOR        * 00800016
*   DIRECT ACCESS VOLUMES THAT ARE WRITTEN ON BY THE -IEHDASDR-       * 01000016
*   UTILITY PROGRAM. IT DOES SO AS FOLLOWS.                           * 01200016
*                                                                     * 01400016
*        -IF DUPLICATE SERIAL NUMBERS ARE ENCOUNTERED ;         SA55451 01450000
*         1) SVC 91 IS ISSUED,                                  SA55451 01500000
*         2) VOLUME SERIAL NO. IN THE UCB IS CLEARED,           SA55451 01550000
*         3) NOT-READY BIT IN UCB IS SET,                       SA55451 01600000
*         4) A DEMOUNT MESSAGE IS SENT TO THE OPERATOR.         SA55451 01650000
*                                                                     * 02200016
*        -IF A NEW/UNIQUE SERIAL NO. RESULTS,ISSUE A -NEW- MESSAGE    * 02400016
*         TO THE OPERATOR. PLACE THE SERIAL NO. IN THE UCB.           * 02600016
*                                                                     * 02800016
*        -IF A NEW VTOC HAS BEEN PLACED ON THIS VOLUME, PUT ITS       * 03000016
*         TTR IN THE UCB.                                             * 03200016
*                                                                     * 03400016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IGC0208B-.                    * 03600016
*                                                                     * 03800016
*INPUT-  REGISTER 1 POINTS TO THE SVRB.                               * 04000016
*   THE EXTENDED AREA OF THE SVRB CONTAINS THE INPUT PARM POINTER     * 04200016
*   THAT WAS PASSED TO -IGC0008B-.                                    * 04400016
*                                                                     * 04600016
*EXITS-NORMAL- VIA A SVC 3 TO THE CALLING ROUTINE.                    * 04800016
*                                                                     * 05000016
*EXITS-ERROR-  NONE POSSIBLE.                                         * 05200016
*                                                                     * 05400016
*SUPERVISOR MACROS-  GETMAIN,FREEMAIN,WTO.                            * 05600016
*                                                                     * 05800016
*OUTPUT-  IF NEW VTOC, ITS TTR IS PLACED IN THE UCB.                  * 06000016
*         IF DUPLICATE SERIAL NO., A RETAIN MESSAGE IS ISSUED.        * 06200016
*         IF NEW SERIAL NO., A NEW MESSAGE IS ISSUED.                 * 06400016
*                                                                     * 06600016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,PRIVILEGED,ENABLED.               * 06800016
*                                                                     * 07000016
*********************************************************************** 07050002
         EJECT                                                          07100002
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             07400016
PARMPTR  EQU   1                       POINTER TO INPUT PARAMETERS.     07600016
R0       EQU   0                                                        07800016
R1       EQU   1                                                        08000016
R2       EQU   2                                                        08200016
R3       EQU   3                                                        08400016
R4       EQU   4                                                        08600016
R5       EQU   5                                                 YM1180 08650002
R6       EQU   6                                                        08800016
R9       EQU   9                                                        09000016
R11      EQU   11                      POINTER TO INPUT PARAMETERS.     09200016
R14      EQU   14                      LINK REGISTER.                   09400016
R15      EQU   15                                                       09600016
GR1      EQU   1                                                        09800016
GR2      EQU   2                       INDEX TO UCB TABLE ENTRIES.      10000016
GR3      EQU   3                       POINTER TO TABLE UCB.            10200016
GR4      EQU   4                       POINTER TO NEW SERIAL.           10400016
GR5      EQU   5                       POINTER TO TABLE UCB  SERIAL.    10600016
GR6      EQU   6                       POINTER TO INPUT UCB.            10800016
GR7      EQU   7                                                        11000016
GR8      EQU   8                                                        11200016
GR9      EQU   9                                                        11400016
GR10     EQU   10                                                       11600016
GR11     EQU   11                                                       11800016
GR12     EQU   12                                                       12000016
GR14     EQU   14                      LINK REGISTER.                   12200016
BASEREG  EQU   12                      BASE REGISTER.                   12400016
GR15     EQU   15                                                       12600016
         SPACE                                                          12800016
DYNALT   EQU   X'1F'                   GETALT ASSIGNMENT.               13000016
NEWVOL   EQU   X'8F'                   NEW VOLUME INPUT.                13200016
COMMA    EQU   C','                    EBCDIC COMMA.                    13400016
WSIZE    EQU   64                      SIZE OF MESSAGE AREA.            13800016
WSIZE1   EQU   WSIZE-12                MESSAGE LENGTH.                  14000016
RBEXSAVE EQU   96                      EXTENTED SAVE AREA FOR SVRB.     14600016
NOTREADY EQU   X'40'                   UCB NOT READY BIT.               15200016
K36      EQU   36                      DISPLACEMENT CONSTANT.   YL02912 15250002
D0       EQU   0                       DISPLACEMENT OF ZERO.     YM1129 15300002
D1       EQU   1                       DISPLACEMENT OF ONE      YL02912 15350002
L3       EQU   3                       LENGTH OF THREE.         YL02912 15360002
L6       EQU   6                       LENGTH OF SIX.           YL02912 15370002
         SPACE                                                          15400016
POST     EQU   X'08'                   POST INDICATOR.                  15600016
         EJECT                                                          16000016
         LR    BASEREG,GR15            SET UP ADDRESSING.               16200016
         USING IGC0208B,BASEREG                                         16400016
         SPACE                                                          16600016
         SPACE 2                                                        16800016
*   POST THE UCBS HERE.                                                 17000016
CKUCBS   EQU   *                                                        17200016
         L     GR11,RBEXSAVE+16(GR1)   PARM LIST POINTER.               17400016
         USING PARMLIST,GR11                                    YL02912 17500002
         LR    GR9,GR1                 SVRB ADDRESS.                    17600016
         USING CVT,GR2                                                  18400016
         B     APARNO                  B AROUND APARNO         @ZA07401 18410000
         DC    C'IGC0208B'             MODULE IDENTIFIER       @ZA07401 18450040
         DC    C'OZ31271'              LAST FIX IN THIS MODULE @ZA31271 18500099
APARNO   L     GR2,CVTPTR              ADDRESS OF CVT.         @ZA07401 18600000
         L     GR2,CVTILK2             UCB ADDRESS TABLE.               18800016
         DROP  GR2                                                      19000016
STARTEST EQU   *                                                   O122 19060019
         L     GR4,SERPTR               POINTER TO NEW SERIAL.  YL02912 19120002
         L     GR6,UCBPTR               POINTER TO UCB.         YL02912 19180002
         LA    GR6,0(GR6)              CLEAR HIGH ORDER BYTE.      O122 19240019
         SR    GR3,GR3                 CLEAR REGISTER 3.       @ZA31271 19270099
         ICM   GR3,3,0(GR2)            GET UCB ADDR            @30AAAG  19300003
         LTR   GR3,GR3                 VALID ENTRY.                     19400016
         BZ    UPUCBPTR                NO--GO SEE IF MORE ENTRIES.      19600016
*        THE FOLLOWING CODE HANDLES 16-BIT UCB ADDRESSES.      @30AAAG  19650003
         BP    NOT16                   NOT 16-BIT UCB ADDR     @30AAAG  19700003
         USING UCB,GR3                                                  19800016
         N     GR3,BITMASK             TURN OFF LEFT HALF WD   @30AAAG  19850003
         CLM   GR3,3,UCBLAST           LOOK FOR EOT            @30AAAG  19900003
         BE    PRETURN                 BRCH IF END OF TABLE    @30AAAG  19950003
NOT16    EQU   *                                               @30AAAG  19960003
         TM    UCBTBYT3,UCB3DACC       THIS A DIRECT ACCESS DEVICE.     20000016
         BZ    UPUCBPTR                NO--GO SEE IF MORE ENTRIES.      20200016
         AIF   ('&LIB' NE 'LIB1').X301201                       XL03912 20250003
         CLI   UCBTBYT4,DA2321         THIS A 2321.                     20400016
         BE    PROC2321                YES-SPECIAL CASE.                20600016
.X301201 ANOP                                                   XL03912 20650003
         LA    GR5,SRTEVOLI            ADDRESS OF SERIAL NO.            20800016
         C     GR5,RBEXSAVE+16(GR9)    THIS UCB TESTED          SA53836 20850002
         BE    UPUCBPTR                GO TEST NEXT UCB         SA53836 20900002
         BAL   GR7,TESTUCB             GO TEST FOR IDENTICAL/NEW.       21000016
         B     UPUCBPTR                GO TEST NEXT UCB.                21200016
         AIF   ('&LIB' NE 'LIB1').X301202                       XL03912 21250003
         SPACE                                                          21400016
PROC2321 LA    GR3,DATACELL            ADDRESS OF 1ST SUB-UCB.          21600016
CK2321   LA    GR5,DCELVOLI-DATACELL(GR3) SERIAL NO. ADDRESS.           21800016
         BAL   GR7,TESTUCB             GO TEST IDENTICAL//NEW.          22000016
         CLI   1(GR3),LASTBIN          THIS THE LAST SUB-UCB.           22200016
         BE    UPUCBPTR                YES--GO TEST NEXT UCB.           22400016
         LA    GR3,SUBLNG(GR3)         STEP TO NEXT SUB-UCB.            22600016
         B     CK2321                  GO CHECK ALL SUB-UCBS.           22800016
.X301202 ANOP                                                   XL03912 22850003
         DROP  3                                                        23000016
         SPACE                                                          23200016
UPUCBPTR LA    GR2,2(GR2)              STEP TO NEXT TABLE ENTRY.        23400016
         CLC   0(2,GR2),UCBLAST        ANY MORE ENTRIES.                23600016
         BNE   STARTEST                YES--KEEP LOOKING.               23800016
PRETURN  EQU  *                                                 YL02912 23850002
         LA    R2,ENDLIST-PARMLIST      PARM LIST SIZE.         YL02912 23860002
         FREEMAIN R,LV=(2),A=(11),SP=229 FREE PARM LIST         YL02912 23920002
         SR    R15,R15                  SET RETURN CODE.        YL02912 24000002
         L     R14,RBEXSAVE+K36(GR9)    GET RETURN ADDRESS.     YL02912 24050002
         MODESET EXTKEY=SUPR                                    YM1315  24060002
         BR    R14                      RETURN TO CALLER.       YL02912 24100002
         EJECT                                                          24200016
TESTUCB  EQU   *                                                        24400002
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.       YL02912 24450002
         CLC   D0(L6,GR4),D0(GR5)       SERIAL NUMBERS EQUAL?   YL02912 24500002
         MODESET EXTKEY=DATAMGT                                 UL02912 24550002
         BE    WTOR                    YES-TELL OPERATOR TO REMOVE VOL. 24600016
TESTUCB1 CLR  GR6,GR3                 THIS THE SELECTED UCB/SUB UCB.    24800016
         BE    WTON                    YES-TELL ABOUT NEW SERIAL.       25000016
         BR    GR7                     NO--RETURN.                      25200016
         SPACE 2                                                        25400016
WTON     EQU   *                       UPDATE UCB HERE//TELL OPERATOR.  25600016
         LTR   GR4,GR4                 IS THERE A NEW SERIAL NO.        25800016
         BZ    TESTTR                  NO--GO SEE IF TTR NEEDS UPDATE.  26000016
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.       YL02912 26100002
         CLC   0(6,GR4),0(GR5)         ARE THE SERIAL NOS. THE SAME.    26200016
         MODESET EXTKEY=DATAMGT                                 YL02912 26300002
         BE    TESTTR                  YES-NO NEED TO TELL THE USER.    26400016
         BAL   GR8,SETUPMSG            PLACE MESSAGE IN BUFFER.         26600016
         MVI   12(GR10),C'N'           'NEW' INDICATOR TO MESSAGE.      26800016
         BAL   GR8,WRITE               WRITE TO OPERATOR//FREECORE.     27000016
         MODESET   EXTKEY=SUPR                                  YL02912 27010002
         ST    GR5,RBEXSAVE+16(GR9)    INDICATE UCB TESTED      SA53836 27050002
         MODESET   EXTKEY=DATAMGT                               YL02912 27060002
         TM    SRTESTAT-UCB(GR6),SRTEONLI  DEVICE ONLINE.          X726 27100018
         BZ    TESTTR                  NO-GO PROCESS VTOC.         X726 27200018
         MODESET EXTKEY=SUPR                                    YL02912 27250002
         MVC   0(6,GR5),0(GR4)         YES-NEW SERIAL NO TO UCB.   X726 27300018
         MODESET EXTKEY=DATAMGT                                 YL02912 27350002
*    UPDATE TTR OF VTOC HERE.                                           27400016
TESTTR   EQU   *                                                YL02912 27600002
         OC    NEWCCHH+D1(L3),NEWCCHH+D1 NEED TTR UPDATE?       YL02912 27700002
         BCR   8,GR7                   NO--GO CHECK MORE UCBS.     O122 27800019
*     BUILD A DUMMY DEB HERE.                                           28000016
         LA    R3,RBEXSAVE(GR9)        SAVE AREA ADDRESS.               28200016
         L     GR8,K36(R3)             SAVE RETURN ADDRESS.     YL02912 28250002
         MODESET   EXTKEY=SUPR                                  YL02912 28300002
         STM   1,12,0(R3)              SAVE THE REGISTERS.              28400016
         MODESET   EXTKEY=DATAMGT                               YL02912 28450002
         GETMAIN R,LV=0+DEBEND-DEB,SP=229                       YL02912 28600002
         USING DEB,1                                                    28800016
         XC    DEB(DEBEND-DEB),DEB     CLEAR CORE TO ZERO.              29000016
         MVI   DEBNMEXT,1              SET FOR 1 EXTENT.                29200016
         MVI   DEBENDCC,X'7F'          SET UPPER EXTENT LIMIT.          29400016
         MVI   DEBNMTRK,X'7F'          SET NO. OF TRACKS.               29600016
         MVI   DEBDEBID,X'0F'          PROTECT KEY//DEB ID.             29800016
         AIF   ('&LIB' NE 'LIB1').X301203                       XL03912 29850003
         L     GR4,0(GR11)             UCB ADDRESS.                     30000016
         USING UCB,4                                                    30200016
         CLI   UCBID,MAINUCB           THIS A 2321.                     30400016
         BNE   DEB2321                 YES--GO HANDLE.                  30600016
.X301203 ANOP                                                   XL03912 30650003
         MVC   DEBUCBAD(L3),UCBPTR+D1   UCB ADDRESS TO DEB.     YL02912 30800002
         AIF   ('&LIB' NE 'LIB1').X301204                       XL03912 30850003
         DROP  4                                                        31000016
.X301204 ANOP                                                   XL03912 31050003
         SPACE                                                          31200016
BUILD1   EQU   *                                                        31400016
         USING CVT,R15                                                  31600016
         L     R15,CVTPTR              ADDRESS OF CVT.                  31800016
         L     R15,CVTPRLTV            CONVERT ADDRESS//MBBCCHHR TO TTR 32000016
         DROP  15                                                       32200016
         SPACE                                                          32400016
         L     R2,NEWCCHH               VTOC PTR FOR UCB.       YL02912 32600002
         MODESET KEYADDR=KEY,WORKREG=14  GET CALLERS KEY         YM1384 32650002
         LM    R4,R5,D0(R2)            GET VTOC CCHH.            YM1180 32700002
         MODESET EXTKEY=DATAMGT                                  YM1384 32710002
         STM   R4,R5,VTOCCCHH          PUT CCHH IN SVC AREA.     YM1180 32750002
         LA    R2,VTOCCCHH             TTR PTR FOR CONVERT.      YM1129 32760002
         SPACE                                                          32800016
         BALR  R14,R15                 CONVERT MBBCCHHR TO TTR.         33000016
         SPACE                                                          33200016
         LR    R15,R1                  SAVE DEB ADDRESS.                33400016
         LM    1,12,0(R3)              RESTORE THE REGISTERS.           33600016
         MODESET   EXTKEY=SUPR                                  YL02912 33610002
         ST    GR8,K36(R3)             RESTORE RETURN ADDRESS.  YL02912 33650002
         MODESET   EXTKEY=DATAMGT                               YL02912 33700002
         SPACE                                                          33800016
         USING UCB,R3                                                   34000016
         L     R3,UCBPTR                GET UCB ADDRESS.        YL02912 34210002
         MODESET EXTKEY=SUPR                                    YL02912 34220002
         AIF   ('&LIB' NE 'LIB1').X301205                       XL03912 34250003
         CLI   UCBID,MAINUCB           THIS A 2321.                     34400016
         BNE   PR2321                  YES--GO HANDLE.                  34600016
.X301205 ANOP                                                   XL03912 34650003
         ST    R0,SRTEFSCT             TTR OF VTOC.                     34800016
         MODESET EXTKEY=DATAMGT                                 YL02912 34900002
TTREND   EQU   *                                                        35000016
         LR    R1,R15                  RESTORE DEB ADDRESS.             35200016
         FREEMAIN R,LV=0+DEBEND-DEB,A=(1),SP=229                YL02912 35400002
         BR    GR7                     GO CHECK MORE UCBS.         O122 35600019
         AIF   ('&LIB' NE 'LIB1').X301206                       XL03912 35650003
         SPACE                                                          35800016
         USING DATACELL,R3                                              36000016
PR2321   ST    R0,DCELVTOC             TTR OF VTOC TO UCB---2321.       36200016
         B     TTREND                  GO EXIT.                         36400016
         DROP  3                                                        36600016
         SPACE 2                                                        36800016
DEB2321  LR    GR6,GR4                 UCB ADDRESS.                     37000016
         BAL   GR14,CONV2321           FIND ADDRESS OF MAIN UCB.        37200016
         ST    GR6,DEBUCBAD-1          2321 UCB ADDRESS TO DEB.         37400016
         B     BUILD1                  EXIT.                            37600016
.X301206 ANOP                                                   XL03912 37650003
         DROP  1                                                        37800016
         SPACE                                                          38000016
*   TELL OPERATOR TO REMOVE THIS VOLUME//IDENTICAL SERIAL NUMBERS     * 38200016
WTOR     EQU   *                                                        38400016
         LTR   GR4,GR4                 WAS THERE A NEW SERIAL NO.       38600016
         BZ    TESTUCB1                NO--GO MAKE MORE TESTS.          38800016
         USING UCB,3                                                    39000016
         AIF   ('&LIB' NE 'LIB1').X301207                       XL03912 39050003
         CLI   UCBID,MAINUCB           THIS A SUB-UCB.                  39200016
         BNE   TESTSUB3                YES--GO CHECK STATUS.            39400016
.X301207 ANOP                                                   XL03912 39450003
         TM    SRTESTAT,SRTEONLI       IS THE TABLE UCB ON-LINE.        39600016
         BCR   8,GR7                   NO--RETURN.                      39800016
         SPACE                                                          40000016
         USING UCB,6                                                    40200016
         TM    SRTESTAT,SRTEONLI       THE SUBJECT UCB ON-LINE.         40800016
         BC    8,TESTUCB1              NO--GO MAKE MORE TESTS.          41000016
         DROP  3,6                                                      41200016
TESTIDEN CLR   GR6,GR3                 THIS THE SUBJECT UCB.            41600016
         BE    TESTUCB1                YES-GO MAKE MORE TESTS.          41800016
         BAL   GR8,SETUPMSG            COMPLETE THE MESSAGE.            42000016
         MVI   12(GR10),C'R'           'REMOVE' INDICATOR TO MESSAGE.   42200016
         USING UCB,GR6                                                  42400016
         AIF   ('&LIB' NE 'LIB1').X301208                       XL03912 42450003
         CLI   UCBTBYT4,DA2321         THIS A 2321.                     42600016
         BE    YES2321                 YES-GO CLEAR SERIAL NO.          42800016
.X301208 ANOP                                                   XL03912 42850003
         TM    SRTESTAT,SRTEPRES       THIS A NON-DEMOUNTABLE DEVICE.   43060016
         BO    SETNR2                  YES-BETTER MARK IT OFF-LINE.     43120016
         LNR   R0,R6                    COMPLIMENTED UCB ADDR   SA55451 43250002
         SVC   91                       ISSUE VOLSTAT SVC       SA55451 43350002
         MODESET EXTKEY=SUPR                                    YL02912 43355002
         XC    SRTEVOLI(6),SRTEVOLI     CLEAR SERIAL NO.        SA55451 43360002
*   TURN ON NOT-READY BIT HERE.                                         43400016
         OI    UCBFL2,NOTREADY         MAKE UCB NOT-READY.              43600016
         MODESET EXTKEY=DATAMGT                                 YL02912 43700002
SETNR    EQU   *                                                        43800016
         AIF   ('&LIB' NE 'LIB1').X301211                       XL03912 43850003
         DROP  GR6                                                      44000016
.X301211 ANOP                                                   XL03912 44050003
         BAL   GR8,WRITE               TELL OPERATOR TO REMOVE VOLUME.  44200016
         B     PRETURN                 POSTING COMPLETE.                44400016
         AIF   ('&LIB' NE 'LIB1').X301209                       XL03912 44450003
YES2321  L     GR11,0(GR11)            INPUT SUB-UCB ADDRESS.           44600016
         USING DATACELL,GR11                                            44800016
         NI    DCELSTAT,X'FF'-SRTEONLI  PUT THIS SUB-UCB OFF-LINE.      45000016
         XC    DCELVOLI-DATACELL(6,GR11),DCELVOLI-DATACELL(GR11)        45200016
*                                      CLEAR OUT NO. IN SUB-UCB.        45400016
.X301209 ANOP                                                   XL03912 45450003
SETNR1   MVC   42(12,GR1),OFFMSG       TELL ABOUT OFFLINE.              45600016
         MVI   1(GR1),WSIZE            SET SIZE IN MESSAGE.             45800016
         B     SETNR                   GO MAKE UCB NOT READY.           46000016
         AIF   ('&LIB' NE 'LIB1').X301210                       XL03912 46050003
         DROP  11                                                       46200016
         SPACE                                                          46400016
         USING UCB,3                                                    46600016
TESTSUB3 TM    DCELSTAT,SRTEONLI       THIS SUB-UCB ONLINE.             46800016
         BCR   8,GR7                   NO--GO MAKE MORE TESTS.          47000016
         USING UCB,6                                                    47400016
TESTSUB6 TM    DCELSTAT,SRTEONLI       THIS SUB-UCB ONLINE.             47600016
         BCR   8,GR7                   NO--GO MAKE MORE TESTS.          47800016
         B     TESTIDEN                YES-CONTINUE RETAIN TEST.        48000016
.X301210 ANOP                                                   XL03912 48010003
SETNR2   EQU  *                                                 YL02912 48052002
         MODESET EXTKEY=SUPR                                    YL02912 48060002
         NI    SRTESTAT,X'FF'-SRTEONLI NON-DEMOUNTABLE DEVICE OFF-LINE. 48100002
         MODESET EXTKEY=DATAMGT                                         48120002
         B     SETNR1                  GO TELL THE USER.                48150016
         AIF   ('&LIB' NE 'LIB1').X301212                       XL03912 48160003
         DROP  3,6                                                      48200016
.X301212 ANOP                                                   XL03912 48250003
         EJECT                                                          48400016
*   COMPLETE MESSAGE IEH809 HERE.                                       48600016
SETUPMSG EQU   *                                                        48800016
         GETMAIN R,LV=4+WSIZE,SP=229   GET WORK AREA.          @ZA07401 49000000
         XC    0(WSIZE,GR1),0(GR1)     CLEAR MESSAGE AREA.              49200016
         MVI   1(GR1),WSIZE1           SET SIZE IN MESSAGE.             49400016
         MVC   4(10,GR1),WTOLIST       MESSAGE IDENTIFIER.              49600016
         LR    GR15,GR6                SAVE UCB REG.               O122 49700019
         USING UCB,GR6                                                  49800016
         AIF   ('&LIB' NE 'LIB1').X301213                       XL03912 49850003
         CLI   UCBID,MAINUCB           THIS A MAIN UCB.                 50000016
         BNE   FINDMAIN                NO--MUST BE 2321.                50200016
.X301213 ANOP                                                   XL03912 50250003
         LR    GR10,GR1                MESSAGE AREA ADDRESS.            50400016
SETNAME  MVC   14(3,GR10),UCBNAME      DEVICE ADDRESS TO MESSAGE.       50600016
         DROP  GR6                                                      50800016
         LR    GR6,GR15                RESTORE UCB REG.            O122 50900019
         MVI   17(GR1),COMMA           INSERT COMMA IN MESSAGE.         51000016
         MODESET EXTKEY=SUPR           ALLOW FETCH OF VOLSER     YM4604 51050002
         MVC   18(6,GR1),0(GR4)        SERIAL NO. TO MESSAGE.           51200016
         MODESET EXTKEY=DATAMGT        RESET MODE FOR DATAMGT    YM4604 51250002
         MVI   24(GR1),COMMA           INSERT COMMA IN MESSAGE.         51400016
         LR    GR15,GR7                SAVE BR AND LINK REG.       O122 51500019
         L     GR7,CVTPTR              CVT ADDRESS.                     51600016
         USING CVT,GR7                                                  51800016
         L     GR7,CVTTCBP             CVT DOUBLE WORD ADDRESS.         52000016
         DROP  7                                                        52200016
         L     GR7,4(GR7)              TCB ADDRESS.                     52400016
         L     GR7,12(GR7)             TIOT ADDRESS.                    52600016
         USING TIOT,GR7                                                 52800016
         MVC   25(8,GR1),TIOCNJOB      JOB NAME TO MESSAGE.             53000016
         MVI   33(GR1),COMMA           INSERT COMMA IN MESSAGE.         53200016
         MVC   34(8,GR1),TIOCSTEP      STEP-PROC NAME TO MSG.  @ZA24230 53400099
         CLI   TIOCSTEP+8,X'40'        WAS THE PREV STEPNAME.  @ZA24230 53410099
         BE    NOPSTEP                 YES SKIP PROCSTEP HANDL.@ZA24230 53420099
         MVI   42(GR1),COMMA           INSERT COMMA IN MESSAGE.@ZA24230 53430099
         MVC   42(8,GR1),TIOCSTEP+8    INSERT STEPNAME IN MSG. @ZA24230 53440099
NOPSTEP  EQU   *                                               ZA24230 53450099
         LR    GR7,GR15                RESTORE BR AND LINK REG.    O122 53500019
         BR    GR8                     RETURN                           53600016
         DROP  7                                                        53800016
         AIF   ('&LIB' NE 'LIB1').X301214                       XL03912 53850003
         EJECT                                                          53900019
         SPACE                                                          54000016
FINDMAIN MVI   17(GR1),SLASH           BIN SEPARATOR.                   54200016
         MVC   18(1,GR1),1(GR3)        BIN NO. TO MESSAGE.              54400016
         OI    18(GR1),X'F0'           SET ZONE BITS.                   54600016
         BAL   GR14,CONV2321           CONVERT SUB TO MAIN UCB ADDRESS. 54800016
         LR    GR10,GR1                MESSAGE AREA ADDRESS.            55000016
         LA    GR1,2(GR1)              RESET 'MOVE TO' POINTER.         55200016
         B     SETNAME                 COMPLETE THE MESSAGE.            55400016
         SPACE                                                          55600016
CONV2321 LH    GR10,0(GR6)             PICK UP BIN NO.                  55800016
         SLA   GR10,4                  TIMES SIXTEEN.                   56000016
         LA    GR10,DATACELL-UCBOB(GR10) ADD LENGTH OF MAIN.            56200016
         LCR   GR10,GR10               NEGATE.                          56400016
         AR    GR6,GR10                ADDRESS OF MAIN.                 56600016
         BR    GR14                    RETURN.                          56800016
.X301214 ANOP                                                   XL03912 56850003
         EJECT                                                          57000016
WRITE    EQU   *                                                        57200016
         SR    GR1,GR1                 CLEAR REG 1             @ZA07401 57250000
         IC    GR1,1(GR10)             GET L'MSG FOR WTO       @ZA07401 57300000
         AR    GR1,GR10                ADD A(WTOLIST),=END MSG @ZA07401 57350000
         MVC   0(4,GR1),ROUTECD        SET ROUTE & DESC CODE=4 @ZA07401 57360000
         OI    2(GR10),X'80'           SET MCS BIT ON          @ZA07401 57370000
         LR    GR1,GR10                MESSAGE ADDRESS.                 57400016
         WTO   ,MF=(E,(1))                                     @ZA07401 57600000
         LR    GR1,GR10                RESTORE ADDRESS OF GETMAIN AREA. 57800016
         FREEMAIN R,LV=4+WSIZE,A=(1),SP=229                    @ZA07401 58000000
         BR    GR8                     RETURN.                          58200016
         SPACE 2                                                        58400016
UCBLAST  DC    X'FFFF'                 LAST ENTRY IN UCB POINTER TABLE. 58600016
OFFMSG   DC    C',NOW OFFLINE'         2321 MESSAGE COMPLETION.         58800016
         SPACE 2                                                        59000016
WTOLIST  DC    C'IEH809I   '           MESSAGE IDENTIFIER.              59200016
ROUTECD  DC    X'10001000'             ROUTE AND DESC CODE=4   @ZA07401 59210000
MAINT    DS    10F                     MAINTENANCE AREA         XL02912 59250002
BITMASK  DC    X'0000FFFF'             ZEROS LEFT HALF OF REG  @30AAAG  59260003
         EJECT                                                          59300019
         SPACE                                                          59400016
TIOT     DSECT                                                          59600016
TIOCNJOB DS    CL8                     JOB NAME                         59800016
TIOCSTEP DS    CL16                    STEP OR PROCEDURE NAME.          60000016
DEB      DSECT                                                          60200016
DEBNMSUB DS    CL1                     OPEN SUBROUTINES.                60400016
DEBTCBAD DS    CL3                     TCB ADDRESS.                     60600016
DEBAMLNG DS    CL1                     LENGTH ACCESS METHOD.            60800016
DEBDEBAD DS    CL3                     NEXT DEB ADDRESS.                61000016
DEBOFLGS DS    CL1                     DATA SET FLAGS.                  61200016
DEBIRBAD DS    CL3                     IRB ADDRESS.                     61400016
DEBOPATB DS    CL1                     TYPE OF I/O.                     61600016
DEBSYSPG DS    CL3                     IOB PURGE ADDRESS.(SYSTEM)       61800016
DEBNMEXT DS    CL1                     NO. OF EXTENTS.                  62000016
DEBUSRPG DS    CL3                     IOB USER PURGE ADDRESS.          62200016
DEBPRIOR DS    CL1                     ZERO                             62400016
DEBECBAD DS    CL3                     PURGE ECB.                       62600016
DEBDEBID DS    CL1                     PROTECT KEY//ID.                 62800016
DEBDCBAD DS    CL3                     DCB ADDRESS.                     63000016
DEBEXSCL DS    CL1                     EXTENT SCALE.                    63200016
DEBAPPAD DS    CL3                     APPENDAGE VECTOR TABLE.          63400016
DEBDVMOD DS    CL1                     FILE MASK.                       63600016
DEBUCBAD DS    CL3                     UCB ADDRESS.                     63800016
DEBBINNO DS    CL2                     BIN NO. FOR 2321.                64000016
DEBSTRCC DS    CL2                     CYLINDER START.                  64200016
DEBSTRHH DS    CL2                     HEAD START.                      64400016
DEBENDCC DS    CL2                     CYLINDER END.                    64600016
DEBENDHH DS    CL2                     HEAD END.                        64800016
DEBNMTRK DS    CL2                     NUMBER OF TRACKS.                65000016
         DS    CL20                                                     65200016
DEBEND   DS    0C                      END OF DEB.                      65400016
         EJECT                                                          65409002
*********************************************************************** 65418002
*                                                                     * 65427002
*   PARAMETER LIST DSECT                                              * 65436002
*                                                                     * 65445002
*********************************************************************** 65454002
         SPACE 2                                                        65463002
PARMLIST DSECT                                                  YL02912 65472002
FUNCTION DS    0F                       CALLER'S FUNCTION.      YL02912 65481002
UCBPTR   DS    F                        UCB POINTER.            YL02912 65490002
DCBPTR   DS    F                        DCB POINTER OR          YL02912 65499002
CCHHPARM EQU   DCBPTR                   ADDR OF TRACK OR        YL02912 65508002
SERPTR   EQU   DCBPTR                   ADDR OF VOL SER.        YL02912 65517002
ALTPTR   DS    F                        ADDR OF ALTINFO OR      YL02912 65526002
NEWCCHH  EQU   ALTPTR                   NEW TRACK ADDRESS.      YL02912 65535002
DEBPTR   DS    F                        DEB POINTER OR          YL02912 65544002
DEVMODP  EQU   DEBPTR                   ADDR OF 3340 MODEL NO.  YL02912 65553002
PRMPTR   DS    F                        ADDR OF CALLER'S LIST.  YL02912 65562002
KEY      EQU   PRMPTR                   KEY OF CALLER.          YL02912 65571002
VTOCCCHH DS    2F                      VTOC PTR.                 YM1129 65573002
IGCRESV  DS    2F                      RESERVED.                 YM1129 65575002
ENDLIST  EQU   *                        PARAMETER LIST END.     YL02912 65580002
         SPACE 2                                                        65589002
         EJECT                                                          65600016
UCB      DSECT                                                          65800016
         IEFUCBOB                                                       66000016
         EJECT                                                          66200016
CVT      DSECT                                                          66400016
         CVT   SYS=MIN                                                  66600016
         END                                                            66800016
./  ADD  SSI=70880155,NAME=IGC0308B
         TITLE 'IGC0308B --- ALTERNATE TRACK ASSIGNMENT FOR 2305'       00210021
         COPY  LCGASMSW                                          SM4351 00220021
IGC0308B CSECT                                                          00250021
*                                                                       00300003
*C 228000                           @SA74452=@YA09634=@XA09732=@ZA04363 00350003
*A 226500-227000,708500             @SA74452=@YA09634=@XA09732=@ZA04363 00360003
*                                                                       00370003
* STATUS - CHANGE LEVEL 000                                           * 00400020
*                                                                     * 00600020
* FUNCTION                                                            * 00800020
*     THIS LOAD OF SVC 82 PERFORMS ALTERNATE TRACK ASSIGNMENT FOR     * 01000020
*     EITHER OF TWO CASES ON A 2305 DEVICE                            * 01200020
*                                                                     * 01400020
*       1)VOLUMES IN THE INITIALIZATION PROCESS.                      * 01800020
*       2)PRE-INITIALIZED VOLUMES(THEY HAVE A FORMAT 4 DSCB).         * 02000020
*                                                                     * 02200020
*     IF THE SPECIFIED DEFECTIVE TRACK IS A PRIMARY TRACK, THE        * 02400020
*     DYNAMIC ALTERNATE IS ASSIGNED TO THE ORIGINAL PRIMARY TRACK.    * 02600020
*                                                                     * 02800020
*     IF THE SPECIFIED DEFECTIVE TRACK IS THE UNASSIGNED DYNAMIC      * 03000020
*     ALTERNATE, NO TRACK ASSIGNMENTS ARE MADE AND A RETURN CODE      * 03200002
*     OF 16 IS PASSED TO CALLING ROUTINE.                             * 03400020
*                                                                     * 03600020
* ENTRY POINT - IGC0308B IS THE ONLY ENTRY POINT.                     * 03800020
*                                                                     * 04000020
* INPUT - REGISTER 1 POINTS TO 3-FULL WORDS AS FOLLOWS:               * 04200020
*         WORD1 - INPUT PARM LIST POINTER PASSED TO IGC0008B.         * 04400020
*         WORD2 - WORK AREA ADDRESS(DESCRIBED BY IOBLOCKS DESECT).    * 04600020
*         WORD3 - POINTER TO SVRB EXTENDED SAVE AREA.                 * 04800002
*                                                                     * 05000020
* EXITS                                                               * 05200020
*     NORMAL - THE SECOND WORD OF THE INPUT PARM LIST CONTAINS THE    * 05400020
*              CCHH OF THE ASSIGNED ALTERNATE TRACK, IF ANY.  IF NO   * 05600020
*              ALTERNATE WAS ASSIGNED, THE SECOND WORD CONTAINS ZEROES* 05800020
*              WITH A RETURN CODE OF ZERO(IN EITHER CASE).            * 06000020
*              SIX BYTES OF THE ALTERNATE TRACK INFORMATION ARE       * 06200020
*              UPDATED(EITHER IN FORMAT 4 DSCB OR POINTED TO BY THE   * 06400020
*              PARM LIST).                                            * 06600020
*                                                                     * 06800020
*     ERROR - RETURN CODE OF 12 IF I/O ERROR WAS ENCOUNTERED.         * 07000020
*             RETURN COE OF 16 IF DYNMAIC ALTERNATE HAS BEEN          * 07200020
*             USED OR IS DEFECTED.                                    * 07400020
*                                                                     * 07600020
* SUPERVISOR MACROS - EXCP,WAIT,FREEMAIN.                             * 07800020
*                                                                     * 08000020
* WORKAREA/TABLES - USES THE WORK AREA DESCRIBED BY DSECT IOBLOCKS.   * 08200020
*                                                                     * 08400020
* OUTPUT - SEE EXITS DESCRIPTION.                                     * 08600002
*                                                                     * 08800020
* ATTRIBUTES - REENTRANT, RELOCATABLE, PRIVILEGED,ENABLED.            * 09000020
*                                                                     * 09050002
*********************************************************************** 09100002
         EJECT                                                          09200020
*********************************************************************** 09400020
*                                                                     * 09600020
*     REGISTER ASSIGNMENTS.                                           * 09800020
*                                                                     * 10000020
*********************************************************************** 10200020
         SPACE 1                                                        10400020
R0       EQU   0                                                        10600020
R1       EQU   1                                                        10800020
R2       EQU   2                                                        11000020
R3       EQU   3                                                        11200020
R4       EQU   4                                                        11400020
R5       EQU   5                                                        11600020
R6       EQU   7                                                        11800020
R7       EQU   8                                                        12000020
R8       EQU   8                                                        12200020
R9       EQU   9                                                        12400020
R10      EQU   10                                                       12600020
R11      EQU   11                                                       12800020
R14      EQU   14                                                       13000020
R15     EQU   15                                                        13200020
PARMPTR  EQU   1                                                        13400020
BASEREG  EQU   12                                                       13600020
         SPACE 1                                                        13800020
*********************************************************************** 14000020
*                                                                     * 14200020
*     EQUATE DEFINITIONS.                                             * 14400020
*                                                                     * 14600020
*********************************************************************** 14800020
         SPACE 1                                                        15000020
K0       EQU   0                       DISPLACEMENT CONSTANT.           15200020
K1       EQU   1                       DISPLACEMENT CONSTANT.           15400020
K2       EQU   2                       DISPLACEMENT CONSTANT.           15600020
K4       EQU   4                       DISPLACEMENT CONSTANT.           15800020
K5       EQU   5                       DISPLACEMENT                     16000020
K6       EQU   6                                                        16200020
K7       EQU   7                                                        16400020
K8       EQU   8                                                        16600020
K12      EQU   12                                                       16800020
K16      EQU   16                                                       17000020
K36      EQU   36                      DISPLACEMENT CONSTANT.   YL02919 17050002
K44      EQU   44                                                       17200020
ONE      EQU   1                                                        17400020
CODERO   EQU   X'16'                   READ R0  OP CODE                 17600020
FLAGS    EQU   X'42'                   FLAGS FOR IOBLOCK.               17800020
NULL     EQU   X'00'                   CODE FOR ANALYZE/FORMAT FUNCTION 18000020
OPCODE   EQU   X'06'                   READ DATA OP CODE.               18200020
SOPCODE  EQU   X'31'                   SEARCH ID EQU OP CODE.           18400020
ROPCODE  EQU   X'1A'                   READ HA OP CODE.                 18600020
WOPCODE  EQU   X'15'                   WRITE RECORD R0 OP CODE.         18800020
WRTCD    EQU   X'05'                   WRITE DATA OP CODE.              19000020
RDCD     EQU   X'19'                   WRITE HOME ADDRESS OP CODE.      19200020
RBEXSAVE EQU   96                      EXTENTED SAVE AREA OF SVRB.      19400020
LAST     EQU   X'80'                   LAST PARAMETER INDICATOR.        19600020
GOOD     EQU   X'7F'                   I/O GOOD COMPLETION BIT.         19800020
COMPLETE EQU   X'40'                   I/O COMPLETION BIT.              20000020
SKIP     EQU   X'10'                   SKIP DATA TRANSFER.              20200020
CHAIN    EQU   X'40'                   COMMAND CHAIN CCWS.              20600020
SILI     EQU   X'20'                   SUPPRESS INCORRECT LENGTH.       20800020
ALT      EQU   X'01'                   ALTERNATE TRACK FLAG.            21000020
DEFECT   EQU   X'02'                   DEFECTIVE TRACK FLAG.            21200020
MOVEHA   EQU    X'40'                   MOVE HA DOWN THE TRACK.         21400020
UE       EQU   X'01'                   UNIT EXCEPTION.                  21600020
XFF      EQU   X'FF'                   HEX FF                           21800020
FMT4LNTH EQU   96                      FORMAT 4 DATA LENGTH.     YM4604 21850002
         EJECT                                                          22000020
         LR    BASEREG,R15             ESTABLISH ADDRESSING.            22200020
         USING IGC0308B,BASEREG                                         22400020
         USING PARMLIST,R11                                     YL02912 22500002
         SPACE                                                          22600020
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04363 22650003
         DC    C'IGC0308B OZ04363'     LAST FIX THIS MOD       @ZA04363 22700003
APARNO   L     R11,K0(R1)              PARM LIST POINTER.      @ZA04363 22800003
         L     R2,K4(R1)               WORKAREA ADDRESS.                23000020
         L     R5,K8(R1)               SVRB EXTENDED AREA.              23200020
         SPACE 2                                                        23400020
*********************************************************************** 23600020
*                                                                     * 23800020
*   INITIALIZE THE IOB.                                               * 24000020
*                                                                     * 24200020
*********************************************************************** 24400020
         SPACE 2                                                        24600020
         USING IOBLOCKS,R2                                              24800020
INITIOB  EQU   *                                                        25000020
         MVI   IOBFLAG1,FLAGS          SET PROPER FLAGS.                25200020
         LA    R3,ECB                  ECB ADDRESS.                     25400020
         ST    R3,IOBECBAD             STORE IN IOB.                    25600020
         MVI   IOBINCAM+ONE,ONE        BLOCK COUNT.                     25800020
         LA    R3,DCB-K44              DCB ADDRESS.                     26000020
         ST    R3,IOBDCBPT             STORE IN IOB.                    26200020
FUNCTEST EQU   *                                                        26400020
         CLI   FUNCTION,NULL            ANALYZE/FORMAT REQUEST? YL02912 26600002
         BE    ASSGN                   YES--GO HANDLE.                  26800020
         SPACE 1                                                        27000020
*   BUILD CCWS FOR READING FORMAT 4 DSCB HERE.                          27200020
         USING IOBLOCKS,R2                                              27400020
FORM4    EQU   *                                                        27600020
         LA    R3,FORMAT4              FORMAT 4 READ-IN AREA.           27800020
         ST    R3,WRTRD                STORE IN READ-DATA CCW.          28000020
         MVI   WRTRD,OPCODE             SET OP CODE.                    28200020
         MVI   WRTRD+K7,FMT4LNTH       SET COUNT.                YM4604 28400002
         LA    R3,SEARCH               SEARCH CCW ADDRESS.              28600020
         ST    R3,TIC                  STORE IN TIC.                    28800020
         MVI   TIC,K8                  SET TIC OP CODE.                 29000020
         LA    R3,CCHHR                SEARCH ADDRESS.                  29200020
         ST    R3,SEARCH               STORE IN SEARCH CCW.             29400020
         MVI   SEARCH+K4,COMPLETE      COMMAND CHAIN ON.                29600020
         MVI   SEARCH+K7,K5            SET COUNT.                       29800020
         MVI   SEARCH,SOPCODE          SET SEARCH OP CODE.              30000020
         LA    R3,SEARCH               SEARCH CCW ADDRESS.              30200020
         ST    R3,IOBSTART             SET IN IOB.                      30400020
         SPACE                                                          30600020
*   STORE CCHHR OF VTOC IN IOB HERE.                                    30800020
         L     R3,UCBPTR                GET UCB ADDRESS.        YL02912 31000002
         USING UCB,R3                                                   31200020
         L     R0,SRTEFSCT             TTR OF VTOC.                     31400020
         SPACE                                                          31600020
FINDCCHH EQU   *                                                        31800020
         LA    R3,RBEXSAVE(R5)         EXTENTED SVRB SAVE AREA.         32000020
         L     R10,K36(R3)             SAVE RETURN ADDRESS.     YL02912 32050002
         MODESET   EXTKEY=SUPR                                  YL02912 32100002
         STM   R1,BASEREG,K0(R3)       SAVE THE REGISTERS.              32200020
         MODESET   EXTKEY=DATAMGT                               YL02912 32250002
         USING CVT,R15                                                  32400020
         L     R15,CVTPTR              CVT ADDRESS.                     32600020
         L     R15,CVTPCNVT            CONVERT ROUTINE ADDRESS.         32800020
         DROP  R15                                                      33000020
         LA    R1,DEB                  ADDDRESS OF DEB.                 33200020
         LA    R2,IOBSEEK              TARGET AREA FOR MBBCCHHR.        33400020
         BALR  R14,R15                 CONVERT TTR TO MBBCCHHR.         33600020
         LM    R1,BASEREG,K0(R3)       RESTORE THE REGISTERS.           33800020
         SPACE                                                          34000020
*   READ IN THE FORMAT 4 DSCB HERE.                                   * 34200020
         SPACE                                                          34400020
         BAL   R9,WRTREAD              READ IN FORMAT4 DSCB DATA FIELD. 34600020
         BAL   R9,WAIT                 AWAIT COMPLETION.                34800020
         MVC   ALTINFO(K6),ALTDATA     CCHH NEXT ALT. AND COUNT LEFT.   35000020
         SPACE                                                          35200020
ASSG1    EQU   *                                                        35400020
         CLC   ALTINFO+K4(K2),ZERO     ANY ALTERNATES LEFT.             35600020
         BNE   WRTPRIM                 YES-                             35800020
EXIT16   EQU   *                                                        36000020
         BAL   R9,FREECORE             FREE THE WORK AREA.              36200020
         LA    R15,K16                 SET RETURN CODE.                 36400020
         B     RETURN                  RETURN TO CALLER.        YL02912 36600002
         EJECT                                                          36650002
*********************************************************************** 37200020
*                                                                     * 37400020
*   WRITE HOME ADDRESS/RECORD ZERO ON THE PRIMARY TRACK HERE.         * 37600020
*                                                                     * 37800020
*********************************************************************** 38000020
WRTPRIM  EQU   *                                                        38200020
         L     R3,CCHHPARM              CCHH OF BAD PRIMARY.    YL02912 38400002
         ST    R3,R0COUNT              TEMPORARY STORAGE                38600020
         MVC   CCHHR(K4),R0COUNT       PRIMARY CCHH TO IOB.             38800020
         MVC   HA+K1(K4),R0COUNT       SET IN CCHH OF HA.               39000020
         MVI   HA,DEFECT               SET FLAG IN HA.                  39200020
         LA    R4,HA                   WRITE-OUT AREA.                  39400020
         ST    R4,WRTHA                STORE IN CCW.                    39600020
         MVI   WRTHA,RDCD              SET OP CODE.                     39800020
         NI    WRTHA+K4,XFF-CHAIN      SET CHAIN BIT OFF                40000020
         MVI   WRTHA+K7,K5             SET COUNT IN CCW.                40200020
         LA    R4,R0COUNT              COUNT FIELD ADDRESS.             40400020
         ST    R4,WRTR0                STORE IN CCW.                    40600020
         MVI   WRTR0,WOPCODE           RESET OP CODE.                   40800020
         NI    WRTR0+K4,XFF-CHAIN      SET CHAIN BIT OFF                41000020
         LA    R4,WRTHA                CHANNEL PROGRAM START.           41200020
         ST    R4,IOBSTART             STORE IN IOB.                    41400020
         BAL   R9,WRTREAD              WRITE HA/R0 ON PRIMARY.          41600020
         BAL   R9,WAIT                 AWAIT COMPLETION.                41800020
         L     R4,PRMPTR                GET CALLER'S PARM PTR.  YL02912 42040002
         L     R9,ALTINFO              GET ALT TRK INFO.         YM4604 42050002
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.        YM4604 42100002
         ST    R9,K4(R4)               PUT ALT INFO IN USER LIST.YM4604 42150002
         MODESET EXTKEY=DATAMGT                                  YM4604 42160002
         EJECT                                                          42200020
*********************************************************************** 42400020
*                                                                     * 42600020
*   WRITE HOME ADDRESS/RECORD ZERO ON THE ALTERNATE TRACK HERE.       * 42800020
*                                                                     * 43000020
*********************************************************************** 43200020
         SPACE 1                                                        43400020
WRTALT   EQU   *                                                        43600020
         LA    R4,WRTR0                ADDR OF START OF CHAN PROG.      43800020
         ST    R4,IOBSTART             STORE IN IOB                     44000020
         ST    R3,R0COUNT              PRIMARY CCHH TO RECORD ZERO.     44200020
         MVI   R0COUNT+K7,K8           SET DATA LENGTH FOR EIGHT.       44400020
         MVI   WRTR0+K7,K16            SET CCW COUNT FOR 16.            44600020
         BAL   R9,WRTREAD              WRITE R0 ON ALTERNATE.           44800020
         BAL   R9,WAIT                 AWAIT COMPLETION.                45000020
         SPACE                                                          45200020
         XC    ALTINFO+K4(K2),ALTINFO+K4 CLEAR NO. OF ALT. TO ZERO.     45400020
         CLI   FUNCTION,NULL            FORMAT-ANALYZE REQUEST. YL02912 45600002
         BNE   UPFORMAT                NO--NEED TO UPDATE FORMAT4 DSCB. 45800020
         L     R4,ALTPTR                ADDR OF ALT INFO.        YM4604 46000002
         MODESET EXTKEY=SUPR                                     YM4604 46050002
         MVC   K0(K6,R4),ALTINFO       UPDATE ALTERNATE TRACK INFO.     46200020
         MODESET EXTKEY=DATAMGT                                  YM4604 46250002
         SPACE 3                                                        46400020
EXIT0    BAL   R9,FREECORE             FREE THE WORKAREA.               46600020
         LA    R15,0                   SET RETURN CODE.                 46800020
RETURN   EQU   *                                                YL02912 47000002
         L    R14,RBEXSAVE+K36(R5)     GET RETURN ADDRESS.      YL02912 47050002
         MODESET EXTKEY=SUPR                                    YM1315  47060002
         BR   R14                      RETURN TO CALLER.        YL02912 47100002
         SPACE                                                          47150002
ASSGN    EQU   *                       SET UP ALTERNATE INFORMATION.    47200020
         L     R4,ALTPTR                POINTER TO ALT INFO.     YM4604 47400002
         MODESET EXTKEY=SUPR                                     YM4604 47460002
         MVC   ALTINFO(K6),K0(R4)      SET UP ALTERNATE TRACK INFO.     47600020
         MODESET EXTKEY=DATAMGT                                  YM4604 47650002
         B     ASSG1                   GO PROCESS THIS TRACK.           47800020
         EJECT                                                          48000020
*********************************************************************** 48200020
*                                                                     * 48400020
*   UPDATE THE FORMAT 4 DSCB HERE.                                    * 48600020
*                                                                     * 48800020
*********************************************************************** 49000020
         SPACE 3                                                        49200020
UPFORMAT EQU   *                       UPDAYE THE FORMAT 4 DSCB HERE.   49400020
         MVC   ALTDATA(K6),ALTINFO     UPDATE ALTERNATE INFORMATION.    49600020
         LA    R3,SEARCH               CHANNEL PROGRAM ADDRESS.         49800020
         ST    R3,IOBSTART             STORE IN IOB.                    50000020
         MVI   WRTRD,WRTCD             SET OP CODE FOR WRITE.           50200020
         MVC   CCHHR(K4),VTOCCCHH      SEEK//SEARCH ADDRESS.            50400020
         BAL   R9,WRTREAD              WRITE OUT NEW FORMAT 4 DSCB DATA 50600020
         BAL   R9,WAIT                 AWAIT COMPLETION.                50800020
         MVI   WRTRD,OPCODE            SET OP CODE FOR READ.            51000020
         OI    WRTRD+K4,SKIP           SKIP DATA TRANSFER.              51200020
         BAL   R9,WRTREAD              READ BACK CHECK DATA.            51400020
         BAL   R9,WAIT                 AWAIT COMPLETION.                51600020
         B     EXIT0                   GO RETURN TO CALLER.             51800020
         SPACE                                                          52000020
*********************************************************************** 52200020
*                                                                     * 52400020
*     EXECUTE CHANNEL PROGRAM                                         * 52600020
*                                                                     * 52800020
*********************************************************************** 53000020
         SPACE                                                          53200020
WRTREAD  EXCP  IOB                     START THE I/O OPERATION.         53400020
         BR    R9                      RETURN.                          53600020
WAIT     TM    ECB,COMPLETE            THIS OPERATION COMPLETE.         53800020
         BO    TEST                    YES-TEST ITS STATUS.             54000020
         WAIT  ECB=ECB                 NO--AWAIT COMPLETION.            54200020
TEST     CLI   ECB,GOOD                EVERYTHING A-OK.                 54400020
         BCR   K8,R9                   YES-RETURN.                      54600020
IOERR    EQU   *                                                        54800020
         BAL   R9,FREECORE             GO FREE STORAGE.         YL02912 54850002
         LA    R15,K12                 SET RETURN CODE.                 55000020
         B     RETURN                  EXIT.*                           55200002
         SPACE 3                                                        55400020
FREECORE EQU   *                       RELEASE THE CORE HERE.           55600020
         LH    R3,SIZE                 SIZE OF AREA TO RELEASE.         55800020
         FREEMAIN R,LV=(3),A=(2),SP=229                         YL02912 56000002
         LA    R2,ENDLIST-PARMLIST      GET PARM LIST SIZE      YL02912 56060002
         FREEMAIN R,LV=(2),A=(11)       FREE PARM LIST          YL02912 56120002
         BR    R9                      RETURN.                          56200020
         SPACE                                                          56400020
         SPACE 3                                                        56600020
F1       DC    F'1'                    TRACK INCREMENT CONSTANT.        56800020
ZERO     DC    1H'0'                   COMPARE CONSTANT.                57000020
MAINT    DS    40X                     ZAP FIX AREA.            YL02912 57000402
         EJECT                                                          57002002
*********************************************************************** 57009002
*                                                                     * 57018002
*   PARAMETER LIST DSECT                                              * 57027002
*                                                                     * 57036002
*********************************************************************** 57045002
         SPACE 2                                                        57054002
PARMLIST DSECT                                                  YL02912 57063002
FUNCTION DS    0F                       CALLER'S FUNCTION.      YL02912 57072002
UCBPTR   DS    F                        UCB POINTER.            YL02912 57081002
DCBPTR   DS    F                        DCB POINTER OR          YL02912 57090002
CCHHPARM EQU   DCBPTR                   ADDR OF TRACK OR        YL02912 57099002
SERPTR   EQU   DCBPTR                   ADDR OF VOL SER.        YL02912 57108002
ALTPTR   DS    F                        ADDR OF ALTINFO OR      YL02912 57117002
NEWCCHH  EQU   ALTPTR                   NEW TRACK ADDRESS.      YL02912 57126002
DEBPTR   DS    F                        DEB POINTER OR          YL02912 57135002
DEVMODP  EQU   DEBPTR                   ADDR OF 3340 MODEL NO.  YL02912 57144002
PRMPTR   DS    F                        ADDR OF CALLER'S LIST.  YL02912 57153002
KEY      EQU   PRMPTR                   KEY OF CALLER.          YL02912 57162002
IGCRESV  DS    4F                      RESERVED.                 YM1129 57164002
ENDLIST  EQU   *                        PARAMETER LIST END.     YL02912 57171002
         SPACE 2                                                        57180002
         EJECT                                                          57200020
IOBLOCKS DSECT                                                          57400020
MYDEB    EQU   *                       DEB DEFINITION.                  57600020
DEBEOEA  DS    1F                      END-OF-EXTENT.                   57800020
DEBSIOA  DS    1F                      START I/O.                       58000020
DEBPCIA  DS    1F                      PCI.                             58200020
DEBCEA   DS    1F                      CHANNEL END.                     58400020
DEBXCEA  DS    1F                      ABNORMAL END.                    58600020
         DS    CL12                                                     58800020
DEBLNGTH DS    CL1                     DEB LENGTH(DOUBLE WORDS)         59000020
         DS    CL3                                                      59200020
DEB      EQU   *                       DEB PROPER                       59400020
DEBNMSUB DS    CL1                     OPEN SUBROUTINES.                59600020
DEBTCBAD DS    CL3                     TCB ADDRESS.                     59800020
DEBAMLNG DS    CL1                     LENGTH ACCESS METHOD.            60000020
DEBDEBAD DS    CL3                     NEXT DEB ADDRESS.                60200020
DEBOFLGS DS    CL1                     DATA SET FLAGS.                  60400020
DEBIRBAD DS    CL3                     IRB ADDRESS.                     60600020
DEBOPATB DS    CL1                     TYPE OF I/O.                     60800020
DEBSYSPG DS    CL3                     IOB PURGE ADDRESS.(SYSTEM)       61000020
DEBNMEXT DS    CL1                     NO. OF EXTENTS.                  61200020
DEBUSRPG DS    CL3                     IOB USER PURGE ADDRESS.          61400020
DEBPRIOR DS    CL1                     ZERO                             61600020
DEBECBAD DS    CL3                     PURGE ECB.                       61800020
DEBDEBID DS    CL1                     PROTECT KEY//ID.                 62000020
DEBDCBAD DS    CL3                     DCB ADDRESS.                     62200020
DEBEXSCL DS    CL1                     EXTENT SCALE.                    62400020
DEBAPPAD DS    CL3                     APPENDAGE VECTOR TABLE.          62600020
DEBDVMOD DS    CL1                     FILE MASK.                       62800020
DEBUCBAD DS    CL3                     UCB ADDRESS.                     63000020
DEBBINNO DS    CL2                     BIN NO. FOR 2321.                63200020
DEBSTRCC DS    CL2                     CYLINDER START.                  63400020
DEBSTRHH DS    CL2                     HEAD START.                      63600020
DEBENDCC DS    CL2                     CYLINDER END.                    63800020
DEBENDHH DS    CL2                     HEAD END.                        64000020
DEBNMTRK DS    CL2                     NUMBER OF TRACKS.                64200020
         DS    CL20                                                     64400020
DEBEND   DS    0C                      END OF DEB.                      64600020
         EJECT                                                          64800020
ECB      DS    1F                      ECB HERE.                        65000020
IOB      EQU   *                       IOB HERE.                        65200020
IOBFLAG1 DS    CL1                     FLAG1                            65400020
IOBFLAG2 DS    CL1                     FLAG2.                           65600020
IOBSENS0 DS    CL1                     SENSE BYTE ZERO.                 65800020
IOBSENS1 DS    CL1                     SENSE BYTE ONE.                  66000020
IOBECBAD DS    CL4                     ADDRESS OF ECB.                  66200020
IOBCSW   DS    CL8                     STATUS WORDS.                    66400020
IOBSTART DS    CL4                     CHANNEL PROGRAM ADDRESS.         66600020
IOBDCBPT DS    CL4                     ADDRESS OF DCB.                  66800020
IOBRESTR DS    CL4                     RESTART ADDRESS.                 67000020
IOBINCAM DS    CL2                     BLOCK COUNT.                     67200020
IOBERRCT DS    CL2                     ERROR COUNT.                     67400020
IOBSEEK  DS    CL8                     SEEK ADDRESS.                    67600020
CCHHR    EQU   IOBSEEK+3               SEARCH ADDRESS.                  67800020
DCB      DS    1F                      DEB ADDRESS.                     68000020
ALTINFO  DS    1D                      KEEP ALTERNATE TRACK INFO HERE.  68200020
WRTHA    DS    1D                      WRITE HOME ADDRESS.              68400020
WRTR0    DS    1D                      WRITE RECORD ZERO.               68600020
RDHA     DS    1D                      READ HOME ADDRESS.               68800020
READR0   DS    1D                      READ RECORD ZERO.                69000020
         AIF   ('&LIB' EQ 'LIB1').X227800                       XL03130 69050003
         DS    3D                       RESERVED.                YM6524 69100002
.X227800 ANOP                                                   XL03130 69160003
HA       DS    CL5                     HOME ADDRESS.                    69200020
SW       DS    CL1                     SWITCH.                          69400020
D2314    EQU   X'80'                   2314 DEVICE.                     69600020
D2321    EQU   X'40'                   2321 DEVICE.                     69800020
DEFALT   EQU   X'02'                                               1057 70000020
RETRY    EQU   X'01'                   GIVE IT ONE MORE TRY.            70200020
SIZE     DS    CL2                     SIZE OF GETMAIN AREA.            70400020
R0COUNT  DS    1D                      RECORD ZERO COUNT FIELD.         70600020
R0DATA   DS    1D                      RECORD ZERO DATA  FIELD.         70800020
RETSW    DS    CL1                     RETRY SW USED IN 108B   @ZA04363 70850003
IOEND1   DS    0C                      END OF BASIC I/O BLOCKS.         71000020
*   EXTENSION FOR GETALT//DYNAMIC TRACK REQUEST.                        71200020
SEARCH   DS    1D                      SEARCH CCW.                      71400020
TIC      DS    1D                      REPEAT UNTIL FOUND.              71600020
WRTRD    DS    1D                      WRITE OR READ DATA.              71800020
FORMAT4  DS    CL96                    FORMAT4 DSCB READ IN AREA.       72000020
ALTDATA  EQU   FORMAT4+8               ALTERNATE TRACK INFORMATION.     72200020
VTOCCCHH EQU   FORMAT4+63              CCHH START OF VTOC.              72400020
IOEND    DS    0C                                                       72600020
         EJECT                                                          72800020
UCB      DSECT                                                          73000020
         IEFUCBOB                                                       73200020
         EJECT                                                          73400020
CVT      DSECT                                                          73600020
         CVT   SYS=MIN                                                  73800020
         END                                                            74000020
./  ADD  SSI=70880156,NAME=IGG019P7
IGG019P7 CSECT                                                   M5431  00050000
*                                                                YM5022 00060002
*                                                                M5431* 00100000
*        RELEASE 4 DELETIONS                                     M5431* 00150000
*        RELEASE 3 DELETIONS                                     M5431* 00250000
*        RELEASE 2 DELETIONS                                     M5431* 00300000
*        RELEASE 1 DELETIONS                                     M5431* 00350000
*                                                                M5431* 00400000
*STATUS CHANGE LEVEL 001                                         M5431* 00500000
*                                                                M5431* 00550000
*FUNCTION/OPERATION- THIS IS THE PAGE FIX APPENDAGE FOR THE      M5431* 00600000
*   IEHDASDR SYSTEM UTILITY PROGRAM. IT FIXES THOSE UTILITY DATA M5431* 00650000
*   AREAS REFERENCED BY THE OTHER IEHDASDR APPENDAGES NOT        M5431* 00700000
*   OTHERWISE FIXED BY IOS UPON ENTRY TO THE APPENDAGES. THIS IS M5431* 00750000
*   DONE IN ORDER TO AVOID DISABLED PAGE EXCEPTIONS. THOSE AREAS M5431* 00800000
*   FIXED BY THIS APPENDAGE ARE;                                 M5431* 00850000
*                  (1) THE -FUNCTION- BLOCK FOR THE PARTICULAR   M5431* 00900000
*                      REQUEST IE -ANALYZE-,-DUMP-,-FORMAT-,     M5431* 00950000
*                      -LABEL-,-RESTORE-,GETALT-                 M5431* 01000000
*                  (2) THE I/O DEVICE CONSTANT BLOCK FOR THE DEVICE   * 01050000
*                      UPON WHICH I/O IS CURRENTLY BEING PERFORMED    * 01100000
*                                                                M5431* 01150000
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IGG019P7-.               M5431* 01200000
*                                                                M5431* 01250000
*INPUT- REGISTER 4 POINTS TO THE DCB.                            M5431* 01350000
*       REGISTER 10 POINTS TO THE WORK AREA IN WHICH THE -FIX-   M5431* 01450000
*                   LIST WILL BE PLACED.                         M5431* 01500000
*                                                                M5431* 01550000
*EXITS-NORMAL- RETURN TO IOS ON REGISTER 14.                     M5431* 01600000
*        REGISTER 11 CONTAINS THE NUMBER OF AREAS                M5431* 01610000
*                    TO BE FIXED                                 M5431* 01620000
*                                                                M5431* 01650000
*EXITS-ERROR- NONE.                                              M5431* 01700000
*                                                                M5431* 01750000
*EXTERNAL ROUTINES- THE APPENDAGE ROUTINE IS ALWAYS ENTERED FROM M5431* 01800000
*   IOS AND EXITS TO IOS WHERE THE PAGES ASSOCIATED WITH THE WORK     * 01850000
*   AREAS CITED ABOVE ARE FIXED.                                 M5431* 01900000
*                                                                M5431* 01950000
*TABLES/WORK AREAS- THE FORMAT OF THE LISTS OF ADDRESSES         M5431* 02000000
*   TO BE FIXED IS AS FOLLOWS;                                   M5431* 02100000
*                   WORD 1-FIRST POSISTION OF THE -FUNCTION-     M5431* 02150000
*                          BLOCK FOR THE UTILITY OPERATION       M5431* 02200000
*                   WORD 2-LAST POSISTION OF THE -FUNCTION-      M5431* 02260000
*                          BLOCK PLUS 1                          M5431* 02310000
*                   WORD 3-FIRST POSISTION OF THE I/O DEVICE     M5431* 02360000
*                          CONSTANT BLOCK                        M5431* 02410000
*                   WORD 4-LAST POSISTION OF THE I/O DEVICE      M5431* 02460000
*                          CONSTANT BLOCK PLUS 1                 M5431* 02510000
*                                                                M5431* 02560000
*ATTRIBUTES- REENTRANT, RELOCATABLE, NON-PRIVILEGED              M5431* 02610000
*                                                                M5431* 02660000
 TITLE    'IGG019P7-PAGE FIX APPENDAGE-IEHDASDR SYSTEM UTILITY'  M5431* 02670000
         EJECT                                                   M5431* 02710000
*                                                                M5431* 02760000
*     THE FOLLOWING ARE REGISTER ASSIGNMENTS                     M5431* 02810000
*                                                                M5431* 02860000
DCBREG   EQU   4                        DCB REGISTER             M5431  02960000
LISTREG  EQU   10                       POINTER TO AREA WHERE    M5431  03010000
*                                       FIX LIST TO BE BUILT     M5431  03020000
*                                            FIXED               M5431  03022000
GR11     EQU   11                       HOLDS NUMBER OF AREAS TO YM5022 03030002
*                                       BE BUILT                 M5431  03052000
GR13     EQU   13                       WORK REGISTER            M5431  03052800
RETREG   EQU   14                       RETURN REGISTER          M5431  03054000
BASEREG  EQU   15                       BASE REGISTER            M5431  03056000
*                                                                M5431* 03056100
         USING IGG019P7,BASEREG                                  M5431  03056400
         USING IHADCB,DCBREG                                     M5431  03106400
         EJECT                                                   M5431  03116400
*                                                                M5431* 03156400
*                                                                M5431* 03166400
*    THE FIRST FOUR BYTES OF THIS CSECT ARE NOT A PART OF THE    M5431* 03206400
*    PAGE FIX APPENDAGE. INSTEAD THEY CONTAIN A BRANCH INSTRUCTION    * 03256400
*    TO THE SIO APPENDAGE IF ONE EXISTS. SINCE THE IEHDASDR PROGRAM   * 03306400
*    DOES NOT HAVE AN SIO APPENDAGE A BRANCH INSTRUCTION IS USED M5431* 03356400
*    TO RETURN CONTROL BACK TO IOS THROUGH REGISTER 14. THIS     M5431* 03406400
*    CONDITION IS BROUGHT ABOUT BY THE FACT THAT THE SAME WORD IN     * 03456400
*    THE AVT TABLE IS EMPLOYED AS A POINTER TO BOTH THE SIO AND THE   * 03506400
*    PAGE FIX APPENDAGES. THE PAGE FIX APPENDAGE IS ASSUMED TO START  * 03556400
*    FOUR BYTES BEYOND THE DESIGNATED ENTRY POINT.               M5431* 03606400
*                                                                M5431* 03658400
*                                                                M5431* 03660400
ENTRY    EQU   *                                                 M5431  03666400
         B     0(RETREG)                RETURN TO IOS            M5431  03706400
*                                                                M5431* 03756400
*                                                                M5431* 03766400
         EJECT                                                          03806400
*                                                                M5431* 03856400
*                                                                M5431* 03866400
*    BEGINNING OF PAGE FIX APPENDAGE. THE FIRST AREA TO BE FIXED M5431* 03906400
*    IS THAT CONTAINING THE FUNCTION BLOCK FOR THE UTILITY OPERATION. * 03956400
*    THE BEGINNING LOCATION OF THE BLOCK IS FOUND IN AN OTHERWISE     * 04006400
*    UNUSED FIELD (FOR -EXCP- PROCESSING) IN THE DCB -THE 'DCBIOBAD'  * 04056400
*    FIELD. THE LAST-MOST POSISTION OF THE BLOCK IS A FUNCTION OF     * 04106400
*    THE TYPE OF UTILITY OPERATION ( IE A -DUMP-,-LABEL-,-FORMAT-     * 04156400
*    ETC REQUEST ). THE FUNCTION BLOCK CODE FROM WITHIN THE FUNCTION  * 04206400
*    BLOCK IS CONVERTED TO A POINTER TO THE APPROPRIATE ENTRY IN A    * 04256400
*    TABLE OF FUNCTION BLOCK SIZES. THE SIZE WHICH IS FOUND IS THEN   * 04306400
*    ADDED TO THE BEGINNING LOCATION OF THE BLOCK.               M5431* 04356400
*                                                                M5431* 04406400
*                                                                M5431* 04456400
         L     GR11,DCBIOBAD            LOAD FUNCTION BLOCK      YM5022 04506402
*                                       ADDRESS                  M5431  04508400
         USING PGFIXLST,LISTREG                                  M5431  04516400
         USING FUNCBLK,GR11                                      YM5022 04556402
         SR    GR13,GR13                CLEAR A REGISTER AND     M5431  04606400
         IC    GR13,FUNCSW              INSERT FUNCTION CODE     M5431  04656400
         SRL   GR13,DIVBY8              CONVERT CODE             M5431  04706400
*                                       TO POINTER VALUE         M5431  04716400
         LH    GR13,FBLKSIZE(GR13)      PICK UP PROPER FUNCT     M5431  04756400
*                                       BLK SIZE                 M5431  04766400
         ST    GR11,FBEGLOC             PUT 1ST FUNCTION BLOCK   YM5022 04806402
*                                       LOCATION IN FIX LIST     M5431  04856400
         LA    GR13,0(GR13,GR11)        CALCULATE UPPER FUNCT    YM5022 04906402
*                                       BLOCK LOCATION           M5431  04916400
         ST    GR13,FENDLOC             AND PUT IN FIX LIST      M5431  04956400
*                                                                M5431* 05006400
*                                                                M5431* 05056400
*    FIX THE AREA OCCUPIED BY THE DEVICE CHARACTERISTIC ENTRY FOR THE * 05106400
*    CURRENT I/O REQUEST.THE BEGINNING LOCATION OF THE ENTRY IS       * 05156400
*    FOUND WITHIN THE RELATED FUNCTION BLOCK. EACH ENTRY IS           * 05206400
*    34 HEXADECIMAL BYTES LONG.                                       * 05256400
*                                                                M5431* 05306400
*                                                                M5431* 05356400
         L     GR13,IODEVCON            GET THE START LOCATION   M5431  05406400
*                                       FOR THE ENTRY            M5431  05456400
         ST    GR13,IOBEGLOC            SAVE LOCATION IN         M5431  05506400
*                                       FIX LIST                 M5431  05516400
         LA    GR13,(KDEVSIZE)(GR13)    POINT TO LAST POSITION   M5431  05556400
         ST    GR13,IOENDLOC            SAVE IN FIX LIST         M5431  05606400
*                                                                M5431* 05656400
         DROP  11                                                YM5022 05666402
*                                                                M5431* 05706400
*    EXIT FROM PAGE FIX ROUTINE                                  M5431* 05756400
*                                                                M5431* 05806400
*                                                                M5431* 05856400
         LA    GR11,LISTSIZE            LOAD NUMB OF AREAS       YM5022 05906402
*                                       TO BE FIXED              M5431  05916400
         BR    RETREG                   EXIT APPENDAGE           M5431  05956400
         EJECT                                                          05966400
*                                                                M5431* 06006400
*                                                                M5431* 06056400
*    THE FOLLOWING TABLE IS USED IN THE CALCULATION OF THE       M5431* 06106400
*    FUNCTION BLOCK SIZE.EACH OF THE FOLLOWING                   M5431* 06156400
*    HALF-WORDS CONTAINS THE SIZE OF                             M5431* 06166400
*    THE INDICATED FUNCTION BLOCK                                M5431* 06176400
*                                                                M5431* 06206400
*                                                                M5431* 06256400
TABLE1   DC    S(DFUNSIZE)              -DUMP- FUNCTIOM          M5431  06306400
         DC    S(RFUNSIZE)              -RESTORE- FUNCTION       M5431  06356400
         DC    S(GFUNSIZE)              -GETALT- FUNCTION        M5431  06406400
         DC    S(LFUNSIZE)              -LABEL- FUNCTION         M5431  06456400
         DC    S(AFUNSIZE)              -ANALYZE- FUNCTION       M5431  06506400
         DC    S(FFUNSIZE)              -FORMAT- FUNCTION        M5431  06556400
         DC    S(IFUNSIZE)              -PUTIPL- FUNCTION        YM3011 06566400
FBLKSIZE EQU   TABLE1-L'TABLE1          PTR USED AS BASE FOR     M5431  06606400
*                                       FUNCTION TABLE           M5431  06606800
*                                                                M5431  06616400
*                                                                M5431  06666400
DIVBY8   EQU   3                        USED IN FINDING FUNCT    M5431  06716400
*                                       BLOCK SIZE               M5431  06776400
*                                                                M5431* 06816400
*                                                                M5431* 06866400
*    THE FOLLOWING DSECT DESCRIBES THE PAGE FIX LIST CONSTRUCTED M5431* 06916400
*    BY THIS MODULE                                              M5431* 06966400
*                                                                M5431* 07016400
*                                                                M5431* 07066400
PGFIXLST DSECT                                                   M5431  07116400
FBEGLOC  DS    F                        BEG LOC OF FUNC BLK      M5431  07166400
FENDLOC  DS    F                        END LOC OF FUNC BLK +1   M5431  07216400
IOBEGLOC DS    F                        BEG LOC OF I/O BLOCK     M5431  07266400
IOENDLOC DS    F                        END LOC OF I/O BLOCK     M5431  07316400
LISTEND  EQU   *                        TBL END MARKER           M5431  07416400
LISTSIZE EQU   (LISTEND-PGFIXLST)/8     NUMB OF ELEMENTS IN      M5431  07466400
*                                       FIX LIST                 M5431  07476400
         EJECT                                                          07516400
         DCBD  DSORG=PS                                          M5431  07566400
         EJECT                                                          07616400
         IEHDBLKS                                                M5431  07666400
*                                                                M5431  07716400
         END                                                            07766400
./  ADD  SSI=70880157,NAME=IGG019P8
         COPY  LCGASMSW                                                 00500000
IGG019P8 CSECT                                                          00550000
*                                                                       00560003
*C 330000,670000,690000             @YA09679=@SA74485=@XA10384=@ZA04411 00570003
*A 325500-326000,666000-669500      @YA09679=@SA74485=@XA10384=@ZA04411 00580003
*                                                                       00590003
*320020-322440                                                  VS01098 00600002
*                                                                       00610002
*D 516500-519000,519700-519900                                 @ZM33043 00620002
*D 510000,520000                    @SA69574=@YA04867=@XA05836=@ZA01207 00650002
*A 515500-519900                    @SA69574=@YA04867=@XA05836=@ZA01207 00660002
*                                                                       00670002
*0856                                                            Y01048 00700000
*                                                             OX02850   00750003
*        OY02647 FIX IS FLAGGED AS OX02850                    OY02647   00800003
*        SA65713 FIX IS FLAGGED AS OX02850                    SA65713   00850003
*                                                                     * 01000016
*1063                                                            M4971  01200020
*STATUS CHANGE LEVEL 001  VS2/2  (MVM)                          YL02912 01600002
*                                                                     * 02000016
*FUNCTION/OPERATION-  THIS ROUTINE MODIFIES THE EXTENT LIMITS IN      * 02500016
*   THE DATA EXTENT BLOCKS(DEBS) FOR ALL DIRECT ACCESS DEVICES        * 03000016
*   INVOLVED. THIS ALLOWS ACCESS TO THE ENTIRE VOLUME BY THE          * 03500016
*   NECESSARY I/O OPERATIONS. THE EXTENT LIMITS ARE SET FOR           * 04000016
*   MAXIMUM FOR THAT DEVICE FOR ALL FUNCTIONS EXCEPT ONE. THE         * 04500016
*   DEVICE THAT IS BEING DUMPED BY THE -DUMP- FUNCTION WILL HAVE      * 05000016
*   ITS END EXTENT INCREMENTED BY ONE FOR EACH TRACK. THIS IS         * 05500016
*   NECESSARY TO FORCE A FILE-PROTECT INTERRUPT BY THE READ-COUNT     * 06000016
*   MULTI-TRACK CHANNEL COMMANDS.  THIS ROUTINE ALSO SETS THE         * 06500016
*   PROPER FILE MASK IN THE DEB.                                      * 07000016
*                                                                     * 07500016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IGG019P8-.                    * 08000016
*                                                                     * 08500016
*INPUT-  REGISTER 1 POINTS TO THE REQUEST ELEMENT.                    * 09000016
*        REGISTER 2 POINTS TO THE IOB.                                * 09500016
*        REGISTER 3 POINTS TO THE DEB.                                * 10000016
*        REGISTER 4 POINTS TO THE DCB.                                * 10500016
*        REGISTER 6 POINTS TO A UCB-SEEK FIELD EQUIVALENT       YL02912 10550002
*        REGISTER 7 POINTS TO THE UCB                                 * 11000016
*        THE DCB+28 WILL CONTAIN A POINTER TO THE FUNCTION BLOCK      * 11500016
*                                                                     * 12000016
*EXITS-  TWO DIFFERENT EXITS ARE POSSIBLE.                            * 12500016
*   THE -DUMP- FUNCTION WILL RETURN ON REGISTER 14 PLUS 4. THIS WILL  * 13000016
*   POST THE CHANNEL PROGRAM COMPLETE.                                * 13500016
*   ALL OTHER FUNCTIONS WILL RETURN ON REGISTER 14 PLUS 8. THE        * 14000016
*   REQUEST WILL BE TRIED AGAIN.                                      * 14500016
*                                                                     * 15000016
*EXITS-ERROR-  NONE                                                   * 15500016
*                                                                     * 16000016
*EXTERNAL ROUTINE-  THE APPENDAGE ROUTINE IS ALWAYS ENTERED FROM IOS  * 16500016
*   AND EXITS TO IOS.                                                 * 17000016
*                                                                     * 17500016
*TABLES/WORKAREAS-  THIS ROUTINE USES THE DEVICE CONSTANTS FOR        * 18000016
*   A PARTICULAR DIRECT ACCESS DEVICE TO SET UP THE EXTENT LIMITS.    * 18500016
*   THE DEVICE CONSTANT TABLE IS ACCESSED BY MEANS OF A POINTER       * 19000016
*   IN THE FUNCTION BLOCK.                                            * 19500016
*                                                                     * 20000016
*ATTRIBUTES- REENTRANT, RELOCATABLE, NON-PRIVILEGED.                  * 20500016
*                                                                     * 21000016
 TITLE 'IGG019P8-END OF EXTENT APPENDAGE-IEHDASDR SYSTEM UTILITY'       21500016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             22000016
GR0      EQU   0                       REG ZERO                         22050000
GR1      EQU   1                       REQUEST ELEMENT POINTER.         22500016
GR2      EQU   2                       IOB POINTER.                     23000016
GR3      EQU   3                       DEB POINTER.                     23500016
GR4      EQU   4                       DCB POINTER.                     24000016
GR7      EQU   7                       UCB POINTER.                     24500016
GR9      EQU   9                       SAVE AREA FOR REG 0       YM3467 24550002
GR10     EQU   10                      FUNCTION BLOCK POINTER.          25000016
GR11     EQU   11                      DEVICE CONSTANT POINTER.         25500016
GR12     EQU   12                      WORK REGISTER.                   26000016
GR13     EQU   13                      WORK REGISTER.                   26050000
GR14     EQU   14                      RETURN REGISTER.                 26500016
GR15     EQU   15                      BASE REGISTER.                   27000016
COMPLT   EQU   X'7F'                   ECB COMPLETE VALUE     OX02850   27050003
L8       EQU   8                        OFFSET INTO SAVE AREA   YL02912 27050102
OVRFL    EQU   X'01'                   OVERFLOW INCOMPLETE    OX02850   27100003
GR6      EQU   6                        UCB SEEK EQUIVALENT     YL02912 27100102
         SPACE                                                          27500016
         USING IOB,GR2                                                  28000016
         USING DEB,GR3                                                  28500016
         USING IHADCB,GR4                                               29000016
         USING UCB,GR7                                                  29500016
         USING FUNCBLK,GR10                                             30000016
         USING IGG019P8,GR15                                            31000016
         USING CONSTANT,GR11                                            31050000
         EJECT                                                          31500016
ENTRY    EQU   *                       ENTRY POINT HERE.                32000016
         L     GR10,DCBIOBAD           FUNCTION BLOCK ADDRESS.          32500016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04411 32550003
         DC    C'IGG019P8 OZ04411'     LAST FIX THIS MOD       @ZA04411 32600003
APARNO   L     GR11,IODEVCON           ADR FOR DEV CONSTANTS.  @ZA04411 33000003
         USING CONSTANT,GR11                                     Y01048 33200000
         SPACE                                                          33500016
         CLI   CCHH,X'FF'              THIS A PARTIAL DUMP FUNCTION.    34000016
         BE    EXTENT3A                YES-SPECIAL CASE.                34500016
         SPACE                                                          35000016
         OC    DEBSTRCC(4),DEBSTRCC    IS THE LOWER DEB LIMIT ZERO.     35500016
         BZ    EXTENT0                 YES-THIS IS NOT FIRST ENTRY.     36000016
         SPACE                                                          36100003
         CLI   FUNCSW,DUMP             THIS A DUMP FUNCTION.            36700003
         BNE   EXTENT2                 NO--MUST BE 1 OF OTHER 5.        37300003
         SPACE                                                          38000016
         AIF   ('&LIB' EQ 'LIB2').NODC1 BRCH IF VS ASSEM        YL02912 38050002
         CLI   UCBTBYT4,X'05'          THIS A 2321.                     38500016
         BE    PROC2321                                                 39000016
         SPACE                                                          39500016
.NODC1   ANOP                                                   YL02912 39550002
         LA    GR7,0(GR7)              CLEAR HIGH ORDER BYTE.           40000016
         CL    GR7,FUCBPTR             THIS THE DUMP TO-DEVICE.         40500016
         BNE   EXTENT3                 NO--MUST BE DUMP FROM-DEVICE.    41000016
         SPACE                                                          41500016
EXTENT2  XC    DEBSTRCC(4),DEBSTRCC    SET LOWER LIMIT FOR ZERO.        42000016
         MVC   DEBENDCC(4),LASTALT     SET UPPER LIMIT FOR MAXIMUM.     42500016
         LH    GR12,TOTALPRM           PRIMARY TRACKS/THIS DEVICE.      43000016
         AH    GR12,TOTALALT           PLUS ALTERNATE TRACKS.           43500016
         SPACE                                                          44000016
EXT3     LA    GR14,8(GR14)            SET RETURN FOR REQUEST RETRY.    44500016
EXT4     STH   GR12,DEBNMTRK           TOTAL TRACKS IN EXTENT.          45000016
         MVI   DEBVMOD,X'D8'           SET FILE MASK FOR ALL WRITES,    45500016
*                                        NO SEEKS.                      46000016
         CLI   FUNCSW,ANALYSIS         THIS THE ANALYZE FUNCTION.       46500016
         BCR   4,GR14                  NO--RETURN TO IOS.               47000016
         MVI   DEBVMOD,X'C0'           YES-ALLOW FULL SEEKS.            47500016
         BR    GR14                    RETURN                           48000016
         SPACE                                                          48500016
EXTENT0  CLC   CCHH(4),DEBENDCC        DOES IOB TRACK ADDRESS EQUAL     49000016
*                                        UPPER LIMIT.                   49500016
         BNE   EXTENT1                 NO, GO UP EXTENTS, RETRY OX02850 50000003
         SPACE                                                          50500016
         LA    GR14,4(GR14)            TAKE POST EXIT         OX02850   51500003
         TM    IOBSENSE,X'08'          DATA CHECK?             @ZA01207 51550002
         BCR   8,GR14                  NO, TAKE POST EXIT      @ZA01207 51600002
POEXIT   NI    IOBCSW+4,X'FD'          TURN OF UNIT CHECK      @ZA01207 51950002
         BR    GR14                    TAKE POST EXIT          @ZA01207 51960002
         SPACE                                                          52500016
EXTENT1  MVC   DUMPWORK(4),DEBENDCC    ALIGN TO FULL WORD.              53000016
         L     GR12,DUMPWORK           CURRENT UPPER CCHH.              53500016
         SPACE                                                          54000016
         CLC   DEBENDHH+1(1),LASTORIG+3 THIS LAST TRACK OF CYLINDER.    54500016
         BC    4,EXT5                                                   55000016
         SPACE                                                          55500016
         A     GR12,CONVCYL            STEP TO NEXT CYLINDER.           56000016
         SPACE                                                          56500016
         CLI   DEBENDHH,X'04'          IS THIS 2321 AND LAST CYLINDER.  57000016
         BC    7,EXT6                  NO--GO RETURN.                   57500016
         SPACE                                                          58000016
         AL    GR12,STC2321            INCREMENT STRIP.                 58500016
         SPACE                                                          59000016
         CLI   DEBENDCC+1,X'09'        THIS THE LAST STRIP.             59500016
         BC    7,EXT6                  NO--RETURN.                      60000016
         SPACE                                                          60500016
         AL    GR12,SCC2321            INCREMENT SUBCELL.               61000016
         B     EXT6                    GO RETURN.                       61500016
         SPACE                                                          62000016
EXT5     AL    GR12,F1                 INCREMENT TO NEXT TRACK.         62500016
         SPACE                                                          63000016
EXT6     ST    GR12,DUMPWORK           TEMPORARY STORAGE.               63500016
         MVC   DEBENDCC(4),DUMPWORK    SET NEW UPPER LIMIT IN DEB.      64000016
         LH    GR12,DEBNMTRK           CURRENT TRACK COUNT IN EXTENT.   64500016
         LA    GR12,1(GR12)            INCREMENT BY ONE.                65000016
         B     EXT3                    GO RETURN.             OX02850   66000003
         SPACE                                                          66500016
EXTENT3A EQU   *                                                YL02912 66550002
         TM    RDVTOC,X'FF'            VTOC JUST READ?         @ZA04411 66600003
         BNO   EXTENT3B                NO THEN BRANCH          @ZA04411 66650003
         MVC   3(4,GR6),CCHHONE        CLEAR UCB SEEK ADR      @ZA04411 66700003
         MVC   CCHH(4),CCHHONE         CLEAR IOB SEEK ADR      @ZA04411 66750003
         XC    DEBSTRCC(4),DEBSTRCC    LOWER DEBLIMIT TO ZERO  @ZA04411 66800003
         MVC   DEBENDCC(4),CCHHONE     END LIMIT TO CURRENT TRK@ZA04411 66850003
         MVI   RDVTOC,X'00'            CLEAR JUST READ VTOC SW @ZA04411 66900003
         B     EXTENT3C                GO UPDTE TRK IN EXTENT  @ZA04411 66950003
EXTENT3B MVC   3(4,GR6),CCHHBEG        CLEAR UCB SEEK ADDRESS. @ZA04411 67000003
         MVC   CCHH(4),CCHHBEG         CLEAR IOB SEEK ADDRESS.          67500016
EXTENT3  XC    DEBSTRCC(4),DEBSTRCC    LOWER LIMIT IN DEB/TRACK ZERO.   68000016
         MVC   DEBENDCC(4),CCHHBEG     UPPER LIMIT IS FIRST TRACK/DUMP. 68500016
EXTENT3C LA    GR12,1                  TRACKS IN EXTENT.       @ZA04411 69000003
         B     EXT3                    GO TO RETURN.                    69500016
         SPACE                                                          70000016
         AIF   ('&LIB' EQ 'LIB2').NODC2 BRCH IF VS ASSEM        YL02912 70050002
PROC2321 LH    GR12,DCELBBNR           BIN NUMBER.                      70500016
         SLA   GR12,4                  TIMES SIXTEEN.                   71000016
         LA    GR12,DATACELL-UCB(GR12,GR7) SUBUCB ADDRESS.              71500016
         CL    GR12,FUCBPTR            THIS THE DUMP FROM DEVICE.       72000016
         BNE   EXTENT3                 NO-SET LIMITED EXTENTS.          72500016
         B     EXTENT2                 SET FULL EXTENTS.                73000016
         SPACE                                                          73500016
.NODC2   ANOP                                                   YL02912 73550002
F1       DC    F'1'                    CONSTANT OF ONE.                 74000016
ONE      EQU   F1                      ONE USED FOR APF          YM3012 74050000
SCC2321  DC    X'00F60000'             INCREMENT TO NEXT SUBCELL.       74500016
STC2321  DC    X'0000FB00'             INCREMENT TO NEXT STRIP.         75000016
E12      EQU   12                        CONSTANT                YM3012 75050000
MAINT    DC    C'P8 MAINT AREA'                               OX02850   75100003
         DC    20F'0'                  ZAP AREA               OX02850   75150003
         EJECT                                                          75500016
         IEHDBLKS                                                       76000016
         EJECT                                                          76500016
         DCBD  DSORG=PS                                                 77000016
         EJECT                                                          77100000
CVT      DSECT                                                          77200000
         CVT   SYS=MIN                                           Y01048 77300000
         EJECT                                                          77500016
UCB      DSECT                                                          78000016
         IEFUCBOB                                                       78500016
         EJECT                                                          79000016
         SPACE                                                          79500016
DEB      DSECT                                                          80000016
DEBVMOD  EQU   DEB+32                  FILE MASK.                       80500016
DEBSTRCC EQU   DEB+38                  CYLINDER-START OF EXTENT LIMIT.  81000016
DEBSTRHH EQU   DEB+40                  TRACK-START OF EXTENT LIMIT.     81500016
DEBENDCC EQU   DEB+42                  CYLINDER/END OF EXTENT LIMIT.    82000016
DEBENDHH EQU   DEB+44                  TRACK-END OF EXTENT LIMIT.       82500016
DEBNMTRK EQU   DEB+46                  NUMBER OF TRACKS THIS EXTENT.    83000016
         SPACE                                                          83500016
IOB      DSECT                                                          84000016
IOBFLAGS DS    CL2                     FLAG BYTES.                      84500016
IOBSENSE DS    CL2                     SENSE BYTES.                     85000016
IOBECBAD DS    1F                      ECB ADDRESS.                     85500016
IOBCSW   DS    2F                      CHANNEL STATUS WORD.             86000016
IOBCAW   DS    1F                      CHANNEL PROGRAM ADDRESS.         86500016
IOBDCBAD DS    1F                      DCB ADDRESS.                     87000016
IOBRST   DS    1F                      RESTART ADDRESS.                 87500016
IOBBLKER DS    1F                      BLOCK AND ERROR COUNTS.          88000016
IOBSEEK  DS    2F                      MBBCCHHR.                        88500016
CCHH     EQU   IOBSEEK+3               CYLINDER/HEAD ADDRESS.           89000016
R        EQU   IOBSEEK+7               RECORD NUMBER.                   89500016
         END                                                            90000016
./  ADD  SSI=70880158,NAME=IGG019P9
 TITLE  'IGG019P9 --- ABNORMAL-END APPENDAGE FOR IEHDASDR UTILITY'      00910002
         COPY  LCGASMSW                                                 00920002
IGG019P9 CSECT                                                          00950000
*486100-494000                                                  VS01098 01000002
*1033                                                            Y01048 01300000
*                                                               XM3786  01350003
*A BUNCH                                                       @X50RSAG 01352003
*STATUS CHANGE LEVEL 004                                                02900002
*                                                                     * 03600016
*FUNCTION/OPERATION- THIS IS THE ABNORMAL END APPENDAGE FOR THE       * 04500016
*   IEHDASDR SYSTEM UTILITY PROGRAM. IT INTERCEPTS I/O ERRORS ON      * 05400016
*   DIRECT ACCESS DEVICES FOR ALL ANALYZE FUNCTIONS (IEHDANAL AND     * 06300016
*   IEHDCELL). IF IT IS A DATA CHECK, THE BIT IN THE DCBIFLGS IS      * 07200016
*   SET TO PREVENT USE OF STANDARD ERROR RECOVERY PROCEDURES. FOR     * 08100016
*   A DATA CHECK IN THE HOME ADDRESS OR RECORD ZERO COUNT FIELD,      * 09000016
*   A SWITCH IS ALSO SET IN THE DCB(DCBIOBAD) FOR LATER INTERROGATION * 09900016
*   BY IEHDANAL OR IEHDCELL. FOR ALL OTHER I/O ERROR CONDITIONS, THE  * 10800016
*   BIT IN THE DCBIFLGS IS SET TO ENSURE USE OF STANDARD ERROR        * 11700016
*   RECOVERY PROCEDURES. CONTROL IS THEN RETURNED TO IOS.             * 12600016
*                                                                     * 13500016
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IGG019P9-.                    * 14400016
*                                                                     * 15300016
*INPUT- REGISTER 2 POINTS TO THE IOB.                                 * 16200016
*       REGISTER 4 POINTS TO THE DCB.                                 * 17100016
*       REGISTER 1 POINTS TO THE RQE.                         SA57293 * 17150021
*       REGISTER 7 POINTS TO THE UCB.                         SA57293 * 17200021
*        REGISTER 8 POINTS AN IOSB FOR MVM.                     YL02912 17250002
*                                                                     * 18000016
*EXITS-NORMAL- RETURN TO IOS ON REGISTER 14.                          * 18900016
*                                                                     * 19800016
*EXITS-ERROR- NONE.                                                   * 20700016
*                                                                     * 21600016
*EXTERNAL ROUTINES- THE APPENDAGE ROUTINE IS ALWAYS ENTERED FROM      * 22500016
*   IOS AND EXITS TO IOS.                                             * 23400016
*                                                                     * 24300016
*TABLES/WORK AREAS- NONE.                                             * 25200016
*                                                                     * 26100016
*ATTRIBUTES- REENTRANT, RELOCATABLE, NON-PRIVILEGED.                  * 27000016
*                                                                     * 27900016
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             29700016
GR0      EQU   0                                                        29750000
GR1      EQU   1                                                        29800000
GR2      EQU   2                       IOB POINTER.                     30600016
GR4      EQU   4                       DCB POINTER.                     31500016
GR7      EQU   7                        UCB POINTER             SA57293 31502021
GR9      EQU   9                        SAVE AREA FOR REG 0      YM3467 31510002
GR10     EQU   10                      WORK REGISTER                    31550000
GR11     EQU   11                      WORK REGISTER.                   32400016
GR12     EQU   12                      WORK REGISTER.                   33300016
GR13     EQU   13                      WORK REGISTER.                   34200016
GR14     EQU   14                      RETURN REGISTER.                 35100016
GR15     EQU   15                      BASE REGISTER.                   36000016
         SPACE 3                                                        36900016
HEX42    EQU   X'42'                    IOB FLAG               @VS40033 36904003
SILI     EQU   X'20'                    SILI BIT               @VS40033 36906003
CMDCH    EQU   X'40'                    CCW CMD CHN            @VS40033 36908003
CMDRJT   EQU   X'80'                    SENSE BIT              @VS40033 36910003
HEXFF    EQU   X'FF'                    'AND' MASK             @VS40033 36912003
FTR      EQU   X'5E'                    RD-MCKD CCW OPCODE     @VS40033 36914003
OVRFL    EQU   X'01'                    FILE-PROTECT INDICATION SA57293 36950021
ZEUS1    EQU   6                        2305-1 UCB TYPE         SA57293 36960021
ZEUS2    EQU   7                        2305-2                  SA57293 37000021
D4       EQU   4                        DISPL. OF 4             SA57293 37050021
UC       EQU   X'02'                   UNIT CHECK.                      37800016
NOERR    EQU   X'0C'                   USED TO PREVENT USE OF STD. ERPS 38700016
DATACK   EQU   X'08'                   DATA CHECK.                      39600016
CNTCK    EQU   X'80'                   DATA CHECK IN COUNT FIELD.       40500016
BADTRK   EQU   X'80'                   DEFECTIVE HA-R0 COUNT FIELD.     41400016
READHA   EQU   X'1A'                   READ HA OP CODE.                 42300016
READR0   EQU   X'16'                   READ R0 OP CODE.                 43200016
GR3      EQU   3                                                 S20201 43300020
MTRD     EQU   X'92'               M-T READ CIUNT                S20201 43400020
HEX9E    EQU   X'9E'               READ COUNT,KEY,DATA CCW      SA55588 43450000
FILEPRT  EQU   X'04'               FILE PROTECT                  S20201 43500020
COMP     EQU   X'7F'               COMP CODE                     S20201 43600020
CLR      EQU   X'00'               CLEAR FLAGS                   S20201 43700020
E12      EQU   12                       CONSTANT OF 12           YM3012 43750000
L8       EQU   8                        SAVE AREA OFFSET        YL02912 43760002
GR8      EQU   8                        IOSB PTR                YL02912 43770002
IOERROR  EQU   X'41'                    PERMENENT I/O ERROR      YM3012 43800000
         SPACE 3                                                        44100016
         USING IOB,GR2                                                  45000016
         USING UCB,GR7                                          SA57293 45050021
         USING IOSB,GR8                                         YL02912 45100002
         USING IHADCB,GR4                                               45900016
         USING IGG019P9,GR15                                            46800016
         EJECT                                                          47700016
ENTRY    EQU   *                       ONLY ENTRY POINT HERE.           48600016
         NI    DCBIOBAD,X'FF'-BADTRK   INSURE BAD HA-R0 SWITCH IS OFF.  49500016
         SPACE                                                          50400016
         TM    IOBCSW+4,UC             WAS THERE A UNIT CHECK.          51300016
         BZ    RETURN                  NO--RETURN TO IOS.               52200016
         USING DEB,GR3                                           S20201 52230020
         USING FUNCBLK,GR12                                      S20201 52260020
         L     GR12,DCBIOBAD       FUNCBLK ADDRESS               S20201 52290020
         CLI   UCBTBYT4,ZEUS2           THIS UCB A 2305-2 ?     SA57293 52300021
         BE    Z2                       YES, WHICH IOB HAD ERR  SA57293 52310021
         CLI   UCBTBYT4,ZEUS1           THIS DEVICE 2305-1 ?    SA57293 52314021
         BNE   AROUND                   NO, PROCESS NORMALLY    SA57293 52316021
Z2       EQU   *                                                SA57293 52318021
         IC    GR10,DEBVMOD             GET FILE MASK           SA57293 52318421
         ST    GR7,DEBVMOD              STORE CORRECT UCB ADDR  SA57293 52319921
         STC   GR10,DEBVMOD             RESET FILE MASK         SA57293 52323221
*                                       IN DEB                  SA57293 52329921
AROUND   EQU   *                                                SA57293 52363321
         CLI   FUNCSW,DUMP         IS THIS DUMP FUNCTION         S20201 52371003
         BNE   NODUMP              NI                            S20201 52381003
         MVC   UCBSEEK(D4),IOSSKCC      SAVE UCB SEEK FOR DDUMP  MVMFIX 52394603
         L     GR11,IOBCSW         CCW ADDRESS FROM CSW          S20201 52402303
         LA    GR11,0(GR11)        ZERO FIRST BYTE               S20201 52410020
         LTR   GR11,GR11                IS CCW ZERO              A46105 52420021
         BC    13,RETURN                YES,USE STANDARD ERPS    A46105 52430021
         SH    GR11,EIGHT          ADDRESS OF FAILING CCW        S20201 52440020
         USING IOBLOCKS,GR13                                     S20201 52442021
         LA    GR13,BLOCKS         GET PRIMARY                   S20201 52444021
         CLI   0(GR11),MTRD        IS IT M-T RD                  S20201 52470020
         BE    RANDLE              YES                          SA55588 52500000
         CLI   0(GR11),HEX9E       CHECK READ COUNT,KEY,DATA    SA55588 52520000
         BNE  RETURN         SA55588                                    52522003
RANDLE   EQU   *                                                SA55588 52526000
         TM    OUTSENSE+1,FILEPRT  IS FILE PROT ON               S20201 52590020
         BZ    RETURN              NO                            S20201 52620020
         DROP  GR13                                              S20201 52650020
         USING CONSTANT,GR13       ADDRESSING FOR                S20201 52680020
         L     GR13,IODEVCON        DEVICE CONSTANTS             S20201 52710020
         CLC   DEBENDCC(4),LASTALT  DOES DEB EQUAL LAST TRK      S20201 52740020
         BNE   RETURN                                            S20201 52770020
POSTXIT  EQU   *                                               @VS40033 52772003
         MVI   IOBECBCC,COMP       POST COMPLETE CODE            S20201 52800020
         NI    DCBIFLGS,X'3F'       SET DCB FLAGS                S20201 52830020
         NI    IOBFLAG1,X'DA'      SET IOB FLAGS                 S20201 52860020
         B     0(GR14)                                           S20201 52890020
NODUMP   EQU   *                                                 S20201 52920020
         SPACE                                                          53100016
         CLI   FUNCSW,RESTORE           RESTORE FUNCTION ?      YL02912 53150002
         BNE   NOREST                   NO, DON'T SET SEEK ADDR YL02912 53200002
         MVC   UCBSEEK(D4),IOSSKCC       SAVE UCB SEEK FOR DREST MVMFIX 53210002
         DROP  GR8                                                      53220002
NOREST   EQU   *                                                YL02912 53250002
         TM    IOBSENS0,DATACK         WAS THERE A DATA CHECK.          54000016
         BZ    RETURN                  NO--RETURN TO IOS.               54900016
         CLI   FUNCSW,RESTORE          IS THIS RESTORE FUNCTION  XM3786 54950003
         BE    RETURN                  YES, LET ERPS HDL ERR     XM3786 55000003
         SPACE                                                          55800016
         L     GR11,IOBCSW             CCW ADDRESS FROM CSW.            56700016
         LA    GR11,0(GR11)            INSURE HIGH ORDER BYTE IS CLEAR. 57600016
         SH    GR11,EIGHT              ADDRESS OF FAILING CCW.          58500016
         SPACE                                                          59400016
         CLI   0(GR11),READHA          THIS A READ HOME ADDRESS CCW.    60300016
         BE    SETFLAG                 YES--SET INDICATOR.              61200016
         SPACE                                                          62100016
         CLI   0(GR11),READR0          THIS A READ R0 CCW.              63000016
         BNE   SETFLAG1                NO--RETURN//BYPASS ERPS.         63900016
         SPACE                                                          64800016
         TM    IOBSENS1,CNTCK          WAS DATA CHECK IN COUNT FIELD.   65700016
         BZ    SETFLAG1                NO--RETURN//BYPASS ERPS.         66600016
         SPACE                                                          67500016
SETFLAG  OI    DCBIOBAD,BADTRK         INDICATE DEFECTIVE HA-R0 AREA.   68400016
SETFLAG1 OI    DCBIFLGS,NOERR          PREVENT USE OF STD. ERPS.        69300016
         BR    GR14                    RETURN TO IOS.                   70200016
         SPACE                                                          71100016
RETURN   NI    DCBIFLGS,X'FF'-NOERR    INSURE STD. ERPS ARE USED.       72000016
         BR    GR14                    RETURN TO IOS.                   72900016
         SPACE                                                          73800016
ONE      DC    F'1'                     CONSTANT OF ONE          YM3012 73850000
EIGHT    DC    H'8'                    CONSTANT FOR SUBTRACT.           74700016
         EJECT                                                          75600016
IOB      DSECT                         DESCRIPTION OF IOB.              76500016
IOBFLAG1 DS    CL1                     FLAG1                            77400016
IOBFLAG2 DS    CL1                     FLAG2.                           78300016
IOBSENS0 DS    CL1                     SENSE BYTE ZERO.                 79200016
IOBSENS1 DS    CL1                     SENSE BYTE ONE.                  80100016
IOBECBCC DS    CL1                     COMPLETION CODE.                 81000016
IOBECBPT DS    CL3                     ADDRESS OF ECB.                  81900016
IOBCSW   DS    CL8                     STATUS WORDS.                    82800016
IOBSTART DS    CL4                     CHANNEL PROGRAM ADDRESS.         83700016
IOBDCBPT DS    CL4                     ADDRESS OF DCB.                  84600016
IOBRESTR DS    CL4                     RESTART ADDRESS.                 85500016
IOBINCAM DS    CL2                     BLOCK COUNT.                     86400016
IOBERRCT DS    CL2                     ERROR COUNT.                     87300016
IOBSEEK  DS    CL8                     SEEK ADDRESS.                    88200016
         IEHDBLKS                                                       88210020
         IEHDWORK                                                       88220020
IOBLOCKS DSECT                                                          88230020
* DUMP 'TO' ECB.                                                        88240020
TOECB    DS    1F                  WAIT//COMPLETE BITS PLUS      S20201 88250020
*                                       CODE.                    S20201 88260020
* DUMP 'TO' IOB.                                                        88270020
TOIOB    DS    0F                                                S20201 88280020
TOFLGS   DS    CL2                 FLAGS ONE AND TWO.            S20201 88290020
TOSENSE  DS    CL2                 SENSE BYTES.                  S20201 88300020
TOECBAD  DS    1F                  ECB ADDRESS                   S20201 88310020
TOSTATUS DS    2F                  CHANNEL STATUS                S20201 88320020
TOCCWAD  DS    1F                  CCW LIST ADDRESS.             S20201 88330020
TODCBAD  DS    1F                  DCB ADDRESS.                  S20201 88340020
TORESAD  DS    1F                  RESTART ADDRESS.              S20201 88350020
TOBLKCNT DS    CL2                 BLOCK COUNT INCREMENT.        S20201 88360020
TOERROR  DS    CL2                 ERROR COUNT.                  S20201 88370020
TOSEEK   DS    2F                  MBBCCHHR                      S20201 88380020
* DUMP 'TO' DCB.                                                        88390020
TODCB    DS    18F                 DCB.                        @VS40033 88400003
         DS    0D                  FOR DOUBLE WORD ALIGNMENT.    S20201 88410020
TAPECCW1 DS    1D                  USED TO PUT OUT CCW RECORD  @VS40033 88420003
*                                    AND DATA ON TAPE.                  88430020
         DS    0D                  FOR DOUBLE WORD ALIGNMENT.    S20201 88460020
* DUMP 'FROM' ECB.                                                      88470020
OUTECB   DS    1F                  WAIT//COMPLETE BITS PLUS      S20201 88480020
*                                       CODE.                    S20201 88490020
OUTIOB   DS    0F                                                S20201 88500020
OUTFLG   DS    CL2                 FLAGS ONE AND TWO.            S20201 88510020
OUTSENSE DS    CL2                 SENSE BYTES.                  S20201 88520020
OUTECBAD DS    1F                       ECB ADDR               @VS40033 88522003
OUTSTAT  DS    2F                  CHANNEL STATUS.               S20201 88530020
OUTCCWAD DS    1F                  CCW LIST ADDRESS              S20201 88540020
OUTDCBAD DS    1F                  DCB ADDRESS.                  S20201 88550020
OUTRESAD DS    1F                  RESTART ADDRESS.              S20201 88560020
OUTBLKCT DS    CL2                 BLOCK COUNT INCREMENT.        S20201 88570020
OUTERROR DS    CL2                 ERROR COUNT.                  S20201 88580020
OUTSEEK  DS    2F                  7BBCCHHR.                     S20201 88590020
CCHH     EQU   OUTSEEK+3           CYLINDER/HEAD ADDRESS.        S20201 88600020
R        EQU   OUTSEEK+7           RECORD NUMBER.                S20201 88610020
* DUMP 'FROM' DCB.                                                      88620020
OUTDCB   DS    18F                 DCB.                          S20201 88630020
IOBLKEND DS    0H                  END OF IOBLOCKS DSECT.        S20201 88640020
DBSIZE   EQU   IOBLKEND-IOBLOCKS   SIZE OF IOBLOCKS DSECT.       S20201 88650020
DEB      DSECT                                                          88660020
DEBVMOD  EQU   DEB+32              FILE MASK                     S20201 88670020
DEBSTRCC EQU   DEB+38              CYLINDER-START OF EXTENT      S20201 88680020
*                                       LIMIT                    S20201 88690020
DEBSTRHH EQU   DEB+40              TRACK-END OF EXETEN LIMIT     S20201 88700020
DEBENDCC EQU   DEB+42              CYL/END OF EXTENT LIMIT       S20201 88710020
DEBENDHH EQU   DEB+44              TRACK/END OF EXTENT LIMIT     S20201 88720020
DEBNMTRK EQU   DEB+46              NUMBER OF TRACKS THIS EXTENT  S20201 88730020
         EJECT                                                          88780002
         IECDIOSB                                               YL02912 88830002
         EJECT                                                          89100016
UCB      DSECT                                                  SA57293 89150021
         IEFUCBOB                                               SA57293 89200021
         EJECT                                                  SA57293 89250021
         DCBD  DSORG=PS                                                 90000016
         EJECT                                                          90200000
CVT      DSECT                                                          90400000
         CVT   SYS=MIN                                           Y01048 90600000
         END                                                            90900016
