./  ADD  SSI=82080082,NAME=IFFABA
         TITLE 'GRAPHICS ATTENTION HANDLER, FIRST LEVEL'                00300000
*********************************************************************** 00600000
*                                                                       00900000
* MODULE NAME:           IFFABA (OS/VS2)                                01200000
*                                                                       01500000
* DESCRIPTIVE NAME:      GRAPHICS ATTENTION HANDLER                     01800000
*                                                                       02100000
* COPYRIGHT:             NONE                                           02400000
*                                                                       02700000
* STATUS:                RELEASE 2.0                                    03000000
*                                                                       03300000
* FUNCTION:              FIRST LEVEL ATTENTION HANDLING IS PROVIDED.    03600000
*                                                                       03900000
*                        ATTENTION PROCESSING IS DEPENDENT UPON THE     04200000
*                          TYPE OF ATTENTION HANDLING SPECIFIED BY      04500000
*                          THE USER IN HIS GRAPHICS DCB:                04800000
*                                                                       05100000
*                          1. FOR EXPRESS (ANALOGOUS TO POLLING):       05400000
*                               A BIT INDICATING THE TYPE OF ATTN       05700000
*                               IS SET IN THE UCBGCB FIELD.             06000000
*                                                                       06300000
*                          2. FOR BASIC (USER ASYNCH RTN SPECIFIED):    06600000
*                               THE SECOND LEVEL ATTN HANDLER, GAR      06900000
*                               (IGG019OE), IS SCHEDULED THROUGH THE    07200000
*                               ASYNCHRONOUS EXIT EFFECTOR, STAGE II,   07500000
*                               FOR DETERMINING THE DISPOSITION OF THE  07800000
*                               ATTENTION.                              08100000
*                                                                       08400000
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 08700000
         EJECT                                                          09000000
* NOTES:                                                                09300000
*                                                                       09600000
*     DEPENDENCIES:      NORMAL PROGRAM OPERATION AS DESCRIBED BELOW;   09900000
*                        CVT POINTER AT STORAGE LOCATION HEX 10.        10200000
*                                                                       10500000
*     RESTRICTIONS:      NONE                                           10800000
*                                                                       11100000
*     RESISTERS:         SEE EQUATE DEFINITIONS FOLLOWING PROLOG        11400000
*                                                                       11700000
*     PATCH LABEL:       USE COMMON NUCLEUS PATCH AREA, IEAPATCH;       12000000
*                        MODID, 24 BYTES, CAN ALSO BE USED.             12300000
*                                                                       12600000
* MODULE TYPE:           EXECUTABLE CODE                                12900000
*                                                                       13200000
*    PROCESSOR:          ASSEMBLER XF                                   13500000
*                                                                       13800000
*    MODULE SIZE:        SEE PAGE 1 OF THIS LISTING                     14100000
*                                                                       14400000
*    ATTRIBUTES:         REENTRANT   LOCKED   KEY 0    SUPERVISOR STATE 14700000
*                                                                       15000000
* ENTRY POINT:           IFFIOM                                         15300000
*                                                                       15600000
*    PURPOSE:            SEE FUNCTION                                   15900000
*                                                                       16200000
*    LINKAGE:                                                           16500000
*                        REGISTER:         CONTENTS:                    16800000
*                            1     ADDR OF:  IOSB                       17100000
*                           13               LOCAL LOCK SAVE AREA       17400000
*                           14               RETURN TO IOS              17700000
*                           15               IFFIOM ENTRY POINT         18000000
*                                                                       18300000
* INPUT:                 SEE LINKAGE TOPIC & DSECTS AT END OF LISTING   18600000
*                                                                       18900000
* OUTPUT:                FOR EXPRESS:   SETS UCBGCB BITS:               19200000
*                                             6 IF LP OR ASYNCH ERROR   19500000
*                                             7 IF KEYBOARD ATTN        19800000
*                                                                       20100000
*                        FOR BASIC:   IGG019OE SCHEDULED USING          20400000
*                                     COMPLEMENTED ADDR OF IQE          20700000
         EJECT                                                          21000000
*                                                                       21300000
* EXITS:                                                                21600000
*                                                                       21900000
*    NORMAL:             RETURN TO ADDRESS IN REG 14                    22200000
*                                                                       22500000
*                        FOR RESCHEDULING GAH IN USER'S MEMORY:         22800000
*                          RETURN TO ADDRESS IN REG 14, PLUS FOUR       23100000
*                                                                       23400000
*    ERROR:              RETURN TO ADDRESS IN REG 14; ATTN DISCARDED    23700000
*                                                                       24000000
*  EXTERNAL REFERENCES:          (BASIC PROCESSING ONLY):               24300000
*                                                                       24600000
*     ROUTINES:         POST STATUS TO RESCHEDULE GAH IN USER'S MEMORY; 24900000
*                       AEE, STAGE II, TO SCHEDULE GAR (IGG019OE).      25200000
*                                                                       25500000
*     DATA AREAS:       SEE EQUS FOLLOWING PROLOG                       25800000
*                                                                       26100000
*     CONTROL BLOCKS:   SEE USING STATEMENTS FOLLOWING PROLOG           26400000
*                       AND DSECTS (IN ALPHABETICAL ORDER)              26700000
*                                                                       27000000
* TABLES:               NONE LOCAL TO MODULE                            27300000
*                                                                       27600000
* MACROS:               NONE                                            27900000
*                                                                       28200000
* CHANGE ACTIVITY:      MODULE HAS BEEN REWRITTEN TO USE THE NEW        28500000
*                       IOS INTERFACE WITH IOSB FROM POST STATUS.       28800000
*                       CSECT FLAGS UPDATED WHERE APPROPIATE:           29100000
         SPACE 3                                                        29400000
IFFABA   CSECT                                                          29700000
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   30000000
*A083200-083400,C084000                                     D11 YA07646 30300000
*C110500-111000  APAR ZA07644 REMOVED BY APAR ----------->  E12 ZA34015 30600000
*C101500,106000,116000                                        LF YM5682 30900000
*A083500                                                      LF YM4067 31200000
*C83500                                                       LG YM5694 31500000
* VS2/R2                                                      LF YM0160 31800000
* OS/R20                                                        SA32068 32100000
* OS/R19                                                        SA28435 32400000
         EJECT                                                          32700000
*        GENERAL REGISTERS                                              33000000
         SPACE 3                                                        33300000
RADR     EQU   1      PARAMETER REGISTER FOR ADDRESSES                  33600000
RBASE    EQU   2                                                        33900000
         SPACE 2                                                        34200000
RASCB    EQU   3        SYSTEM CONTROL BLOCK ADDRESSES                  34500000
RCVT     EQU   4           NAME INDICATES CONTENTS                      34800000
RIOSB    EQU   5                                                        35100000
RIQE     EQU   6            (SEPARATE REGS USED)                        35400000
RIRB     EQU   7           (TO PRESERVE CONTENTS)                       35700000
RSRB     EQU   8              (FOR DEBUGGING)                           36000000
RTCB     EQU   9                                                        36300000
RTEB     EQU   10                                                       36600000
RUCB     EQU   11                                                       36900000
RUCBEXT  EQU   12                                                       37200000
         SPACE 2                                                        37500000
R13SAVE  EQU   13       SYSTEM CONVENTIONAL REGISTERS                   37800000
R14BACK  EQU   14          STANDARD BAL REGISTERS                       38100000
R15EP    EQU   15                                                       38400000
         SPACE 3                                                        38700000
         USING ASCB,RASCB                                               39000000
         USING CVT,RCVT                                                 39300000
         USING IOSB,RIOSB                                               39600000
         USING IQE,RIQE                                                 39900000
         USING RBBASIC,RIRB                                             40200000
         USING SRB,RSRB                                                 40500000
         USING TCB,RTCB                                                 40800000
         USING TEB,RTEB                                                 41100000
         USING UCBOB,RUCB                                               41400000
         USING UCBCMEXT,RUCBEXT                                         41700000
         EJECT                                                          42000000
*        MISCELLANEOUS EQUATES AND DSECT EQUATES                        42300000
         SPACE 2                                                        42600000
ZERO     EQU   0                                                        42900000
TWO      EQU   2                                                        43200000
FOUR     EQU   4                                                        43500000
         SPACE 5                                                        43800000
*     CHANNEL STATUS WORD (CSW) EQUATES                                 44100000
         SPACE 2                                                        44400000
CSWATN   EQU   X'80'                   ATTENTION BIT                    44700000
CSWUC    EQU   X'02'                   UNIT CHECK BIT                   45000000
         EJECT                                                          45300000
*                      INITIALIZATION  SETUPS                           45600000
*                                                                       45900000
*          DETERMINE TYPE OF ATTENTION HANDLING SPECIFIED BY USER       46200000
*               1.  IF EXPRESS, SET UCBGCB BITS                         46500000
*               2.  IF BASIC,   SCHEDULE IGG019OE                       46800000
         SPACE 3                                                        47100000
         ENTRY IFFIOM                  VCON NAME FOR IOS ENTRY          47400000
         USING *,15                                                     47700000
         B     *+24                                                     48000000
MODID    DC    C'IFFABA.VS2R2.&SYSDATE  ' MODULE EYECATCHER ID          48300000
IFFIOM   STM   0,15,ZERO(R13SAVE)      SAVE REGISTERS                   48600000
         DROP  15                                                       48900000
         BALR  RBASE,ZERO              SET UP NEW BASE REGISTER         49200000
         USING *,2                     DEFINE BASE REGISTER             49500000
         SPACE 3                                                        49800000
*     GET UCB FROM IOSB INPUT AND CHECK ATTENTION HANDLING TYPE         50100000
         SPACE                                                          50400000
         LR    RIOSB,RADR         KEEP INPUT ADDR                       50700000
         L     RUCB,IOSUCB        GET UCB ASSOCIATED WITH THIS ATTN     51000000
         OC    IOSSNS(FOUR),IOSSNS ANY SENSE HERE?          D11 ZA07646 51300000
         BZ    CHKBASIC            NO,DONT MOVE IT          D11 ZA07646 51600000
         MVC   UCBSNS(FOUR),IOSSNS  SAVE SENSE DATA       YM5694,YM4067 51900000
CHKBASIC EQU   *                                            D11 ZA07646 52200000
         TM    UCBGCB,UCBGBAS     CHECK IF BASIC ATTN HANDLING          52500000
         BO    GAH0030              IF YES, DO BASIC VALIDITY CHECKS    52800000
         EJECT                                                          53100000
*                      EXPRESS ATTENTION HANDLING                       53400000
*                                                                       53700000
*                1.  DETERMINE ATTENTION STATUS FROM CSW BITS           54000000
*                2.  SET UCBGCB,  BIT  6  FOR LITE PEN & ASYNCH ERROR   54300000
*                                      7      KEYBOARD (PFK OR ANR)     54600000
         SPACE 3                                                        54900000
         TM    IOSTATUS,CSWATN     CHECK FOR ATTN STATUS IN CSW         55200000
         BNO   GAH0020               IF NOT, DISCARD INTERUPT           55500000
         TM    IOSTATUS,CSWUC      SEE IF UNIT CHECK STATUS IS IN CSW   55800000
         BNO   GAH0010               IF NO, ATTN IS KEYBOARD TYPE       56100000
         OI    UCBGCB,UCBGLPAE       IF YES, ATTN IS LITE PEN OR ASYNCH 56400000
         B     GAH0020             RETURN TO IOS                        56700000
GAH0010  OI    UCBGCB,UCBGKBRD       SET KEYBOARD ATTN BIT              57000000
GAH0020  LM    0,15,ZERO(R13SAVE)  RESTORE REGS                         57300000
         BR    R14BACK             RETURN TO SUPV                       57600000
         EJECT                                                          57900000
*                         BASIC ATTENTION HANDLING                      58200000
*                                                                       58500000
*        SECOND LEVEL ATTENTION HANDLER, GAR (IGG019OE), IS SCHEDULED   58800000
*        IN THE USER'S MEMORY.  IF GAH IS NOT EXECUTING IN USER MEMORY, 59100000
*        RETURN TO IOS FOR RESCHEDULING BY PROVIDING USER ID FROM       59400000
*        THE UCB EXTENSION.                                             59700000
*                                                                       60000000
*        VALIDITY CHECKS FOR BASIC ATTENTION HANDLING INCLUDE           60300000
*             1.  DEVICE HAS BEEN OPENED  (UCBGINIT BIT SET)    SA32068 60600000
*             2.  TEB EXISTS              (UCBTEB IS NON-ZERO)          60900000
*             3.  TEB ID FLAG OK          (TEFLAGS, BIT 0 IS SET)       61200000
*             4.  TCB IS NOT ABENDING     (TCBFLGS, BIT 0 IS NOT SET)   61500000
*                                                                       61800000
*        IF ANY CHECK FAILS, THE ATTENTION IS DISCARDED AND             62100000
*                            GAH RETURNS TO IOS                         62400000
         SPACE 3                                                        62700000
GAH0030  L     RSRB,IOSSRB        GET ADDR OF:  SRB              YM5682 63000000
         L     RASCB,SRBASCB                    ASCB                    63300000
         L     RUCBEXT,UCBEXTPT                 UCB EXTENSION    YM0160 63600000
         LA    RUCBEXT,ZERO(RUCBEXT)              CLEAR HI BYTE  YM0160 63900000
         CLC   ASCBASID(TWO),UCBASID   CK IF IN USER MEMORY             64200000
         BE    GAH0040                   IF YES, OK TO CONTINUE         64500000
         MVC   IOSASID(TWO),UCBASID      IF NO,  GET USER ID            64800000
         LM    0,15,ZERO(R13SAVE)                RESTORE REGS           65100000
         B     FOUR(R14BACK)                     RESCHEDULE GAH         65400000
GAH0040  TM    UCBGCB,UCBGINIT    HAS OPEN INITZ DEVICE          YM5682 65700000
         BZ    GAH0020                IF NO, DISCARD ATTN AND RETURN    66000000
         L     RTEB,UCBTEB        CHECK IF TEB EXISTS                   66300000
         LA    RTEB,0(RTEB)           ZERO HI ORDER BYTE                66600000
         LTR   RTEB,RTEB                                                66900000
         BZ    GAH0020                IF NONE, DISCARD ATTN             67200000
         TM    TEFLGS,TEFLAG      IS TEB ID FLAG OK                     67500000
         BNO   GAH0020                IF NO, DISCARD ATTN               67800000
         L     RTCB,TETCB         GET TCB IN CONTROL OF DEVICE  SA28435 68100000
         TM    TCBFLGS,TCBFA      IS ABEND IN PROGRESS?     E12 ZA34015 68400000
         BO    GAH0020            YES,DON'T SCHEDULE ATTN   E12 ZA34015 68450000
         EJECT                                                          69000000
*                    BASIC ATTENTION HANDLING                           69300000
*                                                                       69600000
*               1.  GET NEXT AVAILABLE IQE FROM GAR'S IRB               69900000
*               2.  INITIALIZE IQE PARM FIELD:                          70200000
*                      BYTES:      0:  CSW STATUS BITS                  70500000
*                                1-3:  UCB ADDR                         70800000
*                                                                       71100000
         SPACE 3                                                        71400000
         L     RIRB,TEGARIRB     GET GAR IRB FROM TEB           YM5682  71700000
         L     RIQE,RBNEXAV      CHECK IF IQE AVAIL TO HANDLE ATN       72000000
         LA    RIQE,0(RIQE)         ZERO HI ORDER BYTE                  72300000
         LTR   RIQE,RIQE                                                72600000
         BZ    GAH0020              IF NONE, DISCARD ATTN               72900000
         MVC   RBNEXAV(FOUR),IQELNK IF YES, REMOVE IQE FOR SCHEDULING   73200000
         ST    RUCB,IQEPARM       INITZ IQE FOR GAR                     73500000
         MVC   IQEPARM(1),IOSTATUS     PARM IS CSW STATUS+UCB ADDR      73800000
         SPACE 3                                                        74100000
*    GET AEE, STAGE II, ADDRESS FROM CVT AND SCHEDULE GAR               74400000
         SPACE                                                          74700000
         L     RCVT,CVTPTR          GET CVT ADDR FROM FIXED LOCATION    75000000
         L     R15EP,CVT0EF00       GET AEE-II ENTRY POINT              75300000
         LNR   RADR,RIQE            USE COMPLEMENTED ADR TO INDIC IQE   75600000
         BALR  R14BACK,R15EP          LINK TO AEE                       75900000
         B     GAH0020                RETURN TO IOS                     76200000
         EJECT                                                          76500000
*********************************************************************** 76800000
*                                                                       77100000
*                        DSECTS                                         77400000
*                                                                       77700000
*********************************************************************** 78000000
ASCB     IHAASCB                                                        78300000
         EJECT                                                          78600000
         CVT   DSECT=YES                                                78900000
         EJECT                                                          79200000
         IECDIOSB                                                       79500000
         EJECT                                                          79800000
IQE         DSECT                                                       80100000
IQELNK   DS    F     ADDR OF:              NEXT IQE ON CHAIN            80400000
IQEPARM  DS    F     PARAMETER CONTENTS:   CSW STATUS BITS & UCB ADDR   80700000
IQEADIRB DS    F     ADDR OF:              CONTROLLING IRB              81000000
IQEADTCB DS    F                                       TCB              81300000
         EJECT                                                          81600000
         IHARB                                                          81900000
         EJECT                                                          82200000
SRB      IHASRB                                                         82500000
         EJECT                                                          82800000
         IKJTCB                                                         83100000
         EJECT                                                          83400000
TEB      DSECT                                                          83700000
TESCKIRB DS    F       ADDR OF:     IRB FOR SYSTEM CANCEL KEY RTN       84000000
TEREB    DS    F                    GAM ROUTINE ENTRY BLOCK             84300000
TETCB    DS    F                    TCB                                 84600000
TESCKQE  DS    F                    LIST OF CANCEL KEY IQES             84900000
TEUSECT  DS    F       USE COUNT:   NBR OF UCBS USING THIS TEB          85200000
TEFLGS   DS    F       FLAG BYTES:                                      85500000
TEFLAG   EQU   X'80'                TEB ID FLAG                         85800000
TEGARIRB DS    F       ADDR OF:     GAR'S IRB                           86100000
TEGEIR   DS    F                    GEIR (IGG019OJ) ENTRY POINT         86400000
         EJECT                                                          86700000
UCB      DSECT                                                          87000000
         IEFUCBOB                                                       87300000
**********************************************************************  87600000
*                                                                     * 87900000
*                    ADDITIONAL UCB EQUATES FOR DSECT                 * 88200000
*                                                                     * 88500000
*********************************************************************** 88800000
         SPACE 3                                                        89100000
*          UCBTYP, BYTE 4, BIT SETTINGS                                 89400000
         SPACE                                                          89700000
UCBT2250 EQU   X'02'      UNIT TYPE ID FOR 2250 DEVICE                  90000000
UCBT2260 EQU   X'03'                   FOR 2260                         90300000
UCBT1053 EQU   X'04'                   FOR 1053                         90600000
         SPACE 2                                                        90900000
*          UCBGCB, BIT SETTINGS                                         91200000
         SPACE                                                          91500000
UCBGINIT EQU   X'40'      BIT 2: DEVICE INITZ BY OPEN; ATNS OK   A32068 91800000
UCBGBAS  EQU   X'08'      BIT 4: DEVICE OPENED FOR BASIC ATTNS          92100000
UCBGLPAE EQU   X'02'      BIT 6: LITE PEN OR ASYNCH ERR REC'D           92400000
UCBGKBRD EQU   X'01'      BIT 7: KEYBOARD ATTN REC'D                    92700000
         END                                                            93000000
./  ADD  SSI=33020885,NAME=IFFANA
*TITLE 'GRAPHIC ATTENTION ANALYSIS ROUTINE'                             00020002
*STATUS:CHANGE LEVEL 0                                                  00040002
*FUNCTION/OPERATION:THIS ROUTINE DETERMINES IF AN ATTENTION HAS OCCURED 00060002
*   BY POLLING BITS 6 AND 7 IN THE INDIVIDUAL GRAPHIC CONTROL BYTES     00080002
*   (GCB).THIS ROUTINE DETERMINES THE TYPE OF ATTENTION THAT OCCURED    00100002
*   BY USE OF GCB BITS 6 AND 7 AND THE SENSE BYTES IN THE UNIT CONTROL  00120002
*   BLOCK(UCB).A UNIQUE RETURN CODE FOR EACH TYPE OF ATTENTION IE.LITE  00140002
*   PEN,KEYBOARD,END ORDER SEQUENCE OR ASYNCH.ERROR IS PUT IN GR#15.    00160002
*   CODES ARE PLACED IN GR#15 FOR PARAMETERS MISSING,WORD 5 IN TABLE    00180002
*   OF ADDRESSES MISSING OR NO ATTENTIONS OCCURED.WHEN RETURN IS        00200002
*   MADE TO THE CALLING PROGRAM THE REST OF THE CODING GENERATED BY     00220002
*   THE ANALYZ MACRO DECODES GR#15 AND EITHER PASSES CONTROL TO A USER  00240002
*   ATTENTION ROUTINE OR GENERATES A RETURN CODE TO PLACE IN GR#15      00260002
*   AS PER THE SRL.REGISTERS 1 THRU 12 ARE SAVED ON ENTRY AND RESTORED  00280002
*   UPON EXIT.SAVE AREA POINTED TO BY GR#13 AS PER CONVENTIONS.         00300002
*ENTRY POINTS:IFFANA ALIAS ANLZ.POLL FOR AN ATTENTION.                  00320002
*       L    15,ADDR                                                    00340002
*       BALR 14,15                                                      00360002
*               X                                                       00380002
*               X                                                       00400002
*   ADR DC   V(ANLZ)                                                    00420002
*               X                                                       00440002
*               X                                                       00460002
*               X                                                       00480002
*INPUT:GR#1 CONTAINS ADR OF PARAMETER LIST WHICH IS CONSTRUCTED AS      00500002
*   FOLLOWS:                                                            00520002
*       ******************                                              00540002
*   LIST* DCBLST ADDRESS *(0)                                           00560002
*       ******************                                              00580002
*       * POINTR ADDRESS *(4)                                           00600002
*       ******************                                              00620002
*       * RESERVED       *(8)                                           00640002
*       ******************                                              00660002
*OUTPUT:GR#0 CONTAINS ADDRESS OF OUTPUT AREA(IN CASE OF MULTIPLE OUTPUT 00680002
*   AREAS DEFINED BY MULTIPLE ANALYZ MACROS IN A SINGLE ASSEMBLY).      00700002
*   OUTPUT AREA IS AS FOLLOWS:                                          00720002
*       ****************                                                00740002
*   OUT * SENSE INFO   * (0)                                            00760002
*       ****************                                                00780002
*       * IX * DCB ADR * (4)                                            00800002
*       ****************                                                00820002
*         IX=VALID USE ONLY FOR MULTIPLE 2260S ASSIGNED TO A SINGLE     00840002
*   DATA CONTROL BLOCK(DCB).GIVES THE NUMBER OF THE UCB ADR EXTENT TO   00860002
*   THE DATA EXTENT BLOCK IE 0,1,2 ETC.                                 00880002
*   SENSE INFO VALID ONLY FOR LITE PEN,END ORDER SEQUENCE AND ASYNCH.   00900002
*   ERROR ATTENTIONS.                                                   00920002
*   GR#15 CONTAINS RETURN CODES AS DESCRIBED IN EXITS NORMAL AND ERROR. 00940002
*   RETURN CODES ARE FOR DECODING BY ANALYZ MACRO EXPANSION.            00960002
*EXTERNAL ROUTINES:N/A                                                  00980002
*EXITS NORMAL:IN ALL CASES CONTROL IS RETURNED TO THE ANALYZ MACRO      01000002
*   EXPANSION CODING IN THE CALLING PROG.WITH A RETURN CODE IN GR#15.   01020002
*   THE RETURN CODES ARE AS FOLLOWS:                                    01040002
*   LITE PEN=00               X                                         01060002
*   KEYBOARD(AN OR PF)=04     X                                         01080002
*   ASYNCHRONOUS ERROR=08     XXCODES ARE IN HEX                        01100002
*   END ORDER SEQUENCE=0C     X                                         01120002
*   NO ATTENTIONS PRESENT=10  X                                         01140002
*   LA  15,RETURN CODE                                                  01160002
*   BR  14                                                              01180002
*EXITS-ERROR:IN ALL CASES CONTROL IS RETURNED TO THE ANALYZ MACRO       01200002
*   EXPANSION CODING IN THE CALLING PROG.WITH A RETURN CODE IN GR#15.   01220002
*   THE RETURN CODES ARE AS FOLLOWS:                                    01240002
*   PARAMETER MISSING=18                      XCODES ARE IN HEX         01260002
*   WORD 5 IN ADDRESS TABLE(POINTR)MISSING=20 X                         01280002
*   LA  15,RETURN CODE                                                  01300002
*   BR  14                                                              01320002
*TABLES/WORK AREAS:A TABLE OF USER ATTENTION ROUTINE ADDRS. AS POINTED  01340002
*   TO BY THE POINTR PARAMETER OF THE ANALYZ MACRO.IT IS CONSTRUCTED AS 01360002
*   FOLLOWS.                                                            01380002
*   **************************                                          01400002
*   * LITE PEN ADR           *(0)                                       01420002
*   **************************                                          01440002
*   * KEYBOARD ADR           *(4)                                       01460002
*   **************************                                          01480002
*   * ASYNCHRONOUS ERROR ADR *(8)                                       01500002
*   **************************                                          01520002
*   * END ORDER SEQUENCE ADR *(12)                                      01540002
*   **************************                                          01560002
*  * OUTPUT AREA ADR         *(16)  OUTPUT AREA CONSTRUCTED AS SHOWN    01580002
*   **************************      IN OUTPUT HEADING ABOVE.            01600002
*ATTRIBUTES:RE-ENTRANT                                                  01620002
*NOTES:THE RETURN CODES AS GENERATED BY THIS ROUTINE ARE FOR INTERNAL   01640002
*   USE ONLY AND ARE NOT THE RETURN CODES LOGICALLY PRESENTED TO THE    01660002
*   CALLING PROBLEM PROGRAM.THE RETURN CODES LOGICALLY PRESENTED  TO    01680002
*   THE PROBLEM PROGRAM ARE AS FOLLOWS:                                 01700002
*   NORMAL RETURN=00                                  X                 01720002
*   NO ATTENTIONS=04                                  X                 01740002
*   ATTENTION OCCURED BUT NO USER ROUTINE PROVIDED 08 XCODES ARE IN HEX 01760002
*   PARAMETER MISSING=0C                              X                 01780002
*   WORD 5 IN ADDRESS TABLE MISSING=10                X                 01800002
*   IT IS THE RESPONSIBILITY OF THE USER ATTENTION ROUTINES TO SAVE AND 01820002
*   RESTORE REGISTERS ONCE CONTROL IS GIVEN TO THEM.                    01840002
*                                                                       01860002
*        REGISTER DEFINITION                                            01880002
REG0     EQU   0                       PARAM REGISTER                   01900002
LISTRG   EQU   1                        POINTER TO PARAMETER LIST       01920002
BASERG   EQU   2                        BASE REGISTER                   01940002
TABREG   EQU   3                        POINTER TO TABLE                01960002
DCBREG   EQU   4                        POINTER TO DCB LIST             01980002
INDXRG   EQU   5                        INDEX REGISTER                  02000002
GBREG1   EQU   6                        WORK REG                        02020002
GBREG2   EQU   7                        WORK REG                        02040002
GBREG3   EQU   8                        WORK REG                        02060002
GBREG4   EQU   9                        WORK REG                        02080002
GBREG5   EQU   10                       WORK REG                        02100002
GBREG6   EQU   11                       WORK REG                        02120002
GBREG7   EQU   12                       WORK REG                        02140002
SAVEREG  EQU   13                      SAVE AREA REGISTER               02160002
RETREG   EQU   14                       RETURN REGISTER                 02180002
BRNCHREG EQU   15                      BRANCH TO ADDRESS REGISTER       02200002
ERCODE   EQU   15                      RETURN CODE REGISTER             02220002
*                                                                       02240002
UCBADR   EQU   32                       CONSTANT TO ACCESS START OF     02260002
*                                       UCB LIST IN DEB                 02280002
DEBADR   EQU   44                      CONSTANT TO ACCESS DEB ADDRESS   02300002
SENSE    EQU   32                       SENSE DATA            LF YM4067 02320002
GCBADR   EQU   27                       DISPLACEMENT CONSTANT TO GIVE   02340002
*                                       GCB BYTE AT END OF UCB          02360002
GASR     EQU   70                      GSERV SVC ID                     02380002
*                                                                       02400002
IFFANA   CSECT                                                          02420002
*C023200                                                      LF YM4067 02422002
* 040600,041400,042200,025800                                    S21016 02430002
         ENTRY ANLZ                                                     02440002
ANLZ     STM   LISTRG,GBREG7,24(SAVEREG) SAVE REGISTERS CONTENTS        02460002
         BALR  BASERG,0                 SET UP BASE REGISTER            02480002
         USING *,BASERG                 DEFINE BASE REGISTER            02500002
RECYCLE  CLC   1(3,LISTRG),ZERO        TEST FOR ZERO IN DCBLST PARAM    02520002
         BC    8,EXIT1                  BRANCH IF ZERO                  02540002
         CLC   5(3,LISTRG),ZERO        TEST FOR ZERO IN POINTR PARAM    02560002
         BE    EXIT6                   BRANCH IF ZERO            S21016 02580002
         L     TABREG,4(0,LISTRG)       LOAD POINTER PARAMETER          02600002
         L     DCBREG,0(0,LISTRG)       LOAD DCB LIST POINTER           02620002
         LA    DCBREG,0(0,DCBREG)      ZERO HIGH ORDER BYTE             02640002
         CLC   9(3,LISTRG),ZERO        IS RESUME PTR ZERO               02660002
         BC    8,PTR0                   BRANCH IF YES                   02680002
         CLC   9(3,LISTRG),1(DCBREG)   IS RESUME PTR GREATER THAN       02700002
*                                       LAST DCBLST ENTRY ADDRESS       02720002
         BC    2,PTR0                   BRANCH IF RESUME PTR GREATER    02740002
         L     DCBREG,8(0,LISTRG)       LOAD RESUME PTR                 02760002
         LA    DCBREG,0(0,DCBREG)      ZERO HIGH ORDER BYTE             02780002
         BC    15,IDCHEK                BRANCH                          02800002
PTR0     LA    DCBREG,4(0,DCBREG)      INCREMENT ADDRESS                02820002
         ST    DCBREG,8(0,LISTRG)       STORE ADDRESS IN RESUME PTR     02840002
IDCHEK   CLC   17(3,TABREG),ZERO       TEST FOR ZERO IN TABLE WORD 5    02860002
         BC    8,EXIT3                  BRANCH IF ZERO                  02880002
BACK     L     GBREG1,0(DCBREG)         LOAD DCB ADDRESS                02900002
         L     GBREG1,DEBADR(GBREG1)    LOAD DEB ADDRESS                02920002
         L     INDXRG,0(DCBREG)         LOAD INDEX FACTOR FOR UCB ADR   02940002
*                                       LOCATED IN DEB                  02960002
         SRL   INDXRG,24                LOCATE INDEX FOR MULTIPLICATION 02980002
         LA    GBREG3,0                 ZERO EVEN REGISTER              03000002
         LA    GBREG4,4                LOAD MULTIPLICAND                03020002
         MR    GBREG3,INDXRG            DETERMINE DEB DISPLACEMENT      03040002
*                                       FACTOR FOR PROPER UCB ADR.      03060002
*                                       PRODUCT IS IN GBREG3 AND GBREG4 03080002
         L     GBREG2,UCBADR(GBREG4,GBREG1)  LOAD UCB ADDRESS           03100002
         TM    GCBADR(GBREG2),X'03'     TEST FOR POSTED GCB             03120002
         BC    5,POSTED                 BRANCH IF EITHER OR BOTH        03140002
*                                       BITS POSTED.                    03160002
         L     GBREG3,0(0,LISTRG)       LOAD DCB LIST PTR               03180002
         L     GBREG3,0(0,GBREG3)      LOAD END OF LIST POINTER         03200002
         LA    GBREG3,0(0,GBREG3)      ZERO HIGH ORDER BYTE             03220002
         CLR   GBREG3,DCBREG           COMPARE PRESENR DCBLST POINTER   03240002
*                                      WITH LAST DCBLST ADDRESS         03260002
         BC    8,LAST1                  BRANCH IF PRESENT EQUAL TO      03280002
*                                       LAST IN LIST                    03300002
         LA    DCBREG,4(0,DCBREG)      INCREMENT POINTER                03320002
COMPAR   L     GBREG6,8(0,LISTRG)      LOAD RESUME PTR                  03340002
         LA    GBREG6,0(0,GBREG6)      ZERO HIGH ORDER BYTE             03360002
         CLR   DCBREG,GBREG6           COMPARE TO SEE IF COMPLETE       03380002
*                                      LIST WAS POLLED                  03400002
         BC    8,EXIT4                  NO GCBS POSTED                  03420002
         BC    15,BACK                                                  03440002
LAST1    L     DCBREG,0(0,LISTRG)       LOAD DCB LIST POINTER           03460002
         LA    DCBREG,4(0,DCBREG)      INCREMENT POINTER                03480002
         BC    15,COMPAR                BRANCH                          03500002
POSTED   LA    GBREG5,4(0,DCBREG)      BUMP PTR TO SERVICE NEXT DCB     03520002
*                                      UPON RE-ENTRY                    03540002
         ST    GBREG5,8(0,LISTRG)      STORE ADR OF NEXT DCBLST ENTRY   03560002
*                                      TO SERVICE IN RESUME PTR         03580002
         L     GBREG5,16(0,TABREG)     LOAD OUTPUT AREA ADDRESS         03600002
         MVC   0(4,GBREG5),SENSE(GBREG2)  MOVE SENSE DATA TO OUTPUT     03620002
         L     GBREG3,0(0,DCBREG)       LOAD DCB ADDRESS                03640002
         ST    GBREG3,4(0,GBREG5)      STORE DCB ADDRESS IN OUTPUT      03660002
         TM    GCBADR(GBREG2),X'01'     TEST FOR KEYBOARD ATTENTION     03680002
         BC    1,TEST0                  BRANCH IF KYBD.ATTN.            03700002
         LA    LISTRG,2                LOAD BIT 6 RESET MASK            03720002
         SLL   LISTRG,24               POSITION BIT MASK                03740002
         AR    LISTRG,DCBREG           ADD DCBLST ADDRESS TO PARAMETER  03760002
         SVC   GASR                    RESET BIT 6 IN GCB               03780002
         LR    REG0,GBREG5             OUTPUT AREA ADDRESS TO REG 0     03800002
         BC    15,NOTKEY                                                03820002
TEST0    LA    LISTRG,1                LOAD BIT 7 RESET MASK            03840002
         SLL   LISTRG,24               POSITION BIT MASK                03860002
         AR    LISTRG,DCBREG           ADD DCBLST ADDRESS TO PARAMETER  03880002
         SVC   GASR                    RESET BIT 7 IN GCB               03900002
         LR    REG0,GBREG5             OUTPUT AREA ADDRESS TO REG 0     03920002
         BC    15,EXIT2                BRANCH                           03940002
NOTKEY   TM    1(GBREG5),X'40'         TEST FOR END OF ORDERS SEQUENCE  03960002
         BC    1,EOS                    BRANCH IF SET                   03980002
         TM    1(GBREG5),X'80'         TEST FOR LITE PEN ATTENTION      04000002
         BC    1,LPA                    BRANCH IF SET                   04020002
         BC    15,EXIT5                BRANCH                           04040002
EXIT1    EQU   *                                                 S21016 04048002
         WTO   'IFF401I ANALYZ FOUND NO POLST ADDRESS IN PARAMETER LISTX04056002
               ',ROUTCDE=11,DESC=7                               S21016 04064002
         LA    ERCODE,24               POLST PARAM MISSING              04072002
         B     LPA+4                   BRANCH                           04080002
EXIT2    LA    ERCODE,4                KYBD                             04100002
         B     LPA+4                   BRANCH                           04120002
EXIT3    EQU   *                                                 S21016 04128002
         WTO   'IFF403I ANALYZ FOUND NO OUTPUT AREA ADDRESS IN ATTENTIOX04136002
               N ROUTINE LIST',ROUTCDE=11,DESC=7                 S21016 04144002
         LA    ERCODE,32               OUTPUT AREA ADDR MISSING  S21016 04152002
         B     LPA+4                   BRANCH                           04160002
EXIT4    LA    ERCODE,16               NONE POSTED                      04180002
         B     LPA+4                   BRANCH                           04200002
EXIT5    EQU   *                                                 S21016 04208002
         WTO   'IFF404I ANALYZ DETERMINED AN ASYNCHRONOUS ERROR ATTENTIX04216002
               ON OCCURRED',ROUTCDE=11,DESC=7                    S21016 04224002
         LA    ERCODE,8                                                 04232002
         B     LPA+4                   BRANCH                           04240002
EXIT6    EQU   *                                                 S21016 04243002
         WTO   'IFF402I ANALYZ FOUND NO ATTENTION ROUTINE LIST',ROUTCDEX04246002
               =11,DESC=7                                        S21016 04249002
         LA    ERCODE,24                                         S21016 04252002
         B     LPA+4                   GO RETURN                 S21016 04255002
EOS      LA    ERCODE,12               EOS                              04260002
         B     LPA+4                   BRANCH                           04280002
LPA      LA    ERCODE,0                LP                               04300002
         LM    LISTRG,GBREG7,24(SAVEREG) RESTORE REGISTERS              04320002
         BCR   15,14                   RETURN                           04340002
         DS    0F                                                       04360002
ZERO     DC    4XL1'00'                 ZERO                            04380002
         CNOP  0,8                                                      04400002
         END                                                            04420002
./  ADD  SSI=72760150,NAME=IFFCAN01
   TITLE  'IFFCAN01    CANCEL KEY ROUTINE'                              00100002
**********************************************************************  00150002
*                                                                       00200002
* MODULE NAME:            IFFCAN01 (OS/VS2)                             00250002
*                                                                       00260002
* DESCRIPTIVE NAME:       CANCEL KEY ROUTINE                            00270002
*                                                                       00280002
* COPYRIGHT:              NONE                                          00290002
*                                                                       00292002
* STATUS:                 RELEASE 2.0                                   00294002
*                                                                       00296002
*                                                                       00298002
******************************CONTINUED* NEXT*PAGE********************  00298400
         EJECT                                                          00298802
*  FUNCTION :                                                           00300000
*         PROVIDE 2250 DISPLAY UNIT CANCEL KEY FUNCTIONS TO THE         00350000
*   TERMINAL USER.  THESE FUNCTIONS INCLUDE TERMINATING HIS PROGRAM,    00500002
*   TERMINATING HIS PROGRAM WITH A SYSTEM/360 CORE DUMP, RESUMING HIS   00600002
*   PROGRAM OR REQUESTING A 2250 BUFFER DUMP                            00700002
*   UPON BEING ENTERED, IFFCAN01 DETERMINES IF A CKCB ALREADY EXISTS.   00800002
*   IF NOT, A GETMAIN IS ISSUED AND THE CKCB INITIALIZED.  A GREADR     00900002
*   MACRO IS ISSUED TO DETERMINE IF THE 2250 BUFFER FOR THIS DEVICE IS  01000002
*   RUNNING.  IF SO, THE RESTART ADDRESS IS SAVED.  AN ASGNBFR IS       01100002
*   ISSUED TO ACQUIRE 2250 BUFFER FOR THE CANCEL KEY MAIN PANEL.  IF    01200002
*   NO BUFFER EXISTS, A GETMAIN IS ISSUED FOR MAIN STORAGE, AND A       01300002
*   PORTION OF THE USER'S BUFFER IS READ INTO THIS AREA WHILE IFFCAN01  01400002
*   IN TURN USES THE NOW AVAILABLE 2250 BUFFER.  A GWRITE IS ISSUED     01500002
*   TO STORE THE MAIN PANEL INTO THE BUFFER.  A SEARCH OF THE TIOT IS   01600002
*   THEN MADE TO DETERMINE IF A SYSBFDMP DD STATEMENT WAS SUPPLIED.  IF 01700002
*   NOT, THE 2250 BUFFER DUMP OPTION IS NOT MADE AVAILABLE TO THE       01800002
*   USER.  IF GJP HAD INITIATED THE PROBLEM PROGRAM, THE RESUME OPTION  01900002
*   IS NOT MADE AVAILABLE TO THE USER.  A GWRITE IS THEN ISSUED AND     02000002
*   BUFFER GENERATION IS STARTED.  IFFCAN01 THEN RETURNS TO ITS CALLER  02100002
*                                                                       02200002
*   IF IFFCAN01 DETERMINES THE CKCB VALID, A LIGHT PEN ATTENTION HAS    02300002
*   BEEN RECEIVED, AND IT SCANS THE UCB SENSE DATA TO DETERMINE WHICH   02400002
*   OPTION HAD BEEN SELECTED BY THE USER.  IF THE BUFFER DUMP OPTION    02500002
*   WAS SELECTED, IFFCAN01 LINKS TO IFFCAN03.  AT THIS TIME, IF THE     02600002
*   USER WAS TAKEN FROM THE BUFFER, HE IS REINSTATED.  A RLSEBUF IS     02700002
*   ISSUED FOR ANY ACQUIRED 2250 BUFFER.  IF THE RESUME OPTION WAS      02800002
*   SELECTED, IFFCAN01 RETURNS TO THE CALLING ROUTINE, RESTARTING THE   02900002
*   BUFFER GENERATION, IF NECESSARY.  ALSO, IF GJP IS IN CONTROL, A     03000002
*   RETURN IS AFFECTED.  IF THE USER REQUESTED TERMINATE, AN ABEND IS   03100002
*   ISSUED.  IF DUMP WAS SELECTED AN ABEND/DUMP IS ISSUED.  IN BOTH     03200002
*   CASES THE ABEND CODE IS 063.                                        03300002
*                                                                       03400002
*ENTRY POINTS ENTERED VIA LINK FROM IFFCAN03                            03500002
*                                                                       03600002
*INPUT REGISTER ONE POINTS TO CKQE                                      03700002
*                                                                       03800002
*EXIT,ERROR IF NO CORE AVAILABLE AFTER GETMAIN, RETURN TO CALLER, RC=4  03900002
*           IF I/O ERROR ON 2250, RETURN TO CALLER, RC=4                04000002
*           IF NO 2250 BUFFER AVAILABLE, RETURN TO CALLER, RC=4         04100002
*ATTRIBUTES TRANSIENT, REENTRANT, PRIVILIGED                            04200002
*INPUT                                                                  04300002
*                                                                       04400002
*OUTPUT DISPLAY ON 2250                                                 04500002
*                        * TERMINATE                                    04600002
*                        * DUMP                                         04700002
*                        * RESUME                                       04800002
*                        * BUFFER DUMP                                  04900002
*                                                                       05000002
         EJECT                                                          05050000
*EXTERNAL REFERENCES 1-GWRITE VIA BALR       7-BUFINQ VIA SVC 71        05100002
*                    2-GCNTRL VIA BALR       8-POST VIA SVC 2           05200002
*                    3-GETMAIN VIA SVC 4     9-FREEMAIN VIA SVC 10      05300002
*                    4-WAIT VIA SVC 1       10-RLSEBFR VIA SVC 71       05400002
*                    5-ASGNBFR VIA SVC 71   11-WTO VIA SVC 35           05500002
*                    6-IFFCAN02 VIA LINK                                05600002
*                                                                       05700002
*EXIT,NORMAL RETURN TO CALLER VIA REGISTER 14                           05800002
*                                                                       05900002
*                                                                       06000002
*TABLES/WORKAREAS CANCEL KEY QUEUE ELEMENT                              06100002
*                 CANCEL KEY CONTROL BLOCK                              06200002
*                                                                       06300002
*                                                                       06400002
*NOTES N/A                                                              06500002
*                                                                       06600002
IFFCAN01 CSECT                                                          06650002
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   06652002
*C108000,111000,164000                                        LF YM4067 06652402
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  06654002
* 522300-522600                                                  A30600 06660002
*0831,132000,135000,363000,366000,369000,375000,543000             3112 06670002
* 128000,144000                                                  A25397 06680002
* 085000,216000-268400,328000,414000-421000,519000                M2878 06690002
* 271000,447000                                                   M2878 06692002
* THIS MODULE RE-WRITTEN FOR RELEASE 20                                 06694002
* C375000,C377000                                                A38916 06696002
* A376500,A376600                                                A38916 06698002
* 231000-236000,274000-275000,417000-418000,462000-467000     LB  AOS/1 06698402
* C291000                                                     LI  AOS/1 06698802
* A291500                                                     LI  AOS/1 06699202
* C383000                                                        A42796 06699602
* A157000,A443000-444000,A707000                                  M6619 06699702
* A384000-385000                                                 A44019 06699802
*D145000,D295000,D458000                                      LI A39419 06699902
*A144600-145200,A294600-295200,A383500-422910,A455500         LI A39419 06733202
*A457600-458200,A707200-707800                                LI A39419 06743202
*C147000,C423410                                              LI A39419 06753202
*A279500-279600,A284500-284920,A401500-401600,A405500-405920    OY01294 06763202
*A422370-422390,A422650-422699                                  OY01294 06765202
*D163000,A163500-163600,D190000,A190500-190600               LG Z30AALG 06765300
*D278000,A278500-278600,D242000,A342500-342600               LG Z30AALG 06765400
*D400000,A400500-400600,D422280,A422300-422320               LG Z30AALG 06765500
*D502000,A502500-502600                                      LG Z30AALG 06774100
*A270500,A110500,A157500,A310500,A394500,A454500             LG @ZM2360 06776100
*A476500,A517500,A536500,A536700,A540500,A536600             LG @ZM2360 06778100
*A489500-489997,A499500-499700                               LG @ZM2360 06780100
*C215000-216000                                             D11 ZA06390 06781100
*C002194,C422000,C445000,C510000                            E12 ZA24234 06781500
*C42900,C43700                                              E12 ZA26469 06781900
*A156050-156300,A157100-158060,A270010-271060,A310020-310300E12 ZA26368 06782300
*A394010-394180,A455000-455055,A477000-477065,D48950-489997 E12 ZA26368 06782800
*                                                                       06783800
*                                                                       06784800
*                                                                       06785800
         EJECT                                                          06791402
*                                                                       06800002
*        GENERAL REGISTERS                                              06900002
*                                                                       07000002
R0       EQU   0                                                        07100002
R1       EQU   1                                                        07200002
R2       EQU   2                                                        07300002
R3       EQU   3                                                        07400002
R4       EQU   4                                                        07500002
R5       EQU   5                                                        07600002
R6       EQU   6                                                        07700002
R7       EQU   7                                                        07800002
BASE     EQU   8                                                        07900002
R9       EQU   9                                                        08000002
R10      EQU   10                                                       08100002
R11      EQU   11                                                       08200002
R12      EQU   12                                                       08300002
R13      EQU   13                                                       08400002
R14      EQU   14                                                       08500002
R15      EQU   15                                                       08600002
*                                                                       08700000
*                                                                       08800002
*        EQUATES                                                        08900002
*                                                                       09000002
HEX04    EQU   X'04'                                                    09100002
HEX7F    EQU   X'7F'                                                    09200002
BUFRUN   EQU   X'02'                    SENSE BIT FOR BUFFER     A25397 09300002
*                                            RUNNING             A25397 09400002
ZERO     EQU   0                                                        09500002
WON      EQU   1                                                        09600002
TWO      EQU   2                                                        09700002
THREE    EQU   3                                                        09800002
FOUR     EQU   4                                                        09900002
FIVE     EQU   5                                                        10000002
EIGHT    EQU   8                                                        10100002
TCB      EQU   8                                                        10200002
TIOT     EQU   12                                                       10300002
TWELVE   EQU   12                                                       10400002
THIRTEEN EQU   13                                                       10500002
SIXTEEN  EQU   16                                                       10600002
TWOFOUR  EQU   24                                                       10700002
UCBSENSE EQU   34                                             LF YM4067 10800002
TEB      EQU   28                                                       10900002
RB       EQU   28                                                       11000002
GIOCR    EQU   33             DISP OF TEB GIOCR ADDRESS      LG @ZM2360 11050000
UCBRST   EQU   24                                             LF YM4067 11100002
FULLMASK EQU   X'FF'              FF MASK USED TO TURN FLAG BITS A34790 11200002
         EJECT                                                          11500002
*        ON ENTRY IT IS DETERMINED IF THIS IS THE FIRST ENTRY OR SECOND 11600000
*        FOR SECOND ENTRY THE TE WILL CONTAIN MY WORKAREA WITH AN       11700002
*        ID IN THE FIRST WORD.                                          11800002
*        ON FIRST ENTRY A GETMAIN IS DONE AND THE WORK AREA IS INITIAL- 11900002
*        IZED.  A GREADR XYP IS USED TO SEE IF THE BUFFER IS RUNNING    12000002
*        BECAUSE IT DOES NOT STOP THE BUFFER FIRST.  THEREFORE THE      12100002
*        SUCCESSFUL COMPLETION FLAG OF THE ECB WILL TELL IF THE BUFFER  12200002
*        IS RUNNING.  IF NOT SUCCESSFUL THE BUFFER IS.                  12300002
*                                                                       12400002
         SAVE  (14,12)                                                  13460002
         BALR  BASE,0                   ESTABLISH ADDRESSABILITY        13500002
         USING *,BASE                                                   13600002
         B     *+24                                                     13650002
MODID    DC    C'IFFCAN01.VS2R2.77275'          MODULE EYECATCHER ID    13660000
*                                                                       13700002
* REGISTER 1 CONTAINS POINTER TO CKQE                                   13800002
*                                                                       13900002
         TM    FIVE(R1),HEX04      TEST FLAG BITS OF CKQE TO DETERMINE  14000002
         BO    CAN040                   IF FIRST ENTRY. NO BRANCH M2878 14100002
         LA    R2,EIGHT(R1)        SET POINTER TO AREA ADDRESS          14200002
         LR    R11,R1              SET UP BASE FOR CKQE                 14300002
         USING CKQE,R11                                                 14400002
         LA    R1,16(R1)               PT TO LIST IN CKQE     LI A39419 14460002
         GETMAIN  EC,LV=CKBLGTH,A=(2),SP=250,MF=(E,(1))    E12 @ZA24234 14520000
         LTR   R15,R15                  ANY SPACE AVAILABLE        3112 14600002
         BNZ   CANERR1                 GO ISSUE ERROR MSG     LI A39419 14700002
         L     R9,ZERO(R2)                                              14800002
         USING CKCB,R9             SET UP ADDRESSABILITY                14900002
         XC    CKCB(CKBLGTH),CKCB  CLEAR GETMAIN AREA                   15000002
         LA    R6,CKCBSVAR        LOAD SAVEAREA ADDRESS          A34790 15100002
         ST    R6,8(R13)           CHAIN SAVE AREAS                     15200002
         ST    R13,4(R6)                                                15300002
         LR    R13,R6                                                   15400002
         OI    CKQEFLG1,CKFCKCB   SET CKCB INVALID FLAG          A34790 15500002
         L     R3,CKQEDCB         GET DCB ADDRESS                A34790 15600002
         SR    R15,R15                 CLR REGISTER         E12 ZA26368 15610000
         ICM   R15,THREE,CKQEUCB   GET UCB ADDRESS          E12 ZA26368 15620000
         L     R15,TEB(R15)   GET TEB ADDRESS               E12 ZA26368 15630000
         L     R1,CKQEDCB     GET DCB ADDR                  E12 ZA26368 15640000
         CLC   GIOCR(3,R15),49(R1)  ADDR IN DCB CORRECT     E12 ZA26368 15650000
         BNE   CANERR9        NO,ISSUE ERROR MSG            E12 ZA26368 15660000
         MVC   CKDCBSTR(4),SIXTEEN(R3)   SAVE DCB BFR START ADDR  M6619 15700002
         MVC   CKCBECB+1(3),GIOCR(R15)  ADDRESS OF GIOCR    E12 ZA26368 15720000
*        GREADR     CKCBDECB,SEN,(3),CKCBWRKA,MF=E          E12 ZA26368 15750000
         SR    15,15              CLEAR REGISTER            E12 ZA26368 15760000
         LA    1,CKCBDECB         PARAMETER LIST            E12 ZA26368 15770000
         ST    15,4(0,1)          CLEAR TYPE AREA IN DECB   E12 ZA26368 15780000
         MVI   4(1),X'18'         SENSE TYPE TO DECB        E12 ZA26368 15790000
         LA    15,0(3)            DCB ADDRESS               E12 ZA26368 15800000
         ST    15,8(0,1)          DCB ADDRESS IN DECB       E12 ZA26368 15810000
         LA    15,CKCBWRKA        AREA ADDRESS              E12 ZA26368 15820000
         ST    15,12(0,1)         AREA ADDRESS IN DECB      E12 ZA26368 15830000
         XC    0(4,1),0(1)        CLEAR ECB                 E12 ZA26368 15840000
         L     15,CKCBECB         GET SAFE GIOCR ADDRESS    E12 ZA26368 15850000
         DS    0H                                           E12 ZA26368 15860000
         BALR  14,15              BRANCH TO GIOCR           E12 ZA26368 15870000
         BAL   R12,CANIO          GO CHECK I/O                   A34790 15900002
         TM    CKCBWRKA,BUFRUN    IS BUFFER RUNNING              A34790 16000002
         BNO   CAN010                   IF NOT TAKE BRANCH       A25397 16100002
         OI    CKQEFLG1,CKFBFRUN  SET BUFFER RUNNING FLAG        A34790 16200002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 16350000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 16360000
         MVC   CKCBREST+TWO(TWO),UCBRST(R7)  RESTART IN CKCB  LF YM4067 16400002
*                                                                A34790 16500002
         EJECT                                                          16600002
*        BUFFER IS OBTAINED EITHER BY AN ASGNBFR OR A BUFFER INQ        16700002
*        FOLLOWED BY ROLLING OUT THE USER PICTURE.                      16800002
*        THE DISPLAY IS WRITTEN OUT.  IF THE CALL WAS FROM GJP THEN     16900002
*        THE RESUME OPTION IS BLANKED BY WRITING OVER THE SET MODE.     17000002
*        THEN IF NOT GJP THE PROBLEM PROGRAM IS SET INTO A WAIT         17100002
*        STATE AND THE ROUTINE EXITS.                                   17200002
*                                                                       17300002
CAN010   LA    R5,LEN                                                   17400002
         STH   R5,CKCBBFLG        SET UP BUFFER LENGTH           A34790 17500002
         ASGNBFR (R3),CKCBBFLG,MF=(E,CKCBWRKA)                   A34790 17600002
         LTR   R15,R15             AVAILABLE                            17700002
         BNE   CAN030              NO-GO ROLL OUT OF USER OWNED BUFFER  17800002
         LH    R5,SIXTEEN(R3)   GET BUFFER ADRESS                       17900002
         STH   R5,CKCBBFAD        SAVE IT                        A34790 18000002
CAN020   LA    R4,ODERLNTH    GET LENGTH                                18100002
         LA    R5,ORDERS      AREA ADDRESS                              18200002
         LA    R6,CKCBBFAD        BUFADR IN DECB                 A34790 18300002
         BAL   R7,CANWRITE    GO WRITE TO BUFFER                        18400002
         EJECT                                                          18500002
*                                                                       18600002
* CHECK TIOT TO DETERMINE IF SYSBFDMP DD CARD AVAILABLE. IF NOT, DO     18700002
* NOT ALLOW 2250 BUFFER DUMP OPTION.                                    18800002
*                                                                       18900002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 19050000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 19060000
         L     R7,TEB(R7)    CONTROL BLOCK SEARCHING TCB PTR            19100002
         L     R7,TCB(R7)      TCB POINTER                              19200002
         L     R7,TIOT(R7)     TIOT ADDRESS                             19300002
*                                                                       19400002
* REGISTER SEVEN POINTS TO TIOT. FIRST SIX WORDS ARE CONTROL INFOR-     19500002
* MATION. SET POINTER (R7) TO BYPASS THIS AND BEGIN SEARCH OF DD        19600002
* NAMES FOR SYSBFDMP.                                                   19700002
*                                                                       19800002
         LA    R7,TWOFOUR(R7)      BYPASS JOB AND STEP NAMES            19900002
CAN021D3 EQU   *                                                        20000002
         CLC   ZERO(FOUR,R7),ZEROS   IS THIS END OF TIOT                20100002
         BNE   CAN021               YES, SET NOP BLANK 2250 DUMP OPTION 20200002
*                                                                       20300002
* BUFFER DUMP DD CARD NOT FOUND. COMPUTE ADDRESS WHER NOP ORDER WILL    20400002
* BE STORED TO BLANK BUFFER DUMP OPTION.                                20500002
*                                                                       20600002
         LH    R7,CKCBBFAD        GET BUFFER ADDRESS             A34790 20700002
         LA    R7,D2250(R7)   ADD DISPLACEMENT                          20800002
         STH   R7,CKCBWRKA        SET UP FOR GWRITE              A34790 20900002
         LA    R4,TWO         GET LENGTH                                21000002
         LA    R5,GNOP        AREA ADDRESS                              21100002
         LA    R6,CKCBWRKA        ADDRESS ON DECB                A34790 21200002
         BAL   R7,CANWRITE    GO WRITE TO BUFFER                        21300002
         B     CAN021D5   BRANCH TO CHECK FOR RESUME OPTION             21400002
CAN021   SR    R6,R6               CLEAR FOR IC             D11 ZA06390 21500000
         IC    R6,0(R7)            GET NXTENTRY LEN         D11 ZA06390 21600000
         CLC   FOUR(EIGHT,R7),SYSBFDMP   CHECK FOR DD CARD              21700002
         BE    CAN021D5            IF FOUND, BRANCH                     21800002
         AR    R7,R6          SET POINTER TO NEXT ENTRY                 21900002
         B     CAN021D3       BRANCH TO CONTINUE SEARCH                 22000002
         EJECT                                                          22100002
*                                                                       22200002
* NOW DETERMINE IF RESUME OPTION IS TO BE DISPLAYED                     22300002
*                                                                       22400002
CAN021D5 LH    R6,CKCBBFAD        GET BUFFER ADDRESS             A34790 22500002
         N     R6,CLEAR           ZERO HIGH ORDER BYTES          A34790 22600002
         LA    R7,REP(R6)     COMPUTE AREA FOR NOP IN GR ORDERS         22700002
         STH   R7,CKCBWRKA                                       A34790 22800002
         LA    R6,LEN(R6)     COMPUTE STARTING ADDRESS                  22900002
         STH   R6,CKCBWRKA+TWO                                   A34790 23000002
*                                                                       23700002
* BLANK BUFFER DUMP IN PROGRESS MESSAGE                                 23800002
*                                                                       23900002
CAN022   LA    R4,TWO         GET LENGTH                                24000002
         LA    R5,GNOP        AREA ADDRESS                              24100002
         LH    R6,CKCBBFAD        GET BUFFER ADDRESS             A34790 24200002
         N     R6,CLEAR           ZERO HIGH ORDER BYTES          A34790 24300002
         LA    R6,BUFFGO(R6)  COMPUTE ADDRESS OF THIS MESSAGE           24400002
         STH   R6,CKCBWRKA        STORE IN AREA                  A34790 24500002
         LA    R6,CKCBWRKA        ADDRESS IN DECB                A34790 24600002
         BAL   R7,CANWRITE    GO WRITE TO BUFFER                        24700002
*                                                                       24800002
* CHECK IF BUFFER DUMP UNSUCCESSFUL SHOULD BE DISPLAYED                 24900002
*                                                                       25000002
         LH    R6,CKCBBFAD        GET BUFFER   ADDRESS           A34790 25100002
         N     R6,CLEAR           ZERO HIGH ORDER BYTES          A34790 25200002
         LA    R6,BUFFNOGO(R6) COMPUTE ADDRESS OF THIS MESSAGE          25300002
         STH   R6,CKCBWRKA        STORE IN AREA                  A34790 25400002
         LA    R6,CKCBWRKA        ADDRESS IN DECB                A34790 25500002
         TM    CKQEFLG2,CKFBDFAL  ERROR ON BUFFER DUMP           A34790 25600002
         BO    CAN0221            IF YES BRANCH AND DISP MSG     A34790 25700002
         BAL   R7,CANWRITE        GO TO WRITE BUFFER             A34790 25800002
         B     CAN023             BRANCH AROUND ERROR MSG        A34790 25900002
CAN0221  LA    R5,GECP            UNBLANK BUFF DUMP ERR MSG      A34790 26000002
         BAL   R7,CANWRITE     GO TO WRITE TO BUFFER                    26100002
         EJECT                                                          26200002
* THIS WRITE UPDATES THE GTRU BRANCH ADDRESS TO POINT TO THE START OF   26300002
* THE DISPLAY AND STARTS BUFFER GENERATION.                             26400002
CAN023   NI    CKQEFLG2,FULLMASK-CKFBDFAL  TURN ERR IND OFF      A34790 26500002
         XC    CKCBDECB(FOUR),CKCBDECB  CLEAR ECB                A34790 26600002
         LH    R2,CKCBBFAD        GRET BUFFER ADDRESS            A34790 26700002
         N     R2,CLEAR           ZERO HIGH ORDER BUTES          A34790 26800002
         LA    R2,RETURN-ORDERS+2(R2) GET ORDER PROG START ADDR  A34790 26900002
         STH   R2,CKCBWRKA+2      STORE GTRU LOC FOR RESTART     A34790 27000002
*        GWRITE CKCBDECB,STR,,2,CKCBBFAD,CKCBWRKA+TWO,CKCBBFAD,MF=E     27008000
         SR    15,15               CLEAR REGISTER           E12 ZA26368 27016000
         LA    1,CKCBDECB          PARAMETER LIST           E12 ZA26368 27024000
         MVI   4(1),X'A0'          BUF TYPE CODE IN DECB    E12 ZA26368 27032000
         MVI   5(1),X'6C'          STR TYPE CODE IN DECB    E12 ZA26368 27040000
         L     15,=A(2)                                     E12 ZA26368 27050000
         ST    15,20(0,1)          LENGTH IN DECB           E12 ZA26368 27100000
         LA    15,CKCBBFAD         AREA ADDRESS             E12 ZA26368 27109000
         ST    15,12(0,1)          AREA ADDRESS IN DECB     E12 ZA26368 27118000
         LA    15,CKCBWRKA+TWO     BUFFER ADDRESS           E12 ZA26368 27127000
         ST    15,28(0,1)          BUFFER ADDRESS IN DECB   E12 ZA26368 27136000
         LA    15,CKCBBFAD         START ADDRESS            E12 ZA26368 27145000
         ST    15,24(0,1)          START ADDRESS IN DECB    E12 ZA26368 27154000
         XC    0(4,1),0(1)         CLEAR ECB                E12 ZA26368 27163000
         L     15,CKCBECB          GET GIOCR ADDRESS        E12 ZA26368 27172000
         BALR  14,15               BRANCH TO ENTRY          E12 ZA26368 27181000
*                                                                A34790 27200002
         EJECT                                                          27250002
         BAL   R12,CANIO          GO CHECK I/O                          27300002
         TM    CKQEFLG2,CKFWTCNT  HAS WAIT CNT BEEN INCR BEFORE  A34790 27600002
         BO    CAN024             DO NOT INCR WAIT COUNT         A34790 27700002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 27850000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 27860000
         L     R7,TEB(R7)               GET TEB POINTER           M2878 27900002
         L     R6,TWOFOUR(R7)      GET GAR IRB ADDRESS          OY01294 27950002
         LA    R6,0(R6)            CLEAR HI-ORDER BYTE          OY01294 27960002
         L     R7,TCB(R7)               GET TCB POINTER           M2878 28000002
         L     R7,ZERO(R7)              GET ADDRESS OF OUR RB     M2878 28100002
         L     R7,RB(R7)                GET ADDRESS OF IFFCAN03'S M2878 28200002
*                                            RB                   M2878 28300002
         L     R7,RB(R7)                GET ADDRESS OF USER'S RB  M2878 28400002
         LA    R7,0(R7)            CLEAR HI-ORDER BYTE          OY01294 28450002
         CLR   R6,R7               IS THIS GAR'S IRB?           OY01294 28460002
         BNE   CAN0231             IF NO,INCREMENT...           OY01294 28470002
*                                  ...WAIT COUNT.               OY01294 28480002
         L     R7,RB(R7)           GET NEXT RB ADDRESS.         OY01294 28490002
CAN0231  EQU   *                                                OY01294 28492002
         SR    R6,R6                    CLEAR REGISTER            M2878 28500002
         IC    R6,RB(R7)                GET WAIT COUNT            M2878 28600002
         LA    R6,WON(R6)               INCREMENT BY ONE          M2878 28700002
         STC   R6,RB(R7)                RESTORE IN RB             M2878 28800002
         OI    CKQEFLG2,CKFWTCNT   SET WAIT CNT INCREMENTED FLAG A34790 28900002
CAN024   OI    CKQEFLG1,CKFATTWT  SET L.P. ATTN EXPECTED FLAG    A34790 29000002
         L     R13,CKCBSVAR+FOUR  RESTORE CALLERS SAVE AREA   LI  AOS/1 29060002
CAN025   EQU   *                                              LI  AOS/1 29120002
         RETURN (14,12),RC=0      RESTORE CALLERS SAVE AREA      A34790 29200002
         EJECT                                                          29300002
CAN030   LA    R7,CKCBROLL     SET PTR TO AREA ADDR FOR R/O      A34790 29400002
         LA    R1,CKCBWORK             PT TO LIST IN CKCB     LI A39419 29460002
         GETMAIN  EC,LV=256,A=(7),SP=0,MF=(E,(1))             LI A39419 29520002
         LTR   R15,R15                  ANY SPACE AVAILABLE        3112 29600002
         BNZ   CANERR1     NO, BRANCH FOR WTO                           29700002
         OI    CKQEFLG2,CKFROLBF  SET GETMAIN INDICATOR          A34790 29800002
         L     R7,CKCBROLL     GET BUFFER ADDRESS                A34790 29900002
         BUFINQ (R3),CKCBWRKA,8,MF=(E,(7))                       A34790 30000002
         C     R15,HEX20           SHORT LIST RETURN CODE               30100002
         BE    TSTENTRY            YES BRANCH AROUND ZERO TEST          30200002
         LTR   R15,R15                  RETURN CODE FROM BUFINQPTM 2320 30300002
*                                       ZERO FOR VALID REQUEST PTM 2320 30400002
         BNZ   CANERR3     IF NOT, BRANCH                               30500002
         EJECT                                                          30550002
TSTENTRY CLC   CKCBWRKA+FOUR(FOUR),FFS   IS THERE AN ENTRY       A34790 30600002
         BE    CANERR3     NO, WE'RE STUCK                              30700002
         LH    R6,CKCBWRKA+FOUR   FET BUFFER IN USE              A34790 30800002
         STH   R6,CKCBBFAD        SET AS OUR BUFFER ADDRESS      A34790 30900002
         XC    CKCBDECB(FOUR),CKCBDECB  CLEAR ECB                A34790 31000002
*        GREAD CKCBDECB,BUF,,256,(R7),CKCBBFAD,MF=E READ    E12 ZA26368 31003000
*                                        USER  FROM BUFFER  E12 ZA26368 31006000
         SR    15,15              CLEAR REGISTER            E12 ZA26368 31009000
         LA    1,CKCBDECB         PARAMETER LIST            E12 ZA26368 31012000
         ST    15,4(0,1)          CLEAR TYPE AREA IN DECB   E12 ZA26368 31015000
         MVI   4(1),X'80'           BUF TYPE CODE TO DECB   E12 ZA26368 31018000
         L     15,=A(256)         GET LENGTH                E12 ZA26368 31021000
         ST    15,20(0,1)         STORE LENGTH IN DECB      E12 ZA26368 31024000
         LA    15,0(R7)           GET AREA ADDRESS          E12 ZA26368 31027000
         ST    15,12(0,1)         STORE IN DECB             E12 ZA26368 31030000
         LA    15,CKCBBFAD        GET BUFFER ADDRESS        E12 ZA26368 31033000
         ST    15,28(0,1)         STORE IN DECB             E12 ZA26368 31036000
         XC    0(4,1),0(1)        CLEAR ECB                 E12 ZA26368 31039000
         L     15,CKCBECB         GET GIOCR ADDRESS         E12 ZA26368 31042000
         BALR  14,15              BRANCH TO ENTRY POINT     E12 ZA26368 31045000
         BAL   R12,CANIO          GO CHECK I/O                          31300002
         OI    CKQEFLG2,CKFROLUT  SET BUFFER R/O FLAG            A34790 31400002
         B     CAN020                   GO DO THE REST                  31500002
         EJECT                                                          31600002
*        SECOND ENTRY DETERMINES WHAT WAS DESIRED.                      31700002
*        IF TERMINATE OR DUMP THE BUFFER IS FREED AND                   31800002
*        IF TERMINATE THE BUFFER IS FREED OR ROLLED BACK OUT.           31900002
*        THEN THE RETURN CODE IS SET AND RETURN                         32000002
*        IF RESUME THE PICTURE IS RESTARTED, AND THE PROBLEM PROGRAM    32100002
*        IS TAKEN OUT OF THE WAIT STATE.                                32200002
CAN040   LR    R11,R1         SET UP ADDRESSABILITY FOR CKQE            32300002
         USING CKQE,R11                                                 32400002
         L     R9,CKQECKCB    SET UP ADDRESSABILITY FOR CKCB     A34790 32500002
         USING CKCB,R9                                                  32600002
         LA    R6,CKCBSVAR        CHAIN SAVEAREAS                A34790 32700002
         ST    R6,EIGHT(R13)  SAVE                                      32800002
         ST    R13,FOUR(R6)    AREAS                                    32900002
         LR    R13,R6                                                   33000002
         L     R3,CKQEDCB         GET DCB ADDRESS                A34790 33100002
*                                                                       33200002
* NOW DETERMINE WHICH OPTION WAS SELECTED BY THE USER.  ONE OF THE      33300002
* FOLLOWING ACTIONS IS TAKEN DEPENDENT UPON THE USER'S SELECTION:       33400002
*                   1-TERMINATE-ISSUE ABEND, CODE 063, NO DUMP          33500002
*                   2-DUMP-ISSUE ABEND, CODE 063, DUMP                  33600002
*                   3-RESUME-RESTART USER DISPLAY                       33700002
*                   4-BUFFER DUMP-LINK TO IFFCAN02; UPON RETURN         33800002
*                     REDISPLAY OUR MENU                                33900002
         NI    CKQEFLG1,FULLMASK-CKFATTWT  TURN OFF LIGHT PEN           34000002
*                                        EXPECTED FLAG           A34790 34100002
         SR    R10,R10                 CLEAR REGISTER        LG Z30AALG 34250000
         ICM   R10,THREE,CKQEUCB       GET UCB ADDRESS       LG Z30AALG 34260000
         LH    R6,CKCBBFAD        GET BUFFER ADDREESS            A34790 34300002
         N     R6,CLEAR           ZERO TWO LOW ORDER BYTES OF REGA34790 34400002
         LA    R7,D2250(R6)   COMPUTE MIN BFR LOC FOR BUFF DUMP         34500002
         MVC   CKCBBFDP(TWO),UCBSENSE(R10)  STORE SENSE IN CKCB  A34790 34600002
         CH    R7,CKCBBFDP        IS BUFF DUMP OPTION SELECTED   A34790 34700002
         BH    CAN044             NO,BRANCH TO CONTINUE SEARCH   A34790 34800002
         EJECT                                                          34900002
*                                                                       35000002
* BUFFER DUMP OPTION SELECTED.  PREARE MESSAGE AND GO TO IFFCAN02       35100002
*                                                                       35200002
         LA    R4,TWO          GET LENGTH                               35300002
         LA    R5,GECP          AREA ADDRESS                            35400002
         LH    R6,CKCBBFAD        GET BUFFER   ADDRESS           A34790 35500002
         N     R6,CLEAR           CLEAR HIGH ORDER BYTES         A34790 35600002
         LA    R6,BUFFGO(R6)   COMPUTE ADRESS OF THIS MESSAGE           35700002
         STH   R6,CKCBWRKA        STORE IN AREA                  A34790 35800002
         LA    R6,CKCBWRKA        ADDRESS IN DECB                A34790 35900002
         BAL   R7,CANWRITE     GO TO WRITE TO BUFFER                    36000002
         LA    R1,CANMSGS     GET POINTER TO ERROR MESSAGES             36100002
         ST    R1,CKCBERMT        PUT IN WORKAREA                A34790 36200002
         LR    R1,R11         PREPARE CKQE PTR                          36300002
         LINK  EP=IFFCAN02,MF=(E,(1))    GO TO DUMP PROGRAM             36400002
         LTR   R15,R15         IS RETURN CODE ZERO                      36500002
         BZ    CAN022             IF YES BRANCH                  A34790 36600002
         OI    CKQEFLG2,CKFBDFAL  ERROR ON BUFFER DUMP           A34790 36700002
         B     CAN022             BRANCH TO MSG ROUTINR          A34790 36800002
         EJECT                                                          36900002
CAN044   OI    CKQEFLG1,CKFEXIT    TURN ON EXIT IN PROCESS BIT   A34790 37000002
CAN045   TM    CKQEFLG2,CKFROLUT  CHECK IF BUFFER ROOLED OUT     A34790 37100002
         BO    CAN060         IF YES, BRANCH TO BRING IT BACK           37200002
         TM    CKQEFLG2,CKFROLBF  HAS BUFFER BEEN GOTTEN         A34790 37300002
         BO    CAN061             IF YES, GO FREE IT             A34790 37400002
         CLC   CKCBBFAD(FOUR),ZEROS   HAS BUFFER BEEN GOTTEN      CRB   37500002
         BE    CAN047                 NO DON'T RELEASE BUFFER     CRB   37600002
         EJECT                                                          37700002
*                                                                       37800002
* BUFFER HAS NOT BEEN ROLLED OUT.  RELEASE ANY ACQUIRED BUFFER BEFORE   37900002
* ANYTHING ELSE.                                                        38000002
*                                                                       38100002
         L     R3,CKQEDCB             GET DCB ADDRESS             CRB   38200002
         RLSEBFR  (R3),CKCBBFAD,MF=(E,CKCBWRKA)  FREE BUFFER     A42796 38300002
         MVC   CKCBBFAD(FOUR),ZEROS    CLEAR CKCBBFAD FIELD   LI A39419 38350002
         C     R15,HEX14                                         A44019 38400002
         BE    CAN047                   BRANCH IF GOOD RELEASE   A44019 38500002
         LTR   R15,R15                  RELEASE BUFFER GOOD      A38916 38600002
         BNZ   CANERR8                NO, BRANCH TO ERROR MSG     CRB   38700002
CAN047   LA    R7,REP(R6)    SET MIN BFR ADDRESS FOR RESUME       CRB   38800002
         CH    R7,CKCBBFDP        IS RESUME OPTION SELECTED      A34790 38900002
         BH    CAN048      IF NO, BRANCH                                39000002
         TM    CKQEFLG1,CKFBFRUN   WAS FBUFFER RUNNING           A34790 39100002
         BZ    CAN047D1       IF NOT, BRANCH                            39200002
         NI    CKQEFLG1,FULLMASK-CKFBFRUN   ZERO THIS BIT        A34790 39300002
         XC    CKCBDECB(FOUR),CKCBDECB   CLEAR ECB               A34790 39400002
*        GCNTRL  CKCBDECB,STR,,CKCBREST+TWO,MF=E RSTRT USER E12 ZA26368 39404000
         SR    15,15                 CLEAR REGISTER         E12 ZA26368 39408000
         LA    1,CKCBDECB             PARAMETER LIST        E12 ZA26368 39412000
         ST    15,4(0,1)             CLEAR TYPE IN DECB     E12 ZA26368 39416000
         MVI   4(1),X'6C'            STR TYPE CODE IN DECB  E12 ZA26368 39420000
         LA    15,CKCBREST+TWO       AREA ADDRESS           E12 ZA26368 39424000
         ST    15,24(0,1)            STORE IN DECB          E12 ZA26368 39428000
         XC    0(4,1),0(1)           CLEAR ECB              E12 ZA26368 39432000
         L     15,CKCBECB            GET GIOCR ADDRESS      E12 ZA26368 39436000
         BALR  14,15                 BRANCH TO ENTRY POINT  E12 ZA26368 39440000
         BAL   R12,CANIO          CHECK FOR GOOD I/O             A34790 39600002
         EJECT                                                          39650002
CAN047D1 TM    CKQEFLG2,CKFWTCNT   HAS WAIT COUNT BEEN MODIFIED  A34790 39700002
         BNO   CAN048D3           IF NO, DON'T DECREMENT         A34790 39800002
         NI    CKQEFLG2,FULLMASK-CKFWTCNT  TURN OFF FLAG         A34790 39900002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 40050000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 40060000
         L     R7,TEB(R7)               GET TEB ADDRESS           M2878 40100002
         L     R6,TWOFOUR(R7)      GET GAR'S IRB ADDRESS        OY01294 40150002
         LA    R6,0(R6)            CLEAR HI-ORDER BYTE          OY01294 40160002
         L     R7,TCB(R7)               GET TCB ADDRESS           M2878 40200002
         L     R7,ZERO(R7)              GET OUR RB ADDRESS        M2878 40300002
         L     R7,RB(R7)                GET IFFCAN03'S RB ADDRESS M2878 40400002
         L     R7,RB(R7)                GET USER'S RB ADDRESS     M2878 40500002
         LA    R7,0(R7)            CLEAR HI-ORDER BYTE          OY01294 40550002
         CLR   R6,R7               IS THIS GAR'S IRB?           OY01294 40560002
         BNE   CAN047D2            IF NO,DECREMENT IRB....      OY01294 40570002
*                                  ...WAIT COUNT.               OY01294 40580002
         L     R7,RB(R7)           GET NEXT RB ADDRESS.         OY01294 40590002
CAN047D2 EQU   *                                                OY01294 40592002
         SR    R6,R6                    CLEAR REGISTER            M2878 40600002
         IC    R6,RB(R7)                GET USERS WAIT COUNT      M2878 40700002
         BCTR  R6,0                     DECREMENT IT BY ONE       M2878 40800002
         STC   R6,RB(R7)          RESTORE USERS WAIT COUNT       A34790 40900002
         B     CAN048D3       BRANCH TO FREE STORAGE                    41000002
CAN048   TM    CKQEFLG1,CKFEXIT   OPTIN SELECTED                 A34790 41100002
         BNO   CANEXIT            NO, GO FREE CKCB               A34790 41200002
         LA    R7,DMP(R6)  COMP MIN BUFFER ADDRESS FOR DUMP OPT. A34790 41300002
         CH    R7,CKCBBFDP        IS TERM OPTION SELECTED        A34790 41400002
         BH    CAN048D1       NO, BRANCH                                41500002
         OI    CKQEFLG1,CKFABDMP  SET DUMP BIT                   A34790 41600002
CAN048D1 EQU   *                                              LB  AOS/1 41700002
         OI    CKQEFLG1,CKFDEQUE  SET DE-QUE BIT                 A34790 41900002
         NI    CKQEFLG1,FULLMASK-CKFCKCB TURN OFF CKCB VALID FLG A34790 42000002
         L     R13,FOUR(R13)  SET FREEMAIN AREA                         42100002
         FREEMAIN R,LV=CKBLGTH,A=(9),SP=250                E12 @ZA24234 42200000
         EJECT                                                          42202002
         TM    CKQEFLG2,CKFWTCNT       HAS WAIT COUNT UPED    LI A39419 42207002
         BNO   CAN048D4                IF NO DON'T DECREMENT  LI A39419 42214002
         NI    CKQEFLG2,FULLMASK-CKFWTCNT  TURN OFF FLAG      LI A39419 42221002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 42230000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 42232000
         L     R7,TEB(R7)              GET TEB ADDRESS        LI A39419 42235002
         L     R6,TWOFOUR(R7)      GET GAR'S IRB ADDRESS        OY01294 42237002
         LA    R6,0(R6)            CLEAR HI-ORDER BYTE          OY01294 42239002
         L     R7,TCB(R7)              GET TCB ADDRESS        LI A39419 42242002
         L     R7,ZERO(R7)             GET OUR RB ADDRESS     LI A39419 42249002
         L     R7,RB(R7)               GET IFFCAN03 RB ADDRESSLI A39419 42256002
         L     R7,RB(R7)               GET USER RB ADDRESS    LI A39419 42263002
         LA    R7,0(R7)            CLEAR HI-ORDER BYTE          OY01294 42265002
         CLR   R6,R7               IS THIS GAR'S IRB?           OY01294 42267002
         BNE   CAN048D5            IF NO,DECREMENT IRB...       OY01294 42269002
*                                  ... WAIT COUNT.              OY01294 42269402
         L     R7,RB(R7)           GET NEXT RB ADDRESS          OY01294 42269802
CAN048D5 EQU   *                                                OY01294 42269902
         SR    R6,R6                   CLEAR REGISTER         LI A39419 42270002
         IC    R6,RB(R7)               GET USER WAIT COUNT    LI A39419 42277002
         BCTR  R6,0                    DECREMENT BY 1         LI A39419 42284002
         STC   R6,RB(R7)               RESTORE USER WAIT COUNTLI A39419 42291002
CAN048D4 TM    CKQEFLG1,CKFABDMP       IS THIS DUMP           LI A39419 42341002
         BO    CAN048D2       IF YES, BRANCH                            42400002
         WTO   'IFF006I JOB WAS TERMINATED WITH CANCEL KEY TERMINATE OPX42650002
               TION',ROUTCDE=11,DESC=7                           S21016 42700002
         ABEND 099,,,SYSTEM   NO, SET UP ABEND WITHOUT DUMP E12 ZA26469 42900000
         EJECT                                                          42950002
CAN048D2 EQU   *                                                        43400002
         WTO   'IFF007I JOB WAS TERMINATED WITH CANCEL KEY DUMP OPTION'X43550002
               ,ROUTCDE=11,DESC=7                                S21016 43600002
         ABEND 099,DUMP,,SYSTEM        SET UP ABEND W/DUMP  E12 ZA26469 43700000
*                                                                       43800002
*                                                                       43900002
CAN048D3 NI    CKQEFLG1,FULLMASK-CKFCKCB  SET CKCB VALID BIT OFF A34790 44000002
         OI    CKQEFLG1,CKFDEQUE  SET DEQUE BIT AFTER RESUME     A34790 44100002
         L     R13,FOUR(R13)  RESET SAVE ADDRESS                        44200002
         L     R3,CKQEDCB          LOAD DCB ADDRESS               M6619 44300002
         MVC   SIXTEEN(4,R3),CKDCBSTR RESTORE DCB BFR STRT ADDR   M6619 44400000
         FREEMAIN  R,LV=CKBLGTH,A=(9),SP=250               E12 @ZA24234 44450000
         B     CAN025                   BRANCH TO RETURN          M2878 44600002
         EJECT                                                          44700002
*                                                                       44800002
* USER BUFFER WAS ROLLED OUT.  BRING HIS BUFFER BACK AND FREE AQUIRED   44900002
* STORAGE                                                               45000002
*                                                                       45100002
CAN060   NI    CKQEFLG2,FULLMASK-CKFROLUT  TURN OFF ROLLOUT FLG  A34790 45200002
         L     R7,CKCBROLL        GET PTR TO BUFFER              A34790 45300002
         XC    CKCBDECB(FOUR),CKCBDECB  CLEAR ECB                A34790 45400002
*        GWRITE  CKCBDECB,BUF,,256,(7),CKCBBFAD,MF=E        E12 ZA26368 45450000
         LA    1,CKCBDECB          PARAMETER LIST           E12 ZA26368 45457000
         SR    15,15             CLEAR REGISTER             E12 ZA26268 45464000
         MVI   4(1),X'A0'        BUF TYPE CODE TO DECB      E12 ZA26368 45471000
         L     15,=A(256)        GET LENGTH                 E12 ZA26368 45478000
         ST    15,20(0,1)        STORE IN DECB              E12 ZA26368 45485000
         LA    15,0(7)           GET AREA ADDRESS           E12 ZA26368 45492000
         ST    15,12(0,1)        STORE IN DECB              E12 ZA26368 45499000
         LA    15,CKCBBFAD       GOT BUFFER ADDRESS         E12 ZA26368 45506000
         ST    15,28(0,1)        STORE IN DECB              E12 ZA26368 45513000
         L     15,CKCBECB        GET GIOCR ADDRESS          E12 ZA26368 45520000
         BALR  14,15             BRANCH TO ENTRY POINT      E12 ZA26368 45527000
         MVC   CKCBBFAD(FOUR),ZEROS    CLEAR CKCBBFAD FIELD   LI A39419 45550002
         BAL   R12,CANIO          GO TO CHECK IO                 A34790 45600002
CAN061   LA    R7,CKCBROLL     SET ADDRESS OF AREA TO BR FREED   A34790 45700002
         LA    R1,CKCBWORK             PT TO LIST IN CKCB     LI A39419 45760002
         FREEMAIN  E,LV=256,A=(7),SP=0,MF=(E,(1))             LI A39419 45820002
         NI    CKQEFLG2,FULLMASK-CKFROLBF  TURN OFF R/O GETMN FLGA34790 45900002
         B     CAN047             BRANCH TO TEST SELECTIONS             46000002
         EJECT                                                          46800002
*                                                                       46900002
* THIS WRITE SUBROUTINE IS USED THROUGHOUT PROGRAM TO PUT DATA TO THE   47000000
* BUFFER WITHOUT STARTING GENERATION. INPUT IS AS FOLLOWS:              47100002
*  REGISTER 4: LENGTH OF DATA TO BE WRITTEN                             47200002
*    REGISTER 5; POINTER TO DATA TO BE WRITTEN                          47300002
*   REGISTER 6: BUFFER ADDRESS IN DECB                                  47400002
*                                                                       47500002
CANWRITE XC    CKCBDECB(FOUR),CKCBDECB   CLEAR DECB              A34790 47600002
*        GWRITE  CKCBDECB,BUF,,(4),(5),(6),MF=E  WRT TO BFR E12 ZA26368 47700000
         LA    1,CKCBDECB        PARAMETER LIST             E12 ZA26368 47707000
         SR    15,15             CLEAR REGISTER             E12 ZA26368 47714000
         ST    15,4(0,1)         CLEAR TYPE IN DECB         E12 ZA26368 47721000
         MVI   4(1),X'A0'        BUF TYPE CODE TO DECB      E12 ZA26368 47728000
         LA    15,0(4)           GET LENGTH                 E12 ZA26368 47735000
         ST    15,20(0,1)        STORE IN DECB              E12 ZA26368 47742000
         LA    15,0(5)           GET AREA ADDRESS           E12 ZA26368 47749000
         ST    15,12(0,1)        STORE IN DECB              E12 ZA26368 47756000
         LA    15,0(6)           GET BUFFER ADDRESS         E12 ZA26368 47763000
         ST    15,28(0,1)        STORE IN DECB              E12 ZA26368 47770000
         L     15,CKCBECB        GET GIOCR ADDRESS          E12 ZA26368 47777000
         BALR  14,15             BRANCH TO ENTRY POINT      E12 ZA26368 47784000
         LR    R12,R7      SET RETURN ADDRESS                           47800002
*                                                                       47900002
* CHECK ERROR CODE FROM GIOCR FOR I/O STARTED.  WAIT FOR I/O            48000002
* COMPLETION, CHECK POST CODE, BRANCH ON ERRORS OR RETURN TO CALLER     48100002
*                                                                       48200002
CANIO    LTR   R15,15        CHECK FOR ZERO RETURN CODE                 48300002
         BNZ   CANERR2         IF NOT, BRANCH                           48400002
         LA    R1,CKCBDECB        GET ECB POINTER                A34790 48500002
         WAIT  ECB=(1)       WAIT FOR I/O COMPLETION                    48600002
         CLI   CKCBDECB,HEX7F     I/O GOOD                       A34790 48700002
         BNE   CANERR2           NO, BRANCH                      A34790 48800002
         BR    R12           RETURN TO CALLER                           48900002
*                                                                       49100002
* ERROR HAS BEEN DETECTED.  PUT MESSAGE IN WORKAREA AND ISSUE WTO.      49200002
*                                                                       49300002
CANERR1  MVC   CKCBWRKA(CAN1LN),CANMSG1  PUT MSG IN WKAREA       A34790 49400002
         B     CANSVC               BRANCH TO MOVE UNIT ADDRESS         49500002
CANERR2  MVC   CKCBWRKA(CAN2LN),CANMSG2  PUT MSG IN WKAREA       A34790 49600002
         B     CANSVC               BRANCH TO MOVE UNIT ADDRESS         49700002
CANERR8  MVC   CKCBWRKA(CAN8LN),CANMSG8   PUT MSG IN WKAREA       CRB   49800002
         B     CANSVC               GO GET UNIT ADDRESS                 49900002
CANERR9  EQU   *                                             LG @ZM2360 49950000
         MVC   CKCBWRKA(CAN9LN),CANMSG9 MSG IN WRKAREA       LG @ZM2360 49960000
         B     CANSVC         BRANCH TO SET UNIT ADDRESS     LG @ZM2360 49970000
CANERR3  MVC   CKCBWRKA(CAN3LN),CANMSG3  PUT MSG IN WKAREA       A34790 50000002
CANSVC   LA    R1,CKCBWRKA        GET PARAMETER LIST             A34790 50100002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 50250000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 50260000
         MVC   TWELVE(THREE,R1),THIRTEEN(R7)  PUT UNIT INTO LIST        50300002
         SVC   35      ISSUE WTO                                        50400002
         B     CAN045             GO TO BUFFER R/O CHECK         A34790 50500002
CANEXIT  TM    CKQEFLG1,CKFCKCB   IS CKCB VALID                  A34790 50600002
         BZ    CANRTN              IF NOT, BRANCH TO RETURN             50700002
         NI    CKQEFLG1,FULLMASK-CKFCKCB  SET VALID CKCB FLAG    A34790 50800002
         L     R13,FOUR(R13)       GET SAVE AREA                        50900002
         FREEMAIN  R,LV=CKBLGTH,A=(R9),SP=250              E12 @ZA24234 51000000
CANRTN   OI    CKQEFLG1,CKFDEQUE   MARK CKQE TO BE FREED         A34790 51100002
         B     CAN025             GO TO RETURN TO USER           A34790 51200002
CANMSGS  DC    A(CANMSG1)                                               51300002
         DC    A(CANMSG2)                                               51400002
         DC    A(CANMSG3)                                               51500002
         DC    A(CANMSG4)                                               51600002
         DC    A(CANMSG5)                                               51700002
         DC    A(CANMSG9)                                    LG @ZM2360 51750000
         EJECT                                                          51800002
CANMSG1  WTO   'IFF001I XXX REQUEST IGNORED; LACK OF CORE',MF=L,       ,51900002
               ROUTCDE=(2,11),DESC=4                                    52000002
CANMSG1E EQU   *                                                        52100002
CANMSG2  WTO   '1FF002I XXX REQUEST IGNORED; PERMANENT I/O ERROR',     ,52200002
               MF=L,ROUTCDE=(2,11),DESC=4                               52300002
CANMSG2E EQU   *                                                        52400002
CANMSG3  WTO   'IFF003I XXX REQUEST IGNORED; NO 2250 BUFFER AVAILABLE',,52500002
               MF=L,ROUTCDE=(2,11),DESC=4                               52600002
CANMSG3E EQU   *                                                        52700002
CANMSG4  WTO   'IFF004I XXX REQUEST IGNORED; OPEN FAILURE ON SYSBFDMP',,52800002
               MF=L,ROUTCDE=(2,11),DESC=4                               52900002
CANMSG4E EQU   *                                                        53000002
         EJECT                                                          53050002
CANMSG5  WTO   'IFF005I                                              ',,53100002
               MF=L,ROUTCDE=(2,11),DESC=4                               53200002
CANMSG5E EQU   *                                                        53300002
CANMSG8  WTO   'IFF008I XXX RLSEBFR FAILED IN CANCEL KEY RTN',MF=L,    X53400002
               ROUTCDE=11,DESC=7                                        53500002
CANMSG8E EQU   *                                                        53600002
CANMSG9  WTO   'IFF0009I XXX REQUEST IGNORED;GIOCR ADDRESS NOT IN DCB',X53650000
               MF=L,ROUTCDE=11,DESC=7                        LG @ZM2360 53660000
CANMSG9E EQU   *                                             LG @ZM2360 53670000
CAN1LN   EQU   CANMSG1E-CANMSG1                                         53700002
CAN2LN   EQU   CANMSG2E-CANMSG2                                         53800002
CAN3LN   EQU   CANMSG3E-CANMSG3                                         53900002
CAN8LN   EQU   CANMSG8E-CANMSG8                                         54000002
CAN9LN   EQU   CANMSG9E-CANMSG9  LENGTH OF MESSAGE 9         LG @ZM2360 54050000
         EJECT                                                          54100002
         GINIT                                                          54200002
ORDERS   GSRT                                                           54300002
         GEVM                                                           54400002
         GDV   0,3900,B                                                 54500002
         GECP  L                                                        54600002
         GTXT  '* TERMINATE'                                            54700002
         GCNOP C                                                        54800002
         GEVM                                                           54900002
         GDV   0,3600,B                                                 55000002
DUMP     GECP  L                                                        55100002
         GTXT  '* DUMP'                                                 55200002
         GCNOP C                                                        55300002
         GEVM                                                           55400002
         GDV   0,3300,B                                                 55500002
REPRESS  GECP  L                                                        55600002
         GTXT  '* RESUME'                                               55700002
         GCNOP C                                                        55800002
         GEVM                                                           55900002
         GDV   0,3000,B                                                 56000002
DUMP2250 GECP  L                                                        56100002
         GTXT  '* BUFFER DUMP'                                          56200002
         GCNOP C                                                        56300002
         GEVM                                                           56400002
         GDV   0,2400,B                                                 56500002
DUMPGO   GECP  B                                                        56600002
         GTXT  'IFF101I BUFFER DUMP IN PROGRESS'                        56700002
         GCNOP C                                                        56800002
         GEVM                                                           56900002
         GDV   0,2400,B                                                 57000002
DUMPNOGO GECP  B                                                        57100002
         GTXT  'IFF105I BUFFER DUMP UNSUCCESSFUL'                       57200002
         GCNOP C                                                        57300002
RETURN   GTRU  0                                                        57400002
LEN      EQU   *-ORDERS-2                                               57500002
DMP      EQU   DUMP-ORDERS                                              57600002
REP      EQU   REPRESS-ORDERS                                           57700002
D2250    EQU   DUMP2250-ORDERS                                          57800002
BUFFGO   EQU   DUMPGO-ORDERS                                            57900002
BUFFNOGO EQU   DUMPNOGO-ORDERS                                          58000002
ORDERSE  EQU   *                                                        58100002
ODERLNTH EQU   ORDERSE-ORDERS                                           58200002
GECP     GECP  B                                                        58300002
GNOP     GNOP2                                                          58400002
         EJECT                                                          58500002
*                                                                 M2878 58600002
*                                                                 M2878 58700002
*                        STORAGE CONSTANTS                        M2878 58800002
*                                                                 M2878 58900002
*                                                                 M2878 59000002
         SPACE 2                                                  M2878 59100002
DISABLE  DC    X'00'                    SYSTEM MASK TO REJECT     M2878 59200002
*                                            INTERRUPTS           M2878 59300002
ENABLE   DC    X'FF'                    SYSTEM MASK TO EXCEPT     M2878 59400002
*                                            INTERRUPTS           M2878 59500002
SYSBFDMP DC    C'SYSBFDMP'                                              59600002
HEX14    DC    F'20'                                                    59700002
HEX20    DC    F'32'                                                    59800002
ZEROS    DC    F'0'                                                     59900002
ONE      DC    F'1'                                                     60000002
FFS      DC    X'FFFFFFFF'                                              60100002
CLEAR    DC    X'0000FFFF'        ZERO LOW ORDER BYTES OF REG    A34790 60200002
         LTORG                                                          60300002
          EJECT                                                         60400002
CKQE     DSECT         SYSTEM CANCEL KEY QUEUE ELEMENT                  60500002
         SPACE 2                                                        60600002
CKQECKQE DS    F                        POINTER TO NEXT CKQE ON         60700002
*                                            ACTIVE LIST                60800002
CKQEFLG1 DS    X                        FLAG FIELD BYTE ONE             60900002
CKFGJP   EQU   X'80'                    IS THIS CALL TO SYSTEM CANCEL   61000002
*                                            KEY ROUTINES FROM GJP      61100002
*                                            ABEND HOOK                 61200002
CKFABDMP EQU   X'40'                    A ABEND DUMP IS REQUESTED BY    61300002
*                                            THE 2250 OPERATOR          61400002
CKFATTWT EQU   X'20'                    SYSTEM CANCEL KEY ROUTINES      61500002
*                                            ARE EXPECTING AN ATTENTION 61600002
*                                            FROM DEVICE ASSOCIATED     61700002
*                                            WITH THIS CKQE             61800002
CKFCKCB  EQU   X'10'                    CANCEL KEY CONTROL BLOCK        61900002
*                                            POINTER IS VALID IN CKQE   62000002
CKFEXIT  EQU   X'08'                    EXIT IN PROCESS                 62100002
CKFECB   EQU   X'04'                    GJP ECB POINTER IS VALID IN     62200002
*                                            CKQE AND GJP IS WAITING    62300002
*                                            TO BE POSTED               62400002
CKFDEQUE EQU   X'02'                    SYSTEM CANCEL KEY ROUTINE HAS   62500002
*                                            PERFORMED ALL REQUESTS     62600002
*                                            FOR DEVICE ASSOCIATED      62700002
*                                            WITH THIS CKQE AND THE     62800002
*                                            CKQE SHOULD BE DEQUEUED    62900002
CKFBFRUN EQU   X'01'                    THE 2250 BUFFER WAS RUNNING     63000002
*                                            AT THE TIME THE SYSTEM     63100002
*                                            CANCEL KEY FUNCTION WAS    63200002
*                                            REQUESTED                  63300002
CKQEFLG2 DS    X                        SECOND BYTE OF FLAG FIELD       63400002
CKFROLBF EQU   X'80'                    GETMAIN HAS BEEN ISSUED TO      63500002
*                                            ROLL OUT THE USERS         63600002
*                                            BUFFER SECTION             63700002
CKFROLUT EQU   X'40'                    USERS BUFFER HAS BEEN ROLLED    63800002
*                                            OUT                        63900002
CKFINBUF EQU   X'20'                    GETMAIN FOR INPUT BUFFER FOR    64000002
*                                            BUFFER DUMP REQUEST HAS    64100002
*                                            BEEN ISSUED SUCCESSFULLY   64200002
CKFOPCB  EQU   X'10'                    GETMAIN FOR OUTPUT CONTROL      64300002
*                                            BLOCK HAS BEEN ISSUED      64400002
CKFOPEN  EQU   X'08'                    SYSBFDMP OUTPUT DCB IS OPEN     64500002
CKFLPATN EQU   X'04'                    THIS IS AN ENTRY SCHEDULED      64600002
*                                            BY GAR WITH A LIGHTPEN     64700002
*                                            ATTENTION.                 64800002
CKFWTCNT EQU   X'02'                    THE REQUESTOR OF A        M2878 64900002
*                                            SYSTEM CANCEL KEY    M2878 65000002
*                                            FUNCTION REQUEST     M2878 65100002
*                                            BLOCK'S WAIT COUNT   M2878 65200002
*                                            HAS BEEN INCREMENTED M2878 65300002
*                                            BY ONE               M2878 65400002
CKFBDFAL EQU   X'01'              SET TO ONE IF IFFCAN02 GAVE    A34790 65500002
*                                    A NONZERO RC TO IFFCAN01    A34790 65600002
*                                     INDICATING AN ERROR WHILE  A34790 65700002
*                                    DUMPING THE BUFFER          A34790 65800002
CKQEUCB  DS    H                        UNIT CONTROL BLOCK THAT IS NOW  65900002
*                                            UNDER CONTROL OF THE       66000002
*                                            SYSTEM CANCEL KEY ROUTINES 66100002
CKQECKCB DS    F                        POINTER TO CANCEL KEY CONTROL   66200002
*                                            BLOCK ASSOCIATED WITH THIS 66300002
*                                            CKQE                       66400002
CKQEDCB  DS    F                        POINTER TO THE OPEN DATA        66500002
*                                            CONTROL BLOCK FOR THE      66600002
*                                            DEVICE REQUESTING THE      66700002
*                                            SYSTEM CANCEL KEY FUNCTION 66800002
         EJECT                                                          66900002
CKCB     DSECT         SYSTEM CANCEL KEY CONTROL BLOCK                  67000002
         SPACE 2                                                        67100002
CKCBOPCB DS    F                        ADDRESS OF OUTPUT CONTROL BLOCK 67200002
*                                            ASSOCIATED WITH THIS CKCB  67300002
CKCBECB  DS    F                        ADDRESS OF GJP'S ECB TO BE      67400002
*                                            POSTED WHEN SYSTEM CANCEL  67500002
*                                            KEY FUNCTION REQUESTED BY  67600002
*                                            GJP IS COMPLETE            67700002
CKCBSVAR DS    18F                      SAVE AREA FOR IFFCAN01          67800002
CKCBBFAD DS    H                        BUFFER ADDRESS WHERE SYSTEM     67900002
*                                            CANCEL KEY 256 BYTE BUFFER 68000002
*                                            SECTION STARTS.  OPTION    68100002
*                                            PANEL WILL BE PLACED INTO  68200002
*                                            THIS SECTION               68300002
CKCBBFLG DS    H                        BUFFER LENGTH OF THE DATA       68400002
*                                            WRITTEN TO THE 2250 FOR    68500002
*                                            THE OPTIONS PANEL          68600002
CKCBWRKA DS    CL64                    WORK AREA FOR:                   68700002
*                                            READ MI INPUT              68800002
*                                            READ SENSE INPUT           68900002
*                                            BUFFER INQUIRY TABLE       69000002
*                                            WRITE TO OPERATOR MESSAGES 69100002
CKCBDECB DS    8F                       DATA EVENT CONTROL BLOCK        69200002
*                                            USED IN I/O OPERATIONS     69300002
*                                            TO THE 2250                69400002
CKCBREST DS    F                        ADDRESS OF 2250 RESTART         69500002
*                                            GNERATION OF THE USERS     69600002
*                                            BUFFER PROGRAM             69700002
CKCBROLL DS    F                        ADDRESS OF 256 BYTE AREA USED   69800002
*                                            TO ROLL OUT USERS BUFFER   69900002
*                                            IF NO OTHER BUFFER SPACE   70000002
*                                            AVAILABLE FOR THE DEVICE   70100002
CKCBERMT DS    F                        POINTER TO TABLE OF ERROR       70200002
*                                            MESSAGES TO BE SENT TO     70300002
*                                            THE SYSTEM OPERATOR UPON   70400002
*                                            ERROR CONDITION.           70500002
*                                                                       70600002
CKDCBSTR DS    F                  SAVE AREA FOR DCB BFR STRT ADDR M6619 70700002
CKCBWORK DS    F                       LENGTH FOR E GETMAIN   LI A39419 70720002
         DS    F                       ADDR OF ADDR LIST      LI A39419 70740002
         DS    C                       EC MODE                LI A39419 70760002
         DS    C                       SP VALUE               LI A39419 70780002
CKCBBFDP DS    H                  STOREAGE AREA FOR SENSE DATA   A34790 70800002
*                                    FROM THE UCB ON A LIGHT     A34790 70900002
*                                    PEN ATTENTION               A34790 71000002
CKCBE    EQU   *                                                        71100002
CKBLGTH  EQU   CKCBE-CKCB                                               71200002
         END                                                            71300002
UCBBUF   EQU   24                                                       71400002
UCBTE    EQU   28                  TE PTR IN UCB                        71700002
CAN      EQU   12                  CANCEL WORD IN TE                    72000002
UCBRST   EQU   32                  BUFFER RESTART ADDR IN UCB           72300002
RUN      EQU   X'01'               BUFFER RUN BIT IN SW                 72600002
ROLL     EQU   X'02'               ROLL OUT BIT IN SW                   72900002
IOERR    EQU   X'04'                                                    73200002
GJP      EQU   X'08'                                                    73500002
ENDKEY   EQU   X'20'               END KEY IN READ MIP                  73800002
RUNOFF   EQU   X'FE'               TURN OFF RUN SW                      74100002
RTNCDE   EQU   X'80'                                                    74400002
ABND     EQU   X'40'                                                    74700002
TETCB    EQU   8                                                        75000002
TCBRB    EQU   0                                                        75300002
RBLNK    EQU   28                                                       75600002
CONST    DC    C'CANC'                                                  75900002
FFS      DC    X'FFFFFFFF'                                              76200002
ONE      DC    F'1'                                                     76500002
F8       DC    F'8'                                                     76800002
COREADR  DC    F'0'                                                3112 76900002
COMCODE  DS    0F                                                       77100002
         DC    X'00000222'                                              77400002
WTOPARM  DC    H'43'                                                    77700002
         DC    H'0'                                                     78000002
WTOMSG   DC    C'PERMANENT ERROR ON    .  ATTENTION IGNORED.'           78300002
         EJECT                                                          78600002
         GINIT                                                          78900002
ORDERS   GSRT                                                           79200002
         GEVM                                                           79500002
         GDV   0,3900,B                                                 79800002
         GECP  L                                                        80100002
         GTXT  '* TERMINATE'                                            80400002
         GCNOP C                                                        80700002
         GEVM                                                           81000002
         GDV   0,3600,B                                                 81300002
DUMP     GECP  L                                                        81600002
         GTXT  '* DUMP'                                                 81900002
         GCNOP C                                                        82200002
         GEVM                                                           82500002
         GDV   0,3300,B                                                 82800002
REPRESS  GECP  L                                                        83100002
         GTXT  '* RESUME'                                               83400002
         GCNOP C                                                        83700002
RETURN   GTRU  0                                                        84000002
LEN      EQU   *-ORDERS-2                                               84300002
DMP      EQU   DUMP-ORDERS                                              84600002
REP      EQU   REPRESS-ORDERS                                           84900002
GNOP     GNOP2                                                          85200002
         EJECT                                                          85500002
STORAG   DSECT                                                          85800002
CONID    DS    F                                                        86100002
GJPWAIT  DS    F                                                        86400002
SAVE     DS    18F                                                      86700002
READIN   DS    3F                                                       87000002
BUFAD    DS    H                                                        87300002
BUFLEN   DS    H                                                        87600002
DECB1    DS    8F                                                       87900002
SW       DS    X                                                        88200002
WAIT     DS    X                                                        88500002
RESTRT   DS    F                                                        88800002
SAV256   DS    F                                                        89100002
DCBAD    DS    F                                                        89400002
         END                                                            89700002
./  ADD  SSI=72360078,NAME=IFFCAN02
         TITLE ' GRAPHICS CANCEL KEY DUMP FORMATTING ROUTINE '          00060000
*********************************************************************** 00062000
*                                                                       00064000
* MODULE NAME:           IFFCAN02 (OS/VS2)                              00066000
*                                                                       00068000
* DESCRIPTIVE NAME:      GRAPHICS CANCEL KEY DUMP FORMATTING ROUTINE    00068400
*                                                                       00068800
* COPYRIGHT:             NONE                                           00069200
*                                                                       00069600
* STATUS:                RELEASE 2.0                                    00069700
*                                                                       00069800
* FUNCTION:              FORMAT INTO AN ABDUMP TYPE FORMAT AND PLACE    00073600
*                        ON THE SPECIFIED SEQUENTIAL DEVICE OR DATA     00074000
*                        SET THE 2250 BUFFER SECTIONS, EACH 256         00074400
*                        BYTES IN SIZE, THAT HAVE BEEN ASSIGNED TO      00074800
*                        THE JOBSTEP REQUESTING THE DUMP.               00074900
*                                                                       00075200
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 00085200
         EJECT                                                          00095200
*********************************************************************** 00095300
*                                                                       00095600
* NOTES:                                                                00096000
*    DEPENDENCIES:       NONE                                           00096100
*                                                                       00096600
*     RESTRICTION:       SYSBFDMP CARD MUST SPECIFY A SEQUENTIAL DEVICE 00096700
*                                                                       00097200
*     RESISTERS:         SEE EQUATE DEFINITIONS FOLLOWING PROLOG        00097300
*                                                                       00097400
*     PATCH LABEL:       PATCH, A 50 BYTE DC AREA AT END OF MODULE      00097500
*                                                                       00097600
* MODULE TYPE:           EXECUTABLE CODE                                00098000
*                                                                       00098100
*    PROCESSOR:          ASSEMBLER XF                                   00098200
*                                                                       00098300
*    MODULE SIZE:        SEE PAGE 1 OF THIS LISTING                     00099700
*                                                                       00100100
*    ATTRIBUTES:                                                        00100500
*       AT ENTRY:        REENTRANT  ENABLED  SUPERVISOR STATE IN KEY 0  00100900
*                                                                       00101100
* ENTRY POINT:           IFFCAN02                                       00103400
*                                                                       00105400
*    PURPOSE:            SEE 'FUNCTION' HEADING ABOVE                   00105500
*                                                                       00105600
*    LINKAGE:            SEE 'INPUT', NEXT HEADING                      00106000
*                                                                       00106400
* INPUT:                 REGISTER 1 POINTS TO CKQE FOR DEVICE           00106500
*                        REQUESTING THE DUMP                            00106700
*                                                                       00108300
* OUTPUT:                SEE 'FUNCTION' HEADING ABOVE                   00108700
*                                                                       00109100
* EXITS:                                                                00109400
*                                                                       00109800
*    NORMAL:             RETURN, USING ADDRESS IN REGISTER 14           00110200
*                                                                       00110300
*    ERROR:              RETURN, USING ADDRESS IN REGISTER 14           00110700
*                          RETURN CODE 4 IN REGISTER 15                 00111100
*                                                                       00111500
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 00111800
         EJECT                                                          00112200
*********************************************************************** 00112600
*                                                                       00112700
* EXTERNAL REFERENCES:                                                  00112800
*                                                                       00113100
*     ROUTINES:          IGG019OA TO READ IN THE 2250 BUFFER            00113500
*                        READ/WRITE (BSAM) TO WRITE BUFFER CONTENTS     00113900
*                                                                       00114200
*     DATA AREAS:        SEE DSECT SECTION AT END OF LISTING            00114600
*                                                                       00115000
*     CONTROL BLOCKS:    SEE DSECT SECTION AT END OF LISTING            00115100
*                                                                       00115200
* TABLES:                CKCB     CKQE     BUFFER TABLE                 00115300
*                        OPCB     TIOT                                  00117600
*                                                                       00119600
* MACROS:                CHECK         OPEN           SYNADRLS          00120000
*                        CLOSE         RETURN         WTO               00120600
*                        GETMAIN       SAVE                             00121000
*                        GREAD         SYNADAF                          00121400
*                                                                       00121500
* CHANGE ACTIVITY:       1. BLOCKING FACTOR CHANGED TO A SINGLE LINE    00121600
*                        2. DCB IS OPENED AND CLOSED EVERY ENTRY        00122000
*                                                                       00123100
*                        FIXES DROPPED LIST:     GJP UNSUPPORTED IN VS  00123200
*                                                                       00124400
*********************************************************************** 00124800
         SPACE 3                                                        00124900
IFFCAN02 CSECT                                                          00125000
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   00125100
* 507000,520500-522000,536500-539000                             A33603 00125200
*D631000-634500                                                  A39421 00125800
*A616100,A616200                                                 A39421 00126400
*C119500,D120000                                                 X01007 00127000
*D64500,D79000,D129000,D134500,D318000,D323000                LI A39419 00129300
*A64200-64400,A76200,A78900,A128700-129100,A134200-134800     LI A39419 00131600
*A317800-318100,A322800-323100,A713050-713450                 LI A39419 00133900
*C666000                                                      LI A39419 00136200
*C519500,520000                                              LD YA00801 00138500
*A315600-315997,A624100,C665500                               LG YM5686 00140800
*D231500,A231600-231700,D263000,A263100-263200               LG Z30AALG 00142800
*D278500,A278600-278700,D303000,A303100-303200               LG Z30AALG 00142900
*D433500,A433600-433620                                      LG Z30AALG 00143000
*A297700-297996,A658100-658420                               LG @ZM2360 00193000
*C390500-392500                                             D11 ZA14043 00213000
*                                                                       00243000
*                                                                       00293000
         EJECT                                                          03350021
*********************************************************************** 03400021
*                                                                     * 03450021
*                        EQUATES                                      * 03500021
*                                                                     * 03550021
*********************************************************************** 03600021
WORKR0   EQU   0                        WORKING REGISTER                03650021
WORKR1   EQU   1                        WORKING REGISTER                03700021
WORKR2   EQU   2                        WORKING REGISTER                03750021
BUFTABR  EQU   2                        BUFFER TABLE                    03800021
WORDCTR  EQU   2                        WORD COUNT REGISTER             03850021
WORKR3   EQU   3                        WORKING REGISTER                03900021
BUFINDXR EQU   3                        DISPLACEMENT INTO BUFFER TABLE  03950021
INTRTNR  EQU   4                        INTERNAL RETURN                 04000021
DCBR     EQU   5                        DATA CONTROL BLOCK              04050021
BUFFSECR EQU   7                        ADDRESS OF 256 BUFFER SECTION   04100021
UCBR     EQU   5                        UNIT CONTROL BLOCK              04150021
HEXR     EQU   5                        HEXADECIMAL DATA                04200021
BUFSTR   EQU   6                        ADDRESS OF BUFFER RESTART       04250021
*                                            GENERATION ADDRESS         04300021
MOVELNGR EQU   6                        LENGTH OF INTERPERT AREA        04350021
INDEXR   EQU   6                        INDEX VALUE                     04400021
TIOTR    EQU   6                        TASK INPUT/OUTPUT TABLE         04450021
HALFLNR  EQU   7                        HALF LINE COUNTER               04500021
CKCBR    EQU   7                        CANCEL KEY CONTROL BLOCK        04550021
TCBR     EQU   7                        TASK CONTROL BLOCK              04600021
DEBR     EQU   8                        DATA EVENT BLOCK ADDRESS        04650021
DECBR    EQU   8                        DATA EVENT CONTROL BLOCK        04700021
EBCDICR  EQU   8                        EBCDIC DATA                     04750021
CVTR     EQU   8                        COMMUNICATION VECTOR TABLE      04800021
LINER    EQU   9                        CURRENT OUTPUT LINE IN USE      04850021
TIOTDPLR EQU   9                        TASK I/O TABLE DISPLACEMENT     04900021
OPCBR    EQU   10                       OUTPUT CONTROL BLOCK            04950021
CKQER    EQU   11                       OUTPUT CONTROL BLOCK ADDRESS    05000021
BASER    EQU   12                       CANCEL KEY QUEUE ELEMENT ADD.   05050021
SAVEPTR  EQU   13                       BASE REGISTER                   05100021
RETURNR  EQU   14                       RETURN REGISTER EXTERNAL        05150021
WORKRE   EQU   14                       WORKING REGISTER                05200021
ENTRYR   EQU   15                       ENTRY POINT ADDRESS             05250021
RTNCODER EQU   15                       RETURN CODE                     05300021
WORKRF   EQU   15                       WORKING REGISTER                05350021
DEBR2    EQU   15                       DEB OTHER THAN SYSFBDMP DEB     05400021
SUMR     EQU   15                       ACCUMULATOR                     05450021
XDUMY    EQU   X'00'                   IMMED. COMPARAND       LB  AOS/1 05470021
         EJECT                                                          05500021
*********************************************************************** 05550021
*                                                                     * 05600021
*                        ENTRY INTERFACE                              * 05650021
*                                                                     * 05700021
*********************************************************************** 05750021
         SPACE 2                                                        05800021
         USING *,ENTRYR                                                 05850021
         B     *+24                     BRANCH AROUND ID                05860000
MODID    DC    C'IFFCAN02.VS2R2.74324'                                  05870000
         SAVE  (14,12)                  SAVE REGISTERS                  05900000
         DROP  ENTRYR                   ESTABLISH                       05950021
         BALR  BASER,0                                                  06000021
         USING *,BASER                       ADDRESSABILITY             06050021
         LR    CKQER,WORKR1             ESTABLISH ADDRESSABILITY        06100021
         USING CKQE,CKQER               FOR CKQE                        06150021
         USING CKCB,CKCBR               ESTABLISH ADDRESSABILITY FOR    06200021
*                                            CANCEL KEY CONTROL BLOCK   06250021
         L     CKCBR,CKQECKCB           LOAD POINTER TO CKCB            06300021
*                             TRY TO GET CORE FOR OPCB                  06350021
         LA    CKCBR,ZERO(CKCBR)        CLEAR HIGH ORDER BYTE           06400021
         LA    WORKR1,CKCBWORK         PT TO LIST IN CKCB     LI A39419 06420021
         GETMAIN EC,LV=OPCBLEN,A=(CKCBR),SP=252,MF=(E,(1))    LI A39419 06440021
         SR    WORKR2,WORKR2           SET INDEX TO WTO TABLE           06480021
         LTR   RTNCODER,RTNCODER       WAS GETMAIN SUCCESSFUL           06510021
         BNZ   COMMON                  NO-ISSUE ERROR MESSAGE           06540021
*                                      IF GETMAIN FAILS RETURN CODE     06600021
*                                         IN REGISTER 15 IS ALREADY     06650021
*                                         NOT ZERO SO WILL NOT HAVE     06700021
*                                         TO SET IT FOR ABNORMAL        06750021
*                                         RETURN INDICATOR              06800021
         OI    CKQEFLG2,CKFOPCB         INDICATE THAT                   06850021
*                                            GETTMAIN WAS ISSUED        06900021
*                                            SUCCESSFULLY               06950021
         L     OPCBR,CKCBOPCB           ESTABLISH ADDRESSABILITY        07000021
         USING OPCB,OPCBR                    FOR OPCB                   07050021
         USING SAVEAREA,SAVEPTR                                         07100021
         LA    WORKR1,OPCBSVAR          GET POINTER TO MY SAVE AREA     07150021
         ST    WORKR1,LSA               DOING THE BACKWORD              07200021
         DROP  SAVEPTR                         AND                      07250021
         USING SAVEAREA,WORKR1                     THE                  07300021
         ST    SAVEPTR,HSA              FOREWORD SAVE AREA CHAINING     07350021
         LR    SAVEPTR,WORKR1           SET POINTER TO MY SAVE AREA     07400021
         DROP  WORKR1                                                   07450021
         USING SAVEAREA,SAVEPTR                                         07500021
         SPACE 2                                                        07550021
*                                       GET INPUT BUFFER                07600021
         LA    WORKR1,CKCBWORK         PT TO LIST IN CKCB     LI A39419 07620021
         SPACE 2                                                        07650021
         LA    BUFFSECR,OPCBINBF        GET ADDRESS OF WHERE INPUT      07700021
*                                            BUFFER ADDRESS IS TO GO    07750021
         SPACE 2                                                        07800021
*                                       SEE IF CORE AVAILABLE           07850021
         GETMAIN EC,LV=INBUFLN,A=(BUFFSECR),SP=252,MF=(E,(1)) LI A39419 07890021
         SR    WORKR2,WORKR2           SET INDEX TO WTO TABLE           07930021
         LTR   RTNCODER,RTNCODER       WAS GETMAIN SUCCESSFUL           07960021
         BNZ   COMMON                  NO-ISSUE ERROR MESSAGE           07990021
*                                      IF GETMAIN FAILS RETURN CODE     08050021
*                                         IN REGISTER 15 IS ALREADY     08100021
*                                         NOT ZERO SO WILL NOT HAVE     08150021
*                                         TO SET IT FOR ABNORMAL        08200021
*                                         RETURN INDICATOR              08250021
         OI    CKQEFLG2,CKFINBUF        INDICATE THAT INPUT BUFFER      08300021
*                                            GOTTEN                     08350021
         EJECT                                                          08400021
*********************************************************************** 08450021
*                                                                     * 08500021
*                             MAIN BODY                               * 08550021
*                                                                     * 08600021
*********************************************************************** 08650021
         SPACE 2                                                        08700021
*                   LOCATE CURRENT TCB BY WAY OF CVT                    08750021
         SPACE 2                                                        08800021
         USING CVT,CVTR                 ESTABLISH ADDRESSABILITY FOR    08850021
*                                          COMMUNICATION VECTOR TABLE   08900021
         USING TCB,TCBR                 ESTABLISH ADDRESSABILITY FOR    08950021
*                                            TASK CONTROL BLOCK         09000021
         LA    CVTR,SYSCVTPT            GET LOCATION OF CVT POINTER     09050021
         L     CVTR,ZERO(CVTR)          GET CVT ADDRESS                 09100021
         L     TCBR,CVTTCBP             GET NEW/CURRENT WORDS ADDRESS   09150021
         L     TCBR,CURRTCB(TCBR)       GET CURRENT TCB POINTER         09200021
         SPACE 2                                                        09250021
*                   IS SYSTEM MVT IF YES USE JOBSTEP'S TCB              09300021
         SPACE 2                                                        09350021
         TM    CVTDCB,MVTSYS            IS THIS A MVT SYSTEM            09400021
         BNO   GETTIOT                  IF NOT MVT TAKE BRANCH          09450021
         L     TCBR,TCBJSTCB            GET JOB STEP TCB POINTER        09500021
GETTIOT  L     TIOTR,TCBTIO             GET TASK TIOT ADDRESS           09550021
         USING TIOT,TIOTR               ESTABLISH ADDRESSABILITY FOR    09600021
*                                            TASK I/O TABLE             09650021
         USING TIOTDDEN,WORKR1          ESTABLISH ADDRESSABILITY        09700021
*                                            FOR TASK I/O TABLE         09750021
*                                            DD ENTRY                   09800021
         LA    TIOTDPLR,TIOTHEAD             BYPASS TIOT IDENTIFIERS    09850021
         B     FIRSTENT                 FOR FIRST DD ENTRY SPECIAL      09900021
*                                            ENTRY TO LOOP              09950021
         SPACE 2                                                        10000021
*                   LOOP TO SEARCH TIOT FOR DDENTRY 'SYSBFDMP'          10050021
         SPACE 2                                                        10100021
TIOTLOOP IC    WORKR1,TIOELNGH          GET LENGTH OF THIS DD ENTRY     10150021
         SLL   WORKR1,X24BITS           ZERO OUT OTHER                  10200021
         SRL   WORKR1,X24BITS                THREE BYTES OF REGISTER    10250021
         AR    TIOTDPLR,WORKR1          UP TIOT DISPLACEMENT INTO       10300021
*                                            NEXT DD ENTRY              10350021
FIRSTENT LR    WORKR1,TIOTR             MOVE TIOT ADDRESS TO WORKING    10400021
*                                            PLACE                      10450021
         AR    WORKR1,TIOTDPLR          GET ADDRESS OF NEXT DD ENTRY    10500021
*                                            TIOT                       10550021
*                                       IS THIS END OF TIOT (I.E. FULL  10600021
*                                            WORD OF ZEROS)             10650021
         OC    TIOELNGH(X4BYTES),TIOELNGH      END OF TABLE             10670021
         LA    WORKR2,TWELVE           SET INDEX TO WTO TABLE           10700021
         BZ    COMMON                  ISSUE ERROR MESSAGE              10750021
         CLC   TIOEDDNM,SYSBFDMP        IS DD ENTRY 'SYSBFDMP'          11050021
         BNE   TIOTLOOP                 IF NOT TAKE BRANCH              11100021
         DROP  WORKR1                                                   11150021
         DROP  TIOTR                                                    11200021
         SPACE 2                                                        11250021
DCBNOPEN LA    DCBR,OPCBDCB             PLACE FOR DCB POINTER FROM      12750021
*                                            GETMAIN.                   12800021
*                        TRY TO GET CORE FOR OUTPUT DCB                 12850021
         L     WORKR1,CKQECKCB         PT TO CKCB             LI A39419 12870021
         LA    WORKR1,196(WORKR1)      PT TO LIST IN CKCB     LI A39419 12890021
         GETMAIN EC,LV=DCBLEN,A=(DCBR),SP=252,MF=(E,(1))      LI A39419 12910021
         SR    WORKR2,WORKR2           SET INDEX TO WTO TABLE           12930021
         LTR   RTNCODER,RTNCODER       WAS GETMAIN SUCCESSFUL           12960021
         BNZ   COMMON                  ISSUE ERROR MESSAGE              12990021
*                                      IF GETMAIN FAILS RETURN CODE     13050021
*                                         IN REGISTER 15 IS ALREADY     13100021
*                                         NOT ZERO SO WILL NOT HAVE     13150021
*                                         TO SET IT FOR ABNORMAL        13200021
*                                         RETURN INDICATOR              13250021
         L     DCBR,OPCBDCB             GET DCB NEW LOCATION            13300021
         USING DCB,DCBR            ADDRESSABILITY FOR DCB               13320000
         MVC   DCB(DCBLEN),DCBCOPY      MOVE DCB INTO CORE              13350021
*                                                 JUST GOTTEN           13400021
         L     WORKR1,CKQECKCB         PT TO CKCB             LI A39419 13420021
         LA    WORKR1,196(WORKR1)      PT TO LIST IN CKCB     LI A39419 13440021
         MVI   ZERO(WORKR1),X'8F'      INDICATE LAST DCB      LI A39419 13460021
OPENDCB  OPEN  ((DCBR),(OUTPUT)),MF=(E,(1))                   LI A39419 13480021
         TM    DCBOFLGS,OPEN            IS DCB OPEN SUCCESSFUL          13500021
         LA    RTNCODER,ABNORMAL        SET RETURN CODE FOR ERROR       13550021
*                                            CONDITION INCOUNTERED      13600021
*                                            IF BRANCH TAKEN            13650021
         BZ    EXIT                     IF NOT TAKE BRANCH              13700021
         OI    CKQEFLG2,CKFOPEN         NOTE DCB OPEN                   13750021
         SPACE 2                                                        13800021
         EJECT                                                          18800021
*********************************************************************** 18850021
*                                                                     * 18900021
*                   WILL INITIALIZE OPCB                                18950021
*                                                                       19000021
*********************************************************************** 19050021
START    EQU   *                                                        19100021
         MVC   OPCBPCNT(OPCBHEAD),OPCBCOPY        MOVE OPCB COPY TO     19150021
*                                                 GOTTEN CORE AREA      19200021
         MVC   OPCBDECB,DECBCOPY       MOVE DECB TO OPCB                19250021
         LA    WORKR3,OPCBL1            GET ADDRESS OF LINE 1 BUFFER    19300021
         USING LINE,WORKR3              ESTABLISHING ADDRESSABILITY FOR 19350021
*                                            LINE AREA                  19400021
         LA    WORKR2,OPCBLN2I          GET LINE 2 INDEX VALUE          19450021
         SR    WORKR2,OPCBR             BY LINE POINTER MINUS OPCB      19500021
*                                       ADDRESS                         19550021
         SLL   WORKR3,X8BITS            COMBINE INDEX AND LINE ADDRESS  19600021
         SLDL  WORKR2,X24BITS                INTO ONE WORD              19650021
         ST    WORKR2,OPCBCRLN-X1BYTE   PLACE POINTER IN CURRENT        19700021
*                                            LINE POINTER POSITION      19750021
         ST    WORKR2,OPCBLN1-X1BYTE    PLACE LINE 1 ADDRESS INTO       19800021
*                                            LINE TABLE                 19850021
         LA    WORKR3,OPCBL2            GET ADDRESS OF LINE 2 BUFFER    19900021
         LA    WORKR2,OPCBLN3I          GET LINE 3 INDEX                19950021
         SR    WORKR2,OPCBR             BY LINE POINTER MINUS OPCB      20000021
*                                       ADDRESS                         20050021
         ST    WORKR3,OPCBLN2-X1BYTE    PLACE LINE ADDRESS INTO LINE    20100021
*                                            TABLE                      20150021
         STC   WORKR2,OPCBLN2I          PLACE INDEX TO NEXT LINE TO BE  20200021
*                                            USED INTO TABLE            20250021
         LA    WORKR3,OPCBL3            GET ADDRESS OF LINE 3 BUFFER    20300021
         LA    WORKR2,OPCBLN1I         GET LINE ONE INDEX               20350021
         SR    WORKR2,OPCBR             BY LINE POINTER MINUS OPCB      20400021
*                                       ADDRESS                         20450021
         ST    WORKR3,OPCBLN3-X1BYTE    PLACE LINE ADDRESS INTO LINE    20500021
*                                            TABLE                      20550021
         STC   WORKR2,OPCBLN3I          PLACE INDEX TO NEXT LINE TO BE  20600021
*                                            USED INTO TABLE            20650021
         DROP  WORKR3                                                   20700021
         EJECT                                                          20750021
*********************************************************************** 20800021
*                                                                     * 20850021
*                   EJECT OUTPUT AND FORMAT HEADER AND PRINT IT       * 20900021
*                                                                     * 20950021
*********************************************************************** 21000021
         SPACE 2                                                        21050021
         USING LINE,LINER               ESTABLISHING ADDRESSABILITY     21100021
*                                            FOR OUTPUT LINES           21150021
         L     LINER,OPCBCRLN-X1BYTE    GET CURRENT LINE ADDRESS        21200021
         BAL   INTRTNR,EJECT            GO SPACE OUTPUT TO NEW PAGE     21250021
         MVC   LINETEXT(MSG#1LN),MSG#1  MOVE TEXT OF HEADER MESSAGE     21300021
*                                            TO OUTPUT LINE             21350021
         BAL   INTRTNR,WRITESP2         GO OUTPUT LINE                  21400021
         LA    CVTR,SYSCVTPT            LOCATION OF CVT POINTER         21450021
         L     CVTR,ZERO(CVTR)          GET CVT ADDRESS                 21500021
         USING CVT,CVTR                 ESTABLISH ADDRESSABILITY FOR    21550021
*                                            COMMUNICATION VECTOR TABLE 21600021
         L     TCBR,CVTTCBP             GET NEW/CURRENT WORDS ADDRESS   21650021
         L     TCBR,CURRTCB(TCBR)       GET CURRENT TCB POINTER         21700021
         L     TIOTR,TCBTIO             GET TASK TIOT POINTER           21750021
*                                       ESTABLISH ADDRESSABILITY        21800021
         USING TIOT,TIOTR                    FOR TASK I/O TABLE         21850021
         MVC   LNJOBNM,TXTJOBNM         PLACE 'JOB' ON TO LINE          21900021
         MVC   LNJOBNAM,TIOTNJOB        MOVE JOB NAME TO LINE           21950021
         MVC   LNSTPNM,TXTSTPNM         PLACE 'STEP' ON LINE            22000021
         MVC   LNSTPNAM,TIOTSTP         MOVE STEP NAME TO LINE          22050021
         MVC   LNTMNM,TXTTMNM           PLACE 'TIME' ON LINE            22100021
         MVC   LNDTNM,TXTDTNM           PLACE 'DATA' ON LINE            22150021
         DROP  TIOTR                                                    22200021
         DROP  CVTR                                                     22250021
         TIME  DEC                      GET DATE AND TIME               22300021
         IC    WORKR0,PLUSSIGN          CHANGE TO PACKED DECIMAL OF     22350021
         SRL   WORKR0,X4BITS               HOURS MINUTES AND SECONDS    22400021
         ST    WORKR0,LINEWORK          PLACE TIME INTO LINE WORK AREA  22450021
         MVC   LNTIME,TIMEMASK               PLACE TIME EDIT MASK ON    22500021
*                                                 LINE                  22550021
         ED    LNTIME,LINEWORK               MAKE TIME PRINTABLE        22600021
         ST    WORKR1,LINEWORK          PLACE DATE INTO LINE WORK AREA  22650021
         MVC   LNDATE,DATEMASK               PLACE DATE EDIT MASK ON    22700021
*                                                 LINE                  22750021
         ED    LNDATE,LINEWORK+X1BYTE        MAKE DATE PRINTABLE        22800021
         MVC   LINEWORK,LINEWORK+X5BYTES          MAKE LINE WORK        22850021
*                                            AREA BLANKS AGAIN          22900021
         BAL   INTRTNR,WRITESP          GO OUTPUT LINE                  22950021
         MVC   LNDPMSG,TXTDUMP          PLACE 'DUMP OF' ON LINE         23000021
         USING UCB,UCBR                 ESTABLISHING ADDRESSABILITY     23050021
*                                            FOR UNIT CONTROL BLOCK     23100021
         SR    UCBR,UCBR               CLEAR REGISTER        LG Z30AALG 23160000
         ICM   UCBR,THREE,CKQEUCB      GET UCB ADDRESS       LG Z30AALG 23170000
         MVC   LNDVAD,UCBNAME           MOVE DEVICE ADDRESS TO LINE     23200021
         DROP  UCBR                                                     23250021
         BAL   INTRTNR,WRITESP          GO OUTPUT LINE                  23300021
         MVC   LNBFNM,TXTBFAD           PLACE 'BUFFER START             23350021
*                                            REGENERATION ADDRESS'      23400021
*                                            ON LINE                    23450021
         LA    EBCDICR,LNSTRGAD         POINT TO LINE WHERE BUFFER      23500021
*                                            ADDRESS IS TO GO           23550021
         L     CKCBR,CKQECKCB           ESTABLISH ADDRESSABILITY FOR    23600021
         USING CKCB,CKCBR                    CANCEL KEY CONTROL BLOCK   23650021
         LA    HEXR,CKCBREST+X2BYTES    POINT TO USERS BUFFER RESTART   23700021
*                                            ADDRESS                    23750021
         LA    MOVELNGR,BUFADDLN        LENGTH OF BUFFER ADDRESS        23800021
         BAL   INTRTNR,HEXTOEBC         GO CONVERT BUFFER ADDRESS TO    23850021
*                                            PRINTABLE CHARACTERS AND   23900021
*                                            PLACE ON OUTPUT LINE       23950021
         BAL   INTRTNR,WRITESP2         GO OUTPUT LINE                  24000021
         SPACE 2                                                        24050021
*                       CHECK ROLL OUT                                  24100021
         SPACE 2                                                        24150021
         TM    CKQEFLG2,CKFROLUT        HAS USERS BUFFER BEEN ROLLED    24200021
*                                            OUT                        24250021
         BNO   STARTDMP                 IF NOT TAKE BRANCH              24300021
         SPACE 2                                                        24350021
*                   SINCE USERS BUFFER HAS BEEN ROLLED OUT FOR US       24400021
*                        WILL USE IT IN FORMATING DUMP                  24450021
         SPACE 2                                                        24500021
         LA    DECBR,CKCBDECB           ESTABLISH ADDRESSABILITY FOR    24550021
         USING DECB,DECBR                    DATA EVENT CONTROL BLOCK   24600021
         L     WORKR1,DECBBFAD-X1BYTE        ADDRESS OF WHERE BUFFER    24650021
*                                            SECTION ADDRESS IS         24700021
         MVC   ZERO(X2BYTES,WORKR1),CKCBBFAD MOVE IN ADDRESS            24750021
         MVC   DECBAREA,CKCBROLL            INPUT AREA ADDRESS          24800021
         SPACE 2                                                        24850021
*                                       WILL CALCULATE BUFFER INDEX     24900021
*                                            FOR FIRST BUFFER SECTION   24950021
*                                            ASSIGNED TO DEVICE         25000021
*                                            REQUESTING DUMP. (I.E.     25050021
*                                            BUFFER ADDRESS OF OPTION   25100021
*                                            PANEL IS FIRST ASSIGNED    25150021
*                                            SO INDEX IS ADDRESS        25200021
*                                            DIVIDED BY 256 BUFFER      25250021
*                                            SECTION SIZE)              25300021
         LH    WORKR1,CKCBBFAD         GET BUFFER ADDRESS               25320021
         SLL   WORKR1,X16BITS          SHIFT OUT SIGN BITS              25340021
         SRL   WORKR1,X16BITS          RESTORE REG VALUE                25360021
         LA    WORKR2,NUMONE            GET ONE TO                      25400021
         MR    WORKR0,WORKR2                 MULTIPLY BY TO SET UP FOR  25450021
*                                            DIVIDE                     25500021
         LA    WORKR2,NUM256            GET BUFFER SECTION SIZE AND     25550021
         DR    WORKR0,WORKR2                 DIVIDE TO GET NUMBER OF    25600021
         LR    BUFINDXR,WORKR0               SECTION READ IN            25650021
         SPACE 2                                                        25700021
         B     LINEFORM                 GO FORMAT THIS BUFFER SECTION   25750021
         DROP  DECBR                                                    25800021
         DROP  CKCBR                                                    25850021
         EJECT                                                          25900021
*********************************************************************** 25950021
*                                                                     * 26000021
*              FIND NEXT BUFFER SECTION AND READ IT IN                * 26050021
*                                                                     * 26100021
*********************************************************************** 26150021
         SPACE 2                                                        26200021
STARTDMP SR    BUFINDXR,BUFINDXR        ZERO OUT REGISTER               26250021
CKASSIGN EQU   *                                             LG Z30AALG 26310000
         SR    UCBR,UCBR               CLEAR REGISTER        LG Z30AALG 26320000
         ICM   UCBR,THREE,CKQEUCB      GET UCB ADDRESS       LG Z30AALG 26330000
         USING BUFTABLE,BUFTABR         ESTABLISH ADDRESSABILITY FOR    26350021
*                                            BUFFER TABLE               26400021
         USING UCB,UCBR                 ESTABLISH ADDRESSABILITY FOR    26450021
*                                            UNIT CONTROL BLOCK         26500021
         L     BUFTABR,UCBBFTAB-X1BYTE       GET BUFFER TABLE ADDRESS   26550021
         CLI   UCBTYP,MODEL1            IS THIS A 2250 MODEL 1          26600021
         BNE   MOD2OR3                  IF NOT TAKE BRANCH              26650021
         LA    WORKR1,NUMONE            FOR MODEL 1 ONLY HAVE ONE       26700021
*                                            DEVICE ENTRY IN BUFFER     26750021
*                                            TABLE                      26800021
         B     ADDHEAD                                                  26850021
MOD2OR3  LA    WORKR1,NUM4              FOR MODEL 2 OR 3 HAVE FOUR      26900021
*                                            DEVICE ENTRIES IN TABLE    26950021
*                                            NO MATTER HOW MANY DEVICES 27000021
*                                            ARE ON THE 2840            27050021
ADDHEAD  LA    WORKR1,NUMONE(WORKR1)    ADD ONE ENTRY FOR HEADER THEN   27100021
         SLL   WORKR1,X3BITS                 MULTIPLY BY 8 TO HAVE      27150021
*                                            DISPLACEMENT TO DEVICE     27200021
*                                            ASSIGNMENT SECTIONS        27250021
         AR    BUFTABR,WORKR1           ADD DISPLACEMENT TO START OF    27300021
*                                            TABLE                      27350021
         AR    BUFTABR,BUFINDXR         ADD SECTIONS DISPLACEMENT TO    27400021
*                                            SEE IF ASSIGNED            27450021
         CLC   UCBDEVI,ZERO(BUFTABR)         IS THIS BUFFER SECTION     27500021
*                                            ASSIGNED TO 2250 UNDER     27550021
*                                            CONTROL OF CANCEL KEY      27600021
*                                            ROUTINE.                   27650021
         BE    READIN                   IF YES TAKE BRANCH              27700021
CKNEXTAS LA    BUFINDXR,NUMONE(BUFINDXR)     UP INDEX TO NEXT BUFFER    27750021
*                                            DEVICE ASSIGN BYTE         27800021
         SR    UCBR,UCBR               CLEAR REGISTER        LG Z30AALG 27860000
         ICM   UCBR,THREE,CKQEUCB      GET UCB ADDRESS       LG Z30AALG 27870000
         L     BUFTABR,UCBBFTAB-X1BYTE  GET BUFFER TABLE ADDRESS        27900021
         CH    BUFINDXR,BFTLN           HAVE SEARCHED TOTAL TABLE       27950021
         BNH   CKASSIGN                 IF NOT TAKE BRANCH              28000021
         BAL   INTRTNR,WRITE            WRITE BLANK LINE                28050021
         MVC   LNEOD,MSGEOD             PLACE 'END OF DUMP' ON LINE     28100021
         BAL   INTRTNR,WRITE            GO WRITE LAST LINE              28150021
         BAL   INTRTNR,WRITE           AGAIN FOR BLOCKED RECORDS        28200021
         BAL   INTRTNR,WRITE           TWICE                            28250021
         SR    RTNCODER,RTNCODER        SET RETURN CODE FOR NORMAL      28300021
*                                            COMPLETION (I.E. = 0)      28350021
         B     EXIT                     GO DO HOUSE KEEPING AND RETURN  28400021
*                                            TO CALLER                  28450021
         DROP  UCBR                                                     28500021
READIN   L     CKCBR,CKQECKCB           GET POINTER TO CKCB             28550021
         USING CKCB,CKCBR               ESTABLISH ADDRESSABILITY FOR    28600021
*                                            CANCEL KEY CONTROL BLOCK   28650021
         LR    WORKR2,BUFINDXR          TAKE INDEX VALUE AND            28700021
         SLL   WORKR2,X8BITS                 MULTIPLY BY 256 TO GET     28750021
*                                            DISPLACEMENT OF BUFFER     28800021
*                                            SECTION IN BYTES           28850021
         ST    WORKR2,CKCBWRKA          PLACE ADDRESS INTO WORK AREA    28900021
         LA    WORKR2,CKCBWRKA+X2BYTES       GET POINTER TO ADDRESS     28950021
*                                            VALUE JUST STORED          29000021
         LA    DECBR,CKCBDECB           GET DECB ADDRESS                29050021
         USING DECB,DECBR               ESTABLISH ADDRESSABILITY FOR    29100021
*                                            DATA EVENT CONTROL BLOCK   29150021
         XC    DECBECB,DECBECB          CLEAR WAIT-POST FLAGS IN ECB    29200021
         DROP  CKCBR                                                    29220021
         L     BUFFSECR,OPCBINBF        GET ADDRESS OF READ INPUT       29250021
*                                            BUFFER                     29300021
         L     BUFSTR,DECBSTAD-X1BYTE   GET RESTART GENERATION ADDRESS  29350021
*                                            POINTER                    29400021
         L     DCBR,CKQEDCB             GET DCB ADDRESS                 29450021
*                                       READ IN NEXT SECTION OF 2250    29500021
*                                            BUFFER                     29550021
         LR    WORKR1,DECBR             GET DATA EVENT CONTROL BLOCK    29600021
*                                            ADDRESS INTO REGISTER U    29650021
*                                            ADDRESS INTO REGISTER 1    29700021
*                                            FOR MACRO                  29750021
         SR    GIOCRR1,GIOCRR1         CLR REGISTER          LG @ZM2360 29760000
         ICM   GIOCRR1,THREE,CKQEUCB  GET UCB ADDRESS        LG @ZM2360 29770000
         L     GIOCRR1,TEB(GIOCRR1)  GET TEB ADDRESS         LG @ZM2360 29780000
         CLC   GIOCR(3,GIOCRR1),DCBGIOCR(DCBR)  ADDR IN DCB CORRECT?    29790000
         BE    STREGEN               YES,ISSUE READ          LG @ZM2360 29798400
         LA    WORKR2,MSG#9          NO,LD MSG DISP FOR WTO  LG @ZM2360 29798800
         B     COMMON                GO ISSUE WTO            LG @ZM2360 29799200
STREGEN  EQU   *                                             LG @ZM2360 29799600
         GREAD (WORKR1),STR,(DCBR),256,(BUFFSECR),(WORKR2),(BUFSTR),   C29800021
               MF=E                                                     29850021
         LTR   RTNCODER,RTNCODER        WAS I/O STARTED                 29900021
         LA    WORKR2,FOUR             SET INDEX TO WTO TABLE           29930021
         BNE   COMMON                  ISSUE ERROR MESSAGE              29960021
         WAIT  1,ECB=(DECBR)            WAIT ON I/O TO COMPLETE         30000021
         CLI   DECBECB,SUCCESS          WAS I/O SUCCESSFUL              30050021
         BE    LINEFORM                 GO FORMAT BUFFER SECTION        30100021
         LA    WORKR2,FOUR             SET INDEX TO WTO TABLE           30120021
*                                                                       30150021
*********************************************************************** 30160021
*                                                                     * 30170021
*        THIS ROUTINE WILL ISSUE WTO'S FOR ERROR CONDITIONS           * 30180021
*                                                                     * 30190021
*********************************************************************** 30200021
COMMON   L     CKCBR,CKQECKCB                                           30210021
         USING  CKCB,CKCBR                                              30220021
         L     WORKR1,CKCBERMT         LOAD POINTER TO WTO TABLE        30230021
         L     WORKR1,ZERO(WORKR2,WORKR1)    GET POINTER TO MSG         30240021
         SR    UCBR,UCBR               CLEAR REGISTER        LG Z30AALG 30310000
         ICM   UCBR,THREE,CKQEUCB      GET UCB ADDRESS       LG Z30AALG 30320000
         USING UCB,UCBR                 ESTABLISHING ADDRESSABILITY     30350021
*                                            FOR UNIT CONTROL BLOCK     30400021
         USING WTOMSG,WORKR1            ESTABLISH ADDRESSABILITY FOR    30450021
*                                            WRITE TO OPERATOR MESSAGE  30500021
         MVC   CKCBWRKA(NUM57),WTOMSG   MOVE MSG TO WORK AREA TO        30520021
*                                      MAINTAIN REENTERABILITY          30540021
         MVC   CKCBWRKA+TWELVE(NUM3),UCBNAME    PUT UCBNAME IN WTO      30560021
         LA    WORKR1,CKCBWRKA         GET ADDR OF MSG FOR WTO MACRO    30580021
         WTO   MF=(E,(1))               ISSUE WTO                       30600021
         LA    RTNCODER,ABNORMAL        SET RETURN CODE AS ERROR        30650021
*                                            CONDITION EXISTS           30700021
* GO CLEAN UP AND RETURN TO CALLER                                      30770021
         DROP  UCBR                                                     30850021
         EJECT                                                          30900021
*********************************************************************** 30950021
*                                                                     * 31000021
*                    EXIT ROUTINE FOR NORMAL AND ADNORMAL RETURN      * 31050021
*                                                                     * 31100021
*********************************************************************** 31150021
         SPACE 2                                                        31200021
*    NOTE:  THE RETURN CODE MUST BE IN REGISTER (15)                    31250021
*                                 UPON ENTRY TO THIS SUB-PROGRAM        31300021
         SPACE 2                                                        31350021
EXIT     OI    CKQEFLG1,CKFEXIT         INDICATE THAT EXIT IS NOW       31400021
*                                            IN PROCESS                 31450021
         L     CKCBR,CKQECKCB           GET CKCB ADDRESS                31500021
         ST    RTNCODER,CKCBWRKA+X24BYTES         SAVE RETURN CODE      31550021
         TM    CKQEFLG2,CKFOPEN    IS DCB OPEN?               LG YM5686 31560000
         BNO   FREEBUFF            NO,DO NOT ATTEMPT TO CLOSE LG YM5686 31570000
         L     DCBR,OPCBDCB        GET DCB ADDRESS(SYSBFDMP)  LG YM5686 31580000
         LA    WORKR1,CKCBWORK     GET ADDRESS OF LIST        LG YM5686 31590000
         MVI   ZERO(WORKR1),X'8F'  INDICATE LAST DCB          LG YM5686 31592000
         CLOSE ((DCBR)),MF=(E,(1))                            LG YM5686 31594000
         NI    CKQEFLG2,CLOSED     NOTE DCB CLOSED            LG YM5686 31598400
         LA    WORKR1,CKCBWORK     GET ADDRESS OF LIST        LG YM5686 31599200
         LA    DCBR,OPCBDCB        GET ADDRESS OF DCB ADDRESS LG YM5686 31599300
         FREEMAIN E,LV=DCBLEN,A=(DCBR),SP=252,MF=(E,(1))      LG YM5686 31599600
FREEBUFF EQU   *                                              LG YM5686 31599700
         TM    CKQEFLG2,CKFINBUF        HAS INPUT BUFFER BEEN GOTTEN    31600021
         BNO   EXCKOPCB                 IF NOT TAKE BRANCH              31650021
         LA    WORKR2,OPCBINBF          GET ADDRESS OF BUFFER ADDRESS   31700021
*                                            IN BYTES                   31750021
         LA    WORKR1,CKCBWORK         PT TO LIST IN CKCB     LI A39419 31780021
         FREEMAIN E,LV=INBUFLN,A=(WORKR2),SP=252,MF=(E,(1))   LI A39419 31810021
         NI    CKQEFLG2,FULLMASK-CKFINBUF         TURN OFF BUFFER       31850021
*                                            ACQUIRED SWITCH            31900021
EXCKOPCB TM    CKQEFLG2,CKFOPCB         HAS THE OPCB GETMAIN BE ISSUED  31950021
         BNO   EXRTN                    IF NOT TAKE BRANCH              32000021
         LA    DECBR,OPCBDECB          GET LINE DECB ADDR FOR CHECK     32050021
EXFROPCB L     WORKRE,HSA               GET CALLERS SAVE AREA           32100021
         LA    WORKR2,CKCBOPCB          GET ADDRESS OF OPCB'S ADDRESS   32150021
         LA    WORKR3,OPCBLEN           GET LENGTH OF OPCB LENGTH       32200021
*                                       FREE UP OPCB AREA               32250021
         LA    WORKR1,CKCBWORK         PT TO LIST IN CKCB     LI A39419 32280021
         FREEMAIN E,LV=(WORKR3),A=(WORKR2),SP=252,MF=(E,(1))  LI A39419 32310021
         NI    CKQEFLG2,FULLMASK-CKFOPCB    RESET BIT IN CKQE           32350021
         LR    SAVEPTR,WORKRE           PLACE SAVEAREA ADDRESS INTO     32400021
*                                            PROPER REGISTER            32450021
EXRTN    NI    CKQEFLG1,FULLMASK-CKFEXIT     TURN OFF EXIT IN PROCESS   32500021
         L     RTNCODER,CKCBWRKA+X24BYTES        GET RETURN CODE SAVED  32550021
*                                                 EARLIER               32600021
         RETURN     (14,12),T,RC=(15)             RETURN TO CALLER      32650021
*                                                                       32700021
*                                                                       32750021
*                                                                       32800021
         EJECT                                                          32850021
*********************************************************************** 32900021
*                                                                     * 32950021
*                   PRINT BUFFER SECTION ROUTINE                      * 33000021
*                                  AND                                * 33050021
*                             FORMAT A LINE OF  BUFFER DUMP           * 33100021
*                                                                     * 33150021
*********************************************************************** 33200021
         SPACE 2                                                        33250021
LINEFORM L     CKCBR,CKQECKCB           GET CKCB ADDRESS                33300021
         LA    DECBR,CKCBDECB           ESTABLISH ADDRESSABILITY        33350021
         USING DECB,DECBR               FOR DATA EVENT CONTROL BLOCK    33400021
         L     HEXR,DECBAREA            GET INPUT BUFFER ADDRESS        33450021
         SR    WORKRF,WORKRF            ZERO OUT REGISTER               33500021
         L     WORKRE,DECBBFAD-X1BYTE        GET BUFFER SECTION ADDRESS 33550021
         IC    WORKRF,X1BYTE(WORKRE)         GET BUFFER SECTION         33600021
*                                            DISPLACEMENT OF 0 TO 256   33650021
         AR    HEXR,WORKRF              ADD TO START OF 256 BYTE        33700021
*                                            SECTION READ IN BUFFER     33750021
*                                            ADDRESS                    33800021
         MVC   LININTA,ZERO(HEXR)            MOVE BUFFER DATA           33850021
*                                            INTO OUTPUT LINE TO WORK   33900021
*                                            FROM AND LATER TO BE       33950021
*                                            INTERPRETED IN.            34000021
         LA    MOVELNGR,X4BYTES         SET CHARACTER COUNT TO 4        34050021
         L     HEXR,DECBBFAD-X1BYTE     GET ADDRESS OF BUFFER SECTION   34100021
*                                            FOR FIRST BYTE OF LINE     34150021
         LA    EBCDICR,LINEBFAD         GET BUFFER ADDRESS POSITION     34200021
*                                            ON OUTPUT LINE             34250021
         BAL   INTRTNR,HEXTOEBC         GO PLACE PRINTABLE BUFFER       34300021
*                                            ADDRESS ON LINE            34350021
         LA    EBCDICR,X2BYTES(EBCDICR)      SPACE UP TO NEXT FIELD     34400021
*                                            TO BE FILLED IN            34450021
         LA    HALFLNR,NUM2             SET LOOP REGISTER FOR HALF LINE 34500021
*                                            COUNTER  (I.E. 2)          34550021
         LA    HEXR,LININTA             SET POINTER TO BUFFER DATA      34600021
*                                            TO BE CONVERTED            34650021
HALFLINE LA    WORDCTR,NUM4             SET LOOP REGISTER FOR WORDS IN  34700021
*                                            HALF LINE (I.E. 4)         34750021
WORD     LA    MOVELNGR,X8BYTES         SET CHARACTER COUNT TO 8        34800021
         LA    EBCDICR,X1BYTE(EBCDICR)  SPACE TO START OF NEXT FIELD    34850021
         BAL   INTRTNR,HEXTOEBC         GO HAVE WORD CONVERTED          34900021
         BCT   WORDCTR,WORD             HAVE DONE HALF LINE  (I.E. FOUR 34950021
*                                            FULL WORDS) ?    IF NOT    35000021
*                                            LOOP BACK                  35050021
         LA    EBCDICR,X3BYTES(EBCDICR) SPACE UP OUTPUT LINE POINTER    35100021
         BCT   HALFLNR,HALFLINE         HAVE DONE FULL LINE OR          35150021
*                                            TWO HALF LINES? IF NOT     35200021
*                                            LOOP BACK TO D SECOND      35250021
*                                            HALF                       35300021
         TR    LININTA,TTRTABLE                   INTERPERT BUFFER DATA 35350021
         MVI   LINEFATK,ASTERISK        PLACE * AROUND INTERPERTED      35400021
         MVI   LINEBATK,ASTERISK             DATA                       35450021
         BAL   INTRTNR,WRITE            OUTPUT LINE                     35500021
         LA    WORKRF,X32BYTES          GET 32 BYTE COUNT               35550021
         L     CKCBR,CKQECKCB           GET POINTER TO CKCB             35600021
         LA    DECBR,CKCBDECB           GET POINTER TO DATA EVENT       35650021
*                                            CONTROL BLOCK              35700021
         L     WORKRE,DECBBFAD-X1BYTE   GET BUFFER SECTION ADDRESS      35750021
         AH    WORKRF,ZERO(WORKRE)      UP BUFFER DATA ADDRESS BY 32    35800021
         STH   WORKRF,ZERO(WORKRE)      RESET BUFFER DATA ADDRESS       35850021
         CLI   X1BYTE(WORKRE),BYTEZERO       HAVE WE FORMATED A FULL    35900021
*                                            BUFFER SECTION (I.E. IS    35950021
*                                            ADDRESS MULTIPLE OF 256    36000021
*                                            AND ADDRESS LOW ORDER      36050021
*                                            BYTE ZERO)                 36100021
         BE    CKNEXTAS                 IF YES TAKE BRANCH              36150021
         B     LINEFORM                 GO FORMAT LINE OF THIS          36200021
*                                           BUFFER SECTION              36250021
         EJECT                                                          36300021
*********************************************************************** 36350021
*                                                                     * 36400021
*                   OUTPUT CONTROL SUB-PROGRAM                        * 36450021
*                                                                     * 36500021
*********************************************************************** 36550021
         SPACE 2                                                        36600021
*  INPUT:      ADDRESS IN THE OPCBR REGISTER OF THE OPCB                36650021
         SPACE 2                                                        36700021
*  ENTRY:      EJECT - TO WRITE LINE IN CURRENT LINE OF OPCB AND        36750021
*                             EJECT TO NEW PAGE OF OUTPUT               36800021
*                                                                       36850021
*              WRITE - TO WRITE LINE IN CURRENT LINE OF OPCB AND        36900021
*                             SPACE TO NEXT LINE OF OUTPUT              36950021
*                                                                       37000021
*              WRITESP - TO WRITE LINE IN CURRENT LINE OF OPCB AND      37050021
*                             SKIP ONE LINE OF OUTPUT                   37100021
*                                                                       37150021
*              WRITESP2 - TO WRITE LINE IN CURRENT LINE OF OPCB AND     37200021
*                             SKIP TWO LINES OF OUTPUT                  37250021
*                                                                       37300021
*  EXIT:       BRANCH BACK ON RETURN ADDRESS OF INTERNAL RETURN         37350021
*                   REGISTER INTRTNR                                    37400021
*                                                                       37450021
*  OUTPUT:     TAKE CURRENT LINE AND ISSUE I/O FOR IT. PLACE NEXT       37500021
*                   LINE TO BE USED INTO CURRENT LINE POINTER OF        37550021
*                   OPCB                                                37600021
*                                                                       37650021
*  FUNCTION:   TAKE CURRENT LINE AND ISSUE I/O FOR IT. PLACING PROPER   37700021
*                   CONTROL CODES INTO FIRST BYTE OF LINE. (THE CONTROL 37750021
*                   CODE IS DEPENDENT ON ENTRY POINT TO SUB-PROGRAM)    37800021
*              IF THE NEXT LINE NEEDS TO HAVE A CHECK MADE BEFORE       37850021
*                   CONTROL IS RETURNED TO WHERE IT IS CALLED FROM      37900021
*                   THE CHECK WILL BE ISSUED.                           37950021
*              LINE COUNT IS KEEP SO WHEN LINE COUNT EXCEEDS MAXIMUM    38000021
*                   LIMIT PER PAGE THEN AN AUTOMATIC EJECT WILL TAKE    38050021
*                   PLACE WITH WRITING OF PAGE NUMBER ON TOP LINE OF    38100021
*                   NEW PAGE.                                           38150021
         SPACE 2                                                        38200021
WRITE    MVI   LNCNTCD,WRTSP1        SET CONTROL CODE TO WRITE          38250021
*                                        AND SPACE                      38300021
         LA    SUMR,NUM1                GET ONE TO                      38350021
PAGEFULL AH    SUMR,OPCBLCNT            ADD TO LINE COUNT               38400021
         STH   SUMR,OPCBLCNT            SAVE LINE COUNT                 38450021
UPLINE   SR    INDEXR,INDEXR           CLEAR REGISTER                   38500021
         IC    INDEXR,OPCBLNI          GET NEXT LINE INDEX VALUE        38550021
         L     WORKR1,ZERO(INDEXR,OPCBR)    GET NEXT LINE POINTER       38600021
         ST    WORKR1,OPCBCRLN-X1BYTE  MAKE CURRENT NEXT LINE           38650021
         CLI   OPCBLCNT+X1BYTE,NUM55    IS PAGE FULL (I.E. PAGE COUNT   38700021
*                                            > OR = 55)                 38750021
         BL    CKBLOCK                 IF PAGE NOT FULL TAKE BRANCH     38800021
SETEJECT MVI   LNCNTCD,EJECTCD          SET CONTROL CODE TO WRITE AND   38850021
*                                            EJECT                      38900021
CKBLOCK  L     DCBR,OPCBDCB            GET O/P DCB ADDRESS              38950021
         USING DCB,DCBR            ZA14043 LOGICALLY DELETES 5 LINES    39000000
*        TM    DCBDEVT,DCBDTDA        O/P TAPE OR DA??      D11 ZA14043 39020000
*        BZ    ZEROECB             NO-DONT BLOCK RECS       D11 ZA14043 39050000
*        C     LINER,OPCBLN3-X1BYTE LAST LINE IN BLOCK??    D11 ZA14043 39100000
*        BNE   BLANKOUT                NO-TAKE BRANCH       D11 ZA14043 39150000
*        SPACE 2                                            D11 ZA14043 39200000
*                        PREPARE TO OUTPUT THIS LINE AND ISSUE I/O      39300021
         SPACE 2                                                        39350021
ZEROECB   XC    OPCBECB,OPCBECB      ZERO O/P ECB                       39400021
         LA    DECBR,OPCBDECB          GET ADDR OF O/P DECB             39450021
         L     LINER,OPCBLN1-X1BYTE    GET BUFFER ADDR                  39500021
         ST    LINER,OPCBCRLN-X1BYTE   SET CURRENT LINE AS LINE ONE     39550021
*                                      INCASE O/P NOT BLOCKED           39600021
         WRITE      (DECBR),SF,(DCBR),(LINER),'S',MF=E      WRITE LINE  39650021
*                                       CHECK CURRENT LINE FOR          39700021
*                                            SUCCESSFUL I/O LAST TIME   39750021
*                                            USED                       39800021
         CHECK      (DECBR)                                             39850021
         CLI   OPCBECB,SUCCESS         I/O SUCCESSFUL                   39900021
         BNE   BLANKOUT                 IF NOT TAKE BRANCH              39950021
         NI    OPCBERRF,FULLMASK-IOERBSAM         NOTE THAT THIS I/O    40000021
*                                            WAS SUCCESSFUL (I.E.       40050021
*                                            INDICATE THAT DO NOT HAVE  40100021
*                                            CONSECUTIVE I/O ERRORS)    40150021
*                                                                       40200021
BLANKOUT L     LINER,OPCBCRLN-X1BYTE   GET ADDR OF NEXT LINE            40250021
         MVI   LINE,BLANK              MOVE IN BLANK CHAR               40300021
         MVC   LINETEXT,LINE                 MAKE ALL OF LINE BLANKS    40350021
         CLI   OPCBLCNT+X1BYTE,NUM55    IS PAGE FULL                    40400021
*                                                                       40450021
         BCR   LOW,INTRTNR              IF NOT TAKE BRANCH              40500021
         XC    OPCBLCNT,OPCBLCNT        SET LINE COUNT TO ZERO          40550021
         AP    OPCBPCNT,OPCBDEC1        UP PAGE COUNT BY ONE            40600021
         MVC   LNPAGNM,TXTPAGE          MOVE 'PAGE' TO LINE             40650021
*                                            LINE                       40700021
         ED    LNPAGNO,OPCBPCNT         CHANGE DECIMAL PAGE COUNT TO    40750021
*                                            ECBDIC                     40800021
         B     WRITESP2                 GO WRITE OUT LINE               40850021
         SPACE 3                                                        40900021
EJECT    MVI   LINE,BLANK               MOVE IN BLANK CHARACTER         40950021
         MVC   LINETEXT,LINE                 MAKE ALL CHARACTERS BLANKS 41000021
         MVI   OPCBLCNT+X1BYTE,NUM55    SET LINE COUNT TO PAGE FULL     41050021
         B     UPLINE                  SET CONTROL CODE FOR EJECT       41100021
         SPACE 3                                                        41150021
WRITESP  MVI   LNCNTCD,WRTSPCD          SET CONTROL CODE TO WRITE AND   41200021
*                                            SPACE TWICE                41250021
         LA    SUMR,NUM2                GET TWO TO                      41300021
*                                       ADD TO LINE COUNT               41350021
         B     PAGEFULL                 GO CHECK TO SEE IF PAGE FULL    41400021
         SPACE 3                                                        41450021
WRITESP2 MVI   LNCNTCD,WRTSP2CD         SET CONTROL CODE TO WRITE AND   41500021
*                                            SPACE THREE TIMES          41550021
         LA    SUMR,NUM3                GET THREE TO                    41600021
*                                       ADD TO LINE COUNT               41650021
         B     PAGEFULL                 GO CHECK TO SEE IF PAGE FULL    41700021
         EJECT                                                          41750021
*********************************************************************** 41800021
*                                                                     * 41850021
*                   BSAM I/O ERROR ANALYSIS ROUTINE                   * 41900021
*                                                                     * 41950021
*********************************************************************** 42000021
*                        THE CHECK ROUTINE IGG019BB GIVES US CONTROL    42050021
*                        UPON PERMANENT I/O ERROR CONDITION. CHECK      42100021
*                        MAY USE REGISTERS 14-8 BUT SAVED THEM BY       42150021
*                        STANDARD CONVENTIONS IN MY SAVE AREA POINTER   42200021
*                        TO BY REGISTER 13.  SINCE CHECK WILL NOT       42250021
*                        REINITIALIZE 9-13 FOR US WE SHOULD NOT         42300021
*                        ALTER THEM                                     42350021
ERFORMAT TM    CKQEFLG1,CKFEXIT         IS EXIT IN PROCESS              42400021
         BCR   ONES,RETURNR             IF YES TAKE BRANCH              42450021
*                   IF THE ERROR IS THE SECOND IN A ROW THEN BSAM       42500021
*                        PROCESSING WILL BE STOPPED AND WE WILL RESTORE 42550021
*                        REGISTERS 14-8 FROM OUR SAVE AREA POINTED TO   42600021
*                        BY REGISTER 13.  THESE ARE OUR REGISTERS       42650021
*                        AT TIME OF GOING TO CHECK.                     42700021
         TM    OPCBERRF,IOERBSAM        IS THIS CONSECTIVE ERROR        42750021
         BZ    GETMSG                   IF NOT TAKE BRANCH              42800021
*                   IF THIS IS NOT A CONSECUTIVE ERROR WILL ISSUE       42850021
*                        SYNADAF MACRO AND THEN ISSUE WRITE TO OPERATOR 42900021
*                        TO NOTE ERROR AND THEN SET SWITCH THAT BSAM    42950021
*                        I/O ERROR HAS OCCURED.                         43000021
         LM    RETURNR,DEBR,R0                    RESTORE REGISTERS     43050021
*                                            TO THE WAY THEY WERE       43100021
*                                            BEFORE CHECK WAS ISSUED    43150021
         B     EXIT                     GO CLEAN UP AND STOP            43200021
GETMSG   SYNADAF    ACSMETH=BSAM             FORMAT OUTPUT OF ERROR     43250021
         MVC   ZERO(FOUR,WORKR1),LENFLGS1    MOVE WTO LENGTH            43270021
*                                            AND MCSFLGS TO             43290021
*                                            START OF WTO               43310021
         MVC   FOUR(SEVEN,WORKR1),MSGHDRID    MOVE MSG ID TO WTO        43330021
         SR    UCBR,UCBR               CLEAR REGISTER        LG Z30AALG 43360000
         ICM   UCBR,THREE,CKQEUCB      GET UCB ADDRESS       LG Z30AALG 43362000
         USING UCB,UCBR                ESTABLISH ADDRESSABILITY         43370021
*                                      FOR UNIT CONTROL BLOCK           43390021
         MVC   TWELVE(THREE,WORKR1),UCBNAME     ADD UCB NAME TO WTO     43410021
         MVC   SIXTN(FORTY,WORKR1),FIFTY(WORKR1)     SHIFT MSG          43430021
         MVC   X56BYTES(FOUR,WORKR1),RCDC    MOVE ROUTING AND           43450021
*                                      DESCRIPTOR CODES TO WTO          43470021
         LA    WORKR2,SIXTY(WORKR1)    GET WTO AREA ADDR FOR MSG2       43490021
         MVC   ZERO(FOUR,WORKR2),LENFLGS2    MOVE WTO LENGTH AND        43510021
*                                            MCSFLGS TO WTO 2           43530021
         MVC   FOUR(SEVEN,WORKR2),MSGHDRID    MOVE MSG ID TO WTO        43550021
         MVC   TWELVE(THREE,WORKR2),UCBNAME   ADD UCBNAME TO WTO        43570021
         MVC   SIXTN(X37BYTES,WORKR2),X91BYTES(WORKR2)   SHIFT MSG      43590021
         MVC   X53BYTES(FOUR,WORKR2),RCDC    MOVE ROUTING AND           43610021
*                                    DESCRIPTOR CODES TO WTO            43630021
         WTO   MF=(E,(1))               ISSUE WTO                       43800021
         LR    WORKR1,WORKR2           LOAD REG ONE FOR WTO             43810021
         WTO   MF=(E,(1))              ISSUE WTO                        43820021
         OI    OPCBERRF,IOERBSAM        NOTE HAVE HAD I/O ERROR         43850021
         SYNADRLS                       CLEAN UP SAVE AREA CHAINING     43900021
         LTR   RTNCODER,RTNCODER        WAS FREEING OF SAVE AREA        43950021
*                                            SUCCESSFUL                 44000021
*                                       IF YES TAKE BRANCH              44050021
         BCR   EQUAL,RETURNR            GO BACK TO CHECK AND CONTINUE   44100021
*                                       PROCESSING BSAM OUTPUT          44150021
*                   IF RELEASE OF SAVE AREA AND RESTORING OF REGISTER   44200021
*                        13 TO MY SAVE AREA HAS FAILS WILL TRY TO       44250021
*                        RECOVER BY LOADING REGISTER 13 FROM MY SAVE    44300021
*                        AREA DISPLACEMENT IN OPCB THEN GO BACK TO      44350021
*                        CHECK.  THIS IS A LAST EFFERATE AND IF FAILS   44400021
*                        CAN ONLY BE SORRY FOR TRIED TO KEEP RUNNING    44450021
*                        AS BEST POSIBLE. CHECK MUST POINT TO OUR       44500021
*                        SAVE AREA TO RESTORE REGISTERS BEFORE GOING    44550021
*                        BACK TO MAIN PROGRAM TO CONTINUE.              44600021
*                                                                       44650021
         LA    SAVEPTR,OPCBSVAR         GET POINTER TO SAVE AREA        44700021
         BR    RETURNR                  HOPFULLY GO BACK TO CHECK       44750021
         EJECT                                                          44800021
*********************************************************************** 44850021
*                                                                     * 44900021
*                   SUB-PROGRAM TO CONVERT HEX  TO EBCDIC             * 44950021
*                                                                     * 45000021
*********************************************************************** 45050021
         SPACE 2                                                        45100021
*  INPUT:      REGISTER MOVELGNR NUMBER OF BYTES OF EBCDIC INFROMATION  45150021
*                        TO BE PRODUCED                                 45200021
*              REGISTER HEXR  THE HEX  DATA TO BE CONVERTED TO EBCDIC   45250021
*                                                                       45300021
*              REGISTER EBCDICR THE PLACE WHERE THE EBCDIC INFORMATION  45350021
*                        IS TO GO UPON CONVERSION                       45400021
*  NOTE:       OUTPUT AREA MUST BE TWICE THE SIZE OF THE HEX DATA TO    45450021
*                        BE CONVERTED                                   45500021
*              AT COMPLETION OF THE MOVE OPERATION THE HEXR WILL POINT  45550021
*                   TO THE BYTE NEXT TO BE CONVERTED IF AN EVEN NUMBER  45600021
*                   OF BYTES ARE SPECIFIED OR TO THE BYTE HALF          45650021
*                   CONVERTED IF AN ODD NUMBER WAS SPECIFIED.           45700021
*                   THE EBCDICR REGISTER WILL POINT TO THE NEXT BYTE    45750021
*                   FIELD TO BE STORED INTO IN THE LINE.                45800021
         SPACE 2                                                        45850021
HEXTOEBC LTR   MOVELNGR,MOVELNGR        IS MOVE LENGTH ZERO             45900021
         BCR   EQUAL,INTRTNR            IF YES TAKE BRANCH              45950021
         SR    WORKRE,WORKRE            ZERO OUT REGISTER               46000021
MOVEMORE IC    WORKRE,ZERO(HEXR)        GET TWO HEX DIGITS              46050021
         SRDL  WORKRE,X4BITS            MOVE OUT SECOND DIGITS          46100021
         IC    WORKRF,EBCDICTB(WORKRE)       GET EBCDIC FOR HEX         46150021
         STC   WORKRF,ZERO(EBCDICR)     PLACE EBCDIC CHARACTER IN LINE  46200021
         LA    EBCDICR,NUMONE(EBCDICR)       UP OUTPUT POINTER          46250021
         BCT   MOVELNGR,SCNDHALF        LOWER NUMBER OF OUTPUT REQUEST  46300021
*                                            COUNT BY ONE AND IF HAVE   46350021
         BR    INTRTNR                       CONVERTED ALL THAT WAS     46400021
*                                            REQUESTED RETURN TO WHERE  46450021
*                                            CALLED                     46500021
SCNDHALF SR    WORKRE,WORKRE            ZERO OUT REGISTER               46550021
         SLDL  WORKRE,X4BITS            GET SECOND HALF OF BYTE         46600021
         IC    WORKRF,EBCDICTB(WORKRE)       GET EBCDIC FOR HEX         46650021
         STC   WORKRF,ZERO(EBCDICR)     PLACE EBCDIC CHARACTER ON LINE  46700021
         LA    EBCDICR,NUMONE(EBCDICR)       UP OUTPUT POINTER BY ONE   46750021
         LA    HEXR,NUMONE(HEXR)        UP INPUT POINTER TO NEXT BYTE   46800021
*                                                                       46850021
         BCT   MOVELNGR,MOVEMORE        LOWER NUMBER OF BYTES TO BE     46900021
*                                            CONVERTED BY ONE AND IF    46950021
         BR    INTRTNR                       HAVE CONVERTED ALL THAT    47000021
*                                            WAS REQUESTED RETURN TO    47050021
*                                            WHERE CALLED FROM          47100021
         EJECT                                                          47150021
*********************************************************************** 47200021
*                   THE TABLE USED BY THE TEST AND TRANSLATE          * 47250021
*                        INSTRUCTION TO INTERPRET THE DUMP CORE       * 47300021
*                                                                     * 47350021
*********************************************************************** 47400021
         SPACE 2                                                        47450021
*                                       HEX BYTE  TO BE PRINTED AS      47500021
TTRTABLE DC    X'4B'                      '00'          '.'             47550021
         DC    X'4B'                      '01'          '.'             47600021
         DC    X'4B'                      '02'          '.'             47650021
         DC    X'4B'                      '03'          '.'             47700021
         DC    X'4B'                      '04'          '.'             47750021
         DC    X'4B'                      '05'          '.'             47800021
         DC    X'4B'                      '06'          '.'             47850021
         DC    X'4B'                      '07'          '.'             47900021
         DC    X'4B'                      '08'          '.'             47950021
         DC    X'4B'                      '09'          '.'             48000021
         DC    X'4B'                      '0A'          '.'             48050021
         DC    X'4B'                      '0B'          '.'             48100021
         DC    X'4B'                      '0C'          '.'             48150021
         DC    X'4B'                      '0D'          '.'             48200021
         DC    X'4B'                      '0E'          '.'             48250021
         DC    X'4B'                      '0F'          '.'             48300021
         DC    X'4B'                      '10'          '.'             48350021
         DC    X'4B'                      '11'          '.'             48400021
         DC    X'4B'                      '12'          '.'             48450021
         DC    X'4B'                      '13'          '.'             48500021
         DC    X'4B'                      '14'          '.'             48550021
         DC    X'4B'                      '15'          '.'             48600021
         DC    X'4B'                      '16'          '.'             48650021
         DC    X'4B'                      '17'          '.'             48700021
         DC    X'4B'                      '18'          '.'             48750021
         DC    X'4B'                      '19'          '.'             48800021
         DC    X'4B'                      '1A'          '.'             48850021
         DC    X'4B'                      '1B'          '.'             48900021
         DC    X'4B'                      '1C'          '.'             48950021
         DC    X'4B'                      '1D'          '.'             49000021
         DC    X'4B'                      '1E'          '.'             49050021
         DC    X'4B'                      '1F'          '.'             49100021
         DC    X'4B'                      '20'          '.'             49150021
         DC    X'4B'                      '21'          '.'             49200021
         DC    X'4B'                      '22'          '.'             49250021
         DC    X'4B'                      '23'          '.'             49300021
         DC    X'4B'                      '24'          '.'             49350021
         DC    X'4B'                      '25'          '.'             49400021
         DC    X'4B'                      '26'          '.'             49450021
         DC    X'4B'                      '27'          '.'             49500021
         DC    X'4B'                      '28'          '.'             49550021
         DC    X'4B'                      '29'          '.'             49600021
         DC    X'4E'                      '2A'          '+'             49650021
         DC    X'4B'                      '2B'          '.'             49700021
         DC    X'4B'                      '2C'          '.'             49750021
         DC    X'4B'                      '2D'          '.'             49800021
         DC    X'4B'                      '2E'          '.'             49850021
         DC    X'4B'                      '2F'          '.'             49900021
         DC    X'4B'                      '30'          '.'             49950021
         DC    X'4B'                      '31'          '.'             50000021
         DC    X'4B'                      '32'          '.'             50050021
         DC    X'4B'                      '33'          '.'             50100021
         DC    X'4B'                      '34'          '.'             50150021
         DC    X'4B'                      '35'          '.'             50200021
         DC    X'4B'                      '36'          '.'             50250021
         DC    X'4B'                      '37'          '.'             50300021
         DC    X'4B'                      '38'          '.'             50350021
         DC    X'4B'                      '39'          '.'             50400021
         DC    X'4B'                      '3A'          '.'             50450021
         DC    X'4B'                      '3B'          '.'             50500021
         DC    X'4B'                      '3C'          '.'             50550021
         DC    X'4B'                      '3D'          '.'             50600021
         DC    X'4B'                      '3E'          '.'             50650021
         DC    X'4B'                      '3F'          '.'             50700021
         DC    X'40'                      '40'          ' '      A33603 50750021
         DC    X'4B'                      '41'          '.'             50800021
         DC    X'4B'                      '42'          '.'             50850021
         DC    X'4B'                      '43'          '.'             50900021
         DC    X'4B'                      '44'          '.'             50950021
         DC    X'4B'                      '45'          '.'             51000021
         DC    X'4B'                      '46'          '.'             51050021
         DC    X'4B'                      '47'          '.'             51100021
         DC    X'4B'                      '48'          '.'             51150021
         DC    X'4B'                      '49'          '.'             51200021
         DC    X'4A'                      '4A'          '¢'             51250021
         DC    X'4B'                      '4B'          '.'             51300021
         DC    X'4C'                      '4C'          '<'             51350021
         DC    X'4D'                      '4D'          '('             51400021
         DC    X'4E'                      '4E'          '+'             51450021
         DC    X'4F'                      '4F'          '|'             51500021
         DC    X'50'                      '50'          '&'             51550021
         DC    X'4B'                      '51'          '.'             51600021
         DC    X'4B'                      '52'          '.'             51650021
         DC    X'4B'                      '53'          '.'             51700021
         DC    X'4B'                      '54'          '.'             51750021
         DC    X'4B'                      '55'          '.'             51800021
         DC    X'4B'                      '56'          '.'             51850021
         DC    X'4B'                      '57'          '.'             51900021
         DC    X'4B'                      '58'          '.'  LD YA00801 51950001
         DC    X'4B'                      '59'          '.'  LD YA00801 52000001
         DC    X'5A'                      '5A'          ' '      A33603 52050021
         DC    X'5B'                      '5B'          '$'      A33603 52100021
         DC    X'5C'                      '5C'          '*'      A33603 52150021
         DC    X'5D'                      '5D'          ')'      A33603 52200021
         DC    X'5E'                      '5E'          ';'             52250021
         DC    X'5F'                      '5F'          '¬'             52300021
         DC    X'60'                      '60'          '-'             52350021
         DC    X'61'                      '61'          '/'             52400021
         DC    X'4B'                      '62'          '.'             52450021
         DC    X'4B'                      '63'          '.'             52500021
         DC    X'4B'                      '64'          '.'             52550021
         DC    X'4B'                      '65'          '.'             52600021
         DC    X'4B'                      '66'          '.'             52650021
         DC    X'4B'                      '67'          '.'             52700021
         DC    X'4B'                      '68'          '.'             52750021
         DC    X'4B'                      '69'          '.'             52800021
         DC    X'4B'                      '6A'          '.'             52850021
         DC    X'6B'                      '6B'          ','             52900021
         DC    X'6C'                      '6C'          '%'             52950021
         DC    X'6D'                      '6D'          '_'             53000021
         DC    X'6E'                      '6E'          '>'             53050021
         DC    X'6F'                      '6F'          '?'             53100021
         DC    X'4B'                      '70'          '.'             53150021
         DC    X'4B'                      '71'          '.'             53200021
         DC    X'4B'                      '72'          '.'             53250021
         DC    X'4B'                      '73'          '.'             53300021
         DC    X'4B'                      '74'          '.'             53350021
         DC    X'4B'                      '75'          '.'             53400021
         DC    X'4B'                      '76'          '.'             53450021
         DC    X'4B'                      '77'          '.'             53500021
         DC    X'4B'                      '78'          '.'             53550021
         DC    X'4B'                      '79'          '.'             53600021
         DC    X'7A'                      '7A'          ':'      A33603 53650021
         DC    X'7B'                      '7B'          '#'      A33603 53700021
         DC    X'7C'                      '7C'          '@'      A33603 53750021
         DC    X'7D'                      '7D'          '''      A33603 53800021
         DC    X'7E'                      '7E'          '='      A33603 53850021
         DC    X'7F'                      '7F'          '"'      A33603 53900021
         DC    X'4B'                      '80'          '.'             53950021
         DC    X'C1'                      '81'          'A'             54000021
         DC    X'C2'                      '82'          'B'             54050021
         DC    X'C3'                      '83'          'C'             54100021
         DC    X'C4'                      '84'          'D'             54150021
         DC    X'C5'                      '85'          'E'             54200021
         DC    X'C6'                      '86'          'F'             54250021
         DC    X'C7'                      '87'          'G'             54300021
         DC    X'C8'                      '88'          'H'             54350021
         DC    X'C9'                      '89'          'I'             54400021
         DC    X'4B'                      '8A'          '.'             54450021
         DC    X'4B'                      '8B'          '.'             54500021
         DC    X'4B'                      '8C'          '.'             54550021
         DC    X'4B'                      '8D'          '.'             54600021
         DC    X'4B'                      '8D'          '.'             54650021
         DC    X'4B'                      '8F'          '.'             54700021
         DC    X'4B'                      '90'          '.'             54750021
         DC    X'D1'                      '91'          'J'             54800021
         DC    X'D2'                      '92'          'K'             54850021
         DC    X'D3'                      '93'          'L'             54900021
         DC    X'D4'                      '94'          'M'             54950021
         DC    X'D5'                      '95'          'N'             55000021
         DC    X'D6'                      '96'          'O'             55050021
         DC    X'D7'                      '97'          'P'             55100021
         DC    X'D8'                      '98'          'Q'             55150021
         DC    X'D9'                      '99'          'R'             55200021
         DC    X'4B'                      '9A'          '.'             55250021
         DC    X'4B'                      '9B'          '.'             55300021
         DC    X'4B'                      '9C'          '.'             55350021
         DC    X'4B'                      '9D'          '.'             55400021
         DC    X'4B'                      '9E'          '.'             55450021
         DC    X'4B'                      '9F'          '.'             55500021
         DC    X'4B'                      'A0'          '.'             55550021
         DC    X'4B'                      'A1'          '.'             55600021
         DC    X'E2'                      'A2'          'S'             55650021
         DC    X'E3'                      'A3'          'T'             55700021
         DC    X'E4'                      'A4'          'U'             55750021
         DC    X'E5'                      'A5'          'V'             55800021
         DC    X'E6'                      'A6'          'W'             55850021
         DC    X'E7'                      'A7'          'X'             55900021
         DC    X'E8'                      'A8'          'Y'             55950021
         DC    X'E9'                      'A9'          'Z'             56000021
         DC    X'4B'                      'AA'          '.'             56050021
         DC    X'4B'                      'AB'          '.'             56100021
         DC    X'4B'                      'AC'          '.'             56150021
         DC    X'4B'                      'AD'          '.'             56200021
         DC    X'4B'                      'AE'          '.'             56250021
         DC    X'4B'                      'AF'          '.'             56300021
         DC    X'4B'                      'B0'          '.'             56350021
         DC    X'4B'                      'B1'          '.'             56400021
         DC    X'4B'                      'B2'          '.'             56450021
         DC    X'4B'                      'B3'          '.'             56500021
         DC    X'4B'                      'B4'          '.'             56550021
         DC    X'4B'                      'B5'          '.'             56600021
         DC    X'4B'                      'B6'          '.'             56650021
         DC    X'4B'                      'B7'          '.'             56700021
         DC    X'4B'                      'B8'          '.'             56750021
         DC    X'4B'                      'B9'          '.'             56800021
         DC    X'4B'                      'BA'          '.'             56850021
         DC    X'4B'                      'BB'          '.'             56900021
         DC    X'4B'                      'BC'          '.'             56950021
         DC    X'4B'                      'BD'          '.'             57000021
         DC    X'4B'                      'BE'          '.'             57050021
         DC    X'4B'                      'BF'          '.'             57100021
         DC    X'4B'                      'B0'          '.'             57150021
         DC    X'C1'                      'C1'          'A'             57200021
         DC    X'C2'                      'C2'          'B'             57250021
         DC    X'C3'                      'C3'          'C'             57300021
         DC    X'C4'                      'C4'          'D'             57350021
         DC    X'C5'                      'C5'          'E'             57400021
         DC    X'C6'                      'C6'          'F'             57450021
         DC    X'C7'                      'C7'          'G'             57500021
         DC    X'C8'                      'C8'          'H'             57550021
         DC    X'C9'                      'C9'          'I'             57600021
         DC    X'4B'                      'CA'          '.'             57650021
         DC    X'4B'                      'CB'          '.'             57700021
         DC    X'4B'                      'CC'          '.'             57750021
         DC    X'4B'                      'CD'          '.'             57800021
         DC    X'4B'                      'CE'          '.'             57850021
         DC    X'4B'                      'CF'          '.'             57900021
         DC    X'4B'                      'D0'          '.'             57950021
         DC    X'D1'                      'D1'          'J'             58000021
         DC    X'D2'                      'D2'          'K'             58050021
         DC    X'D3'                      'D3'          'L'             58100021
         DC    X'D4'                      'D4'          'M'             58150021
         DC    X'D5'                      'D5'          'N'             58200021
         DC    X'D6'                      'D6'          'O'             58250021
         DC    X'D7'                      'D7'          'P'             58300021
         DC    X'D8'                      'D8'          'Q'             58350021
         DC    X'D9'                      'D9'          'R'             58400021
         DC    X'4B'                      'DA'          '.'             58450021
         DC    X'4B'                      'DB'          '.'             58500021
         DC    X'4B'                      'DC'          '.'             58550021
         DC    X'4B'                      'DD'          '.'             58600021
         DC    X'4B'                      'DE'          '.'             58650021
         DC    X'4B'                      'DF'          '.'             58700021
         DC    X'4B'                      'E0'          '.'             58750021
         DC    X'4B'                      'E1'          '.'             58800021
         DC    X'E2'                      'E2'          'S'             58850021
         DC    X'E3'                      'E3'          'T'             58900021
         DC    X'E4'                      'E4'          'U'             58950021
         DC    X'E5'                      'E5'          'V'             59000021
         DC    X'E6'                      'E6'          'W'             59050021
         DC    X'E7'                      'E7'          'X'             59100021
         DC    X'E8'                      'E8'          'Y'             59150021
         DC    X'E9'                      'E9'          'Z'             59200021
         DC    X'4B'                      'EA'          '.'             59250021
         DC    X'4B'                      'EB'          '.'             59300021
         DC    X'4B'                      'EC'          '.'             59350021
         DC    X'4B'                      'ED'          '.'             59400021
         DC    X'4B'                      'EE'          '.'             59450021
         DC    X'4B'                      'EF'          '.'             59500021
         DC    X'F0'                      'F0'          '0'             59550021
         DC    X'F1'                      'F1'          '1'             59600021
         DC    X'F2'                      'F2'          '2'             59650021
         DC    X'F3'                      'F3'          '3'             59700021
         DC    X'F4'                      'F4'          '4'             59750021
         DC    X'F5'                      'F5'          '5'             59800021
         DC    X'F6'                      'F6'          '6'             59850021
         DC    X'F7'                      'F7'          '7'             59900021
         DC    X'F8'                      'F8'          '8'             59950021
         DC    X'F9'                      'F9'          '9'             60000021
         DC    X'4B'                      'FA'          '.'             60050021
         DC    X'4B'                      'FB'          '.'             60100021
         DC    X'4B'                      'FC'          '.'             60150021
         DC    X'4B'                      'FD'          '.'             60200021
         DC    X'4B'                      'FE'          '.'             60250021
         DC    X'4B'                      'FF'          '.'             60300021
*                                                                       60350021
         EJECT                                                          60400021
*********************************************************************** 60450021
*                                                                     * 60500021
*                        EBCDIC LOOK UP TABLE FOR HEX TO EBCDIC       * 60550021
*                             CONVERSION                              * 60600021
*                                                                     * 60650021
*********************************************************************** 60700021
         SPACE 2                                                        60750021
*                                  HEX VALUE TO BE PRINTED AS           60800021
EBCDICTB DC    C'0'                  '0000'          '0'                60850021
         DC    C'1'                  '0001'          '1'                60900021
         DC    C'2'                  '0010'          '2'                60950021
         DC    C'3'                  '0011'          '3'                61000021
         DC    C'4'                  '0100'          '4'                61050021
         DC    C'5'                  '0101'          '5'                61100021
         DC    C'6'                  '0110'          '6'                61150021
         DC    C'7'                  '0111'          '7'                61200021
         DC    C'8'                  '1000'          '8'                61250021
         DC    C'9'                  '1001'          '9'                61300021
         DC    C'A'                  '1010'          'A'                61350021
         DC    C'B'                  '1011'          'B'                61400021
         DC    C'C'                  '1100'          'C'                61450021
         DC    C'D'                  '1101'          'D'                61500021
         DC    C'E'                  '1110'          'E'                61550021
         DC    C'F'                  '1111'          'F'                61600021
DISABLED DC    X'00'             MASK TO DISABLE ALL INTERRUPTS  A39421 61610021
ENABLED  DC    X'FF'                   MASK TO ENABLE ALL INTER  A39421 61620021
         EJECT                                                          61650021
         SPACE 2                                                        61700021
*                        PRINTER CONTROL CODES                          61750021
         SPACE 2                                                        61800021
WRTSP1   EQU   X'09'                    WRITE AND SPACE ONE LINE        61850021
WRTSPCD  EQU   X'11'                    WRITE AND SPACE TWO LINES       61900021
WRTSP2CD EQU   X'19'                    WRITE AND SPACE THREE LINES     61950021
EJECTCD  EQU   X'89'                    WRITE AND SKIP TO CHANNEL 1     62000021
NUM1     EQU   1                        HEX VALUE OF ONE                62050021
NUM2     EQU   2                        HEX VALUE OF TWO                62100021
NUM3     EQU   3                        HEX VALUE OF THREE              62150021
NUM4     EQU   4                        HEX VALUE OF FOUR               62200021
NUM55    EQU   55                       HEX VALUE OF 55                 62250021
NUM57    EQU   57                      HEX VALUE OF 57                  62258021
RCDC     DC    X'10004020'             ROUTING/DESCRIPTOR CODES         62266021
LENFLGS1 DC    X'00388000'             LENGTH/MCSFLGS FOR WTO 1         62274021
LENFLGS2 DC    X'00358000'             LENGTH/MCSFLGS FOR WTO 2         62282021
MSGHDRID DC    C'IFF005I'              MSG ID                           62290021
NUM256   EQU   256                      HEX VALUE OF 256                62300021
BLANK    EQU   X'40'                    EBCDIC BLANK CHARACTER          62350021
CKNEEDED EQU   X'FF'                    CHECK NEEDED FOR THIS LINE ECB  62400021
CLOSED   EQU   X'F7'             MASK TO SET DCB CLOSED FLGS  LG YM5686 62410000
TXTPAGE  DC    C'PAGE'                                                  62450021
PAGEMASK DC    X'20202020'              MASK USED IN EDIT OF PAGE COUNT 62500021
CKFERROR EQU   X'02'                    HAVE HAD ONE I/0 ERROR ON       62550021
*                                            BSAM OUT PUT               62600021
LOW      EQU   4                        CONDITION CODE FOR LOW (4)      62650021
EQUAL    EQU   8                        CONDITION CODE OF 8 (EQUAL)     62700021
NOTHIGH  EQU   13                       CONDITION CODE OF 13 (NOT HIGH) 62750021
ZERO     EQU   0                        DISPLACEMENT OF ZERO            62800021
NUMONE   EQU   1                        DISPLACEMENT OF ONE             62850021
X4BITS   EQU   4                        MOVEMENT OF 4 BITS              62900021
X8BITS   EQU   8                        SHIFT OF 8 BITS (1 BYTE)        62950021
*                                       ALSO MULTIPLY BY 256            63000021
ABNORMAL EQU   4                        ADNORMAL RETURN CODE            63050021
SUCCESS  EQU   X'7F'                    POST CODE FOR SUCCESSFUL I/O    63500021
FULLMASK EQU   X'FF'                    FULL BYTE OF ONES MASK          63550021
BYTEZERO EQU   X'00'                    BYTE OF ZEROS                   63600021
*                                       BRANCH IF TAKEN                 63650021
IOERBSAM EQU   X'FF'                    BSAM ERROR CONSECTATIVE ERROR   63700021
*                                            INDICATOR                  63750021
ONES     EQU   1                        CONDITION CODE OF ONE           63800021
WTOHEAD  DC    AL1(91)                  WTO MESSAGE LENGTH              63850021
         DC    X'00'                    FILLER                          63900021
         DC    C'IFF005I '              MESSAGE ID                      63950021
WTOUNIT  DC    C'   '                   UNIT ADDRESS                    64000021
WTOUNITL EQU   *-WTOUNIT                LENGTH OF UNIT ADDRESS          64050021
WTOUNDPL EQU   WTOHEAD-WTOUNIT          DISPLACEMENT INTO WTO WHERE     64100021
*                                            UNIT ADDRESS IS PLACED     64150021
WTOLN    EQU   *-WTOHEAD                LENGTH OF WTO HEADER            64200021
*                                                                       64250021
*                                       WORDS USED IN DUMP FORMAT       64300021
*                                                                       64350021
MSG#1    DC    C'*2250 BUFFER DUMP REQUESTED *'                         64400021
MSG#1LN  EQU   *-MSG#1                  LENGTH OF MESSAGE 1 TEXT        64450021
TXTJOBNM DC    C'JOB'                                                   64500021
TXTSTPNM DC    C'STEP'                                                  64550021
TXTTMNM  DC    C'TIME'                                                  64600021
TXTDTNM  DC    C'DATE'                                                  64650021
TXTBFAD  DC    C'BUFFER START REGENERATION ADDRESS'                     64700021
TXTDUMP  DC    C'DUMP OF'                                               64750021
TIMEMASK DC    X'2020204B20204B2020'    MASK USED IN EDIT OF TIME       64800021
DATEMASK DC    X'20204B202020'          MASK USED IN EDIT OF DATE       64850021
ASTERISK EQU   C'*'                     PRINTABLE ASTERISK CHARACTER    64900021
MSGEOD   DC    C'END OF 2250 BUFFER DUMP'         TEXT MESSAGE          64950021
SYSBFDMP DC    C'SYSBFDMP'              DUMP OUTPUT DDNAME              65000021
PATCH    DC    C'IFFCAN02 50 BYTE PATCH AREA.'                          65010000
         DS    0H                  LINEUP SO CAN USE IT ALL D11         65015000
         DC    40X'FF'                                      D11         65020000
*                        STORAGE CONSTANTS                              65050021
X1BYTE   EQU   1                                                        65100021
X2BYTES  EQU   2                        DISPLACEMENT OF TWO             65150021
X3BYTES  EQU   3                        DISPLACEMENT OF THREE BYTES     65200021
X4BYTES  EQU   4                        LENGTH OF 4 BYTES               65250021
X5BYTES  EQU   5                       DISP OF 5 BYTES                  65300021
X8BYTES  EQU   8                        DISPLACEMENT VALUE OF 8         65350021
X24BYTES EQU   24                       DISPLACEMENT VALUE OF 24        65400021
X32BYTES EQU   32                       DISPLACEMENT VALUE OF 32        65450021
X36BYTES EQU   36                       DISPLACEMENT VALUE OF 36        65500021
X3BITS   EQU   3                        MULTIPLY BY 8 (MULTIPIER)       65550021
*                                           (I.E. 3 SHIFT BITS)         65580021
X16BITS  EQU   16                      SHIFT VALUE OF HALF WORD         65610021
X24BITS  EQU   24                       SHIFT VALUE OF 24 BITS          65650021
FOUR     EQU   4                       DISPLACEMENT                     65653021
SEVEN    EQU   7                       LENGTH OF SEVEN                  65656021
TWELVE   EQU   12                      DISPLACEMENT                     65659021
THREE    EQU   3                       DISPLACEMENT                     65662021
SIXTN    EQU   16                      DISPLACEMENT                     65665021
FORTY    EQU   40                      DISPLACEMENT                     65668021
FIFTY    EQU   50                      DISPLACEMENT                     65671021
NUM52    EQU   52                                                       65674021
SIXTY    EQU   60                                                       65677021
X37BYTES EQU   37                                                       65680021
X53BYTES EQU   53                                                       65683021
X56BYTES EQU   56                                                       65686021
X91BYTES EQU   91                                                       65689021
MSG#2AD  EQU   8                        DISPLACEMENT INTO ERROR         65700021
*                                            MESSAGE TABLE FOR IFF002I  65750021
*                                            MESSAGE ADDRESS            65800021
MSG#9    EQU   20                    DISP INTO MSG TABLE     LG @ZM2360 65810000
GIOCR    EQU   33                    DISP INTO TEB           LG @ZM2360 65820000
TEB      EQU   28                    DISP INTO UCB           LG @ZM2360 65830000
DCBGIOCR EQU   49                    DISP INTO DCB           LG @ZM2360 65840000
GIOCRR1  EQU   15                    WORK REG                LG @ZM2360 65842000
PLUSSIGN DC    X'C0'                    PLUSS SIGN FOR PACKED DECIMAL   65850021
         LTORG                                                          65900021
         SPACE 2                                                        65950021
*                             OPCB HEADER VALUES                        66000021
         SPACE 2                                                        66050021
OPCBCOPY DC    X'000C'                  DECIMAL PLUS ZERO PAGE COUNT    66100021
         DC    X'0000'                  HEX ZERO LINE COUNT             66150021
         DC    X'001C'                  DECIMAL PLUS ONE PAGE ADDER     66200021
         DC    X'00'                    BSAM ERROR COUNTER              66250021
         EJECT                                                          66300021
         EJECT                                                          66350021
         WRITE DECBCOPY,SF,,,'S',,,MF=L      DECB COPY                  66400021
DECBLN   EQU   *-DECBCOPY               LENGTH OF DECB                  66450021
         EJECT                                                          66500021
DCBCOPY  DCB   DSORG=PS,MACRF=W,RECFM=MBF,LRECL=124,BLKSIZE=124,       C66550000
               DDNAME=SYSBFDMP,BFALN=F,SYNAD=GETMSG    LG YM5686,A39419 66600000
DCBLEN   EQU   *-DCBCOPY                LENGTH OF DCB                   66650021
         EJECT                                                          66700021
CKQE     DSECT         SYSTEM CANCEL KEY QUEUE ELEMENT                  66750021
         SPACE 2                                                        66800021
CKQECKQE DS    F                        POINTER TO NEXT CKQE ON         66850021
*                                            ACTIVE LIST                66900021
CKQEFLG1 DS    X                        FLAG FIELD BYTE ONE             66950021
CKFGJP   EQU   X'80'                    IS THIS CALL TO SYSTEM CANCEL   67000021
*                                            KEY ROUTINES FROM GJP      67050021
*                                            ABEND HOOK                 67100021
CKFABDMP EQU   X'40'                    A ABEND DUMP IS REQUESTED BY    67150021
*                                            THE 2250 OPERATOR          67200021
CKFATTWT EQU   X'20'                    SYSTEM CANCEL KEY ROUTINES      67250021
*                                            ARE EXPECTING AN ATTENTION 67300021
*                                            FROM DEVICE ASSOCIATED     67350021
*                                            WITH THIS CKQE             67400021
CKFCKCB  EQU   X'10'                    CANCEL KEY CONTROL BLOCK        67450021
*                                            POINTER IS VALID IN CKQE   67500021
CKFEXIT  EQU   X'08'                    EXIT IN PROCESS                 67550021
CKFECB   EQU   X'04'                    GJP ECB POINTER IS VALID IN     67600021
*                                            CKQE AND GJP IS WAITING    67650021
*                                            TO BE POSTED               67700021
CKFDEQUE EQU   X'02'                    SYSTEM CANCEL KEY ROUTINE HAS   67750021
*                                            PERFORMED ALL REQUESTS     67800021
*                                            FOR DEVICE ASSOCIATED      67850021
*                                            WITH THIS CKQE AND THE     67900021
*                                            CKQE SHOULD BE DEQUEUED    67950021
CKFBFRUN EQU   X'01'                    THE 2250 BUFFER WAS RUNNING     68000021
*                                            AT THE TIME THE SYSTEM     68050021
*                                            CANCEL KEY FUNCTION WAS    68100021
*                                            REQUESTED                  68150021
CKQEFLG2 DS    X                        SECOND BYTE OF FLAG FIELD       68200021
CKFROLBF EQU   X'80'                    GETMAIN HAS BEEN ISSUED TO      68250021
*                                            ROLL OUT THE USERS         68300021
*                                            BUFFER SECTION             68350021
CKFROLUT EQU   X'40'                    USERS BUFFER HAS BEEN ROLLED    68400021
*                                            OUT                        68450021
CKFINBUF EQU   X'20'                    GETMAIN FOR INPUT BUFFER FOR    68500021
*                                            BUFFER DUMP REQUEST HAS    68550021
*                                            BEEN ISSUED SUCCESSFULLY   68600021
CKFOPCB  EQU   X'10'                    GETMAIN FOR OUTPUT CONTROL      68650021
*                                            BLOCK HAS BEEN ISSUED      68700021
CKFOPEN  EQU   X'08'                    SYSBFDMP OUTPUT DCB IS OPEN     68750021
CKFLPATN EQU   X'04'                    THIS IS AN ENTRY SCHEDULED      68800021
*                                            BY GAR WITH A LIGHTPEN     68850021
*                                            ATTENTION.                 68900021
CKFWTCNT EQU   X'02'                    THE REQUESTOR OF A        M2878 68907021
*                                            SYSTEM CANCEL KEY    M2878 68914021
*                                            FUNCTION REQUEST     M2878 68921021
*                                            BLOCK'S WAIT COUNT   M2878 68928021
*                                            HAS BEEN INCREMENTED M2878 68935021
*                                            BY ONE               M2878 68942021
CKQEUCB  DS    H                        UNIT CONTROL BLOCK THAT IS NOW  68950021
*                                            UNDER CONTROL OF THE       69000021
*                                            SYSTEM CANCEL KEY ROUTINES 69050021
CKQECKCB DS    F                        POINTER TO CANCEL KEY CONTROL   69100021
*                                            BLOCK ASSOCIATED WITH THIS 69150021
*                                            CKQE                       69200021
CKQEDCB  DS    F                        POINTER TO THE OPEN DATA        69250021
*                                            CONTROL BLOCK FOR THE      69300021
*                                            DEVICE REQUESTING THE      69350021
*                                            SYSTEM CANCEL KEY FUNCTION 69400021
         EJECT                                                          69450021
CKCB     DSECT         SYSTEM CANCEL KEY CONTROL BLOCK                  69500021
         SPACE 2                                                        69550021
CKCBOPCB DS    F                        ADDRESS OF OUTPUT CONTROL BLOCK 69600021
*                                            ASSOCIATED WITH THIS CKCB  69650021
CKCBECB  DS    F                        ADDRESS OF GJP'S ECB TO BE      69700021
*                                            POSTED WHEN SYSTEM CANCEL  69750021
*                                            KEY FUNCTION REQUESTED BY  69800021
*                                            GJP IS COMPLETE            69850021
CKCBSVAR DS    18F                      SAVE AREA FOR IFFCAN01          69900021
CKCBBFAD DS    H                        BUFFER ADDRESS WHERE SYSTEM     69950021
*                                            CANCEL KEY 256 BYTE BUFFER 70000021
*                                            SECTION STARTS.  OPTION    70050021
*                                            PANEL WILL BE PLACED INTO  70100021
*                                            THIS SECTION               70150021
CKCBBFLG DS    H                        BUFFER LENGTH OF THE DATA       70200021
*                                            WRITTEN TO THE 2250 FOR    70250021
*                                            THE OPTIONS PANEL          70300021
CKCBWRKA DS    CL64                    WORK AREA FOR:                   70350021
*                                            READ MI INPUT              70400021
*                                            READ SENSE INPUT           70450021
*                                            BUFFER INQUIRY TABLE       70500021
*                                            WRITE TO OPERATOR MESSAGES 70550021
CKCBDECB DS    8F                       DATA EVENT CONTROL BLOCK        70600021
*                                            USED IN I/O OPERATIONS     70650021
*                                            TO THE 2250                70700021
CKCBREST DS    F                        ADDRESS OF 2250 RESTART         70750021
*                                            GNERATION OF THE USERS     70800021
*                                            BUFFER PROGRAM             70850021
CKCBROLL DS    F                        ADDRESS OF 256 BYTE AREA USED   70900021
*                                            TO ROLL OUT USERS BUFFER   70950021
*                                            IF NO OTHER BUFFER SPACE   71000021
*                                            AVAILABLE FOR THE DEVICE   71050021
CKCBERMT DS    F                        POINTER TO TABLE OF ERROR       71100021
*                                            MESSAGES TO BE SENT TO     71150021
*                                            THE SYSTEM OPERATOR UPON   71200021
*                                            ERROR CONDITION.           71250021
*                                                                       71300021
CKDCBSTR DS    F                       SAVE AREA - DCB BUFFER LI  M6619 71305021
*                                      START ADDRESS          LI A39419 71310021
CKCBWORK DS    F                       LENGTH FOR E GETMAIN   LI A39419 71315021
         DS    F                       ADDR OF ADDR LIST      LI A39419 71320021
         DS    C                       EC MODE                LI A39419 71325021
         DS    C                       SP VALUE               LI A39419 71330021
CKCBBFDP DS    H                       STORAGE FOR SENSE DATA LI A34790 71335021
*                                      FROM UCB ON LP ATTN    LI A34790 71340021
         EJECT                                                          71350021
UCB      DSECT         UNIT CONTROL BLOCK                               71400021
         DS    0F                                                       71450021
         SPACE 2                                                        71500021
UCBIJI   DS    X                        INTERNAL JOB IDENTIFICATION     71550021
UCBACM   DS    X                        ALLOCATION CHANNEL MASK         71600021
UCBID    DS    X                        UCB IDENTIFICATION - HEX FF     71650021
UCBSTBYA DS    X                        STATUS BYTE A                   71700021
UCBCHA   DS    X                        CHANNEL ADDRESS                 71750021
UCBUA    DS    X                        UNIT ADDRESS                    71800021
UCBFL1   DS    X                        FLAG BYTE 1                     71850021
UCBDTI   DS    X                        INDEX TO DEVICE TABLE           71900021
UCBETI   DS    X                        ERROR ROUTINE KEY               71950021
UCBSTI   DS    X                        STATISTICS TABLE INDEX          72000021
UCBLCI   DS    X                        CHANNEL TABEL INDEX             72050021
UCBATI   DS    X                        ATTENTION TABLE INDEX           72100021
UCBWGT   DS    X                        FLAGS AND CHANNEL MASK          72150021
UCBNAME  DS    3X                       UNIT NAME IN EBCDIC             72200021
UCBTYP   DS    F                        DEVICE TYPE                     72250021
MODEL1   EQU   X'31'                    MODEL 1 2250 TYPE CODE          72300021
UCBLTR   DS    H                        LAST REQUEST ELEMENT            72350021
UCBSNS   DS    2H                       SENSE INFORMATION               72400021
UCBUCNT  DS    X                        USE COUNT                       72450021
UCBGCB   DS    X                        GRAPHIC CONTROL BYTE            72500021
UCBTEB   DS    F                        TASK ENTRY BLOCK ADDRESS        72550021
UCBREST  DS    F                        RESTART ADDRESS                 72600021
UCBDEVI  DS    X                        DEVICE INDEX FOR BUFFER TABLE   72650021
UCBBFTAB DS    3X                       BUFFER TABLE ADDRESS            72700021
         EJECT                     BUFFER TABLE                         72750021
BUFTABLE DSECT                                                          72800021
         DS    0F                                                       72850021
         SPACE 2                                                        72900021
BFTLN    DS    H                        TOTAL LENGTH OF BUFFER TABLE    72950021
BFTNMDEV DS    H                        TOTAL NUMBER OF DEVICES         73000021
BFTEXBUF DS    H                        EXPRESS BUFFER SIZE             73050021
BFTTOTAV DS    H                        TOTAL AVAILABLE SECTIONS        73100021
         EJECT                                                          73150021
OPCB     DSECT         OUTPUT CONTROL BLOCK                             73200021
         SPACE 2                                                        73250021
         DS    0F                                                       73300021
OPCBLNI  DS    X                        INDEX OF LINE IN USE            73350021
OPCBCRLN DS    3X                       ADDRESS OF LINE NOW IN USE      73400021
OPCBLN1I DS    X                        INDEX OF LINE ONE (I.E.         73450021
*                                            DISPLACEMENT TO NEXT       73500021
*                                            LINE TO BE USED)           73550021
OPCBLN1  DS    3X                       ADDRESS OF LINE ONE             73600021
OPCBLN2I DS    X                        INDEX OF LINE TWO               73650021
OPCBLN2  DS    3X                       ADDRESS OF LINE TWO             73700021
OPCBLN3I DS    X                        INDEX OF LINE THREE             73750021
OPCBLN3  DS    3X                       ADDRESS OF LINE THREE           73800021
OPCBPCNT DS    H                        PAGE COUNT OF OUTPUT IN DECIMAL 73850021
OPCBLCNT DS    H                        LINE COUNT OF CURRENT PAGE      73900021
*                                            IN HEX                     73950021
OPCBDEC1 DS    H                        HALF WORD OF A DECIMAL ONE      74000021
OPCBERRF DS    X                        BSAM ERROR FLAG FIELD COUNTER   74050021
OPCBHEAD EQU   *-OPCBPCNT               LENGTH OF OPCB HEADER           74100021
OPCBSVAR DS    18F                      SAVE AREA FOR IFFCAN02          74150021
OPCBL1   DS    CL124                   LINE ONE BUFFER AREA             74200021
OPCBL2   DS    CL124                   LINE TWO BUFFER AREA             74250021
OPCBL3   DS    CL124                   LINE THREE BUFFER AREA           74300021
         DS    0F                                                       74350021
OPCBECB  DS    F                       O/P ECB                          74400021
         ORG   OPCBECB                                                  74450021
OPCBDECB DS    CL20                    O/P DECB                         74500021
         DS    0F                                                       74550021
OPCBDCB  DS    F                        ADDRESS OF DCB ASSOCIATED WITH  74600021
*                                            SYSBFDMP DD CARD (I.E.     74650021
*                                            BSAM OUTPUT)               74700021
OPCBINBF DS    F                        ADDRESS OF 256 BYTE INPUT AREA  74750021
*                                            FOR BUFFER SECTIONS TO     74800021
*                                            BE READ INTO.              74850021
OPCBERSV DS    3F                      SAVE AREA FOR BSAM ERROR RTN     74900021
OPCBLEN  EQU   *-OPCB                   LENGTH OF OPCB                  74950021
         EJECT                                                          75000021
*                             INPUT BUFFER                              75050021
INPUTBUF DSECT                                                          75100021
         DC    CL256' '                 ONE BASIC BUFFER SECTION        75150021
INBUFLN  EQU   *-INPUTBUF               LENGTH OF BUFFER IN BYTES       75200021
*                                            INPUT BUFFER AREA          75250021
         EJECT                                                          75300021
SAVEAREA DSECT         SAVE AREA                                        75350021
         SPACE 2                                                        75400021
WD1      DS    F                        FIRST WORD                      75450021
HSA      DS    F                        HEAD SAVE AREA POINTER          75500021
LSA      DS    F                        LAST SAVE AREA POINTER          75550021
RET      DS    F                        RETURN ADDRESS                  75600021
EPA      DS    F                        ENTRY POINT ADDRESS             75650021
R0       DS    F                        REGISTER 0  CONTENTS            75700021
R1       DS    F                        REGISTER 1  CONTENTS            75750021
R2       DS    F                        REGISTER 2  CONTENTS            75800021
R3       DS    F                        REGISTER 3  CONTENTS            75850021
R4       DS    F                        REGISTER 4  CONTENTS            75900021
R5       DS    F                        REGISTER 5  CONTENTS            75950021
R6       DS    F                        REGISTER 6  CONTENTS            76000021
R7       DS    F                        REGISTER 7  CONTENTS            76050021
R8       DS    F                        REGISTER 8  CONTENTS            76100021
R9       DS    F                        REGISTER 9  CONTENTS            76150021
R10      DS    F                        REGISTER 10 CONTENTS            76200021
R11      DS    F                        REGISTER 11 CONTENTS            76250021
R12      DS    F                        REGISTER 12 CONTENTS            76300021
         EJECT                                                          76350021
TIOT     DSECT         TASK INPUT / OUTPUT TABLE                        76400021
         SPACE 2                                                        76450021
TIOTNJOB DS    D                        JOB NAME                        76500021
TIOTSTP  DS    D                        JOB STEP OR PROCEDURE STEP NAME 76550021
TIOTPRC  DS    D                        PROCEDURE JOB STEP NAME         76600021
TIOTHEAD EQU   *-TIOT                   LENGTH OF TIOT HEADER           76650021
         SPACE 2                                                        76700021
TIOTDDEN DSECT                          DD ENTRY IN TIOT                76750021
         SPACE 2                                                        76800021
TIOELNGH DS    X                        LENGTH OF DD ENTRY              76850021
TIOESTTA DS    X                        STATUS BYTE A                   76900021
TIOENTCT DS    X                        NUMBER OF DEVICES REQUESTED     76950021
TIEOLINK DS    X                        ALLOCATION: LINE-CLOSE: FLAG    77000021
TIOEDDNM DS    CL8                      DD NAME                         77050021
TIOEJFCB DS    3X                       RELATIVE ADDRESS OF JFCB        77100021
TIOESTIC DS    X                        STATUS BYTE C                   77150021
TIOESTIB DS    X                        STATUS BYTE B                   77200021
TIOEFSRT DS    3X                       UNIT CONTROL BLOCK ADDRESS      77250021
         EJECT                                                          77300021
TCB      DSECT         TASK CONTROL BLOCK                               77350021
         SPACE 2                                                        77400021
TCBRBP   DS    F                        PROGRAM BLOCK POINTER           77450021
TCBDIE   DS    F                        PROGRAM INTERRUPT ELEMENT       77500021
TCBDEB   DS    F                        DATA EVENT BLOCK QUEUE          77550021
TCBTIO   DS    F                        TASK I/O TABLE                  77600021
         ORG   TCB+124                                                  77650021
TCBJSTCB DS    F                        ADDRESS OF JOB STEP TCB (MVT)   77700021
         EJECT                                                          77750021
DEB      DSECT         DATA EVENT BLOCK                                 77800021
         DS    0F                                                       77850021
         SPACE 2                                                        77900021
DEBNMSUB DS    X                        NUMBER OF SUBROUTINES           77950021
DEBTCBAD DS    3X                       TASK CONTROL BLOCK ADDRESS      78000021
DEBAMLNG DS    X                        LENGTH OF ACCESS METHOD SECTION 78050021
DEBDEBAD DS    CL3                      NEXT DEB ON DEB QUEUE           78100021
         ORG   DEB+16                                                   78150021
DEBNMEXT DS    X                        NUMBER OF EXTENTS               78200021
         ORG   DEB+25                                                   78250021
DEBDCBAD DS    3X                       DATA CONTROL BLOCK ADDRESS      78300021
         ORG   DEB+33                                                   78350021
DEBUCBAD DS    3X                       UNIT CONTROL BLOCK ADDRESS      78400021
         EJECT                                                          78450021
DCB      DSECT                                                          78500021
         DS    0F                                                       78550021
         SPACE 2                                                        78600021
         ORG   DCB+17                                                   78650021
DCBDEVT  DS    X                       DEVICE TYPE                      78700021
DCBDTAPE EQU   X'80'                   TAPE                             78750021
DCBDDA   EQU   X'20'                   DIRECT ACCESS                    78800021
DCBDTDA  EQU   DCBDTAPE+DCBDDA         TAPE OR DA                       78850021
         ORG   DCB+40                                                   78900021
DCBTIOT  DS    H                        OFFSET OF DD ENTRY IN TIOT      78950021
         ORG   DCB+45                                                   79000021
DCBDEBAD DS    3X                       DATA EVENT BLOCK ADDRESS        79050021
         ORG   DCB+48                                                   79100021
DCBOFLGS DS    X                        OPEN FLAGS                      79150021
OPEN     EQU   X'10'                    SUCCESSFUL OPEN FOR THIS DCB    79200021
         EJECT                                                          79250021
*                        DATA EVENT CONTROL BLOCK (GRAPHIC)             79300021
DECB     DSECT                                                          79350021
         SPACE 2                                                        79400021
DECBECB  DS    F                        EVENT CONTROL BLOCK             79450021
DECBTYPE DS    F                        TYPE OF I/O FIELD               79500021
DECBDCB  DS    F                        DATA CONTROL BLOCK ADDRESS      79550021
DECBAREA DS    F                        I/O BUFFER AREA ADDRESS         79600021
DECBHXCD DS    X                        HEX CODE ON I/O COMPLETNESS     79650021
DECBCNT  DS    3X                       CHANNEL STATUS WORD COUNT       79700021
DECBSTA  DS    X                        STATUS BIT A                    79750021
DECBLNGH DS    3X                       LENGTH OF I/O DATA IN BYTES     79800021
DECBSTB  DS    X                        STATUS BIT B                    79850021
DECBSTAD DS    3X                       ADDRESS OF START REGENERATION   79900021
*                                           ADDRESS                     79950021
DECBUNIX DS    X                        UNIT INDEX                      80000021
DECBBFAD DS    3X                       ADDRESS OF DATA TRANSFER TO OR  80050021
*                                            FROM BUFFER ADDRESS        80100021
         EJECT                                                          80150021
SYSCVTPT EQU   16                       STORAGE LOCATION OF CVT ADDRESS 80200021
         SPACE 2                                                        80250021
CVT      DSECT        COMMUNICATION VECTOR TABLE                        80300021
         DS    0F                                                       80350021
         SPACE 2                                                        80400021
CVTTCBP  DS    F                        ADDRESS OF NEXT AND CURRENT     80450021
*                                            TCB POINTERS               80500021
         ORG   CVT+116                                                  80550021
CVTDCB   DS    X                        SYSTEM CONFIGURATION            80600021
MVTSYS   EQU   X'10'                    SYSTEM IS MVT                   80650021
CURRTCB  EQU   4                        DISPLACEMENT TO CURRENT TCB     80700021
*                                            POINTER IN NEW OLD TCB     80750021
*                                            WORDS                      80800021
         EJECT                                                          80850021
LINE     DSECT         OUTPUT LINE FORMAT                               80900021
         SPACE 2                                                        80950021
LNCNTCD  DS    X                        CONTROL CODE FOR PRINTER        81000021
*                                       MESSAGE NUMBER ONE FORMAT       81050021
         DS    2X                                                       81100021
LNJOBNM  DC    C'JOB'                                                   81150021
         DS    X                                                        81200021
LNJOBNAM DC    CL8' '                   JOBNAME                         81250021
         DS    3X                                                       81300021
LNSTPNM  DC    C'STEP'                                                  81350021
         DS    X                                                        81400021
LNSTPNAM DC    CL8' '                   STEPNAME                        81450021
         DS    3X                                                       81500021
LNTMNM   DC    C'TIME'                                                  81550021
LNTIME   DC    CL9' '                   TIME OF DAY                     81600021
         DS    3X                                                       81650021
LNDTNM   DC    C'DATE'                                                  81700021
         DS    X                                                        81750021
LNDATE   DC    CL6' '                   DATE                            81800021
         DS    2X                                                       81850021
LINEWORK DC    F'0'                     WORK AREA                       81900021
         SPACE 2                                                        81950021
*                                       MESSAGE NUMBER TWO FORMAT       82000021
         SPACE 2                                                        82050021
         ORG   LINE+3                                                   82100021
LNDPMSG  DC    C'DUMP OF'                                               82150021
         DS    X                                                        82200021
LNDVAD   DC    C'XXX'                   UNIT ADDRESS                    82250021
         SPACE 2                                                        82300021
*                                       MESSAGE NUMBER THREE FORMAT     82350021
         SPACE 2                                                        82400021
         ORG   LINE+3                                                   82450021
LNBFNM   DC    C'BUFFER START REGENERATION ADDRESS'                     82500021
         DS    X                                                        82550021
LNSTRGAD DC    4C' '                    BUFFER RESTART ADDRESS          82600021
BUFADDLN EQU   *-LNSTRGAD               LENGTH OF BUFFER ADDRESS        82650021
*                                            IN BYTES                   82700021
         SPACE 2                                                        82750021
*                                       MESSACE NUMBER FOUR FORMAT      82800021
         SPACE 2                                                        82850021
         ORG   LINE+1                                                   82900021
LINEBFAD DC    4C' '                    BUFFER ADDRESS                  82950021
         ORG   LINE+86                                                  83000021
LINEFATK DC    C'*'                     FRONT ASTERISK ARROUND          83050021
LININTA  DC    CL32' '                  INTERPERTED BUFFER              83100021
LINTLNG  EQU   *-LININTA                LENGTH OF INTERPERT BUFFER      83150021
LINEBATK DS    C'*'                     FOLLOWING ASTERISK              83200021
         SPACE 2                                                        83250021
*                                       MESSAGE LINE                    83300021
         SPACE 2                                                        83350021
         ORG   LINE+1                                                   83400021
LINETEXT DC    CL123' '                LINE SIZE                        83450021
LINELNG  EQU   *-LINETEXT               LENGTH OF OUTPUT LINE TEXT      83500021
         SPACE 2                                                        83550021
*                                  PAGE COUNT                           83600021
         SPACE 2                                                        83650021
         ORG   LINE+113                                                 83700021
LNPAGNM  DC    C'PAGE    '                                              83750021
         ORG   LNPAGNM+4                                                83800021
LNPAGNO  DC    C'    '                  PAGE COUNT                      83850021
         SPACE 2                                                        83900021
*                             LAST LINE ('END OD DUMP')                 83950021
         SPACE 2                                                        84000021
         ORG   LINE+1                                                   84050021
LNEOD    DC    C'END OF 2250 BUFFER DUMP'                               84100021
         EJECT                                                          84150021
WTOMSG   DSECT                WRITE TO OPERATOR ERROR MESSAGE           84200021
         SPACE 2                                                        84250021
WTOLNG   DS    X                        LENGTH OF MESSAGE               84300021
         DS    X                                                        84350021
WTOID    DC    C'IFF000I'               MESSAGE ID                      84400021
         DS    X                                                        84450021
WTOUNTAD DC    C'XXX'                   UNIT ADDRESS                    84500021
         DS    X                                                        84550021
WTOTEXT  DC    64C' '                   MESSAGE TEXT                    84600021
         END                                                            84650021
./  ADD  SSI=20480893,NAME=IFFCAN03
IFFCAN03 CSECT                                                          02000021
         TITLE ' SYSTEM CANCEL KEY INTEFACE ROUTINE - IFFCAN03'         04000021
*********************************************************************** 06000021
*                                                                     * 08000021
* TITLE - SYSTEM CANCEL KEY INTERFACE ROUTINE                         * 10000021
*                                                                     * 12000021
* NAME  - IFFCAN03                                                    * 14000021
*                                                                     * 16000021
* FUNCTION - CAUSE IFFCAN01(CANCEL KEY ROUTINE) TO BE LOADED AND      * 18000021
*            LINK TO IT                                               * 20000021
*                                                                     * 22000021
* ENTRY POINT - IFFCAN03                                              * 24000021
*                                                                     * 26000021
* INPUT - ADDRESS OF CKQE IN REGISTER ONE                             * 28000021
*                                                                     * 30000021
* OUTPUT - NONE                                                       * 32000021
*                                                                     * 34000021
* EXTERNAL                                                            * 36000021
* REFERENCES - LINK                                                   * 38000021
*                                                                     * 40000021
* EXITS - RETURN TO CALLER                                            * 42000021
*                                                                     * 44000021
* RETURN CODES - NA                                                   * 46000021
*                                                                     * 48000021
* TABLES/WORK AREAS - NONE                                            * 50000021
*                                                                     * 52000021
* ATTRIBUTES -  REENTRANT                                             * 54000021
*                                                                     * 56000021
*********************************************************************** 58000021
         EJECT                                                          60000021
*********************************************************************** 62000021
*                                                                     * 64000021
*                       REGISTER EQUATES                              * 66000021
*                                                                     * 68000021
*********************************************************************** 70000021
R0       EQU   0                                                        72000021
BASE     EQU   12                      BASE REGISTER                    74000021
         SPACE 2                                                        78000021
*********************************************************************** 80000021
         SPACE 2                                                        82000021
         BALR  BASE,R0                 ESTABLISH                        84000021
         USING *,BASE                   ADDRESSABILITY                  86000021
         SAVE  (14,12)                                                  87000021
         LINK  EP=IFFCAN01                                              88000021
         RETURN  (14,12)                                                90000021
         END                                                            92000021
./  ADD  SSI=20480960,NAME=IFFPAAST
IFFPAAST CSECT                          GSTOR                           00020021
         TITLE 'GSTOR' STORE GRAPHIC DATA                               00040021
*TITLE. STORE GRAPHIC ORDERS ROUTINE                                    00050021
*                                                                       00052021
*STATUS. CHANGE LEVEL 0                                                 00060021
*                                                                       00080021
*FUNCTION/OPERATION. GSTOR STORES GRAPHIC DATA IN THE GDOA              00100021
*    (GRAPHIC DATA OUTPUT AREA)                                         00120021
*                                                                       00140021
*ENTRY POINTS. GSTOR VIA CALL OR LINK MACRO  ALIAS NAME IFFPAA          00160021
*                                                                       00180021
*INPUT.OUTPUT CONTROL BLOCK POINTER (OCBP) AND A PARAMETER ADDRESS      00200021
*   WHICH CONTAINS THE ADDRESS OF THE DATA TO STORE AND THE 'N'         00220021
*   NUMBER OF BYTES TO STORE                                            00240021
*                                                                       00260021
*OUTPUT. GRAPHIC DATA STORED IN THE G D O A (GRAPHIC DATA OUTPUT AREA)  00280021
*                                                                       00300021
*EXTERNAL ROUTINES. NONE                                                00320021
*                                                                       00340021
*EXITS-NORMAL. COMPLETION OF TASK EXIT VIA RETURN MACRO                 00360021
*    -ERROR. HEXADECIMAL 14 OR 18 IN REG. 15                            00380021
*  IMMEDIATE RETURN. EXIT VIA RETURN MACRO                              00400021
*                                                                       00420021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE AND USER             00440021
*    SUPPLIED WORK AREA                                                 00460021
*                                                                       00480021
*ATTRIBUTES. READ ONLY, REENTRANT                                       00500021
* STORE GRAPHIC DATA IN USER PROVIDED GRAPHIC DATA OUTPUT AREA-N BYTES  00520021
         ENTRY GSTOR                                                    00540021
GSTOR    SAVE  (14,12),T,*              SYSTEM SAVE 14,15,0 THRU 12     00560021
         BALR  9,0                      SET UP BASE ADDRESS             00580021
         USING *,9                                                      00600021
         SR    15,15                    CLEAR RETURN CODE               00620021
         SR    PASREG,PASREG            CLEAR OVERFLOW PASS REGISTER    00640021
         LM    OBPREG,PATREG,0(1)       LOAD OCBP AND PARTAB ADDRESS    00660021
         LM    ADDREG,CNTREG,0(PATREG)  LOAD INPUT DATA ADDRESS AND N   00680021
GSTOR1   L     OABREG,0(0,OBPREG)       ADDRESS OF OACB                 00700021
         L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        00720021
         LTR   WRKREG,CNTREG            LOAD N AND TEST IF ZERO OR LESS 00740021
         BC    2,GSTOR2                 GREATER THAN ZERO               00760021
         WTO   'IFF541I GSTOR FOUND NON-POSITIVE BYTE COUNT IN PARTAB',X00766021
               ROUTCDE=11,DESC=7                                 S21016 00772021
         LA    15,20                    LOAD RETURN CODE                00780021
         B     EXIT                     RETURN                          00800021
*                                                                       00820021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 00840021
*                                                                       00860021
GSTOR2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N              00880021
         LA    TEMREG,4                                                 00900021
         AR    TEMREG,OLPREG            OLP ADDRESS PLUS N PLUS 4       00920021
         L     SLOREG,0(OABREG)         GET STARTING ADDRESS            00940021
         A     SLOREG,4(OABREG)         LAST ADDRESS OF GDOA            00960021
         L     OLPREG,16(0,OABREG)      RESET OLP ADDRESS               00980021
         CR    TEMREG,SLOREG            COMPARE LAST TO TOTAL AVAILABLE 01000021
         BNH   OK                       ROOM FOR NEW DATA               01020021
*                                                                       01040021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    01060021
*                                                                       01080021
         SR    TEMREG,SLOREG            EQUALS BYTES-CAN'T STORE        01100021
         SR    WRKREG,TEMREG            NUMBER OF BYTES-CAN STORE       01120021
         C     WRKREG,ZERO                                              01140021
         BNH   GSTOR4                   NO STORAGE AVAILABLE            01160021
         SR    CNTREG,WRKREG            BYTES REMAINING                 01180021
         BAL   LINREG,GSTOR6            MOVE GRAPHIC DATA               01200021
GSTOR3   LA    PASREG,1                 SET PASS INDICATOR              01220021
         L     WKAREG,4(0,OBPREG)       ADDRESS OF WORKAREA             01240021
         STM   0,15,0(WKAREG)           SAVE REGISTERS                  01260021
         L     15,8(0,OABREG)           OVERFLOW ADDRESS                01280021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         01300021
*   SAVE AREA. THIS GIVES HIS BASE REGISTER THE RIGHT VALUE             01320021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      01340021
         LM    0,15,0(WKAREG)           RELOAD REGISTERS                01360021
         B     GSTOR1                   STORE REMAINING DATA            01380021
*                                                                       01400021
*                                                                       01420021
*                                                                       01440021
*                                                                       01460021
* NO DATA TO MOVE-NO SPACE AVAILABLE                                    01480021
*                                                                       01500021
GSTOR4   C     PASREG,ONE               WAS A TRANSFER MADE TO OVERFLOW 01520021
         BL    GSTOR3                   NO                              01540021
         WTO   'IFF542I GSTOR, AFTER RETURN FROM OVERFLOW ROUTINE, FOUNX01546021
               D GDOA STILL FULL',ROUTCDE=11,DESC=7              S21016 01552021
         LA    15,24                    SET ERROR RETURN CODE           01560021
         B     EXIT                     RETURN WITH ERROR INDICATION    01580021
*                                                                       01600021
*                                                                       01620021
*                                                                       01640021
* STORE GRAPHIC DATA IN GDOA                                            01660021
*                                                                       01680021
GSTOR6   LA    TEMREG,255               SET REG EQUAL TO 255            01700021
GSTOR6A  CR    WRKREG,TEMREG            IS NO. TO MOVE OVER 255         01720021
         BH    GSTOR7                   YES                             01740021
         LR    TEMREG,WRKREG            LOAD NO. TO MOVE                01760021
         S     TEMREG,ONE               COMPENSATE FOR BYTE OVER        01780021
         EX    TEMREG,MOVE              MOVE DATA                       01800021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              01820021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                01840021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           01860021
         BR    LINREG                   RETURN INTERNAL                 01880021
GSTOR7   LR    SLOREG,TEMREG            SET REG TO 255                  01900021
         S     SLOREG,ONE               REDUCE BY ONE                   01920021
         EX    SLOREG,MOVE              MOVE DATA                       01940021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              01960021
         AR    ADDREG,TEMREG            UPDATE DATA ADDRESS             01980021
         SR    WRKREG,TEMREG            REDUCE AMOUNT TO MOVE           02000021
         B     GSTOR6A                  DO NEXT GROUP                   02020021
OK       BAL   LINREG,GSTOR6            MOVE GRAPHIC DATA               02040021
EXIT     RETURN (14,12),T,RC=(15)       RETURN -CODE SET IN RET CODE    02060021
MOVE     MVC   0(0,OLPREG),0(ADDREG)                                    02080021
ZERO     DC    F'0'                                                     02100021
ONE      DC    F'1'                                                     02120021
FOUR     DC    F'4'                                                     02140021
PASREG   EQU   0                                                        02160021
WKAREG   EQU   1                                                        02180021
OBPREG   EQU   2                                                        02200021
PATREG   EQU   3                                                        02220021
OABREG   EQU   4                                                        02240021
OLPREG   EQU   5                                                        02260021
ADDREG   EQU   6                                                        02280021
CNTREG   EQU   7                                                        02300021
WRKREG   EQU   8                                                        02320021
TEMREG   EQU   10                                                       02340021
LOAREG   EQU   12                                                       02360021
SLOREG   EQU   11                                                       02380021
LINREG   EQU   14                                                       02400021
         DS    0D                                                       02420021
         END                                                            02440021
./  ADD  SSI=20480189,NAME=IFFPBAPR
         TITLE 'GCPRNT - ALPHAMERIC CHARACTER DISPLAY ROUTINE'          00020021
*STATUS. CHANGE LEVEL 0                                               * 00040021
*                                                                     * 00060021
*FUNCTION/OPERATION. GCPRNT GENERATES THE GRAPHIC ORDERS TO DISPLAY A * 00080021
*   STRING OF ALPHAMERIC CHARACTERS ON THE DISPLAY UNIT SCREEN AND    * 00100021
*   STORES THEM IN THE GRAPHIC DATA OUTPUT AREA -(GDOA)               * 00120021
*                                                                     * 00140021
*ENTRY POINTS. GCPRNT VIA CALL OR LINK MACRO   ALIAS NAME IFFPBAPR    * 00160021
*                                                                     * 00180021
*INPUT. OUTPUT CONTROL BLOCK POINTER (OCBP) AND A PARAMETER TABLE     * 00200021
*   WHICH POINTS TO A SEQUENCE OF CHARACTERS IN MAIN STORAGE          * 00220021
*                                                                     * 00240021
*OUTPUT. A STRING OF ALPHAMERIC CHARACTERS STORED IN THE GDOA         * 00260021
*                                                                     * 00280021
*EXTERNAL ROUTINES. N/A                                               * 00300021
*                                                                     * 00320021
*EXITS-NORMAL. COMPLETION OF TASK EXIT VIA RETURN MACRO               * 00340021
*     -ERROR. HEXADECIMAL 4,8,C,10,14,OR 18 IN REG 15                 * 00360021
*   IMMEDIATE RETURN. EXIT VIA RETURN MACRO                           * 00380021
*     -ERROR. HEXADECIMAL 28 IN REG 15  DOES NOT RETURN IMMEDIATELY   * 00400021
*   COMPLETION OF TASK AND RETURN VIA RETURN MACRO                    * 00420021
*                                                                     * 00440021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE, XYLIM TABLE AND   * 00460021
*   WORK AREA                                                         * 00480021
*                                                                     * 00500021
*ATTRIBUTES. READ ONLY, REENTRANT                                     * 00520021
         EJECT                                                          00540021
IFFPBAPR CSECT                          GCPRNT                          00560021
*0669                                                              7468 00570021
         ENTRY GCPRNT                                                   00580021
GCPRNT   SAVE  (14,12),T,*              SAVE REGISTARS                  00600021
         BALR  9,0                                                      00620021
         USING *,9                                                      00640021
         USING PARTAB,PATREG                                            00660021
         USING XYLIMT,XYLREG                                            00680021
         USING WRKAREA,WKAREG                                           00700021
         SR    15,15                    CLEAR ERROR RETURN REG          00720021
         SR    CNTREG,CNTREG            CLEAR BYTE COUNT REG            00740021
         LM    OBPREG,PATREG,0(1)       LOAD OCBP,PARTAB ADDRESS        00760021
         L     WKAREG,4(OBPREG)         LOAD WRKAREA ADDRESS            00780021
         L     OABREG,0(OBPREG)         LOAD OACB ADDRESS               00800021
*  SAVE MASK BITS AS SET BY USER                                        00820021
         ST    9,MASKSV                                                 00840021
         SR    WRKREG,WRKREG                                            00860021
         SPM   WRKREG                                                   00880021
         L     XYLREG,0(PATREG)         LOAD XYLIM TABLE ADDRESS        00900021
         LM    XREG,YREG,4(PATREG)      LOAD X,Y VALUES                 00920021
         ST    15,64(WKAREG)            CLEAR ERROR COUNT IN WRKAREA    00940021
         CH    CNTREG,20(PATREG)        TEST N GREATER THAN 0           00960021
         BNL   ERR20RET                 BR IF BYTES IS 0 OR LESS        00980021
         CLI   12(PATREG),C'F'          TEST FOR FLOAT                  01000021
         BE    FLTLEG                                                   01020021
         CLI   12(PATREG),C'B'          TEST FOR FIX                    01040021
         BE    TESTS                                                    01060021
         BAL   LINREG,ERR40                                             01080021
TESTS    CLI   13(PATREG),C'S'          TEST FOR SCALE                  01100021
         BE    SCALFIX                                                  01120021
         CLI   13(PATREG),C'N'          TEST FOR NOSCALE                01140021
         BE    TESTC                                                    01160021
         BAL   LINREG,ERR40                                             01180021
TESTC    CLI   22(PATREG),C'C'          TEST FOR CURRENT BEAM START     01200021
         BE    TESTMOD                                                  01220021
         CLI   22(PATREG),C'U'          TEST FOR USER SPECIFIED         01240021
         BE    TESTVAL                                                  01260021
         BAL   LINREG,ERR40                                             01280021
*   TEST  UC,VC    FOR 0-4095 LIMITS                                    01300021
TESTVAL  C     XREG,ZERO                                                01320021
         BL    ERR8RET                                                  01340021
         C     XREG,HIGH                                                01360021
         BH    ERR8RET                                                  01380021
         C     YREG,ZERO                                                01400021
         BL    ERR8RET                                                  01420021
         C     YREG,HIGH                                                01440021
         BH    ERR8RET                                                  01460021
*   BUILD  GEPM AND GDV XY(B) ORDERS IN WORK AREA                       01480021
         MVC   68(2,WKAREG),GEPM                                        01500021
         MVC   GOMODE,GEPM                                              01520021
         STH   XREG,70(WKAREG)          STORE  XC                       01540021
         STH   YREG,72(WKAREG)          STORE  YC                       01560021
         OI    70(WKAREG),X'40'         SETBLANK BIT                    01580021
         LA    CNTREG,6                 K=6                             01600021
         EJECT                                                          01620021
*    SUBROUTINE  TO  TEST  CHARACTER  MODE + SIZE  FOR  GRAPHIC  ORDER  01640021
*    PATREG  CONTAINS  THE  ADDRESS  OF  THE  PARAMETER  TABLE          01660021
*   TEST  CHARACTER MODE                                                01680021
TESTMOD  CLI   15(PATREG),C'P'          TEST FOR P MODE -PROTECTED      01700021
         BE    PLEG                                                     01720021
         CLI   15(PATREG),C'F'          TEST FOR F MODE -UNPROTECTED    01740021
         BE    FLEG                                                     01760021
         BAL   LINREG,ERR40                                             01780021
FLEG     LH    ORDREG,GFSC                                              01800021
*   TEST  CHARACTER SIZE                                                01820021
SIZE     CLI   14(PATREG),C'L'          LARGE                           01840021
         BE    SIZEL                                                    01860021
         CLI   14(PATREG),C'B'          BASIC                           01880021
         BE    ORDSTO                                                   01900021
         BAL   LINREG,ERR40                                             01920021
ORDSTO   STH   ORDREG,68(WKAREG,CNTREG)                                 01940021
         STH   ORDREG,GOMODE                                            01960021
         B     COUNT                                                    01980021
SIZEL    A     ORDREG,ONE               BUILD L SIZE                    02000021
         B     ORDSTO                                                   02020021
PLEG     LH    ORDREG,GFPC                                              02040021
         B     SIZE                                                     02060021
*   SET UP TO STORE N-BYTES OF GRAPHIC ORDERS IN GDOA                   02080021
COUNT    A     CNTREG,TWO               NUMBER OF BYTES                 02100021
         LA    ADDREG,68(WKAREG)        GET ADD OF ORDERS               02120021
         BAL   LINREG,STORE                                             02140021
*   SET UP TO STORE N-BYTES OF DATA IN GDOA                             02160021
         LH    CNTREG,20(PATREG,0)                                      02180021
         L     ADDREG,16(PATREG,0)                                      02200021
         BAL   LINREG,STORE                                             02220021
*   TEST  FOR N= EVEN NUMBER                                            02240021
         TM    21(PATREG),X'01'         TEST N                          02260021
         BC    8,RET                                                    02280021
         LA    CNTREG,1                 SET N-BYTES =1                  02300021
         LA    ADDREG,ZERO                                              02320021
         BAL   LINREG,STORE                                             02340021
         B     RET                                                      02360021
FLTLEG   CLI   13(PATREG),C'S'          TEST FOR SCALE                  02380021
         BE    SCALFLT                                                  02400021
         CLI   13(PATREG),C'N'          TEST FOR NO SCALE               02420021
         BE    FCONVERT                                                 02440021
         BAL   LINREG,ERR40                                             02460021
FCONVERT LR    VALREG,XREG              FIXCONVERT -(CONVERT FLOAT      02480021
         BAL   LINREG,FIXCONV           TO FIX)                         02500021
         LR    XREG,VALREG                                              02520021
         LR    VALREG,YREG                                              02540021
         BAL   LINREG,FIXCONV                                           02560021
         LR    YREG,VALREG                                              02580021
         B     TESTC                                                    02600021
SCALFLT  BAL   LINREG,XYLCHK                                            02620021
         EJECT                                                          02640021
*    SET-UP FOR CONVERTING X1Y1X2Y2 TO FLOATING PT VALUES               02660021
         LA    CONREG,4                 LOOP  COUNT                     02680021
         LA    INXREG,0                 SET INDEX                       02700021
         LA    WRKREG,0                 SET INDEX                       02720021
FLTLOOP  LH    VALREG,0(XYLREG,INXREG)  GET X1Y1,X2Y2 VALUES            02740021
         BAL   LINREG,FLTCONV                                           02760021
         ST    VALREG,4(WKAREG,WRKREG)                                  02780021
         A     INXREG,TWO                                               02800021
         A     WRKREG,FOUR                                              02820021
         BCT   CONREG,FLTLOOP                                           02840021
*    FLOATING POINT SPECIFIED - TEST FOR CHARACTERISTIC ZERO AND        02860021
*    FRACTION NON ZERO. OF ALL U,V VALUES                               02880021
         L     VALREG,U1                                                02900021
         BAL   LINREG,FIXCONV                                           02920021
         L     VALREG,U2                                                02940021
         BAL   LINREG,FIXCONV                                           02960021
         L     VALREG,V1                                                02980021
         BAL   LINREG,FIXCONV                                           03000021
         L     VALREG,V2                                                03020021
         BAL   LINREG,FIXCONV                                           03040021
         L     VALREG,UC                                                03060021
         BAL   LINREG,FIXCONV                                           03080021
         L     VALREG,VC                                                03100021
         BAL   LINREG,FIXCONV                                           03120021
*   SUBROUTINE  TO SCALE  FLOATING  POINT  VALUES                       03140021
*        X=(UC-U1)*(X2-X1)/(U2-U1)+X1                                   03160021
*        Y=(VC-V1)*(Y2-Y1)/(V2-V1)+Y1                                   03180021
*    SCALED  FLOATING  VALUES  LOADED  IN  XREG AND YREG                03200021
FLTSCAL  LE    0,4(PATREG)              UC                              03220021
         SE    0,8(XYLREG)                -U1                           03240021
         LE    2,12(WKAREG)             X2                              03260021
         SE    2,4(WKAREG)                -X1                           03280021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    03300021
         MER   0,2                      MULTIPLICAND* MULTIPLIER        03320021
         LE    2,12(XYLREG)             U2                              03340021
         SE    2,8(XYLREG)                -U1                           03360021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    03380021
         DER   0,2                      DIVIDEND/ DIVISOR               03400021
         AE    0,4(WKAREG)              QUOTIENT+X1                     03420021
         STE   0,0(WKAREG)                                              03440021
         L     XREG,0(WKAREG)           SCALED FLOATING VAL UC IN XREG  03460021
         LE    0,8(PATREG)              VC                              03480021
         SE    0,16(XYLREG)               -V1                           03500021
         LE    2,16(WKAREG)             Y2                              03520021
         SE    2,8(WKAREG)                -Y1                           03540021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    03560021
         MER   0,2                                                      03580021
         LE    2,20(XYLREG)             V2                              03600021
         SE    2,16(XYLREG)               -V1                           03620021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    03640021
         DER   0,2                                                      03660021
         AE    0,8(WKAREG)              +Y1                             03680021
         STE   0,0(WKAREG)                                              03700021
         L     YREG,0(WKAREG)           SCALED FLOATING VAL VC IN YREG  03720021
         B     FCONVERT                                                 03740021
SCALFIX  BAL   LINREG,XYLCHK                                            03760021
         EJECT                                                          03780021
*    SUBROUTINE  TO  SCALE  FIX  POINT  VALUES                          03800021
*    XREG AND YREG CONTAIN U AND V VALUES FROM THE PARAMETER TABLE      03820021
*        X=(UC-U1)*(X2-X1)/(U2-U1)+X1                                   03840021
*        Y=(VC-V1)*(Y2-Y1)/(V2-V1)+Y1                                   03860021
*   SCALED UC AND VC  ARE  RETURNED TO YREG AND YREG                    03880021
FIXSCAL  S     XREG,8(XYLREG)           UC-U1                           03900021
         LR    ODDREG,XREG              LOAD MULTIPLICAND               03920021
         LH    XREG,4(XYLREG)           X2                              03940021
         SH    XREG,0(XYLREG)             -X1                           03960021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    03980021
         SR    EVEREG,EVEREG            CLEAR EVEN REG                  04000021
         MR    EVEREG,XREG              (VC-U1)*(X2-X1) = (DIVIDEND)    04020021
         L     XREG,12(XYLREG)          U2                              04040021
         S     XREG,8(XYLREG)             -U1                           04060021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    04080021
         SR    EVEREG,EVEREG            CLEAR EVEN FOR DIVIDE           04100021
         DR    EVEREG,XREG              DIVIDEND/DIVISOR                04120021
         AH    ODDREG,0(XYLREG)         QUOTIENT +1                     04140021
         LR    XREG,ODDREG              SCALED VC IN XREG               04160021
         S     YREG,16(XYLREG)          VC-V1                           04180021
         LR    ODDREG,YREG                                              04200021
         LH    YREG,6(XYLREG)           Y2                              04220021
         SH    YREG,2(XYLREG)             -Y1                           04240021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    04260021
         SR    EVEREG,EVEREG                                            04280021
         MR    EVEREG,YREG                                              04300021
         L     YREG,20(XYLREG)          V2                              04320021
         S     YREG,16(XYLREG)            -V1                           04340021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    04360021
         SR    EVEREG,EVEREG                                            04380021
         DR    EVEREG,YREG              DIVIDEND/DIVISOR                04400021
         AH    ODDREG,2(XYLREG)         QUOTIENT + Y1                   04420021
         LR    YREG,ODDREG              SCALED VC IN YREG               04440021
         B     TESTC                                                    04460021
*    CONVERT  FLOATING  POINT  TO  FIXED  POINT  VALUES                 04480021
*    TEST FLOATING POINT INPUT VALIDITY                                 04500021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          04520021
FIXCONV  ST    VALREG,0(WKAREG)         STORE FLT VAL IN WORKAREA       04540021
         LE    6,0(WKAREG)              LOAD VALUE TO FLOAT REG         04560021
         N     VALREG,FCHAR             CHECK  CHARACTERISTIC           04580021
         BE    FLERR1                   POSSIBLE ERROR                  04600021
FCHECOK  AU    6,X6                     ADD EXPONENT TO FLOAT REG       04620021
         STE   6,0(WKAREG)              STORE CONV IN WORKAREA          04640021
         L     VALREG,0(WKAREG)         LOAD TO GR                      04660021
         N     VALREG,XZERO             DROP CHARACTERISTIC             04680021
         LTR   VALREG,VALREG            IS VAL NEGATIVE                 04700021
         BNL   NOTNEG                                                   04720021
         N     VALREG,NSIGN             DROP SIGN                       04740021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLIMENT           04760021
NOTNEG   BR    LINREG                   RETURN TO NSI AFTER BAL         04780021
FLERR1   CE    6,ZERO                   IS VAL ZERO                     04800021
         BE    FCHECOK                                                  04820021
         B     ERR12RET                                                 04840021
         EJECT                                                          04860021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  VALUES                 04880021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          04900021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   04920021
         ST    VALREG,0(WKAREG)                                         04940021
         LE    0,0(WKAREG)              LOAD FLOATING PT REG            04960021
         AE    0,X6                     NORMALIZE                       04980021
         STE   0,0(WKAREG)                                              05000021
         L     VALREG,0(WKAREG)         FLOAT PT VAL IN VALREG          05020021
         BR    LINREG                                                   05040021
*   XYLCHK  SUBROUTINE                                                  05060021
*   CHECK X1,X2,Y1,Y2 LIMITS GREATER THAN 0 AND LESS THAN 4095          05080021
*   CHECK X1 LESS THAN X2 , Y1 LESS THAN Y2                             05100021
*   ADDRESSOF XYLIM TABLE IN XYLREG BEFORE BAL                          05120021
XYLCHK   LA    CONREG,4                SET LOOP CONTROL                 05140021
         LA    INXREG,0                 SET  INDEX                      05160021
XYLLOOP  LH    TEMREG,0(XYLREG,INXREG)  X1,Y1,X2,Y2                     05180021
         C     TEMREG,ZERO                                              05200021
         BL    ERR4RET                                                  05220021
         C     TEMREG,HIGH                                              05240021
         BH    ERR4RET                                                  05260021
         A     INXREG,TWO                                               05280021
         BCT   CONREG,XYLLOOP                                           05300021
         CLC   0(2,XYLREG),4(XYLREG)    X1 COMP  X2                     05320021
         BNL   ERR4RET                                                  05340021
         CLC   2(2,XYLREG),6(XYLREG)    Y1 COMP  Y2                     05360021
         BNL   ERR4RET                                                  05380021
         BR    LINREG                                                   05400021
         EJECT                                                          05420021
*   LOAD ERROR CODE IN REG 15                                           05440021
ERR40    LA    15,40                    PARAMETER ERROR - DOES NOT RET  05460021
         B     ERRCNT                                                   05480021
ERR24RET LA    15,24                     USERS OVF HAS NOT RESET OLP    05500021
         B     ERRCNTR                                                  05520021
ERR20RET LA    15,20                   PARAMETER ERROR - RETURNS        05540021
         B     ERRCNTR                                                  05560021
ERR16RET LA    15,16                     U1,V1 GREATER THAN U2,V2       05580021
         B     ERRCNTR                                                  05600021
ERR12RET LA    15,12                     FLT PT ERROR DETECTED          05620021
         B     ERRCNTR                                                  05640021
ERR8RET  LA    15,8                      U,V LIMIT ERROR AFTER SCALE    05660021
         B     ERRCNTR                                                  05680021
ERR4RET  LA    15,4                      XYLIM X1,Y1  X2,Y2 LIMIT ERROR 05700021
ERRCNTR  LA    LINREG,RET                                               05720021
ERRCNT   L     TEMREG,64(WKAREG)                                        05740021
         A     TEMREG,ONE                                               05760021
         ST    TEMREG,64(WKAREG)                                        05780021
         BR    LINREG                                                   05800021
*   TEST ERROR COUNT IN WORK AREA AND SET BIT                           05820021
*   IN HIGH POSITION OF REG 15 IF MULTIPLE ERRORS                       05840021
RET      LA    TEMREG,1                                                 05860021
         C     TEMREG,64(WKAREG)                                        05880021
         BL    SETBIT                                                   05900021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            05920021
RETMACRO L     WRKREG,MASKSV                                            05940021
         SPM   WRKREG                                                   05960021
         RETURN (14,12),T,RC=(15)                                       05980021
SETBIT   O     15,MZERO                                                 06000021
         B     RETMACRO                                                 06020021
         EJECT                                                          06040021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    06060021
* INPUT TO SUBROUTINE                                                   06080021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   06100021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                06120021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               06140021
*   OABREG = ADDRESS OF OACB                                            06160021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   06180021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        06200021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              06220021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 06240021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        06260021
         LA    TEMREG,4                                                 06280021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               06300021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    06320021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       06340021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       06360021
         CR    TEMREG,SLOREG                                            06380021
         BNH   OK                       ROOM FOR DATA                   06400021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    06420021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         06440021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       06460021
* ANY BYTES TO STORE                                                    06480021
         C     WRKREG,ZERO                                              06500021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           06520021
         LH    TEMREG,H2A02                                             06540021
         CH    TEMREG,GOMODE                                            06560021
         BH    STORE3A                                                  06580021
         LH    TEMREG,H0003                                             06600021
         NR    TEMREG,WRKREG                                            06620021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (BAPR)      7468 06640021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      06660021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 06680021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              06700021
* STORE REGISTERS IN WORKAREA                                           06720021
         STM   0,15,0(WKAREG)           SAVE REGISTERS IN WORKAREA      06740021
         L     15,8(0,OABREG)           OVER FLOW ADDRESS               06760021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         06780021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      06800021
         LM    0,15,0(WKAREG)           RELOAD FROM WORKAREA            06820021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    06840021
* NO SPACE AVAILABLE                                                    06860021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 06880021
         BL    STORE3                   NO                              06900021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          06920021
         B     ERR24RET                                                 06940021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 06960021
         BR    LINREG                                                   06980021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           07000021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      07020021
         BH    STORE7                   YES                             07040021
         LR    TEMREG,WRKREG                                            07060021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       07080021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               07100021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              07120021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                07140021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           07160021
         BR    INTLNK                   RETURN INTERNALLY               07180021
STORE7   LR    SLOREG,TEMREG                                            07200021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       07220021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               07240021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              07260021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            07280021
         SR    WRKREG,TEMREG           REDUCE BY 255                    07300021
         B     STORE6A                  MAKE NEXT COMPARISON            07320021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               07340021
         EJECT                                                          07360021
ZERO     DC    F'0'                                                     07380021
ONE      DC    F'1'                                                     07400021
TWO      DC    F'2'                                                     07420021
FOUR     DC    F'4'                                                     07440021
HIGH     DC    F'4095'                                                  07460021
H2A02    DC    X'2A02'                                                  07480021
H0003    DC    H'0003'                                                  07500021
FCHAR    DC    X'7F000000'                                              07520021
XZERO    DC    X'80FFFFFF'                   SIGN AND VALUE -DROP EXPO  07540021
X6       DC    X'46000000'                   EXPONENT OF SIX            07560021
NSIGN    DC    X'7FFFFFFF'                   DROP SIGN -RETAIN VALUE    07580021
MZERO    DC    X'80000000'                                              07600021
GEPM     DC    X'2A00'                                                  07620021
GFSC     DC    X'2A40'                                                  07640021
GFPC     DC    X'2A44'                                                  07660021
PASREG   EQU   0                                                        07680021
VALREG   EQU   0                                                        07700021
WKAREG   EQU   1                                                        07720021
OBPREG   EQU   2                                                        07740021
OABREG   EQU   2                                                        07760021
PATREG   EQU   3                                                        07780021
XREG     EQU   4                                                        07800021
OLPREG   EQU   4                                                        07820021
WRKREG   EQU   5                                                        07840021
YREG     EQU   5                                                        07860021
CNTREG   EQU   6                                                        07880021
INXREG   EQU   7                                                        07900021
ORDREG   EQU   7                                                        07920021
ADDREG   EQU   8                                                        07940021
XYLREG   EQU   8                                                        07960021
EVEREG   EQU   10                                                       07980021
TEMREG   EQU   10                                                       08000021
ODDREG   EQU   11                                                       08020021
SLOREG   EQU   11                                                       08040021
LINREG   EQU   12                                                       08060021
CONREG   EQU   14                                                       08080021
INTLNK   EQU   14                                                       08100021
         EJECT                                                          08120021
PARTAB   DSECT                                                          08140021
XYLIM    DS    CL4                                                      08160021
UC       DS    CL4                                                      08180021
VC       DS    CL4                                                      08200021
F        DS    CL1                                                      08220021
S        DS    CL1                                                      08240021
CSIZE    DS    CL1                                                      08260021
CMODE    DS    CL1                                                      08280021
DATA     DS    CL4                                                      08300021
N        DS    CL2                                                      08320021
START    DS    CL1                                                      08340021
*                                                                       08360021
XYLIMT   DSECT                                                          08380021
X1       DS    CL2                                                      08400021
Y1       DS    CL2                                                      08420021
X2       DS    CL2                                                      08440021
Y2       DS    CL2                                                      08460021
U1       DS    CL4                                                      08480021
U2       DS    CL4                                                      08500021
V1       DS    CL4                                                      08520021
V2       DS    CL4                                                      08540021
WRKAREA  DSECT                                                          08560021
OVFSAVE  DS    CL64                     STORE SAVE AREA- OVERFLOW       08580021
PORSAVE  DS    CL64                     POR SAVE.AREA                   08600021
ERRCOUNT DS    CL4                      ERROR COUNT SAVE AREA           08620021
ORDBUILD DS    CL8                      ORDER BUILD AREA                08640021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    08660021
         ORG   OVFSAVE+396                                              08680021
GOMODE   DS    CL2                                                      08700021
         END                                                            08720021
./  ADD  SSI=20480469,NAME=IFFPCAAR
         TITLE 'GARC-CIRCULAR ARC GENERATION ROUTINE(ROUTINE)'          00020021
*STATUS. CHANGE LEVEL 0                                               * 00040021
*                                                                     * 00060021
*FUNCTION/OPERATION. GARC GENERATES THE GRAPHIC ORDERS AND DATA TO    * 00080021
*   DISPLAY A SERIES OF POINTS THAT APPROXIMATE A CIRCLE OR ARC ON    * 00100021
*   THE DISPLAY UNIT SCREEN AND STORES THEM IN THE GRAPHIC DATA OUTPUT* 00120021
*   AREA-(GDOA)                                                       * 00140021
*                                                                     * 00160021
*ENTRY POINTS.GARC VIA CALL OR LINK MACRO  ALIAS NAME IFFPCAAR        * 00180021
*                                                                     * 00200021
*INPUT.OUTPUT CONTROL BLOCK POINTER(OCBP) AND A PARAMETER TABLE       * 00220021
*   WHICH CONTAINS PARAMETERS REQUIRED BY GARC                        * 00240021
*                                                                     * 00260021
*OUTPUT.A GRAPHIC ORDER GEPM TO CAUSE DISPLAY UNIT ENTERING POINT     * 00280021
*   PLOTTING MODE AND A SERIES OF DATA BYTES WHICH CONTAIN THE X,Y    * 00300021
*   COORDIATES OF THE CIRCLE OR ARC. THE OUTPUT ARE STORED IN GDOA    * 00320021
*                                                                     * 00340021
*EXTERNAL ROUTINES. N/A                                               * 00360021
*                                                                     * 00380021
*EXITS-NORMAL.COMPLETION OF TASK EXIT VIA RETURN MACRO                * 00400021
*     -ERROR.HEXADECIMAL 4,12,16,20,24,28,AND 32(WHEN OFF-SCREEN ONLY)* 00420021
*   IN REG 15 RETURN IMMEDIATELY. EXIT VIA RETURN MACRO               * 00440021
*     -ERROR.HEXADECIMAL 32(WHEN NOT OFF-SCREEN),40,44,48 IN REG 15   * 00460021
*   DO NOT RETURN IMMEDIATELY. UPON COMPLETION OF TASK,RETURN VIA     * 00480021
*   RETURN MACRO                                                      * 00500021
*                                                                     * 00520021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE,XYLIM TABLE AND    * 00540021
*   WORK AREA                                                         * 00560021
*                                                                     * 00580021
*ATTRIBUTES.READ ONLY,REENTRANT                                       * 00600021
*                                                                     * 00620021
IFFPCAAR CSECT                                                          00640021
*0669                                                              7468 00650021
         ENTRY GARC                                                     00660021
GARC     SAVE  (14,12),T,*              SAVE REGISTERS                  00680021
         BALR  9,0                                                      00700021
         USING *,9                                                      00720021
         SR    NPAREG,NPAREG            INIT  NO.OF POINTS ATTEMPTED    00740021
*                                                                       00760021
*   INITIALIZATION                                                      00780021
*                                                                       00800021
MAINRT   L     WRKREG,0(0,1)            GET OCBP ADDRESS                00820021
         L     PATREG,4(0,1)            GET PARTAB ADDRESS              00840021
         USING PARTAB,PATREG                                            00860021
         L     WKAREG,4(0,WRKREG)       GET WORKAREA ADDRESS            00880021
         USING WKAREA,WKAREG                                            00900021
         L     OABREG,0(WRKREG)         GET OACB ADDRESS                00920021
         ST    OABREG,WOACB                                             00940021
         L     XYLREG,XYLIM             LOAD XYLIM ADDR INTO XYLREG     00960021
         USING XYLIMTB,XYLREG                                           00980021
*  SAVE MASK BITS AS SET BY USER                                        01000021
         ST    9,MASKSV                                                 01020021
         SR    WRKREG,WRKREG                                            01040021
         SPM   WRKREG                                                   01060021
         MVC   WUC,UC                   SAVE UC VC FOR WORKING          01080021
         MVC   WVC,VC                                                   01100021
         MVC   WR,RU                    SAVE RADIUS FOR WORKING         01120021
         MVC   WALPHA,ALPHA             SAVE ALPHA FOR WORKING          01140021
         SR    15,15                    CLEAR ERROR CODE REGISTER       01160021
         ST    15,ERRCOUNT              CLEAR ERROR COUNT               01180021
         BAL   LINREG,XYLCHK                                            01200021
*                                                                       01220021
*   TEST OFF S/G OPTION SPECIFIED AND DECIDE BOUNDARY TO BE OBSERVED    01240021
*                                                                       01260021
TESTSG   CLI   SG,C'A'                  IS OPTION A SPECIFIED           01280021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          01300021
         CLI   SG,C'B'                  IS OPTION B SPECIFIED           01320021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        01340021
         CLI   SG,C'C'                  IS C OPTION SPECIFIED           01360021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          01380021
         CLI   SG,C'D'                  IS D OPTION SPECIFIED           01400021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          01420021
         CLI   SG,C'E'                  IS E OPTION SPECIFIED           01440021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        01460021
         BAL   LINREG,ERR40             OTHERWISE INPUT ERROR ASSUME E  01480021
MVSCRLIM LA    WRKREG,SCRCHK            GET SCREEN CHECK RT ADDR        01500021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     01520021
         B     TESTF                                                    01540021
MVGRDLIM LA    WRKREG,GRDCK             LOAD GRID CHECK RT ADDR         01560021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     01580021
*                                                                       01600021
*   TEST IF FLOATING AND/OR SCALING INPUT USED                          01620021
*                                                                       01640021
TESTF    CLI   F,C'F'                   TEST FOR FLOAT                  01660021
         BE    FLTRT                                                    01680021
         CLI   F,C'B'                   TEST FOR FIX                    01700021
         BE    TESTSC                                                   01720021
         BAL   LINREG,ERR40                                             01740021
TESTSC   CLI   S,C'S'                   TEST FOR SCALING                01760021
         BE    SCALFIX                                                  01780021
         CLI   S,C'N'                   TEST FOR NO SCALING             01800021
         BE    TESTIN                                                   01820021
         BAL   LINREG,ERR40                                             01840021
         B     TESTIN                                                   01860021
FLTRT    CLI   S,C'S'                   TEST FOR SCALING                01880021
         BE    SCALFLT                                                  01900021
         CLI   S,C'N'                   TEST FOR NO SCALING             01920021
         BE    FCONVERT                                                 01940021
         BAL   LINREG,ERR40                                             01960021
         B     FCONVERT                                                 01980021
*                                                                       02000021
*   TEST INPUT PARAMETERS                                               02020021
*                                                                       02040021
TESTIN   SR    NPAREG,NPAREG            INITIATE PT COUNT               02060021
         C     NPAREG,WR                COMPARE RADIUS TO ZERO          02080021
         BNL   ERR20RET       IF NEGATIVE OR ZERO SET ERROR CODE        02100021
         CH    NPAREG,THETA             COMPARE ZERO TO THETA           02120021
         BH    ERR20RET                                                 02140021
         CH    NPAREG,GAMMA                                             02160021
         BH    ERR20RET                                                 02180021
         CLI   INC,C'D'                 TEST IF INC=D                   02200021
         BE    TESTD                     IF SO TEST DENSITY FIELD       02220021
         CLI   INC,C'A'                 TEST IF INC=A                   02240021
         BE    TESTA                     IF SO TEST ALPHA FIELD         02260021
         B     ERR20RET                                                 02280021
*   MAIN ROUTINE                                                        02300021
*                                                                       02320021
TESTD    CH    NPAREG,DENSITY           COMPARE ZERO TO DENSITY         02340021
         BH    ERR20RET                 IF NEGTIVE GO TO SET ERRORCODE  02360021
         L     WRKREG,FOUR                                              02380021
         CH    WRKREG,DENSITY           COMPARE FOUR TO DENSITY         02400021
         BH    COMALP                   GO TO COMPUTE ALPHA AS D IS 0-3 02420021
CONVRD   L     MPCREG,C360              CONVERT DENSITY TO ALPHA        02440021
         MH    MPCREG,DENSITY           DENSITY*360                     02460021
         SRDA  MPCREG,32                                                02480021
         SLDA  MPCREG,28                                                02500021
         D     MPCREG,TWOPI                                             02520021
         SR    MPCREG,MPCREG                                            02540021
         D     MPCREG,WR                DIVIDED BY RADIUS               02560021
         SLA   MPCREG,1                 SHIFT TO DOUBLE THE REMAINDER   02580021
         C     MPCREG,WR                                                02600021
         BL    CHECK                    NO ROUNDING IF 2*REMAINDER LT R 02620021
        A     PRDREG,ONE                ROUND BY ADD ONE TO QUOTIENT    02640021
CHECK    C     PRDREG,ZERO              CHECK VALIDITY OF RESULT        02660021
         BL    ERR20RET                                                 02680021
         BE    SETALP                                                   02700021
         STH   PRDREG,WALPHA            SAVE COMPUTED ALPHA             02720021
         B     ALPRECK                                                  02740021
TESTA    CH    NPAREG,ALPHA             COMPARE ALPHA TO ZERO           02760021
         BH    ERR20RET                 IF NEGTIVE GO TO SET ERRORCODE  02780021
         BNE   ALPRECK                                                  02800021
COMALP   LA    DVDREG,345                IF YES COMPUTE ALPHA           02820021
         C     DVDREG,WR                                                02840021
         BL    SETALP                    OTHERWISE                      02860021
         SRDA  DVDREG,32(0)                                             02880021
         D     DVDREG,WR                                                02900021
         STH   QUOREG,WALPHA            SAVE COMPUTED ALPHA             02920021
ALPRECK  LH    WRKREG,WALPHA            GET ALPHA                       02940021
         C     WRKREG,C360              COMPARE ALPHA TO 360            02960021
         BH    ERR20RET                 IF OVER 360 GO TO SET ERRCODE   02980021
         B     STOEPM                                                   03000021
SETALP   L     WRKREG,ONE               SET ALPHA TO ONE                03020021
         STH   WRKREG,WALPHA            STORE ALPHA                     03040021
STOEPM   STM   2,12,PORSAVE             STORE REGISTERS                 03060021
         MVC   GOMODE,EPM                                               03080021
         LA    CNTREG,2                 PASSING BYTE NUMBER             03100021
         LA    ADDREG,EPM               LOAD GEPM ADDRESS               03120021
         L     OABREG,WOACB             GET OACB ADDR SAVED             03140021
         BAL   LINREG,STORE                                             03160021
         LM    2,12,PORSAVE             RESTORE REGISTERS               03180021
TESTGM   LH    DVDREG,GAMMA             SEE IF GAMMA ZERO               03200021
         CH    DVDREG,ZERO               IF YES                         03220021
         BE    ONEPT                      THIS IS ONE POINT PLOTTING    03240021
         SRDA  DVDREG,32(0)                                             03260021
         D     DVDREG,C360                COMPUTE GAMMA(MOD 360)        03280021
         C     DVDREG,ZERO              CHECK IF GAMMA(MOD 360) ZERO    03300021
         BNE   ARCRT                     IF NOT IT IS AN ARC            03320021
         L     GMREG,C360                IF YES SET GAMMI=360 (CIRCLE)  03340021
         B     PROCEED                                                  03360021
ONEPT    SR    GMREG,GMREG              GAMMI=0 IF ONE POINT            03380021
         B     PROCEED                                                  03400021
ARCRT    LR    GMREG,DVDREG             GAMMI=GAMMA(MOD 360)            03420021
PROCEED  LH    DVDREG,THETA             GET THETA                       03440021
         SRDA  DVDREG,32(0)                                             03460021
         D     DVDREG,C360              COMPUTE THET=THETA(MOD 360)     03480021
         AR    GMREG,DVDREG              GAMM=GAMMI+THET                03500021
         STH   GMREG,WGAMMA                                             03520021
         STH   DVDREG,WTHETA            SAVE INITIAL THETA              03540021
         STH   DVDREG,WDELTA            SAVE INITIAL THETA AS DELTA     03560021
DTENTRY  SRDA  DVDREG,32                                                03580021
         D     DVDREG,C90               COMPUTE THET(MOD 90)            03600021
         SLA   QUOREG,1                                                 03620021
         C     DVDREG,ZERO               IS THET=K TIMES 90             03640021
         BNE   COMPXYI                   IF NOT GO TO COMPUTE XYI       03660021
         C     QUOREG,ZERO               IF YES ASSIGN XI YI VALUES     03680021
         BNE   TESTG2                     DEPENDING ON QUADRANT         03700021
         MVC   WXI,WR                   FOR ZERO DEGREE                 03720021
         MVC   WYI,ZERO                 XI=R,YI=0                       03740021
         B     FDENTRY                  GO TO FORM DATA                 03760021
TESTG2   C     QUOREG,TWO                                               03780021
         BNE   TESTH2                                                   03800021
         MVC   WXI,ZERO                 FOR 90 DEGREE                   03820021
         MVC   WYI,WR                    XI= 0,YI=R                     03840021
         B     FDENTRY                                                  03860021
TESTH2   C     QUOREG,FOUR                                              03880021
         BNE   SETXYI                                                   03900021
         L     WRKREG,WR                FOR 180 DEGREE                  03920021
         LNR   XREG,WRKREG               XI=-R  YI=0                    03940021
         ST    XREG,WXI                 SAVE COMPUTED XI                03960021
         MVC   WYI,ZERO                  SET YI=0                       03980021
         B     FDENTRY                                                  04000021
SETXYI   MVC   WXI,ZERO                 FOR 270 DEGREE                  04020021
         L     WRKREG,WR                 XI=0 YI=-R                     04040021
         LNR   YREG,WRKREG                                              04060021
         ST    YREG,WYI                                                 04080021
         B     FDENTRY                                                  04100021
COMPXYI  C     QUOREG,ZERO              CHECK IF THET IN 1ST OR 3RD Q   04120021
         BC    8,NORMAL                  IF YES GO TO NORMAL ROUTINE    04140021
         C     QUOREG,FOUR                                              04160021
         BC    8,NORMAL                                                 04180021
         L     WRKREG,C90                                               04200021
         SR    WRKREG,DVDREG                                            04220021
         LR    DVDREG,WRKREG                                            04240021
         STH   DVDREG,WTHETA                                            04260021
NORMAL   C     DVDREG,C45               COMPARE THET TO 45              04280021
         BH    OVER45                                                   04300021
         LR    WRKREG,DVDREG            LOAD THET TO WK REG             04320021
         MH    WRKREG,PLUS4                                             04340021
         LH    XREG,TABLE+2(WRKREG)       GET COS(THET)                 04360021
         SRDA  XREG,32                                                  04380021
         M     XREG,WR                  XI=R*COS(THET)                  04400021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04420021
         SRA   PRDREG,14                                                04440021
         MH    PRDREG,CSIGN(QUOREG)                                     04460021
         ST    PRDREG,WXI               SAVE XI                         04480021
         L     YREG,TABLE(WRKREG)                                       04500021
         SRDA  YREG,48                                                  04520021
         M     YREG,WR                  YI=R*SIN(THET)                  04540021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04560021
         SRA   PRDREG,14                                                04580021
         MH    PRDREG,SSIGN(QUOREG)                                     04600021
         ST    PRDREG,WYI               SAVE YI                         04620021
         B     FDENTRY                  GO TO FORM XY DATA              04640021
OVER45   LR    WRKREG,DVDREG            ROUTINE FOR THET OVER 45        04660021
         MH    WRKREG,MINUS4                                            04680021
         L     XREG,TABLE+360(WRKREG)                                   04700021
         SRDA  XREG,48                                                  04720021
         M     XREG,WR                  XI=R*COS(THET)                  04740021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04760021
         SRA   PRDREG,14                                                04780021
         MH    PRDREG,CSIGN(QUOREG)                                     04800021
         ST    PRDREG,WXI               SAVE XI                         04820021
         LH    YREG,TABLE+362(WRKREG)                                   04840021
         SRDA  YREG,32                                                  04860021
         M     YREG,WR                                                  04880021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04900021
         SRA   PRDREG,14                                                04920021
         MH    PRDREG,SSIGN(QUOREG)                                     04940021
         ST    PRDREG,WYI               SAVE YI                         04960021
FDENTRY  A     NPAREG,ONE                                               04980021
         L     WRKREG,WXI               COMPUTE X=XI&XC                 05000021
         A     WRKREG,WUC                                               05020021
SAVEX    ST    WRKREG,COMPUX            SAVE COMPUTED X                 05040021
         STH   WRKREG,BUILDXY           SAVE SIGNIFICANT PORTION OF X   05060021
         L     WRKREG,WYI               COMPUTE Y=YI&YC                 05080021
         A     WRKREG,WVC                                               05100021
         ST    WRKREG,COMPUY            SAVE COMPUTED Y                 05120021
         STH   WRKREG,BUILDXY+2         SAVE SIGNIFICANT PART OF Y      05140021
         L     WRKREG,WRTADDR           GET BOUNDARY CHCK RT            05160021
         BALR  LINREG,WRKREG            BRANCH TO CHECK                 05180021
         CLI   OFFSW,X'11'              IS THIS PT OFF BOUNDARY         05200021
         BE    ILLEGAL                  IF SO GO TO ILLEGAL HANDLING    05220021
         STM   2,12,PORSAVE                                             05240021
         LA    CNTREG,4                 LOAD BYTE NUMBER                05260021
         LA    ADDREG,BUILDXY                                           05280021
         L     OABREG,WOACB                                             05300021
         BAL   LINREG,STORE             BRANCH AND LINK TO STORE RT     05320021
         LM    2,12,PORSAVE                                             05340021
CKENTRY  LH    DELREG,WDELTA            GET DELTA                       05360021
         CH    DELREG,WGAMMA            COMPARE DELTA TO GAMM           05380021
         BE    RET                       IF EQUAL JOB IS COMPLETED      05400021
         AH    DELREG,WALPHA            ADD ALPHA                       05420021
         STH   DELREG,WDELTA            STORE DELTA                     05440021
         CH    DELREG,WGAMMA            COMPARE DELTA TO GAMM           05460021
         BC    12,NEWTHET                IF LE COMPUTE NEW THET         05480021
         MVC   WDELTA,WGAMMA            SET DELTA=GAMM                  05500021
         LH    DELREG,WDELTA                                            05520021
NEWTHET  LR    DVDREG,DELREG            LOAD DELT TO DIVIDEND REG       05540021
         SRDA  DVDREG,32                                                05560021
         D     DVDREG,C360              THET NOT OVER 360               05580021
         STH   DVDREG,WTHETA                                            05600021
         B     DTENTRY                                                  05620021
*                                                                       05640021
*   HANDLING OF OFF S/G CONDITIONS                                      05660021
*                                                                       05680021
ILLEGAL  CLI   SG,C'A'                  IS A OPTION SPECIFIED           05700021
         BNE   OPTIONB                  IF NOT TEST FOR B               05720021
         BAL   LINREG,ERR44                                             05740021
         B     CKENTRY                  CONTINUE AFTER SET ERROR CODE   05760021
OPTIONB  CLI   SG,C'B'                  IS B OPTION SPECIFIED           05780021
         BNE   OPTIONC                  IF NOT TEST FOR OPTION C        05800021
         BAL   LINREG,ERR48                                             05820021
         B     CKENTRY                  CONTINUE AFTER SET ERROR CODE   05840021
OPTIONC  CLI   SG,C'C'                  IS OPTION C SPECIFIED           05860021
         BNE   OPTIOND                  IF NOT TEST FOR OPTION D        05880021
         BAL   LINREG,SCRCHK            IF YES GO TO TEST IF OFF SCREEN 05900021
         CLI   OFFSW,X'11'              TEST IF OFF SWITCH ON           05920021
         BE    ERR32RET                 IF OFF SCREEN ERROR RETURN      05940021
         LA    15,32                    OTHERWISE SET ERROR CODE        05960021
         BAL   LINREG,ERRCNT            UPDATE ERROR COUNT              05980021
         B     CKENTRY                  AND CONTINUE THE JOB            06000021
OPTIOND  CLI   SG,C'D'                  IS OPTION D SPECIFIED           06020021
         BNE   ASSUMEE                  IF NOT ASSUME OPTION E          06040021
         B     ERR28RET                 IMMEDIATE ERROR RETURN          06060021
ASSUMEE  B     ERR32RET                 IMMEDIATE ERROR RETURN          06080021
RET      LA    WRKREG,1                                                 06100021
         C     WRKREG,ERRCOUNT                                          06120021
         BL    SETBIT                                                   06140021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            06160021
RETMACRO L     WRKREG,MASKSV                                            06180021
         SPM   WRKREG                                                   06200021
         RETURN (14,12),T,RC=(15)                                       06220021
SETBIT   O     15,MZERO                                                 06240021
         B     RETMACRO                                                 06260021
*                                                                       06280021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    06300021
* INPUT TO SUBROUTINE                                                   06320021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   06340021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                06360021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               06380021
*   OABREG = ADDRESS OF OACB                                            06400021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   06420021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        06440021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              06460021
*                                                                       06480021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 06500021
*                                                                       06520021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        06540021
         LA    TEMREG,4                                                 06560021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               06580021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    06600021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       06620021
         CR    TEMREG,SLOREG                                            06640021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       06660021
         BC    12,OK                    ROOM FOR DATA                   06680021
*                                                                       06700021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    06720021
*                                                                       06740021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         06760021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       06780021
*                                                                       06800021
* ANY BYTES TO STORE                                                    06820021
*                                                                       06840021
         C     WRKREG,ZERO                                              06860021
         BC    12,STORE4                LESS OF EQUAL TO ZERO           06880021
         LH    TEMREG,H2A02                                             06900021
         CH    TEMREG,GOMODE                                            06920021
         BH    STORE3A                                                  06940021
         LH    TEMREG,H0003                                             06960021
         NR    TEMREG,WRKREG                                            06980021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (CAAR)      7468 07000021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      07020021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 07040021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              07060021
*                                                                       07080021
* STORE REGISTERS IN WORKAREA                                           07100021
*                                                                       07120021
         STM   0,15,0(WKAREG)           SAVE REGISTERS IN WORKAREA      07140021
         L     15,8(0,OABREG)           OVER FLOW ADDRESS               07160021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         07180021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      07200021
         LM    0,15,0(WKAREG)           RELOAD FROM WORKAREA            07220021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    07240021
*                                                                       07260021
* NO SPACE AVAILABLE                                                    07280021
*                                                                       07300021
*                                                                       07320021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 07340021
         BC    4,STORE3                 NO                              07360021
*                                                                       07380021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          07400021
*                                                                       07420021
         LA    15,24                    SET ERROR CODE                  07440021
         B     RET                      SYMBOLIC IN POR                 07460021
*                                                                       07480021
*                                                                       07500021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 07520021
         BR    LINREG                                                   07540021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           07560021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      07580021
         BC    2,STORE7                 YES                             07600021
         LR    TEMREG,WRKREG                                            07620021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       07640021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               07660021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              07680021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                07700021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           07720021
         BR    INTLNK                   RETURN INTERNALLY               07740021
STORE7   LR    SLOREG,TEMREG                                            07760021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       07780021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               07800021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              07820021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            07840021
         SR    WRKREG,TEMREG           REDUCE BY 255                    07860021
         B     STORE6A                  MAKE NEXT COMPARISON            07880021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               07900021
*                                                                       07920021
*   SUBROUTINE TO CHECK IF INPUT POINT WITHIN GRID                      07940021
*                                                                       07960021
GRDCK    LH    WRKREG,X1                GET X1                          07980021
         C     WRKREG,COMPUX            SEE IF COMPUTED X OUTSIDE GRID  08000021
         BH    SIGNAL                                                   08020021
         LH    WRKREG,X2                GET X2                          08040021
         C     WRKREG,COMPUX            SEE IF COMPUTED X OUTSIDE GRID  08060021
         BL    SIGNAL                                                   08080021
         LH    WRKREG,Y1                GET Y1                          08100021
         C     WRKREG,COMPUY            SEE IF COMPUTED Y OUTSIDE GRID  08120021
         BH    SIGNAL                                                   08140021
         LH    WRKREG,Y2                GET Y2                          08160021
         C     WRKREG,COMPUY            SEE IF COMPUTED Y OUTSIDE GRID  08180021
         BL    SIGNAL                                                   08200021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET SW OFF         08220021
         BR    LINREG                                                   08240021
*                                                                       08260021
*   SUBROUTINE TO CHECK IF INPUT POINT WITHIN SCREEN                    08280021
*                                                                       08300021
SCRCHK   L     WRKREG,COMPUX            GET COMPUTED X                  08320021
         C     WRKREG,ZERO              COMPARE TO ZERO                 08340021
         BL    SIGNAL                   IF NEGATIVE SIGNAL OFFSG        08360021
         C     WRKREG,C4095             COMPARE TO 4095                 08380021
         BH    SIGNAL                   IF HIGHER SIGNAL OFFSG          08400021
         L     WRKREG,COMPUY            GET COMPUTED Y AND              08420021
         C     WRKREG,ZERO               TEST IN THE SAME WAY           08440021
         BL    SIGNAL                                                   08460021
         C     WRKREG,C4095                                             08480021
         BH    SIGNAL                                                   08500021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET SW OFF         08520021
         BR    LINREG                                                   08540021
SIGNAL   MVI   OFFSW,X'11'              SET OFFGRID SWITCH ON           08560021
         BR    LINREG                                                   08580021
* SCALE UC VC IN FIXED POINT WITH THE FOLLOWING FORMULAS                08600021
*                                                                       08620021
*   UC=(U-U1)(X2-X1)/(U2-U1)+X1                                         08640021
*   VC=(V-V1)(Y2-Y1)/(V2-V1)+Y1                                         08660021
*                                                                       08680021
SCALFIX  STM   2,12,PORSAVE                                             08700021
FIXSCAL  LA    CNTREG,2                                                 08720021
         SR    HALREG,HALREG            INDEX REG FOR X1 THEN Y1        08740021
         SR    SCLREG,SCLREG            INDEX REG FOR UC THEN VC        08760021
         SR    INXREG,INXREG            INDEX REG FOR UI THEN VI        08780021
SCALFXV  L     DVSREG,U2(INXREG)        LOAD U2 THEN V2                 08800021
         S     DVSREG,U1(INXREG)        U2-U1 THEN V2-V1                08820021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    08840021
         L     DVDREG,UC(SCLREG)        LOAD UC THEN VC                 08860021
         S     DVDREG,U1(INXREG)        UC-U1 OR VC-V1                  08880021
         LH    WRKREG,X2(HALREG)        LOAD X2 THEN Y2                 08900021
         SH    WRKREG,X1(HALREG)        X2-X1 OR Y2-Y1                  08920021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    08940021
         SRDA  DVDREG,32                                                08960021
         MR    DVDREG,WRKREG            (UC-U1)(X2-X1)OR(VC-V1)(Y2-Y1)  08980021
         DR    DVDREG,DVSREG            DEVIDED BY U2-U1 ORV2-V1        09000021
         AH    QUOREG,X1(HALREG)        ADD X1 OR Y1                    09020021
         ST    QUOREG,WUC(SCLREG)       STORE SCALED UC VC FOR WORKING  09040021
         A     INXREG,EIGHT                                             09060021
         A     SCLREG,FOUR              INDEXING REGISTER               09080021
         A     HALREG,TWO               INDEXING REGISTER               09100021
         BCT   CNTREG,SCALFXV           LOOP TO SCALE VC                09120021
* SCALE RU USING FORMULA                                                09140021
*                                                                       09160021
*   R=RU*(X2-X1)/(U2-U1)                                                09180021
*                                                                       09200021
         L     DVSREG,U2                GET U2                          09220021
         S     DVSREG,U1                U2-U1                           09240021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    09260021
         LH    DVDREG,X2                LOAD X2                         09280021
         SH    DVDREG,X1                X2-X1                           09300021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    09320021
         SRDA  DVDREG,32                                                09340021
         M    DVDREG,RU                 RU*(X2-X1) AND                  09360021
         DR    DVDREG,DVSREG            DIVIDED BY (U2-U1)              09380021
         ST    QUOREG,WR                                                09400021
         LM    2,12,PORSAVE                                             09420021
         B     TESTIN                                                   09440021
*    CONVERT XYLIM TABLE TO FLOATING VALUES                             09460021
SCALFLT  STM   2,12,PORSAVE                                             09480021
*    FLOATING POINT SPECIFIED - TEST FOR CHARACTERISTIC ZERO AND        09500021
*    FRACTION NON ZERO. OF ALL U,V VALUES                               09520021
         L     VALREG,UC                                                09540021
         BAL   LINREG,FIXCONV                                           09560021
         L     VALREG,VC                                                09580021
         BAL   LINREG,FIXCONV                                           09600021
         L     VALREG,RU                                                09620021
         BAL   LINREG,FIXCONV                                           09640021
         L     VALREG,U1                                                09660021
         BAL   LINREG,FIXCONV                                           09680021
         L     VALREG,U2                                                09700021
         BAL   LINREG,FIXCONV                                           09720021
         L     VALREG,V1                                                09740021
         BAL   LINREG,FIXCONV                                           09760021
         L     VALREG,V2                                                09780021
         BAL   LINREG,FIXCONV                                           09800021
         LA    CNTREG,4                 SET LOOP COUNT                  09820021
         SR    HALREG,HALREG            SET HALF WORK INDEX REG         09840021
         SR    SCLREG,SCLREG            CLEAR FULL WORD INDEX REG       09860021
NEXTXY   LH    VALREG,X1(HALREG)        GET X1,Y1,X2,Y2                 09880021
         BAL   LINREG,FLTCONV           BRANCH TO CONVERT               09900021
         ST    VALREG,FX1(SCLREG)       STORE CONVERTED VALUES          09920021
         A     HALREG,TWO               INDEXING HALF WORD              09940021
         A     SCLREG,FOUR              INDEXING FULL WORD              09960021
         BCT   CNTREG,NEXTXY                                            09980021
*                                                                       10000021
*                                                                       10020021
* SCALE UC VC IN FLOATING POINT WITH THE FOLLOWING FORMULAS             10040021
*                                                                       10060021
*  UC=(UC-U1)(X2-X1)/(U2-U1)+X1                                         10080021
*  VC=(VC-V1)(Y2-Y1)/(V2-V1)+Y1                                         10100021
*                                                                       10120021
FLTSCAL  LA    CNTREG,2                                                 10140021
         SR    INXREG,INXREG                                            10160021
         SR    SCLREG,SCLREG                                            10180021
SCALFLV  LE    REG6,U1(INXREG)          LOAD U1 THEN V1                 10200021
         LE    REG4,U2(INXREG)          LOAD U2 THEN V2                 10220021
         SER   REG4,REG6                     U2-U1                      10240021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    10260021
         LE    REG0,UC(SCLREG)          LOAD UC THEN VC                 10280021
         SER   REG0,REG6                U-U1  OR V-V1                   10300021
         LE    REG6,FX1(SCLREG)         LOAD X1 OR Y1 FLT VALUE         10320021
         LE    REG2,FX2(SCLREG)         X2 OR Y2 FLOAT VALUE            10340021
         SER   REG2,REG6                (X2-X1)                         10360021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    10380021
         MER   REG0,REG2                (U-U1)(X2-X1)                   10400021
         DER   REG0,REG4                (U-U1)(X2-X1)                   10420021
         AER   REG0,REG6                                                10440021
         STE   REG0,WUC(SCLREG)         STORE UC VC SCALED VALUES       10460021
         A     INXREG,EIGHT                                             10480021
         A     SCLREG,FOUR                                              10500021
         BCT   CNTREG,SCALFLV                                           10520021
*                                                                       10540021
* SCALE RU IN FLOATING POINT WITH THE FOLLOWING FORMULAS                10560021
*                                                                       10580021
*   R=RU*(X2-X1)/(U2-U1)                                                10600021
*                                                                       10620021
         LE    REG6,U1                  LOAD U1                         10640021
         LE    REG4,U2                  LOAD U2                         10660021
         SER   REG4,REG6                U2-U1                           10680021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    10700021
         LE    REG0,RU                  GET RADIUS IN PARTAB            10720021
         LE    REG6,FX1                 LOAD X1 FLOAT VALUE             10740021
         LE    REG2,FX2                 LOAD X2 FLOAT VALUE             10760021
         SER   REG2,REG6                FX2-FX1                         10780021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    10800021
         MER   REG0,REG2                RU*(X2-X1)                      10820021
         DER   REG0,REG4                DIVIDED BY U2-U1                10840021
         STE   REG0,WR                  STORE SCALED RADIUS             10860021
         LM    2,12,PORSAVE                                             10880021
*                                                                       10900021
*    CONVERT FLOATING UC VC RU TO FIXED POINT VALUES                    10920021
FCONVERT L     VALREG,WR                LOAD RADIUS                     10940021
         BAL   LINREG,FIXCONV           FIXCONV=CONVERT FLT TO FIX      10960021
         ST    VALREG,WR                STORE THE CONVERTED RADIUS      10980021
         L     VALREG,WUC               GET UC                          11000021
         BAL   LINREG,FIXCONV                                           11020021
         ST    VALREG,WUC               STORE CONVERTED UC              11040021
         L     VALREG,WVC               GET VC                          11060021
         BAL   LINREG,FIXCONV                                           11080021
         ST    VALREG,WVC               STORE CONVERTED VC              11100021
         B     TESTIN                                                   11120021
FIXCONV  ST    1,OVFSAVE                STORE IN FIRST WORD REG.1       11140021
         TM    OVFSAVE+3,X'07'          TEST LAST THREE BITS            11160021
         BZ    SETMODI                  NO BITS ON SET INDEX TO ZERO    11180021
         LA    TEMREG,4                 SET MODIFIER                    11200021
         B     SAVFLT                   START CONVERSION                11220021
SETMODI  LA    TEMREG,0                 SET MODIFIER TO ZERO            11240021
SAVFLT   ST    VALREG,TEMFLT(TEMREG)    SAVE FLOAT VALUE                11260021
         SR    WRKREG,WRKREG                                            11280021
         ST    WRKREG,TEMFLT+4(TEMREG)  CLEAR SECOND WORD               11300021
         LD    6,TEMFLT(TEMREG)         VALUE TO FLOAT REGISTERS        11320021
         N     VALREG,FCHAR                                             11340021
         BE    FLERR1                   CHARACTERISTIC IS ZERO          11360021
         AE    6,FLPT5                  ADD .5 TO ROUND                 11380021
         AW    6,X4E                    ADD UNNORMALIZED-RIGHT JUSTIF.  11400021
         STD   6,TEMFLT(TEMREG)         SAVE VALUES                     11420021
         L     WRKREG,TEMFLT+4(TEMREG)  CHECK SECOND WORD               11440021
         N     WRKREG,MZERO             CHECK BIT 32                    11460021
         BM    ERR12RET                                                 11480021
         L     WRKREG,TEMFLT(TEMREG)                                    11500021
         N     WRKREG,BYTE123                                           11520021
         BM    ERR12RET                                                 11540021
         L     WRKREG,TEMFLT(TEMREG)                                    11560021
         N     WRKREG,MZERO             DROP CHARACTERISTIC             11580021
         L     VALREG,TEMFLT+4(TEMREG)  NEW FIXED VALUE                 11600021
         LTR   WRKREG,WRKREG                                            11620021
         BNL   NOTNEG                                                   11640021
         LNR   VALREG,VALREG            TWO'S COMPLEMENT                11660021
NOTNEG   BR    LINREG                                                   11680021
FLERR1   CE    6,ZERO                   IS TOTAL VALUE ZERO             11700021
         BE    NOTNEG                   RETURN                          11720021
         B     ERR12RET                 SET ERROR CODE AND RETURN       11740021
         DS    0D                                                       11760021
X4E      DC    X'4E00000000000000'                                      11780021
FLPT5    DC    E'.5'                                                    11800021
BYTE123  DC    X'00FFFFFF'                                              11820021
MZERO    DC    X'80000000'                                              11840021
FCHAR    DC    X'7F000000'                                              11860021
XZERO    DC    X'80FFFFFF'              SIGN AND VALUE -DROP EXPONENT   11880021
X6       DC    X'46000000'              EXPONENT OF SIX                 11900021
NSIGN    DC    X'7FFFFFFF'                                              11920021
*                                                                       11940021
*   CONVERT FIXED POINT TO FLOATING POINT VALUES                        11960021
*                                                                       11980021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   12000021
         ST    VALREG,OVFSAVE                                           12020021
         LE    0,OVFSAVE                LOAD TO FLOAT REG.              12040021
         AE    0,X6                     NORMALIZE                       12060021
         STE   0,OVFSAVE                                                12080021
         L     VALREG,OVFSAVE           FLOAT PT VALUE IN REG.          12100021
         BR    LINREG                                                   12120021
*    CHECK XYLIM TABLE                                                  12140021
XYLCHK   LH    XYREG1,X1                LOAD X1                         12160021
         LH    XYREG2,X2                LOAD X2                         12180021
         LA    CONREG,2                 SET LOOP CONTROL                12200021
XYLOOP   CR    XYREG1,XYREG2            COMPARE X1 TO X2                12220021
         BNL   XYLERR                                                   12240021
         C     XYREG1,ZERO              COMPARE X1 TO ZERO              12260021
         BL    XYLERR                                                   12280021
         C     XYREG1,C4095             COMPARE X1 TO 4095              12300021
         BH    XYLERR                                                   12320021
         C     XYREG2,ZERO              CHECK X2                        12340021
         BL    XYLERR                                                   12360021
         C     XYREG2,C4095                                             12380021
         BH    XYLERR                                                   12400021
         LH    XYREG1,Y1                LOAD Y1                         12420021
         LH    XYREG2,Y2                LOAD Y2                         12440021
         BCT   CONREG,XYLOOP                                            12460021
         BR    LINREG                                                   12480021
XYLERR   B     ERR4RET                                                  12500021
*INPUT INVALID- ERROR HANDLING                                          12520021
ERR4RET  LA    15,4                     XYLIM X1,Y1,X2,Y2 ERROR         12540021
         B     ERRCNTR                                                  12560021
ERR12RET LA    15,12                                                    12580021
         B     ERRCNTR                                                  12600021
ERR16RET LA    15,16                    U1 V1 GREATER THAN U2 V2        12620021
         B     ERRCNTR                                                  12640021
ERR20RET LA    15,20                    IMMEDIATE INPUT RETURN          12660021
         B     ERRCNTR                                                  12680021
ERR24RET LA    15,24                    USERS OVERFLOW                  12700021
         B     ERRCNTR                                                  12720021
ERR28RET LA    15,28                    SET ERROR CODE                  12740021
         B     ERRCNTR                                                  12760021
ERR32RET LA    15,32                                                    12780021
         B     ERRCNTR                                                  12800021
ERR40    LA    15,40                    INPUT ERROR - NOT SERIOUS       12820021
         B     ERRCNT                                                   12840021
ERR44    LA    15,44                                                    12860021
         B     ERRCNT                                                   12880021
ERR48    LA    15,48                                                    12900021
         B     ERRCNT                                                   12920021
ERRCNTR  LA    LINREG,RET                                               12940021
ERRCNT   L     TEMREG,ERRCOUNT          UPDATE ERROR COUNT              12960021
         A     TEMREG,ONE                                               12980021
         ST    TEMREG,ERRCOUNT                                          13000021
         BR    LINREG                                                   13020021
ZERO     DC    F'0'                                                     13040021
ONE      DC    F'1'                                                     13060021
TWO      DC    F'2'                                                     13080021
FOUR     DC    F'4'                                                     13100021
EIGHT    DC    F'8'                                                     13120021
TWOPI    DC    FS28'6.2832'             DEFINE TWOPI VALUE              13140021
EPM      DC    X'2A00'                  GEPM ORDER                      13160021
C16384   DC    F'16384'                                                 13180021
C8192    DC    F'8192'                                                  13200021
C4095    DC    F'4095'                                                  13220021
C360     DC    F'360'                                                   13240021
C90      DC    F'90'                                                    13260021
C45      DC    F'45'                                                    13280021
H2A02    DC    X'2A02'                                                  13300021
H0003    DC    H'0003'                                                  13320021
PLUS4    DC    X'0004'                                                  13340021
MINUS4   DC    X'FFFC'                                                  13360021
CSIGN    DC    X'0001FFFFFFFF0001'                                      13380021
SSIGN    DC    X'00010001FFFFFFFF'                                      13400021
TABLE    DC    HS14'0.0000,1.0000,0.0175,0.9999'                        13420021
         DC    HS14'0.0349,0.9994,0.0523,0.9986'                        13440021
         DC    HS14'0.0698,0.9976,0.0872,0.9962'                        13460021
         DC    HS14'0.1045,0.9945,0.1219,0.9925'                        13480021
         DC    HS14'0.1392,0.9903,0.1564,0.9877'                        13500021
         DC    HS14'0.1737,0.9848,0.1908,0.9816'                        13520021
         DC    HS14'0.2079,0.9782,0.2250,0.9744'                        13540021
         DC    HS14'0.2419,0.9703,0.2588,0.9659'                        13560021
         DC    HS14'0.2756,0.9613,0.2924,0.9563'                        13580021
         DC    HS14'0.3090,0.9511,0.3256,0.9455'                        13600021
         DC    HS14'0.3420,0.9397,0.3584,0.9336'                        13620021
         DC    HS14'0.3746,0.9272,0.3907,0.9205'                        13640021
         DC    HS14'0.4067,0.9136,0.4226,0.9063'                        13660021
         DC    HS14'0.4384,0.8988,0.4540,0.8910'                        13680021
         DC    HS14'0.4695,0.8830,0.4848,0.8746'                        13700021
         DC    HS14'0.5000,0.8660,0.5150,0.8572'                        13720021
         DC    HS14'0.5299,0.8481,0.5446,0.8387'                        13740021
         DC    HS14'0.5592,0.8290,0.5736,0.8192'                        13760021
         DC    HS14'0.5878,0.8090,0.6018,0.7986'                        13780021
         DC    HS14'0.6157,0.7880,0.6293,0.7772'                        13800021
         DC    HS14'0.6428,0.7660,0.6561,0.7547'                        13820021
         DC    HS14'0.6691,0.7431,0.6820,0.7314'                        13840021
         DC    HS14'0.6947,0.7193,0.7071,0.7071'                        13860021
REG0     EQU   0                                                        13880021
REG2     EQU   2                                                        13900021
REG4     EQU   4                                                        13920021
REG6     EQU   6                                                        13940021
HALREG   EQU   5                                                        13960021
SCLREG   EQU   6                                                        13980021
INXREG   EQU   7                                                        14000021
DVSREG   EQU   8                                                        14020021
XYREG1   EQU   7                                                        14040021
XYREG2   EQU   8                                                        14060021
VALREG   EQU   8                                                        14080021
XYLREG   EQU   14                                                       14100021
WKAREG   EQU   1                                                        14120021
DVDREG   EQU   2                                                        14140021
QUOREG   EQU   3                                                        14160021
GMREG    EQU   4                                                        14180021
DELREG   EQU   4                                                        14200021
WRKREG   EQU   4                                                        14220021
CONREG   EQU   5                                                        14240021
XREG     EQU   6                                                        14260021
YREG     EQU   6                                                        14280021
MPCREG   EQU   6                                                        14300021
PRDREG   EQU   7                                                        14320021
NPAREG   EQU   10                                                       14340021
PATREG   EQU   12                                                       14360021
PASREG   EQU   2                                                        14380021
SLOREG   EQU   3                                                        14400021
OLPREG   EQU   5                                                        14420021
TEMREG   EQU   6                                                        14440021
ADDREG   EQU   7                                                        14460021
OABREG   EQU   8                                                        14480021
CNTREG   EQU   10                                                       14500021
LINREG   EQU   11                                                       14520021
INTLNK   EQU   12                                                       14540021
WKAREA   DSECT                                                          14560021
OVFSAVE  DS    CL72                     18-WORD SAVEAREA FOR REGISTERS  14580021
         ORG   OVFSAVE                                                  14600021
TEMFLT   DS    CL8                      A  TEMPORARY SAVE AREA          14620021
         DS    CL64                                                     14640021
PORSAVE  DS    CL44                     A  REGISTER SAVE AREA           14660021
ERRCOUNT DS    CL4                      COUNT OF ERRORS                 14680021
FX1      DS    CL4                      FLOATING X1                     14700021
FY1      DS    CL4                      FLOATING Y1                     14720021
FX2      DS    CL4                      FLOATING X2                     14740021
FY2      DS    CL4                      FLOATING Y2                     14760021
WOACB    DS    CL4                      AN AREA TO SAVE OACB ADDRESS    14780021
WRTADDR  DS    CL4                      ADDR OF GRID OR SCREEN CHECK RT 14800021
WUC      DS    CL4                                                      14820021
WVC      DS    CL4                                                      14840021
WR       DS    CL4                                                      14860021
WTHETA   DS    CL2                                                      14880021
WALPHA   DS    CL2                                                      14900021
WGAMMA   DS    CL2                                                      14920021
WDELTA   DS    CL2                                                      14940021
BUILDXY  DS    CL4                      XY BUILDUP AREA                 14960021
WXI      DS    CL4                                                      14980021
WYI      DS    CL4                                                      15000021
COMPUX   DS    CL4                      COMPUTED X VALUE                15020021
COMPUY   DS    CL4                      COMPUTED Y VALUE                15040021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    15060021
         ORG   OVFSAVE+396                                              15080021
GOMODE   DS    CL2                                                      15100021
PARTAB   DSECT                                                          15120021
XYLIM    DS    CL4                                                      15140021
UC       DS    CL4                                                      15160021
VC       DS    CL4                                                      15180021
F        DS    CL1                                                      15200021
S        DS    CL1                                                      15220021
INC      DS    CL1                                                      15240021
SG       DS    CL1                                                      15260021
RU       DS    CL4                                                      15280021
THETA    DS    CL2                                                      15300021
DENSITY  DS    CL2                                                      15320021
         ORG   DENSITY                                                  15340021
ALPHA    DS    CL2                                                      15360021
GAMMA    DS    CL2                                                      15380021
OFFSW    DS    CL1                                                      15400021
XYLIMTB  DSECT                                                          15420021
X1       DS    CL2                                                      15440021
Y1       DS    CL2                                                      15460021
X2       DS    CL2                                                      15480021
Y2       DS    CL2                                                      15500021
U1       DS    CL4                                                      15520021
U2       DS    CL4                                                      15540021
V1       DS    CL4                                                      15560021
V2       DS    CL4                                                      15580021
         END                                                            15600021
./  ADD  SSI=20480470,NAME=IFFPDAPL
         TITLE 'GSPLOT-SCALE AND PLOT'                                  00020021
*STATUS. CHANGE LEVEL 0                                                 00040021
*                                                                       00060021
*FUNCTION/OPERATION. GSPLOT GENERATES THE GRAPHIC ORDERS TO DISPLAY A   00080021
*   POINT,CHARACTER,OR VECTOR PLOT.  A COMBINATION OF THE VARIOUS PLOT  00100021
*   TYPES MAY BE DISPLAYED.                                             00120021
*   THE GRAPHIC ORDERS ARE STORED IN THE GRAPHIC DATA OUTPUT AREA(GDOA) 00140021
*                                                                       00160021
*ENTRY POINTS. GSPLOT VIA CALL OR LINK MACRO   ALIAS NAME IFFPDA        00180021
*                                                                       00200021
*INPUT.OUTPUT CONTROL BLOCK POINTER (OCBP) AND A PARAMETER ADDRESS      00220021
*   WHICH POINTS TO A SEQUENCE OF ADDRESSES AND EBCDIC CHARACTERS IN A  00240021
*   USER PROVIDED PARAMETER TABLE                                       00260021
*                                                                       00280021
*OUTPUT. A STRING OF GRAPHIC ORDERS SUITABLE FOR PLOTTING               00300021
*                                                                       00320021
*EXTERNAL ROUTINES. GOFFSG-OFF SCREEN/GRID INTERSECTION ROUTINE         00340021
*                                                                       00360021
*EXITS-NORMAL. COMPLETION OF TASK EXIT VIA RETURN MACRO                 00380021
*     -ERROR. HEXADECIMAL 4,C,10,18,1C, OR 20 IN REG. 15                00400021
*  IMMEDIATE RETURN. EXIT VIA RETURN MACRO                              00420021
*     -ERROR. HEXADECIMAL 28,2C OR 30 IN REG. 15 DOES NOT RETURN        00440021
*      IMMEDIATELY-COMPLETION OF TASK AND RETURN VIA RETURN MACRO       00460021
*                                                                       00480021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE, XYLIM TABLE, UTAB,  00500021
*   VTAB VALUE TABLES AND A USER SUPPLIED WORK AREA                     00520021
*                                                                       00540021
*ATTRIBUTES. READ ONLY, REENTRANT                                       00560021
*                                                                       00580021
IFFPDAPL CSECT                          GSPLOT                          00600021
*0669                                                              7468 00610021
* GSPLOT ROUTINE-SAVE REGISTERS-SET RETURN REGISTER AND INITIALIZE      00620021
*                                                                       00640021
         ENTRY GSPLOT                                                   00660021
GSPLOT   SAVE  (14,12),T,*              SYSTEM SAVE MACRO               00680021
         BALR  9,0                                                      00700021
         USING *,9                      BASE REGISTER                   00720021
         USING XYLIM,PATREG                                             00740021
         USING X1,XYLREG                                                00760021
         USING OVFSAVE,WKAREG                                           00780021
         SR    15,15                    CLEAR RETURN CODE               00800021
         LM    OBPREG,PATREG,0(1)       LOAD CONTROL BLOCK AND PARTAB   00820021
         L     OABREG,0(0,OBPREG)       CONTROL BLOCK ADDRESS           00840021
         L     WKAREG,4(0,OBPREG)       WORK AREA ADDRESS               00860021
*  SAVE MASK BITS AS SET BY USER                                        00880021
         ST    9,MASKSV                                                 00900021
         SR    WRKREG,WRKREG                                            00920021
         SPM   WRKREG                                                   00940021
*   CLEAR WORKAREA-TOTAL TEMPORARY STORAGE                              00960021
*                                                                       00980021
         LA    CNTREG,72                COUNT FOR WORK AREA             01000021
         SR    CONREG,CONREG            SET INDEX CONTROL               01020021
CLEARWK  ST    15,OVFSAVE(CONREG)       CLEAR WORK AREA                 01040021
         A     CONREG,FOUR              MODIFY                          01060021
         BCT   CNTREG,CLEARWK           CONTINUE                        01080021
         MVI   COUNT+1,X'01'            SET COUNT TO 1                  01100021
* CHECK INPUT PARAMETERS                                                01120021
*                                                                       01140021
         L     XYLREG,XYLIM             XYLIM ADDRESS                   01160021
         BAL   INTREG,XYLCHK            CHK X1,X2,Y1,Y2 FOR LIMITS      01180021
*                                                                       01200021
* TEST IF FLOATING PT.OR FIXED IS SPECIFIED                             01220021
*                                                                       01240021
         CLI   F,C'B'                   FIXED PARAMETER                 01260021
         BE    OV1                      YES                             01280021
         CLI   F,C'F'                   FLOAT PRAAMETER                 01300021
         BE    OV1                      YES                             01320021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01340021
OV1      CLI   S,C'S'                   SCALE                           01360021
         BE    OV2                      YES                             01380021
         CLI   S,C'N'                   NO SCALE                        01400021
         BE    OV2                      YES                             01420021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01440021
*                                                                       01460021
* TEST FOR ABSOLUTE OR RELATIVE MODE                                    01480021
*                                                                       01500021
OV2      CLI   A,C'A'                   ABSOLUTE MODE                   01520021
         BE    OV3                      YES                             01540021
         CLI   A,C'R'                   RELATIVE MODE                   01560021
         BE    OV3                      YES                             01580021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01600021
*                                                                       01620021
* TEST INCREMENT CODE                                                   01640021
*                                                                       01660021
OV3      CLI   I,C'W'                   NO-INCREMENT                    01680021
         BE    OV4                      YES                             01700021
         CLI   I,C'X'                   INCREMENT U-ONLY                01720021
         BE    OV4                      YES                             01740021
         CLI   I,C'Y'                   INCREMENT V-ONLY                01760021
         BE    OV4                      YES                             01780021
         CLI   I,C'Z'                   INCREMENT U AND V               01800021
         BE    OV4                      YES                             01820021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01840021
*                                                                       01860021
* TEST PLOT TYPE CODE                                                   01880021
*                                                                       01900021
*                                                                       01920021
OV4      CLI   PTYPE,C'A'               POINT PLOT                      01940021
         BE    OV5                      YES                             01960021
         CLI   PTYPE,C'B'               CHARACTER PLOT                  01980021
         BE    OV5                      YES                             02000021
         CLI   PTYPE,C'C'               VECTOR PLOT                     02020021
         BE    OV5                      YES                             02040021
         CLI   PTYPE,C'D'               VECTOR AND POINT                02060021
         BE    OV5                      YES                             02080021
         CLI   PTYPE,C'E'               VECTOR AND CHARACTER            02100021
         BE    OV5                      YES                             02120021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     02140021
*                                                                       02160021
* CHECK S/G OPTIONS                                                     02180021
*                                                                       02200021
*                                                                       02220021
*   TEST OFF S/G OPTION SPECIFIED AND DECIDE BOUNDARY TO BE OBSERVED    02240021
*                                                                       02260021
OV5      CLI   SG,C'A'                  IS OPTION A SPECIFIED           02280021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          02300021
         CLI   SG,C'B'                  IS OPTION B SPECIFIED           02320021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        02340021
         CLI   SG,C'C'                  IS C OPTION SPECIFIED           02360021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          02380021
         CLI   SG,C'D'                  IS D OPTION SPECIFIED           02400021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          02420021
         CLI   SG,C'E'                  IS E OPTION SPECIFIED           02440021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        02460021
         BAL   LINREG,ERR40             OTHERWISE INPUT ERROR ASSUME E  02480021
MVSCRLIM LA    WRKREG,SCLCHK           GET SCREEN CHECK RT ADDRESS      02500021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     02520021
         LA    WRKREG,LOHI              SCREEN LIMITS START ADDRESS     02540021
         ST    WRKREG,SABL              STORE THE ADDRESS AT SABL       02560021
         B     OV6                                                      02580021
MVGRDLIM LA    WRKREG,GRLCHK           LOAD GRID ROUTINE CHECK ADDRESS  02600021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     02620021
         ST    XYLREG,SABL              STORE GRID LIMITS ADDR          02640021
OV6      CLC   N,ZERO                   N COMPARED TO ZERO              02660021
         BH    OV7                      N GREATER THAN ZERO             02680021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     02700021
* IS SYMBOL IN PARAMETER TABLE                                          02720021
*                                                                       02740021
OV7      CLI   PTYPE,C'B'               CHARACTER PLOT SPECIFIED        02760021
         BE    OV8                      YES                             02780021
         CLI   PTYPE,C'E'               VECTOR AND CHARACTER SPECIFIED  02800021
         BNE   STADD                    SKIP OVER-LAP CHECK             02820021
*                                                                       02840021
* IS CHARACTER GIVEN IN TABLE                                           02860021
*                                                                       02880021
OV8      LH    VALREG,SYMBOL            LETTER TO PLOT                  02900021
         N     VALREG,BYTE3             MASK FOR THIRD BYTE             02920021
         BC    4,CHSMOD                 LETTER PRESENT                  02940021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     02960021
*                                                                       02980021
*   SUBROUTINE TO TEST AND DEVELOPE GRAPHIC ORDER  FOR                  03000021
*   CHARACTER MODE AND SIZE                                             03020021
*   PATREG CONTAINS THE ADDRESS OF THE PARAMETER TABLE ON ENTRY         03040021
*   ORDREG CONTAINS THE GRAPHIC ORDER DEVELOPED ON RETURN               03060021
*   IF MODE OR SIZE ARE INCORRECTLY SPECIFIED, UNPROTECTED AND BASIC    03080021
*   ARE ASSUMED                                                         03100021
CHSMOD   CLI   CMOD,C'P'                PROTECTED                       03120021
         BE    PLEG                                                     03140021
         CLI   CMOD,C'F'                UNPROTECTED                     03160021
         BE    FLEG                                                     03180021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     03200021
FLEG     LH    VALREG,GFSC                                              03220021
SIZE     CLI   CSIZE,C'L'               LARGE                           03240021
         BE    SIZEL                                                    03260021
         CLI   CSIZE,C'B'               BASIC                           03280021
         BE    ORDSTO                                                   03300021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     03320021
ORDSTO   STH   VALREG,CHARMOD           ORDER-MODE-SIZE                 03340021
         B     NOCHK                    CHECK OVERLAP LETTER            03360021
SIZEL    A     VALREG,ONE               MODIFY ORDER TO LARGE           03380021
         B     ORDSTO                                                   03400021
PLEG     LH    VALREG,GFPC                                              03420021
         B     SIZE                                                     03440021
GFSC     DC    X'2A40'                                                  03460021
GFPC     DC    X'2A44'                                                  03480021
*                                                                       03500021
* CHECK OVERLAP LETTERS                                                 03520021
NOCHK    CLI   E,C'O'                   OVERLAP LETTER PRESENT          03540021
         BE    STADD                    YES                             03560021
         CLI   E,C'N'                   NO-OVERLAP-WANTED               03580021
         BE    STADD                    YES                             03600021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     03620021
*                                                                       03640021
* STORE VALUES FROM UTAB AND VTAB IN WORKAREA-SCALED VALUES AFTER SCALE 03660021
*                                                                       03680021
STADD    L     WRKREG,UTAB              UTAB ADDRESS                    03700021
         L     VALREG,0(0,WRKREG)       FIRST VALUE                     03720021
         ST    VALREG,UA                ABSOLUTE UA                     03740021
         ST    VALREG,UASCALE           ABSOLUTE-MAY BE SCALED          03760021
         STH   VALREG,X2FIN             MAY BE FINAL FIXED VALUE        03780021
         L     WRKREG,VTAB              VTAB ADDRESS                    03800021
         L     VALREG,0(0,WRKREG)       FIRST VALUE                     03820021
         ST    VALREG,VA                ABSOLUTE VA                     03840021
         ST    VALREG,VASCALE           ABSOLUTE-MAY BE SCALED          03860021
         STH   VALREG,Y2FIN             MAY BE FINAL FIXED VALUE        03880021
*                                                                       03900021
* IS FLOATING SPECIFIED                                                 03920021
*                                                                       03940021
         CLI   F,C'F'                   FLOATING PT. SPECIFIED          03960021
         BNE   NOFLOAT                  INDICATES FIXED OR NO PARAMETER 03980021
*                                                                       04000021
* IS SCALING SPECIFIED                                                  04020021
*                                                                       04040021
         CLI   S,C'S'                   SCALING SPECIFIED               04060021
         BNE   NOSCALE1                 INDICATES NO SCALE-CONVERT TO   04080021
*                                       FIXED PT. UA VALUES             04100021
*                                                                       04120021
* SET UP VALUES TO CONVERT XYLIM TABLE TO FLOATING POINT VALUES         04140021
*                                                                       04160021
         LA    CONREG,4                 DO FOUR VALUES                  04180021
         SR    INXREG,INXREG            CLEAR CONTROL MODIFICATION      04200021
         SR    CNTREG,CNTREG            CLEAR CONTROL MODIFICATION      04220021
NEXTXY   LH    VALREG,X1(INXREG)        GET X1,Y1,X2,Y2 VALUES          04240021
         BAL   LINREG,FLTCONV           CONVERT FIXED VALUE TO FLOAT PT 04260021
         ST    VALREG,FX1(CNTREG)       STORE IN WORKAREA               04280021
         A     INXREG,TWO               MODIFY BY TWO BYTES             04300021
         A     CNTREG,FOUR              MODIFY BY FOUR BYTES            04320021
         BCT   CONREG,NEXTXY                                            04340021
*                                                                       04360021
* FLOATING POINT SCALE-SUBROUTINE                                       04380021
* EQUATION XS=(UA-U1)*(X2-X1)/(U2-U1)+X1                                04400021
* EQUATION YS=(VA-V1)*(Y2-Y1)/(V2-V1)+Y1                                04420021
*                                                                       04440021
FLTSCAL  LA    CNTREG,2                 SET CONTROL                     04460021
         SR    CONREG,CONREG            CLEAR MODIFIER                  04480021
         SR    INXREG,INXREG            CLEAR MODIFIER                  04500021
FLTSCAL1 LE    6,U1(CONREG)             U1 THEN V1                      04520021
         LE    4,U2(CONREG)             U2 THEN V2                      04540021
         SER   4,6                      U2-U1 THEN V2-V1                04560021
         BC    13,ERR16RET         MINUS OR ZERO                        04580021
* LOAD FLOATING PT VALUE FROM WORKAREA                                  04600021
         LE    0,UA(INXREG)             UA-STORED THRU UN               04620021
         SER   0,6                      UA-U1 VARIABLE RESULT           04640021
         LE    6,FX1(INXREG)            X1 OR Y1 CONVERTED VALUE        04660021
         LE    2,FX2(INXREG)            X2 OR Y2 CONVERTED VALUE        04680021
         SER   2,6                                                      04700021
         MER   0,2                      UA-U1*X2-X1 OR VA-V1*Y2-Y1      04720021
         DER   0,4                      /U2-U1 OR V2-V1                 04740021
         AER   0,6                      +X1 OR Y1                       04760021
         STE   0,UASCALE(INXREG)        X OR Y SCALED VALUE             04780021
         A     CONREG,EIGHT             MODIFY FOR V1-V2                04800021
         A     INXREG,FOUR                                              04820021
         BCT   CNTREG,FLTSCAL1                                          04840021
*                                                                       04860021
* SCALE WAS SPECIFIED OR NO SCALE IS REQUIRED-CONVERT DATA TO FIXED PT. 04880021
*                                                                       04900021
*                                                                       04920021
NOSCALE1 LA    CONREG,2                 SET CONTROL                     04940021
         SR    CNTREG,CNTREG            CLEAR INDEX VALUE               04960021
         SR    INXREG,INXREG                                            04980021
NEXTSCAL L     VALREG,UASCALE(INXREG)   LOAD SCALED OR UNSCALED VALUE   05000021
         BAL   INTREG,FIXCONV           CONVERT TO FIXED PT.            05020021
         ST    VALREG,UASCALE(INXREG)   CONVERTED FIXED VALUE           05040021
         STH   VALREG,X2FIN(CNTREG)     FINAL VALUE                     05060021
         A     CNTREG,TWO               MODIFY                          05080021
         A     INXREG,FOUR                                              05100021
         BCT   CONREG,NEXTSCAL                                          05120021
         B     CHKCNT                                                   05140021
*                                                                       05160021
* FLOATING PT IS NOT SPECIFIED                                          05180021
* IS SCALING SPECIFIED                                                  05200021
*                                                                       05220021
*                                                                       05240021
*                                                                       05260021
* STORE  X1,Y1,X2,Y2 IN WORK AREA                                       05280021
NOFLOAT  LA    CONREG,4                                                 05300021
         SR    INXREG,INXREG                                            05320021
         SR    CNTREG,CNTREG                                            05340021
NEXXY    LH    VALREG,X1(INXREG)        X1,Y1,X2,Y2                     05360021
         ST    VALREG,FX1(CNTREG)       X1,Y1,X2,Y2 IN WORKAREA         05380021
         A     INXREG,TWO                                               05400021
         A     CNTREG,FOUR                                              05420021
         BCT   CONREG,NEXXY                                             05440021
*                                                                       05460021
         CLI   S,C'S'                   IS SCALE INDICATED              05480021
         BNE   CHKCNT                   INDICATES NO SCALE              05500021
* DATA MUST BE SCALED IN FIXED PT.                                      05520021
*                                                                       05540021
FIXSCAL  LA    INTREG,2                 SET INTERNAL CONTROL            05560021
         SR    CONREG,CONREG            CLEAR MODIFIER                  05580021
         SR    INXREG,INXREG            CLEAR MODIFIER                  05600021
FIXSCAL1 L     VALREG,U1(CONREG)        U1 THEN V1                      05620021
         L     TEMREG,U2(CONREG)        U2 THEN V2                      05640021
         SR    TEMREG,VALREG            U2-U1                           05660021
         BC    13,ERR16RET         MINUS OR ZERO                        05680021
         L     XREG,UA(INXREG)          UA                              05700021
         SR    XREG,VALREG              UA-U1  VARIABLE RESULT          05720021
         L     YREG,FX1(INXREG)         X1 OR Y1                        05740021
         L     VALREG,FX2(INXREG)       X2 OR Y2                        05760021
         SR    VALREG,YREG              X2-X1                           05780021
         SR    EREG,EREG                CLEAR MULTIPLICAND              05800021
         MR    EREG,VALREG              UA-U1*X2-X1                     05820021
         DR    EREG,TEMREG                                              05840021
         AR    XREG,YREG                                                05860021
         ST    XREG,UASCALE(INXREG)     X OR Y SCALED                   05880021
         A     CONREG,EIGHT                                             05900021
         A     INXREG,FOUR                                              05920021
         BCT   INTREG,FIXSCAL1                                          05940021
         LH    VALREG,UAS2              X                               05960021
         STH   VALREG,X2FIN             SCALED VALUE OF X               05980021
         LH    VALREG,VAS2              Y                               06000021
         STH   VALREG,Y2FIN             SCALED VALUE OF Y               06020021
*                                                                       06040021
*CHECK COUNT-IS IT EQUAL TO TWO OR MORE                                 06060021
*                                                                       06080021
CHKCNT   CLC   COUNT,TWO+2              COMPARE COUNT TO TWO            06100021
         BNL   SECOND                   YES                             06120021
         L     WRKREG,WRTADDR           CHECK FOR GRID IF APPLIES       06140021
         BALR  LINREG,WRKREG                                            06160021
         CLC   N,ONE+2                 FOR ONLY ONE POINT               06180021
         BE    ONEPT                   HANDLE IT IN POINT MODE          06200021
         LA    CNTREG,2                                                 06220021
         LA    ADDREG,ORDER1                                            06240021
         CLI   PTYPE,C'B'                                               06260021
         BNH   PTMODE                   MODE INITIALIZE GDOA FOR PTONLY 06280021
*                                       GENERATE                        06300021
         MVI   ORDER1,X'2A'             ORDER FOR VECTOR PLOTTING       06320021
         MVI   ORDER2,X'02'                                             06340021
         MVC   GOMODE,ORDER1                                            06360021
         BAL   LINREG,STORE             GIVE TO STORE ROUTINE           06380021
         B     SECOND                                                   06400021
PTMODE   MVI   ORDER1,X'2A'             ORDER FOR POINT PLOTTING        06420021
         MVI   ORDER2,X'00'             GENERATED GIVE                  06440021
         MVC   GOMODE,ORDER1                                            06460021
         BAL   LINREG,STORE             TO STORE ROUTINE                06480021
         B     SECOND                                                   06500021
*                                                                       06520021
* IS N VALUE EQUAL TO OR LESS THAN 1                                    06540021
*                                                                       06560021
*                                                                       06580021
*                                                                       06600021
* WAS PT. OFF SCREEN-ONLY 1 POINT ESTABLISHED                           06620021
*                                                                       06640021
ONEPT    BAL   LINREG,SCLCHK            DISCONTINUE IF ONLY ONE         06660021
         CLC   SWSTATUS,STATUS1         POINT AND IT IS OFF SCREEN      06680021
         BNE   ERR32RET                                                 06700021
*                                                                       06720021
* PT ON SCREEN- SET UP ORDER FOR A PT.                                  06740021
*                                                                       06760021
         MVI   ORDER1,X'2A'             PT PLOT MODE                    06780021
         MVI   ORDER2,X'00'                                             06800021
         MVC   ORDER3,X2FINAL           X AND Y FOR A POINT             06820021
         MVC   GOMODE,ORDER1                                            06840021
         LA    CNTREG,6                 MOVE SIX BYTES                  06860021
         LA    ADDREG,ORDER1            ADDRESS OF DATA                 06880021
         BAL   LINREG,STORE             STORE GRAPHIC DATA IN GDOA      06900021
         BAL   LINREG,PLTCH        GO PLOT A CHARECTOR        LI A44596 06910021
         BAL   LINREG,STORE        STORE IN GDOA              LI A44596 06912021
         B     RET                      RETURN TO USER                  06920021
*                                                                       06940021
* IS COUNT EQUAL TO N                                                   06960021
*                                                                       06980021
NOT1     CLC   N,COUNT                  COMPARE N TO COUNT              07000021
         BE    RET                      END OF PROGRAM                  07020021
* UPDATE COUNT FOR NEXT POINT                                           07040021
         LH    CNTREG,COUNT             COUNT                           07060021
         A     CNTREG,ONE               UPDATE COUNT                    07080021
         STH   CNTREG,COUNT             SAVE COUNT                      07100021
*                                                                       07120021
         L     VALREG,ZERO              CLEAR SKIPSW                    07140021
         STH   VALREG,SKIPSW                                            07160021
         MVC   PT1SW,OFFSW              UPDATE SCREEN GRID SWITCH       07180021
* SAVE THE PREVIOUS CALCULATED VALUE                                    07200021
         L     VALREG,UASCALE           X VALUE MAXIMUM SIZE            07220021
         ST    VALREG,UASCALE2          PT1-X-VALUE                     07240021
         L     VALREG,VASCALE           Y VALUE MAXIMUM SIZE            07260021
         ST    VALREG,VASCALE2          PT1-Y-VALUE                     07280021
         L     VALREG,X2FINAL                                           07300021
         ST    VALREG,X1FINAL                                           07320021
*                                                                       07340021
         SR    CONREG,CONREG            CLEAR MODIFIER                  07360021
         LA    CNTREG,2                 SET LOOP CONTROL                07380021
* THIS ROUTINE GET U-AND V TABLE VALUES                                 07400021
*                                                                       07420021
* GET NEXT VALUE FROM TABLE-UTAB                                        07440021
*                                                                       07460021
INCU     LH    INXREG,INDEX             TABLE INDEX VALUE               07480021
         L     WRKREG,UTAB              UTAB ADDRESS                    07500021
         CLI   I,C'X'                   U ARRAY INCREMENTAL             07520021
         BE    UINCR                    YES                             07540021
         CLI   I,C'Z'                   U AND V ARRAY INCREMENTAL       07560021
         BE    UINCR                    YES-BOTH U AND V ARE INCREMENT  07580021
FLCHK    CLI   F,C'F'                   FLOATING PT.                    07600021
         BE    FLRCHK                   YES-IS IT RELATIVE              07620021
FIXVAL   L     VALREG,4(INXREG,WRKREG)  NO -BINARY OR ASSUMED BINARY    07640021
         CLI   A,C'R'                   RELATIVE                        07660021
         BNE   USTORE                   NOT RELATIVE-STORE INDEXED VAL. 07680021
         B     USTORA                   RELATIVE-ADD PREVIOUS VALUE     07700021
UINCR    CLI   F,C'F'                   FLOATING PT.                    07720021
         BE    FLOATAD                  FLOAT SPECIFIED                 07740021
         L     VALREG,4(0,WRKREG)       FIXED INCREMENT VALUE-NOT INDEX 07760021
USTORA   A     VALREG,UA(CONREG)        ADD PREVIOUS ABS. VALUE         07780021
USTORE   ST    VALREG,UA(CONREG)        NEXT ABS. VALUE                 07800021
         ST    VALREG,UASCALE(CONREG)   NEW X OR Y VALUE                07820021
         B     INCV                     GET THE V VALUE                 07840021
*                                                                       07860021
* FLOATING PT NUMBERS SPECIFIED                                         07880021
*                                                                       07900021
FLRCHK   LE    0,4(INXREG,WRKREG)       NEXT FLOATING VALUE-INDEXED     07920021
         CLI   A,C'R'                   IS FLOAT RELATIVE               07940021
         BNE   STORFL                   NO REPLACE VALUE                07960021
         B     STORAF                   YES                             07980021
FLOATAD  LE    0,4(0,WRKREG)            FLOAT INCREMENT-NOT INDEXED     08000021
STORAF   AE    0,UA(CONREG)             FLOAT ADD ABS. VALUE            08020021
STORFL   STE   0,UA(CONREG)             NEW VALUE X OR Y                08040021
         STE   0,UASCALE(CONREG)        NEW X OR Y VALUE                08060021
*                                                                       08080021
* SET UP V TABLE AND MAKE CHECKS                                        08100021
*                                                                       08120021
INCV     BCT   CNTREG,DOV               DO V TABLE                      08140021
         B     OUT                                                      08160021
DOV      LA    CONREG,4                 SET MODIFIER                    08180021
         L     WRKREG,VTAB              VTAB ADDRESS                    08200021
         CLI   I,C'Y'                   V INCREMENTAL                   08220021
         BE    UINCR                    YES                             08240021
         CLI   I,C'Z'                   V AND U INCREMENTAL             08260021
         BE    UINCR                    YES                             08280021
         B     FLCHK                    NO                              08300021
*                                                                       08320021
* BOTH TABLE VALUES STORED-UPDATE INDEX                                 08340021
*                                                                       08360021
OUT      A     INXREG,FOUR              UPDATE INDEX VALUE              08380021
         STH   INXREG,INDEX             SAVE TABLE INDEX VALUE          08400021
         CLI   F,C'F'                                                   08420021
         BE    CHKSCA                   YES                             08440021
         CLI   S,C'S'                                                   08460021
         BE    FIXSCAL                  YES-SCALE NEW VALUES            08480021
* STORE FIXED UNSCALED VALUES FOR NEXT PT VALUE                         08500021
STOXY    L     VALREG,UA                                                08520021
         STH   VALREG,X2FIN             X2 UNSCALED FIXED VALUE         08540021
         L     VALREG,VA                                                08560021
         STH   VALREG,Y2FIN             Y2 UNSCALED FIXED VALUE         08580021
         B     CHKCNT                   NO                              08600021
CHKSCA   CLI   S,C'S'                   SCALING SPECIFIED               08620021
         BE    FLTSCAL                  YES                             08640021
         B     NOSCALE1                 NO                              08660021
SECOND   BAL   LINREG,SCRNGRD                                           08680021
         CLC   SKIPSW,ONE+2             SKIP PLOTTING IF REQUIRED       08700021
         BE    NOT1                                                     08720021
         CLI   PTYPE,C'B'               FOR CHARACTER MODE              08740021
         BE    BEAMOFF                  POSITION BEAM OFF               08760021
         CLI   PTYPE,C'A'               FOR POINT MODE                  08780021
         BE    BEAMON                   POSITION BEAM ON                08800021
         CLC   COUNT,ONE+2              FOR OTHER THAN                  08820021
         BH    BEAMON                   FIRST POINT,POSITION BEAM ON    08840021
BEAMOFF  MVC   ORDER3,X2FINAL           OTHERWISE INSERT                08860021
         OI    ORDER3,X'40'             BLANK BEAM BIT IN               08880021
         LA    CNTREG,4                 ORDER AND                       08900021
         LA    ADDREG,ORDER3                                            08920021
         BAL   LINREG,STORE             STORE                           08940021
         B     FLOW2                    BACK TO NORMAL FLOW             08960021
BEAMON   CLI   PTYPE,C'B'               IF NOT VECTOR MODE USE          08980021
         BNH   REGOUT                  STANDARD OUTPUT                  09000021
         BAL   LINREG,VECTOR            OTHERWISE GENERATE PSEUDO VEC.  09020021
         B     FLOW2                                                    09040021
REGOUT   MVC   ORDER3,X2FINAL          POSITION AT                      09060021
         LA    ADDREG,ORDER3                                            09080021
         LA    CNTREG,4                 PT2,BEAM ON                     09100021
         BAL   LINREG,STORE             STORE                           09120021
FLOW2    CLI   PTYPE,C'B'               IF CHARACTER                    09140021
         BE    CHAR                     MODE OR                         09160021
         CLI   PTYPE,C'E'               VECTOR AND CHARACTER            09180021
         BE    CHAR                     PLOT CHARACTER                  09200021
         CLI   PTYPE,C'D'               IF NOT POINT-VECTOR MODE        09220021
         BNE   NOT1                     GO TO UPDATE THE COUNTER        09240021
         LA    CNTREG,4                 OTHERWISE REPEAT ORDER TO       09260021
         LA    ADDREG,ORDER3                                            09280021
         BAL   LINREG,STORE             STORE TO INTENSIFY END POINT    09300021
         B     NOT1                     GO TO UPDATE THE COUNTER        09320021
CHAR     BAL   LINREG,PLTCH             GO PLOT A CHARACTER             09340021
         BAL   LINREG,STORE             STORE GRAPHIC ORDERS IN GDOA    09360021
         CLI   PTYPE,C'E'               IF NOT VECTOR CHARACTER MODE    09380021
         BNE   REPTM                    REPEAT ENTER POINT MODE         09400021
         MVI   ORDER1,X'2A'             OTHERWISE REENTER VECTOR MODE   09420021
         MVI   ORDER2,X'02'                                             09440021
         OI    ORDER3,X'40'             TURN BEAM OFF                   09460021
         MVC   GOMODE,ORDER1                                            09480021
         LA    CNTREG,6                 AND REPEAT ORDER                09500021
         LA    ADDREG,ORDER1                                            09520021
         BAL   LINREG,STORE             TO STORE OF CURRENT POSITION    09540021
         B     NOT1                     GET NEXT VALUES                 09560021
REPTM    LA    CNTREG,2                                                 09580021
         LA    ADDREG,ORDER1                                            09600021
         MVI   ORDER1,X'2A'             ORDER FOR POINT PLOTTING        09620021
         MVI   ORDER2,X'00'                                             09640021
         MVC   GOMODE,ORDER1                                            09660021
         BAL   LINREG,STORE             TO STORE ROUTINE                09680021
         B     NOT1                     UPDATE THE COUNTER              09700021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    09720021
* INPUT TO SUBROUTINE                                                   09740021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   09760021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                09780021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               09800021
*   OABREG = ADDRESS OF OACB                                            09820021
STORE    STM   8,12,PORSAVE             SAVE REGISTERS                  09840021
         SR    PASREG,PASREG            CLEAR OVERFLOW INDICATOR        09860021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        09880021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              09900021
*                                                                       09920021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 09940021
*                                                                       09960021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        09980021
         LA    TEMREG,4                                                 10000021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               10020021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    10040021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       10060021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       10080021
         CR    TEMREG,SLOREG                                            10100021
         BNH   OK                                                       10120021
*                                                                       10140021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    10160021
*                                                                       10180021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         10200021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       10220021
*                                                                       10240021
* ANY BYTES TO STORE                                                    10260021
*                                                                       10280021
         C     WRKREG,ZERO                                              10300021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           10320021
         LH    TEMREG,H2A02                                             10340021
         CH    TEMREG,GOMODE                                            10360021
         BH    STORE3A                                                  10380021
         LH    TEMREG,H0003                                             10400021
         NR    TEMREG,WRKREG                                            10420021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (DAPL)      7468 10440021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      10460021
         BAL   INTREG,STORE6            LINK INTERNALLY                 10480021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              10500021
*                                                                       10520021
* STORE REGISTERS IN WORKAREA                                           10540021
*                                                                       10560021
         STM   0,15,OVFSAVE             OVERFLOW SAVE IN WORKAREA       10580021
         CLC   ADGOFFSG,ZERO            WAS OFF SCREEN/GRID LOADED      10600021
         BE    LAOVFLO                  NO                              10620021
         SR    WRKREG,WRKREG                                            10640021
         ST    WRKREG,ADGOFFSG          CLEAR ADDRESS                   10660021
         LR    3,1                      SAVE REG 1.                     10680021
         DELETE EP=GOFFSG                                               10700021
         LR    1,3                      RESTORE REG 1.                  10720021
LAOVFLO  L     15,8(0,OABREG)           LOAD OVERFLOW ADDRESS           10740021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         10760021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      10780021
         LM    0,15,OVFSAVE             RELOAD AND CONTINUE TO STORE    10800021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    10820021
*                                                                       10840021
* NO SPACE AVAILABLE                                                    10860021
*                                                                       10880021
*                                                                       10900021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 10920021
         BL    STORE3                                                   10940021
*                                                                       10960021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          10980021
*                                                                       11000021
         B     ERR24RET                                                 11020021
*                                                                       11040021
*                                                                       11060021
OK       BAL   INTREG,STORE6            LINK INTERNALLY                 11080021
         LM    8,12,PORSAVE            RELOAD REGISTERS                 11100021
         BR    LINREG                                                   11120021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           11140021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      11160021
         BH    STORE7                                                   11180021
         LR    TEMREG,WRKREG                                            11200021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       11220021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               11240021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              11260021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                11280021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           11300021
         BR    INTREG                   RETURN INTERNALLY               11320021
STORE7   LR    SLOREG,TEMREG                                            11340021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       11360021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               11380021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              11400021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            11420021
         SR    WRKREG,TEMREG           REDUCE BY 255                    11440021
         B     STORE6A                  MAKE NEXT COMPARISON            11460021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               11480021
*                                                                       11500021
*    CONVERT  FLOATING  POINT  TO  FIXED  POINT  VALUES                 11520021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          11540021
*                                                                       11560021
FIXCONV  ST    1,OVFSAVE                STORE IN FIRST WORD REG. 1      11580021
         TM    OVFSAVE+3,X'07'          TEST LAST THREE BITS            11600021
         BZ    SETMODI                  NO BITS ON SET INDEX TO ZERO    11620021
         LA    TEMREG,4                 SET MODIFIER                    11640021
         B     SAVFLT                   START CONVERSION                11660021
         MVC   GOMODE,CHARMOD                                           11680021
SETMODI  LA    TEMREG,0                 SET MODIFIER TO ZERO            11700021
SAVFLT   ST    VALREG,TEMFLT(TEMREG)    SAVE FLOAT VALUE                11720021
         SR    WRKREG,WRKREG                                            11740021
         ST    WRKREG,TEMFLT+4(TEMREG)  CLEAR SECOND WORD               11760021
         LD    6,TEMFLT(TEMREG)         VALUE TO FLOAT REGISTERS        11780021
         N     VALREG,FCHAR                                             11800021
         BE    FLERR1                   CHARACTERISTIC IS ZERO          11820021
         AE    6,FLPT5                  ADD .5 TO ROUND                 11840021
         AW    6,X4E                    ADD UNNORMALIZED-RIGHT JUSTIFY  11860021
         STD   6,TEMFLT(TEMREG)         SAVE VALUES                     11880021
         L     WRKREG,TEMFLT+4(TEMREG)  CHECK SECOND WORD               11900021
         N     WRKREG,MZERO             CHECK BIT 32                    11920021
         BM    ERR12RET                 INDICATE ERROR                  11940021
         L     WRKREG,TEMFLT(TEMREG)                                    11960021
         N     WRKREG,BYTE123                                           11980021
         BM    ERR12RET                                                 12000021
         L     WRKREG,TEMFLT(TEMREG)                                    12020021
         N     WRKREG,MZERO             DROP CHARACTERISTIC             12040021
         L     VALREG,TEMFLT+4(TEMREG)  NEW FIXED VALUE                 12060021
         LTR   WRKREG,WRKREG                                            12080021
         BNL   NOTNEG                   NOT NEGATIVE                    12100021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLIMENT           12120021
NOTNEG   BR    INTREG                   RETURN TO N S I                 12140021
FLERR1   CE    6,ZERO                   IS TOTAL VALUE ZERO             12160021
         BE    NOTNEG                   RETURN                          12180021
         B     ERR12RET                 SET ERROR CODE AND RETURN       12200021
*                                                                       12220021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  VALUES                 12240021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          12260021
*                                                                       12280021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   12300021
         ST    VALREG,OVFSAVE                                           12320021
         LE    0,OVFSAVE                LOAD TO FLOAT REG.              12340021
         AE    0,X6                     NORMALIZE                       12360021
         STE   0,OVFSAVE                                                12380021
         L     VALREG,OVFSAVE           FLOAT PT. VALUE IN REG.         12400021
         BR    LINREG                                                   12420021
*   ROUTINE TO CHECK IF PT. IS OUTSIDE OF GRID BOUNDARY                 12440021
*                                                                       12460021
GRLCHK   LH    VALREG,X1                X1                              12480021
         C     VALREG,UASCALE           X VALUE COMPARED TO X1          12500021
         BH    SETIND                   OFF GRID LIMIT                  12520021
         LH    VALREG,X2                X2                              12540021
         C     VALREG,UASCALE           X VALUE COMPARED TO X2          12560021
         BL    SETIND                   OFF GRID LIMIT                  12580021
         LH    VALREG,Y1                Y1                              12600021
         C     VALREG,VASCALE           Y VALUE COMPARED TO Y1          12620021
         BH    SETIND                   OFF GRID                        12640021
         LH    VALREG,Y2                Y2                              12660021
         C     VALREG,VASCALE           Y VALUE COMPARED TO Y2          12680021
         BL    SETIND                   OFF GRID                        12700021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET OFF            12720021
         B     OV10                                                     12740021
SETIND   MVI   OFFSW,X'11'              SET INDICATOR                   12760021
         BR    LINREG                   RETURN                          12780021
OV10     BR    LINREG                   RETURN                          12800021
*                                                                       12820021
*                                                                       12840021
*    ROUTINE TO CHECK IF POINT IS OFF THE SCREEN                        12860021
*                                                                       12880021
SCLCHK   L     VALREG,UASCALE           GET X VALUE                     12900021
         C     VALREG,ZERO              X VALUE COMPARED TO ZERO        12920021
         BL    SETBITS                  OFF SCREEN                      12940021
         C     VALREG,HIGH              X VALUE COMPARED TO 4095        12960021
         BH    SETBITS                  OFF SCREEN                      12980021
         L     VALREG,VASCALE           GET Y VALUE                     13000021
         C     VALREG,ZERO              Y VALUE COMPARED TO ZERO        13020021
         BL    SETBITS                  OFF SCREEN                      13040021
         C     VALREG,HIGH              Y VALUE COMPARED TO 4095        13060021
         BH    SETBITS                  OFF SCREEN                      13080021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET OFF            13100021
         BR    LINREG                   RETURN                          13120021
SETBITS  MVI   OFFSW,X'11'              SET INDICATOR                   13140021
         BR    LINREG                   RETURN                          13160021
*                                                                       13180021
*                                                                       13200021
SCRNGRD  ST    LINREG,RSAVE             SAVE THE BRANCH REGISTER        13220021
         L     WRKREG,WRTADDR           GET BOUNDARY CHECK RT ADDRESS   13240021
         BALR  LINREG,WRKREG             AND BRANCH TO CHECK            13260021
         CLC   SWSTATUS,STATUS1         CHECK THE SWS STATUS IF STATUS1 13280021
         BE    RESREG                   ARE ALL POINTS ON ANSWER  YES   13300021
OPTIONA  CLI   SG,C'A'                  OTHERWISE OFFSG CONDITION EXIST 13320021
         BNE   OPTIONB                   CHECK USER-SPECIFIED OPTION    13340021
         BAL   LINREG,ERR44             IF A OPTION SET ERR CODE AND    13360021
         B     ANALOFF                   ANALIZE OFF STATUS TO HANDLE   13380021
OPTIONB  CLI   SG,C'B'                  IS B OPTION SPECIFIED           13400021
         BNE   OPTIONC                  IF NOT TEST FOR C               13420021
         BAL   LINREG,ERR48             IF YES SET ERR CODE AND         13440021
         B     ANALOFF                   ANALIZE OFF STATUS TO HANDLE   13460021
OPTIONC  CLI   SG,C'C'                  IS C OPTION SPECIFIED           13480021
         BNE   OPTIOND                  IF NOT TEST FOR D               13500021
         BAL LINREG,SCLCHK              CHECK FURTHER IF POINT          13520021
         CLI   OFFSW,X'11'               OFF SCREEN                     13540021
         BE    ERR32RET                 IFF OFF SCREEN IMMEDIATE RET    13560021
         LA    15,32                    OTHERWISE SET ERROR CODE AND    13580021
         BAL   LINREG,ERRCNT             CONTINUE THE JOB               13600021
         BAL   LINREG,GRLCHK            CHECK FURTHER FOR GRID          13620021
         B     ANALOFF                  GO TO ANALIZE OFF STATUS        13640021
OPTIOND  CLI   SG,C'D'                  IS OPTION D SPECIFIED           13660021
         BNE   ASSUMEE                  IF NOT ASSUME OPTION E          13680021
         B     ERR28RET                 IMMEDIATE ERROR RETURN          13700021
ASSUMEE  B     ERR32RET                 IMMEDIATE ERROR RETURN          13720021
         BE    ERR32RET                 IF OFF SCREEN IMMEDIATE RETURN  13740021
         BAL   LINREG,SCLCHK            IF OPTION C TEST FOR OFF SCRN   13760021
         LA    15,32                    OTHERWISE SET ERROR CODE        13780021
         BAL   LINREG,ERRCNT            UPDATE ERROR COUNT              13800021
         MVI   OFFSW,X'11'              RESTORE OFF BOUNDARY STATUS     13820021
         B     RESREG                   CONTINUE JOB                    13840021
SETSKIP  L     VALREG,ONE               SET SWITCH TO SKIP TO NEXT      13860021
         STH   VALREG,SKIPSW            POINT                           13880021
         B     RESREG                   AND RETURN VIA RESTORE REG      13900021
ANALOFF  CLI   PTYPE,C'B'               IF NOT VECTOR                   13920021
         BH    ANALVEC                  TYPE SKIP IT IF                 13940021
         CLC   SWSTATUS,STATUS3         IT IS POINT 2 OFF               13960021
         BE    SETSKIP                                                  13980021
         B     RESREG                   OTHERWISE CONTINUE              14000021
ANALVEC  CLC   COUNT,ONE+2              IF FIRST POINT OFF, GET         14020021
         BNH   SETSKIP                  GET ANOTHER                     14040021
         STM   13,0,PORSAVE             SAVE REGISTERS                  14060021
         ST    13,OVFSAVE+4             SAVE POR SAVEAREA CHAINING ADDR 14080021
         ST    15,SVR15                 SAVE ERROR REGISTER             14100021
         LA    13,OVFSAVE               LOAD GOFFSG RT SAVEAREA ADDR    14120021
         LR    WRKREG,1                 SAVE REG1-WKAREA POINTER        14140021
         CLC   GOFFSGAD,ZERO            CHECK IF GOFFSG RT ADDR AREA 0  14160021
         BNE   OFFHDLG                  IF NOT RT BROUGHT IN GO TO HDL  14180021
         LA    1,SABL                   LOAD 24-WORD PARTAB START ADDR  14200021
         LOAD  EP=GOFFSG                RETAIN THE MODULE               14220021
         LR    1,WRKREG                 RESTORE REGISTER 1              14240021
         ST    0,GOFFSGAD               SAVE GOFFSG RT ADDRESS          14260021
OFFHDLG  L     15,GOFFSGAD              LOAD GOFFSG RT ADDRESS          14280021
         LA    1,SABL                   LOAD 24-WORD PARTAB ADDR        14300021
         BALR  14,15                    BRANCH TO GOFFSG RT             14320021
         LR    1,WRKREG                 RESTORE REG 1                   14340021
LINKOUT  LM    13,0,PORSAVE             RESTORE REG 13 TO 0             14360021
         L     15,SVR15                 RESTORE ERROR REGISTER          14380021
*   ANALIZE THE RESPONSE OF GOFFSG ROUTINE AND GENERATE PROPER DATA     14400021
ANALRES  CLC   NI,ZERO                  IS NI=0                         14420021
         BE    NOINTS                   IF SO GO TO NO INTERSECT RT     14440021
         CLC   NI,ONE                   IS NI=1                         14460021
         BE    ONEINTS                  IF SO GO TO ONE INTERSECT RT    14480021
BOTHOUT  MVC   X1FINAL,XYINT1           OTHERWISE GDV I1X,I1Y,B         14500021
         MVC   X2FINAL,XYINT2                                           14520021
         MVC   ORDER3,X1FINAL           AND GDV I2X,I2Y,U               14540021
         MVC   ORDER4,X2FINAL                                           14560021
         OI    ORDER3,X'40'                                             14580021
         LA    CNTREG,8                 LOAD BYTE NUMBER                14600021
         LA    ADDREG,ORDER3                                            14620021
         BAL   LINREG,STORE             GIVE TO STORE ROUTINE           14640021
         B     SETSKIP                  SKIP THE NEXT POINT             14660021
NOINTS   CLC   SWSTATUS,STATUS2         SEE IF PT1 OFF PT2 ON           14680021
         BE    NOINTSA                  IF SO IT'S NO INTS CONDITION A  14700021
         B     SETSKIP                  GO ON TO NEXT POINT             14720021
NOINTSA  MVC   X1FINAL,X2FINAL          GDV X2,Y2,B                     14740021
         MVC   ORDER3,X1FINAL           AND GDV X2,Y2,U                 14760021
         MVC   ORDER4,X2FINAL                                           14780021
         OI    ORDER3,X'40'                                             14800021
         LA    CNTREG,8                 AND GIVE TO STORE ROUTINE       14820021
         LA    ADDREG,ORDER3                                            14840021
         B     STOREP                                                   14860021
ONEINTS  CLC   SWSTATUS,STATUS2         SEE IF PT1 OFF PT2 ON           14880021
         BE    ONEINTSA                 IF SO GO TO ONE INTS CONDITIONA 14900021
         CLC   SWSTATUS,STATUS3         SEE IF PT1 ON PT2 OFF           14920021
         BE    ONEINTSB                 IF SO GO TO ONE INTS CONDITIONB 14940021
         B     BOTHOUT                                                  14960021
ONEINTSA MVC   X1FINAL,XYINT1           GENERATE I1X,I1Y,B              14980021
         MVC   ORDER3,X1FINAL                                           15000021
         OI    ORDER3,X'40'             BLAND BEAM BIT                  15020021
         LA CNTREG,4                    AND GIVE TO STORE ROUTINE       15040021
         LA    ADDREG,ORDER3                                            15060021
         B     STOREP                                                   15080021
ONEINTSB MVC   X2FINAL,XYINT1                                           15100021
         MVC   ORDER3,X2FINAL                                           15120021
         LA CNTREG,4                    GDVI1X,I1Y,U AND THEN STORE     15140021
         LA    ADDREG,ORDER3                                            15160021
         BAL   LINREG,STORE             STORE THE POINT AND             15180021
         B     SETSKIP                  AND SKIP ANYTHING ELSE          15200021
STOREP   BAL   LINREG,STORE                                             15220021
RESREG   L     LINREG,RSAVE             RESTORE THE L INE REGISTER      15240021
         BR    LINREG                   AND RETURN                      15260021
* SUBROUTINE TO PLOT A CHARACTER                                        15280021
PLTCH    CLI   E,C'O'                   NO OVERLAP                      15300021
         BE    OV9                      YES-NO OVER LAP PERMITTER       15320021
         B     PLTCH1                   VECTOR AND CHAR OR VECTOR ONLY  15340021
OV9      LH    VALREG,X2FIN             X2                              15360021
         SH    VALREG,X1FIN             X2-X1                           15380021
         LPR   XREG,VALREG              ABSOLUTE OF DELTA X             15400021
         C     XREG,EIGHT                                               15420021
         BH    PLTCH1                   MORE THAN EIGHT                 15440021
         LH    VALREG,Y2FIN             Y2                              15460021
         SH    VALREG,Y1FIN             Y2-Y1                           15480021
         LPR   YREG,VALREG              ABSOLUTE OF DELTA Y             15500021
         C     YREG,EIGHT                                               15520021
         BH    PLTCH1                   MOVE THAN EIGHT                 15540021
*                                                                       15560021
* DIFFERENCE IS LESS THAN EIGHT BETWEEN POINTS                          15580021
*                                                                       15600021
         L     VALREG,X1FINAL           X1,Y1                           15620021
         ST    VALREG,X2FINAL           STORE X1,Y1 OVER X2,Y2          15640021
         B     NOT1                     CHECK COUNT                     15660021
PLTCH1   MVC   ORDER5,CHARMOD           MODE AND CHARACTER SIZE         15680021
         MVC   ORDER6,SYMBOL            LETTER                          15700021
         MVI   ORDER7,X'00'             NULL CHARACTER                  15720021
         LA    CNTREG,4                 COUNT TO MOVE                   15740021
         LA    ADDREG,ORDER5                                            15760021
         BR    LINREG                                                   15780021
*                                                                       15800021
*        PSUEDO VECTOR GENERATOR                                        15820021
*        THIS ROUTINE TAKES ADVANTAGE OF THE LIMITED                    15840021
*        VECTOR CAPABILITY OF A 2250 WITHOUT THE ABSOLUTE               15860021
*        VECTOR GRAPHICS FEATURE                                        15880021
*                                                                       15900021
VECTOR   ST    LINREG,RSAVE             SAVE BRANCH REGISTER            15920021
         L     VALREG,X1FINAL           GET X1 AND Y1                   15940021
         ST    VALREG,PT1VEC            TEMP CALCULATIONS               15960021
         L     VALREG,X2FINAL           X2,Y2                           15980021
         ST    VALREG,PT2VEC            TEMP CALCULATIONS               16000021
* DETERMINE DELTA X AND DELTA Y                                         16020021
         LH    VALREG,X2FIN             X2                              16040021
         SH    VALREG,X1FIN             X2-X1                           16060021
         STH   VALREG,DELTAX            SAVE DELTA X                    16080021
         LPR   XREG,VALREG              ABSOLUTE OF DELTA X             16100021
*                                                                       16120021
         LH    VALREG,Y2FIN             Y2                              16140021
         SH    VALREG,Y1FIN             Y2-Y1                           16160021
         STH   VALREG,DELTAY            SAVE DELTA  Y                   16180021
         LPR   YREG,VALREG              ABSOLUTE OF DELTA Y             16200021
*                                                                       16220021
* IS DELTA X EQUAL TO ZERO                                              16240021
*                                                                       16260021
         CLC   DELTAX,ZERO              DELTA X EQUAL ZERO              16280021
         BE    SETCNT                   LINE IS VERTICAL-ENTER ORDERS   16300021
         CLC   DELTAY,ZERO              DELTA Y EQUAL ZERO              16320021
         BNE   DETPTS                   DELTA X AND DELTA Y HAVE VALUES 16340021
* ON DROP THRU LINE IS HORIZONTAL                                       16360021
* HORIZONTAL LINE-ENTER GRAPHIC ORDERS ABSOLUTE VECTOR MODE             16380021
SETCNT   LA    CNTREG,10                TEN BYTES THIS PATH             16400021
         LA    ADDREG,ORDER1            ORDER ADDRESS                   16420021
* ENTER ABSOLUTE VECTOR MODE                                            16440021
NOMODE   MVC   ORDER3,X1FINAL           OLD PT.                         16460021
         OI    ORDER3,X'40'             BLANK BIT                       16480021
         MVC   ORDER4,X2FINAL           NEW PT.                         16500021
         BAL   LINREG,STORE             STORE GRAPHIC ORDERS IN GDOA    16520021
ENDVEC   L     LINREG,RSAVE RELOAD LINE REGISTER                        16540021
         BR    LINREG                   RETURN                          16560021
*                                                                       16580021
*                                                                       16600021
* DETERMINE INTERMEDIATE POINT                                          16620021
DETPTS   SR    CONREG,CONREG            CLEAR MODIFIER                  16640021
         CR    XREG,YREG                                                16660021
         BH    NPATH                    DELTA  X LESS THAN DELTA Y      16680021
         STH   YREG,NC                  SET NC=YREG                     16700021
         STH   YREG,NT                  SET NT=YREG                     16720021
         STH   XREG,NR                  SET NR=XREG                     16740021
         LH    VALREG,NR                AND NA                          16760021
         SRA   VALREG,1(0)              EQUAL TO                        16780021
         STH   VALREG,NA                NR/2                            16800021
OVCHG    LH    VALREG,NC                WHEN NC =0 ALL DONE             16820021
         CH    VALREG,ZERO                                              16840021
         BNH   ENDVEC                                                   16860021
         LH    VALREG,DELTAY                                            16880021
         LPR   YREG,VALREG                                              16900021
         LH    VALREG,DELTAX                                            16920021
         LPR   XREG,VALREG                                              16940021
         LH    VALREG,NA                                                16960021
         AH    VALREG,NR                NA=NA+NR                        16980021
         STH   VALREG,NA                                                17000021
         CH    VALREG,NT                IF NA GREATER OR EQUAL TO NT    17020021
         BNL   ANG45                    USE 45 DEGREE LINE              17040021
         CR    YREG,XREG                IF ABS. VALUE DELTA Y GREATER   17060021
         BH    ROUTE2                   THAN ABS.VALUE DELTAX-ROUTE2    17080021
         LH    VALREG,DELTAX            IF DELTA X LESS THAN 0          17100021
         CH    VALREG,ZERO                                              17120021
         BL    XNEG                     GO TO XNEG                      17140021
         LH    VALREG,PT1VE             OTHERWISE                       17160021
         A     VALREG,EIGHT             INCREMENT X ONE SMALL DELTA(SMD 17180021
         STH   VALREG,PT1VE                                             17200021
         B     NCDECR                                                   17220021
NPATH    STH   XREG,NC                                                  17240021
         STH   XREG,NT                                                  17260021
         STH   YREG,NR                                                  17280021
         LH    VALREG,NR                                                17300021
         SRA   VALREG,1(0)                                              17320021
         STH   VALREG,NA                                                17340021
         B     OVCHG                                                    17360021
ROUTE2   LH    VALREG,DELTAY            IF DELTAX IS ZERO AND Y         17380021
         CH    VALREG,ZERO              IS       LESS THAN ZERO         17400021
         BL    YNEG                     USE YNEG                        17420021
         LH    VALREG,PT2VE             OTHERWISE                       17440021
         A     VALREG,EIGHT             IMCREMENT Y                     17460021
         STH   VALREG,PT2VE             ONE SMD                         17480021
         B     NCDECR                                                   17500021
XNEG     LH    VALREG,PT1VE             DECREMENT                       17520021
         S     VALREG,EIGHT             X BY ONE SMD                    17540021
         STH   VALREG,PT1VE                                             17560021
         B     NCDECR                                                   17580021
YNEG     LH    VALREG,PT2VE             DECREMENT Y                     17600021
         S     VALREG,EIGHT             BY ONE SMD                      17620021
         STH   VALREG,PT2VE            STUFF IT AWAY                    17640021
         B     NCDECR                                                   17660021
ANG45    LH    VALREG,DELTAX            IF DELTA X IS LESS THAN         17680021
         CH    VALREG,ZERO              ZERO                            17700021
         BL    ROUTE3                   GO TO ROUTE3                    17720021
         LH    VALREG,DELTAY            IF DELTAY IS                    17740021
         CH    VALREG,ZERO              LESS THAN ZERO                  17760021
         BL    XPYN                     GO TO XPYN                      17780021
         LH    VALREG,PT1VE             OTHERWISE INCREMENT             17800021
         A     VALREG,EIGHT             BOTH BY ONE SMD                 17820021
         STH   VALREG,PT1VE                                             17840021
         LH    VALREG,PT2VE                                             17860021
         A     VALREG,EIGHT                                             17880021
         STH   VALREG,PT2VE                                             17900021
         B     NADECR                                                   17920021
*                                                                       17940021
ROUTE3   LH    VALREG,DELTAY            IF BOTH DELTA X AND Y ARE       17960021
         CH    VALREG,ZERO              LESS THAN ZERO                  17980021
         BL    BTHNEG                   GO TO BTHNEG                    18000021
         LH    VALREG,PT1VE             OTHERWISE                       18020021
         S     VALREG,EIGHT             DECREMENT X AND INCREMENT Y     18040021
         STH   VALREG,PT1VE             BY ONE SMD                      18060021
         LH    VALREG,PT2VE                                             18080021
         A     VALREG,EIGHT                                             18100021
         STH   VALREG,PT2VE                                             18120021
         B     NADECR                                                   18140021
*                                                                       18160021
XPYN     LH    VALREG,PT1VE             INCREMENT X                     18180021
         A     VALREG,EIGHT             AND DECREMENT Y BY ONE SMD      18200021
         STH   VALREG,PT1VE                                             18220021
         LH    VALREG,PT2VE                                             18240021
         S     VALREG,EIGHT                                             18260021
         STH   VALREG,PT2VE                                             18280021
         B     NADECR                                                   18300021
*                                                                       18320021
BTHNEG   LH    VALREG,PT1VE             DECREMENT X AN Y BY ONE SMD     18340021
         S     VALREG,EIGHT                                             18360021
         STH   VALREG,PT1VE                                             18380021
         LH    VALREG,PT2VE                                             18400021
         S     VALREG,EIGHT                                             18420021
         STH   VALREG,PT2VE                                             18440021
NADECR   LH    VALREG,NA                                                18460021
         SH    VALREG,NT                SUBTRACT NT FROM NA             18480021
         STH   VALREG,NA                                                18500021
NCDECR   LH    VALREG,NC                SUBTRACT ONE SMD FROM ABS.VALUE 18520021
         S     VALREG,EIGHT             OF THE LARGEST DELTA            18540021
         STH   VALREG,NC                SAVE FOR COMPLETION TEST        18560021
         MVC   ORDER3,PT1VEC            OUTPUT SMALL VECTOR             18580021
         LA    CNTREG,4                 USING THE STORE ROUTINE         18600021
         LA    ADDREG,ORDER3                                            18620021
         BAL   LINREG,STORE                                             18640021
         B     OVCHG                    AND CONTINUE                    18660021
*        XYLCHK     SUBROUTINE                                          18680021
*        ADDRESS OF XYLIM TABLE IN  XYLREG BEFORE  BAL                  18700021
XYLCHK   LA    CONREG,4                SET LOOP CONTROL                 18720021
         LA    INXREG,0                 SET  INDEX                      18740021
XYLLOOP  LH    TEMREG,X1(INXREG)        X1,Y1,X2,Y2                     18760021
         C     TEMREG,ZERO                                              18780021
         BL    ERR4RET                                                  18800021
         C     TEMREG,HIGH                                              18820021
         BH    ERR4RET                                                  18840021
         A     INXREG,TWO                                               18860021
         BCT   CONREG,XYLLOOP                                           18880021
         CLC   X1,X2                    X1 COMPARED TO X2               18900021
         BNL   ERR4RET                                                  18920021
         CLC   Y1,Y2                    Y1 COMPARED TO Y2               18940021
         BNL   ERR4RET                                                  18960021
         BR    INTREG                   RETURN TO MAIN LINE             18980021
ERR4RET  LA    15,4                     XYLIM X1,Y2,X2,Y2 LIMIT ERROR   19000021
         B     ERRCNTR                                                  19020021
ERR8RET  LA    15,8                                                     19040021
         B     ERRCNTR                                                  19060021
ERR12RET LA    15,12                    FLOATING POINT ERROR DETECTED   19080021
         B     ERRCNTR                                                  19100021
ERR16RET LA    15,16                    U1,V1 GREATER THAN U2,V2        19120021
         B     ERRCNTR                                                  19140021
ERR20RET LA    15,20                                                    19160021
         B     ERRCNTR                                                  19180021
ERR24RET LA    15,24                    USERS OVERFLOW-OLP NOT RESET    19200021
         B     ERRCNTR                                                  19220021
ERR28RET LA    15,28                                                    19240021
         B     ERRCNTR                                                  19260021
ERR32RET LA    15,32                    OPTION C                        19280021
         B     ERRCNTR                                                  19300021
ERR40    LA    15,40                    PARAMETERS ERROR-NOT SERIOUS    19320021
         B     ERRCNT                   ADD TO COUNT                    19340021
ERR44    LA    15,44                                                    19360021
         B     ERRCNT                                                   19380021
ERR48    LA    15,48                                                    19400021
         B     ERRCNT                   ADD TO COUNT                    19420021
ERRCNTR  LA    LINREG,RET                                               19440021
ERRCNT   L     TEMREG,ERRCOUNT                                          19460021
         A     TEMREG,ONE                                               19480021
         ST    TEMREG,ERRCOUNT                                          19500021
         BR    LINREG                                                   19520021
*                                                                       19540021
*   RET SUBROUTINE TESTS COUNT IN WORK AREA,(ERRCOUNT) AND              19560021
*   SETS BIT IN SIGN POSITION OF REG. 15 IF MULTIBLE ERRORS             19580021
*   (MORE THAN ONE)                                                     19600021
RET      CLC   ADGOFFSG,ZERO            HAS OFF SCREEN/GRID ROUTINE     19620021
         BE    RET1                                                     19640021
         ST    15,SVR15                 SAVE ERROR REGISTER             19660021
         LR    WRKREG,1                 SAVE REGISTER 1                 19680021
         DELETE EP=GOFFSG                                               19700021
         LR    1,WRKREG                 RESTORE REGISTER 1              19720021
         L     15,SVR15                 RESTORE ERROR REGISTER          19740021
RET1     LA    TEMREG,1                                                 19760021
         C     TEMREG,ERRCOUNT                                          19780021
         BL    SETBIT                                                   19800021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            19820021
RETMACRO L     WRKREG,MASKSV                                            19840021
         SPM   WRKREG                                                   19860021
         RETURN (14,12),T,RC=(15)                                       19880021
SETBIT   O     15,MZERO                                                 19900021
         B     RETMACRO                                                 19920021
BYCT     DC    F'120'                                                   19940021
ZERO     DC    F'0'                     ZERO                            19960021
MZERO    DC    X'80000000'              MINUS ZERO                      19980021
ONE      DC    F'1'                                                     20000021
TWO      DC    F'2'                                                     20020021
MTWO     DC    X'FFFFFFFE'              MINUS TWO                       20040021
FOUR     DC    F'4'                                                     20060021
EIGHT    DC    F'8'                                                     20080021
HIGH     DC    F'4095'                  HIGH LIMIT                      20100021
BYTE3    DC    X'0000FF00'              MASK SYMBOL-EBCDIC CODE         20120021
BYTE123  DC    X'00FFFFFF'                                              20140021
ALLFF    DC    X'FFFFFFFF'              ALL BITS                        20160021
X6       DC    X'46000000'              EXPONENT OF SIX                 20180021
         DS    0D                       ALIGN BOUNDARY                  20200021
X4E      DC    X'4E00000000000000'                                      20220021
FLPT5    DC    E'.5'                                                    20240021
FCHAR    DC    X'7F000000'              MASK FOR CHARACTERISTIC         20260021
LOHI     DC    F'0'                     X1,Y1                           20280021
         DC    H'4095'                  UPPER LIMIT                     20300021
         DC    H'4095'                  UPPER LIMIT                     20320021
STATUS1  DC    H'0'                     BOTH PT1 AND PT2 WITHIN LIMITS  20340021
H2A02    DC    X'2A02'                                                  20360021
H0003    DC    H'0003'                                                  20380021
STATUS2  DC    X'1100'                  PT1 OFF PT2 ON                  20400021
STATUS3  DC    X'0011'                  PT1 ON PT2 OFF                  20420021
* REGISTER ASSIGN MENT                                                  20440021
VALREG   EQU   0                                                        20460021
PASREG   EQU   0                                                        20480021
WKAREG   EQU   1                                                        20500021
XYLREG   EQU   2                                                        20520021
OBPREG   EQU   2                        MUST BE IN THIS ORDER           20540021
PATREG   EQU   3                        MUST BE IN THIS ORDER           20560021
WRKREG   EQU   4                                                        20580021
EREG     EQU   4                        EVEN REGISTER                   20600021
XREG     EQU   5                        ODD  REGISTER                   20620021
CNTREG   EQU   5                                                        20640021
TEMREG   EQU   6                                                        20660021
OREG     EQU   6                        EVEN REGISTER                   20680021
YREG     EQU   7                        ODD REGISTER                    20700021
ADDREG   EQU   7                                                        20720021
INXREG   EQU   8                                                        20740021
SLOREG   EQU   8                                                        20760021
OABREG   EQU   10                                                       20780021
INTREG   EQU   11                                                       20800021
OLPREG   EQU   12                                                       20820021
CONREG   EQU   12                                                       20840021
LINREG   EQU   14                                                       20860021
* PARTAB DEFINED STORAGE MAP                                            20880021
* PATREG EQUALS A GENERAL REGISTER                                      20900021
PARTAB   DSECT                                                          20920021
XYLIM    DS    CL4                      XYLIM ADDRESS                   20940021
UTAB     DS    CL4                      UTAB  ADDRESS                   20960021
VTAB     DS    CL4                      VTAB  ADDRESS                   20980021
F        DS    CL1                      MODE OF INPUT                   21000021
S        DS    CL1                      SCALE OR NO SCALE               21020021
CSIZE    DS    CL1                      CHARACTER SIZE                  21040021
CMOD     DS    CL1                      PROTECTED OR UNPROTECTED MODE   21060021
A        DS    CL1                      RELATIVE OR ABSOLUTE            21080021
I        DS    CL1                      INCREMENT OR NO INCREMENT       21100021
PTYPE    DS    CL1                      PLOT TYPE                       21120021
SG       DS    CL1                                                      21140021
N        DS    CL2                      NUMBER OF POINTS TO PLOT        21160021
SYMBOL   DS    CL1                      LETTER TO PLOT                  21180021
E        DS    CL1                      OVERLAP OR NO OVERLAP           21200021
* XYLIM TABLE DEFINED.STORAGE MAP                                       21220021
* XYLREG EQUALS A GENERAL REGISTER                                      21240021
XYLIMTB  DSECT                                                          21260021
X1       DS    CL2                      LOWER LEFT COORDINATE VALUE     21280021
Y1       DS    CL2                      LOWER LEFT COORDINATE VALUE     21300021
X2       DS    CL2                      UPPER RIGHT COORDINATE VALUE    21320021
Y2       DS    CL2                      UPPER RIGHT COORDINATE VALUE    21340021
U1       DS    CL4                      LOWER LEFT SCALING COORDINATE   21360021
U2       DS    CL4                      LOWER LEFT SCALING COORDINATE   21380021
V1       DS    CL4                      UPPER RIGHT SCALING COORDINATE  21400021
V2       DS    CL4                      UPPER RIGHT SCALING COORDINATE  21420021
* WORK AREA DEFINED STORAGE MAP                                         21440021
* WKAREG EQUALS A GENERAL REGISTER                                      21460021
WKAREA   DSECT                                                          21480021
         DS    0D                                                       21500021
OVFSAVE  DS    0CL72                                                    21520021
TEMFLT   DS    0CL8                                                     21540021
         DS    CL72                                                     21560021
ERRCOUNT DS    CL4                      COUNT OF PARAMETER ERRORS       21580021
INCOUNT  DS    CL4                                                      21600021
         ORG   INCOUNT                                                  21620021
INDEX    DS    CL2                      TABLE INDEX OF UTAB OR VTAB     21640021
COUNT    DS    CL2                      NUMBER OF POINTS PROCESSED      21660021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    21680021
FX1      DS    CL4                      FLOAT X1                        21700021
FY1      DS    CL4                      FLOAT Y1                        21720021
FX2      DS    CL4                      FLOAT X2                        21740021
FY2      DS    CL4                      FLOAT Y2                        21760021
UA       DS    CL4                      ABSOLUTE FLOAT OR FIXED UA      21780021
VA       DS    CL4                      ABSOLUTE FLOAT OR FIXED VA      21800021
X1FINAL  DS    CL4                      X1,Y1                           21820021
         ORG   X1FINAL                                                  21840021
X1FIN    DS    CL2                      X1                              21860021
Y1FIN    DS    CL2                      Y1                              21880021
X2FINAL  DS    CL4                      X2,Y2                           21900021
         ORG   X2FINAL                                                  21920021
X2FIN    DS    CL2                      X2                              21940021
Y2FIN    DS    CL2                      Y2                              21960021
WRTADDR  DS    CL4                      ADDR OF GRID OR SCREEN CHECK RT 21980021
GOFFSGAD DS    CL4                      GOFFSG RT ADDR AREA             22000021
SWSTATUS DS    CL2                      SWITCH STATUS OF PT1 AND PT2    22020021
         ORG   SWSTATUS                                                 22040021
PT1SW    DS    CL1                      PREVIOUS STATUS                 22060021
OFFSW    DS    CL1                      CURRENT STATUS                  22080021
SKIPSW   DS    CL2                      SET TO ONE TO SKIP POINT        22100021
NC       DS    CL2                                                      22120021
NT       DS    CL2                                                      22140021
NR       DS    CL2                                                      22160021
NA       DS    CL2                                                      22180021
RSAVE    DS    CL4                      PLACE TO SAVE LINE REGISTER     22200021
SVR15    DS    CL4                      PLACE TO SAVE ERROR REGISTER    22220021
ORDER1   DS    CL1                      GRAPHICORDERS-MODE              22240021
ORDER2   DS    CL1                                                      22260021
ORDER3   DS    CL4                      PT. TO PLOT                     22280021
ORDER4   DS    CL4                                                      22300021
         ORG   ORDER4                                                   22320021
ORDER5   DS    CL2                                                      22340021
ORDER6   DS    CL1                                                      22360021
ORDER7   DS    CL1                                                      22380021
ORDER8   DS    CL2                                                      22400021
EPRGMOD  DS    CL4                                                      22420021
         ORG   EPRGMOD                                                  22440021
EOPRG    DS    CL2                      LAST PT. INDICATOR              22460021
CHARMOD  DS    CL2                      ORDER FOR CHARACTER AND MODE    22480021
PT1VEC   DS    CL4                      SIMULATED VECTOR X1,Y1          22500021
         ORG   PT1VEC                                                   22520021
PT1VE    DS    CL2                                                      22540021
PT2VE    DS    CL2                                                      22560021
PT2VEC   DS    CL4                      SIMULATED VECTOR X2,Y2          22580021
         ORG   PT2VEC                                                   22600021
PT2VECT  DS    CL2                                                      22620021
PT2VECS  DS    CL2                                                      22640021
DELTAX   DS    CL2                      DELTA X                         22660021
DELTAY   DS    CL2                      DELTA Y                         22680021
TOTAL    DS    CL4                                                      22700021
         ORG   TOTAL                                                    22720021
INTEGER  DS    CL2                      INTEGER-SIMULATED VECTOR        22740021
FRACTION DS    CL2                      FRACTION-SIMULATED VECTOR       22760021
ABVTEMP  DS    CL4                      VECTOR MODE-TEMP STORAGE        22780021
         ORG   ABVTEMP                                                  22800021
ABVMODE  DS    CL2                      VECTOR MODE INDICATOR           22820021
TEMP     DS    CL2                      TEMP STORAGE                    22840021
XYINCR   DS    CL4                      CHANGING X OR Y VALUE           22860021
PORSAVE  DS    CL28                                                     22880021
ADGOFFSG DS    CL4                      ADDRESS OF GOFFSG               22900021
SABL     DS    CL4                      ADDRESS OF BOUNDARY             22920021
UASCALE2 DS    CL4                                                      22940021
VASCALE2 DS    CL4                                                      22960021
UASCALE  DS    CL4                      ABSOLUTE FLOAT-FIX-THEN SCALE   22980021
         ORG   UASCALE                                                  23000021
UAS1     DS    CL2                                                      23020021
UAS2     DS    CL2                      FIXED HALF WORD-MAY BE SCALED   23040021
VASCALE  DS    CL4                                                      23060021
         ORG   VASCALE                                                  23080021
VAS1     DS    CL2                                                      23100021
VAS2     DS    CL2                      FIXED HALF WORD-MAY BE SCALED   23120021
NI       DS    CL4                      NUMBER OF INTERATIONS           23140021
XYINT1   DS    CL4                      FIRST INTERSECTION              23160021
XYINT2   DS    CL4                      SECOND INTERSECTION             23180021
INTWKA   DS    CL64                     INTERNAL WORKAREA               23200021
         DS    0D                                                       23220021
         DS    0D                                                       23240021
         DS    0D                                                       23260021
         ORG   OVFSAVE+396                                              23280021
GOMODE   DS    CL2                                                      23300021
         END                                                            23320021
./  ADD  SSI=20480473,NAME=IFFPEAGR
         TITLE 'GCGRID-- RECTANGULAR CARTESIAN GRID GENERATION ROUTINE' 00020021
*STATUS. CHANGE LEVEL 0                                               * 00040021
*                                                                     * 00060021
*FUNCTION/OPERATION. GCGRID GENERATES RECTANGULAR CARTESIAN GRID      * 00080021
*   PATTERNS IN LINEAR, SEMI-LOGARITHMIC OR LOGARITHMIC FORMS. THE    * 00100021
*   SEMI-LOGARITHMIC GRID PATTERN MAY BE LOGARITHMIC IN EITHER THE    * 00120021
*   HORIZONTAL OR VERTICAL DIRECTION. THE ORDERS GENERATED ARE STORED * 00140021
*   IN THE GRAPHIC DATA OUTPUT AREA (GDOA)                            * 00160021
*                                                                     * 00180021
*ENTRY POINTS. GCGRID VIA CALL OR LINK MACRO   ALIAS NAME IFFPEAGR    * 00200021
*                                                                     * 00220021
*INPUT. OUTPUT CONTROL BLOCK POINTER (OCBP) AND A PARAMETER TABLE     * 00240021
*                                                                     * 00260021
*OUTPUT. GRAPHIC ORDERS TO GENERATE A GRID STORED IN THE GDOA         * 00280021
*                                                                     * 00300021
*EXTERNAL ROUTINES. N/A                                               * 00320021
*                                                                     * 00340021
*EXITS-NORMAL. COMPLETION OF TASK. EXIT VIA RETUR MACRO               * 00360021
*     -ERROR. HEXADECIMAL 4,8,C,10, OR 18 IN REG 15                   * 00380021
*   IMMEDIATE RETURN. EXIT VIA RETURN MACRO                           * 00400021
*     -ERROR. HEXADECIMAL 28 IN REG 15   DOES NOT RETURN IMMEDIATELY  * 00420021
*   COMPLETION  OF TASK AND EXIT VIA RETURN MACRO                     * 00440021
*                                                                     * 00460021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE, XYLIM TABLE AND   * 00480021
*   WORK AREA                                                         * 00500021
*                                                                     * 00520021
*ATTRIBUTES. READ ONLY, REENTRANT                                     * 00540021
         EJECT                                                          00560021
IFFPEAGR CSECT                          GCGRID                          00580021
*0669                                                              7468 00590021
         ENTRY GCGRID                                                   00600021
GCGRID   SAVE  (14,12),T,*                                              00620021
         BALR  9,0                                                      00640021
         USING *,9                                                      00660021
         USING PARTAB,PATREG                                            00680021
         USING XYLIMT,XYLREG                                            00700021
         USING WRKAREA,WKAREG                                           00720021
         LM    OBPREG,PATREG,0(1)       LAOD ADDRESS OF OCBP, PARTAB    00740021
         L     WKAREG,4(OBPREG)         LOAD ADDRESS OF WORK AREA       00760021
         L     OABREG,0(OBPREG)         LOAD ADDRESS OF OACB            00780021
         L     XYLREG,0(PATREG)         LOAD ADDRESS OF XYLIM TABLE     00800021
*  SAVE MASK BITS AS SET BY USER                                        00820021
         ST    9,MASKSV                                                 00840021
         SR    WRKREG,WRKREG                                            00860021
         SPM   WRKREG                                                   00880021
         LM    XREG,YREG,4(PATREG)      LOAD UI VI                      00900021
         SR    15,15                    ZERO ERR CODE REG               00920021
         ST    15,64(WKAREG)                 ERR COUNT                  00940021
         BAL   LINREG,XYLCHK                                            00960021
         CLI   12(PATREG),C'F'          TEST FOR FLOAT                  00980021
         BE    FLTLEG                                                   01000021
         CLI   12(PATREG),C'B'          TEST FOR FIX POINT              01020021
         BE    TESTS                                                    01040021
         BAL   LINREG,ERR40                                             01060021
TESTS    CLI   13(PATREG),C'S'          TEST FOR SCALE                  01080021
         BE    FIXSCAL                                                  01100021
         CLI   13(PATREG),C'N'          TEST FOR NO SCALE               01120021
         BE    TESTUV                                                   01140021
         BAL   LINREG,ERR40                                             01160021
*   TEST  UI,VI   FOR  0-4095 LIMITS                                    01180021
TESTUV   C     XREG,ZERO                                                01200021
         BNH   ERR8RET                                                  01220021
         C     XREG,HIGH                                                01240021
         BH    ERR8RET                                                  01260021
         C     YREG,ZERO                                                01280021
         BNH   ERR8RET                                                  01300021
         C     YREG,HIGH                                                01320021
         BH    ERR8RET                                                  01340021
*   STORE GTYPE IN WORK AREA AND TEST FOR TYPE OF GRID                  01360021
         MVC   68(1,WKAREG),14(PATREG)  STORE GTYPE                     01380021
         CLI   68(WKAREG),C'A'          LINEAR-X,Y                      01400021
         BE    GTYPEOK                                                  01420021
         CLI   68(WKAREG),C'B'          LOG-X, LINEAR-Y                 01440021
         BE    GTYPEOK                                                  01460021
         CLI   68(WKAREG),C'C'          LINEAR-X, LOG-Y                 01480021
         BE    GTYPEOK                                                  01500021
         CLI   68(WKAREG),C'D'          LOG-X, LOG-Y                    01520021
         BE    GTYPEOK                                                  01540021
         BAL   LINREG,ERR40                                             01560021
         MVI   68(WKAREG),C'A'          SET GTYPE = A                   01580021
*   STORE  GAVM  ORDER  IN  GDOA                                        01600021
GTYPEOK  LA    CNTREG,2                 LOAD NUMBER OF BYTES            01620021
         MVC   72(2,WKAREG),GAVM        GET GAVM ORDER                  01640021
         MVC   GOMODE,GAVM                                              01660021
         BAL   LINREG,STORELNK                                          01680021
         EJECT                                                          01700021
*   SET   SX=1   SY=Y1  TY=Y2                                           01720021
         MVC   72(4,WKAREG),0(XYLREG)   SX,SY                           01740021
         MVC   78(2,WKAREG),6(XYLREG)      TY                           01760021
SETSX    MVC   76(2,WKAREG),72(WKAREG)  SX                              01780021
         BAL   LINREG,STORINIT                                          01800021
*   TEST FOR  LOG   X-AXIS                                              01820021
         CLI   68(WKAREG),C'B'          LOG-X                           01840021
         BE    LOGX                                                     01860021
         CLI   68(WKAREG),C'D'          LOG-X                           01880021
         BE    LOGX                                                     01900021
*    LINEAR      X AXIS                                                 01920021
         LH    WRKREG,76(WKAREG)        SX                              01940021
SETVALX  AR    WRKREG,XREG                +XINC                         01960021
*    COMPARE   SX+XINC  TO X2 ,IF  GREATER  GO TO  YAXIS                01980021
         CH    WRKREG,4(XYLREG)                                         02000021
         BH    YLEG                                                     02020021
         STH   WRKREG,72(WKAREG)        NEW SX                          02040021
*    OLD SY TO TY   OLD TY TO SY                                        02060021
         LH    WRKREG,78(WKAREG)        SAVE OLD TY                     02080021
         MVC   78(2,WKAREG),74(WKAREG)  OLD SY TO TY                    02100021
         STH   WRKREG,74(WKAREG)        OLD TY TO SY                    02120021
         B     SETSX                                                    02140021
*    SET  SX=X1   SY=Y1  TX=X2                                          02160021
YLEG     MVC   72(4,WKAREG),0(XYLREG)   SX SY                           02180021
         MVC   76(2,WKAREG),4(XYLREG)   TX                              02200021
SETSY    MVC   78(2,WKAREG),74(WKAREG)     SY                           02220021
         BAL   LINREG,STORINIT                                          02240021
*   TEST FOR  LOG   Y-AXIS                                              02260021
         CLI   68(WKAREG),C'C'          LOG-Y                           02280021
         BE    LOGY                                                     02300021
         CLI   68(WKAREG),C'D'          LOG-Y                           02320021
         BE    LOGY                                                     02340021
*   LINEAR      Y-AXIS                                                  02360021
         LH    WRKREG,74(WKAREG)        SY                              02380021
SETVALY  AR    WRKREG,YREG                +YINC                         02400021
*   COMPARE    SX+YINC TO Y2 ,IF GREATER  RETURN                        02420021
         CH    WRKREG,6(XYLREG)                                         02440021
         BH    RET                                                      02460021
         STH   WRKREG,74(WKAREG)        NEW SY                          02480021
*   OLD  SX TO TX   OLD TX TO  SX                                       02500021
         LH    WRKREG,76(WKAREG)        SAVE OLD TX                     02520021
         MVC   76(2,WKAREG),72(WKAREG)  OLD SX TO TX                    02540021
         NI    76(WKAREG),X'0F'         RESET BLANKING BIT              02560021
         STH   WRKREG,72(WKAREG)        OLD TX TO SX                    02580021
         B     SETSY                                                    02600021
STORINIT OI    72(WKAREG),X'40'         SET  BEAM  OFF                  02620021
         LA    CNTREG,8                                                 02640021
STORELNK STM   1,14,80(WKAREG)                                          02660021
         LA    ADDREG,72(WKAREG)                                        02680021
         BAL   LINREG,STORE                                             02700021
         LM    1,14,80(WKAREG)                                          02720021
         BR    LINREG                                                   02740021
         EJECT                                                          02760021
*   XYLCHK  SUBROUTINE                                                  02780021
*   CHECK X1,X2,Y1,Y2 LIMITS GREATER THAN 0 AND LESS THAN 4095          02800021
*   CHECK X1 LESS THAN X2 , Y1 LESS THAN Y2                             02820021
*   ADDRESSOF XYLIM TABLE IN XYLREG BEFORE BAL                          02840021
XYLCHK   LA    CNTREG,4                 SET  LOOP  COUNT                02860021
         LA    INXREG,0                 SET  INDEX                      02880021
XYLLOOP  LH    WRKREG,0(XYLREG,INXREG)  LOAD  X1,Y1,X2,Y2               02900021
         C     WRKREG,ZERO                                              02920021
         BL    ERR4RET                                                  02940021
         C     WRKREG,HIGH                                              02960021
         BH    ERR4RET                                                  02980021
         A     INXREG,TWO                                               03000021
         BCT   CNTREG,XYLLOOP                                           03020021
         CLC   0(2,XYLREG),4(XYLREG)    X1 COMP  X2                     03040021
         BNL   ERR4RET                                                  03060021
         CLC   2(2,XYLREG),6(XYLREG)    Y1 COMP  Y2                     03080021
         BNL   ERR4RET                                                  03100021
         BR    LINREG                                                   03120021
*   LOAD ERROR CODE IN REG 15                                           03140021
ERR40    LA    15,40                    PARAMETER ERROR DOES NOT RET    03160021
         B     ERRCNT                                                   03180021
ERR24RET LA    15,24                    USER OUF HAS NOT RESET OLP      03200021
         B     ERRCNTR                                                  03220021
ERR16RET LA    15,16                    U1,V1 GREATER THAN U2,V2        03240021
         B     ERRCNTR                                                  03260021
ERR12RET LA    15,12                    FLT PT ERROR DETECTED           03280021
         B     ERRCNTR                                                  03300021
ERR8RET  LA    15,8                     U,V LIMIT ERROR                 03320021
         B     ERRCNTR                                                  03340021
ERR4RET  LA    15,4                     XYLIM X1,Y1  X2,Y2 LIMIT ERROR  03360021
         B     ERRCNTR                                                  03380021
ERRCNTR  LA    LINREG,RET                                               03400021
ERRCNT   L     TEMREG,64(WKAREG)                                        03420021
         A     TEMREG,ONE                                               03440021
         ST    TEMREG,64(WKAREG)                                        03460021
         BR    LINREG                                                   03480021
*   TEST ERROR COUNT IN WORK AREA AND SET BIT                           03500021
*   IN SIGN POSITION OF REG 15 IF MULTIPLE ERRORS                       03520021
RET      LA    TEMREG,1                                                 03540021
         C     TEMREG,64(WKAREG)                                        03560021
         BL    SETBIT                                                   03580021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            03600021
RETMACRO L     WRKREG,MASKSV                                            03620021
         SPM   WRKREG                                                   03640021
         RETURN (14,12),T,RC=(15)                                       03660021
SETBIT   O     15,MZERO                                                 03680021
         B     RETMACRO                                                 03700021
         EJECT                                                          03720021
*   LOGX LOOPS 8 TIMES / LOGCYCLE                                       03740021
*   TEST IF TX GREATER THAN X2 -IF YES GO TO YAXIS                      03760021
*   LOGTABLE INDEXED BY 2 / LOOP                                        03780021
LOGX     LA    CONREG,8                 SET  LOOP CONTROL =8            03800021
         MVC   70(2,WKAREG),76(WKAREG)  SAVE SX FOR LOG CYCLE           03820021
         SR    INXREG,INXREG            SET  INDEX =0                   03840021
LOGLOOPX LA    LOGREG,LOGTBL            GET  ADDR  OF LOG TABLE         03860021
         LR    ODDREG,XREG              LOAD  XINC                      03880021
         MH    ODDREG,0(LOGREG,INXREG)            *  LOG                03900021
         SRA   ODDREG,14                ABSOLUTE  VAL                   03920021
         AH    ODDREG,70(WKAREG)                                        03940021
         CH    ODDREG,4(XYLREG)         COMPARE TO  X2  LIMIT           03960021
         BH    YLEG                                                     03980021
         STH   ODDREG,72(WKAREG)        NEW  TX                         04000021
         LH    WRKREG,78(WKAREG)        SAVE OLD TY                     04020021
         MVC   78(2,WKAREG),74(WKAREG)  OLD SY TO TY                    04040021
         STH   WRKREG,74(WKAREG)        OLD TY TO SY                    04060021
         MVC   76(2,WKAREG),72(WKAREG)  TX                              04080021
         BAL   LINREG,STORINIT                                          04100021
         A     INXREG,TWO                                               04120021
         BCT   CONREG,LOGLOOPX                                          04140021
         LH    WRKREG,70(WKAREG)        GET SX FOR NEXT LOG CYCLE       04160021
         B     SETVALX                                                  04180021
         EJECT                                                          04200021
*   LOGY LOOPS 8 TIMES / LOGCYCLE                                       04220021
*   TEST IF TY GREATER THAN Y2 -IF YES RETURN                           04240021
*   LOGTABLE INDEXED BY 2 / LOOP                                        04260021
LOGY     LA    CONREG,8                 SETLOOPCONTROL                  04280021
         MVC   70(2,WKAREG),74(WKAREG)  SAVE SY FOR LOG CYCLE           04300021
         SR    INXREG,INXREG            SET  INXDEX = 0                 04320021
LOGLOOPY LA    LOGREG,LOGTBL            GET  ADDR  OF  LOG  TABLE       04340021
         LR    ODDREG,YREG              LOAD  YINC                      04360021
         MH    ODDREG,0(LOGREG,INXREG)             *  LOG               04380021
         SRA   ODDREG,14                                                04400021
         AH    ODDREG,70(WKAREG)                                        04420021
         CH    ODDREG,6(XYLREG)         COMPARE TO Y2 LIMIT             04440021
         BH    RET                                                      04460021
         STH   ODDREG,74(WKAREG)        NEW  TY                         04480021
         LH    WRKREG,76(WKAREG)        SAVE OLD  TX                    04500021
         MVC   76(2,WKAREG),72(WKAREG)  OLD SX TO TX                    04520021
         NI    76(WKAREG),X'0F'                                         04540021
         STH   WRKREG,72(WKAREG)        OLD TX TO SX                    04560021
         MVC   78(2,WKAREG),74(WKAREG)  TY                              04580021
         BAL   LINREG,STORINIT                                          04600021
         A     INXREG,TWO                                               04620021
         BCT   CONREG,LOGLOOPY                                          04640021
         LH    WRKREG,70(WKAREG)        GET SX FOR NEXT LOG CYCLE       04660021
         B     SETVALY                                                  04680021
FLTLEG   CLI   13(PATREG),C'S'                                          04700021
         BE    SCALFLT                                                  04720021
         CLI   13(PATREG),C'N'          TEST FOR NO SCALE               04740021
         BE    FCONVERT                                                 04760021
         BAL   LINREG,ERR40                                             04780021
FCONVERT LR    VALREG,XREG              FIXCONVERT -(CONVERT FLOAT      04800021
         BAL   LINREG,FIXCONV           TO FIX)                         04820021
         LR    XREG,VALREG                                              04840021
         LR    VALREG,YREG                                              04860021
         BAL   LINREG,FIXCONV                                           04880021
         LR    YREG,VALREG                                              04900021
         B     TESTUV                                                   04920021
         EJECT                                                          04940021
*    CONVERT  FLOATING  POINT  TO  FIXED  POINT  VALUES                 04960021
*    TEST FLOATING POINT INPUT VALIDITY                                 04980021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          05000021
FIXCONV  ST    VALREG,0(WKAREG)         STORE FLT VAL IN WORKAREA       05020021
         LE    6,0(WKAREG)              LOAD VALUE TO FLOAT REG         05040021
         N     VALREG,FCHAR             CHECK  CHARACTERISTIC           05060021
         BE    FLERR1                   POSSIBLE ERROR                  05080021
FCHECOK  AU    6,X6                     ADD EXPONENT TO FLOAT REG       05100021
         STE   6,0(WKAREG)              STORE CONV IN WORKAREA          05120021
         L     VALREG,0(WKAREG)         LOAD TO GR                      05140021
         N     VALREG,XZERO             DROP CHARACTERISTIC             05160021
         LTR   VALREG,VALREG            IS VAL NEGATIVE                 05180021
         BNL   NOTNEG                                                   05200021
         N     VALREG,NSIGN             DROP SIGN                       05220021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLIMENT           05240021
NOTNEG   BR    LINREG                   RETURN TO NSI AFTER BAL         05260021
FLERR1   CE    6,ZERO                   IS VAL ZERO                     05280021
         BE    FCHECOK                                                  05300021
         B     ERR12RET                                                 05320021
SCALFLT  LA    CONREG,4                 LOOP  COUNT                     05340021
         LA    INXREG,0                 SET INDEX                       05360021
         LA    WRKREG,0                                                 05380021
FLTLOOP  LH    VALREG,0(XYLREG,INXREG)  GET X1Y1,X2Y2 VALUES            05400021
         BAL   LINREG,FLTCONV                                           05420021
         ST    VALREG,4(WKAREG,WRKREG)                                  05440021
         A     INXREG,TWO                                               05460021
         A     WRKREG,FOUR                                              05480021
         BCT   CONREG,FLTLOOP                                           05500021
*    FLOATING POINT SPECIFIED - TEST FOR CHARACTERISTIC ZERO AND        05520021
*    FRACTION NON ZERO. OF ALL U,V VALUES                               05540021
         L     VALREG,U1                                                05560021
         BAL   LINREG,FIXCONV                                           05580021
         L     VALREG,U2                                                05600021
         BAL   LINREG,FIXCONV                                           05620021
         L     VALREG,V1                                                05640021
         BAL   LINREG,FIXCONV                                           05660021
         L     VALREG,V2                                                05680021
         BAL   LINREG,FIXCONV                                           05700021
         L     VALREG,UI                                                05720021
         BAL   LINREG,FIXCONV                                           05740021
         L     VALREG,VI                                                05760021
         BAL   LINREG,FIXCONV                                           05780021
         EJECT                                                          05800021
*   SUBROUTINE TO SCALE FLOATING POINT VALUES                           05820021
*   SCALED  U,V VALUES LOADED IN XREG AND YREG                          05840021
*   (X2-X1)*UI/U2-U1   SCALED INCREMENT (XINC)                          05860021
*   (Y2-Y1)*VI/V2-V1   SCALED INCREMENT (YINC)                          05880021
FLTSCAL  LE    0,12(WKAREG)             X2                              05900021
         SE    0,4(WKAREG)              -X1                             05920021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    05940021
         ME    0,4(PATREG)              *UI                             05960021
         LE    2,12(XYLREG)             U2                              05980021
         SE    2,8(XYLREG)              -U1                             06000021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    06020021
         DER   0,2                                                      06040021
         STE   0,0(WKAREG)                                              06060021
         L     XREG,0(WKAREG)           XREG CONTAINS SCALED FP UI      06080021
         LE    0,16(WKAREG)             Y2                              06100021
         SE    0,8(WKAREG)              -Y1                             06120021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    06140021
         ME    0,8(PATREG)              *VI                             06160021
         LE    2,20(XYLREG)             V2                              06180021
         SE    2,16(XYLREG)             -V1                             06200021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    06220021
         DER   0,2                                                      06240021
         STE   0,0(WKAREG)                                              06260021
         L     YREG,0(WKAREG)           YREG CONTAINS SCALED FP         06280021
         B     FCONVERT                                                 06300021
         EJECT                                                          06320021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  VALUES                 06340021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          06360021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   06380021
         ST    VALREG,0(WKAREG)                                         06400021
         LE    0,0(WKAREG)              LOAD FLOATING PT REG            06420021
         AE    0,X6                     NORMALIZE                       06440021
         STE   0,0(WKAREG)                                              06460021
         L     VALREG,0(WKAREG)         FLOAT PT VAL IN VALREG          06480021
         BR    LINREG                                                   06500021
*   SUBROUTINE TO SCALE   FIXED  POINT  VALUES                          06520021
*   (X2-X1)*UI/U2-U1)= SCALED INCREMENT (XINC)                          06540021
*   (Y2-Y1)*VI/V2-V1)= SCALED INCREMENT (YINC)                          06560021
*   SCALED  U,V VALUES LOADED IN  XREG AND YREG  (FIXED POINT)          06580021
FIXSCAL  LH    ODDREG,4(XYLREG)         X2                              06600021
         SH    ODDREG,0(XYLREG)         -X1                             06620021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    06640021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   06660021
         MR    EVEREG,XREG              * UI                            06680021
         L     XREG,12(XYLREG)          U2                              06700021
         S     XREG,8(XYLREG)           -U1                             06720021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    06740021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   06760021
         DR    EVEREG,XREG                                              06780021
         LR    XREG,ODDREG              SCALED U VALUE IN XREG          06800021
         LH    ODDREG,6(XYLREG)         Y2                              06820021
         SH    ODDREG,2(XYLREG)         -Y1                             06840021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    06860021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   06880021
         MR    EVEREG,YREG              * VI                            06900021
         L     YREG,20(XYLREG)          V2                              06920021
         S     YREG,16(XYLREG)          -V1                             06940021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    06960021
         SR    EVEREG,EVEREG                                            06980021
         DR    EVEREG,YREG                                              07000021
         LR    YREG,ODDREG                                              07020021
         B     TESTUV                                                   07040021
         EJECT                                                          07060021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    07080021
* INPUT TO SUBROUTINE                                                   07100021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   07120021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                07140021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               07160021
*   OABREG = ADDRESS OF OACB                                            07180021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   07200021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        07220021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              07240021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 07260021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        07280021
         LA    TEMREG,4                                                 07300021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               07320021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    07340021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       07360021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       07380021
         CR    TEMREG,SLOREG                                            07400021
         BNH   OK                       ROOM FOR DATA                   07420021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    07440021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         07460021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       07480021
* ANY BYTES TO STORE                                                    07500021
         C     WRKREG,ZERO                                              07520021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           07540021
         LH    TEMREG,H2A02                                             07560021
         CH    TEMREG,GOMODE                                            07580021
         BH    STORE3A                                                  07600021
         LH    TEMREG,H0003                                             07620021
         NR    TEMREG,WRKREG                                            07640021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (EAGR)      7468 07660021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      07680021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 07700021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              07720021
* STORE REGISTERS IN WORKAREA                                           07740021
         STM   0,15,0(WKAREG)           SAVE REGISTERS IN WORKAREA      07760021
         L     15,8(0,OABREG)           OVER FLOW ADDRESS               07780021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         07800021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      07820021
         LM    0,15,0(WKAREG)           RELOAD FROM WORKAREA            07840021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    07860021
* NO SPACE AVAILABLE                                                    07880021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 07900021
         BL    STORE3                   NO                              07920021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          07940021
         B     ERR24RET                                                 07960021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 07980021
         BR    LINREG                                                   08000021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           08020021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      08040021
         BH    STORE7                   YES                             08060021
         LR    TEMREG,WRKREG                                            08080021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       08100021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               08120021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              08140021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                08160021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           08180021
         BR    INTLNK                   RETURN INTERNALLY               08200021
STORE7   LR    SLOREG,TEMREG                                            08220021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       08240021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               08260021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              08280021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            08300021
         SR    WRKREG,TEMREG           REDUCE BY 255                    08320021
         B     STORE6A                  MAKE NEXT COMPARISON            08340021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               08360021
         EJECT                                                          08380021
         CNOP  0,4                                                      08400021
LOGTBL   DC    HS14'.3010'              LOG2                            08420021
         DC    HS14'.4771'              LOG3                            08440021
         DC    HS14'.6021'              LOG4                            08460021
         DC    HS14'.6990'              LOG5                            08480021
         DC    HS14'.7782'              LOG6                            08500021
         DC    HS14'.8451'              LOG7                            08520021
         DC    HS14'.9031'              LOG8                            08540021
         DC    HS14'.9542'              LOG9                            08560021
ZERO     DC    F'0'                                                     08580021
ONE      DC    F'1'                                                     08600021
TWO      DC    F'2'                                                     08620021
HIGH     DC    F'4095'                                                  08640021
FOUR     DC    F'4'                                                     08660021
H2A02    DC    X'2A02'                                                  08680021
H0003    DC    H'0003'                                                  08700021
FCHAR    DC    X'7F000000'                                              08720021
XZERO    DC    X'80FFFFFF'                   SIGN AND VALUE -DROP EXP   08740021
X6       DC    X'46000000'                   EXPONENT OF SIX            08760021
NSIGN    DC    X'7FFFFFFF'                   DROP SIGN -RETAIN VALUE    08780021
MZERO    DC    X'80000000'                                              08800021
GAVM     DC    X'2A02'                                                  08820021
PASREG   EQU   0                                                        08840021
WKAREG   EQU   1                                                        08860021
OBPREG   EQU   2                                                        08880021
OABREG   EQU   2                                                        08900021
PATREG   EQU   3                                                        08920021
XYLREG   EQU   4                                                        08940021
XREG     EQU   5                                                        08960021
SLOREG   EQU   5                                                        08980021
YREG     EQU   6                                                        09000021
INTLNK   EQU   6                                                        09020021
WRKREG   EQU   7                                                        09040021
CNTREG   EQU   8                                                        09060021
LOGREG   EQU   8                                                        09080021
INXREG   EQU   10                                                       09100021
OLPREG   EQU   10                                                       09120021
EVEREG   EQU   10                                                       09140021
ODDREG   EQU   11                                                       09160021
VALREG   EQU   11                                                       09180021
TEMREG   EQU   11                                                       09200021
LINREG   EQU   12                                                       09220021
CONREG   EQU   14                                                       09240021
ADDREG   EQU   14                                                       09260021
         EJECT                                                          09280021
PARTAB   DSECT                                                          09300021
XYLIM    DS    CL4                                                      09320021
UI       DS    CL4                                                      09340021
VI       DS    CL4                                                      09360021
F        DS    CL1                                                      09380021
S        DS    CL1                                                      09400021
GTYPE    DS    CL1                                                      09420021
*                                                                       09440021
XYLIMT   DSECT                                                          09460021
X1       DS    CL2                                                      09480021
Y1       DS    CL2                                                      09500021
X2       DS    CL2                                                      09520021
Y2       DS    CL2                                                      09540021
U1       DS    CL4                                                      09560021
U2       DS    CL4                                                      09580021
V1       DS    CL4                                                      09600021
V2       DS    CL4                                                      09620021
*                                                                       09640021
WRKAREA  DSECT                                                          09660021
OVFSAVE  DS    CL64                     STORE SAVE AREA -OVERFLOW       09680021
PORSAVE  DS    CL64                     POR SAVE AREA                   09700021
ERRCOUNT DS    CL4                      ERROR COUNT SAVE AREA           09720021
SX1      DS    CL2                                                      09740021
SY1      DS    CL2                                                      09760021
SX2      DS    CL2                                                      09780021
         ORG   SX2                                                      09800021
TX       DS    CL2                                                      09820021
SY2      DS    CL2                                                      09840021
         ORG   SY2                                                      09860021
TY       DS    CL2                                                      09880021
WRKGTYPE DS    CL1                      GTYPE SAVE                      09900021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    09920021
         ORG   OVFSAVE+396                                              09940021
GOMODE   DS    CL2                                                      09960021
         END                                                            09980021
./  ADD  SSI=20480474,NAME=IFFPFAVA
         TITLE 'GVARC-CIRCULAR ARC GENERATION ROUTINE(WITH VECTORS)'  * 00020021
*STATUS. CHANGE LEVEL 0                                               * 00040021
*                                                                     * 00060021
*FUNCTION/OPERATION. GVARC GENERATES THE GRAPHIC ORDER AND DATA TO    * 00080021
*   DISPLAY A CIRCLE OR ARC, OR A POLYGON OR SEGMENT OF POLYGON ON    * 00100021
*   THE DISPLAY UNIT SCREEN AND STORES THEM IN THE GRAPHIC DATA OUTPUT* 00120021
*   AREA-(GDOA)                                                       * 00140021
*                                                                     * 00160021
*ENTRY POINTS.GVARC VIA CALL OR LINK MACRO  ALIAS NAME IFFPFAVA       * 00180021
*                                                                     * 00200021
*INPUT.OUTPUT CONTROL BLOCK POINTER(OCBP) AND A PARAMETER TABLE       * 00220021
*   WHICH CONTAINS PARAMETERS REQUIRED BY GVARC                       * 00240021
*                                                                     * 00260021
*OUTPUT.A GRAPHIC ORDER GEVM TO CAUSE DISPLAY UNIT ENTERING INTO      * 00280021
*   VECTOR MODE AND A SERIES OF DATA BYTES WHICH CONTAIN THE X,Y      * 00300021
*   COORDINATES OF THE END POINTS OF THE IMAGE. THE OUTPUT OF THIS    * 00320021
*   ROUTINE IS STORED IN GDOA                                         * 00340021
*                                                                     * 00360021
*EXTERNAL ROUTINES. GOFFSG ROUTINE WILL BE USED WHENEVER NEEDED       * 00380021
*                                                                     * 00400021
*EXITS-NORMAL.COMPLETION OF TASK EXIT VIA RETURN MACRO                * 00420021
*     -ERROR.HEXADECIMAL 4,12,16,20,24,28,AND 32(WHEN OFF-SCREEN ONLY)* 00440021
*   IN REG 15 RETURN IMMEDIATELY. EXIT VIA RETURN MACRO               * 00460021
*     -ERROR.HEXADECIMAL 32(WHEN NOT OFF-SCREEN),40,44,48 IN REG 15   * 00480021
*   DO NOT RETURN IMMEDIATELY. UPON COMPLETION OF TASK,RETURN VIA     * 00500021
*   RETURN MACRO                                                      * 00520021
*                                                                     * 00540021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE,XYLIM TABLE AND    * 00560021
*   WORK AREA                                                         * 00580021
*                                                                     * 00600021
*ATTRIBUTES.READ ONLY,REENTRANT                                       * 00620021
*                                                                     * 00640021
IFFPFAVA CSECT                          GVARC                           00660021
*0669                                                              7468 00670021
         ENTRY GVARC                                                    00680021
GVARC    SAVE  (14,12),T,*              SAVE REGISTERS                  00700021
         BALR  9,0                                                      00720021
         USING *,9                                                      00740021
         SR    NPAREG,NPAREG            INIT  NO.OF POINTS ATTEMPTED    00760021
*                                                                       00780021
*   INITIALIZATION                                                      00800021
*                                                                       00820021
MAINRT   L     WRKREG,0(0,1)            GET OCBP ADDRESS                00840021
         L     PATREG,4(0,1)            GET PARTAB ADDRESS              00860021
         USING PARTAB,PATREG                                            00880021
         L     WKAREG,4(0,WRKREG)       GET WORKAREA ADDRESS            00900021
         USING WKAREA,WKAREG                                            00920021
         L     OABREG,0(WRKREG)         GET OACB ADDRESS                00940021
         ST    OABREG,WOACB                                             00960021
         L     XYLREG,XYLIM             LOAD XYLIM ADDR INTO XYLREG     00980021
         USING XYLIMTB,XYLREG                                           01000021
*  SAVE MASK BITS AS SET BY USER                                        01020021
         ST    9,MASKSV                                                 01040021
         SR    WRKREG,WRKREG                                            01060021
         SPM   WRKREG                                                   01080021
         MVC   WUC,UC                   SAVE UC VC FOR WORKING          01100021
         MVC   WVC,VC                                                   01120021
         MVC   WR,RU                    SAVE RADIUS FOR WORKING         01140021
         MVC   WALPHA,ALPHA             SAVE ALPHA FOR WORKING          01160021
         MVC   GOFFSGAD,ZERO            ZERO OUT GOFFSG ADDR AREA       01180021
         SR    15,15                    CLEAR ERROR CODE REGISTER       01200021
         ST    15,ERRCOUNT              CLEAR ERROR COUNT               01220021
         BAL   LINREG,XYLCHK                                            01240021
*                                                                       01260021
*   TEST OFF S/G OPTION SPECIFIED AND DECIDE BOUNDARY TO BE OBSERVED    01280021
*                                                                       01300021
TESTSG   CLI   SG,C'A'                  IS OPTION A SPECIFIED           01320021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          01340021
         CLI   SG,C'B'                  IS OPTION B SPECIFIED           01360021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        01380021
         CLI   SG,C'C'                  IS C OPTION SPECIFIED           01400021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          01420021
         CLI   SG,C'D'                  IS D OPTION SPECIFIED           01440021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          01460021
         CLI   SG,C'E'                  IS E OPTION SPECIFIED           01480021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        01500021
         BAL   LINREG,ERR40             OTHERWISE INPUT ERROR ASSUME E  01520021
MVSCRLIM LA    WRKREG,SCRCHK            GET SCREEN CHECK RT ADDR        01540021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     01560021
         LA    WRKREG,ZERO              GET SCREEN LIMITS START ADDR    01580021
         ST    WRKREG,SABL              STORE THE ADDRESS AT SABL       01600021
         B     TESTF                                                    01620021
MVGRDLIM LA    WRKREG,GRDCK             LOAD GRID CHECK RT ADDR         01640021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     01660021
         ST    XYLREG,SABL              STORE GRID LIMITS ADDR          01680021
TESTF    CLI   F,C'F'                   TEST FOR FLOAT                  01700021
         BE    FLTRT                                                    01720021
         CLI   F,C'B'                   TEST FOR FIX                    01740021
         BE    TESTSC                                                   01760021
         BAL   LINREG,ERR40                                             01780021
TESTSC   CLI   S,C'S'                   TEST FOR SCALING                01800021
         BE    SCALFIX                                                  01820021
         CLI   S,C'N'                   TEST FOR NO SCALING             01840021
         BE    TESTIN                                                   01860021
         BAL   LINREG,ERR40                                             01880021
         B     TESTIN                                                   01900021
FLTRT    CLI   S,C'S'                   TEST FOR SCALING                01920021
         BE    SCALFLT                                                  01940021
         CLI   S,C'N'                   TEST FOR NO SCALING             01960021
         BE    FCONVERT                                                 01980021
         BAL   LINREG,ERR40                                             02000021
         B     FCONVERT                                                 02020021
*                                                                       02040021
*   TEST OTHER INPUT PARAMETERS                                         02060021
*                                                                       02080021
TESTIN   SR    NPAREG,NPAREG            INITIATE PT COUNT               02100021
         C     NPAREG,WR                COMPARE RADIUS TO ZERO          02120021
         BNL   ERR20RET       IF NEGATIVE OR ZERO SET ERROR CODE        02140021
         CH    NPAREG,THETA             COMPARE ZERO TO THETA           02160021
         BH    ERR20RET                                                 02180021
         CH    NPAREG,GAMMA                                             02200021
         BH    ERR20RET                                                 02220021
         CLI   INC,C'D'                 TEST IF INC=D                   02240021
         BE    TESTD                     IF SO TEST DENSITY FIELD       02260021
         CLI   INC,C'A'                 TEST IF INC=A                   02280021
         BE    TESTA                     IF SO TEST ALPHA FIELD         02300021
         B     ERR20RET                                                 02320021
*                                                                       02340021
*   MAIN ROUTINE                                                        02360021
*                                                                       02380021
TESTD    CH    NPAREG,DENSITY           COMPARE ZERO TO DENSITY         02400021
         BH    ERR20RET                 IF NEGTIVE GO TO SET ERRORCODE  02420021
         L     WRKREG,FOUR                                              02440021
         CH    WRKREG,DENSITY           COMPARE FOUR TO DENSITY         02460021
         BH    COMALP                   GO TO COMPUTE ALPHA AS D IS 0-3 02480021
CONVRD   L     MPCREG,C360              CONVERT DENSITY TO ALPHA        02500021
         MH    MPCREG,DENSITY           DENSITY*360                     02520021
         SRDA  MPCREG,32                                                02540021
         SLDA  MPCREG,28                                                02560021
         D     MPCREG,TWOPI                                             02580021
         SR    MPCREG,MPCREG                                            02600021
         D     MPCREG,WR                DIVIDED BY RADIUS               02620021
         SLA   MPCREG,1                 SHIFT TO DOUBLE THE REMAINDER   02640021
         C     MPCREG,WR                                                02660021
         BL    CHECK                    NO ROUNDING IF 2*REMAINDER LT R 02680021
        A     PRDREG,ONE                ROUND BY ADD ONE TO QUOTIENT    02700021
CHECK    C     PRDREG,ZERO              CHECK VALIDITY OF RESULT        02720021
         BL    ERR20RET                                                 02740021
         BE    SETALP                                                   02760021
         STH   PRDREG,WALPHA            SAVE COMPUTED ALPHA             02780021
         B     ALPRECK                                                  02800021
TESTA    CH    NPAREG,ALPHA             COMPARE ALPHA TO ZERO           02820021
         BH    ERR20RET                 IF NEGTIVE GO TO SET ERRORCODE  02840021
         BNE   ALPRECK                                                  02860021
COMALP   LA    DVDREG,345                IF YES COMPUTE ALPHA           02880021
         C     DVDREG,WR                                                02900021
         BL    SETALP                    OTHERWISE                      02920021
         SRDA  DVDREG,32(0)                                             02940021
         D     DVDREG,WR                                                02960021
         STH   QUOREG,WALPHA            SAVE COMPUTED ALPHA             02980021
ALPRECK  LH    WRKREG,WALPHA            GET ALPHA                       03000021
         C     WRKREG,C360              COMPARE ALPHA TO 360            03020021
         BH    ERR20RET                 IF OVER 360 GO TO SET ERRCODE   03040021
         B     STOEVM                                                   03060021
SETALP   L     WRKREG,ONE               SET ALPHA TO ONE                03080021
         STH   WRKREG,WALPHA            STORE ALPHA                     03100021
STOEVM   STM   2,12,PORSAVE             STORE REGISTERS                 03120021
         MVC   GOMODE,EVM                                               03140021
         LA    CNTREG,2                 PASSING BYTE NUMBER             03160021
         LA    ADDREG,EVM                       GEVM ADDRESS            03180021
         L     OABREG,WOACB             GET OACB ADDR SAVED             03200021
         BAL   LINREG,STORE                                             03220021
         LM    2,12,PORSAVE             RESTORE REGISTERS               03240021
         MVI   BMSWITCH,X'11'           SET BEAM SWITCH OFF             03260021
TESTGM   LH    DVDREG,GAMMA             SEE IF GAMMA ZERO               03280021
         CH    DVDREG,ZERO               IF YES                         03300021
         BE    ONEPT                      THIS IS ONE POINT PLOTTING    03320021
         SRDA  DVDREG,32(0)                                             03340021
         D     DVDREG,C360                COMPUTE GAMMA(MOD 360)        03360021
         C     DVDREG,ZERO              CHECK IF GAMMA(MOD 360) ZERO    03380021
         BNE   ARCRT                     IF NOT IT IS AN ARC            03400021
         L     GMREG,C360                IF YES SET GAMMI=360 (CIRCLE)  03420021
         B     PROCEED                                                  03440021
ONEPT    SR    GMREG,GMREG              GAMMI=0 IF ONE POINT            03460021
         B     PROCEED                                                  03480021
ARCRT    LR    GMREG,DVDREG             GAMMI=GAMMA(MOD 360)            03500021
PROCEED  LH    DVDREG,THETA             GET THETA                       03520021
         SRDA  DVDREG,32(0)                                             03540021
         D     DVDREG,C360              COMPUTE THET=THETA(MOD 360)     03560021
         AR    GMREG,DVDREG              GAMM=GAMMI+THET                03580021
         STH   GMREG,WGAMMA                                             03600021
         STH   DVDREG,WTHETA            SAVE INITIAL THETA              03620021
         STH   DVDREG,WDELTA            SAVE INITIAL THETA AS DELTA     03640021
DTENTRY  SRDA  DVDREG,32                                                03660021
         D     DVDREG,C90               COMPUTE THET(MOD 90)            03680021
         SLA   QUOREG,1                                                 03700021
         C     DVDREG,ZERO               IS THET=K TIMES 90             03720021
         BNE   COMPXYI                   IF NOT GO TO COMPUTE XYI       03740021
         C     QUOREG,ZERO               IF YES ASSIGN XI YI VALUES     03760021
         BNE   TESTG2                     DEPENDING ON QUADRANT         03780021
         MVC   WXI,WR                   FOR ZERO DEGREE                 03800021
         MVC   WYI,ZERO                 XI=R,YI=0                       03820021
         B     FDENTRY                  GO TO FORM DATA                 03840021
TESTG2   C     QUOREG,TWO                                               03860021
         BNE   TESTH2                                                   03880021
         MVC   WXI,ZERO                 FOR 90 DEGREE                   03900021
         MVC   WYI,WR                    XI= 0,YI=R                     03920021
         B     FDENTRY                                                  03940021
TESTH2   C     QUOREG,FOUR                                              03960021
         BNE   SETXYI                                                   03980021
         L     WRKREG,WR                FOR 180 DEGREE                  04000021
         LNR   XREG,WRKREG               XI=-R  YI=0                    04020021
         ST    XREG,WXI                 SAVE COMPUTED XI                04040021
         MVC   WYI,ZERO                  SET YI=0                       04060021
         B     FDENTRY                                                  04080021
SETXYI   MVC   WXI,ZERO                 FOR 270 DEGREE                  04100021
         L     WRKREG,WR                 XI=0 YI=-R                     04120021
         LNR   YREG,WRKREG                                              04140021
         ST    YREG,WYI                                                 04160021
         B     FDENTRY                                                  04180021
COMPXYI  C     QUOREG,ZERO              CHECK IF THET IN 1ST OR 3RD Q   04200021
         BC    8,NORMAL                  IF YES GO TO NORMAL ROUTINE    04220021
         C     QUOREG,FOUR                                              04240021
         BC    8,NORMAL                                                 04260021
         L     WRKREG,C90                                               04280021
         SR    WRKREG,DVDREG                                            04300021
         LR    DVDREG,WRKREG                                            04320021
         STH   DVDREG,WTHETA                                            04340021
NORMAL   C     DVDREG,C45               COMPARE THET TO 45              04360021
         BH    OVER45                                                   04380021
         LR    WRKREG,DVDREG            LOAD THET TO WK REG             04400021
         MH    WRKREG,PLUS4                                             04420021
         LH    XREG,TABLE+2(WRKREG)    GET  COS(THET)                   04440021
         SRDA  XREG,32                                                  04460021
         M     XREG,WR                  XI=R*COS(THET)                  04480021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04500021
         SRA   PRDREG,14                                                04520021
         MH    PRDREG,CSIGN(QUOREG)                                     04540021
         ST    PRDREG,WXI               SAVE XI                         04560021
         L     YREG,TABLE(WRKREG)                                       04580021
         SRDA  YREG,48                                                  04600021
         M     YREG,WR                  YI=R*SIN(THET)                  04620021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04640021
         SRA   PRDREG,14                                                04660021
         MH    PRDREG,SSIGN(QUOREG)                                     04680021
         ST    PRDREG,WYI               SAVE YI                         04700021
         B     FDENTRY                  GO TO FORM XY DATA              04720021
OVER45   LR    WRKREG,DVDREG            ROUTINE FOR THET OVER 45        04740021
         MH    WRKREG,MINUS4                                            04760021
         L     XREG,TABLE+360(WRKREG)                                   04780021
         SRDA  XREG,48                                                  04800021
         M     XREG,WR                  XI=R*COS(THET)                  04820021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04840021
         SRA   PRDREG,14                                                04860021
         MH    PRDREG,CSIGN(QUOREG)                                     04880021
         ST    PRDREG,WXI               SAVE XI                         04900021
         LH    YREG,TABLE+362(WRKREG)                                   04920021
         SRDA  YREG,32                                                  04940021
         M     YREG,WR                                                  04960021
         A     PRDREG,C8192            ROUND TO THE NEAREST INTEGER     04980021
         SRA   PRDREG,14                                                05000021
         MH    PRDREG,SSIGN(QUOREG)                                     05020021
         ST    PRDREG,WYI               SAVE YI                         05040021
FDENTRY  A     NPAREG,ONE                                               05060021
         L     WRKREG,WXI               COMPUTE X=XI&XC                 05080021
         A     WRKREG,WUC                                               05100021
SAVEX    ST    WRKREG,COMPUX            SAVE COMPUTED X                 05120021
         STH   WRKREG,BUILDXY           SAVE SIGNIFICANT PORTION OF X   05140021
         L     WRKREG,WYI               COMPUTE Y=YI&YC                 05160021
         A     WRKREG,WVC                                               05180021
         ST    WRKREG,COMPUY            SAVE COMPUTED Y                 05200021
         STH   WRKREG,BUILDXY+2         SAVE SIGNIFICANT PART OF Y      05220021
         CLI   BMSWITCH,X'11'           SEE IF THIS IS FIRST PT         05240021
         BE    FIRSTPT                  IF YES GO TO FIRST PT SUBRT     05260021
         MVC   PT1SW(1),OFFSW           SAVE PREVIOUS SW STATUS         05280021
         MVC   PREVPT(8),CURPT                                          05300021
         MVC   CURPT(8),COMPUX          UPDATE PT2                      05320021
         L     WRKREG,WRTADDR           GET BOUNDARY CHECK RT ADDRESS   05340021
         BALR  LINREG,WRKREG             AND BRANCH TO CHECK            05360021
         CLC   SWSTATUS,STATUS1         CHECK THE SWS STATUS IF STATUS1 05380021
         BE    FILGDOA                  BOTH PTS OK GO TO FILL GDOA     05400021
OPTIONA  CLI   SG,C'A'                  OTHERWISE OFFSG CONDITION EXIST 05420021
         BNE   OPTIONB                   CHECK USER-SPECIFIED OPTION    05440021
         BAL   LINREG,ERR44             IF A OPTION SET ERR CODE AND    05460021
         B     ANALOFF                   ANALIZE OFF STATUS TO HANDLE   05480021
OPTIONB  CLI   SG,C'B'                  IS B OPTION SPECIFIED           05500021
         BNE   OPTIONC                  IF NOT TEST FOR C               05520021
         BAL   LINREG,ERR48             IF YES SET ERR CODE AND         05540021
         B     ANALOFF                   ANALIZE OFF STATUS TO HANDLE   05560021
OPTIONC  CLI   SG,C'C'                  IS C OPTION SPECIFIED           05580021
         BNE   OPTIOND                  IF NOT TEST FOR D               05600021
         BAL   LINREG,SCRCHK            IF YES FURTHER CHECK IF THE PT  05620021
         CLI   OFFSW,X'11'               OFF SCREEN                     05640021
         BE    ERR32RET                 IFF OFF SCREEN IMMEDIATE RET    05660021
         LA    15,32                    OTHERWISE SET ERROR CODE AND    05680021
         BAL   LINREG,ERRCNT             CONTINUE THE JOB               05700021
         BAL   LINREG,GRDCK             RESTORE THE PT STATUS           05720021
         B     ANALOFF                  GO TO ANALIZE OFF STATUS        05740021
OPTIOND  CLI   SG,C'D'                  IS OPTION D SPECIFIED           05760021
         BNE   ASSUMEE                  IF NOT ASSUME OPTION E          05780021
         B     ERR28RET                 IMMEDIATE ERROR RETURN          05800021
ASSUMEE  B     ERR32RET                 IMMEDIATE ERROR RETURN          05820021
FIRSTPT  MVC   CURPT(8),COMPUX          PLACE FIRST PT AS CURRENT PT    05840021
         MVI   BMSWITCH,X'00'           RESTORE THE BEAM SW             05860021
         L     WRKREG,WRTADDR           GET BOUNDARY CHECK RT ADDR      05880021
         BALR  LINREG,WRKREG            GO TO CHECK PT VALIDITY         05900021
         CLI   OFFSW,X'11'              IS THE PT OFF BOUNDARY          05920021
         BE    FIRSTOUT                 IF SO GO TO FIRSTOUT HANDLING   05940021
         L     WRKREG,COMPUX            IF WITHIN LIMITS BLANK BEAM     05960021
         A     WRKREG,C16384                                            05980021
         STH   WRKREG,BUILDXY           PUT BLANKED X TO XY BUILDAREA   06000021
         B     FILGDOA                  BRANCH TO FILL GDOA             06020021
FIRSTOUT CLI   SG,C'A'                  IS OPTION A SPECIFIED           06040021
         BNE   CKFORB                   IF NOT GO TO CHECK FOR B        06060021
         BAL   LINREG,ERR44             IF A OPTION GO TO SET ERRORCODE 06080021
         B     CKENTRY                   AND CONTINUE THE JOB           06100021
CKFORB   CLI   SG,C'B'                  IS OPTION B SPECIFIED           06120021
         BNE   CKFORC                   IF NOT GO TO CHECK FOR C        06140021
         BAL   LINREG,ERR48             IF B SPECIFIED SET ERROR CODE   06160021
         B     CKENTRY                   AND CONTINUE THE JOB           06180021
CKFORC   CLI   SG,C'C'                  IS C OPTION SPECIFIED           06200021
         BNE   OPTIOND                  IF NOT GO TO OPTION D TEST      06220021
         BAL   LINREG,SCRCHK            IF C OPTION TEST IF OFF SCREEN  06240021
         BE    ERR32RET                 IF OFF SCREEN IMMEDIATE RETURN  06260021
         LA    15,32                    OTHERWISE SET ERROR CODE        06280021
         BAL   LINREG,ERRCNT            UPDATE ERROR COUNT              06300021
         MVI   OFFSW,X'11'              RESTORE OFF BOUNDARY STATUS     06320021
         B     CKENTRY                  CONTINUE THE JOB                06340021
ANALOFF  STM   13,0,PORSAVE             SAVE REGISTERS                  06360021
         ST    13,OVFSAVE+4             SAVE POR SAVEAREA CHAINING ADDR 06380021
         ST    15,SVR15                 SAVE ERROR REGISTER             06400021
         LA    13,OVFSAVE               LOAD GOFFSG RT SAVEAREA ADDR    06420021
         LR    WRKREG,1                 SAVE REG1-WKAREA POINTER        06440021
         CLC   GOFFSGAD,ZERO            CHECK IF GOFFSG RT ADDR AREA 0  06460021
         BNE   OFFHDLG                  IF NOT RT BROUGHT IN GO TO HDL  06480021
         LA    1,SABL                   LOAD 24-WORD PARTAB START ADDR  06500021
         LOAD  EP=GOFFSG                RETAIN THE MODULE               06520021
         LR    1,WRKREG                 RESTORE REGISTER 1              06540021
         ST    0,GOFFSGAD               SAVE GOFFSG RT ADDRESS          06560021
OFFHDLG  L     15,GOFFSGAD              LOAD GOFFSG RT ADDRESS          06580021
         LA    1,SABL                   LOAD 24-WORD PARTAB ADDR        06600021
         BALR  14,15                    BRANCH TO GOFFSG RT             06620021
         LR    1,WRKREG                 RESTORE REG 1                   06640021
LINKOUT  LM    13,0,PORSAVE             RESTORE REG 13 TO 0             06660021
         L     15,SVR15                 RESTORE ERROR REGISTER          06680021
*   ANALIZE THE RESPONSE OF GOFFSG ROUTINE AND GENERATE PROPER DATA     06700021
ANALRES  CLC   NI,ZERO                  IS NI=0                         06720021
         BE    NOINTS                   IF SO GO TO NO INTERSECT RT     06740021
         CLC   NI,ONE                   IS NI=1                         06760021
         BE    ONEINTS                  IF SO GO TO ONE INTERSECT RT    06780021
BOTHOUT  LH    WRKREG,INTS1             OTHERWISE GDV I1X,I1Y,B         06800021
         A     WRKREG,C16384             AND GDV I2X,I2Y,U              06820021
         STH   WRKREG,INTS1             STORE THE BEAM BLANKED I1X      06840021
         STM   2,12,PORSAVE             THEN SAVE REGISTERS             06860021
         LA    CNTREG,8                 LOAD BYTE NUMBER                06880021
         LA    ADDREG,INTS1             LOAD I1 I2 STARTING ADDR        06900021
         B     STOREP                   BRANCH TO STORING POINT         06920021
NOINTS   CLC   SWSTATUS,STATUS2         SEE IF PT1 OFF PT2 ON           06940021
         BE    NOINTSA                  IF SO IT'S NO INTS CONDITION A  06960021
         B     CKENTRY                  CONTINUE THE JOB                06980021
NOINTSA  LH    WRKREG,BUILDXY           GET BUILT X                     07000021
         A     WRKREG,C16384            BLANK THE BEAM BIT              07020021
         STH   WRKREG,PRIORXY           STORE TO WKAREA PRIOR TO BLDXY  07040021
         MVC   PRIORXY+2(2),BUILDXY+2   PUT Y2 IN                       07060021
LOADATA  STM   2,12,PORSAVE             SAVE REGISTERS                  07080021
         LA    CNTREG,8                 LOAD BYTE NUMBER                07100021
         LA    ADDREG,PRIORXY           GDV X2,Y2,B AND X2,Y2,U ADDR    07120021
         B     STOREP                                                   07140021
ONEINTS  CLC   SWSTATUS,STATUS2         SEE IF PT1 OFF PT2 ON           07160021
         BE    ONEINTSA                 IF SO GO TO ONE INTS CONDITIONA 07180021
         CLC   SWSTATUS,STATUS3         SEE IF PT1 ON PT2 OFF           07200021
         BE    ONEINTSB                 IF SO GO TO ONE INTS CONDITIONB 07220021
         B     BOTHOUT                                                  07240021
ONEINTSA LH    WRKREG,INTS1             GENERATE GDV I1X,I1Y,B          07260021
         A     WRKREG,C16384                                            07280021
         STH   WRKREG,PRIORXY                                           07300021
         MVC   PRIORXY+2(2),INTS1+2     IS IMMEDIATELY BEFORE BUILDXY   07320021
         B     LOADATA                  BRANCH TO LOAD DATA             07340021
ONEINTSB MVC   BUILDXY(4),INTS1         GENERATE GDV I1X,I1Y,U          07360021
FILGDOA  STM   2,12,PORSAVE                                             07380021
         LA    CNTREG,4                 LOAD BYTE NUMBER                07400021
         LA    ADDREG,BUILDXY                                           07420021
STOREP   L     OABREG,WOACB                                             07440021
         BAL   LINREG,STORE             BRANCH AND LINK TO STORE RT     07460021
         LM    2,12,PORSAVE                                             07480021
CKENTRY  LH    DELREG,WDELTA            GET DELTA                       07500021
         CH    DELREG,WGAMMA            COMPARE DELTA TO GAMMA          07520021
         BE    RET                      IF EQUAL JOB IS COMPLLETED      07540021
         AH    DELREG,WALPHA            ADD ALPHA                       07560021
         STH   DELREG,WDELTA            STORE DELTA                     07580021
         CH    DELREG,WGAMMA            COMPARE DELTA TO GAMM           07600021
         BC    12,NEWTHET                IF LE COMPUTE NEW THET         07620021
         MVC   WDELTA,WGAMMA            SET DELTA=GAMM                  07640021
         LH    DELREG,WDELTA                                            07660021
NEWTHET  LR    DVDREG,DELREG            LOAD DELT TO DIVIDEND REG       07680021
         SRDA  DVDREG,32                                                07700021
         D     DVDREG,C360              THET NOT OVER 360               07720021
         STH   DVDREG,WTHETA                                            07740021
         B     DTENTRY                                                  07760021
RET      CLC   GOFFSGAD,ZERO            WAS GOFFSG ROUTINE BROUGHT IN   07780021
         BE    RET1                                                     07800021
         ST    15,SVR15                 SAVE ERROR REGISTER             07820021
         LR    WRKREG,1                 SAVE REGISTER 1                 07840021
         DELETE EP=GOFFSG                                               07860021
         LR    1,WRKREG                 RESTORE REGISTER 1              07880021
         L     15,SVR15                 RESTORE ERROR REGISTER          07900021
RET1     LA    WRKREG,1                                                 07920021
         C     WRKREG,ERRCOUNT                                          07940021
         BL    SETBIT                                                   07960021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            07980021
RETMACRO L     WRKREG,MASKSV                                            08000021
         SPM   WRKREG                                                   08020021
         RETURN (14,12),T,RC=(15)                                       08040021
SETBIT   O     15,MZERO                                                 08060021
         B     RETMACRO                                                 08080021
*                                                                       08100021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    08120021
* INPUT TO SUBROUTINE                                                   08140021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   08160021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                08180021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               08200021
*   OABREG = ADDRESS OF OACB                                            08220021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   08240021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        08260021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              08280021
*                                                                       08300021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 08320021
*                                                                       08340021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        08360021
         LA    TEMREG,4                                                 08380021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               08400021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    08420021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       08440021
         CR    TEMREG,SLOREG                                            08460021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       08480021
         BC    12,OK                    ROOM FOR DATA                   08500021
*                                                                       08520021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    08540021
*                                                                       08560021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         08580021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       08600021
*                                                                       08620021
* ANY BYTES TO STORE                                                    08640021
*                                                                       08660021
         C     WRKREG,ZERO                                              08680021
         BC    12,STORE4                LESS OF EQUAL TO ZERO           08700021
         LH    TEMREG,H2A02                                             08720021
         CH    TEMREG,GOMODE                                            08740021
         BH    STORE3A                                                  08760021
         LH    TEMREG,H0003                                             08780021
         NR    TEMREG,WRKREG                                            08800021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (FAVA)      7468 08820021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      08840021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 08860021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              08880021
*                                                                       08900021
* STORE REGISTERS IN WORKAREA                                           08920021
*                                                                       08940021
         STM   0,15,OVFSAVE             SAVE REGISTERS                  08960021
         CLC   GOFFSGAD,ZERO            WAS GOFFSG BROUGHT IN           08980021
         BE    LAOVFLO                  IF SO GO TO OVERFLOW HDLG       09000021
         SR    WRKREG,WRKREG                                            09020021
         ST    WRKREG,GOFFSGAD          CLEAR GOFFSG ROUTINE ADDR       09040021
         LR    3,1                      SAVE REG 1.                     09060021
         DELETE EP=GOFFSG                                               09080021
         LR    1,3                      RESTORE REG 1.                  09100021
LAOVFLO  L     15,8(0,OABREG)           LOAD OVERFLOW ADDRESS           09120021
         LM    2,12,28(13)              RESET USERS REGISTERS           09140021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      09160021
         LM    0,15,OVFSAVE             RELOAD AND CONTINUE TO STORE    09180021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    09200021
*                                                                       09220021
* NO SPACE AVAILABLE                                                    09240021
*                                                                       09260021
*                                                                       09280021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 09300021
         BC    4,STORE3                 NO                              09320021
*                                                                       09340021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          09360021
*                                                                       09380021
         LA    15,24                    SET ERROR CODE                  09400021
         B     RET                      SYMBOLIC IN POR                 09420021
*                                                                       09440021
*                                                                       09460021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 09480021
         BR    LINREG                                                   09500021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           09520021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      09540021
         BC    2,STORE7                 YES                             09560021
         LR    TEMREG,WRKREG                                            09580021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       09600021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               09620021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              09640021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                09660021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           09680021
         BR    INTLNK                   RETURN INTERNALLY               09700021
STORE7   LR    SLOREG,TEMREG                                            09720021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       09740021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               09760021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              09780021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            09800021
         SR    WRKREG,TEMREG           REDUCE BY 255                    09820021
         B     STORE6A                  MAKE NEXT COMPARISON            09840021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               09860021
*                                                                       09880021
*   SUBROUTINE TO CHECK IF INPUT COORDINATES WITHIN GRID                09900021
*                                                                       09920021
GRDCK    LH    WRKREG,X1                GET X1                          09940021
         C     WRKREG,COMPUX            SEE IF COMPUTED X OUTSIDE GRID  09960021
         BH    SIGNAL                                                   09980021
         LH    WRKREG,X2                GET X2                          10000021
         C     WRKREG,COMPUX            SEE IF COMPUTED X OUTSIDE GRID  10020021
         BL    SIGNAL                                                   10040021
         LH    WRKREG,Y1                GET Y1                          10060021
         C     WRKREG,COMPUY            SEE IF COMPUTED Y OUTSIDE GRID  10080021
         BH    SIGNAL                                                   10100021
         LH    WRKREG,Y2                GET Y2                          10120021
         C     WRKREG,COMPUY            SEE IF COMPUTED Y OUTSIDE GRID  10140021
         BL    SIGNAL                                                   10160021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET SW OFF         10180021
         BR    LINREG                                                   10200021
*                                                                       10220021
*   SUBROUTINE TO CHECK IF INPUT COORDINATES WITHIN SCREEN              10240021
*                                                                       10260021
SCRCHK   L     WRKREG,COMPUX            GET COMPUTED X                  10280021
         C     WRKREG,ZERO              COMPARE TO ZERO                 10300021
         BL    SIGNAL                   IF NEGATIVE SIGNAL OFFSG        10320021
         C     WRKREG,C4095             COMPARE TO 4095                 10340021
         BH    SIGNAL                   IF HIGHER SIGNAL OFFSG          10360021
         L     WRKREG,COMPUY            GET COMPUTED Y AND              10380021
         C     WRKREG,ZERO               TEST IN THE SAME WAY           10400021
         BL    SIGNAL                                                   10420021
         C     WRKREG,C4095                                             10440021
         BH    SIGNAL                                                   10460021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET SW OFF         10480021
         BR    LINREG                                                   10500021
SIGNAL   MVI   OFFSW,X'11'              SET OFFGRID SWITCH ON           10520021
         BR    LINREG                                                   10540021
* SCALE UC VC IN FIXED POINT WITH THE FOLLOWING FORMULAS                10560021
*                                                                       10580021
*   UC=(U-U1)(X2-X1)/(U2-U1)+X1                                         10600021
*   VC=(V-V1)(Y2-Y1)/(V2-V1)+Y1                                         10620021
*                                                                       10640021
SCALFIX  STM   2,12,PORSAVE                                             10660021
FIXSCAL  LA    CNTREG,2                                                 10680021
         SR    HALREG,HALREG            INDEX REG FOR X1 THEN Y1        10700021
         SR    SCLREG,SCLREG            INDEX REG FOR UC THEN VC        10720021
         SR    INXREG,INXREG            INDEX REG FOR UI THEN VI        10740021
SCALFXV  L     DVSREG,U2(INXREG)        LOAD U2 THEN V2                 10760021
         S     DVSREG,U1(INXREG)        U2-U1 THEN V2-V1                10780021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    10800021
         L     DVDREG,UC(SCLREG)        LOAD UC THEN VC                 10820021
         S     DVDREG,U1(INXREG)        UC-U1 OR VC-V1                  10840021
         LH    WRKREG,X2(HALREG)        LOAD X2 THEN Y2                 10860021
         SH    WRKREG,X1(HALREG)        X2-X1 OR Y2-Y1                  10880021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    10900021
         SRDA  DVDREG,32                                                10920021
         MR    DVDREG,WRKREG            (UC-U1)(X2-X1)OR(VC-V1)(Y2-Y1)  10940021
         DR    DVDREG,DVSREG            DEVIDED BY U2-U1 ORV2-V1        10960021
         AH    QUOREG,X1(HALREG)        ADD X1 OR Y1                    10980021
         ST    QUOREG,WUC(SCLREG)       STORE SCALED UC VC FOR WORKING  11000021
         A     INXREG,EIGHT                                             11020021
         A     SCLREG,FOUR              INDEXING REGISTER               11040021
         A     HALREG,TWO               INDEXING REGISTER               11060021
         BCT   CNTREG,SCALFXV           LOOP TO SCALE VC                11080021
* SCALE RU USING FORMULA                                                11100021
*                                                                       11120021
*   R=RU*(X2-X1)/(U2-U1)                                                11140021
*                                                                       11160021
         L     DVSREG,U2                GET U2                          11180021
         S     DVSREG,U1                U2-U1                           11200021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    11220021
         LH    DVDREG,X2                LOAD X2                         11240021
         SH    DVDREG,X1                X2-X1                           11260021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    11280021
         SRDA  DVDREG,32                                                11300021
         M    DVDREG,RU                 RU*(X2-X1) AND                  11320021
         DR    DVDREG,DVSREG            DIVIDED BY (U2-U1)              11340021
         ST    QUOREG,WR                                                11360021
         LM    2,12,PORSAVE                                             11380021
         B     TESTIN                                                   11400021
*    CONVERT XYLIM TABLE TO FLOATING VALUES                             11420021
SCALFLT  STM   2,12,PORSAVE                                             11440021
*    FLOATING POINT SPECIFIED - TEST FOR CHARACTERISTIC ZERO AND        11460021
*    FRACTION NON ZERO. OF ALL U,V VALUES                               11480021
         L     VALREG,UC                                                11500021
         BAL   LINREG,FIXCONV                                           11520021
         L     VALREG,VC                                                11540021
         BAL   LINREG,FIXCONV                                           11560021
         L     VALREG,RU                                                11580021
         BAL   LINREG,FIXCONV                                           11600021
         L     VALREG,U1                                                11620021
         BAL   LINREG,FIXCONV                                           11640021
         L     VALREG,U2                                                11660021
         BAL   LINREG,FIXCONV                                           11680021
         L     VALREG,V1                                                11700021
         BAL   LINREG,FIXCONV                                           11720021
         L     VALREG,V2                                                11740021
         BAL   LINREG,FIXCONV                                           11760021
         LA    CNTREG,4                 SET LOOP COUNT                  11780021
         SR    HALREG,HALREG            SET HALF WORK INDEX REG         11800021
         SR    SCLREG,SCLREG            CLEAR FULL WORD INDEX REG       11820021
NEXTXY   LH    VALREG,X1(HALREG)        GET X1,Y1,X2,Y2                 11840021
         BAL   LINREG,FLTCONV           BRANCH TO CONVERT               11860021
         ST    VALREG,FX1(SCLREG)       STORE CONVERTED VALUES          11880021
         A     HALREG,TWO               INDEXING HALF WORD              11900021
         A     SCLREG,FOUR              INDEXING FULL WORD              11920021
         BCT   CNTREG,NEXTXY                                            11940021
*                                                                       11960021
*                                                                       11980021
* SCALE UC VC IN FLOATING POINT WITH THE FOLLOWING FORMULAS             12000021
*                                                                       12020021
*  UC=(UC-U1)(X2-X1)/(U2-U1)+X1                                         12040021
*  VC=(VC-V1)(Y2-Y1)/(V2-V1)+Y1                                         12060021
*                                                                       12080021
FLTSCAL  LA    CNTREG,2                                                 12100021
         SR    INXREG,INXREG                                            12120021
         SR    SCLREG,SCLREG                                            12140021
SCALFLV  LE    REG6,U1(INXREG)          LOAD U1 THEN V1                 12160021
         LE    REG4,U2(INXREG)          LOAD U2 THEN V2                 12180021
         SER   REG4,REG6                     U2-U1                      12200021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    12220021
         LE    REG0,UC(SCLREG)          LOAD UC THEN VC                 12240021
         SER   REG0,REG6                U-U1  OR V-V1                   12260021
         LE    REG6,FX1(SCLREG)         LOAD X1 OR Y1 FLT VALUE         12280021
         LE    REG2,FX2(SCLREG)         X2 OR Y2 FLOAT VALUE            12300021
         SER   REG2,REG6                (X2-X1)                         12320021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    12340021
         MER   REG0,REG2                (U-U1)(X2-X1)                   12360021
         DER   REG0,REG4                (U-U1)(X2-X1)                   12380021
         AER   REG0,REG6                                                12400021
         STE   REG0,WUC(SCLREG)         STORE UC VC SCALED VALUES       12420021
         A     INXREG,EIGHT                                             12440021
         A     SCLREG,FOUR                                              12460021
         BCT   CNTREG,SCALFLV                                           12480021
*                                                                       12500021
* SCALE RU IN FLOATING POINT WITH THE FOLLOWING FORMULAS                12520021
*                                                                       12540021
*   R=RU*(X2-X1)/(U2-U1)                                                12560021
*                                                                       12580021
         LE    REG6,U1                  LOAD U1                         12600021
         LE    REG4,U2                  LOAD U2                         12620021
         SER   REG4,REG6                U2-U1                           12640021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    12660021
         LE    REG0,RU                  GET RADIUS IN PARTAB            12680021
         LE    REG6,FX1                 LOAD X1 FLOAT VALUE             12700021
         LE    REG2,FX2                 LOAD X2 FLOAT VALUE             12720021
         SER   REG2,REG6                FX2-FX1                         12740021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    12760021
         MER   REG0,REG2                RU*(X2-X1)                      12780021
         DER   REG0,REG4                DIVIDED BY U2-U1                12800021
         STE   REG0,WR                  STORE SCALED RADIUS             12820021
         LM    2,12,PORSAVE                                             12840021
*                                                                       12860021
*    CONVERT FLOATING UC VC RU TO FIXED POINT VALUES                    12880021
FCONVERT L     VALREG,WR                LOAD RADIUS                     12900021
         BAL   LINREG,FIXCONV           FIXCONV=CONVERT FLT TO FIX      12920021
         ST    VALREG,WR                STORE THE CONVERTED RADIUS      12940021
         L     VALREG,WUC               GET UC                          12960021
         BAL   LINREG,FIXCONV                                           12980021
         ST    VALREG,WUC               STORE CONVERTED UC              13000021
         L     VALREG,WVC               GET VC                          13020021
         BAL   LINREG,FIXCONV                                           13040021
         ST    VALREG,WVC               STORE CONVERTED VC              13060021
         B     TESTIN                                                   13080021
FIXCONV  ST    1,OVFSAVE                STORE IN FIRST WORD REG. 1      13100021
         TM    OVFSAVE+3,X'07'          TEST LAST THREE BITS            13120021
         BZ    SETMODI                  NO BITS ON SET INDEX TO ZERO    13140021
         LA    TEMREG,4                 SET MODIFIER                    13160021
         B     SAVFLT                   START CONVERSION                13180021
SETMODI  LA    TEMREG,0                 SET MODIFIER TO ZERO            13200021
SAVFLT   ST    VALREG,TEMFLT(TEMREG)    SAVE FLOAT VALUE                13220021
         SR    WRKREG,WRKREG                                            13240021
         ST    WRKREG,TEMFLT+4(TEMREG)  CLEAR SECOND WORD               13260021
         LD    6,TEMFLT(TEMREG)         VALUE TO FLOAT REGISTERS        13280021
         N     VALREG,FCHAR                                             13300021
         BE    FLERR1                   CHARACTERISTIC IS ZERO          13320021
         AE    6,FLPT5                  ADD .5 TO ROUND                 13340021
         AW    6,X4E                    ADD UNNORMALIZED-RIGHT JUSTIFY  13360021
         STD   6,TEMFLT(TEMREG)         SAVE VALUES                     13380021
         L     WRKREG,TEMFLT+4(TEMREG)  CHECK SECOND WORD               13400021
         N     WRKREG,MZERO             CHECK BIT 32                    13420021
         BM    ERR12RET                 INCICATE ERROR                  13440021
         L     WRKREG,TEMFLT(TEMREG)                                    13460021
         N     WRKREG,BYTE123                                           13480021
         BM    ERR12RET                                                 13500021
         L     WRKREG,TEMFLT(TEMREG)                                    13520021
         N     WRKREG,MZERO             DROP CHARACTERISTIC             13540021
         L     VALREG,TEMFLT+4(TEMREG)  NEW FIXED VALUE                 13560021
         LTR   WRKREG,WRKREG                                            13580021
         BNL   NOTNEG                                                   13600021
         LNR   VALREG,VALREG            TWO'S COMPLEMENT                13620021
NOTNEG   BR    LINREG                                                   13640021
FLERR1   CE    6,ZERO                   IS TOTAL VALUE ZERO             13660021
         BE    NOTNEG                   RETURN                          13680021
         B     ERR12RET                 SET ERROR CODE AND RETURN       13700021
         DS    0D                                                       13720021
X4E      DC    X'4E00000000000000'                                      13740021
FLPT5    DC    E'.5'                                                    13760021
BYTE123  DC    X'00FFFFFF'                                              13780021
MZERO    DC    X'80000000'                                              13800021
FCHAR    DC    X'7F000000'                                              13820021
XZERO    DC    X'80FFFFFF'              SIGN AND VALUE -DROP EXPONENT   13840021
X6       DC    X'46000000'              EXPONENT OF SIX                 13860021
NSIGN    DC    X'7FFFFFFF'                                              13880021
*                                                                       13900021
*   CONVERT FIXED POINT TO FLOATING POINT VALUES                        13920021
*                                                                       13940021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   13960021
         ST    VALREG,OVFSAVE                                           13980021
         LE    0,OVFSAVE                LOAD TO FLOAT REG.              14000021
         AE    0,X6                     NORMALIZE                       14020021
         STE   0,OVFSAVE                                                14040021
         L     VALREG,OVFSAVE           FLOAT PT VALUE IN REG.          14060021
         BR    LINREG                                                   14080021
*    CHECK XYLIM TABLE                                                  14100021
XYLCHK   LH    XYREG1,X1                LOAD X1                         14120021
         LH    XYREG2,X2                LOAD X2                         14140021
         LA    CONREG,2                 SET LOOP CONTROL                14160021
XYLOOP   CR    XYREG1,XYREG2            COMPARE X1 TO X2                14180021
         BNL   XYLERR                                                   14200021
         C     XYREG1,ZERO              COMPARE X1 TO ZERO              14220021
         BL    XYLERR                                                   14240021
         C     XYREG1,C4095             COMPARE X1 TO 4095              14260021
         BH    XYLERR                                                   14280021
         C     XYREG2,ZERO              CHECK X2                        14300021
         BL    XYLERR                                                   14320021
         C     XYREG2,C4095                                             14340021
         BH    XYLERR                                                   14360021
         LH    XYREG1,Y1                LOAD Y1                         14380021
         LH    XYREG2,Y2                LOAD Y2                         14400021
         BCT   CONREG,XYLOOP                                            14420021
         BR    LINREG                                                   14440021
XYLERR   B     ERR4RET                                                  14460021
*INPUT INVALID- ERROR HANDLING                                          14480021
ERR4RET  LA    15,4                     XYLIM X1,Y1,X2,Y2 ERROR         14500021
         B     ERRCNTR                                                  14520021
ERR12RET LA    15,12                                                    14540021
         B     ERRCNTR                                                  14560021
ERR16RET LA    15,16                    U1 V1 GREATER THAN U2 V2        14580021
         B     ERRCNTR                                                  14600021
ERR20RET LA    15,20                    IMMEDIATE INPUT RETURN          14620021
         B     ERRCNTR                                                  14640021
ERR24RET LA    15,24                    USERS OVERFLOW                  14660021
         B     ERRCNTR                                                  14680021
ERR28RET LA    15,28                    SET ERROR CODE                  14700021
         B     ERRCNTR                                                  14720021
ERR32RET LA    15,32                                                    14740021
         B     ERRCNTR                                                  14760021
ERR40    LA    15,40                    INPUT ERROR - NOT SERIOUS       14780021
         B     ERRCNT                                                   14800021
ERR44    LA    15,44                                                    14820021
         B     ERRCNT                                                   14840021
ERR48    LA    15,48                                                    14860021
         B     ERRCNT                                                   14880021
ERRCNTR  LA    LINREG,RET                                               14900021
ERRCNT   L     TEMREG,ERRCOUNT          UPDATE ERROR COUNT              14920021
         A     TEMREG,ONE                                               14940021
         ST    TEMREG,ERRCOUNT                                          14960021
         BR    LINREG                                                   14980021
ZERO     DC    F'0'                                                     15000021
         DC    H'4095,4095'             HIGH LIMITS OF SCREEN           15020021
ONE      DC    F'1'                                                     15040021
TWO      DC    F'2'                                                     15060021
FOUR     DC    F'4'                                                     15080021
EIGHT    DC    F'8'                                                     15100021
TWOPI    DC    FS28'6.2832'             DEFINE TWOPI VALUE              15120021
EVM      DC    X'2A02'                  GEVM ORDER                      15140021
C16384   DC    F'16384'                                                 15160021
C8192    DC    F'8192'                                                  15180021
C4095    DC    F'4095'                                                  15200021
C360     DC    F'360'                                                   15220021
C90      DC    F'90'                                                    15240021
C45      DC    F'45'                                                    15260021
H2A02    DC    X'2A02'                                                  15280021
H0003    DC    H'0003'                                                  15300021
PLUS4    DC    X'0004'                                                  15320021
MINUS4   DC    X'FFFC'                                                  15340021
CSIGN    DC    X'0001FFFFFFFF0001'                                      15360021
SSIGN    DC    X'00010001FFFFFFFF'                                      15380021
TABLE    DC    HS14'0.0000,1.0000,0.0175,0.9999'                        15400021
         DC    HS14'0.0349,0.9994,0.0523,0.9986'                        15420021
         DC    HS14'0.0698,0.9976,0.0872,0.9962'                        15440021
         DC    HS14'0.1045,0.9945,0.1219,0.9925'                        15460021
         DC    HS14'0.1392,0.9903,0.1564,0.9877'                        15480021
         DC    HS14'0.1737,0.9848,0.1908,0.9816'                        15500021
         DC    HS14'0.2079,0.9782,0.2250,0.9744'                        15520021
         DC    HS14'0.2419,0.9703,0.2588,0.9659'                        15540021
         DC    HS14'0.2756,0.9613,0.2924,0.9563'                        15560021
         DC    HS14'0.3090,0.9511,0.3256,0.9455'                        15580021
         DC    HS14'0.3420,0.9397,0.3584,0.9336'                        15600021
         DC    HS14'0.3746,0.9272,0.3907,0.9205'                        15620021
         DC    HS14'0.4067,0.9136,0.4226,0.9063'                        15640021
         DC    HS14'0.4384,0.8988,0.4540,0.8910'                        15660021
         DC    HS14'0.4695,0.8830,0.4848,0.8746'                        15680021
         DC    HS14'0.5000,0.8660,0.5150,0.8572'                        15700021
         DC    HS14'0.5299,0.8481,0.5446,0.8387'                        15720021
         DC    HS14'0.5592,0.8290,0.5736,0.8192'                        15740021
         DC    HS14'0.5878,0.8090,0.6018,0.7986'                        15760021
         DC    HS14'0.6157,0.7880,0.6293,0.7772'                        15780021
         DC    HS14'0.6428,0.7660,0.6561,0.7547'                        15800021
         DC    HS14'0.6691,0.7431,0.6820,0.7314'                        15820021
         DC    HS14'0.6947,0.7193,0.7071,0.7071'                        15840021
STATUS1  DC    H'0'                     BOTH PT1 AND PT2 WITHIN LIMITS  15860021
STATUS2  DC    X'1100'                  PT1 OFF PT2 ON                  15880021
STATUS3  DC    X'0011'                  PT1 ON PT2 OFF                  15900021
REG0     EQU   0                                                        15920021
REG2     EQU   2                                                        15940021
REG4     EQU   4                                                        15960021
REG6     EQU   6                                                        15980021
HALREG   EQU   5                                                        16000021
SCLREG   EQU   6                                                        16020021
INXREG   EQU   7                                                        16040021
DVSREG   EQU   8                                                        16060021
XYREG1   EQU   7                                                        16080021
XYREG2   EQU   8                                                        16100021
VALREG   EQU   8                                                        16120021
XYLREG   EQU   14                                                       16140021
WKAREG   EQU   1                                                        16160021
DVDREG   EQU   2                                                        16180021
QUOREG   EQU   3                                                        16200021
GMREG    EQU   4                                                        16220021
DELREG   EQU   4                                                        16240021
WRKREG   EQU   4                                                        16260021
CONREG   EQU   5                                                        16280021
XREG     EQU   6                                                        16300021
YREG     EQU   6                                                        16320021
MPCREG   EQU   6                                                        16340021
PRDREG   EQU   7                                                        16360021
NPAREG   EQU   10                                                       16380021
PATREG   EQU   12                                                       16400021
PASREG   EQU   2                                                        16420021
SLOREG   EQU   3                                                        16440021
OLPREG   EQU   5                                                        16460021
TEMREG   EQU   6                                                        16480021
ADDREG   EQU   7                                                        16500021
OABREG   EQU   8                                                        16520021
CNTREG   EQU   10                                                       16540021
LINREG   EQU   11                                                       16560021
INTLNK   EQU   12                                                       16580021
WKAREA   DSECT                                                          16600021
OVFSAVE  DS    CL72                     18-WORD SAVEAREA FOR REGISTERS  16620021
         ORG   OVFSAVE                                                  16640021
TEMFLT   DS    CL8                      A  TEMPORARY SAVE AREA          16660021
         DS    CL64                                                     16680021
PORSAVE  DS    CL44                     A  REGISTER SAVE AREA           16700021
ERRCOUNT DS    CL4                      COUNT OF ERRORS                 16720021
FX1      DS    CL4                      FLOATING X1                     16740021
FY1      DS    CL4                      FLOATING Y1                     16760021
FX2      DS    CL4                      FLOATING X2                     16780021
FY2      DS    CL4                      FLOATING Y2                     16800021
WOACB    DS    CL4                      AN AREA TO SAVE OACB ADDRESS    16820021
WUC      DS    CL4                                                      16840021
WVC      DS    CL4                                                      16860021
WR       DS    CL4                                                      16880021
WTHETA   DS    CL2                                                      16900021
WALPHA   DS    CL2                                                      16920021
WGAMMA   DS    CL2                                                      16940021
WDELTA   DS    CL2                                                      16960021
WXI      DS    CL4                                                      16980021
WYI      DS    CL4                                                      17000021
PRIORXY  DS    CL4                      A 4-BYTE AREA BEFORE BUILT XY   17020021
BUILDXY  DS    CL4                      XY BUILDUP AREA                 17040021
COMPUX   DS    CL4                      COMPUTED X VALUE                17060021
COMPUY   DS    CL4                      COMPUTED Y VALUE                17080021
WRTADDR  DS    CL4                      ADDR OF GRID OR SCREEN CHECK RT 17100021
GOFFSGAD DS    CL4                      GOFFSG RT ADDR AREA             17120021
SABL     DS    CL4                      ADDR OF BOUNDARY LIMITS         17140021
PREVPT   DS    CL8                      PREVIOUS POINT                  17160021
CURPT    DS    CL8                      CURRENT POINT                   17180021
NI       DS    CL4                      NUMBER OF INTERSECTIONS         17200021
INTS1    DS    CL4                      INTERSECTION 1                  17220021
INTS2    DS    CL4                      INTERSECTION 2                  17240021
SCRATCH  DS    CL64                                                     17260021
SVR15    DS    CL4                      PLACE TO SAVE ERROR REGISTER    17280021
SWSTATUS DS    CL2                      SWITCH STATUS OF PT1 AND PT2    17300021
         ORG   SWSTATUS                                                 17320021
PT1SW    DS    CL1                      PREVIOUS STATUS                 17340021
OFFSW    DS    CL1                      CURRENT STATUS                  17360021
BMSWITCH DS    CL1                      BEAM SWITCH STATUS              17380021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    17400021
         ORG   OVFSAVE+396                                              17420021
GOMODE   DS    CL2                                                      17440021
PARTAB   DSECT                                                          17460021
XYLIM    DS    CL4                                                      17480021
UC       DS    CL4                                                      17500021
VC       DS    CL4                                                      17520021
F        DS    CL1                                                      17540021
S        DS    CL1                                                      17560021
INC      DS    CL1                                                      17580021
SG       DS    CL1                                                      17600021
RU       DS    CL4                                                      17620021
THETA    DS    CL2                                                      17640021
DENSITY  DS    CL2                                                      17660021
         ORG   DENSITY                                                  17680021
ALPHA    DS    CL2                                                      17700021
GAMMA    DS    CL2                                                      17720021
XYLIMTB  DSECT                                                          17740021
X1       DS    CL2                                                      17760021
Y1       DS    CL2                                                      17780021
X2       DS    CL2                                                      17800021
Y2       DS    CL2                                                      17820021
U1       DS    CL4                                                      17840021
U2       DS    CL4                                                      17860021
V1       DS    CL4                                                      17880021
V2       DS    CL4                                                      17900021
         END                                                            17920021
./  ADD  SSI=20480475,NAME=IFFPGAVP
         TITLE 'GSVPLT SCALE AND PLOT'                                  00020021
*STATUS. CHANGE LEVEL 0                                                 00040021
*                                                                       00060021
*FUNCTION/OPERATION. GSVPLT GENERATES THE GRAPHIC ORDERS TO DISPLAY A   00080021
*   POINT,CHARACTER,OR VECTOR PLOT.  A COMBINATION OF THE VARIOUS PLOT  00100021
*   TYPES MAY BE DISPLAYED.                                             00120021
*   THE GRAPHIC ORDERS ARE STORED IN THE GRAPHIC DATA OUTPUT AREA(GDOA) 00140021
*                                                                       00160021
*ENTRY POINTS. GSVPLT VIA CALL OR LINK MACRO   ALIAS NAME IFFPGA        00180021
*INPUT.OUTPUT CONTROL BLOCK POINTER (OCBP) AND A PARAMETER ADDRESS      00200021
*   WHICH POINTS TO A SEQUENCE OF ADDRESSES AND EBCDIC CHARACTERS IN A  00220021
*   USER PROVIDED PARAMETER TABLE                                       00240021
*                                                                       00260021
*OUTPUT. A STRING OF GRAPHIC ORDERS SUITABLE FOR PLOTTING               00280021
*EXTERNAL ROUTINES. GOFFSG-OFF SCREEN/GRID INTERSECTION ROUTINE         00300021
*                                                                       00320021
*EXITS-NORMAL. COMPLETION OF TASK EXIT VIA RETURN MACRO                 00340021
*     -ERROR. HEXADECIMAL 4,C,10,18,1C, OR 20 IN REG. 15                00360021
*  IMMEDIATE RETURN. EXIT VIA RETURN MACRO                              00380021
*     -ERROR. HEXADECIMAL 28,2C OR 30 IN REG. 15 DOES NOT RETURN        00400021
*      IMMEDIATELY-COMPLETION OF TASK AND RETURN VIA RETURN MACRO       00420021
*                                                                       00440021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE, XYLIM TABLE, UTAB,  00460021
*   VTAB VALUE TABLES AND A USER SUPPLIED WORK AREA                     00480021
*                                                                       00500021
*ATTRIBUTES. READ ONLY, REENTRANT                                       00520021
*                                                                       00540021
IFFPGAVP CSECT                          GSVPLT                          00560021
* 102700,107040-107160,172700                                    A29402 00561021
* 138060,138120,174100                                           A28795 00562021
*0669                                                              7468 00565021
* GSVPLT ROUTINE-SAVE REGISTERS-SET RETURN REGISTER AND INITIALIZE      00580021
*                                                                       00600021
         ENTRY GSVPLT                                                   00620021
GSVPLT   SAVE  (14,12),T,*              SYSTEM SAVE MACRO               00640021
         BALR  9,0                                                      00660021
         USING *,9                      BASE REGISTER                   00680021
         USING XYLIM,PATREG                                             00700021
         USING X1,XYLREG                                                00720021
         USING OVFSAVE,WKAREG                                           00740021
         SR    15,15                    CLEAR RETURN CODE               00760021
         LM    OBPREG,PATREG,0(1)       LOAD CONTROL BLOCK AND PARTAB   00780021
         L     OABREG,0(0,OBPREG)       CONTROL BLOCK ADDRESS           00800021
         L     WKAREG,4(0,OBPREG)       WORK AREA ADDRESS               00820021
*  SAVE MASK BITS AS SET BY USER                                        00840021
         ST    9,MASKSV                                                 00860021
         SR    WRKREG,WRKREG                                            00880021
         SPM   WRKREG                                                   00900021
*   CLEAR WORKAREA-TOTAL TEMPORARY STORAGE                              00920021
*                                                                       00940021
         LA    CNTREG,72                COUNT FOR WORK AREA             00960021
         SR    CONREG,CONREG            SET INDEX CONTROL               00980021
CLEARWK  ST    15,OVFSAVE(CONREG)       CLEAR WORK AREA                 01000021
         A     CONREG,FOUR              MODIFY                          01020021
         BCT   CNTREG,CLEARWK           CONTINUE                        01040021
         MVI   COUNT+1,X'01'            SET COUNT TO 1                  01060021
* CHECK INPUT PARAMETERS                                                01080021
*                                                                       01100021
         L     XYLREG,XYLIM             XYLIM ADDRESS                   01120021
         BAL   INTREG,XYLCHK            CHK X1,X2,Y1,Y2 FOR LIMITS      01140021
*                                                                       01160021
* TEST IF FLOATING PT.OR FIXED IS SPECIFIED                             01180021
*                                                                       01200021
         CLI   F,C'B'                   FIXED PARAMETER                 01220021
         BE    OV1                      YES                             01240021
         CLI   F,C'F'                   FLOAT PRAAMETER                 01260021
         BE    OV1                      YES                             01280021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01300021
OV1      CLI   S,C'S'                   SCALE                           01320021
         BE    OV2                      YES                             01340021
         CLI   S,C'N'                   NO SCALE                        01360021
         BE    OV2                      YES                             01380021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01400021
*                                                                       01420021
* TEST FOR ABSOLUTE OR RELATIVE MODE                                    01440021
*                                                                       01460021
OV2      CLI   A,C'A'                   ABSOLUTE MODE                   01480021
         BE    OV3                      YES                             01500021
         CLI   A,C'R'                   RELATIVE MODE                   01520021
         BE    OV3                      YES                             01540021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01560021
*                                                                       01580021
* TEST INCREMENT CODE                                                   01600021
*                                                                       01620021
OV3      CLI   I,C'W'                   NO-INCREMENT                    01640021
         BE    OV4                      YES                             01660021
         CLI   I,C'X'                   INCREMENT U-ONLY                01680021
         BE    OV4                      YES                             01700021
         CLI   I,C'Y'                   INCREMENT V-ONLY                01720021
         BE    OV4                      YES                             01740021
         CLI   I,C'Z'                   INCREMENT U AND V               01760021
         BE    OV4                      YES                             01780021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     01800021
*                                                                       01820021
* TEST PLOT TYPE CODE                                                   01840021
*                                                                       01860021
*                                                                       01880021
OV4      CLI   PTYPE,C'A'               POINT PLOT                      01900021
         BE    OV5                      YES                             01920021
         CLI   PTYPE,C'B'               CHARACTER PLOT                  01940021
         BE    OV5                      YES                             01960021
         CLI   PTYPE,C'C'               VECTOR PLOT                     01980021
         BE    OV5                      YES                             02000021
         CLI   PTYPE,C'D'               VECTOR AND POINT                02020021
         BE    OV5                      YES                             02040021
         CLI   PTYPE,C'E'               VECTOR AND CHARACTER            02060021
         BE    OV5                      YES                             02080021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     02100021
*                                                                       02120021
* CHECK S/G OPTIONS                                                     02140021
*                                                                       02160021
*                                                                       02180021
*   TEST OFF S/G OPTION SPECIFIED AND DECIDE BOUNDARY TO BE OBSERVED    02200021
*                                                                       02220021
OV5      CLI   SG,C'A'                  IS OPTION A SPECIFIED           02240021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          02260021
         CLI   SG,C'B'                  IS OPTION B SPECIFIED           02280021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        02300021
         CLI   SG,C'C'                  IS C OPTION SPECIFIED           02320021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          02340021
         CLI   SG,C'D'                  IS D OPTION SPECIFIED           02360021
         BE    MVGRDLIM                 IF YES USE GRID LIMITS          02380021
         CLI   SG,C'E'                  IS E OPTION SPECIFIED           02400021
         BE    MVSCRLIM                 IF YES USE SCREEN LIMITS        02420021
         BAL   LINREG,ERR40             OTHERWISE INPUT ERROR ASSUME E  02440021
MVSCRLIM LA    WRKREG,SCLCHK           GET SCREEN CHECK RT ADDRESS      02460021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     02480021
         LA    WRKREG,LOHI              SCREEN LIMITS START ADDRESS     02500021
         ST    WRKREG,SABL              STORE THE ADDRESS AT SABL       02520021
         B     OV6                                                      02540021
MVGRDLIM LA    WRKREG,GRLCHK           LOAD GRID ROUTINE CHECK ADDRESS  02560021
         ST    WRKREG,WRTADDR           STORE THE ROUTINE ADDR USED     02580021
         ST    XYLREG,SABL              STORE GRID LIMITS ADDR          02600021
OV6      CLC   N,ZERO                   N COMPARED TO ZERO              02620021
         BH    OV7                      N GREATER THAN ZERO             02640021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     02660021
* IS SYMBOL IN PARAMETER TABLE                                          02680021
*                                                                       02700021
OV7      CLI   PTYPE,C'B'               CHARACTER PLOT SPECIFIED        02720021
         BE    OV8                      YES                             02740021
         CLI   PTYPE,C'E'               VECTOR AND CHARACTER SPECIFIED  02760021
         BNE   STADD                    SKIP OVER-LAP CHECK             02780021
*                                                                       02800021
* IS CHARACTER GIVEN IN TABLE                                           02820021
*                                                                       02840021
OV8      LH    VALREG,SYMBOL            LETTER TO PLOT                  02860021
         N     VALREG,BYTE3             MASK FOR THIRD BYTE             02880021
         BC    4,CHSMOD                 LETTER PRESENT                  02900021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     02920021
*                                                                       02940021
*   SUBROUTINE TO TEST AND DEVELOPE GRAPHIC ORDER  FOR                  02960021
*   CHARACTER MODE AND SIZE                                             02980021
*   PATREG CONTAINS THE ADDRESS OF THE PARAMETER TABLE ON ENTRY         03000021
*   ORDREG CONTAINS THE GRAPHIC ORDER DEVELOPED ON RETURN               03020021
*   IF MODE OR SIZE ARE INCORRECTLY SPECIFIED, UNPROTECTED AND BASIC    03040021
*   ARE ASSUMED                                                         03060021
CHSMOD   CLI   CMOD,C'P'                PROTECTED                       03080021
         BE    PLEG                                                     03100021
         CLI   CMOD,C'F'                UNPROTECTED                     03120021
         BE    FLEG                                                     03140021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     03160021
FLEG     LH    VALREG,GFSC                                              03180021
SIZE     CLI   CSIZE,C'L'               LARGE                           03200021
         BE    SIZEL                                                    03220021
         CLI   CSIZE,C'B'               BASIC                           03240021
         BE    ORDSTO                                                   03260021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     03280021
ORDSTO   STH   VALREG,CHARMOD           ORDER-MODE-SIZE                 03300021
         B     NOCHK                    CHECK OVERLAP LETTER            03320021
SIZEL    A     VALREG,ONE               MODIFY ORDER TO LARGE           03340021
         B     ORDSTO                                                   03360021
PLEG     LH    VALREG,GFPC                                              03380021
         B     SIZE                                                     03400021
GFSC     DC    X'2A40'                                                  03420021
GFPC     DC    X'2A44'                                                  03440021
*                                                                       03460021
* CHECK OVERLAP LETTERS                                                 03480021
NOCHK    CLI   E,C'O'                   OVERLAP LETTER PRESENT          03500021
         BE    STADD                    YES                             03520021
         CLI   E,C'N'                   NO-OVERLAP-WANTED               03540021
         BE    STADD                    YES                             03560021
         BAL   LINREG,ERR40             SET ERROR CODE-COUNT ERRORS     03580021
*                                                                       03600021
* STORE VALUES FROM UTAB AND VTAB IN WORKAREA-SCALED VALUES AFTER SCALE 03620021
*                                                                       03640021
STADD    L     WRKREG,UTAB              UTAB ADDRESS                    03660021
         L     VALREG,0(0,WRKREG)       FIRST VALUE                     03680021
         ST    VALREG,UA                ABSOLUTE UA                     03700021
         ST    VALREG,UASCALE           ABSOLUTE-MAY BE SCALED          03720021
         STH   VALREG,X2FIN             MAY BE FINAL FIXED VALUE        03740021
         L     WRKREG,VTAB              VTAB ADDRESS                    03760021
         L     VALREG,0(0,WRKREG)       FIRST VALUE                     03780021
         ST    VALREG,VA                ABSOLUTE VA                     03800021
         ST    VALREG,VASCALE           ABSOLUTE-MAY BE SCALED          03820021
         STH   VALREG,Y2FIN             MAY BE FINAL FIXED VALUE        03840021
*                                                                       03860021
* IS FLOATING SPECIFIED                                                 03880021
*                                                                       03900021
         CLI   F,C'F'                   FLOATING PT. SPECIFIED          03920021
         BNE   NOFLOAT                  INDICATES FIXED OR NO PARAMETER 03940021
*                                                                       03960021
* IS SCALING SPECIFIED                                                  03980021
*                                                                       04000021
         CLI   S,C'S'                   SCALING SPECIFIED               04020021
         BNE   NOSCALE1                 INDICATES NO SCALE-CONVERT TO   04040021
*                                       FIXED PT. UA VALUES             04060021
*                                                                       04080021
* SET UP VALUES TO CONVERT XYLIM TABLE TO FLOATING POINT VALUES         04100021
*                                                                       04120021
         LA    CONREG,4                 DO FOUR VALUES                  04140021
         SR    INXREG,INXREG            CLEAR CONTROL MODIFICATION      04160021
         SR    CNTREG,CNTREG            CLEAR CONTROL MODIFICATION      04180021
NEXTXY   LH    VALREG,X1(INXREG)        GET X1,Y1,X2,Y2 VALUES          04200021
         BAL   LINREG,FLTCONV           CONVERT FIXED VALUE TO FLOAT PT 04220021
         ST    VALREG,FX1(CNTREG)       STORE IN WORKAREA               04240021
         A     INXREG,TWO               MODIFY BY TWO BYTES             04260021
         A     CNTREG,FOUR              MODIFY BY FOUR BYTES            04280021
         BCT   CONREG,NEXTXY                                            04300021
*                                                                       04320021
* FLOATING POINT SCALE-SUBROUTINE                                       04340021
* EQUATION XS=(UA-U1)*(X2-X1)/(U2-U1)+X1                                04360021
* EQUATION YS=(VA-V1)*(Y2-Y1)/(V2-V1)+Y1                                04380021
*                                                                       04400021
FLTSCAL  LA    CNTREG,2                 SET CONTROL                     04420021
         SR    CONREG,CONREG            CLEAR MODIFIER                  04440021
         SR    INXREG,INXREG            CLEAR MODIFIER                  04460021
FLTSCAL1 LE    6,U1(CONREG)             U1 THEN V1                      04480021
         LE    4,U2(CONREG)             U2 THEN V2                      04500021
         SER   4,6                      U2-U1 THEN V2-V1                04520021
         BC    13,ERR16RET         MINUS OR ZERO                        04540021
* LOAD FLOATING PT VALUE FROM WORKAREA                                  04560021
         LE    0,UA(INXREG)             UA-STORED THRU UN               04580021
         SER   0,6                      UA-U1 VARIABLE RESULT           04600021
         LE    6,FX1(INXREG)            X1 OR Y1 CONVERTED VALUE        04620021
         LE    2,FX2(INXREG)            X2 OR Y2 CONVERTED VALUE        04640021
         SER   2,6                                                      04660021
         MER   0,2                      UA-U1*X2-X1 OR VA-V1*Y2-Y1      04680021
         DER   0,4                      /U2-U1 OR V2-V1                 04700021
         AER   0,6                      +X1 OR Y1                       04720021
         STE   0,UASCALE(INXREG)        X OR Y SCALED VALUE             04740021
         A     CONREG,EIGHT             MODIFY FOR V1-V2                04760021
         A     INXREG,FOUR                                              04780021
         BCT   CNTREG,FLTSCAL1                                          04800021
*                                                                       04820021
* SCALE WAS SPECIFIED OR NO SCALE IS REQUIRED-CONVERT DATA TO FIXED PT. 04840021
*                                                                       04860021
*                                                                       04880021
NOSCALE1 LA    CONREG,2                 SET CONTROL                     04900021
         SR    CNTREG,CNTREG            CLEAR INDEX VALUE               04920021
         SR    INXREG,INXREG                                            04940021
NEXTSCAL L     VALREG,UASCALE(INXREG)   LOAD SCALED OR UNSCALED VALUE   04960021
         BAL   INTREG,FIXCONV           CONVERT TO FIXED PT.            04980021
         ST    VALREG,UASCALE(INXREG)   CONVERTED FIXED VALUE           05000021
         STH   VALREG,X2FIN(CNTREG)     FINAL VALUE                     05020021
         A     CNTREG,TWO               MODIFY                          05040021
         A     INXREG,FOUR                                              05060021
         BCT   CONREG,NEXTSCAL                                          05080021
         B     CHKCNT                                                   05100021
*                                                                       05120021
* FLOATING PT IS NOT SPECIFIED                                          05140021
* IS SCALING SPECIFIED                                                  05160021
*                                                                       05180021
*                                                                       05200021
*                                                                       05220021
* STORE  X1,Y1,X2,Y2 IN WORK AREA                                       05240021
NOFLOAT  LA    CONREG,4                                                 05260021
         SR    INXREG,INXREG                                            05280021
         SR    CNTREG,CNTREG                                            05300021
NEXXY    LH    VALREG,X1(INXREG)        X1,Y1,X2,Y2                     05320021
         ST    VALREG,FX1(CNTREG)       X1,Y1,X2,Y2 IN WORKAREA         05340021
         A     INXREG,TWO                                               05360021
         A     CNTREG,FOUR                                              05380021
         BCT   CONREG,NEXXY                                             05400021
*                                                                       05420021
         CLI   S,C'S'                   IS SCALE INDICATED              05440021
         BNE   CHKCNT                   INDICATES NO SCALE              05460021
* DATA MUST BE SCALED IN FIXED PT.                                      05480021
*                                                                       05500021
FIXSCAL  LA    INTREG,2                 SET INTERNAL CONTROL            05520021
         SR    CONREG,CONREG            CLEAR MODIFIER                  05540021
         SR    INXREG,INXREG            CLEAR MODIFIER                  05560021
FIXSCAL1 L     VALREG,U1(CONREG)        U1 THEN V1                      05580021
         L     TEMREG,U2(CONREG)        U2 THEN V2                      05600021
         SR    TEMREG,VALREG            U2-U1                           05620021
         BC    13,ERR16RET         MINUS OR ZERO                        05640021
         L     XREG,UA(INXREG)          UA                              05660021
         SR    XREG,VALREG              UA-U1  VARIABLE RESULT          05680021
         L     YREG,FX1(INXREG)         X1 OR Y1                        05700021
         L     VALREG,FX2(INXREG)       X2 OR Y2                        05720021
         SR    VALREG,YREG              X2-X1                           05740021
         SR    EREG,EREG                CLEAR MULTIPLICAND              05760021
         MR    EREG,VALREG              UA-U1*X2-X1                     05780021
         DR    EREG,TEMREG                                              05800021
         AR    XREG,YREG                                                05820021
         ST    XREG,UASCALE(INXREG)     X OR Y SCALED                   05840021
         A     CONREG,EIGHT                                             05860021
         A     INXREG,FOUR                                              05880021
         BCT   INTREG,FIXSCAL1                                          05900021
         LH    VALREG,UAS2              X                               05920021
         STH   VALREG,X2FIN             SCALED VALUE OF X               05940021
         LH    VALREG,VAS2              Y                               05960021
         STH   VALREG,Y2FIN             SCALED VALUE OF Y               05980021
*                                                                       06000021
*CHECK COUNT-IS IT EQUAL TO TWO OR MORE                                 06020021
*                                                                       06040021
CHKCNT   CLC   COUNT,TWO+2              COMPARE COUNT TO TWO            06060021
         BNL   SECOND                   YES                             06080021
         L     WRKREG,WRTADDR           CHECK FOR GRID IF APPLIES       06100021
         BALR  LINREG,WRKREG                                            06120021
         CLC   N,ONE+2                 FOR ONLY ONE POINT               06140021
         BE    ONEPT                   HANDLE IT IN POINT MODE          06160021
         LA    CNTREG,2                                                 06180021
         LA    ADDREG,ORDER1                                            06200021
         CLI   PTYPE,C'B'                                               06220021
         BNH   PTMODE                   MODE INITIALIZE GDOA FOR PTONLY 06240021
*                                       GENERATE                        06260021
         MVI   ORDER1,X'2A'             ORDER FOR VECTOR PLOTTING       06280021
         MVI   ORDER2,X'02'                                             06300021
         MVC   GOMODE,ORDER1                                            06320021
         BAL   LINREG,STORE             GIVE TO STORE ROUTINE           06340021
         B     SECOND                                                   06360021
PTMODE   MVI   ORDER1,X'2A'             ORDER FOR POINT PLOTTING        06380021
         MVI   ORDER2,X'00'             GENERATED GIVE                  06400021
         MVC   GOMODE,ORDER1                                            06420021
         BAL   LINREG,STORE             TO STORE ROUTINE                06440021
         B     SECOND                                                   06460021
*                                                                       06480021
* IS N VALUE EQUAL TO OR LESS THAN 1                                    06500021
*                                                                       06520021
*                                                                       06540021
*                                                                       06560021
* WAS PT. OFF SCREEN-ONLY 1 POINT ESTABLISHED                           06580021
*                                                                       06600021
ONEPT    BAL   LINREG,SCLCHK            DISCONTINUE IF ONLY ONE         06620021
         CLC   SWSTATUS,STATUS1         POINT AND IT IS OFF SCREEN      06640021
         BNE   ERR32RET                                                 06660021
*                                                                       06680021
* PT ON SCREEN- SET UP ORDER FOR A PT.                                  06700021
*                                                                       06720021
         MVI   ORDER1,X'2A'             PT PLOT MODE                    06740021
         MVI   ORDER2,X'00'                                             06760021
         MVC   GOMODE,ORDER1                                            06780021
         MVC   ORDER3,X2FINAL           X AND Y FOR A POINT             06800021
         LA    CNTREG,6                 MOVE SIX BYTES                  06820021
         LA    ADDREG,ORDER1            ADDRESS OF DATA                 06840021
         BAL   LINREG,STORE             STORE GRAPHIC DATA IN GDOA      06860021
         B     RET                      RETURN TO USER                  06880021
*                                                                       06900021
* IS COUNT EQUAL TO N                                                   06920021
*                                                                       06940021
NOT1     CLC   N,COUNT                  COMPARE N TO COUNT              06960021
         BE    RET                      END OF PROGRAM                  06980021
* UPDATE COUNT FOR NEXT POINT                                           07000021
         LH    CNTREG,COUNT             COUNT                           07020021
         A     CNTREG,ONE               UPDATE COUNT                    07040021
         STH   CNTREG,COUNT             SAVE COUNT                      07060021
*                                                                       07080021
         L     VALREG,ZERO              CLEAR SKIPSW                    07100021
         STH   VALREG,SKIPSW                                            07120021
         MVC   PT1SW,OFFSW              UPDATE SCREEN GRID SWITCH       07140021
* SAVE THE PREVIOUS CALCULATED VALUE                                    07160021
         L     VALREG,UASCALE           X VALUE MAXIMUM SIZE            07180021
         ST    VALREG,UASCALE2          PT1-X-VALUE                     07200021
         L     VALREG,VASCALE           Y VALUE MAXIMUM SIZE            07220021
         ST    VALREG,VASCALE2          PT1-Y-VALUE                     07240021
         L     VALREG,X2FINAL                                           07260021
         ST    VALREG,X1FINAL                                           07280021
*                                                                       07300021
         SR    CONREG,CONREG            CLEAR MODIFIER                  07320021
         LA    CNTREG,2                 SET LOOP CONTROL                07340021
* THIS ROUTINE GET U-AND V TABLE VALUES                                 07360021
*                                                                       07380021
* GET NEXT VALUE FROM TABLE-UTAB                                        07400021
*                                                                       07420021
INCU     LH    INXREG,INDEX             TABLE INDEX VALUE               07440021
         L     WRKREG,UTAB              UTAB ADDRESS                    07460021
         CLI   I,C'X'                   U ARRAY INCREMENTAL             07480021
         BE    UINCR                    YES                             07500021
         CLI   I,C'Z'                   U AND V ARRAY INCREMENTAL       07520021
         BE    UINCR                    YES-BOTH U AND V ARE INCREMENT  07540021
FLCHK    CLI   F,C'F'                   FLOATING PT.                    07560021
         BE    FLRCHK                   YES-IS IT RELATIVE              07580021
FIXVAL   L     VALREG,4(INXREG,WRKREG)  NO -BINARY OR ASSUMED BINARY    07600021
         CLI   A,C'R'                   RELATIVE                        07620021
         BNE   USTORE                   NOT RELATIVE-STORE INDEXED VAL. 07640021
         B     USTORA                   RELATIVE-ADD PREVIOUS VALUE     07660021
UINCR    CLI   F,C'F'                   FLOATING PT.                    07680021
         BE    FLOATAD                  FLOAT SPECIFIED                 07700021
         L     VALREG,4(0,WRKREG)       FIXED INCREMENT VALUE-NOT INDEX 07720021
USTORA   A     VALREG,UA(CONREG)        ADD PREVIOUS ABS. VALUE         07740021
USTORE   ST    VALREG,UA(CONREG)        NEXT ABS. VALUE                 07760021
         ST    VALREG,UASCALE(CONREG)   NEW X OR Y VALUE                07780021
         B     INCV                     GET THE V VALUE                 07800021
*                                                                       07820021
* FLOATING PT NUMBERS SPECIFIED                                         07840021
*                                                                       07860021
FLRCHK   LE    0,4(INXREG,WRKREG)       NEXT FLOATING VALUE-INDEXED     07880021
         CLI   A,C'R'                   IS FLOAT RELATIVE               07900021
         BNE   STORFL                   NO REPLACE VALUE                07920021
         B     STORAF                   YES                             07940021
FLOATAD  LE    0,4(0,WRKREG)            FLOAT INCREMENT-NOT INDEXED     07960021
STORAF   AE    0,UA(CONREG)             FLOAT ADD ABS. VALUE            07980021
STORFL   STE   0,UA(CONREG)             NEW VALUE X OR Y                08000021
         STE   0,UASCALE(CONREG)        NEW X OR Y VALUE                08020021
*                                                                       08040021
* SET UP V TABLE AND MAKE CHECKS                                        08060021
*                                                                       08080021
INCV     BCT   CNTREG,DOV               DO V TABLE                      08100021
         B     OUT                                                      08120021
DOV      LA    CONREG,4                 SET MODIFIER                    08140021
         L     WRKREG,VTAB              VTAB ADDRESS                    08160021
         CLI   I,C'Y'                   V INCREMENTAL                   08180021
         BE    UINCR                    YES                             08200021
         CLI   I,C'Z'                   V AND U INCREMENTAL             08220021
         BE    UINCR                    YES                             08240021
         B     FLCHK                    NO                              08260021
*                                                                       08280021
* BOTH TABLE VALUES STORED-UPDATE INDEX                                 08300021
*                                                                       08320021
OUT      A     INXREG,FOUR              UPDATE INDEX VALUE              08340021
         STH   INXREG,INDEX             SAVE TABLE INDEX VALUE          08360021
         CLI   F,C'F'                                                   08380021
         BE    CHKSCA                   YES                             08400021
         CLI   S,C'S'                                                   08420021
         BE    FIXSCAL                  YES-SCALE NEW VALUES            08440021
* STORE FIXED UNSCALED VALUES FOR NEXT PT VALUE                         08460021
STOXY    L     VALREG,UA                                                08480021
         STH   VALREG,X2FIN             X2 UNSCALED FIXED VALUE         08500021
         L     VALREG,VA                                                08520021
         STH   VALREG,Y2FIN             Y2 UNSCALED FIXED VALUE         08540021
         B     CHKCNT                   NO                              08560021
CHKSCA   CLI   S,C'S'                   SCALING SPECIFIED               08580021
         BE    FLTSCAL                  YES                             08600021
         B     NOSCALE1                 NO                              08620021
SECOND   BAL   LINREG,SCRNGRD                                           08640021
         CLC   SKIPSW,ONE+2             SKIP PLOTTING IF REQUIRED       08660021
         BE    NOT1                                                     08680021
         CLI   PTYPE,C'B'               FOR CHARACTER MODE              08700021
         BE    BEAMOFF                  POSITION BEAM OFF               08720021
         CLI   PTYPE,C'A'               FOR POINT MODE                  08740021
         BE    BEAMON                   POSITION BEAM ON                08760021
         CLC   COUNT,ONE+2              FOR OTHER THAN                  08780021
         BH    BEAMON                   FIRST POINT,POSITION BEAM ON    08800021
BEAMOFF  MVC   ORDER3,X2FINAL           OTHERWISE INSERT                08820021
         OI    ORDER3,X'40'             BLANK BEAM BIT IN               08840021
         LA    CNTREG,4                 ORDER AND                       08860021
         LA    ADDREG,ORDER3                                            08880021
         BAL   LINREG,STORE             STORE                           08900021
         B     FLOW2                    BACK TO NORMAL FLOW             08920021
BEAMON   MVC   ORDER3,X2FINAL           POSITION AT                     08940021
         LA    ADDREG,ORDER3                                            08960021
         LA    CNTREG,4                 PT2,BEAM ON                     08980021
         BAL   LINREG,STORE             STORE                           09000021
FLOW2    CLI   PTYPE,C'B'               IF CHARACTER                    09020021
         BE    CHAR                     MODE OR                         09040021
         CLI   PTYPE,C'E'               VECTOR AND CHARACTER            09060021
         BE    CHAR                     PLOT CHARACTER                  09080021
         CLI   PTYPE,C'D'               IF NOT POINT-VECTOR MODE        09100021
         BNE   NOT1                     GO TO UPDATE THE COUNTER        09120021
         LA    CNTREG,4                 OTHERWISE REPEAT ORDER TO       09140021
         LA    ADDREG,ORDER3                                            09160021
         BAL   LINREG,STORE             STORE TO INTENSIFY END POINT    09180021
         B     NOT1                     GO TO UPDATE THE COUNTER        09200021
CHAR     BAL   LINREG,PLTCH             GO PLOT A CHARACTER             09220021
         BAL   LINREG,STORE             STORE GRAPHIC ORDERS IN GDOA    09240021
         CLI   PTYPE,C'E'               IF NOT VECTOR CHARACTER MODE    09260021
         BNE   REPTM                    REPEAT ENTER POINT MODE         09280021
         MVI   ORDER1,X'2A'             OTHERWISE REENTER VECTOR MODE   09300021
         MVI   ORDER2,X'02'                                             09320021
         MVC   GOMODE,ORDER1                                            09340021
         OI    ORDER3,X'40'             TURN BEAM OFF                   09360021
         LA    CNTREG,6                 AND REPEAT ORDER                09380021
         LA    ADDREG,ORDER1                                            09400021
         BAL   LINREG,STORE             TO STORE OF CURRENT POSITION    09420021
         B     NOT1                     GET NEXT VALUES                 09440021
REPTM    LA    CNTREG,2                                                 09460021
         LA    ADDREG,ORDER1                                            09480021
         MVI   ORDER1,X'2A'             ORDER FOR POINT PLOTTING        09500021
         MVI   ORDER2,X'00'                                             09520021
         MVC   GOMODE,ORDER1                                            09540021
         BAL   LINREG,STORE             TO STORE ROUTINE                09560021
         B     NOT1                     UPDATE THE COUNTER              09580021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    09600021
* INPUT TO SUBROUTINE                                                   09620021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   09640021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                09660021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               09680021
*   OABREG = ADDRESS OF OACB                                            09700021
STORE    STM   8,12,PORSAVE             SAVE REGISTERS                  09720021
         SR    PASREG,PASREG            CLEAR OVERFLOW INDICATOR        09740021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        09760021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              09780021
*                                                                       09800021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 09820021
*                                                                       09840021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        09860021
         LA    TEMREG,4                                                 09880021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               09900021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    09920021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       09940021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       09960021
         CR    TEMREG,SLOREG                                            09980021
         BNH   OK                                                       10000021
*                                                                       10020021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    10040021
*                                                                       10060021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         10080021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       10100021
*                                                                       10120021
* ANY BYTES TO STORE                                                    10140021
*                                                                       10160021
         C     WRKREG,ZERO                                              10180021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           10200021
         LH    TEMREG,H2A02                                             10220021
         CH    TEMREG,GOMODE                                            10240021
         BH    STORE3B                                           A29402 10270021
         LH    TEMREG,H0003                                             10280021
         NR    TEMREG,WRKREG                                            10300021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (GAVP)      7468 10320021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      10340021
         BAL   INTREG,STORE6            LINK INTERNALLY                 10360021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              10380021
*                                                                       10400021
* STORE REGISTERS IN WORKAREA                                           10420021
*                                                                       10440021
         STM   0,15,OVFSAVE             OVERFLOW SAVE IN WORKAREA       10460021
         CLC   GOFFSGAD,ZERO           WAS OFF SCREEN/GRID LOADED  5800 10480021
         BE    LAOVFLO                  NO                              10500021
         SR    WRKREG,WRKREG                                            10520021
         ST    WRKREG,GOFFSGAD         CLEAR ADDRESS               5800 10540021
         LR    3,1                      SAVE REG 1.                     10560021
         DELETE EP=GOFFSG                                               10580021
         LR    1,3                      RESTORE REG 1.                  10600021
LAOVFLO  L     15,8(0,OABREG)           LOAD OVERFLOW ADDRESS           10620021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         10640021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      10660021
         LM    0,15,OVFSAVE             RELOAD AND CONTINUE TO STORE    10680021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    10700021
STORE3B  C     WRKREG,FOUR             ROOM FOR FOUR BYTES ?     A29402 10704021
         BNL   STORE3A                 YES-STORE X,Y PAIR        A29402 10708021
         MVC   0(2,OLPREG),H2A80       NO-NOP TWO BYTES          A29402 10712021
         B     STORE3                  GO TO USER OVRFLOW        A29402 10716021
*                                                                       10720021
* NO SPACE AVAILABLE                                                    10740021
*                                                                       10760021
*                                                                       10780021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 10800021
         BL    STORE3                                                   10820021
*                                                                       10840021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          10860021
*                                                                       10880021
         B     ERR24RET                                                 10900021
*                                                                       10920021
*                                                                       10940021
OK       BAL   INTREG,STORE6            LINK INTERNALLY                 10960021
         LM    8,12,PORSAVE            RELOAD REGISTERS                 10980021
         BR    LINREG                                                   11000021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           11020021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      11040021
         BH    STORE7                                                   11060021
         LR    TEMREG,WRKREG                                            11080021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       11100021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               11120021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              11140021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                11160021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           11180021
         BR    INTREG                   RETURN INTERNALLY               11200021
STORE7   LR    SLOREG,TEMREG                                            11220021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       11240021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               11260021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              11280021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            11300021
         SR    WRKREG,TEMREG           REDUCE BY 255                    11320021
         B     STORE6A                  MAKE NEXT COMPARISON            11340021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               11360021
*                                                                       11380021
*    CONVERT  FLOATING  POINT  TO  FIXED  POINT  VALUES                 11400021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          11420021
*                                                                       11440021
FIXCONV  ST    1,OVFSAVE                STORE IN FIRST WORD REG. 1      11460021
         TM    OVFSAVE+3,X'07'          TEST LAST THREE BITS            11480021
         BZ    SETMODI                  NO BITS ON SET INDEX TO ZERO    11500021
         LA    TEMREG,4                 SET MODIFIER                    11520021
         B     SAVFLT                   START CONVERSION                11540021
SETMODI  LA    TEMREG,0                 SET MODIFIER TO ZERO            11560021
SAVFLT   ST    VALREG,TEMFLT(TEMREG)    SAVE FLOAT VALUE                11580021
         SR    WRKREG,WRKREG                                            11600021
         ST    WRKREG,TEMFLT+4(TEMREG)  CLEAR SECOND WORD               11620021
         LD    6,TEMFLT(TEMREG)         VALUE TO FLOAT REGISTERS        11640021
         N     VALREG,FCHAR                                             11660021
         BE    FLERR1                   CHARACTERISTIC IS ZERO          11680021
         AE    6,FLPT5                  ADD .5 TO ROUND                 11700021
         AW    6,X4E                    ADD UNNORMALIZED-RIGHT JUSTIFY  11720021
         STD   6,TEMFLT(TEMREG)         SAVE VALUES                     11740021
         L     WRKREG,TEMFLT+4(TEMREG)  CHECK SECOND WORD               11760021
         N     WRKREG,MZERO             CHECK BIT 32                    11780021
         BM    ERR12RET                 INDICATE ERROR                  11800021
         L     WRKREG,TEMFLT(TEMREG)                                    11820021
         N     WRKREG,BYTE123                                           11840021
         BM    ERR12RET                                                 11860021
         L     WRKREG,TEMFLT(TEMREG)                                    11880021
         N     WRKREG,MZERO             DROP CHARACTERISTIC             11900021
         L     VALREG,TEMFLT+4(TEMREG)  NEW FIXED VALUE                 11920021
         LTR   WRKREG,WRKREG                                            11940021
         BNL   NOTNEG                   NOT NEGATIVE                    11960021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLIMENT           11980021
NOTNEG   BR    INTREG                   RETURN TO N S I                 12000021
FLERR1   CE    6,ZERO                   IS TOTAL VALUE ZERO             12020021
         BE    NOTNEG                   RETURN                          12040021
         B     ERR12RET                 SET ERROR CODE AND RETURN       12060021
*                                                                       12080021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  VALUES                 12100021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          12120021
*                                                                       12140021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   12160021
         ST    VALREG,OVFSAVE                                           12180021
         LE    0,OVFSAVE                LOAD TO FLOAT REG.              12200021
         AE    0,X6                     NORMALIZE                       12220021
         STE   0,OVFSAVE                                                12240021
         L     VALREG,OVFSAVE           FLOAT PT. VALUE IN REG.         12260021
         BR    LINREG                                                   12280021
*   ROUTINE TO CHECK IF PT. IS OUTSIDE OF GRID BOUNDARY                 12300021
*                                                                       12320021
GRLCHK   LH    VALREG,X1                X1                              12340021
         C     VALREG,UASCALE           X VALUE COMPARED TO X1          12360021
         BH    SETIND                   OFF GRID LIMIT                  12380021
         LH    VALREG,X2                X2                              12400021
         C     VALREG,UASCALE           X VALUE COMPARED TO X2          12420021
         BL    SETIND                   OFF GRID LIMIT                  12440021
         LH    VALREG,Y1                Y1                              12460021
         C     VALREG,VASCALE           Y VALUE COMPARED TO Y1          12480021
         BH    SETIND                   OFF GRID                        12500021
         LH    VALREG,Y2                Y2                              12520021
         C     VALREG,VASCALE           Y VALUE COMPARED TO Y2          12540021
         BL    SETIND                   OFF GRID                        12560021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET OFF            12580021
         B     OV10                                                     12600021
SETIND   MVI   OFFSW,X'11'              SET INDICATOR                   12620021
OV10     BR    LINREG                   RETURN                          12640021
*                                                                       12660021
*    ROUTINE TO CHECK IF POINT IS OFF THE SCREEN                        12680021
*                                                                       12700021
SCLCHK   L     VALREG,UASCALE           GET X VALUE                     12720021
         C     VALREG,ZERO              X VALUE COMPARED TO ZERO        12740021
         BL    SETBITS                  OFF SCREEN                      12760021
         C     VALREG,HIGH              X VALUE COMPARED TO 4095        12780021
         BH    SETBITS                  OFF SCREEN                      12800021
         L     VALREG,VASCALE           GET Y VALUE                     12820021
         C     VALREG,ZERO              Y VALUE COMPARED TO ZERO        12840021
         BL    SETBITS                  OFF SCREEN                      12860021
         C     VALREG,HIGH              Y VALUE COMPARED TO 4095        12880021
         BH    SETBITS                  OFF SCREEN                      12900021
         MVI   OFFSW,X'00'              WITHIN LIMIT SET OFF            12920021
         BR    LINREG                   RETURN                          12940021
SETBITS  MVI   OFFSW,X'11'              SET INDICATOR                   12960021
         BR    LINREG                   RETURN                          12980021
*                                                                       13000021
*                                                                       13020021
SCRNGRD  ST    LINREG,RSAVE             SAVE THE BRANCH REGISTER        13040021
         L     WRKREG,WRTADDR           GET BOUNDARY CHECK RT ADDRESS   13060021
         BALR  LINREG,WRKREG             AND BRANCH TO CHECK            13080021
         CLC   SWSTATUS,STATUS1         CHECK THE SWS STATUS IF STATUS1 13100021
         BE    RESREG                   ARE ALL POINTS ON ANSWER  YES   13120021
OPTIONA  CLI   SG,C'A'                  OTHERWISE OFFSG CONDITION EXIST 13140021
         BNE   OPTIONB                   CHECK USER-SPECIFIED OPTION    13160021
         BAL   LINREG,ERR44             IF A OPTION SET ERR CODE AND    13180021
         B     ANALOFF                   ANALIZE OFF STATUS TO HANDLE   13200021
OPTIONB  CLI   SG,C'B'                  IS B OPTION SPECIFIED           13220021
         BNE   OPTIONC                  IF NOT TEST FOR C               13240021
         BAL   LINREG,ERR48             IF YES SET ERR CODE AND         13260021
         B     ANALOFF                   ANALIZE OFF STATUS TO HANDLE   13280021
OPTIONC  CLI   SG,C'C'                  IS C OPTION SPECIFIED           13300021
         BNE   OPTIOND                  IF NOT TEST FOR D               13320021
         BAL LINREG,SCLCHK              CHECK FURTHER IF POINT          13340021
         CLI   OFFSW,X'11'               OFF SCREEN                     13360021
         BE    ERR32RET                 IFF OFF SCREEN IMMEDIATE RET    13380021
         LA    15,32                    OTHERWISE SET ERROR CODE AND    13400021
         BAL   LINREG,ERRCNT             CONTINUE THE JOB               13420021
         BAL   LINREG,GRLCHK            CHECK FURTHER FOR GRID          13440021
         B     ANALOFF                  GO TO ANALIZE OFF STATUS        13460021
OPTIOND  CLI   SG,C'D'                  IS OPTION D SPECIFIED           13480021
         BNE   ASSUMEE                  IF NOT ASSUME OPTION E          13500021
         B     ERR28RET                 IMMEDIATE ERROR RETURN          13520021
ASSUMEE  B     ERR32RET                 IMMEDIATE ERROR RETURN          13540021
         BE    ERR32RET                 IF OFF SCREEN IMMEDIATE RETURN  13560021
         BAL   LINREG,SCLCHK            IF OPTION C TEST FOR OFF SCRN   13580021
         LA    15,32                    OTHERWISE SET ERROR CODE        13600021
         BAL   LINREG,ERRCNT            UPDATE ERROR COUNT              13620021
         MVI   OFFSW,X'11'              RESTORE OFF BOUNDARY STATUS     13640021
         B     RESREG                   CONTINUE JOB                    13660021
SETSKIP  L     VALREG,ONE               SET SWITCH TO SKIP TO NEXT      13680021
         STH   VALREG,SKIPSW            POINT                           13700021
         B     RESREG                   AND RETURN VIA RESTORE REG      13720021
ANALOFF  CLI   PTYPE,C'B'               IF NOT VECTOR                   13740021
         BH    ANALVEC                  TYPE SKIP IT IF                 13760021
         CLC   SWSTATUS,STATUS3         IT IS POINT 2 OFF               13780021
         BE    SETSKIP                                                  13800021
         CLC   SWSTATUS,STATUS4        ANOTHER PT OFF?           A28795 13806021
         BE    SETSKIP                 YES GET NEXT PT           A28795 13812021
         B     RESREG                   OTHERWISE CONTINUE              13820021
ANALVEC  CLC   COUNT,ONE+2              IF FIRST POINT OFF, GET         13840021
         BNH   SETSKIP                  GET ANOTHER                     13860021
         STM   13,0,PORSAVE             SAVE REGISTERS                  13880021
         ST    13,OVFSAVE+4             SAVE POR SAVEAREA CHAINING ADDR 13900021
         ST    15,SVR15                 SAVE ERROR REGISTER             13920021
         LA    13,OVFSAVE               LOAD GOFFSG RT SAVEAREA ADDR    13940021
         LR    WRKREG,1                 SAVE REG1-WKAREA POINTER        13960021
         CLC   GOFFSGAD,ZERO            CHECK IF GOFFSG RT ADDR AREA 0  13980021
         BNE   OFFHDLG                  IF NOT RT BROUGHT IN GO TO HDL  14000021
         LA    1,SABL                   LOAD 24-WORD PARTAB START ADDR  14020021
         LOAD  EP=GOFFSG                RETAIN THE MODULE               14040021
         LR    1,WRKREG                 RESTORE REGISTER 1              14060021
         ST    0,GOFFSGAD               SAVE GOFFSG RT ADDRESS          14080021
OFFHDLG  L     15,GOFFSGAD              LOAD GOFFSG RT ADDRESS          14100021
         LA    1,SABL                   LOAD 24-WORD PARTAB ADDR        14120021
         BALR  14,15                    BRANCH TO GOFFSG RT             14140021
         LR    1,WRKREG                 RESTORE REG 1                   14160021
LINKOUT  LM    13,0,PORSAVE             RESTORE REG 13 TO 0             14180021
         L     15,SVR15                 RESTORE ERROR REGISTER          14200021
*   ANALIZE THE RESPONSE OF GOFFSG ROUTINE AND GENERATE PROPER DATA     14220021
ANALRES  CLC   NI,ZERO                  IS NI=0                         14240021
         BE    NOINTS                   IF SO GO TO NO INTERSECT RT     14260021
         CLC   NI,ONE                   IS NI=1                         14280021
         BE    ONEINTS                  IF SO GO TO ONE INTERSECT RT    14300021
BOTHOUT  MVC   X1FINAL,XYINT1           OTHERWISE GDV I1X,I1Y,B         14320021
         MVC   X2FINAL,XYINT2                                           14340021
         MVC   ORDER3,X1FINAL           AND GDV I2X,I2Y,U               14360021
         MVC   ORDER4,X2FINAL                                           14380021
         OI    ORDER3,X'40'                                             14400021
         LA    CNTREG,8                 LOAD BYTE NUMBER                14420021
         LA    ADDREG,ORDER3                                            14440021
         BAL   LINREG,STORE             GIVE TO STORE ROUTINE           14460021
         B     SETSKIP                  SKIP THE NEXT POINT             14480021
NOINTS   CLC   SWSTATUS,STATUS2         SEE IF PT1 OFF PT2 ON           14500021
         BE    NOINTSA                  IF SO IT'S NO INTS CONDITION A  14520021
         B     SETSKIP                  GO ON TO NEXT POINT             14540021
NOINTSA  MVC   X1FINAL,X2FINAL          GDV X2,Y2,B                     14560021
         MVC   ORDER3,X1FINAL           AND GDV X2,Y2,U                 14580021
         MVC   ORDER4,X2FINAL                                           14600021
         OI    ORDER3,X'40'                                             14620021
         LA    CNTREG,8                 AND GIVE TO STORE ROUTINE       14640021
         LA    ADDREG,ORDER3                                            14660021
         B     STOREP                                                   14680021
ONEINTS  CLC   SWSTATUS,STATUS2         SEE IF PT1 OFF PT2 ON           14700021
         BE    ONEINTSA                 IF SO GO TO ONE INTS CONDITIONA 14720021
         CLC   SWSTATUS,STATUS3         SEE IF PT1 ON PT2 OFF           14740021
         BE    ONEINTSB                 IF SO GO TO ONE INTS CONDITIONB 14760021
         B     BOTHOUT                                                  14780021
ONEINTSA MVC   X1FINAL,XYINT1           GENERATE I1X,I1Y,B              14800021
         MVC   ORDER3,X1FINAL                                           14820021
         OI    ORDER3,X'40'             BLAND BEAM BIT                  14840021
         LA CNTREG,4                    AND GIVE TO STORE ROUTINE       14860021
         LA    ADDREG,ORDER3                                            14880021
         B     STOREP                                                   14900021
ONEINTSB MVC   X2FINAL,XYINT1                                           14920021
         MVC   ORDER3,X2FINAL                                           14940021
         LA CNTREG,4                    GDVI1X,I1Y,U AND THEN STORE     14960021
         LA    ADDREG,ORDER3                                            14980021
         BAL   LINREG,STORE             STORE THE POINT AND             15000021
         B     SETSKIP                  AND SKIP ANYTHING ELSE          15020021
STOREP   BAL   LINREG,STORE                                             15040021
RESREG   L     LINREG,RSAVE             RESTORE THE L INE REGISTER      15060021
         BR    LINREG                   AND RETURN                      15080021
* SUBROUTINE TO PLOT A CHARACTER                                        15100021
PLTCH    CLI   E,C'O'                   NO OVERLAP                      15120021
         BE    OV9                      YES-NO OVER LAP PERMITTER       15140021
         B     PLTCH1                   VECTOR AND CHAR OR VECTOR ONLY  15160021
OV9      LH    VALREG,X2FIN             X2                              15180021
         SH    VALREG,X1FIN             X2-X1                           15200021
         LPR   XREG,VALREG              ABSOLUTE OF DELTA X             15220021
         C     XREG,EIGHT                                               15240021
         BH    PLTCH1                   MORE THAN EIGHT                 15260021
         LH    VALREG,Y2FIN             Y2                              15280021
         SH    VALREG,Y1FIN             Y2-Y1                           15300021
         LPR   YREG,VALREG              ABSOLUTE OF DELTA Y             15320021
         C     YREG,EIGHT                                               15340021
         BH    PLTCH1                   MOVE THAN EIGHT                 15360021
*                                                                       15380021
* DIFFERENCE IS LESS THAN EIGHT BETWEEN POINTS                          15400021
*                                                                       15420021
         L     VALREG,X1FINAL           X1,Y1                           15440021
         ST    VALREG,X2FINAL           STORE X1,Y1 OVER X2,Y2          15460021
         B     NOT1                     CHECK COUNT                     15480021
PLTCH1   MVC   ORDER5,CHARMOD           MODE AND CHARACTER SIZE         15500021
         MVC   GOMODE,CHARMOD                                           15520021
         MVC   ORDER6,SYMBOL            LETTER                          15540021
         MVI   ORDER7,X'00'             NULL CHARACTER                  15560021
         LA    CNTREG,4                 COUNT TO MOVE                   15580021
         LA    ADDREG,ORDER5                                            15600021
         BR    LINREG                                                   15620021
*                                                                       15640021
*        XYLCHK     SUBROUTINE                                          15660021
*        ADDRESS OF XYLIM TABLE IN  XYLREG BEFORE  BAL                  15680021
XYLCHK   LA    CONREG,4                SET LOOP CONTROL                 15700021
         LA    INXREG,0                 SET  INDEX                      15720021
XYLLOOP  LH    TEMREG,X1(INXREG)        X1,Y1,X2,Y2                     15740021
         C     TEMREG,ZERO                                              15760021
         BL    ERR4RET                                                  15780021
         C     TEMREG,HIGH                                              15800021
         BH    ERR4RET                                                  15820021
         A     INXREG,TWO                                               15840021
         BCT   CONREG,XYLLOOP                                           15860021
         CLC   X1,X2                    X1 COMPARED TO X2               15880021
         BNL   ERR4RET                                                  15900021
         CLC   Y1,Y2                    Y1 COMPARED TO Y2               15920021
         BNL   ERR4RET                                                  15940021
         BR    INTREG                   RETURN TO MAIN LINE             15960021
ERR4RET  LA    15,4                     XYLIM X1,Y2,X2,Y2 LIMIT ERROR   15980021
         B     ERRCNTR                                                  16000021
ERR8RET  LA    15,8                                                     16020021
         B     ERRCNTR                                                  16040021
ERR12RET LA    15,12                    FLOATING POINT ERROR DETECTED   16060021
         B     ERRCNTR                                                  16080021
ERR16RET LA    15,16                    U1,V1 GREATER THAN U2,V2        16100021
         B     ERRCNTR                                                  16120021
ERR20RET LA    15,20                                                    16140021
         B     ERRCNTR                                                  16160021
ERR24RET LA    15,24                    USERS OVERFLOW-OLP NOT RESET    16180021
         B     ERRCNTR                                                  16200021
ERR28RET LA    15,28                                                    16220021
         B     ERRCNTR                                                  16240021
ERR32RET LA    15,32                    OPTION C                        16260021
         B     ERRCNTR                                                  16280021
ERR40    LA    15,40                    PARAMETERS ERROR-NOT SERIOUS    16300021
         B     ERRCNT                   ADD TO COUNT                    16320021
ERR44    LA    15,44                                                    16340021
         B     ERRCNT                                                   16360021
ERR48    LA    15,48                                                    16380021
         B     ERRCNT                   ADD TO COUNT                    16400021
ERRCNTR  LA    LINREG,RET                                               16420021
ERRCNT   L     TEMREG,ERRCOUNT                                          16440021
         A     TEMREG,ONE                                               16460021
         ST    TEMREG,ERRCOUNT                                          16480021
         BR    LINREG                                                   16500021
*                                                                       16520021
*   RET SUBROUTINE TESTS COUNT IN WORK AREA,(ERRCOUNT) AND              16540021
*   SETS BIT IN SIGN POSITION OF REG. 15 IF MULTIBLE ERRORS             16560021
*   (MORE THAN ONE)                                                     16580021
RET      CLC   GOFFSGAD,ZERO           HAS OFF SCREEN/GRID ROUTINE 5800 16600021
         BE    RET1                                                     16620021
         ST    15,SVR15                 SAVE ERROR REGISTER             16640021
         LR    WRKREG,1                 SAVE REGISTER 1                 16660021
         DELETE EP=GOFFSG                                               16680021
         LR    1,WRKREG                 RESTORE REGISTER 1              16700021
         L     15,SVR15                 RESTORE ERROR REGISTER          16720021
RET1     LA    TEMREG,1                                                 16740021
         C     TEMREG,ERRCOUNT                                          16760021
         BL    SETBIT                                                   16780021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            16800021
RETMACRO L     WRKREG,MASKSV                                            16820021
         SPM   WRKREG                                                   16840021
         RETURN (14,12),T,RC=(15)                                       16860021
SETBIT   O     15,MZERO                                                 16880021
         B     RETMACRO                                                 16900021
BYCT     DC    F'120'                                                   16920021
ZERO     DC    F'0'                     ZERO                            16940021
MZERO    DC    X'80000000'              MINUS ZERO                      16960021
ONE      DC    F'1'                                                     16980021
TWO      DC    F'2'                                                     17000021
MTWO     DC    X'FFFFFFFE'              MINUS TWO                       17020021
FOUR     DC    F'4'                                                     17040021
EIGHT    DC    F'8'                                                     17060021
HIGH     DC    F'4095'                  HIGH LIMIT                      17080021
BYTE3    DC    X'0000FF00'              MASK SYMBOL-EBCDIC CODE         17100021
BYTE123  DC    X'00FFFFFF'                                              17120021
ALLFF    DC    X'FFFFFFFF'              ALL BITS                        17140021
X6       DC    X'46000000'              EXPONENT OF SIX                 17160021
         DS    0D                       ALIGN BOUNDARY                  17180021
X4E      DC    X'4E00000000000000'                                      17200021
FLPT5    DC    E'.5'                                                    17220021
FCHAR    DC    X'7F000000'              MASK FOR CHARACTERISTIC         17240021
LOHI     DC    F'0'                     X1,Y1                           17260021
H2A80    DC    X'2A80'                 NOP                       A29402 17270021
H2A02    DC    X'2A02'                                                  17280021
H0003    DC    H'0003'                                                  17300021
         DC    H'4095'                  UPPER LIMIT                     17320021
         DC    H'4095'                  UPPER LIMIT                     17340021
STATUS1  DC    H'0'                     BOTH PT1 AND PT2 WITHIN LIMITS  17360021
STATUS2  DC    X'1100'                  PT1 OFF PT2 ON                  17380021
STATUS3  DC    X'0011'                  PT1 ON PT2 OFF                  17400021
STATUS4  DC    X'1111'                 TWO SUCCESSIVE PTS OFF    A28795 17410021
* REGISTER ASSIGN MENT                                                  17420021
VALREG   EQU   0                                                        17440021
PASREG   EQU   0                                                        17460021
WKAREG   EQU   1                                                        17480021
XYLREG   EQU   2                                                        17500021
OBPREG   EQU   2                        MUST BE IN THIS ORDER           17520021
PATREG   EQU   3                        MUST BE IN THIS ORDER           17540021
WRKREG   EQU   4                                                        17560021
EREG     EQU   4                        EVEN REGISTER                   17580021
XREG     EQU   5                        ODD  REGISTER                   17600021
CNTREG   EQU   5                                                        17620021
TEMREG   EQU   6                                                        17640021
OREG     EQU   6                        EVEN REGISTER                   17660021
YREG     EQU   7                        ODD REGISTER                    17680021
ADDREG   EQU   7                                                        17700021
INXREG   EQU   8                                                        17720021
SLOREG   EQU   8                                                        17740021
OABREG   EQU   10                                                       17760021
INTREG   EQU   11                                                       17780021
OLPREG   EQU   12                                                       17800021
CONREG   EQU   12                                                       17820021
LINREG   EQU   14                                                       17840021
* PARTAB DEFINED STORAGE MAP                                            17860021
* PATREG EQUALS A GENERAL REGISTER                                      17880021
PARTAB   DSECT                                                          17900021
XYLIM    DS    CL4                      XYLIM ADDRESS                   17920021
UTAB     DS    CL4                      UTAB  ADDRESS                   17940021
VTAB     DS    CL4                      VTAB  ADDRESS                   17960021
F        DS    CL1                      MODE OF INPUT                   17980021
S        DS    CL1                      SCALE OR NO SCALE               18000021
CSIZE    DS    CL1                      CHARACTER SIZE                  18020021
CMOD     DS    CL1                      PROTECTED OR UNPROTECTED MODE   18040021
A        DS    CL1                      RELATIVE OR ABSOLUTE            18060021
I        DS    CL1                      INCREMENT OR NO INCREMENT       18080021
PTYPE    DS    CL1                      PLOT TYPE                       18100021
SG       DS    CL1                                                      18120021
N        DS    CL2                      NUMBER OF POINTS TO PLOT        18140021
SYMBOL   DS    CL1                      LETTER TO PLOT                  18160021
E        DS    CL1                      OVERLAP OR NO OVERLAP           18180021
* XYLIM TABLE DEFINED.STORAGE MAP                                       18200021
* XYLREG EQUALS A GENERAL REGISTER                                      18220021
XYLIMTB  DSECT                                                          18240021
X1       DS    CL2                      LOWER LEFT COORDINATE VALUE     18260021
Y1       DS    CL2                      LOWER LEFT COORDINATE VALUE     18280021
X2       DS    CL2                      UPPER RIGHT COORDINATE VALUE    18300021
Y2       DS    CL2                      UPPER RIGHT COORDINATE VALUE    18320021
U1       DS    CL4                      LOWER LEFT SCALING COORDINATE   18340021
U2       DS    CL4                      LOWER LEFT SCALING COORDINATE   18360021
V1       DS    CL4                      UPPER RIGHT SCALING COORDINATE  18380021
V2       DS    CL4                      UPPER RIGHT SCALING COORDINATE  18400021
* WORK AREA DEFINED STORAGE MAP                                         18420021
* WKAREG EQUALS A GENERAL REGISTER                                      18440021
WKAREA   DSECT                                                          18460021
         DS    0D                                                       18480021
OVFSAVE  DS    0CL72                                                    18500021
TEMFLT   DS    0CL8                                                     18520021
         DS    CL72                                                     18540021
ERRCOUNT DS    CL4                      COUNT OF PARAMETER ERRORS       18560021
INCOUNT  DS    CL4                                                      18580021
         ORG   INCOUNT                                                  18600021
INDEX    DS    CL2                      TABLE INDEX OF UTAB OR VTAB     18620021
COUNT    DS    CL2                      NUMBER OF POINTS PROCESSED      18640021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    18660021
FX1      DS    CL4                      FLOAT X1                        18680021
FY1      DS    CL4                      FLOAT Y1                        18700021
FX2      DS    CL4                      FLOAT X2                        18720021
FY2      DS    CL4                      FLOAT Y2                        18740021
UA       DS    CL4                      ABSOLUTE FLOAT OR FIXED UA      18760021
VA       DS    CL4                      ABSOLUTE FLOAT OR FIXED VA      18780021
X1FINAL  DS    CL4                      X1,Y1                           18800021
         ORG   X1FINAL                                                  18820021
X1FIN    DS    CL2                      X1                              18840021
Y1FIN    DS    CL2                      Y1                              18860021
X2FINAL  DS    CL4                      X2,Y2                           18880021
         ORG   X2FINAL                                                  18900021
X2FIN    DS    CL2                      X2                              18920021
Y2FIN    DS    CL2                      Y2                              18940021
WRTADDR  DS    CL4                      ADDR OF GRID OR SCREEN CHECK RT 18960021
GOFFSGAD DS    CL4                      GOFFSG RT ADDR AREA             18980021
SWSTATUS DS    CL2                      SWITCH STATUS OF PT1 AND PT2    19000021
         ORG   SWSTATUS                                                 19020021
PT1SW    DS    CL1                      PREVIOUS STATUS                 19040021
OFFSW    DS    CL1                      CURRENT STATUS                  19060021
SKIPSW   DS    CL2                      SET TO ONE TO SKIP POINT        19080021
RSAVE    DS    CL4                      PLACE TO SAVE LINE REGISTER     19100021
SVR15    DS    CL4                      PLACE TO SAVE ERROR REGISTER    19120021
ORDER1   DS    CL1                      GRAPHICORDERS-MODE              19140021
ORDER2   DS    CL1                                                      19160021
ORDER3   DS    CL4                      PT. TO PLOT                     19180021
ORDER4   DS    CL4                                                      19200021
         ORG   ORDER4                                                   19220021
ORDER5   DS    CL2                                                      19240021
ORDER6   DS    CL1                                                      19260021
ORDER7   DS    CL1                                                      19280021
ORDER8   DS    CL2                                                      19300021
EPRGMOD  DS    CL4                                                      19320021
         ORG   EPRGMOD                                                  19340021
EOPRG    DS    CL2                      LAST PT. INDICATOR              19360021
CHARMOD  DS    CL2                      ORDER FOR CHARACTER AND MODE    19380021
PT1VEC   DS    CL4                      SIMULATED VECTOR X1,Y1          19400021
         ORG   PT1VEC                                                   19420021
PT1VE    DS    CL2                                                      19440021
PT2VE    DS    CL2                                                      19460021
PT2VEC   DS    CL4                      SIMULATED VECTOR X2,Y2          19480021
         ORG   PT2VEC                                                   19500021
PT2VECT  DS    CL2                                                      19520021
PT2VECS  DS    CL2                                                      19540021
DELTAX   DS    CL2                      DELTA X                         19560021
DELTAY   DS    CL2                      DELTA Y                         19580021
TOTAL    DS    CL4                                                      19600021
         ORG   TOTAL                                                    19620021
INTEGER  DS    CL2                      INTEGER-SIMULATED VECTOR        19640021
FRACTION DS    CL2                      FRACTION-SIMULATED VECTOR       19660021
ABVTEMP  DS    CL4                      VECTOR MODE-TEMP STORAGE        19680021
         ORG   ABVTEMP                                                  19700021
ABVMODE  DS    CL2                      VECTOR MODE INDICATOR           19720021
TEMP     DS    CL2                      TEMP STORAGE                    19740021
XYINCR   DS    CL4                      CHANGING X OR Y VALUE           19760021
PORSAVE  DS    CL28                                                     19780021
ADGOFFSG DS    CL4                      ADDRESS OF GOFFSG               19800021
SABL     DS    CL4                      ADDRESS OF BOUNDARY             19820021
UASCALE2 DS    CL4                                                      19840021
VASCALE2 DS    CL4                                                      19860021
UASCALE  DS    CL4                      ABSOLUTE FLOAT-FIX-THEN SCALE   19880021
         ORG   UASCALE                                                  19900021
UAS1     DS    CL2                                                      19920021
UAS2     DS    CL2                      FIXED HALF WORD-MAY BE SCALED   19940021
VASCALE  DS    CL4                                                      19960021
         ORG   VASCALE                                                  19980021
VAS1     DS    CL2                                                      20000021
VAS2     DS    CL2                      FIXED HALF WORD-MAY BE SCALED   20020021
NI       DS    CL4                      NUMBER OF INTERATIONS           20040021
XYINT1   DS    CL4                      FIRST INTERSECTION              20060021
XYINT2   DS    CL4                      SECOND INTERSECTION             20080021
INTWKA   DS    CL64                     INTERNAL WORKAREA               20100021
         DS    0D                                                       20120021
         ORG   OVFSAVE+396                                              20140021
GOMODE   DS    CL2                                                      20160021
         END                                                            20180021
./  ADD  SSI=20480476,NAME=IFFPHALA
         TITLE 'GLABEL - GRID LABEL ROUTINE'                          * 00020021
*STATUS. CHANGE LEVEL 0                                               * 00040021
*                                                                     * 00060021
*FUNCTION/OPERATION. GLABEL  GENERATES GRAPHIC ORDERS THAT WILL LABEL * 00080021
*   EACH DIVISION OR LOG CYCLE OF AN X OR Y AXIS OF A RECTANGULAR     * 00100021
*   GRID WITH ALPHAMERIC CHARACTERS AND IF SPECIFIED PLACE A TICK     * 00120021
*   MARK BETWEEN THE AXIS LABELED AND THE LABEL ITSELF.               * 00140021
*                                                                     * 00160021
*ENTRY POINTS. GLABEL VIA CALL OR LINK MACRO    ALIAS NAME IFFPHALA   * 00180021
*                                                                     * 00200021
*INPUT. OUTPUT CONTROL BLOCK POINTER AND A PARAMETER TABLE            * 00220021
*                                                                     * 00240021
*OUTPUT. A STRING OF GRAPHIC ORDERS STORED IN THE GDOA                * 00260021
*                                                                     * 00280021
*EXTERNAL ROUTINES. N/A                                               * 00300021
*                                                                     * 00320021
*EXITS-NORMAL. COMPLETION OF TASK. EXIT VIA RETURN MACRO              * 00340021
*     -ERROR. HEXADECIMAL 4,8,C,10,14,18, OR 20 IN REG 15             * 00360021
*   IMMEDIATE RETURN. EXIT VIA RETURN MACRO                           * 00380021
*     -ERROR. HEXADECIMAL 28 IN REG 15   DOES NOT RETURN IMMEDIATELY  * 00400021
*   COMPLETION OF TASK. EXIT VIA RETURN MACRO                         * 00420021
*                                                                     * 00440021
*TABLES/WORK AREAS. USER SPECIFIED PARAMETER TABLE, XYLIM TABLE AND   * 00460021
*   WORK AREA                                                         * 00480021
*                                                                     * 00500021
* ATTRIBUTES. READ ONLY, REENTRANT                                    * 00520021
         EJECT                                                          00540021
IFFPHALA CSECT                          GLABEL                          00560021
*0669                                                              7468 00570021
         ENTRY GLABEL                                                   00580021
GLABEL   SAVE  (14,12),T,*                                              00600021
         BALR  9,0                                                      00620021
         USING *,9                                                      00640021
         USING PARTAB,PATREG                                            00660021
         USING XYLIMT,XYLREG                                            00680021
         USING WRKAREA,WKAREG                                           00700021
         LM    OBPREG,PATREG,0(1)       GET ADDR OF OCBP,PARTAB         00720021
         L     WKAREG,4(OBPREG)                     WRKAREA             00740021
         L     OABREG,0(OBPREG)                     OACB                00760021
         L     XYLREG,0(PATREG)                     XYLIM TABLE         00780021
*  SAVE MASK BITS AS SET BY USER                                        00800021
         ST    9,MASKSV                                                 00820021
         SR    WRKREG,WRKREG                                            00840021
         SPM   WRKREG                                                   00860021
         LM    XREG,YREG,UI             LOAD UI,VC OR VI,UC             00880021
         SR    15,15                    RESET ERR CODE REG              00900021
         ST    15,ERRCOUNT              RESET ERR COUNT                 00920021
         BAL   LINREG,XYLCHK                                            00940021
         CLI   F,C'F'                   TEST FOR FLOAT                  00960021
         BE    FLTLEG                                                   00980021
         CLI   F,C'B'                  TEST FOR FIX                     01000021
         BE    TESTS                                                    01020021
         BAL   LINREG,ERR40                                             01040021
TESTS    CLI   S,C'S'                   TEST FOR SCALE                  01060021
         BE    FIXSCAL                                                  01080021
         CLI   S,C'N'                   TEST FOR NO SCALE               01100021
         BE    TESTUV                                                   01120021
         BAL   LINREG,ERR40                                             01140021
*   TEST  UC,VC FOR LESS THAN ZERO AND GREATER THAN 4095                01160021
TESTUV   C     YREG,HIGH                                                01180021
         BH    ERR8RET                                                  01200021
         C     YREG,ZERO                                                01220021
         BL    ERR8RET                                                  01240021
*   TEST  UI,VI   FOR  0-4095 LIMITS                                    01260021
         C     XREG,ZERO                                                01280021
         BNH   ERR8RET                                                  01300021
         C     XREG,HIGH                                                01320021
         BH    ERR8RET                                                  01340021
         LH    WRKREG,LGAP                                              01360021
         C     WRKREG,ZERO              TEST LGAP FOR LESS THAN ZERO    01380021
         BL    ERR20RET                                                 01400021
         LH    WRKREG,FLENGTH                                           01420021
         C     WRKREG,ZERO              TEST FLENGTH LESS THAN ZERO     01440021
         BL    ERR20RET                                                 01460021
         EJECT                                                          01480021
*   TEST  AXIS  TO  BE  LABELED                                         01500021
         CLI   TYPE,C'Y'                                                01520021
         BE    TICKGAP                                                  01540021
         CLI   TYPE,C'X'                                                01560021
         BE    SIZETEST                                                 01580021
         B     ERR20RET                                                 01600021
SIZETEST CLI   SIZE,C'B'                                                01620021
         BE    BASIC                                                    01640021
         CLI   SIZE,C'L'                                                01660021
         BE    LARGE                                                    01680021
BASIC    LA    ODDREG,56                                                01700021
         B     LENGTH                                                   01720021
LARGE    LA    ODDREG,84                                                01740021
LENGTH   MH    ODDREG,FLENGTH                                           01760021
         CR    ODDREG,XREG              COMPARE TO INC X OR Y           01780021
         BL    TICKGAP                                                  01800021
         B     ERR20RET                                                 01820021
TICKGAP  LH    WRKREG,LTICK                                             01840021
         CH    WRKREG,LGAP                                              01860021
         BH    LTICKERR                                                 01880021
         C     WRKREG,ZERO                                              01900021
         BE    TESTFL                   NO TICK IF LTICK = 0            01920021
         BH    STORGEVM                                                 01940021
LTICKERR BAL   LINREG,ERR40                                             01960021
TESTFL   LH    WRKREG,FLENGTH                                           01980021
         C     WRKREG,ZERO                                              02000021
         BE    RET                                                      02020021
*   TEST CHARACTER SIZE B OR L                                          02040021
         CLI   SIZE,C'B'                                                02060021
         BE    CHBASIC                                                  02080021
         CLI   SIZE,C'L'                                                02100021
         BE    CHLARGE                                                  02120021
         BAL   LINREG,ERR40                                             02140021
CHBASIC  LA    ODDREG,56                CWTH  BASIC                     02160021
         LA    EVEREG,80                CHGTH                           02180021
         MVC   YE,GFSCB                                                 02200021
         B     TESTTYPE                                                 02220021
CHLARGE  LA    ODDREG,84                CWTH LARGE                      02240021
         LA    EVEREG,120               CHGTH                           02260021
         MVC   YE,GFSCL                                                 02280021
TESTTYPE CLI   TYPE,C'X'                                                02300021
         BE    COMPUTEX                                                 02320021
         B     COMPUTEY                                                 02340021
         EJECT                                                          02360021
*   XI=X1-((FLENGTH-1)*CWTH)/2)     YI=VC-LGAP-(CHGT/2)                 02380021
COMPUTEX LH    WRKREG,FLENGTH                                           02400021
         S     WRKREG,ONE                                               02420021
         STH   WRKREG,WRKAREA                                           02440021
         MH    ODDREG,WRKAREA                                           02460021
         SRA   ODDREG,1                 /2                              02480021
         LH    WRKREG,X1                                                02500021
         SR    WRKREG,ODDREG            =XI                             02520021
         BM    ERR20RET                                                 02540021
         STH   WRKREG,XI                                                02560021
         SH    YREG,LGAP                VC-LGAP                         02580021
         SRA   EVEREG,1                 CWTH/2                          02600021
         SR    YREG,EVEREG              =YI                             02620021
         BM    ERR20RET                                                 02640021
         STH   YREG,YI                                                  02660021
         B     LOADADDR                                                 02680021
*    XI =UC-LGAP-(FLENGTH*CWTH)   YI=Y1                                 02700021
COMPUTEY MH    ODDREG,FLENGTH                                           02720021
         SH    YREG,LGAP                                                02740021
         SR    YREG,ODDREG                                              02760021
         BM    ERR20RET                                                 02780021
         STH   YREG,XI                                                  02800021
         MVC   YI,Y1                                                    02820021
LOADADDR MVC   ADDRESS,DATA                                             02840021
         MVC   XS,GEVM                                                  02860021
         MVC   GOMODE,GEVM                                              02880021
STORLABL MVC   YS,XI                                                    02900021
         MVC   XE,YI                                                    02920021
         OI    YS,X'40'                 SET BLANK BIT                   02940021
         LA    ADDREG,XS                                                02960021
         LA    CNTREG,8                                                 02980021
         BAL   LINREG,STORSAVE                                          03000021
         L     ADDREG,ADDRESS                                           03020021
         L     WRKREG,ADDRESS                                           03040021
         AH    WRKREG,FLENGTH           ADDRESS+FLENGTH                 03060021
         ST    WRKREG,ADDRESS           =NEW ADDRESS                    03080021
         LH    CNTREG,FLENGTH                                           03100021
         BAL   LINREG,STORSAVE                                          03120021
         MVC   GOMODE,YE                                                03140021
         TM    FLENGTH+1,X'01'          TEST FOR  FL=EVEN NUMBER        03160021
         BZ    NEXTINC                                                  03180021
         LA    ADDREG,ZERO                                              03200021
         LA    CNTREG,1                                                 03220021
         BAL   LINREG,STORSAVE                                          03240021
NEXTINC  CLI   TYPE,C'X'                                                03260021
         BE    XINC                                                     03280021
         LH    WRKREG,YI                YI                              03300021
         AR    WRKREG,XREG                +YINC                         03320021
         STH   WRKREG,YI                =NEW YI                         03340021
         CH    WRKREG,Y2                                                03360021
         BH    RET                                                      03380021
         B     STORLABL                                                 03400021
XINC     LH    WRKREG,XI                                                03420021
         AR    WRKREG,XREG                                              03440021
         STH   WRKREG,XI                                                03460021
         CH    WRKREG,X2                                                03480021
         BH    RET                                                      03500021
         B     STORLABL                                                 03520021
         EJECT                                                          03540021
*   STORE GEVM ORDER IN GDOA                                            03560021
STORGEVM LA    CNTREG,2                                                 03580021
         LA    ADDREG,GEVM                                              03600021
         MVC   GOMODE,GEVM                                              03620021
         BAL   LINREG,STORSAVE                                          03640021
         LR    WRKREG,YREG              UC OR VC                        03660021
         SH    WRKREG,LTICK             -LTICK=XE OR YE                 03680021
         BM    ERR20RET                XE OR YE OFF SCREEN              03700021
         CLI   TYPE,C'X'                                                03720021
         BE    XAXIS                                                    03740021
         STH   YREG,XS                  XS=UC                           03760021
         MVC   YS,Y1                    YS=Y1                           03780021
         STH   WRKREG,XE                XE=XS-LTICK                     03800021
         MVC   YE,Y1                    YE=YS                           03820021
         B     BLANKBIT                                                 03840021
XAXIS    MVC   XS,X1                    XS=X1                           03860021
         STH   YREG,YS                  YS=VC                           03880021
         MVC   XE,X1                    XE=XS                           03900021
         STH   WRKREG,YE                YE=YS-LTICK                     03920021
BLANKBIT OI    XS,X'40'                                                 03940021
         LA    CNTREG,8                                                 03960021
         LA    ADDREG,XS                                                03980021
STORTICK BAL   LINREG,STORSAVE                                          04000021
         CLI   TYPE,C'X'                                                04020021
         BE    XAXIS2                                                   04040021
         LH    WRKREG,YS                GET  YS                         04060021
         AR    WRKREG,XREG              +INC                            04080021
         STH   WRKREG,YS                NEW YS                          04100021
         STH   WRKREG,YE                NEW YE                          04120021
         CH    WRKREG,Y2                                                04140021
         BH    TESTFL                                                   04160021
         B     STORTICK                                                 04180021
XAXIS2   LH    WRKREG,XE                GET  XS (XE)                    04200021
         AR    WRKREG,XREG              +INC                            04220021
         STH   WRKREG,XS                NEW XS                          04240021
         STH   WRKREG,XE                NEW XE                          04260021
         CH    WRKREG,X2                                                04280021
         BH    TESTFL                                                   04300021
         B     BLANKBIT                                                 04320021
         EJECT                                                          04340021
*   LOAD ERROR CODE IN REG 15                                           04360021
ERR40    LA    15,40                    PARAMETER ERROR - DOES NOT RET  04380021
         B     ERRCNT                                                   04400021
ERR24RET LA    15,24                    USERS OVF HAS NOT RESET OLP     04420021
         B     ERRCNTR                                                  04440021
ERR20RET LA    15,20                    PARAMETER ERROR - RET           04460021
         B     ERRCNTR                                                  04480021
ERR16RET LA    15,16                    U1,V1 GREATER THAN U1,U2        04500021
         B     ERRCNTR                                                  04520021
ERR12RET LA    15,12                    FLT PT ERROR DETECTED           04540021
         B     ERRCNTR                                                  04560021
ERR8RET  LA    15,8                     U,V LIMIT ERROR AFTER SCALE     04580021
         B     ERRCNTR                                                  04600021
ERR4RET  LA    15,4                     XYLIM X1,Y1  X2,Y2 LIMIT ERROR  04620021
ERRCNTR  LA    LINREG,RET                                               04640021
ERRCNT   L     TEMREG,ERRCOUNT                                          04660021
         A     TEMREG,ONE                                               04680021
         ST    TEMREG,ERRCOUNT                                          04700021
         BR    LINREG                                                   04720021
*   TEST ERROR COUNT IN WORK AREA AND SET BIT                           04740021
*   IN SIGN POSITION OF REG 15 IF MULTIPLE ERRORS                       04760021
RET      LA    TEMREG,1                                                 04780021
         C     TEMREG,ERRCOUNT                                          04800021
         BL    SETBIT                                                   04820021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            04840021
RETMACRO L     WRKREG,MASKSV                                            04860021
         SPM   WRKREG                                                   04880021
         RETURN (14,12),T,RC=(15)                                       04900021
SETBIT   O     15,MZERO                                                 04920021
         B     RETMACRO                                                 04940021
         EJECT                                                          04960021
*   XYLCHK  SUBROUTINE                                                  04980021
*   CHECK X1,X2,Y1,Y2 LIMITS GREATER THAN 0 AND LESS THAN 4095          05000021
*   CHECK X1 LESS THAN X2 , Y1 LESS THAN Y2                             05020021
*   ADDRESSOF XYLIM TABLE IN XYLREG BEFORE BAL                          05040021
XYLCHK   LA    CNTREG,4                 SET  LOOP  COUNT                05060021
         LA    INXREG,0                 SET  INDEX                      05080021
XYLLOOP  LH    WRKREG,X1(INXREG)        LOAD X1,Y1,X2,Y2                05100021
         C     WRKREG,ZERO                                              05120021
         BL    ERR4RET                                                  05140021
         C     WRKREG,HIGH                                              05160021
         BH    ERR4RET                                                  05180021
         A     INXREG,TWO                                               05200021
         BCT   CNTREG,XYLLOOP                                           05220021
         CLC   X1,X2                                                    05240021
         BNL   ERR4RET                                                  05260021
         CLC   Y1,Y2                                                    05280021
         BNL   ERR4RET                                                  05300021
         BR    LINREG                                                   05320021
*   SAVE REG IN WORK AREA BEFORE BAL TO STORE                           05340021
STORSAVE STM   1,15,PORSAVE                                             05360021
         BAL   LINREG,STORE                                             05380021
         LM    1,15,PORSAVE                                             05400021
         BR    LINREG                                                   05420021
FLTLEG   CLI   S,C'S'                   TEST FOR SCALE                  05440021
         BE    SCALFLT                                                  05460021
         CLI   S,C'N'                   TEST FOR NO SCALE               05480021
         BE    FCONVERT                                                 05500021
         BAL   LINREG,ERR40                                             05520021
FCONVERT LR    VALREG,XREG              FIXCONVERT -(CONVERT FLOAT      05540021
         BAL   LINREG,FIXCONV           TO FIX)                         05560021
         LR    XREG,VALREG                                              05580021
         LR    VALREG,YREG                                              05600021
         BAL   LINREG,FIXCONV                                           05620021
         LR    YREG,VALREG                                              05640021
         B     TESTUV                                                   05660021
         EJECT                                                          05680021
*   CONVERT FLOATING POINT TO FIXED POINT VALUES                        05700021
*   TEST FLOATING POINT INPUT VALIDITY                                  05720021
*   VALREG CONTAINS THE VALUE TO BE CONVERTED                           05740021
FIXCONV  ST    VALREG,0(WKAREG)         STORE FLT VAL IN WORKAREA       05760021
         LE    6,0(WKAREG)              LOAD VALUE TO FLOAT REG         05780021
         N     VALREG,FCHAR             CHECK  CHARACTERISTIC           05800021
         BE    FLERR1                   POSSIBLE ERROR                  05820021
FCHECOK  AU    6,X6                     ADD EXPONENT TO FLOAT REG       05840021
         STE   6,0(WKAREG)              STORE CONV IN WORKAREA          05860021
         L     VALREG,0(WKAREG)         LOAD TO GR                      05880021
         N     VALREG,XZERO             DROP CHARACTERISTIC             05900021
         LTR   VALREG,VALREG            IS VAL NEGATIVE                 05920021
         BNL   NOTNEG                                                   05940021
         N     VALREG,NSIGN             DROP SIGN                       05960021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLIMENT           05980021
NOTNEG   BR    LINREG                   RETURN TO NSI AFTER BAL         06000021
FLERR1   CE    6,ZERO                   IS VAL ZERO                     06020021
         BE    FCHECOK                                                  06040021
         B     ERR12RET                                                 06060021
SCALFLT  LA    CONREG,4                 LOOP  COUNT                     06080021
         LA    INXREG,0                 SET INDEX                       06100021
         LA    WRKREG,0                                                 06120021
FLTLOOP  LH    VALREG,X1(INXREG)        GET X1,Y1,X2,Y2 VALUES          06140021
         BAL   LINREG,FLTCONV                                           06160021
         ST    VALREG,4(WKAREG,WRKREG)                                  06180021
         A     INXREG,TWO                                               06200021
         A     WRKREG,FOUR                                              06220021
         BCT   CONREG,FLTLOOP                                           06240021
*    FLOATING POINT SPECIFIED - TEST FOR CHARACTERISTIC ZERO AND        06260021
*    FRACTION NON ZERO. OF ALL U,V VALUES                               06280021
         L     VALREG,U1                                                06300021
         BAL   LINREG,FIXCONV                                           06320021
         L     VALREG,U2                                                06340021
         BAL   LINREG,FIXCONV                                           06360021
         L     VALREG,V1                                                06380021
         BAL   LINREG,FIXCONV                                           06400021
         L     VALREG,V2                                                06420021
         BAL   LINREG,FIXCONV                                           06440021
         L     VALREG,UI                                                06460021
         BAL   LINREG,FIXCONV                                           06480021
         L     VALREG,VC                                                06500021
         BAL   LINREG,FIXCONV                                           06520021
         EJECT                                                          06540021
*   SUBROUTINE TO SCALE FLOATING POINT VALUES                           06560021
*   SCALED  U,V VALUES LOADED IN XREG AND YREG                          06580021
FLTSCAL  CLI   TYPE,C'X'                                                06600021
         BE    FLTSCALX                                                 06620021
*   (Y2-Y1)*VI/V2-V1)= SCALED INCREMENT (YINC)                          06640021
*   (UC-U1)*(X2-X1)/(U2-U1)+X1=XC                                       06660021
         LE    0,16(WKAREG)             Y2                              06680021
         SE    0,8(WKAREG)              -Y1                             06700021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    06720021
         ME    0,VI                     *VI                             06740021
         LE    2,V2                     V2                              06760021
         SE    2,V1                     -V1                             06780021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    06800021
         DER   0,2                                                      06820021
         STE   0,0(WKAREG)                                              06840021
         L     XREG,0(WKAREG)           XREG CONTAINS SCALED FP WI      06860021
         LE    0,UC                     UC                              06880021
         SE    0,U1                       -U1                           06900021
         LE    2,12(WKAREG)             X2                              06920021
         SE    2,4(WKAREG)                -X1                           06940021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    06960021
         MER   0,2                                                      06980021
         LE    2,U2                     U2                              07000021
         SE    2,U1                       -U1                           07020021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    07040021
         DER   0,2                                                      07060021
         AE    0,4(WKAREG)              +X1                             07080021
         STE   0,0(WKAREG)                                              07100021
         L     YREG,0(WKAREG)           SCALED FLOATING UC IN YREG      07120021
         B     FCONVERT                                                 07140021
*   (X2-X1)*UI/U2-U1)= SCALED INCREMENT (XINC)                          07160021
*   (VC-V1)*(Y2-Y1)/(V2-V1)+Y1=YC                                       07180021
FLTSCALX LE    0,12(WKAREG)             X2                              07200021
         SE    0,4(WKAREG)              -X1                             07220021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    07240021
         ME    0,UI                     *UI                             07260021
         LE    2,U2                     U2                              07280021
         SE    2,U1                     -U1                             07300021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    07320021
         DER   0,2                                                      07340021
         STE   0,0(WKAREG)                                              07360021
         L     XREG,0(WKAREG)           XREG CONTAINS SCALED FP UI      07380021
         LE    0,VC                     VC                              07400021
         SE    0,V1                       -V1                           07420021
         LE    2,16(WKAREG)             Y2                              07440021
         SE    2,8(WKAREG)                -Y1                           07460021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    07480021
         MER   0,2                                                      07500021
         LE    2,V2                     V2                              07520021
         SE    2,V1                       -V1                           07540021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    07560021
         DER   0,2                                                      07580021
         AE    0,8(WKAREG)              +Y1                             07600021
         STE   0,0(WKAREG)                                              07620021
         L     YREG,0(WKAREG)           SCALED FLOATING VAL VC IN YREG  07640021
         B     FCONVERT                                                 07660021
         EJECT                                                          07680021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  VALUES                 07700021
*    TEST FLOATING POINT INPUT VALIDITY                                 07720021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED                          07740021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   07760021
         ST    VALREG,0(WKAREG)                                         07780021
         LE    0,0(WKAREG)              LOAD FLOATING PT REG            07800021
         AE    0,X6                     NORMALIZE                       07820021
         STE   0,0(WKAREG)                                              07840021
         L     VALREG,0(WKAREG)         FLOAT PT VAL IN VALREG          07860021
         BR    LINREG                                                   07880021
         EJECT                                                          07900021
*   SUBROUTINE TO SCALE   FIXED  POINT  VALUES                          07920021
*   SCALED  U,V VALUES LOADED IN  XREG AND YREG  (FIXED POINT)          07940021
FIXSCAL  CLI   TYPE,C'X'                                                07960021
         BE    FIXSCALX                                                 07980021
*   (Y2-Y1)*VI/V2-V1)= SCALED INCREMENT (YINC)                          08000021
*   (UC-U1)*(X2-X1)/(U2-U1)+X1=XC                                       08020021
         LH    ODDREG,Y2                Y2                              08040021
         SH    ODDREG,Y1                -Y1                             08060021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    08080021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   08100021
         MR    EVEREG,XREG              *VI                             08120021
         L     XREG,V2                  V2                              08140021
         S     XREG,V1                    -V1                           08160021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    08180021
         SR    EVEREG,EVEREG                                            08200021
         DR    EVEREG,XREG                                              08220021
         LR    XREG,ODDREG              YINC IN XREG                    08240021
         S     YREG,U1                  UC-U1                           08260021
         LR    ODDREG,YREG                                              08280021
         LH    YREG,X2                  X2                              08300021
         SH    YREG,X1                    -X1                           08320021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    08340021
         SR    EVEREG,EVEREG                                            08360021
         MR    EVEREG,YREG                                              08380021
         L     YREG,U2                  U2                              08400021
         S     YREG,U1                    -U1                           08420021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    08440021
         SR    EVEREG,EVEREG                                            08460021
         DR    EVEREG,YREG                                              08480021
         AH    ODDREG,X1                +X1                             08500021
         LR    YREG,ODDREG              SCALED VC IN YREG               08520021
         B     TESTUV                                                   08540021
*   (X2-X1)*UI/U2-U1)= SCALED INCREMENT (XINC)                          08560021
*   (VC-V1)*(Y2-Y1)/(V2-V1)+Y1=YC                                       08580021
FIXSCALX LH    ODDREG,X2                                                08600021
         SH    ODDREG,X1                -X1                             08620021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    08640021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   08660021
         MR    EVEREG,XREG              * UI                            08680021
         L     XREG,U2                  U2                              08700021
         S     XREG,U1                                                  08720021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    08740021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   08760021
         DR    EVEREG,XREG                                              08780021
         LR    XREG,ODDREG              SCALED U VALUE IN XREG          08800021
         S     YREG,V1                  VC                              08820021
         LR    ODDREG,YREG                                              08840021
         LH    YREG,Y2                  Y2                              08860021
         SH    YREG,Y1                    -Y1                           08880021
         BC    13,ERR4RET               BRANCH ON OVF, MINUS OR ZERO    08900021
         SR    EVEREG,EVEREG                                            08920021
         MR    EVEREG,YREG                                              08940021
         L     YREG,V2                  V2                              08960021
         S     YREG,V1                    -V1                           08980021
         BC    13,ERR16RET              BRANCH ON OVF, MINUS OR ZERO    09000021
         SR    EVEREG,EVEREG                                            09020021
         DR    EVEREG,YREG                                              09040021
         AH    ODDREG,Y1                                                09060021
         LR    YREG,ODDREG                                              09080021
         B     TESTUV                                                   09100021
         EJECT                                                          09120021
* STORE GRAPHIC DATA IN GDOA FOR POR                                    09140021
* INPUT TO SUBROUTINE                                                   09160021
*   CNTREG = NUMBER OF BYTES OF GRAPHIC DATA TO STORE                   09180021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA                                09200021
*   WKAREG = REGISTER 1 MUST CONTAIN THE WORKAREA ADDRESS               09220021
*   OABREG = ADDRESS OF OACB                                            09240021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   09260021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        09280021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              09300021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 09320021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        09340021
         LA    TEMREG,4                                                 09360021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               09380021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    09400021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       09420021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       09440021
         CR    TEMREG,SLOREG                                            09460021
         BNH   OK                       ROOM FOR DATA                   09480021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    09500021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         09520021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       09540021
* ANY BYTES TO STORE                                                    09560021
         C     WRKREG,ZERO                                              09580021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           09600021
         LH    TEMREG,H2A02                                             09620021
         CH    TEMREG,GOMODE                                            09640021
         BH    STORE3A                                                  09660021
         LH    TEMREG,H0003                                             09680021
         NR    TEMREG,WRKREG                                            09700021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (HALA)      7468 09720021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      09740021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 09760021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              09780021
* STORE REGISTERS IN WORKAREA                                           09800021
         STM   0,15,0(WKAREG)           SAVE REGISTERS IN WORKAREA      09820021
         L     15,8(0,OABREG)           OVER FLOW ADDRESS               09840021
         LM    2,12,28(13)              RELOAD USER'S REGISTERS         09860021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      09880021
         LM    0,15,0(WKAREG)           RELOAD FROM WORKAREA            09900021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    09920021
* NO SPACE AVAILABLE                                                    09940021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 09960021
         BL    STORE3                   NO                              09980021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          10000021
         B     ERR24RET                                                 10020021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 10040021
         BR    LINREG                                                   10060021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           10080021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      10100021
         BH    STORE7                   YES                             10120021
         LR    TEMREG,WRKREG                                            10140021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       10160021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               10180021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              10200021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                10220021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           10240021
         BR    INTLNK                   RETURN INTERNALLY               10260021
STORE7   LR    SLOREG,TEMREG                                            10280021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       10300021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               10320021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              10340021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            10360021
         SR    WRKREG,TEMREG           REDUCE BY 255                    10380021
         B     STORE6A                  MAKE NEXT COMPARISON            10400021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               10420021
         EJECT                                                          10440021
ZERO     DC    F'0'                                                     10460021
ONE      DC    F'1'                                                     10480021
TWO      DC    F'2'                                                     10500021
HIGH     DC    F'4095'                                                  10520021
FOUR     DC    F'4'                                                     10540021
H2A02    DC    X'2A02'                                                  10560021
H0003    DC    H'0003'                                                  10580021
FCHAR    DC    X'7F000000'                                              10600021
XZERO    DC    X'80FFFFFF'                   SIGN AND VALUE -DROP E     10620021
X6       DC    X'46000000'                   EXPONENT OF SIX            10640021
NSIGN    DC    X'7FFFFFFF'                   DROP SIGN -RETAIN VALUE    10660021
MZERO    DC    X'80000000'                                              10680021
GEVM     DC    X'2A02'                                                  10700021
GFSCB    DC    X'2A40'                                                  10720021
GFSCL    DC    X'2A41'                                                  10740021
PASREG   EQU   0                                                        10760021
WKAREG   EQU   1                                                        10780021
OBPREG   EQU   2                                                        10800021
OABREG   EQU   2                                                        10820021
PATREG   EQU   3                                                        10840021
XYLREG   EQU   4                                                        10860021
XREG     EQU   5                                                        10880021
SLOREG   EQU   5                                                        10900021
YREG     EQU   6                                                        10920021
INTLNK   EQU   6                                                        10940021
WRKREG   EQU   7                                                        10960021
CNTREG   EQU   8                                                        10980021
INXREG   EQU   10                                                       11000021
OLPREG   EQU   10                                                       11020021
EVEREG   EQU   10                                                       11040021
ODDREG   EQU   11                                                       11060021
VALREG   EQU   11                                                       11080021
TEMREG   EQU   11                                                       11100021
LINREG   EQU   12                                                       11120021
CONREG   EQU   14                                                       11140021
ADDREG   EQU   14                                                       11160021
         EJECT                                                          11180021
PARTAB   DSECT                                                          11200021
XYLIM    DS    CL4                                                      11220021
UI       DS    CL4                                                      11240021
         ORG   UI                                                       11260021
VI       DS    CL4                                                      11280021
UC       DS    CL4                                                      11300021
         ORG   UC                                                       11320021
VC       DS    CL4                                                      11340021
F        DS    CL1                                                      11360021
S        DS    CL1                                                      11380021
SIZE     DS    CL1                                                      11400021
TYPE     DS    CL1                                                      11420021
DATA     DS    CL4                                                      11440021
FLENGTH  DS    CL2                                                      11460021
LGAP     DS    CL2                                                      11480021
LTICK    DS    CL2                                                      11500021
*                                                                       11520021
XYLIMT   DSECT                                                          11540021
X1       DS    CL2                                                      11560021
Y1       DS    CL2                                                      11580021
X2       DS    CL2                                                      11600021
Y2       DS    CL2                                                      11620021
U1       DS    CL4                                                      11640021
U2       DS    CL4                                                      11660021
V1       DS    CL4                                                      11680021
V2       DS    CL4                                                      11700021
*                                                                       11720021
WRKAREA  DSECT                                                          11740021
OVFSAVE  DS    CL64                                                     11760021
PORSAVE  DS    CL64                                                     11780021
ADDRESS  DS    CL4                                                      11800021
ERRCOUNT DS    CL4                                                      11820021
XI       DS    CL2                                                      11840021
YI       DS    CL2                                                      11860021
XS       DS    CL2                                                      11880021
YS       DS    CL2                                                      11900021
XE       DS    CL2                                                      11920021
YE       DS    CL2                                                      11940021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    11960021
         ORG   OVFSAVE+396                                              11980021
GOMODE   DS    CL2                                                      12000021
         END                                                            12020021
./  ADD  SSI=20480477,NAME=IFFPIAPG
         TITLE 'GPGRID -  POINT POLAR GRID GENEREATION ROUTINE'         00020021
*                                                                       00040021
*                                                                       00060021
*   STATUS.              CHANGE LEVEL 0.                                00080021
*                                                                       00100021
*   FUNCTION/OPERATION.  GPGRID GENERATES THE GRAPHIC ORDERS TO DISPLAY 00120021
*                        A SET OF CONCENTRIC CIRCLES, DIVIDED INTO      00140021
*                        EQUAL SECTORS BY A NUMBER OF RADIAL VECTORS.   00160021
*                        THE SPACING BETWEEN THE CIRCLES MAY BE LINEAR  00180021
*                        OR LOGARITHMIC.  THIS ROUTINE PROVIDES THE     00200021
*                        GRAPHIC ORDERS TO  DISPLAY  POINTS ON THE      00220021
*                        PERIMETERS OF THE CIRCLES.                     00240021
*                                                                       00260021
*   ENTRY POINTS.        GPGRID VIA CALL OR LINK MACRO.                 00280021
*                        ALIAS NAME - IFFPIAPG                          00300021
*                                                                       00320021
*   INPUT.               OUTPUT CONTROL BLOCK POINTER (OACB).           00340021
*                        PARAMETER TABLE WHICH DEFINES THE POSITION,    00360021
*                        SIZE, AND TYPE OF POLAR GRID.                  00380021
*                                                                       00400021
*   OUTPUT.              GRAPHIC ORDERS STORED IN THE GDOA.             00420021
*                                                                       00440021
*   EXTERNAL ROUTINES.   GOFFSG - OFF SCREEN OFF GRID ROUTINE.          00460021
*                                                                       00480021
*   EXITS-NORMAL.        COMPLETION OF TASK. EXIT VIA RETURN MACRO.     00500021
*        -ERROR.         IMMEDIATE RETURN. EXIT VIA RETURN MACRO.       00520021
*                        HEXADECIMAL 4,8,C,10,14, OR 18 IN RET CODE REG 00540021
*        -ERROR.         DOES NOT RETURN IMMEDIATELY. COMPLETION OF     00560021
*                        TASK AND RETURN VIA RETURN MACRO.              00580021
*                        HEXADECIMAL 28 IN RETURN CODE REGISTER.        00600021
*                                                                       00620021
*   TABLES/WORK AREAS.   USER SPECIFIED PARAMETER TABLE, XYLIM TABLE    00640021
*                        AND WORK AREA.                                 00660021
*                                                                       00680021
*   ATTRIBUTER.          READ ONLY. REENTRANT.                          00700021
         EJECT                                                          00720021
IFFPIAPG CSECT                          GPGRID                          00740021
*0669                                                              7468 00750021
         ENTRY GPGRID                                                   00760021
PASREG   EQU   0                                                        00780021
WKAREG   EQU   1                        WORK AREA ADDRESS REGISTER      00800021
PARREG   EQU   1                                                        00820021
OBPREG   EQU   2                        CONTROL BLOCK POINTER ADDR REG  00840021
OABREG   EQU   2                        CONTROL BLOCK ADDRESS REGISTER  00860021
PATREG   EQU   3                        ADDRESS OF PARAMETER TABLE      00880021
XYLREG   EQU   4                        ADDRESS OF XYLIM TABLE          00900021
XREG     EQU   5                        X-COMPUTING REGISTER            00920021
SLOREG   EQU   5                        SLOA ADDRESS REGISTER           00940021
COSREG   EQU   5                        COSINE REGISTER                 00960021
SINREG   EQU   6                        SINE REGISTER                   00980021
YREG     EQU   6                        Y-COMPUTING REGISTER            01000021
INTLNK   EQU   6                        INTERNAL POR LINK REGISTER      01020021
INDEXREG EQU   7                        INDEX REGISTER                  01040021
WRKREG   EQU   7                        WORK REGISTER                   01060021
CNTREG   EQU   8                        COUNT REGISTER                  01080021
LINKREG  EQU   8                        INTERNAL POR LINK REGISTER      01100021
BASE9    EQU   9                        BASE REGISTER FOR GPGRID        01120021
INXREG   EQU   10                       INDEX AND POR LINK REGISTER     01140021
OLPREG   EQU   10                       ORDER LOAD POINT ADDRESS        01160021
EVEREG   EQU   10                       ARITHMETIC WORK REGISTER        01180021
ODDREG   EQU   11                       ARITHMETIC WORK REGISTER        01200021
VALREG   EQU   11                       WORK REGISTER                   01220021
TEMREG   EQU   11                       WORK REGISTER                   01240021
LINREG   EQU   12                       INTERNAL POR LINK REGISTER      01260021
ADDREG   EQU   14                       GENERAL USE ADDRESS REGISTER    01280021
CONREG   EQU   14                       CONTROL COUNT REGISTER          01300021
ERREG    EQU   15                       ERROR CODE REGISTER             01320021
         EJECT                                                          01340021
*************************                                               01360021
*   INITIALIZATION      *                                               01380021
*************************                                               01400021
GPGRID   STM   14,12,12(13)                                             01420021
         BALR  BASE9,0                                                  01440021
         USING *,BASE9                                                  01460021
         USING PARTAB,PATREG                                            01480021
         USING WKAREA,WKAREG                                            01500021
         USING XYLIMT,XYLREG                                            01520021
         SR    ERREG,ERREG                                              01540021
         LM    OBPREG,PATREG,0(PARREG)  LOAD OCBP AND PARTAB ADDRESSES. 01560021
         L     XYLREG,XYLIM             LOAD ADDR OF XYLIM TABLE.       01580021
         L     WKAREG,4(0,OBPREG)       LOAD ADDR OF USER WORK AREA.    01600021
         L     OABREG,0(0,OBPREG)       LOAD ADDR OF CONTROL BLOCK.     01620021
*  SAVE MASK BITS AS SET BY USER                                        01640021
         ST    9,MASKSV                                                 01660021
         SR    WRKREG,WRKREG                                            01680021
         SPM   WRKREG                                                   01700021
         BAL   LINREG,XYLCHK            LINK TO XYLIM CHECK             01720021
         MVC   ERCOUNT,ZERO         CLEAR ERROR COUNTER                 01740021
         MVI   LOADSW,X'00'                                             01760021
         MVI   SGSW,X'00'                                               01780021
         CLI   F,C'F'                   CHECK FOR FLOATING POINT VALUES 01800021
         BE    FLOAT                    BRANCH IF FIX FL OPTION = F     01820021
         CLI   F,C'B'                                                   01840021
         BE    CHKS                     IF F PARA NOT = F OR B,         01860021
         BAL   LINKREG,ER40             LINK TO SET ERROR CODE.         01880021
CHKS     CLI   S,C'S'                   CHECK IF SCALING REQUIRED.      01900021
         BE    LINK1                    SCALE FIXED POINT VALUES.       01920021
         MVC   RINK(4),RINC             STORE RINC AND MAX-RADIUS       01940021
         MVC   MAXR(4),MAXRAD           IN THE USER WORK AREA.          01960021
         MVC   XC(8),UC                 UC,VC TO USER WORK AREA.        01980021
TSTS     CLI   S,C'N'                                                   02000021
         BE    CHKPARA                  IF SCALE PARA NOT S OR N,       02020021
         BAL   LINKREG,ER40             LINK TO SET ERROR CODE.         02040021
         B     CHKPARA                                                  02060021
FLOAT    CLI   S,C'S'                                                   02080021
         BE    LINK2                                                    02100021
         CLI   S,C'N'                   IF SCALE PARA NOT S OR N,       02120021
         BE    LINK0                    LINK TO SET ERROR CODE.         02140021
         BAL   LINKREG,ER40                                             02160021
LINK0    L     VALREG,UC                CONVERT UC,VC,RINC AND          02180021
         BAL   LINKREG,FCONVERT         MAX-RADIUS TO FIXED POINT.      02200021
         ST    VALREG,XC                                                02220021
         L     VALREG,VC                                                02240021
         BAL   LINKREG,FCONVERT                                         02260021
         ST    VALREG,YC                                                02280021
         L     VALREG,RINC                                              02300021
         BAL   LINKREG,FCONVERT                                         02320021
         ST    VALREG,RINK                                              02340021
         L     VALREG,MAXRAD                                            02360021
         BAL   LINKREG,FCONVERT                                         02380021
         ST    VALREG,MAXR                                              02400021
         B     CHKPARA                                                  02420021
LINK1    L     XREG,UC                  SCALE FIXED-POINT VALUES        02440021
         L     YREG,VC                  UC,VC,RINC,AND MAX-RADIUS.      02460021
         BAL   LINREG,SCALFIX                                           02480021
         ST    XREG,XC                                                  02500021
         ST    YREG,YC                                                  02520021
         L     XREG,RINC                                                02540021
         BAL   LINREG,FIXSCAL                                           02560021
         ST    XREG,RINK                                                02580021
         L     XREG,MAXRAD                                              02600021
         BAL   LINREG,FIXSCAL           BR TO SCALE MAXIMUM RADIUS.     02620021
         ST    XREG,MAXR                                                02640021
         B     CHKPARA                                                  02660021
LINK2    BAL   LINKREG,SCALFLT          SCALE FLOATING POINT VALUES     02680021
         MVC   VALUE1(4),RINC           UC,VC,RINC, AND MAXRAD.         02700021
         BAL   LINKREG,FLTSCAL                                          02720021
         ST    VALREG,RINK              STORE SCALED VALUES IN          02740021
         MVC   VALUE1(4),MAXRAD         XC,YC,RINK, AND MAXR.           02760021
         BAL   LINKREG,FLTSCAL                                          02780021
         ST    VALREG,MAXR                                              02800021
******************************                                          02820021
*   CHECK PARAMETER TABLE    *                                          02840021
******************************                                          02860021
CHKPARA  LM    XREG,YREG,XC             CHECK INPUT PARAMETERS.         02880021
         C     XREG,ZERO                IF XC IS LESS THAN ZERO,        02900021
         BL    ER8                      BR TO SET ERROR CODE & RETURN.  02920021
         C     XREG,C4095               IF XC IS GREATER THAN 4095,     02940021
         BH    ER8                      BR TO SET ERROR CODE & RETURN.  02960021
         C     YREG,ZERO                IF YC IS LESS THAN ZERO,        02980021
         BL    ER8                      BR TO SET ERROR CODE & RETURN.  03000021
         C     YREG,C4095                                               03020021
         BH    ER8                                                      03040021
         L     WRKREG,MAXR              CHECK MAXR AND RINK             03060021
         C     WRKREG,FOUR              TO SEE IF GT FOUR.              03080021
         BL    ER20                     SET ERROR CODE AND RET IF NOT.  03100021
         L     WRKREG,RINK                                              03120021
         C     WRKREG,FOUR                                              03140021
         BL    ER20                                                     03160021
         MVC   R(4),RINK                                                03180021
         CLI   TYPE,C'A'                                                03200021
         BE    TSTINC                                                   03220021
         CLI   TYPE,C'B'                IF TYPE NOT A OR B,             03240021
         BNE   ER20                     SET ERROR CODE AND RETURN.      03260021
RLOG     MVI   J,X'01'                  LOG GRID REQUESTED. SET J=1.    03280021
         MVC   LOGSAV(2),MINUS2                                         03300021
TSTINC   CLI   INC,C'A'                 CHECK PARAMETER INC TO SEE      03320021
         BE    SETA                     IF ALPHA OR DENSITY IS SPEC.    03340021
         CLI   INC,C'D'                                                 03360021
         BE    SETD                                                     03380021
SETC     BAL   LINKREG,ER40             IF INC NOT A OR D, SET INTERNAL 03400021
         MVI   INK,C'C'                 INDICATOR TO C, ERROR CODE TO   03420021
         B     AOK                      40 AND CONTINUE PROCESSING.     03440021
SETA     LH    WRKREG,ALPHA             ALPHA SPECIFIED.                03460021
         CH    WRKREG,ZERO                                              03480021
         BL    SETC                                                     03500021
         BE    SETCC                                                    03520021
         CH    WRKREG,H360                                              03540021
         BNL   SETC                                                     03560021
         MVI   INK,C'A'                 ALPHA OK.                       03580021
         MVC   ALPH(2),ALPHA            MOVE ALPHA TO USER WORK AREA.   03600021
         B     AOK                                                      03620021
SETCC    MVI   INK,C'C'                                                 03640021
         B     AOK                                                      03660021
SETD     LH    WRKREG,DENSITY           DENSITY SPECIFIED.              03680021
         CH    WRKREG,FOUR                                              03700021
         BL    SETC                                                     03720021
         MVI   INK,C'D'                                                 03740021
AOK      LA    CNTREG,2                 LENGTH OF GEPM ORDER TO CNTREG. 03760021
         LA    ADDREG,GEPM              ADDR OF GEPM ORDER TO ADDREG.   03780021
         MVC   GOMODE,GEPM                                              03800021
         BAL   LINREG,STORE             LINK TO STORE GEPM ORDER.       03820021
         MVC   I(4),ONE                 SET I=1.                        03840021
         EJECT                                                          03860021
TESTINC  CLI   INK,C'C'                 IF INK=C, COMPUTE ALPHA=2048/R  03880021
         BE    COMPA                                                    03900021
         CLI   INK,C'D'                 IF INK NOT D, INK=A.            03920021
         BNE   SETNPT                                                   03940021
**************************************************                      03960021
* COMPUTE  TEMP=360*DENSITY/(2PI*R)              *                      03980021
*          ALPHA=INTEGRAL PART OF (TEMP+0.5)     *                      04000021
**************************************************                      04020021
ALPHAGET L     EVEREG,C360                                              04040021
         MH    EVEREG,DENSITY           COMPUTE 360*DENSITY             04060021
         SRDA  EVEREG,32                                                04080021
         SLDA  EVEREG,29                                                04100021
         D     EVEREG,TWOPI             COMPUTE 360*DENSITY/2PI         04120021
         SR    EVEREG,EVEREG                                            04140021
         L     WRKREG,R                                                 04160021
         DR    EVEREG,WRKREG            COMPUTE ALPHA=360*DENSITY/2PI/R 04180021
         A     ODDREG,ONE                                               04200021
         SRA   ODDREG,1                                                 04220021
         STH   ODDREG,ALPH              STORE ALPHA IN USER WORK AREA.  04240021
CHKA1    CLC   ALPH(2),ZERO                                             04260021
         BH    CHKA2                                                    04280021
SETALP   MVC   ALPH(2),ONE+2            SET ALPHA = 1                   04300021
         B     SETNPT                                                   04320021
CHKA2    CLC   ALPH(2),H360                                             04340021
         BL    SETNPT                                                   04360021
         BAL   LINKREG,ER40                                             04380021
******************************                                          04400021
*   COMPUTE ALPHA=2048/R     *                                          04420021
******************************                                          04440021
COMPA    CLC   R(4),C1365               IF R IS GT 1365,                04460021
         BH    SETALP                   BR TO SET ALPHA TO ONE.         04480021
         CLC   R+2(2),C46               IF R IS LESS THAN 46,           04500021
         BL    SETA45                   SET ALPHA = 45.                 04520021
         LA    EVEREG,2048              IF NOT, COMPUTE ALPHA.          04540021
         SRDA  EVEREG,32                                                04560021
         SLDA  EVEREG,1                                                 04580021
         D     EVEREG,R                                                 04600021
         A     ODDREG,ONE                                               04620021
         SRA   ODDREG,1                                                 04640021
         STH   ODDREG,ALPH              STORE ALPHA IN USER WORK AREA.  04660021
         B     SETNPT                                                   04680021
SETA45   MVC   ALPH(2),C45                                              04700021
         B     SETNPT                                                   04720021
GETR     STH   INDEXREG,LOGSAV                                          04740021
         SR    EVEREG,EVEREG            COMPUTE  R=RINC*(I-1+LOG(J))    04760021
         L     EVEREG,I                 EVEREG=I                        04780021
         SH    EVEREG,ONE+2             EVEREG=I-1                      04800021
         SLA   EVEREG,14                                                04820021
         AH    EVEREG,LOGJ(INDEXREG)    EVEREG=I-1+LOG(J)               04840021
         SRDA  EVEREG,32                                                04860021
         M     EVEREG,RINK              EVEREG=R=RINC*(I-1+LOG(J))      04880021
         AH    ODDREG,POINT5                                            04900021
         SRA   ODDREG,14                REMOVE DECIMAL PORTION OF R     04920021
         ST    ODDREG,R                 AND STORE IN USER WORK AREA.    04940021
         BR    LINKREG                                                  04960021
SETNPT   MVC   K(2),ZERO                                                04980021
         LA    EVEREG,360               SET NPT EQ TO INTEGRAL          05000021
         SRDA  EVEREG,32                PART OF 360/ALPHA.              05020021
         LH    XREG,ALPH                                                05040021
         DR    EVEREG,XREG                                              05060021
         STH   ODDREG,NPT               NPT=THE # OF POINTS PER CIRCLE. 05080021
         CLC  R(4),C5793                SEE IF ALL POINTS WITH CURRENT  05100021
         BNH   SETPHI                   RADIUS WILL BE OUTSIDE SCREEN.  05120021
         MVC   K(2),NPT                                                 05140021
         B     OFFSCR                   BR TO CHECK OFF SCREEN OPTION.  05160021
SETPHI   LH    ODDREG,K                 SET PHI=K*ALPHA                 05180021
         MH    ODDREG,ALPH                                              05200021
         STH   ODDREG,PHI               STORE VALUE IN USER WRK AREA.   05220021
         EJECT                                                          05240021
***********************************                                     05260021
*   DETERMINE QUADRANT OF PHI.    *                                     05280021
*   GET SIN%PHI< AND COS%PHI<     *                                     05300021
*   FROM SINE/COSINE TABLE.       *                                     05320021
***********************************                                     05340021
         CLC   PHI(2),C90               CHECK IF PHI IN 1'ST QUADRANT.  05360021
         BH    CK180                    IF NOT, CHECK QUADRANT 2.       05380021
         CLC   PHI(2),C46                                               05400021
         BL    TBLOK                                                    05420021
         MVI   FUNCSW,X'0F'             PHI IN RANGE OF 46-90 DEG.      05440021
         LA    WRKREG,90                                                05460021
         B     LOOKUP1                  GO TO EXTRACT SIN(PHI),COS(PHI) 05480021
TBLOK    MVI   FUNCSW,X'00'             PHI IN RANGE OF 0-45 DEG.       05500021
         LA    WRKREG,0                                                 05520021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 05540021
CK180    CLC   PHI(2),C180              CHECK IF PHI IN 2'ND QUADRANT   05560021
         BH    CK270                    IF NOT, CHECK QUADRANT 3.       05580021
         CLC   PHI(2),C136                                              05600021
         BL    PHI180                                                   05620021
         MVI   FUNCSW,X'30'             PHI IN RANGE OF 136-180 DEG.    05640021
         LA    WRKREG,180                                               05660021
         B     LOOKUP1                  GO TO EXTRACT SIN(PHI),COS(PHI) 05680021
PHI180   MVI   FUNCSW,X'3F'             PHI IN RANGE OF 91-135 DEG.     05700021
         LA    WRKREG,90                                                05720021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 05740021
CK270    CLC   PHI(2),C270              CHECK IF PHI IN 3'RD QUAD.      05760021
         BH    CK315                    IF NOT, PHI IN QUADRANT 4.      05780021
         CLC   PHI(2),C226                                              05800021
         BL    PHI270                                                   05820021
         MVI   FUNCSW,X'FF'             PHI IN RANGE OF 226-270 DEG.    05840021
         LA    WRKREG,270                                               05860021
         B     LOOKUP1                  GO TO EXTRACT SIN(PHI),COS(PHI) 05880021
PHI270   MVI   FUNCSW,X'F0'             PHI IN RANGE OF 181-225 DEG.    05900021
         LA    WRKREG,180                                               05920021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 05940021
CK315    CLC   PHI(2),C315                                              05960021
         BH    PHI360                                                   05980021
         MVI   FUNCSW,X'CF'             PHI IN RANGE OF 271-315 DEG.    06000021
         LA    WRKREG,270                                               06020021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 06040021
PHI360   CLC   PHI(2),H360                                              06060021
         BNL   OMIT                                                     06080021
         MVI   FUNCSW,X'C0'             PHI IN RANGE OF 316-360 DEG.    06100021
         LA    WRKREG,360                                               06120021
         B     LOOKUP1                                                  06140021
LOOKUP1  SH    WRKREG,PHI                                               06160021
         LR    INXREG,WRKREG                                            06180021
         B     EXTRACT                                                  06200021
LOOKUP2  LH    INXREG,PHI                                               06220021
         SR    INXREG,WRKREG                                            06240021
EXTRACT  MH    INXREG,FOUR+2                                            06260021
         TM    FUNCSW,X'0F'             IF FUNCSW=0F, GO TO PUT COS     06280021
         BO    SWITCH                   IN SINREG AND SIN IN COSREG.    06300021
         LH    SINREG,SINE(INXREG)      LOAD SINE TO SINREG.            06320021
         LH    COSREG,COSINE(INXREG)    LOAD COSINE TO COSREG.          06340021
         B     TSIGNS                   GO TO TEST SIGN OF FUNCTIONS.   06360021
SWITCH   LH    SINREG,COSINE(INXREG)    LOAD COSINE TO SINREG.          06380021
         LH    COSREG,SINE(INXREG)      LOAD SINE TO COSREG.            06400021
TSIGNS   TM    FUNCSW,X'C0'             SEE IF SIGN OF SINE IS MINUS.   06420021
         BZ    TSIGNC                                                   06440021
         MH    SINREG,MINUS1                                            06460021
TSIGNC   TM    FUNCSW,X'30'             SEE IF SIGN OF COSINE IS MINUS. 06480021
         BZ    MULTR                                                    06500021
         MH    COSREG,MINUS1                                            06520021
         EJECT                                                          06540021
**************************************************                      06560021
*   COMPUTE  X=XC+R*COS(PHI) AND Y=YC+R*SIN(PHI) *                      06580021
**************************************************                      06600021
MULTR    LR    EVEREG,COSREG            LOAD COS(PHI)                   06620021
         SRDA  EVEREG,32                                                06640021
         M     EVEREG,R                 R*COS(PHI)                      06660021
         L     COSREG,XC                                                06680021
         SLA   COSREG,14                                                06700021
         AR    COSREG,ODDREG            XC+R*COS(PHI)                   06720021
         AH    COSREG,POINT5                                            06740021
         SRA   COSREG,14                SHIFT OFF DECIMAL PORTION OF X. 06760021
         LR    EVEREG,SINREG            LOAD SIN(PHI)                   06780021
         SRDA  EVEREG,32                                                06800021
         M     EVEREG,R                 R*SIN(PHI)                      06820021
         L     SINREG,YC                                                06840021
         SLA   SINREG,14                                                06860021
         AR    SINREG,ODDREG            YC+R*SIN(PHI)                   06880021
         AH    SINREG,POINT5                                            06900021
         SRA   SINREG,14                SHIFT OFF DECIMAL PORTION OF Y. 06920021
****************************************                                06940021
*   XREG=COSREG=X   YREG=SINREG=Y      *                                06960021
****************************************                                06980021
OFFCHECK BAL   LINKREG,CHKOFF           LINK TO OFF GRID/SCREEN CHECK.  07000021
         B     OFFGRD                   IF POINT OFF GRID.              07020021
         B     OFFSCR                   IF POINT OFF SCREEN.            07040021
         B     CONT                     IF POINT OK.                    07060021
CHKOFF   CH    XREG,H4095               TEST X- AND Y-COORDINATES       07080021
         BH    4(0,LINKREG)             TO SEE IF OFF-SCREEN/GRID.      07100021
         CH    XREG,ZERO                                                07120021
         BL    4(0,LINKREG)                                             07140021
         CH    YREG,H4095                                               07160021
         BH    4(0,LINKREG)                                             07180021
         CH    YREG,ZERO                                                07200021
         BL    4(0,LINKREG)                                             07220021
         CH    XREG,X1                                                  07240021
         BL    0(0,LINKREG)                                             07260021
         CH    XREG,X2                                                  07280021
         BH    0(0,LINKREG)                                             07300021
         CH    YREG,Y1                                                  07320021
         BL    0(0,LINKREG)                                             07340021
         CH    YREG,Y2                                                  07360021
         BH    0(0,LINKREG)                                             07380021
         B     8(0,LINKREG)                                             07400021
OFFGRD   BAL   LINKREG,TSTGR            LINK TO TEST USER OPTION.       07420021
         B     OMIT                       IF OPTION = A OR C.           07440021
         TM    SGSW,X'F0'                                               07460021
         BO    PT2ON                                                    07480021
         B     CONT                       IF OPTION = B,E, OR INVALID.  07500021
TSTGR    CLI   OFFSG,C'A'                                               07520021
         BNE   GRDB                                                     07540021
         BAL   LINREG,ER44              OMIT POINT AND SET ERROR CODE   07560021
         BR    LINKREG                  IF S/G OPTION=A.                07580021
GRDB     CLI   OFFSG,C'B'               SHOW POINT IF S/G-OPTION=B      07600021
         BE    4(0,LINKREG)                                             07620021
GRDC     CLI   OFFSG,C'C'               OMIT POINT IF S/G OPTION=C      07640021
         BE    0(0,LINKREG)                                             07660021
GRDD     CLI   OFFSG,C'D'                                               07680021
         BNE   GRDE                                                     07700021
         LA    LINREG,RET               SET ERROR CODE AND RETURN TO    07720021
         B     ER28                     CALLING PROG IF S/G OPTION=D    07740021
GRDE     CLI   OFFSG,C'E'                                               07760021
         BE    4(0,LINKREG)             OMIT POINT IF S/G OPTION=E      07780021
         LR    TEMREG,LINKREG                                           07800021
         BAL   LINKREG,ER40             S/G OPTION INVALID.             07820021
         B     4(0,TEMREG)                                              07840021
OFFSCR   BAL   LINKREG,TSTSR            LINK TO TEST USER OPTION.       07860021
         B     OMIT                       IF OPTION = A OR B.           07880021
         B     OMIT                                                     07900021
TSTSR    CLI   OFFSG,C'A'                                               07920021
         BNE   SCRB                                                     07940021
         BAL   LINREG,ER44              OMIT POINT AND SET ERROR CODE   07960021
         B     4(0,LINKREG)             IF S/G OPTION=A.                07980021
SCRB     CLI   OFFSG,C'B'                                               08000021
         BNE   SCRC                                                     08020021
         BAL   LINREG,ER48              OMIT POINT AND SET ERROR CODE   08040021
         BR    LINKREG                  IF S/G OPTION=B.                08060021
SCRC     CLI   OFFSG,C'C'               SEE IF OPTION C                 08080021
         BNE   SCRD                                                     08100021
         LA    LINREG,RET                                               08120021
         B     ER32                                                     08140021
SCRD     CLI   OFFSG,C'D'                                               08160021
         BNE   SCRE                                                     08180021
         LA    LINREG,RET               SET ERROR CODE AND RETURN TO    08200021
         B     ER28                     CLLING PROG IF S/G OPTION=D     08220021
SCRE     LA    LINREG,RET                                               08240021
         B     ER32                     ERROR 32 ASSUMED.               08260021
CONT     STH   XREG,GDV1                STORE X-COORDINATE IN GDV.      08280021
         STH   YREG,GDV1+2              STORE Y-COORDINATE IN GDV.      08300021
         LA    CNTREG,4                 LENGTH OF GDV TO COUNT REG.     08320021
         LA    ADDREG,GDV1                                              08340021
         BAL   LINREG,STORE             LINK TO STORE GDV X,Y,U.        08360021
OMIT     CLC   NPT(2),K                 CHECK NO OF POINTS DRAWN        08380021
         BE    TSTGRD                   WITH NO OF POINTS PER CIRCLE.   08400021
         LH    EVEREG,K                 IF K AND NPT UNEQUAL, SET       08420021
         A     EVEREG,ONE               K=K+1 AND RETURN TO COMPUTE     08440021
         STH   EVEREG,K                 THE NEXT X,Y VALUES.            08460021
         B     SETPHI                                                   08480021
TSTGRD   CLI   TYPE,C'B'                                                08500021
         BNE   TESTI                    BRANCH IF LINEAR GRID.          08520021
         CLI   J,X'08'                                                  08540021
         BH    TESTI                                                    08560021
         SR    EVEREG,EVEREG                                            08580021
         IC    EVEREG,J                                                 08600021
         A     EVEREG,ONE               SET J=J+1                       08620021
         STC   EVEREG,J                                                 08640021
         LH    INDEXREG,LOGSAV          GET ADDRESS OF                  08660021
         A     INDEXREG,TWO             CURRENT LOG(J).                 08680021
         BAL   LINKREG,GETR                                             08700021
         B     TESTINC                                                  08720021
TESTI    SR    EVEREG,EVEREG                                            08740021
         L     EVEREG,I                 LOAD THE NO OF CIRCLES.         08760021
         A     EVEREG,ONE               SET I=I+1      I=# OF CIRCLES,  08780021
         ST    EVEREG,I                                OR LOG CYCLES.   08800021
         SRDA  EVEREG,32                                                08820021
         M     EVEREG,RINK              MULTIPLY I BY RINC.             08840021
         CL    ODDREG,MAXR              IF MAX-RADIUS IS LT I*RINC      08860021
         BH    TESTNR                   BR TO TEST THE NO OF RADII.     08880021
         ST    ODDREG,R                 NEW LOG CYCLE.                  08900021
         CLI   TYPE,C'B'                                                08920021
         BE    SETJ                                                     08940021
         B     TESTINC                                                  08960021
SETJ     MVI   J,X'01'                  SET J=1 AND                     08980021
         MVC   LOGSAV(2),MINUS2         RETURN TO GEN                   09000021
         B     TESTINC                  NEXT LOG CYCLE                  09020021
         EJECT                                                          09040021
TESTNR   CLC   NR(2),ZERO               IF NO RADII REQUESTED,          09060021
         BE    RET                      RETURN TO USER ROUTINE.         09080021
         LA    CNTREG,2                 LENGTH OF GEVM ORDER TO CNTREG. 09100021
         LA    ADDREG,GEVM              LOAD ADDR OF GEVM ORDER.        09120021
         MVC   GOMODE,GEVM                                              09140021
         BAL   LINREG,STORE             LINK TO STORE GEVM ORDER.       09160021
**************************************************                      09180021
*   COMPUTE END POINTS OF 90,0,180,& 270 DEG RAD *                      09200021
**************************************************                      09220021
         L     EVEREG,XC                                                09240021
         A     EVEREG,MAXR              VV1=XC+MAXR                     09260021
         ST    EVEREG,VV1                                               09280021
         L     EVEREG,XC                                                09300021
         S     EVEREG,MAXR              VV2=XC-MAXR                     09320021
         ST    EVEREG,VV2                                               09340021
         L     EVEREG,YC                                                09360021
         A     EVEREG,MAXR              VV3=YC+MAXR                     09380021
         ST    EVEREG,VV3                                               09400021
         L     EVEREG,YC                                                09420021
         S     EVEREG,MAXR              VV4=YC-MAXR                     09440021
         ST    EVEREG,VV4                                               09460021
         LM    XREG,YREG,XC                                             09480021
         BAL   LINKREG,CHKOFF           LINK TO CHECK CENTER OF CIRCLE  09500021
         B     XCOFF                    FOR OFF GRID CONDITION.         09520021
         B     XCOFF                                                    09540021
         MVI   SGSW,X'00'               CENTER POINT ON GRID. SET SGSW  09560021
         B     CHKNR                    AND GO TO CHECK NUM OF RADII.   09580021
XCOFF    MVI   SGSW,X'F0'               CENTER POINT OFF GRID.          09600021
CHKNR    STM   XREG,YREG,PT1X                                           09620021
         CLC   NR(2),C8                 CHECK THE NUMBER                09640021
         BE    GETUVAL                  OF RADII TO SEE                 09660021
         CLC   NR(2),FOUR+2             IF VALID.                       09680021
         BE    GEN4                                                     09700021
         CLC   NR(2),TWO+2              NR MUST = 1,2,4, OR 8.          09720021
         BE    GEN2                                                     09740021
         CLC   NR(2),ONE+2                                              09760021
         BE    GEN1                                                     09780021
         BAL   LINKREG,ER40             ASSUME ZERO IF NR IS INVALID.   09800021
         B     RET                      RETURN TO CALLING PROGRAM.      09820021
GEN4     MVC   PT2X(4),XC               GENERATE RADII                  09840021
         MVC   PT2Y(4),VV4              ON Y AXIS.                      09860021
         LM    XREG,YREG,PT2X                                           09880021
         BAL   INXREG,CHKPOINT          CHECK FOR OFF SCR/GRD.          09900021
         MVC   PT2Y(4),VV3                                              09920021
         LM    XREG,YREG,PT2X                                           09940021
         BAL   INXREG,CHKPOINT                                          09960021
GEN2     MVC   PT2X(4),VV2              GENERATE RADII                  09980021
         MVC   PT2Y(4),YC               ON X AXIS                       10000021
         LM    XREG,YREG,PT2X                                           10020021
         BAL   INXREG,CHKPOINT          CHECK FOR OFF SCR/GRD.          10040021
GEN1     MVC   PT2X(4),VV1                                              10060021
         MVC   PT2Y(4),YC                                               10080021
         LM    XREG,YREG,PT2X                                           10100021
         BAL   INXREG,CHKPOINT                                          10120021
         B     RET                      RETURN TO CALLING PROGRAM.      10140021
CHKPOINT ST    INXREG,VALUE1                                            10160021
         OI    SGSW,X'0C'                                               10180021
         BAL   LINKREG,CHKOFF                                           10200021
         B     GRID                                                     10220021
         B     SCREEN                                                   10240021
         NI    SGSW,X'F0'                                               10260021
         TM    SGSW,X'F0'                                               10280021
         BO    GRID                                                     10300021
ONSCR    MVC   GDV1(2),XC+2             ALL POINTS ON SCREEN.           10320021
         MVC   GDV1+2(2),YC+2           PUT GDV'S NEEDED TO PUT         10340021
         STH   XREG,GDV2                VECTOR AS COMPUTED.             10360021
         STH   YREG,GDV2+2                                              10380021
PUTRAD1  OI    GDV1,X'40'               SET BEAM BIT OF GDV1 OFF.       10400021
         LA    CNTREG,8                                                 10420021
         LA    ADDREG,GDV1                                              10440021
         BAL   LINREG,STORE             STORE GDV'S IN GDOA.            10460021
         NI    SGSW,X'F0'                                               10480021
         L     INXREG,VALUE1            RETURN TO MAINLINE.             10500021
         BR    INXREG                                                   10520021
GRID      BAL  LINKREG,TSTGR            LINK TO TEST OFF GRID OPTION.   10540021
         B     LINKGR                         OFF GRID BRANCH.          10560021
         B     ONSCR                          SHOW ON SCREEN BRANCH.    10580021
         B     SEENI                          SHOW ON GRID ONLY.        10600021
SCREEN   BAL   LINKREG,TSTSR            LINK TO TEST OFF SCREEN OPTION. 10620021
         B     LINKSR                         SHOW ON SCREEN BRANCH.    10640021
         B     LINKGR                         SHOW ON GRID BRANCH.      10660021
SEENI    CLI   NI+3,X'02'               SEE IF TWO INTERSECT POINTS     10680021
         BE    TWOIN                                                    10700021
         CLI   NI+3,X'01'                                               10720021
         BE    ONEIN1                                                   10740021
         NI    SGSW,X'F0'                                               10760021
         L     INXREG,VALUE1            RETURN TO MAINLINE.             10780021
         BR    INXREG                                                   10800021
TWOIN    MVC   GDV1(4),INTS1X                                           10820021
         MVC   GDV2(4),INTS2X                                           10840021
         B     PUTRAD1                                                  10860021
ONEIN1   TM    SGSW,X'F0'                                               10880021
         BO    ONEIN2                                                   10900021
PUTCNTR  MVC   GDV1(2),XC+2                                             10920021
         MVC   GDV1+2(2),YC+2                                           10940021
         MVC   GDV2(4),INTS1X                                           10960021
         B     PUTRAD1                                                  10980021
ONEIN2   TM    SGSW,X'0F'               IF PT2 PART OF SGSW IS OFF,     11000021
         BZ    PUTP2                    BR TO PUT GDV PT2X,PT2Y,U.      11020021
         TM    SGSW,X'03'                                               11040021
         BO    PUTCNTR                                                  11060021
         MVC   GDV1(4),INTS1X             PUT GDV'S NEEDED TO GENERATE  11080021
         MVC   GDV2(4),INTS1X             POINT AT INTERSECT ONE.       11100021
         B     PUTRAD1                                                  11120021
PUTP2    STH   XREG,GDV2                                                11140021
         STH   YREG,GDV2+2                                              11160021
         MVC   GDV1(4),INTS1X                                           11180021
         B     PUTRAD1                                                  11200021
         EJECT                                                          11220021
*********************************************                           11240021
*   COMPUTE END POINTS OF 45 DEGREE RADII   *                           11260021
*********************************************                           11280021
GETUVAL  LH    EVEREG,COS45                    UU1=XC+MAXR*COS(45)      11300021
         SRDA  EVEREG,32                                                11320021
         M     EVEREG,MAXR                                              11340021
         AH    ODDREG,POINT5                                            11360021
         SRDA  EVEREG,14                                                11380021
         A     ODDREG,XC                                                11400021
         ST    ODDREG,UU1                                               11420021
         LH    EVEREG,SIN45                    UU1=YC+MAXR*SIN(45)      11440021
         SRDA  EVEREG,32                                                11460021
         M     EVEREG,MAXR                                              11480021
         AH    ODDREG,POINT5                                            11500021
         SRDA  EVEREG,14                                                11520021
         A     ODDREG,YC                                                11540021
         ST    ODDREG,UU2                                               11560021
         LH    EVEREG,COS45                    UU3=XC-MAXR*COS(45)      11580021
         SRDA  EVEREG,32                                                11600021
         M     EVEREG,MAXR                                              11620021
         AH    ODDREG,POINT5                                            11640021
         SRDA  EVEREG,14                                                11660021
         L     XREG,XC                                                  11680021
         SR    XREG,ODDREG                                              11700021
         ST    XREG,UU3                                                 11720021
         LH    EVEREG,SIN45                    UU4=YC-MAXR*SIN(45)      11740021
         SRDA  EVEREG,32                                                11760021
         M     EVEREG,MAXR                                              11780021
         AH    ODDREG,POINT5                                            11800021
         SRDA  EVEREG,14                                                11820021
         L     YREG,YC                                                  11840021
         SR    YREG,ODDREG                                              11860021
         ST    YREG,UU4                                                 11880021
*********************************************                           11900021
*   COMPUTE X- AND Y-COORDINATES (XE,YE)    *                           11920021
*   AND STORE THE GDV'S NEEDED TO GENERATE  *                           11940021
*   RADII AT +45 DEGREES FROM EACH AXIS.    *                           11960021
*********************************************                           11980021
         MVC   PT2X(8),UU1              SET END POINT FOR RADII AT 45   12000021
         MVC   TEMP(2),C56+2            DEGREES EQ TO UU1,UU2.          12020021
         LM    XREG,YREG,PT2X                                           12040021
         BAL   INXREG,CHECKUU                                           12060021
         MVC   PT2X(4),UU3              END POINT FOR RADII AT 135      12080021
         MVC   TEMP(2),MINUS56          DEGREES EQ TO UU3,UU2.          12100021
         LM    XREG,YREG,PT2X                                           12120021
         BAL   INXREG,CHECKUU                                           12140021
         MVC   PT2Y(4),UU4              END POINT FOR RADII AT 225      12160021
         MVC   TEMP(2),C56+2            DEGREES EQ TO UU3,UU4.          12180021
         LM    XREG,YREG,PT2X                                           12200021
         BAL   INXREG,CHECKUU                                           12220021
         MVC   PT2X(4),UU1              END POINT FOR RADII AT 315      12240021
         MVC   TEMP(2),MINUS56          DEGREES EQ TO UU1,UU4.          12260021
         LM    XREG,YREG,PT2X                                           12280021
         BAL   INXREG,CHECKUU                                           12300021
         B     GEN4                     GO TO PUT RADII ON X & Y AXIS.  12320021
CHECKUU  ST    INXREG,VALUE1                                            12340021
         OI    SGSW,X'0C'                                               12360021
         BAL   LINKREG,CHKOFF           LINK TO CHECK PT2.              12380021
         B     GRDOFF                   OFF GRID BRANCH.                12400021
         B     SCROFF                   OFF SCREEN BRANCH.              12420021
         NI    SGSW,X'F0'                                               12440021
         TM    SGSW,X'F0'               SEE IF XC,YC OFF GRID.          12460021
         BO    GRDOFF                                                   12480021
         B     PUT20RU                                                  12500021
GRDOFF   BAL   LINKREG,TSTGR            LINK TO TEST USER OPTION.       12520021
         B     LINKGR                   SHOW ON GRID.                   12540021
         B     PUT20RU                  SHOW ON SCREEN.                 12560021
         B     TESTNI                   GO TO TEST NUMBER OF INTERSECTS 12580021
SCROFF   BAL   LINKREG,TSTSR            LINK  TO TEST USER OPTION.      12600021
         B     LINKSR                   SHOW ON SCREEN.                 12620021
         B     LINKGR                   SHOW ON GRID.                   12640021
TESTNI   CLI   NI+3,X'02'                                               12660021
         BE    PUT2                                                     12680021
         CLI   NI+3,X'01'                                               12700021
         BE    PUT1A                                                    12720021
         NI    SGSW,X'F0'                                               12740021
         L     INXREG,VALUE1                                            12760021
         BR    INXREG                                                   12780021
PUT2     LH    YREG,INTS1Y              TWO INTERSECT POINTS.           12800021
         LH    XREG,INTS2Y                                              12820021
         CR    XREG,YREG                SEE IF INTS2 IS LT INTS1.       12840021
         BL    INT2LO                                                   12860021
         MVC   XE(4),INTS1X             START OF RADII IS INTERSECT 1.  12880021
         MVC   ZE(4),INTS2X                                             12900021
         B     PUTRAD2                                                  12920021
INT2LO   MVC   XE(4),INTS2X             START OF RADII IS INTERSECT 2   12940021
         MVC   ZE(4),INTS1X                                             12960021
         B     PUTRAD2                                                  12980021
PUT1A    TM    SGSW,X'F0'               SEE IF XC,YC OFF GRID.          13000021
         BO    PUT1B                                                    13020021
PUTXYC   L     YREG,YC                  ONE INTERSECT POINT.            13040021
         LH    XREG,INTS1Y                                              13060021
         CR    XREG,YREG                FIND LOW POINT OF RADII         13080021
         BL    INT1LO                                                   13100021
         MVC   XE(2),XC+2               START OF RADII IS XC,YC.        13120021
         MVC   YE(2),YC+2                                               13140021
         MVC   ZE(4),INTS1X             END OF RADII IS INTS1.          13160021
         B     PUTRAD2                                                  13180021
INT1LO   MVC   XE(4),INTS1X             START OF RADII IS INTS1.        13200021
         MVC   ZE(2),XC+2               END OF RADII IS XC,YC.          13220021
         MVC   ZE+2(2),YC+2                                             13240021
         B     PUTRAD2                                                  13260021
PUT1B    TM    SGSW,X'0F'               SEE IF BOTH POINTS OFF.         13280021
         BZ    FINDLO                                                   13300021
         TM    SGSW,X'03'                                               13320021
         BO    PUTXYC                                                   13340021
         MVC   GDV1(4),INTS1X           GENERATE POINT AT INTERSECT     13360021
         MVC   GDV2(4),INTS1X           ONE IF BOTH POINTS OFF GRID.    13380021
         B     PUTRAD1                                                  13400021
PUT20RU  MVC   INTS1X(2),XC+2                                           13420021
         MVC   INTS1Y(2),YC+2                                           13440021
FINDLO   LH    YREG,INTS1Y              FIND LOW POINT OF RADII.        13460021
         L     XREG,PT2Y                                                13480021
         CR    XREG,YREG                                                13500021
         BL    PT2LO                                                    13520021
         MVC   XE(4),INTS1X             INTS1 IS START OF RADII.        13540021
         MVC   ZE(2),PT2X+2             PT2 IS END OF RADII.            13560021
         MVC   ZE+2(2),PT2Y+2                                           13580021
         B     PUTRAD2                                                  13600021
PT2LO    MVC   XE(2),PT2X+2                                             13620021
         MVC   YE(2),PT2Y+2             PT2 IS START OF RADII.          13640021
         MVC   ZE(4),INTS1X             INTS1 IS END OF RADII.          13660021
PUTRAD2  MVC   GDV1(2),XE               SET UP A GDV FOR POSITIONING    13680021
         MVC   GDV1+2(2),YE             BEAM AT XE,YE BLANKED.          13700021
         OI    GDV1,X'40'                                               13720021
         LA    CNTREG,4                                                 13740021
         LA    ADDREG,GDV1                                              13760021
         BAL   LINREG,STORE                                             13780021
NEWXE    LH    EVEREG,XE                XE=XE+TEMP                      13800021
         AH    EVEREG,TEMP                                              13820021
         STH   EVEREG,XE                                                13840021
         LH    EVEREG,YE                YE=YE+56                        13860021
         AH    EVEREG,C56+2                                             13880021
         STH   EVEREG,YE                                                13900021
         CH    EVEREG,ZE+2                                              13920021
         BNL   LAST1                                                    13940021
         MVC   GDV1(2),XE               SET UP GDV FOR NEW              13960021
         MVC   GDV1+2(2),YE             BEAM POSITION.                  13980021
         LA    ADDREG,GDV1              GDV1= GDV XE,YE,U               14000021
         LA    CNTREG,4                                                 14020021
         BAL   LINREG,STORE                                             14040021
         B     NEWXE                                                    14060021
LAST1    MVC   GDV1(4),ZE               SET UP GDV TO COMPLETE RADII.   14080021
         LA    ADDREG,GDV1                                              14100021
         LA    CNTREG,4                                                 14120021
         BAL   LINREG,STORE                                             14140021
         NI    SGSW,X'F0'                                               14160021
         L     INXREG,VALUE1                                            14180021
         BR    INXREG                                                   14200021
LINKGR   ST    XYLREG,SABL                                              14220021
         B     PT2ON                                                    14240021
LINKSR   OI    SGSW,X'03'                                               14260021
         LA    WRKREG,ZERO                                              14280021
         ST    WRKREG,SABL                                              14300021
PT2ON    STM   XREG,YREG,PT2X           STORE COORDINATES IN PT2X,PT2Y. 14320021
         STM   14,1,SAVE                STORE VITAL REGISTERS.          14340021
         ST    13,OVFSAVE+4                                             14360021
         ST    15,SVR15                 SAVE ERROR REGISTER             14380021
         LA    13,OVFSAVE               SET UP SAVE AREA FOR GOFFSG,    14400021
         LR    WRKREG,WKAREG            SAVE WORK AREA ADDRESS          14420021
         CLI   LOADSW,X'FF'             IF LOADSW IS ON, BR TO GET ADDR 14440021
         BE    GETIT                    OF GOFFSG. IF LOADSW IS OFF,    14460021
         LA    1,SABL                   AND POINT TO PARAMETER TABLE.   14480021
         LOAD EP=GOFFSG                 GET ADDR OF OFF SCREEN/GR1D RTN 14500021
         LR    WKAREG,WRKREG                                            14520021
         ST    0,LOADSW                 STORE ADDR OF GOFFSG ROUTINE.   14540021
         OI    LOADSW,X'FF'             SET LOAD SWITCH ON.             14560021
GETIT    L     15,LOADSW                LOAD ADDR OF GOFFSG ROUTINE AND 14580021
         LA    1,SABL                   POINT TO WORK AREA              14600021
         BALR  14,15                    BRANCH & LINK TO GOFFSG.        14620021
RESET    LR    WKAREG,WRKREG                                            14640021
         LM    14,0,SAVE                                                14660021
         L     13,OVFSAVE+4             RESTORE SAVE AREA ADDRESS.      14680021
         L     15,SVR15                 RESTORE ERROR REGISTER          14700021
         B     8(0,LINKREG)                                             14720021
         EJECT                                                          14740021
*********************************************                           14760021
*        XYLCHK     SUBROUTINE              *                           14780021
*        ADDRESS OF XYLIM TABLE IN XYLREG   *                           14800021
*********************************************                           14820021
XYLCHK   LA    CNTREG,4                 SET  LOOP  COUNT                14840021
         LA    INXREG,0                 SET  INDEX                      14860021
XYLLOOP  LH    WRKREG,0(XYLREG,INXREG)  LOAD  X1,Y1,X2,Y2               14880021
         C     WRKREG,ZERO                                              14900021
         BL    XYLERR                                                   14920021
         C     WRKREG,HIGH                                              14940021
         BH    XYLERR                                                   14960021
         A     INXREG,TWO                                               14980021
         BCT   CNTREG,XYLLOOP                                           15000021
         CLC   0(2,XYLREG),4(XYLREG)    X1 COMP  X2                     15020021
         BNL   XYLERR                                                   15040021
         CLC   2(2,XYLREG),6(XYLREG)    Y1 COMP  Y2                     15060021
         BNL   XYLERR                                                   15080021
         BR    LINREG                                                   15100021
XYLERR   LA    15,4                     SET ERROR CODE = 4              15120021
         BAL   LINREG,ERRCNT                                            15140021
         B     RET                                                      15160021
ER8      LA    ERREG,8                  UC,VC PARAMETER ERROR,          15180021
         BAL   LINREG,ERRCNT            IMMEDIATE RETURN.               15200021
         B     RET                                                      15220021
ER16     BAL   LINREG,ERRCNT                                            15240021
         LA    ERREG,16                                                 15260021
         B     RET                                                      15280021
ER20     LA    ERREG,20                 INPUT PARAMETER ERROR,          15300021
         BAL   LINREG,ERRCNT            IMMEDIATE RETURN.               15320021
         B     RET                                                      15340021
ER28     LA    ERREG,28                 S/G OPTION = D.                 15360021
         B     ERRCNT                                                   15380021
ER32     LA    ERREG,32                 S/G OPTION = C OR E.            15400021
         B     ERRCNT                                                   15420021
ER40     LA    ERREG,40                 INPUT PARAMETER ERROR,          15440021
         BAL   LINREG,ERRCNT            COUNT ERRORS AND CONTINUE.      15460021
         BR    LINKREG                                                  15480021
ER44     LA    ERREG,44                 S/G OPTION = A.                 15500021
         B     ERRCNT                                                   15520021
ER48     LA    ERREG,48                 S/G OPTION = B.                 15540021
ERRCNT   L     TEMREG,ERCOUNT                                           15560021
         A     TEMREG,ONE                                               15580021
         ST    TEMREG,ERCOUNT                                           15600021
         BR    LINREG                                                   15620021
RET      LA    TEMREG,1                                                 15640021
         C     TEMREG,ERCOUNT                                           15660021
         BL    SETBIT                                                   15680021
RETURN   CLI   LOADSW,X'00'                                             15700021
         BE    RETMACRO                                                 15720021
         ST    15,SVR15                 SAVE ERROR REGISTER             15740021
         LR    WRKREG,1                 SAVE REGISTER 1                 15760021
DELETE   DELETE EP=GOFFSG                                               15780021
         LR    1,WRKREG                 RESTORE REGISTER 1              15800021
         L     15,SVR15                 RESTORE ERROR REGISTER          15820021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            15840021
RETMACRO L     WRKREG,MASKSV                                            15860021
         SPM   WRKREG                                                   15880021
         RETURN (14,12),T,RC=(15)                                       15900021
SETBIT   O     15,MZERO                                                 15920021
         B     RETURN                                                   15940021
         EJECT                                                          15960021
SCALFLT  LA    CONREG,4                 LOOP  COUNT                     15980021
         LA    INXREG,0                 SET INDEX                       16000021
         LA    WRKREG,0                                                 16020021
FLTLOOP  LH    VALREG,0(XYLREG,INXREG)  GET X1Y1,X2Y2 VALUES            16040021
         BAL   LINREG,FLTCONV                                           16060021
         ST    VALREG,4(WKAREG,WRKREG)                                  16080021
         A     INXREG,TWO                                               16100021
         A     WRKREG,FOUR                                              16120021
         BCT   CONREG,FLTLOOP                                           16140021
***********************************************                         16160021
*   SUBROUTINE TO SCALE FLOATING  *                                     16180021
*   POINT COORDINATES UC,VC.      *                                     16200021
***********************************************                         16220021
         LE    0,UC                                                     16240021
         SE    0,U1                     UC-U1                           16260021
         LE    2,12(WKAREG)             LOAD CONVERTED X2.              16280021
         SE    2,4(WKAREG)              X2-X1                           16300021
         MER   0,2                      (UC-U1)*(X2-X1)                 16320021
         LE    2,U2                                                     16340021
         SE    2,U1                     U2-U1                           16360021
         BNP   ER16                                                     16380021
         DER   0,2                      ((UC-U1)*(X2-X1))/(U2-U1)       16400021
         AE    0,4(WKAREG)              ADD X1 TO COMPLETE FUNCTION.    16420021
         L     VALREG,0(WKAREG)                                         16440021
         STE   0,0(WKAREG)                                              16460021
         BAL   LINREG,FIXCONV                                           16480021
         ST    VALREG,XC                                                16500021
         LE    0,VC                                                     16520021
         SE    0,V1                                                     16540021
         LE    2,16(WKAREG)                                             16560021
         SE    2,8(WKAREG)                                              16580021
         MER   0,2                                                      16600021
         LE    2,V2                                                     16620021
         SE    2,V1                     V2-V1                           16640021
         BNP   ER16                                                     16660021
         DER   0,2                      ((VC-V1)*(Y2-Y1)/(V2-V1)        16680021
         AE    0,8(WKAREG)              ADD Y1 TO COMPLETE FUNCTION     16700021
         L     VALREG,0(WKAREG)                                         16720021
         STE   0,0(WKAREG)                                              16740021
         BAL   LINREG,FIXCONV                                           16760021
         ST    VALREG,YC                                                16780021
         BR    LINKREG                                                  16800021
**************************************************                      16820021
*   SUBROUTINE TO SCALE FLOATING POINT VALUES    *                      16840021
*   SVAL=XINC*((X2-X1)/(U2-U1))  XINC=RINC OR MRU*                      16860021
*   SVAL REPRESENTS RINC OR MRU SCALED           *                      16880021
**************************************************                      16900021
FLTSCAL  LE    0,12(WKAREG)             X2                              16920021
         SE    0,4(WKAREG)              -X1                             16940021
         ME    0,VALUE1                 *UI                             16960021
         LE    2,12(XYLREG)             U2                              16980021
         SE    2,8(XYLREG)              -U1                             17000021
         DER   0,2                                                      17020021
         STE   0,0(WKAREG)                                              17040021
         L     XREG,0(WKAREG)           XREG CONTAINS SCALED FP UI      17060021
         L     VALREG,0(WKAREG)                                         17080021
         BAL   LINREG,FIXCONV           BR AND LINK TO CONVERT RTN.     17100021
         LR    XREG,VALREG              LOAD XREG WITH SCALED INC       17120021
         BR    LINKREG                  AND RETURN TO MAINLINE.         17140021
         EJECT                                                          17160021
*********************************************                           17180021
*   CONVERT FLOATING POINT TO FIXED POINT   *                           17200021
*   VALREG = VALUE TO BE CONVERTED          *                           17220021
*********************************************                           17240021
FCONVERT LR    VALREG,XREG              FIXCONVERT -(CONVERT FLOAT      17260021
         BAL   LINREG,FIXCONV           TO FIX)                         17280021
         LR    XREG,VALREG                                              17300021
         LR    VALREG,YREG                                              17320021
         BAL   LINREG,FIXCONV                                           17340021
         LR    YREG,VALREG                                              17360021
         BR    LINKREG                                                  17380021
FIXCONV  ST    1,OVFSAVE                STORE REG 1 IN WORK AREA        17400021
         TM    OVFSAVE+3,X'07'          TEST LAST THREE BITS            17420021
         BZ    *+12                     NO BITS ON, SET INDEX TO ZERO   17440021
         LA    TEMREG,4                 SET MODIFIER                    17460021
         B     *+8                      START CONVERSION                17480021
         LA    TEMREG,0                 SET MODIFIER TO ZERO            17500021
         ST    VALREG,TEMFLT(TEMREG)    SAVE FLOAT VALUE                17520021
         SR    WRKREG,WRKREG                                            17540021
         ST    WRKREG,TEMFLT+4(TEMREG)  CLEAR SECOND WORD               17560021
         LD    6,TEMFLT(TEMREG)         VALUE TO FLOAT REGISTERS        17580021
         N     VALREG,FCHAR                                             17600021
         BE    FLERR1                   CHARACTERISTIC IS ZERO          17620021
         AE    6,FLPT5                  ADD .5 TO ROUND                 17640021
         AW    6,X4E                    ADD UNNORMALIZED-RIGHT JUSTIFY  17660021
         STD   6,TEMFLT(TEMREG)         SAVE VALUES                     17680021
         L     WRKREG,TEMFLT+4(TEMREG)  CHECK SECOND WORD               17700021
         N     WRKREG,MZERO             CHECK BIT 32                    17720021
         BM    ER12                     BRANCH ON MINUS                 17740021
         L     WRKREG,TEMFLT(TEMREG)                                    17760021
         N     WRKREG,BYTE123                                           17780021
         BM    ER12                     BRANCH ON MINUS                 17800021
         L     WRKREG,TEMFLT(TEMREG)                                    17820021
         N     WRKREG,MZERO             DROP CHARACTERISTIC             17840021
         L     VALREG,TEMFLT+4(TEMREG)  NEW FIXED VALUE                 17860021
         LTR   WRKREG,WRKREG                                            17880021
         BNL   NOTNEG                   NOT NEGATIVE                    17900021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLEMENT           17920021
NOTNEG   BR    LINREG                   RETURN TO MAINLINE.             17940021
FLERR1   CE    6,ZERO                   IS TOTAL VALUE ZERO             17960021
         BE    NOTNEG                   RETURN                          17980021
         B     ER12                     ERROR 12                        18000021
ER12   LA    ERREG,12                                                   18020021
       BAL   LINKREG,ERRCNT                                             18040021
       B     RET                                                        18060021
**************************************************                      18080021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  *                      18100021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED   *                      18120021
**************************************************                      18140021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   18160021
         ST    VALREG,0(WKAREG)                                         18180021
         LE    0,0(WKAREG)              LOAD FLOATING PT REG            18200021
         AE    0,X6                     NORMALIZE                       18220021
         STE   0,0(WKAREG)                                              18240021
         L     VALREG,0(WKAREG)         FLOAT PT VAL IN VALREG          18260021
         BR    LINREG                                                   18280021
         EJECT                                                          18300021
**********************************                                      18320021
*   SUBROUTINE TO SCALE FIXED     *                                     18340021
*   FIXED POINT COORDINATES UC,VC *                                     18360021
***********************************                                     18380021
SCALFIX  S     XREG,U1                  COMPUTE UC-U1                   18400021
         LR    ODDREG,XREG              LOAD MULTIPLICAND               18420021
         LH    XREG,X2                                                  18440021
         SH    XREG,X1                  COMPUTE X2-X1                   18460021
         SR    EVEREG,EVEREG                 AND                        18480021
         MR    EVEREG,XREG              (UC-U1)*(X2-X1)                 18500021
         L     XREG,U2                                                  18520021
         S     XREG,U1                  COMPUTE U2-U1                   18540021
         BNP   ER16                                                     18560021
         DR    EVEREG,XREG              COMPUTE ((UC-U1)<(X2-X1))/U2-U1 18580021
         AH    ODDREG,X1                COMPLETE FUNCTION BY ADDING X1. 18600021
         LR    XREG,ODDREG              RETURN SCALED VALUE IN XREG.    18620021
         S     YREG,V1                  COMPUTE VC-V1                   18640021
         LR    ODDREG,YREG                                              18660021
         LH    YREG,Y2                                                  18680021
         SH    YREG,Y1                  COMPUTE Y2-Y1                   18700021
         SR    EVEREG,EVEREG                                            18720021
         MR    EVEREG,YREG              (VC-V1)*(Y2-Y1)                 18740021
         L     YREG,V2                                                  18760021
         S     YREG,V1                  COMPUTE V2-V1                   18780021
         BNP   ER16                                                     18800021
         DR    EVEREG,YREG              COMPUTE ((VC-V1)*(Y2-Y1))/U2-V1 18820021
         AH    ODDREG,Y1                COMPLETE FUNCTION BY ADDING Y1. 18840021
         LR    YREG,ODDREG              RETURN SCALED VALUE IN YREG.    18860021
         BR    LINREG                   RETURN TO MAINLINE.             18880021
**************************************************                      18900021
*   SUBROUTINE TO SCALE   FIXED  POINT  VALUES   *                      18920021
*   SVAL=XINC*((X2-X1)/(U2-U1))  XINC=RINC OR MRU*                      18940021
*   SVAL REPRESENTS RINC OR MRU SCALED           *                      18960021
**************************************************                      18980021
FIXSCAL  LH    ODDREG,4(XYLREG)         X2                              19000021
         SH    ODDREG,0(XYLREG)         -X1                             19020021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   19040021
         MR    EVEREG,XREG              * UI                            19060021
         L     XREG,12(XYLREG)          U2                              19080021
         S     XREG,8(XYLREG)           -U1                             19100021
         BNP   ER16                                                     19120021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   19140021
         DR    EVEREG,XREG                                              19160021
         LR    XREG,ODDREG              SCALED U VALUE IN XREG          19180021
         BR    LINREG                                                   19200021
         EJECT                                                          19220021
*********************************************                           19240021
* STORE GRAPHIC DATA IN GDOA FOR POR        *                           19260021
* INPUT TO SUBROUTINE                       *                           19280021
*   CNTREG = NUMBER OF BYTES TO BE STORED   *                           19300021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA    *                           19320021
*   WKAREG = WORK AREA ADDRESS              *                           19340021
*   OABREG = ADDRESS OF OACB                *                           19360021
*********************************************                           19380021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   19400021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        19420021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              19440021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 19460021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        19480021
         LA    TEMREG,4                                                 19500021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               19520021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    19540021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       19560021
         CR    TEMREG,SLOREG                                            19580021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       19600021
         BNH   OK                                                       19620021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    19640021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         19660021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       19680021
* ANY BYTES TO STORE                                                    19700021
         C     WRKREG,ZERO                                              19720021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           19740021
         LH    TEMREG,H2A02                                             19760021
         CH    TEMREG,GOMODE                                            19780021
         BH    STORE3A                                                  19800021
         LH    TEMREG,H0003                                             19820021
         NR    TEMREG,WRKREG                                            19840021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (IAPG)      7468 19860021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      19880021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 19900021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              19920021
* STORE REGISTERS IN WORKAREA                                           19940021
         STM   0,15,0(WKAREG)           SAVE REGISTERS IN WORKAREA      19960021
         CLI   LOADSW,X'FF'                                             19980021
         BNE   LOADREG                                                  20000021
         LR    3,1                      SAVE REG 1.                     20020021
         DELETE EP=GOFFSG                                               20040021
         LR    1,3                      RESTORE REG 1.                  20060021
LOADREG  L     15,8(0,OABREG)       OVERFLOW ADDRESS                    20080021
         LM    2,12,28(13)           RELOAD USERS REG                   20100021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      20120021
         MVI   LOADSW,X'00'                                             20140021
         LM    0,15,0(WKAREG)           RELOAD FROM WORKAREA            20160021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    20180021
* NO SPACE AVAILABLE                                                    20200021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 20220021
         BL    STORE3                                                   20240021
*                                                                       20260021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          20280021
         LA    15,28                    SET ERROR CODE REG.             20300021
         B     RET                      SYMBOLIC IN POR                 20320021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 20340021
         BR    LINREG                                                   20360021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           20380021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      20400021
         BH    STORE7                                                   20420021
         LR    TEMREG,WRKREG                                            20440021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       20460021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               20480021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              20500021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                20520021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           20540021
         BR    INTLNK                   RETURN INTERNALLY               20560021
STORE7   LR    SLOREG,TEMREG                                            20580021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       20600021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               20620021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              20640021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            20660021
         SR    WRKREG,TEMREG           REDUCE BY 255                    20680021
         B     STORE6A                  MAKE NEXT COMPARISON            20700021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               20720021
         CNOP  0,4                                                      20740021
         EJECT                                                          20760021
******************************                                          20780021
*   CONSTANTS USED BY GPGRID *                                          20800021
******************************                                          20820021
         DS    0D                                                       20840021
X4E      DC    X'4E00000000000000'                                      20860021
ZERO     DC    F'0'                                                     20880021
H4095    DC    H'4095,4095'                                             20900021
ONE      DC    F'1'                                                     20920021
TWO      DC    F'2'                                                     20940021
FOUR     DC    F'4'                                                     20960021
FLPT5    DC    E'.5'                                                    20980021
C56      DC    F'56'                                                    21000021
C360     DC    F'360'                                                   21020021
C1365    DC    F'1365'                                                  21040021
C4095    DC    F'4095'                                                  21060021
C5793    DC    F'5793'                                                  21080021
TWOPI    DC    FS28'6.2832'                                             21100021
HIGH     DC    F'4095'                                                  21120021
BYTE123  DC    X'00FFFFFF'                                              21140021
FCHAR    DC    X'7F000000'                                              21160021
XZERO    DC    X'80FFFFFF'                                              21180021
X6       DC    X'46000000'                   EXPONENT OF SIX            21200021
MZERO    DC    X'80000000'                                              21220021
POINT5   DC    HS14'.5'                                                 21240021
MINUS1   DC    H'-1'                                                    21260021
MINUS2   DC    H'-2'                                                    21280021
MINUS56  DC    H'-56'                                                   21300021
C8       DC    H'8'                                                     21320021
C45      DC    H'45'                                                    21340021
C46      DC    H'46'                                                    21360021
C90      DC    H'90'                                                    21380021
C136     DC    H'136'                                                   21400021
C180     DC    H'180'                                                   21420021
C226     DC    H'226'                                                   21440021
C270     DC    H'270'                                                   21460021
C315     DC    H'315'                                                   21480021
H360     DC    H'360'                                                   21500021
H2A02    DC    X'2A02'                                                  21520021
H0003    DC    H'0003'                                                  21540021
GEPM     DC    X'2A00'                                                  21560021
GEVM     DC    X'2A02'                                                  21580021
LOGJ     DC    HS14'.3010,.4771,.6021,.6990,.7782,.8451,.9031,.9542'    21600021
*   LOGJ TABLE=LOG VALUES FOR THE CYCLES OF LOG GRID. WHEN J=2,3,4,...9 21620021
LOGTBL   EQU   LOGJ                                                     21640021
         EJECT                                                          21660021
******************************                                          21680021
*    SINE/COSINE TABLE       *                                          21700021
******************************                                          21720021
SCTBL    DC    HS14'0.0000,1.0000,0.0175,0.9999'             0- 1       21740021
         DC    HS14'0.0349,0.9994,0.0523,0.9986'             2- 3       21760021
         DC    HS14'0.0698,0.9976,0.0872,0.9962'             4- 5       21780021
         DC    HS14'0.1045,0.9945,0.1219,0.9926'             6- 7       21800021
         DC    HS14'0.1392,0.9903,0.1564,0.9877'             8- 9       21820021
         DC    HS14'0.1737,0.9848,0.1908,0.9816'            10-11       21840021
         DC    HS14'0.2079,0.9782,0.2250,0.9744'            12-13       21860021
         DC    HS14'0.2419,0.9703,0.2588,0.9659'            14-15       21880021
         DC    HS14'0.2756,0.9613,0.2924,0.9563'            16-17       21900021
         DC    HS14'0.3090,0.9511,0.3256,0.9455'            18-19       21920021
         DC    HS14'0.3420,0.9397,0.3584,0.9336'            20-21       21940021
         DC    HS14'0.3746,0.9272,0.3907,0.9205'            22-23       21960021
         DC    HS14'0.4067,0.9136,0.4226,0.9063'            24-25       21980021
         DC    HS14'0.4384,0.8988,0.4540,0.8910'            26-27       22000021
         DC    HS14'0.4695,0.8830,0.4848,0.8746'            28-29       22020021
         DC    HS14'0.5000,0.8660,0.5150,0.8572'            30-31       22040021
         DC    HS14'0.5299,0.8481,0.5446,0.8387'            32-33       22060021
         DC    HS14'0.5592,0.8290,0.5736,0.8192'            34-35       22080021
         DC    HS14'0.5878,0.8090,0.6018,0.7986'            36-37       22100021
         DC    HS14'0.6157,0.7880,0.6293,0.7772'            38-39       22120021
         DC    HS14'0.6428,0.7660,0.6561,0.7547'            40-41       22140021
         DC    HS14'0.6691,0.7431,0.6820,0.7314'            42-43       22160021
S4445    DC    HS14'0.6947,0.7193,0.7071,0.7071'            44-45       22180021
SINE     EQU   SCTBL                                                    22200021
COSINE   EQU   SCTBL+2                                                  22220021
SIN45    EQU   S4445+4                                                  22240021
COS45    EQU   S4445+6                                                  22260021
         EJECT                                                          22280021
******************************                                          22300021
******************************                                          22320021
*   PARAMETER TABLE FORMAT   *                                          22340021
******************************                                          22360021
PARTAB   DSECT                                                          22380021
XYLIM    DS    CL4                      ADDR OF XY LIMIT TABLE.         22400021
UC       DS    CL4                      X-COORDINATE OF ARC CENTER.     22420021
VC       DS    CL4                      Y-COORDINATE OF ARC CENTER.     22440021
F        DS    CL1                      FIXED/FLOATING POINT INDICATOR. 22460021
S        DS    CL1                      SCALING INDICATOR.              22480021
INC      DS    CL1                      ALPHA/DENSITY INDICATOR.        22500021
OFFSG    DS    CL1                      OFF SCREEN/GRID OPTION IND.     22520021
RINC     DS    CL4                      INCREMENT IN RADIAL DIRECTION.  22540021
NR       DS    CL2                      # OF RADII                      22560021
DENSITY  DS    CL2                   ** DENSITY OF CONSECUTIVE POINTS.  22580021
ALPHA    EQU   DENSITY               ** DEGREE OF SUCCESIVE POINTS.     22600021
MAXRAD   DS    CL4                      MAXIMUM LENGTH OF RADIUS.       22620021
TYPE     DS    CL1                      GRID TYPE.                      22640021
         EJECT                                                          22660021
******************************                                          22680021
*   GPGRID USE OF WORK AREA  *                                          22700021
******************************                                          22720021
WKAREA   DSECT                                                          22740021
OVFSAVE  DS    0CL72                                                    22760021
TEMFLT   DS    0CL8                                                     22780021
         DS    CL128                                                    22800021
SABL     DS    CL4                                                      22820021
PT1X     DS    CL4                                                      22840021
PT1Y     DS    CL4                                                      22860021
PT2X     DS    CL4                                                      22880021
PT2Y     DS    CL4                                                      22900021
NI       DS    CL4                                                      22920021
INTS1X   DS    CL2                                                      22940021
INTS1Y   DS    CL2                                                      22960021
INTS2X   DS    CL2                                                      22980021
INTS2Y   DS    CL2                                                      23000021
         DS    CL64                                                     23020021
SAVE     DS    CL16                                                     23040021
LOADSW   DS    CL4                                                      23060021
GDV1     DS    CL4                                                      23080021
GDV2     DS    CL4                                                      23100021
XC       DS    CL4                                                      23120021
YC       DS    CL4                                                      23140021
MAXR     DS    CL4                                                      23160021
RINK     DS    CL4                                                      23180021
R        DS    CL4                                                      23200021
VALUE1   DS    CL4                                                      23220021
UU1      DS    CL4                                                      23240021
UU2      DS    CL4                                                      23260021
UU3      DS    CL4                                                      23280021
UU4      DS    CL4                                                      23300021
VV1      DS    CL4                                                      23320021
VV2      DS    CL4                                                      23340021
VV3      DS    CL4                                                      23360021
VV4      DS    CL4                                                      23380021
I        DS    CL4                                                      23400021
SVR15    DS    CL4                      PLACE TO SAVE ERROR REGISTER    23420021
ERCOUNT  DS    CL4                                                      23440021
ALPH     DS    CL2                                                      23460021
NPT      DS    CL2                                                      23480021
PHI      DS    CL2                                                      23500021
K        DS    CL2                                                      23520021
LOGSAV   DS    CL2                                                      23540021
TEMP     DS    CL2                                                      23560021
XE       DS    CL2                                                      23580021
YE       DS    CL2                                                      23600021
ZE       DS    CL4                                                      23620021
SGSW     DS    CL1                                                      23640021
FUNCSW   DS    CL1                                                      23660021
INK      DS    CL1                                                      23680021
J        DS    CL1                                                      23700021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    23720021
         ORG   OVFSAVE+396                                              23740021
GOMODE   DS    CL2                                                      23760021
XYLIMT   DSECT                                                          23780021
X1       DS    CL2                                                      23800021
Y1       DS    CL2                                                      23820021
X2       DS    CL2                                                      23840021
Y2       DS    CL2                                                      23860021
U1       DS    CL4                                                      23880021
U2       DS    CL4                                                      23900021
V1       DS    CL4                                                      23920021
V2       DS    CL4                                                      23940021
         END                                                            23960021
./  ADD  SSI=20480478,NAME=IFFPJAPV
         TITLE 'GPVGRD - VECTOR POLAR GRID GENEREATION ROUTINE'         00020021
*                                                                       00040021
*                                                                       00060021
*   STATUS.              CHANGE LEVEL 0.                                00080021
*                                                                       00100021
*   FUNCTION/OPERATION.  GPVGRD GENERATES THE GRAPHIC ORDERS TO DISPLAY 00120021
*                        A SET OF CONCENTRIC CIRCLES, DIVIDED INTO      00140021
*                        EQUAL SECTORS BY A NUMBER OF RADIAL VECTORS.   00160021
*                        THE SPACING BETWEEN THE CIRCLES MAY BE LINEAR  00180021
*                        OR LOGARITHMIC.  THIS ROUTINE PROVIDES THE     00200021
*                        GRAPHIC ORDERS TO  DISPLAY POLYGONS  WHICH     00220021
*                        APPROXIMATE THE CIRCLES, AND IS PROVIDED FOR   00240021
*                        USE WITH GRAPHIC  DEVICES  HAVING ABSOLUTE     00260021
*                        VECTORS CAPABILITIES.                          00280021
*                                                                       00300021
*   ENTRY POINTS.        GPVGRD VIA CALL OR LINK MACRO.                 00320021
*                        ALIAS NAME - IFFPJAPV                          00340021
*                                                                       00360021
*   INPUT.               OUTPUT CONTROL BLOCK POINTER (OACB).           00380021
*                        PARAMETER TABLE WHICH DEFINES THE POSITION,    00400021
*                        SIZE, AND TYPE OF POLAR GRID.                  00420021
*                                                                       00440021
*   OUTPUT.              GRAPHIC ORDERS STORED IN THE GDOA.             00460021
*                                                                       00480021
*   EXTERNAL ROUTINES.   GOFFSG - OFF SCREEN OFF GRID ROUTINE.          00500021
*                                                                       00520021
*   EXITS-NORMAL.        COMPLETION OF TASK. EXIT VIA RETURN MACRO.     00540021
*        -ERROR.         IMMEDIATE RETURN. EXIT VIA RETURN MACRO.       00560021
*                        HEXADECIMAL 4,8,C,10,14, OR 18 IN RET CODE REG 00580021
*        -ERROR.         DOES NOT RETURN IMMEDIATELY. COMPLETION OF     00600021
*                        TASK AND RETURN VIA RETURN MACRO.              00620021
*                        HEXADECIMAL 28 IN RETURN CODE REGISTER.        00640021
*                                                                       00660021
*   TABLES/WORK AREAS.   USER SPECIFIED PARAMETER TABLE, XYLIM TABLE    00680021
*                        AND WORK AREA.                                 00700021
*                                                                       00720021
*   ATTRIBUTES.          READ ONLY. REENTRANT.                          00740021
         EJECT                                                          00760021
IFFPJAPV CSECT                          GPVGRD                          00780021
*0669                                                              7468 00790021
         ENTRY GPVGRD                                                   00800021
PASREG   EQU   0                                                        00820021
WKAREG   EQU   1                        WORK AREA ADDRESS REGISTER      00840021
PARREG   EQU   1                                                        00860021
OBPREG   EQU   2                        CONTROL BLOCK POINTER ADDR REG  00880021
OABREG   EQU   2                        CONTROL BLOCK ADDRESS REGISTER  00900021
PATREG   EQU   3                        ADDRESS OF PARAMETER TABLE      00920021
XYLREG   EQU   4                        ADDRESS OF XYLIM TABLE          00940021
XREG     EQU   5                        X-COMPUTING REGISTER            00960021
SLOREG   EQU   5                        SLOA ADDRESS REGISTER           00980021
COSREG   EQU   5                        COSINE REGISTER                 01000021
SINREG   EQU   6                        SINE REGISTER                   01020021
YREG     EQU   6                        Y-COMPUTING REGISTER            01040021
INTLNK   EQU   6                        INTERNAL POR LINK REGISTER      01060021
INDEXREG EQU   7                        INDEX REGISTER                  01080021
WRKREG   EQU   7                        WORK REGISTER                   01100021
CNTREG   EQU   8                        COUNT REGISTER                  01120021
LINKREG  EQU   8                        INTERNAL POR LINK REGISTER.     01140021
BASE9    EQU   9                        BASE REGISTER FOR GPGRID        01160021
INXREG   EQU   10                       INDEX AND POR LINK REGISTER     01180021
OLPREG   EQU   10                       ORDER LOAD POINT ADDRESS        01200021
EVEREG   EQU   10                       ARITHMETIC WORK REGISTER        01220021
ODDREG   EQU   11                       ARITHMETIC WORK REGISTER        01240021
VALREG   EQU   11                       WORK REGISTER                   01260021
TEMREG   EQU   11                       WORK REGISTER                   01280021
LINREG   EQU   12                       INTERNAL POR LINK REGISTER      01300021
ADDREG   EQU   14                       GENERAL USE ADDRESS REGISTER    01320021
CONREG   EQU   14                       CONTROL COUNT REGISTER          01340021
ERREG    EQU   15                       ERROR CODE REGISTER             01360021
         EJECT                                                          01380021
*************************                                               01400021
*   INITIALIZATION      *                                               01420021
*************************                                               01440021
GPVGRD   STM   14,12,12(13)                                             01460021
         BALR  BASE9,0                                                  01480021
         USING *,BASE9                                                  01500021
         USING PARTAB,PATREG                                            01520021
         USING WKAREA,WKAREG                                            01540021
         USING XYLIMT,XYLREG                                            01560021
         SR    ERREG,ERREG                                              01580021
         LM    OBPREG,PATREG,0(PARREG)  LOAD OCBP AND PARTAB ADDRESSES. 01600021
         L     XYLREG,XYLIM             LOAD ADDR OF XYLIM TABLE.       01620021
         L     WKAREG,4(0,OBPREG)       LOAD ADDR OF USER WORK AREA.    01640021
         L     OABREG,0(0,OBPREG)       LOAD ADDR OF CONTROL BLOCK.     01660021
*  SAVE MASK BITS AS SET BY USER                                        01680021
         ST    9,MASKSV                                                 01700021
         SR    WRKREG,WRKREG                                            01720021
         SPM   WRKREG                                                   01740021
         BAL   LINREG,XYLCHK            LINK TO XYLIM CHECK             01760021
         MVC   ERCOUNT,ZERO         CLEAR ERROR COUNTER                 01780021
         MVI   SGSW,X'00'                                               01800021
         MVI   LOADSW,X'00'                                             01820021
         CLI   F,C'F'                   CHECK FOR FLOATING POINT VALUES 01840021
         BE    FLOAT                    BRANCH IF FIX FL OPTION = F     01860021
         CLI   F,C'B'                                                   01880021
         BE    CHKS                     IF F PARA NOT = F OR B,         01900021
         BAL   LINKREG,ER40             LINK TO SET ERROR CODE.         01920021
CHKS     CLI   S,C'S'                   CHECK IF SCALING REQUIRED.      01940021
         BE    LINK1                    SCALE FIXED POINT VALUES.       01960021
         MVC   RINK(4),RINC             STORE RINC AND MAX-RADIUS       01980021
         MVC   MAXR(4),MAXRAD           IN THE USER WORK AREA.          02000021
         MVC   XC(8),UC                 UC,VC TO USER WORK AREA.        02020021
TSTS     CLI   S,C'N'                                                   02040021
         BE    CHKPARA                  IF SCALE PARA NOT S OR N,       02060021
         BAL   LINKREG,ER40             LINK TO SET ERROR CODE.         02080021
         B     CHKPARA                                                  02100021
FLOAT    CLI   S,C'S'                                                   02120021
         BE    LINK2                                                    02140021
         CLI   S,C'N'                   IF SCALE PARA NOT S OR N,       02160021
         BE    LINK0                    LINK TO SET ERROR CODE.         02180021
         BAL   LINKREG,ER40                                             02200021
LINK0    L     VALREG,UC                CONVERT UC,VC,RINC AND          02220021
         BAL   LINREG,FIXCONV           MAX-RADIUS TO FIXED POINT.      02240021
         ST    VALREG,XC                                                02260021
         L     VALREG,VC                                                02280021
         BAL   LINREG,FIXCONV                                           02300021
         ST    VALREG,YC                                                02320021
         L     VALREG,RINC                                              02340021
         BAL   LINREG,FIXCONV                                           02360021
         ST    VALREG,RINK                                              02380021
         L     VALREG,MAXRAD                                            02400021
         BAL   LINREG,FIXCONV                                           02420021
         ST    VALREG,MAXR                                              02440021
         B     CHKPARA                                                  02460021
LINK1    L     XREG,UC                  SCALE FIXED-POINT VALUES        02480021
         L     YREG,VC                  UC,VC,RINC,AND MAX-RADIUS.      02500021
         BAL   LINREG,SCALFIX                                           02520021
         ST    XREG,XC                                                  02540021
         ST    YREG,YC                                                  02560021
         L     XREG,RINC                                                02580021
         BAL   LINREG,FIXSCAL                                           02600021
         ST    XREG,RINK                                                02620021
         L     XREG,MAXRAD                                              02640021
         BAL   LINREG,FIXSCAL           BR TO SCALE MAXIMUM RADIUS.     02660021
         ST    XREG,MAXR                                                02680021
         B     CHKPARA                                                  02700021
LINK2    BAL   LINKREG,SCALFLT          SCALE FLOATING POINT VALUES     02720021
         MVC   VALUE1(4),RINC           UC,VC,RINC, AND MAXRAD.         02740021
         BAL   LINKREG,FLTSCAL                                          02760021
         ST    VALREG,RINK              STORE SCALED VALUES IN          02780021
         MVC   VALUE1(4),MAXRAD         XC,YC,RINK, AND MAXR.           02800021
         BAL   LINKREG,FLTSCAL                                          02820021
         ST    VALREG,MAXR                                              02840021
******************************                                          02860021
*   CHECK PARAMETER TABLE    *                                          02880021
******************************                                          02900021
CHKPARA  LM    XREG,YREG,XC             CHECK INPUT PARAMETERS.         02920021
         C     XREG,ZERO                IF XC IS LESS THAN ZERO,        02940021
         BL    ER8                      BR TO SET ERROR CODE & RETURN.  02960021
         C     XREG,C4095               IF XC IS GREATER THAN 4095,     02980021
         BH    ER8                      BR TO SET ERROR CODE & RETURN.  03000021
         C     YREG,ZERO                IF YC IS LESS THAN ZERO,        03020021
         BL    ER8                      BR TO SET ERROR CODE & RETURN.  03040021
         C     YREG,C4095                                               03060021
         BH    ER8                                                      03080021
         L     WRKREG,MAXR              CHECK MAXR AND RINK             03100021
         C     WRKREG,FOUR              TO SEE IF GT FOUR.              03120021
         BL    ER20                     SET ERROR CODE AND RET IF NOT.  03140021
         L     WRKREG,RINK                                              03160021
         C     WRKREG,FOUR                                              03180021
         BL    ER20                                                     03200021
         MVC   R(4),RINK                                                03220021
         CLI   TYPE,C'A'                                                03240021
         BE    TSTINC                                                   03260021
         CLI   TYPE,C'B'                IF TYPE NOT A OR B,             03280021
         BNE   ER20                     SET ERROR CODE AND RETURN.      03300021
RLOG     MVI   J,X'01'                  LOG GRID REQUESTED. SET J=1.    03320021
         MVC   LOGSAV(2),MINUS2                                         03340021
TSTINC   CLI   INC,C'A'                 CHECK PARAMETER INC TO SEE      03360021
         BE    SETA                     IF ALPHA OR DENSITY IS SPEC.    03380021
         CLI   INC,C'D'                                                 03400021
         BE    SETD                                                     03420021
SETC     BAL   LINKREG,ER40             IF INC NOT A OR D, SET INTERNAL 03440021
         MVI   INK,C'C'                 INDICATOR TO C, ERROR CODE TO   03460021
         B     AOK                      40 AND CONTINUE PROCESSING.     03480021
SETA     LH    WRKREG,ALPHA             ALPHA SPECIFIED.                03500021
         CH    WRKREG,ZERO                                              03520021
         BL    SETC                                                     03540021
         BE    SETCC                                                    03560021
         CH    WRKREG,H360                                              03580021
         BNL   SETC                                                     03600021
         MVI   INK,C'A'                 ALPHA OK.                       03620021
         MVC   ALPH(2),ALPHA            MOVE ALPHA TO USER WORK AREA.   03640021
         B     AOK                                                      03660021
SETCC    MVI   INK,C'C'                                                 03680021
         B     AOK                                                      03700021
SETD     LH    WRKREG,DENSITY           DENSITY SPECIFIED.              03720021
         CH    WRKREG,FOUR                                              03740021
         BL    SETC                                                     03760021
         MVI   INK,C'D'                                                 03780021
AOK      LA    CNTREG,2                 LENGTH OF GEPM ORDER TO CNTREG. 03800021
         LA    ADDREG,GEVM              LOAD ADDR OF GEVM ORDER.        03820021
         MVC   GOMODE,GEVM                                              03840021
         BAL   LINREG,STORE             LINK TO STORE GEPM ORDER.       03860021
         MVC   I(4),ONE                 SET I=1.                        03880021
         EJECT                                                          03900021
TESTINC  CLI   INK,C'C'                 IF INK=C, COMPUTE ALPHA=2048/R  03920021
         BE    COMPA                                                    03940021
         CLI   INK,C'D'                 IF INK NOT D, INK=A.            03960021
         BNE   SETNPT                                                   03980021
**************************************************                      04000021
* COMPUTE  TEMP=360*DENSITY/(2PI*R)              *                      04020021
*          ALPHA=INTEGRAL PART OF (TEMP+0.5)     *                      04040021
**************************************************                      04060021
ALPHAGET L     EVEREG,C360                                              04080021
         MH    EVEREG,DENSITY           COMPUTE 360*DENSITY             04100021
         SRDA  EVEREG,32                                                04120021
         SLDA  EVEREG,29                                                04140021
         D     EVEREG,TWOPI             COMPUTE 360*DENSITY/2PI         04160021
         SR    EVEREG,EVEREG                                            04180021
         L     WRKREG,R                                                 04200021
         DR    EVEREG,WRKREG            COMPUTE ALPHA=360*DENSITY/2PI/R 04220021
         A     ODDREG,ONE                                               04240021
         SRA   ODDREG,1                                                 04260021
         STH   ODDREG,ALPH              STORE ALPHA IN USER WORK AREA.  04280021
CHKA1    CLC   ALPH(2),ZERO                                             04300021
         BH    CHKA2                                                    04320021
SETALP   MVC   ALPH(2),ONE+2            SET ALPHA = 1.                  04340021
         B     SETNPT                                                   04360021
CHKA2    CLC   ALPH(2),H360                                             04380021
         BL    SETNPT                                                   04400021
         BAL   LINKREG,ER40                                             04420021
******************************                                          04440021
*   COMPUTE ALPHA=2048/R     *                                          04460021
******************************                                          04480021
COMPA    CLC   R(4),C1365               IF R IS GT 1365,                04500021
         BH    SETALP                   BR TO SET ALPHA TO ONE.         04520021
         CLC   R+2(2),C46               IF R IS LESS THAN 46,           04540021
         BL    SETA45                   SET ALPHA = 45.                 04560021
         LA    EVEREG,2048              IF NOT, COMPUTE ALPHA.          04580021
         SRDA  EVEREG,32                                                04600021
         SLDA  EVEREG,1                                                 04620021
         D     EVEREG,R                                                 04640021
         A     ODDREG,ONE                                               04660021
         SRA   ODDREG,1                                                 04680021
         STH   ODDREG,ALPH              STORE ALPHA IN USER WORK AREA.  04700021
         B     SETNPT                                                   04720021
SETA45   MVC   ALPH(2),C45                                              04740021
         B     SETNPT                                                   04760021
GETR     STH   INDEXREG,LOGSAV                                          04780021
         SR    EVEREG,EVEREG            COMPUTE  R=RINC*(I-1+LOG(J))    04800021
         L     EVEREG,I                 EVEREG=I                        04820021
         SH    EVEREG,ONE+2             EVEREG=I-1                      04840021
         SLA   EVEREG,14                                                04860021
         AH    EVEREG,LOGJ(INDEXREG)    EVEREG=I-1+LOG(J)               04880021
         SRDA  EVEREG,32                                                04900021
         M     EVEREG,RINK              EVEREG=R=RINC*(I-1+LOG(J))      04920021
         AH    ODDREG,POINT5                                            04940021
         SRA   ODDREG,14                REMOVE DECIMAL PORTION OF R     04960021
         ST    ODDREG,R                 AND STORE IN USER WORK AREA.    04980021
         BR    LINKREG                                                  05000021
SETNPT   MVC   K(2),ZERO                                                05020021
         CLC  R(4),C5793                SEE IF ALL POINTS WITH CURRENT  05040021
         BNH   SETPHI                   RADIUS WILL BE OUTSIDE SCREEN.  05060021
         MVC   PHI(2),H360                                              05080021
         MVC   PT1X(4),C5793                                            05100021
         L     XREG,C5793                                               05120021
         L     YREG,C5793                                               05140021
         OI    SGSW,X'FF'                                               05160021
         B     OFFSCR                   BR TO CHECK OFF SCREEN OPTION.  05180021
SETPHI   LH    ODDREG,K                 SET PHI=K*ALPHA                 05200021
         MH    ODDREG,ALPH                                              05220021
         STH   ODDREG,PHI               STORE VALUE IN USER WRK AREA.   05240021
         LA    LINREG,OFFCHECK                                          05260021
         EJECT                                                          05280021
***********************************                                     05300021
*   DETERMINE QUADRANT OF PHI.    *                                     05320021
*   GET SIN%PHI< AND COS%PHI<     *                                     05340021
*   FROM SINE/COSINE TABLE.       *                                     05360021
***********************************                                     05380021
GETQUAD  CLC   PHI(2),C90               CHECK IF PHI IN 1'ST QUADRANT.  05400021
         BH    CK180                    IF NOT, CHECK QUADRANT 2.       05420021
         CLC   PHI(2),C46                                               05440021
         BL    TBLOK                                                    05460021
         MVI   FUNCSW,X'0F'             PHI IN RANGE OF 46-90 DEG.      05480021
         LA    WRKREG,90                                                05500021
         B     LOOKUP1                  GO TO EXTRACT SIN(PHI),COS(PHI) 05520021
TBLOK    MVI   FUNCSW,X'00'             PHI IN RANGE OF 0-45 DEG.       05540021
         LA    WRKREG,0                                                 05560021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 05580021
CK180    CLC   PHI(2),C180              CHECK IF PHI IN 2'ND QUADRANT   05600021
         BH    CK270                    IF NOT, CHECK QUADRANT 3.       05620021
         CLC   PHI(2),C136                                              05640021
         BL    PHI180                                                   05660021
         MVI   FUNCSW,X'30'             PHI IN RANGE OF 136-180 DEG.    05680021
         LA    WRKREG,180                                               05700021
         B     LOOKUP1                  GO TO EXTRACT SIN(PHI),COS(PHI) 05720021
PHI180   MVI   FUNCSW,X'3F'             PHI IN RANGE OF 91-135 DEG.     05740021
         LA    WRKREG,90                                                05760021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 05780021
CK270    CLC   PHI(2),C270              CHECK IF PHI IN 3'RD QUAD.      05800021
         BH    CK315                    IF NOT, PHI IN QUADRANT 4.      05820021
         CLC   PHI(2),C226                                              05840021
         BL    PHI270                                                   05860021
         MVI   FUNCSW,X'FF'             PHI IN RANGE OF 226-270 DEG.    05880021
         LA    WRKREG,270                                               05900021
         B     LOOKUP1                  GO TO EXTRACT SIN(PHI),COS(PHI) 05920021
PHI270   MVI   FUNCSW,X'F0'             PHI IN RANGE OF 181-225 DEG.    05940021
         LA    WRKREG,180                                               05960021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 05980021
CK315    CLC   PHI(2),C315                                              06000021
         BH    PHI360                                                   06020021
         MVI   FUNCSW,X'CF'             PHI IN RANGE OF 271-315 DEG.    06040021
         LA    WRKREG,270                                               06060021
         B     LOOKUP2                  GO TO EXTRACT SIN(PHI),COS(PHI) 06080021
PHI360   CLC   PHI(2),H360                                              06100021
         BNL   SET360                                                   06120021
         MVI   FUNCSW,X'C0'             PHI IN RANGE OF 316-360 DEG.    06140021
         LA    WRKREG,360                                               06160021
         B     LOOKUP1                                                  06180021
SET360   L     INXREG,ZERO                                              06200021
         MVI   FUNCSW,X'00'                                             06220021
         B     EXTRACT                                                  06240021
LOOKUP1  SH    WRKREG,PHI                                               06260021
         LR    INXREG,WRKREG                                            06280021
         B     EXTRACT                                                  06300021
LOOKUP2  LH    INXREG,PHI                                               06320021
         SR    INXREG,WRKREG                                            06340021
EXTRACT  MH    INXREG,FOUR+2                                            06360021
         TM    FUNCSW,X'0F'             IF FUNCSW=0F, GO TO PUT COS     06380021
         BO    SWITCH                   IN SINREG AND SIN IN COSREG.    06400021
         LH    SINREG,SINE(INXREG)      LOAD SINE TO SINREG.            06420021
         LH    COSREG,COSINE(INXREG)    LOAD COSINE TO COSREG.          06440021
         B     TSIGNS                   GO TO TEST SIGN OF FUNCTIONS.   06460021
SWITCH   LH    SINREG,COSINE(INXREG)    LOAD COSINE TO SINREG.          06480021
         LH    COSREG,SINE(INXREG)      LOAD SINE TO COSREG.            06500021
TSIGNS   TM    FUNCSW,X'C0'             SEE IF SIGN OF SINE IS MINUS.   06520021
         BZ    TSIGNC                                                   06540021
         MH    SINREG,MINUS1                                            06560021
TSIGNC   TM    FUNCSW,X'30'             SEE IF SIGN OF COSINE IS MINUS. 06580021
         BZ    MULTR                                                    06600021
         MH    COSREG,MINUS1                                            06620021
         EJECT                                                          06640021
**************************************************                      06660021
*   COMPUTE  X=XC+R*COS(PHI) AND Y=YC+R*SIN(PHI) *                      06680021
**************************************************                      06700021
MULTR    LR    EVEREG,COSREG            LOAD COS(PHI)                   06720021
         SRDA  EVEREG,32                                                06740021
         M     EVEREG,R                 R*COS(PHI)                      06760021
         L     COSREG,XC                                                06780021
         SLA   COSREG,14                                                06800021
         AR    COSREG,ODDREG            XC+R*COS(PHI)                   06820021
         AH    COSREG,POINT5                                            06840021
         SRA   COSREG,14                SHIFT OFF DECIMAL PORTION OF X. 06860021
         LR    EVEREG,SINREG            LOAD SIN(PHI)                   06880021
         SRDA  EVEREG,32                                                06900021
         M     EVEREG,R                 R*SIN(PHI)                      06920021
         L     SINREG,YC                                                06940021
         SLA   SINREG,14                                                06960021
         AR    SINREG,ODDREG            YC+R*SIN(PHI)                   06980021
         AH    SINREG,POINT5                                            07000021
         SRA   SINREG,14                SHIFT OFF DECIMAL PORTION OF Y. 07020021
         BR    LINREG                                                   07040021
****************************************                                07060021
*   XREG=COSREG=X   YREG=SINREG=Y      *                                07080021
****************************************                                07100021
OFFCHECK BAL   LINKREG,CHKOFF           LINK TO OFF GRID/SCREEN CHECK.  07120021
         B     OFFGRD                   IF POINT OFF GRID.              07140021
         B     OFFSCR                   IF POINT OFF SCREEN.            07160021
         B     CONT                     IF POINT OK.                    07180021
CHKOFF   C     XREG,C4095               TEST X- AND Y-COORDINATES       07200021
         BH    4(0,LINKREG)             TO SEE IF OFF-SCREEN/GRID.      07220021
         C     XREG,ZERO                                                07240021
         BL    4(0,LINKREG)                                             07260021
         C     YREG,C4095                                               07280021
         BH    4(0,LINKREG)                                             07300021
         C     YREG,ZERO                                                07320021
         BL    4(0,LINKREG)                                             07340021
         CH    XREG,X1                                                  07360021
         BL    0(0,LINKREG)                                             07380021
         CH    XREG,X2                                                  07400021
         BH    0(0,LINKREG)                                             07420021
         CH    YREG,Y1                                                  07440021
         BL    0(0,LINKREG)                                             07460021
         CH    YREG,Y2                                                  07480021
         BH    0(0,LINKREG)                                             07500021
         CLI   SGSW,X'F0'               SEE IF PREVIOUS POINT WAS OFF.  07520021
         BE    PT2ON                                                    07540021
         B     8(0,LINKREG)                                             07560021
OFFGRD   BAL   LINKREG,TSTGR            LINK TO TEST USER OPTION.       07580021
         B     LINKG                      IF OPTION = A OR C.           07600021
         TM    SGSW,X'F0'                                               07620021
         BO    PT2ON                                                    07640021
         B     CONT                       IF OPTION = B,E, OR INVALID.  07660021
TSTGR    CLI   OFFSG,C'A'               SET ERROR CODE AND LINK TO      07680021
         BNE   GRDC                     GOFFSG ROUTINE IF S/G OPTION    07700021
         BAL   LINREG,ER44              IS EQUAL TO A. SHOW ALL POINTS  07720021
         BR    LINKREG                  ON GRID AND CONTINUE PROCESSING 07740021
GRDC     CLI   OFFSG,C'C'               IF S/G OPTION IS EQ TO A OR C.  07760021
         BNE   GRDB                                                     07780021
         BR    LINKREG                                                  07800021
GRDB     CLI   OFFSG,C'B'               SHOW POINT IF S/G-OPTION=B      07820021
         BE    4(0,LINKREG)                                             07840021
GRDD     CLI   OFFSG,C'D'                                               07860021
         BNE   GRDE                                                     07880021
         LA    LINREG,RET               SET ERROR CODE AND RETURN TO    07900021
         B     ER28                     CALLING PROG IF S/G OPTION=D    07920021
GRDE     CLI   OFFSG,C'E'                                               07940021
         BE    4(0,LINKREG)                                             07960021
         LR    TEMREG,LINREG                                            07980021
         BAL   LINKREG,ER40             S/G OPTION INVALID.             08000021
         B     4(0,TEMREG)                                              08020021
OFFSCR   BAL   LINKREG,TSTSR            LINK TO TEST USER OPTION.       08040021
         B     LINKS                      IF OPTION = A OR B.           08060021
         B     LINKG                                                    08080021
TSTSR    CLI   OFFSG,C'A'                                               08100021
         BNE   SCRB                                                     08120021
         BAL   LINREG,ER44                                              08140021
         B     4(0,LINKREG)                                             08160021
SCRB     CLI   OFFSG,C'B'                                               08180021
         BNE   SCRC                                                     08200021
         BAL   LINREG,ER48                                              08220021
         BR    LINKREG                                                  08240021
SCRC     CLI   OFFSG,C'C'               SEE IF OPTION C                 08260021
         BNE   SCRD                                                     08280021
         LA    LINREG,RET                                               08300021
         B     ER32                                                     08320021
SCRD     CLI   OFFSG,C'D'                                               08340021
         BNE   SCRE                                                     08360021
         LA    LINREG,RET               SET ERROR CODE AND RETURN TO    08380021
         B     ER28                     CLLING PROG IF S/G OPTION=D     08400021
SCRE     LA    LINREG,RET                                               08420021
         B     ER32                     ERROR 32 ASSUMED.               08440021
LINKG    ST    XYLREG,SABL                                              08460021
         B     CHK1ST                                                   08480021
LINKS    LA    WRKREG,ZERO                                              08500021
         ST    WRKREG,SABL                                              08520021
         B     CHK1ST                                                   08540021
CONT     STH   XREG,GDV1                STORE X-COORDINATE IN GDV.      08560021
         STH   YREG,GDV1+2              STORE Y-COORDINATE IN GDV.      08580021
         CLC   PHI(2),ZERO                                              08600021
         BNE   PUTGDV                                                   08620021
         OI    GDV1,X'40'                                               08640021
PUTGDV   LA    CNTREG,4                 LENGTH OF GDV TO COUNT REG.     08660021
         LA    ADDREG,GDV1                                              08680021
SAVEXY   STM   XREG,YREG,VALUE1                                         08700021
         BAL   LINREG,STORE             LINK TO STORE GDV X,Y,U.        08720021
         LM    XREG,YREG,VALUE1                                         08740021
OMIT     CLC   PHI(2),H360              CHECK FOR END OF GENERATION     08760021
         BNL   TSTGRD                   FOR CURRENT CYCLE.              08780021
         LH    EVEREG,K                 IF MORE POINTS TO COMPUTE, SET  08800021
         A     EVEREG,ONE               K=K+1 AND RETURN TO COMPUTE     08820021
         STH   EVEREG,K                 THE NEXT X,Y VALUES.            08840021
         STM   XREG,YREG,PT1X                                           08860021
         B     SETPHI                                                   08880021
TSTGRD   MVI   SGSW,X'00'               RESET SCREEN GRID SWITCH        08900021
         CLI   TYPE,C'B'                                                08920021
         BNE   TESTI                    BRANCH IF LINEAR GRID.          08940021
         CLI   J,X'08'                                                  08960021
         BH    TESTI                                                    08980021
         SR    EVEREG,EVEREG                                            09000021
         IC    EVEREG,J                                                 09020021
         A     EVEREG,ONE               SET J=J+1                       09040021
         STC   EVEREG,J                                                 09060021
         LH    INDEXREG,LOGSAV          GET ADDRESS OF                  09080021
         A     INDEXREG,TWO             CURRENT LOG(J).                 09100021
         BAL   LINKREG,GETR                                             09120021
         B     TESTINC                                                  09140021
TESTI    SR    EVEREG,EVEREG                                            09160021
         L     EVEREG,I                 LOAD THE NO OF CIRCLES.         09180021
         A     EVEREG,ONE               SET I=I+1      I=# OF CIRCLES,  09200021
         ST    EVEREG,I                                OR LOG CYCLES.   09220021
         SRDA  EVEREG,32                                                09240021
         M     EVEREG,RINK              MULTIPLY I BY RINC.             09260021
         CL    ODDREG,MAXR              IF MAX-RADIUS IS LT I*RINC      09280021
         BH    TESTNR                   BR TO TEST THE NO OF RADII.     09300021
         ST    ODDREG,R                 NEW LOG CYCLE.                  09320021
         CLI   TYPE,C'B'                                                09340021
         BE    SETJ                                                     09360021
         B     TESTINC                                                  09380021
SETJ     MVI   J,X'01'                  SET J=1 AND                     09400021
         MVC   LOGSAV(2),MINUS2         RETURN TO GEN                   09420021
         B     TESTINC                  NEXT LOG CYCLE.                 09440021
CHK1ST   CLC   PHI(2),ZERO              IF FIRST POINT FOR CURRENT      09460021
         BNE   SETUP                    CIRCLE EXCEEDS BOUNDRY, SET ON  09480021
         MVI   SGSW,X'F0'               PT1 PART OF SGSW,               09500021
         B     OMIT                     AND BRANCH TO OMIT POINT.       09520021
SETUP    OI    SGSW,X'0F'                   SET ON PT2 PART OF SGSW,    09540021
PT2ON    STM   XREG,YREG,PT2X           STORE COORDINATES IN PT2X,PT2Y. 09560021
         STM   14,1,SAVE                STORE VITAL REGISTERS.          09580021
         ST    13,OVFSAVE+4                                             09600021
         ST    15,SVR15                 SAVE ERROR REGISTER             09620021
         LA    13,OVFSAVE               SET UP SAVE AREA FOR GOFFSG.    09640021
         LR    WRKREG,WKAREG            SAVE WORK AREA ADDRESS,         09660021
         CLI   LOADSW,X'FF'             IF LOADSW IS ON, BR TO GET ADDR 09680021
         BE    GETIT                    OF GOFFSG. IF LOADSW IS OFF,    09700021
         LA    1,SABL                   POINT TO PARAMETER TABLE AND,   09720021
         LOAD EP=GOFFSG                 GET ADDR OF OFF SCREEN/GR1D RTN 09740021
         LR    WKAREG,WRKREG                                            09760021
         ST    0,LOADSW                 STORE ADDR OF GOFFSG ROUTINE.   09780021
         OI    LOADSW,X'FF'             SET LOAD SWITCH ON.             09800021
GETIT    L     15,LOADSW                LOAD ADDR OF GOFFSG ROUTINE.    09820021
         LA    1,SABL                                                   09840021
         BALR  14,15                    BRANCH & LINK TO GOFFSG.        09860021
RESET    LR    WKAREG,WRKREG                                            09880021
         LM    14,0,SAVE                                                09900021
         L     13,OVFSAVE+4             RESTORE SAVE AREA ADDRESS.      09920021
         L     15,SVR15                 RESTORE ERROR REGISTER          09940021
CHKNI    CLI   SGSW,B'10101010'         IF SIGN SET TO 10101010, GO TO  09960021
         BE    8(0,LINKREG)             PROCESS RADIAL VECTORS.         09980021
         CLI   NI+3,X'02'               IF NI=2, BR TO GENERATE ORDERS  10000021
         BE    PUT2I                    FOR LINE FROM INTS1 TO INTS2.   10020021
         TM    SGSW,X'F0'               SEE IF PREVIOUS POINT WAS OUT   10040021
         BO    SGSWFF                   OF BOUNDRY LIMITS.              10060021
         CLI   NI+3,X'00'               IF NOT, CHECK # OF INTERSECT    10080021
         BE    GOBACK                   POINTS. IF NONE, BR TO GOBACK.  10100021
         MVC   GDV1(4),INTS1X           GDV1 = GDV INTS1X,INTS1Y,U      10120021
         LA    CNTREG,4                                                 10140021
SGSTORE  LA    ADDREG,GDV1                                              10160021
         MVI   SGSW,X'F0'               SET SGSW TO INDICATE PREVIOUS   10180021
         B     SAVEXY                   POINT EXCEEDED BOUNTRY.         10200021
PUT2I    MVC   GDV1(8),INTS1X           GDV1 = GDV INTS1X,INTS1Y,B      10220021
         OI    GDV1,X'40'               GDV2 = GDV INTS2X,INTS2Y,U      10240021
         LA    CNTREG,8                                                 10260021
         B     SGSTORE                                                  10280021
SGSWFF   TM    SGSW,X'FF'               SEE IF BOTH POINTS OFF          10300021
         BM    SGSWF0                                                   10320021
         CLI   NI+3,X'00'               IF NO INTERSECT                 10340021
         BE    GOBACK                                                   10360021
         MVC   GDV1(4),INTS1X           GDV1 = INTS1X,UNTS1Y,B          10380021
         MVC   GDV2(4),INTS1X           GDV2 = INTS1X,UNTS1Y,U          10400021
         LA    CNTREG,8                                                 10420021
         B     SGSTORE                                                  10440021
GOBACK   MVI   SGSW,X'F0'                                               10460021
         B     OMIT                                                     10480021
SGSWF0   CLI   NI+3,X'00'               IF NO INTERSECT POINTS,         10500021
         BE    PUTPOINT                 GO TO PUT POINT AT PT2.         10520021
         MVC   GDV1(4),INTS1X           GDV1 = INTS1X,INTS1Y,B          10540021
         STH   XREG,GDV2                GDV2 = X,Y,U                    10560021
         STH   YREG,GDV2+2                                              10580021
         B     PUT1I                                                    10600021
PUTPOINT STH   XREG,GDV1                GDV1 = X,Y,B                    10620021
         STH   YREG,GDV1+2                                              10640021
         MVC   GDV2(4),GDV1             GDV2 = X,Y,U                    10660021
PUT1I    OI    GDV1,X'40'                                               10680021
         LA    CNTREG,8                                                 10700021
         LA    ADDREG,GDV1                                              10720021
SETSWSG  MVI   SGSW,X'00'                                               10740021
         B     SAVEXY                                                   10760021
         EJECT                                                          10780021
TESTNR   CLC   NR(2),ZERO               IF NO RADII REQUESTED,          10800021
         BE    RET                      RETURN TO USER ROUTINE.         10820021
         MVI   SGSW,B'10101010'         SET SGSW TO INDICATE RADII.     10840021
***********************************                                     10860021
*   COMPUTE END POINTS OF RADII   *                                     10880021
***********************************                                     10900021
         SR    WRKREG,WRKREG                                            10920021
         LH    WRKREG,NR                                                10940021
         LA    EVEREG,360                                               10960021
         SRDA  EVEREG,32                                                10980021
         DR    EVEREG,WRKREG            COMPUTE PHI = 360/NR            11000021
         C     EVEREG,ZERO              IF 360/NR = INTEGER,            11020021
         BE    GETANGLE                 BR TO GET SINE/COSINE.          11040021
         LA    ERREG,40                 IF NOT, ERROR.                  11060021
         BAL   LINREG,ERRCNT            NO RADII GENERATED.             11080021
         B     RET                                                      11100021
GETANGLE STH   ODDREG,PHI                                               11120021
         MVC   NPT(2),PHI                                               11140021
         MVC   R(4),MAXR                                                11160021
         MVC   PT1X(8),XC                                               11180021
         LM    XREG,YREG,XC                                             11200021
         BAL   LINKREG,CHKOFF                                           11220021
         B     XCOFFG                                                   11240021
         B     XCOFFG                                                   11260021
         MVI   BNDRSW,X'00'                                             11280021
         B     LINKR                                                    11300021
XCOFFG   MVI   BNDRSW,X'F0'                                             11320021
LINKR    BAL   LINREG,GETQUAD                                           11340021
         BAL   LINKREG,CHKOFF                                           11360021
         B     GRDOFF                                                   11380021
         B     SCROFF                                                   11400021
         OI    BNDRSW,X'0F'                                             11420021
         TM    BNDRSW,X'F0'                                             11440021
         BO    GRDOFF                                                   11460021
ONSCR    MVC   GDV1(2),XC+2                                             11480021
         MVC   GDV1+2(2),YC+2                                           11500021
         STH   XREG,GDV2                                                11520021
         STH   YREG,GDV2+2                                              11540021
         B     PUTRADII                                                 11560021
GRDOFF   BAL   LINKREG,TSTGR                                            11580021
         B     LINKGR                                                   11600021
         B     ONSCR                                                    11620021
         B     TESTNI                                                   11640021
SCROFF   BAL   LINKREG,TSTSR                                            11660021
         B     LINKSR                                                   11680021
         B     LINKGR                                                   11700021
         B     TESTNI                                                   11720021
TESTNI   CLI   NI+3,X'02'                                               11740021
         BE    GEN2                                                     11760021
         CLI   NI+3,X'01'                                               11780021
         BE    GEN1A                                                    11800021
         B     NOGEN                                                    11820021
GEN1A    TM    BNDRSW,X'F0'                                             11840021
         BO    GEN1B                                                    11860021
         MVC   GDV2(4),INTS1X                                           11880021
         MVC   GDV1(2),XC+2                                             11900021
         MVC   GDV1+2(2),YC+2                                           11920021
         B     PUTRADII                                                 11940021
GEN1B    MVC   GDV1(4),INTS1X                                           11960021
         TM    BNDRSW,X'0F'                                             11980021
         BO    PUTP2                                                    12000021
         TM    BNDRSW,X'03'                                             12020021
         BO    PUTXCYC                                                  12040021
         MVC   GDV2(4),INTS1X                                           12060021
         B     PUTRADII                                                 12080021
PUTP2    STH   XREG,GDV2                                                12100021
         STH   YREG,GDV2+2                                              12120021
         B     PUTRADII                                                 12140021
PUTXCYC  MVC   GDV2(2),XC+2                                             12160021
         MVC   GDV2+2(2),YC+2                                           12180021
         B     PUTRADII                                                 12200021
GEN2     MVC   GDV1(4),INTS1X                                           12220021
         MVC   GDV2(4),INTS2X                                           12240021
         B     PUTRADII                                                 12260021
LINKGR   ST    XYLREG,SABL                                              12280021
         B     PT2ON                                                    12300021
LINKSR   OI    BNDRSW,X'03'                                             12320021
         LA    WRKREG,ZERO                                              12340021
         ST    WRKREG,SABL                                              12360021
         B     PT2ON                                                    12380021
PUTRADII OI    GDV1,X'40'                                               12400021
         LA    CNTREG,8                 STORE GDV ORDERS IN GDOA.       12420021
         LA    ADDREG,GDV1                                              12440021
         BAL   LINREG,STORE                                             12460021
NOGEN    CLC   PHI(2),H360                                              12480021
         BE    RET                                                      12500021
         NI    BNDRSW,X'F0'                                             12520021
         LH    ODDREG,NPT                                               12540021
         AH    ODDREG,PHI                                               12560021
         STH   ODDREG,PHI                                               12580021
         B     LINKR                                                    12600021
         EJECT                                                          12620021
*********************************************                           12640021
*        XYLCHK     SUBROUTINE              *                           12660021
*        ADDRESS OF XYLIM TABLE IN XYLREG   *                           12680021
*********************************************                           12700021
XYLCHK   LA    CNTREG,4                 SET  LOOP  COUNT                12720021
         LA    INXREG,0                 SET  INDEX                      12740021
XYLLOOP  LH    WRKREG,0(XYLREG,INXREG)  LOAD  X1,Y1,X2,Y2               12760021
         C     WRKREG,ZERO                                              12780021
         BL    XYLERR                                                   12800021
         C     WRKREG,HIGH                                              12820021
         BH    XYLERR                                                   12840021
         A     INXREG,TWO                                               12860021
         BCT   CNTREG,XYLLOOP                                           12880021
         CLC   0(2,XYLREG),4(XYLREG)    X1 COMP  X2                     12900021
         BNL   XYLERR                                                   12920021
         CLC   2(2,XYLREG),6(XYLREG)    Y1 COMP  Y2                     12940021
         BNL   XYLERR                                                   12960021
         BR    LINREG                                                   12980021
XYLERR   LA    15,4                     SET ERROR CODE = 4              13000021
         BAL   LINREG,ERRCNT                                            13020021
         B     RET                                                      13040021
ER8      LA    ERREG,8                  UC,VC PARAMETER ERROR,          13060021
         BAL   LINREG,ERRCNT            IMMEDIATE RETURN.               13080021
         B     RET                                                      13100021
ER12   LA    ERREG,12                                                   13120021
       BAL   LINKREG,ERRCNT                                             13140021
       B     RET                                                        13160021
ER16     BAL   LINREG,ERRCNT                                            13180021
         LA    ERREG,16                                                 13200021
         B     RET                                                      13220021
ER20     LA    ERREG,20                 INPUT PARAMETER ERROR,          13240021
         BAL   LINREG,ERRCNT            IMMEDIATE RETURN.               13260021
         B     RET                                                      13280021
ER28     LA    ERREG,28                 S/G OPTION = D.                 13300021
         B     ERRCNT                                                   13320021
ER32     LA    ERREG,32                 S/G OPTION = C OR E.            13340021
         B     ERRCNT                                                   13360021
ER40     LA    ERREG,40                 INPUT PARAMETER ERROR,          13380021
         BAL   LINREG,ERRCNT            COUNT ERRORS AND CONTINUE.      13400021
         BR    LINKREG                                                  13420021
ER44     LA    ERREG,44                 S/G OPTION = A.                 13440021
         B     ERRCNT                                                   13460021
ER48     LA    ERREG,48                 S/G OPTION = B.                 13480021
ERRCNT   L     TEMREG,ERCOUNT                                           13500021
         A     TEMREG,ONE                                               13520021
         ST    TEMREG,ERCOUNT                                           13540021
         BR    LINREG                                                   13560021
RET      LA    TEMREG,1                                                 13580021
         C     TEMREG,ERCOUNT                                           13600021
         BL    SETBIT                                                   13620021
RETURN   CLI   LOADSW,X'00'                                             13640021
         BE    RETMACRO                                                 13660021
         ST    15,SVR15                 SAVE ERROR REGISTER             13680021
         LR    WRKREG,1                 SAVE REGISTER 1                 13700021
         DELETE EP=GOFFSG                                               13720021
         LR    1,WRKREG                 RESTORE REGISTER 1              13740021
         L     15,SVR15                 RESTORE ERROR REGISTER          13760021
* RESTORE PROGRAM MASK TO SETTING UPON ENTRY                            13780021
RETMACRO L     WRKREG,MASKSV                                            13800021
         SPM   WRKREG                                                   13820021
         RETURN (14,12),T,RC=(15)                                       13840021
SETBIT   O     15,MZERO                                                 13860021
         B     RETURN                                                   13880021
         EJECT                                                          13900021
SCALFLT  LA    CONREG,4                 LOOP  COUNT                     13920021
         LA    INXREG,0                 SET INDEX                       13940021
         LA    WRKREG,0                                                 13960021
FLTLOOP  LH    VALREG,0(XYLREG,INXREG)  GET X1Y1,X2Y2 VALUES            13980021
         BAL   LINREG,FLTCONV                                           14000021
         ST    VALREG,4(WKAREG,WRKREG)                                  14020021
         A     INXREG,TWO                                               14040021
         A     WRKREG,FOUR                                              14060021
         BCT   CONREG,FLTLOOP                                           14080021
***********************************                                     14100021
*   SUBROUTINE TO SCALE FLOATING  *                                     14120021
*   POINT COORDINATES UC,VC.      *                                     14140021
***********************************                                     14160021
         LE    0,UC                                                     14180021
         SE    0,U1                     UC-U1                           14200021
         LE    2,12(WKAREG)             LOAD CONVERTED X2.              14220021
         SE    2,4(WKAREG)              X2-X1                           14240021
         MER   0,2                      (UC-U1)*(X2-X1)                 14260021
         LE    2,U2                                                     14280021
         SE    2,U1                     U2-U1                           14300021
         BC    13,ER16                  BRANCH ON OVF, MINUS OR ZERO    14320021
         DER   0,2                      ((UC-U1)*(X2-X1))/(U2-U1)       14340021
         AE    0,4(WKAREG)              ADD X1 TO COMPLETE FUNCTION.    14360021
         STE   0,0(WKAREG)                                              14380021
         L     VALREG,0(WKAREG)                                         14400021
         BAL   LINREG,FIXCONV                                           14420021
         ST    VALREG,XC                                                14440021
         LE    0,VC                                                     14460021
         SE    0,V1                                                     14480021
         LE    2,16(WKAREG)                                             14500021
         SE    2,8(WKAREG)                                              14520021
         MER   0,2                                                      14540021
         LE    2,V2                                                     14560021
         SE    2,V1                     V2-V1                           14580021
         BC    13,ER16                  BRANCH ON OVF, MINUS OR ZERO    14600021
         DER   0,2                      ((VC-V1)*(Y2-Y1)/(V2-V1)        14620021
         AE    0,8(WKAREG)              ADD Y1 TO COMPLETE FUNCTION     14640021
         STE   0,0(WKAREG)                                              14660021
         L     VALREG,0(WKAREG)                                         14680021
         BAL   LINREG,FIXCONV                                           14700021
         ST    VALREG,YC                                                14720021
         BR    LINKREG                                                  14740021
**************************************************                      14760021
*   SUBROUTINE TO SCALE FLOATING POINT VALUES    *                      14780021
*   SVAL=XINC*((X2-X1)/(U2-U1))  XINC=RINC OR MRU*                      14800021
*   SVAL REPRESENTS RINC OR MRU SCALED           *                      14820021
**************************************************                      14840021
FLTSCAL  LE    0,12(WKAREG)             X2                              14860021
         SE    0,4(WKAREG)              -X1                             14880021
         ME    0,VALUE1                 *UI                             14900021
         LE    2,12(XYLREG)             U2                              14920021
         SE    2,8(XYLREG)              -U1                             14940021
         DER   0,2                                                      14960021
         STE   0,0(WKAREG)                                              14980021
         L     XREG,0(WKAREG)           XREG CONTAINS SCALED FP UI      15000021
         L     VALREG,0(WKAREG)                                         15020021
         BAL   LINREG,FIXCONV           BR AND LINK TO CONVERT RTN.     15040021
         LR    XREG,VALREG              LOAD XREG WITH SCALED INC       15060021
         BR    LINKREG                  AND RETURN TO MAINLINE.         15080021
         EJECT                                                          15100021
*********************************************                           15120021
*   CONVERT FLOATING POINT TO FIXED POINT   *                           15140021
*   VALREG = VALUE TO BE CONVERTED          *                           15160021
*********************************************                           15180021
FIXCONV  ST    1,OVFSAVE                STORE REG 1 IN WORK AREA        15200021
         TM    OVFSAVE+3,X'07'          TEST LAST THREE BITS            15220021
         BZ    *+12                     NO BITS ON, SET INDEX TO ZERO   15240021
         LA    TEMREG,4                 SET MODIFIER                    15260021
         B     *+8                      START CONVERSION                15280021
         LA    TEMREG,0                 SET MODIFIER TO ZERO            15300021
         ST    VALREG,TEMFLT(TEMREG)    SAVE FLOAT VALUE                15320021
         SR    WRKREG,WRKREG                                            15340021
         ST    WRKREG,TEMFLT+4(TEMREG)  CLEAR SECOND WORD               15360021
         LD    6,TEMFLT(TEMREG)         VALUE TO FLOAT REGISTERS        15380021
         N     VALREG,FCHAR                                             15400021
         BE    FLERR1                   CHARACTERISTIC IS ZERO          15420021
         AE    6,FLPT5                  ADD .5 TO ROUND                 15440021
         AW    6,X4E                    ADD UNNORMALIZED-RIGHT JUSTIFY  15460021
         STD   6,TEMFLT(TEMREG)         SAVE VALUES                     15480021
         L     WRKREG,TEMFLT+4(TEMREG)  CHECK SECOND WORD               15500021
         N     WRKREG,MZERO             CHECK BIT 32                    15520021
         BM    ER12                     BRANCH ON MINUS                 15540021
         L     WRKREG,TEMFLT(TEMREG)                                    15560021
         N     WRKREG,BYTE123                                           15580021
         BM    ER12                     BRANCH ON MINUS                 15600021
         L     WRKREG,TEMFLT(TEMREG)                                    15620021
         N     WRKREG,MZERO             DROP CHARACTERISTIC             15640021
         L     VALREG,TEMFLT+4(TEMREG)  NEW FIXED VALUE                 15660021
         LTR   WRKREG,WRKREG                                            15680021
         BNL   NOTNEG                   NOT NEGATIVE                    15700021
         LNR   VALREG,VALREG            TAKE TWO'S COMPLEMENT           15720021
NOTNEG   BR    LINREG                   RETURN TO MAINLINE.             15740021
FLERR1   CE    6,ZERO                   IS TOTAL VALUE ZERO             15760021
         BE    NOTNEG                   RETURN                          15780021
         B     ER12                     ERROR 12                        15800021
**************************************************                      15820021
*    CONVERT  FIXED  POINT  TO  FLOATING  POINT  *                      15840021
*    VALREG CONTAINS THE VALUE TO BE CONVERTED   *                      15860021
**************************************************                      15880021
FLTCONV  O     VALREG,X6                EXPONENT OF 6                   15900021
         ST    VALREG,0(WKAREG)                                         15920021
         LE    0,0(WKAREG)              LOAD FLOATING PT REG            15940021
         AE    0,X6                     NORMALIZE                       15960021
         STE   0,0(WKAREG)                                              15980021
         L     VALREG,0(WKAREG)         FLOAT PT VAL IN VALREG          16000021
         BR    LINREG                                                   16020021
         EJECT                                                          16040021
**********************************                                      16060021
*   SUBROUTINE TO SCALE FIXED     *                                     16080021
*   FIXED POINT COORDINATES UC,VC *                                     16100021
***********************************                                     16120021
SCALFIX  S     XREG,U1                  COMPUTE UC-U1                   16140021
         LR    ODDREG,XREG              LOAD MULTIPLICAND               16160021
         LH    XREG,X2                                                  16180021
         SH    XREG,X1                  COMPUTE X2-X1                   16200021
         SR    EVEREG,EVEREG                 AND                        16220021
         MR    EVEREG,XREG              (UC-U1)*(X2-X1)                 16240021
         L     XREG,U2                                                  16260021
         S     XREG,U1                  COMPUTE U2-U1                   16280021
         BC    13,ER16                  BRANCH ON OVF, MINUS OR ZERO    16300021
         DR    EVEREG,XREG              COMPUTE ((UC-U1)<(X2-X1))/U2-U1 16320021
         AH    ODDREG,X1                COMPLETE FUNCTION BY ADDING X1. 16340021
         LR    XREG,ODDREG              RETURN SCALED VALUE IN XREG.    16360021
         S     YREG,V1                  COMPUTE VC-V1                   16380021
         LR    ODDREG,YREG                                              16400021
         LH    YREG,Y2                                                  16420021
         SH    YREG,Y1                  COMPUTE Y2-Y1                   16440021
         MR    EVEREG,YREG              (VC-V1)*(Y2-Y1)                 16460021
         L     YREG,V2                                                  16480021
         S     YREG,V1                  COMPUTE V2-V1                   16500021
         BC    13,ER16                  BRANCH ON OVF, MINUS OR ZERO    16520021
         SR    EVEREG,EVEREG                                            16540021
         DR    EVEREG,YREG              COMPUTE ((VC-V1)*(Y2-Y1))/U2-V1 16560021
         AH    ODDREG,Y1                COMPLETE FUNCTION BY ADDING Y1. 16580021
         LR    YREG,ODDREG              RETURN SCALED VALUE IN YREG.    16600021
         BR    LINREG                   RETURN TO MAINLINE              16620021
**************************************************                      16640021
*   SUBROUTINE TO SCALE   FIXED  POINT  VALUES   *                      16660021
*   SVAL=XINC*((X2-X1)/(U2-U1))  XINC=RINC OR MRU*                      16680021
*   SVAL REPRESENTS RINC OR MRU SCALED           *                      16700021
**************************************************                      16720021
FIXSCAL  LH    ODDREG,4(XYLREG)         X2                              16740021
         SH    ODDREG,0(XYLREG)         -X1                             16760021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   16780021
         MR    EVEREG,XREG              * UI                            16800021
         L     XREG,12(XYLREG)          U2                              16820021
         S     XREG,8(XYLREG)           -U1                             16840021
         BC    13,ER16                  BRANCH ON OVF, MINUS OR ZERO    16860021
         SR    EVEREG,EVEREG            ZERO EVEN REG                   16880021
         DR    EVEREG,XREG                                              16900021
         LR    XREG,ODDREG              SCALED U VALUE IN XREG          16920021
         BR    LINREG                                                   16940021
         EJECT                                                          16960021
*********************************************                           16980021
* STORE GRAPHIC DATA IN GDOA FOR POR        *                           17000021
* INPUT TO SUBROUTINE                       *                           17020021
*   CNTREG = NUMBER OF BYTES TO BE STORED   *                           17040021
*   ADDREG = ADDRESS OF THE GRAPHIC DATA    *                           17060021
*   WKAREG = WORK AREA ADDRESS              *                           17080021
*   OABREG = ADDRESS OF OACB                *                           17100021
*********************************************                           17120021
STORE    SR    PASREG,PASREG            CLEAR OVERFLOW PASS INDICATOR   17140021
STORE1   L     OLPREG,16(0,OABREG)      ADDRESS OF OLP FROM OACB        17160021
         LR    WRKREG,CNTREG            LOAD BYTES TO MOVE              17180021
* CALCULATE ADDRESSES BASED ON N VALUE AND SIZE OF GDOA                 17200021
STORE2   AR    OLPREG,WRKREG            OLP ADDRESS PLUS N VALUE        17220021
         LA    TEMREG,4                                                 17240021
         AR    TEMREG,OLPREG            OLP PLUS N PLUS 4               17260021
         L     SLOREG,0(OABREG)         SLOA ADDRESS                    17280021
         A     SLOREG,4(OABREG)         ADD LOA EQUALS TOTAL GDOA       17300021
         CR    TEMREG,SLOREG                                            17320021
         L     OLPREG,16(0,OABREG)      RESET INITIAL OLP ADDRESS       17340021
         BNH   OK                                                       17360021
* NOT ENOUGH ROOM TO STORE ALL OF THE DATA-DETERMINE AMOUNT TO STORE    17380021
         SR    TEMREG,SLOREG            EQUAL BYTES-CAN'T STORE         17400021
         SR    WRKREG,TEMREG            NUMBER OF BYTES CAN STORE       17420021
* ANY BYTES TO STORE                                                    17440021
         C     WRKREG,ZERO                                              17460021
         BNH   STORE4                   LESS OF EQUAL TO ZERO           17480021
         LH    TEMREG,H2A02                                             17500021
         CH    TEMREG,GOMODE                                            17520021
         BH    STORE3A                                                  17540021
         LH    TEMREG,H0003                                             17560021
         NR    TEMREG,WRKREG                                            17580021
         BM    STORE4      GO TO USER OVERFLOW ROUTINE (JAPV)      7468 17600021
STORE3A  SR    CNTREG,WRKREG       BYTES REMAINING                      17620021
         BAL   INTLNK,STORE6            LINK INTERNALLY                 17640021
STORE3   LA    PASREG,1                 SET PASS INDICATOR              17660021
* STORE REGISTERS IN WORKAREA                                           17680021
         STM   0,15,0(WKAREG)           SAVE REGISTERS IN WORKAREA      17700021
         CLI   LOADSW,X'FF'                                             17720021
         BNE   LOADREG                                                  17740021
         LR    3,1                      SAVE REG 1.                     17760021
         DELETE EP=GOFFSG                                               17780021
         LR    1,3                      RESTORE REG 1.                  17800021
LOADREG  L     15,8(0,OABREG)       OVERFLOW ADDRESS                    17820021
         LM    2,12,28(13)           RELOAD USERS REG                   17840021
         BALR  14,15                    LINK TO ROUTINE-SET RETURN      17860021
         MVI   LOADSW,X'00'                                             17880021
         LM    0,15,0(WKAREG)           RELOAD FROM WORKAREA            17900021
         B     STORE1                   GET NEW OLP ADDRESS-CONTINUE    17920021
* NO SPACE AVAILABLE                                                    17940021
STORE4   C     PASREG,ONE               WAS A TRANSFER TO OVERFLOW MADE 17960021
         BL    STORE3                                                   17980021
*                                                                       18000021
* SET ERROR CODE AND RETURN TO POR-LEAVE POR WITH RETURN MACRO          18020021
         LA    15,28                    SET ERROR CODE REG.             18040021
         B     RET                      SYMBOLIC IN POR                 18060021
OK       BAL   INTLNK,STORE6            LINK INTERNALLY                 18080021
         BR    LINREG                                                   18100021
STORE6   LA    TEMREG,255               SET REG. EQUAL TO 255           18120021
STORE6A  CR    WRKREG,TEMREG            IS AMOUNT TO MOVE OVER 255      18140021
         BH    STORE7                                                   18160021
         LR    TEMREG,WRKREG                                            18180021
         S     TEMREG,ONE               COMPENSATE FOR EXTRA BYTE       18200021
         EX    TEMREG,MOVE              MOVE GRAPHIC DATA               18220021
         AR    OLPREG,WRKREG            UPDATE OLP ADDRESS              18240021
         AR    ADDREG,WRKREG            UPDATE DATA ADDR                18260021
         ST    OLPREG,16(0,OABREG)      STORE NEW OLP ADDRESS           18280021
         BR    INTLNK                   RETURN INTERNALLY               18300021
STORE7   LR    SLOREG,TEMREG                                            18320021
         S     SLOREG,ONE               COMPENSATE FOR EXTRA BYTE       18340021
         EX    SLOREG,MOVE              MOVE GRAPHIC DATA               18360021
         AR    OLPREG,TEMREG            UPDATE OLP ADDRESS              18380021
         AR    ADDREG,TEMREG            UPDATE INPUT ADDRESS            18400021
         SR    WRKREG,TEMREG           REDUCE BY 255                    18420021
         B     STORE6A                  MAKE NEXT COMPARISON            18440021
MOVE     MVC   0(0,OLPREG),0(ADDREG)    MOVE DATA TO GDOA               18460021
         CNOP  0,4                                                      18480021
         EJECT                                                          18500021
******************************                                          18520021
*   CONSTANTS USED BY GPGRID *                                          18540021
******************************                                          18560021
         DS    0D                                                       18580021
X4E      DC    X'4E00000000000000'                                      18600021
ZERO     DC    F'0'                                                     18620021
H4095    DC    H'4095,4095'                                             18640021
ONE      DC    F'1'                                                     18660021
TWO      DC    F'2'                                                     18680021
FOUR     DC    F'4'                                                     18700021
FLPT5    DC    E'.5'                                                    18720021
C360     DC    F'360'                                                   18740021
C1365    DC    F'1365'                                                  18760021
C4095    DC    F'4095'                                                  18780021
C5793    DC    F'5793'                                                  18800021
TWOPI    DC    FS28'6.2832'                                             18820021
HIGH     DC    F'4095'                                                  18840021
BYTE123  DC    X'00FFFFFF'                                              18860021
FCHAR    DC    X'7F000000'                                              18880021
X6       DC    X'46000000'                   EXPONENT OF SIX            18900021
MZERO    DC    X'80000000'                                              18920021
POINT5   DC    HS14'.5'                                                 18940021
H2A02    DC    X'2A02'                                                  18960021
H0003    DC    H'0003'                                                  18980021
MINUS1   DC    H'-1'                                                    19000021
MINUS2   DC    H'-2'                                                    19020021
C45      DC    H'45'                                                    19040021
C46      DC    H'46'                                                    19060021
C90      DC    H'90'                                                    19080021
C136     DC    H'136'                                                   19100021
C180     DC    H'180'                                                   19120021
C226     DC    H'226'                                                   19140021
C270     DC    H'270'                                                   19160021
C315     DC    H'315'                                                   19180021
H360     DC    H'360'                                                   19200021
GEVM     DC    X'2A02'                                                  19220021
LOGJ     DC    HS14'.3010,.4771,.6021,.6990,.7782,.8451,.9031,.9542'    19240021
*   LOGJ TABLE=LOG VALUES FOR THE CYCLES OF LOG GRID. WHEN J=2,3,4,...9 19260021
LOGTBL   EQU   LOGJ                                                     19280021
         EJECT                                                          19300021
******************************                                          19320021
*    SINE/COSINE TABLE       *                                          19340021
******************************                                          19360021
SCTBL    DC    HS14'0.0000,1.0000,0.0175,0.9999'             0- 1       19380021
         DC    HS14'0.0349,0.9994,0.0523,0.9986'             2- 3       19400021
         DC    HS14'0.0698,0.9976,0.0872,0.9962'             4- 5       19420021
         DC    HS14'0.1045,0.9945,0.1219,0.9926'             6- 7       19440021
         DC    HS14'0.1392,0.9903,0.1564,0.9877'             8- 9       19460021
         DC    HS14'0.1737,0.9848,0.1908,0.9816'            10-11       19480021
         DC    HS14'0.2079,0.9782,0.2250,0.9744'            12-13       19500021
         DC    HS14'0.2419,0.9703,0.2588,0.9659'            14-15       19520021
         DC    HS14'0.2756,0.9613,0.2924,0.9563'            16-17       19540021
         DC    HS14'0.3090,0.9511,0.3256,0.9455'            18-19       19560021
         DC    HS14'0.3420,0.9397,0.3584,0.9336'            20-21       19580021
         DC    HS14'0.3746,0.9272,0.3907,0.9205'            22-23       19600021
         DC    HS14'0.4067,0.9136,0.4226,0.9063'            24-25       19620021
         DC    HS14'0.4384,0.8988,0.4540,0.8910'            26-27       19640021
         DC    HS14'0.4695,0.8830,0.4848,0.8746'            28-29       19660021
         DC    HS14'0.5000,0.8660,0.5150,0.8572'            30-31       19680021
         DC    HS14'0.5299,0.8481,0.5446,0.8387'            32-33       19700021
         DC    HS14'0.5592,0.8290,0.5736,0.8192'            34-35       19720021
         DC    HS14'0.5878,0.8090,0.6018,0.7986'            36-37       19740021
         DC    HS14'0.6157,0.7880,0.6293,0.7772'            38-39       19760021
         DC    HS14'0.6428,0.7660,0.6561,0.7547'            40-41       19780021
         DC    HS14'0.6691,0.7431,0.6820,0.7314'            42-43       19800021
         DC    HS14'0.6947,0.7193,0.7071,0.7071'            44-45       19820021
SINE     EQU   SCTBL                                                    19840021
COSINE   EQU   SCTBL+2                                                  19860021
         EJECT                                                          19880021
******************************                                          19900021
*   PARAMETER TABLE FORMAT   *                                          19920021
******************************                                          19940021
PARTAB   DSECT                                                          19960021
XYLIM    DS    CL4                      ADDR OF XY LIMIT TABLE.         19980021
UC       DS    CL4                      X-COORDINATE OF ARC CENTER.     20000021
VC       DS    CL4                      Y-COORDINATE OF ARC CENTER.     20020021
F        DS    CL1                      FIXED/FLOATING POINT INDICATOR. 20040021
S        DS    CL1                      SCALING INDICATOR.              20060021
INC      DS    CL1                      ALPHA/DENSITY INDICATOR.        20080021
OFFSG    DS    CL1                      OFF SCREEN/GRID OPTION IND.     20100021
RINC     DS    CL4                      INCREMENT IN RADIAL DIRECTION.  20120021
NR       DS    CL2                      # OF RADII                      20140021
DENSITY  DS    CL2                   ** DENSITY OF CONSECUTIVE POINTS.  20160021
ALPHA    EQU   DENSITY               ** DEGREE OF SUCCESIVE POINTS.     20180021
MAXRAD   DS    CL4                      MAXIMUM LENGTH OF RADIUS.       20200021
TYPE     DS    CL1                      GRID TYPE.                      20220021
         EJECT                                                          20240021
******************************                                          20260021
*   GPVGRD USE OF WORK AREA  *                                          20280021
******************************                                          20300021
WKAREA   DSECT                                                          20320021
OVFSAVE  DS    0CL72                                                    20340021
TEMFLT   DS    0CL8                                                     20360021
         DS    CL128                                                    20380021
SABL     DS    CL4                                                      20400021
PT1X     DS    CL4                                                      20420021
PT1Y     DS    CL4                                                      20440021
PT2X     DS    CL4                                                      20460021
PT2Y     DS    CL4                                                      20480021
NI       DS    CL4                                                      20500021
INTS1X   DS    CL2                                                      20520021
INTS1Y   DS    CL2                                                      20540021
INTS2X   DS    CL2                                                      20560021
INTS2Y   DS    CL2                                                      20580021
         DS    CL64                                                     20600021
SAVE     DS    CL16                                                     20620021
LOADSW   DS    CL4                                                      20640021
GDV1     DS    CL4                                                      20660021
GDV2     DS    CL4                                                      20680021
XC       DS    CL4                                                      20700021
YC       DS    CL4                                                      20720021
MAXR     DS    CL4                                                      20740021
R        DS    CL4                                                      20760021
RINK     DS    CL4                                                      20780021
VALUE1   DS    CL4                                                      20800021
VALUE2   DS    CL4                                                      20820021
I        DS    CL4                                                      20840021
SVR15    DS    CL4                      PLACE TO SAVE ERROR REGISTER    20860021
ERCOUNT  DS    CL4                                                      20880021
ALPH     DS    CL2                                                      20900021
NPT      DS    CL2                                                      20920021
PHI      DS    CL2                                                      20940021
K        DS    CL2                                                      20960021
LOGSAV   DS    CL2                                                      20980021
SGSW     DS    CL1                                                      21000021
FUNCSW   DS    CL1                                                      21020021
BNDRSW   DS    CL1                                                      21040021
INK      DS    CL1                                                      21060021
J        DS    CL1                                                      21080021
MASKSV   DS    F                   SAVE SETTING OF USER PROGRAM MASK    21100021
         ORG   OVFSAVE+396                                              21120021
GOMODE   DS    CL2                                                      21140021
XYLIMT   DSECT                                                          21160021
X1       DS    CL2                                                      21180021
Y1       DS    CL2                                                      21200021
X2       DS    CL2                                                      21220021
Y2       DS    CL2                                                      21240021
U1       DS    CL4                                                      21260021
U2       DS    CL4                                                      21280021
V1       DS    CL4                                                      21300021
V2       DS    CL4                                                      21320021
         END                                                            21340021
./  ADD  SSI=20480479,NAME=IFFPKADG
         START                                                          00060021
*TITLE IFFPKADG                                                       * 00120021
*                                                                     * 00180021
*STATUS: CHANGE LEVEL 000                                             * 00240021
*                                                                     * 00300021
*FUNCTION/OPERATION: GENERATES A SERIES OF GRAPHIC ORDERS FROM DATA   * 00360021
*   SUPPLIED BY THE USER. THE ORDERS MAY CONSIST OF ABSOLUTE OR       * 00420021
*   INCREMENTAL ORDERS OR AN OPTIMIZED MIXTURE OF THE TWO. THE DATA   * 00480021
*   FORMAT AND MODE IS SPECIFIED BY THE USER IN HIS PARAMETER TABLE.  * 00540021
*   THE DATA IS SCALED IF DESIRED USING THE ENTRIES IN THE XYSCALE    * 00600021
*   TABLE TO DERIVE APPROPRIATE SCALING FACTORS.                      * 00660021
*                                                                     * 00720021
*INPUT: A PARAMETER TABLE (PARTAB) AND AN OUTPUT CONTROL BLOCK POINTER* 00780021
*   (OCBP). THESE POINT TO AN XYSCALE TABLE AND TO THE OUTPUT AREA    * 00840021
*   CONTROL BLOCK (OCBP) AND AN HUNDRED-WORD WORKAREA RESPECTIVELY.   * 00900021
*                                                                     * 00960021
*OUTPUT: THE GRAPHIC ORDERS TO PLOT THE DATA AS SPECIFIED ARE PLACED  * 01020021
*   IN THE USER'S GDOA.                                               * 01080021
*                                                                     * 01140021
*EXTERNAL ROUTINES: GOFFSG                                            * 01200021
*                                                                     * 01260021
*EXITS-NORMAL: VIA RETURN MACRO WITH A ZERO RETURN CODE ON SUCESSFUL  * 01320021
*   COMPLETION.                                                       * 01380021
*              VIA A BALR 14,15 TO THE USER'S OVERFLOW ROUTINE        * 01440021
*                                                                     * 01500021
*EXITS-ERROR: VIA RETURN MACRO WITH A NON-ZERO RETURN CODE IN REGISTER* 01560021
*   15                                                                * 01620021
*                                                                     * 01680021
*TABLES/WORKAREA: AN HUNDRED-WORD USER SUPPLIED WORKAREA. TABLES OF   * 01740021
*   POSSIBLE PARAMETER VALUES AND THE CORRESPONDING SWITCH SETTINGS   * 01800021
*                                                                     * 01860021
*ATTRIBUTES: PROBLEM STATE, REENTRANT, CHARACTER DEPENDENT.           * 01920021
*                                                                       01980021
WORKAREA DSECT                                                          02040021
         DS    0F                      FORCE FULL WORD ALIGNMENT        02100021
*                                                                       02160021
X1       DS    H                       GRID LIMITS-LOWER LEFT CORNER    02220021
Y1       DS    H                       IN 4096 RASTER UNITS             02280021
X2       DS    H                       GRID LIMITS-UPPER RIGHT CORNER   02340021
Y2       DS    H                       IN 4096 RASTER UNITS             02400021
*                                                                       02460021
OVERFLAG DS    C                                                        02520021
PTSGSW   DS    C                       PLOT TYPE-SCISSORING OPTIONS     02580021
*              X'80'         1=OPTIMIZED PLOT/0=NOT OPTIMIZED           02640021
*              X'40'         1=FIRST POINT FOR CALL                     02700021
*              X'20'         1=INCREMENTAL PLOT/0=ABSOLUTE PLOT         02760021
*              X'10'         1=VECTOR PLOT/0=POINT PLOT                 02820021
*              X'08'         1=DISCONTINUE WHEN SCREEN EXCEEDED         02880021
*                            0=CONTINUE                                 02940021
*              X'04'         1=DISCONTINUE WHEN GRID EXCEEDED           03000021
*                            0=CONTINUE                                 03060021
*              X'02'         1=SHOW ALL POINTS WITHIN SCREEN LIMITS     03120021
*                            0=SHOW ALL POINTS WITHIN GRID LIMITS       03180021
UMODE    DS    C                       CHARACTERISTICS OF U'S           03240021
VMODE    DS    C                       CHARACTERISTICS OF V'S           03300021
*              X'10'         1=FLOATING-POINT/0=INTEGER                 03360021
*              X'20'         INPUT VALUES ABSOLUTE                      03420021
*              X'40'         INPUT VALUES A TABLE OF INCREMENTS         03480021
*              X'80'         INPUT VALUES BY ADDING A FIXED INCREMENT   03540021
XP       DS    H                       LAST PHYSICAL LOCATION           03600021
YP       DS    H                       OF BEAM                          03660021
X        DS    F                       LAST LOGICAL LOCATION            03720021
Y        DS    F                       OF BEAM                          03780021
U        DS    F                       LAST U-VALUE                     03840021
V        DS    F                       LAST V-VALUE                     03900021
UTAB     DS    F                       LAST ENTRY IN U-ARRAY USED       03960021
VTAB     DS    F                       LAST ENTRY IN V-ARRAY USED       04020021
*                                                                       04080021
GIX1     DS    H                       COORDINATES OF FIRST INTERSEC-   04140021
GIY1     DS    H                       TION WITH GRID LIMITS            04200021
GIX2     DS    H                       COORDINATES OF SECOND  INTER-    04260021
GIY2     DS    H                       SECTION WITH GRID LIMITS         04320021
PTPOS    DS    C                       RELATIVE POSITIONS OF END-POINTS 04380021
*                                                                       04440021
DEFLG    DS    C                       DEFAULT FLAG                     04500021
RETCD    DS    H                       RETURN CODE WORK AREA            04560021
PARTABAD DS    F                       ADDRESS OF PARTAB                04620021
OACBAD   DS    F                       ADDRESS OF OACB                  04680021
*                                                                       04740021
NXTX1    DS    F                       X AND Y COORDINATES              04800021
NXTY1    DS    F                       OF FIRST POINT-VECTOR            04860021
SUPLT1   DS    C                       SUPRESS PLOT SWITCH              04920021
PTCNT1   DS    C                       NO. OF POINTS TO PLOT            04980021
BV11     DS    C                       BLANKED BEAM SWITCHES            05040021
BV21     DS    C                                                        05100021
ADJX11   DS    H                       ADJUSED X                        05160021
ADJY11   DS    H                                 AND Y                  05220021
ADJX21   DS    H                                      COORDINATES       05280021
ADJY21   DS    H                       TO PLOT VECTOR                   05340021
NXTX2    DS    F                       X AND Y COORDINATES              05400021
NXTY2    DS    F                       OF SECOND POINT-VECTOR           05460021
SUPLT2   DS    C                       SUPRESS PLOT SWITCH              05520021
PTCNT2   DS    C                       NO. OF POINTS TO PLOT            05580021
BV12     DS    C                       BLANKED BEAM SWITCHES            05640021
BV22     DS    C                                                        05700021
ADJX12   DS    H                       ADJUSTED X                       05760021
ADJY12   DS    H                                  AND Y                 05820021
ADJX22   DS    H                                        COORDINATES     05880021
ADJY22   DS    H                       TO PLOT VECTOR                   05940021
*                                                                       06000021
NXTX3    DS    F                       X AND Y COORDINATES FOR          06060021
NXTY3    DS    F                       OPTIMIZATION CHECK VECTOR        06120021
SUPLT3   DS    C                       SUPRESS PLOT                     06180021
PTCNT3   DS    C                       NO. OF POINTS TO PLOT            06240021
BV13     DS    C                       BLANKED VECTOR SWITCHES          06300021
BV23     DS    C                                                        06360021
ADJX13   DS    H                       ADJUSTED X                       06420021
ADJY13   DS    H                                  AND Y                 06480021
ADJX23   DS    H                                        COORDINATES     06540021
ADJY23   DS    H                       OF VECTOR                        06600021
SVAR1    DS    18F                     SAVE AREA-SUB-LEVEL 1            06660021
SVAR2    DS    18F                     SAVE AREA-SUB-LEVEL 2            06720021
*                                                                       06780021
SMSW     DS    C                       SET MODE SWITCH                  06840021
INTS     DS    C                       NUMBER OF INTERSECTIONS          06900021
*                                      BETWEEN GRID/SCREEN AND VECTOR   06960021
ABSPTS   DS    H                       NO. OF ABSOLUTE PTS. IN WORKAREA 07020021
INCPTS   DS    H                       NO. OF INCREMENTAL PTS.          07080021
BTCNT    DS    H                       NO. OF BYTES REMAINING           07140021
*                                                                       07200021
OPTIMSV  DS    6F                                                       07260021
*                                      LOOK-AHEAD                       07320021
WRKAR    DS    12F                                                      07380021
OPT14    DS    F                       SAVE AREA FOR REGISTER 14        07440021
DELTAX   DS    F                       TEMPORARY STORAGE-X AND Y        07500021
DELTAY   DS    F                       DISPLACEMENTS FROM LAST POINT    07560021
SIX1     DS    H                       COORDINATES OF FIRST INTER-      07620021
SIY1     DS    H                       SECTION WITH SCREEN LIMITS       07680021
SIX2     DS    H                       COORDINATES OF SECOND INTER-     07740021
SIY2     DS    H                       SECTION WITH SCREEN LIMITS       07800021
         ORG   WRKAR+8                                                  07860021
SABL     DS    F                       POINTER TO GRID/SCREEN LIMITS    07920021
PT1X     DS    F                       COORDINATES OF FROM POINT        07980021
PT1Y     DS    F                       OF VECTOR                        08040021
PT2X     DS    F                       COORDINATES OF TO POINT          08100021
PT2Y     DS    F                       OF VECTOR                        08160021
NI       DS    F                       NUMBER OF INTERSECTIONS          08220021
INTS1X   DS    H                       COORDINATES OF FIRST INTERSEC-   08280021
INTS1Y   DS    H                       TION POINT                       08340021
INTS2X   DS    H                       COORDINATES OF SECOND            08400021
INTS2Y   DS    H                       INTERSECTION POINT               08460021
         ORG   X1+396                                                   08520021
CURMOD   DS    H                       LAST SET MODE ORDER GENERATED    08580021
MODE     DS    C                       TEMPORARY STORAGE FOR UMODE &    08640021
*                                      VMODE                            08700021
         DS    C                       RESERVED                         08760021
PARTAB   DSECT                                                          08820021
XYSCALE  DS    F                  ADDRESS OF SCALING TABLES             08880021
UADDR    DS    F                  ADDRESSES OF FIRST U AND              08940021
VADDR    DS    F                  V VALUES                              09000021
F        DS    C                  MODE                                  09060021
IPU      DS    C                  FORMAT OF U VALUES                    09120021
IPV      DS    C                  FORMAT OF V VALUES                    09180021
PTYPE    DS    C                  TYPE OF PLOT                          09240021
POSOPT   DS    C                  POSITIONING OPTION                    09300021
SGOPT    DS    C                  SCREEN/GRID SCISSORING OPTION         09360021
S        DS    C                  SCALING                               09420021
SMOPT    DS    C                  INITIAL SET MODE OPTION               09480021
SEGOPT   DS    C                  SEGMENT OPTION                        09540021
         DS    C                  RESERVED                              09600021
N        DS    H                  NUMBER OF U,V PAIRS                   09660021
UINDEX   DS    F                  INDICES TO                            09720021
VINDEX   DS    F                             TABLE ENTRIES              09780021
UINCR    DS    F                  FIXED U AND                           09840021
VINCR    DS    F                              V INCREMENTS              09900021
SCALETAB DSECT                                                          09960021
GX1      DS    F                  GRID LIMITS-LOWER LEFT CORNER         10020021
GY1      DS    F                                                        10080021
GX2      DS    F                             -UPPER RIGHT CORNER        10140021
GY2      DS    F                                                        10200021
SX1      DS    F                  SCREEN LIMITS-LOWER LEFT CORNER       10260021
SY1      DS    F                                                        10320021
SX2      DS    F                               -UPPER RIGHT CORNER      10380021
SY2      DS    F                                                        10440021
DX1      DS    F                  DATA LIMITS-LOWER LEFT CORNER         10500021
DY1      DS    F                                                        10560021
DX2      DS    F                             -UPPER RIGHT CORNER        10620021
DY2      DS    F                                                        10680021
XALTER   DS    F                  X-ALTER SWITCH- ALSO, MULTIPLICA-     10740021
*                                 TIVE SCALING CONSTANT                 10800021
YALTER   DS    F                  Y-ALTER SWITCH- ALSO, MULTIPLICA-     10860021
*                                 TIVE Y SCALING CONSTANT               10920021
XCON     DS    F                  ADDITIVE X SCALING CONSTANT           10980021
YCON     DS    F                  ADDITIVE Y SCALING CONSTANT           11040021
SGPAR    DSECT                                                          11100021
NXTX     DS    F                                                        11160021
NXTY     DS    F                                                        11220021
SUPLT    DS    C                                                        11280021
PTCNT    DS    C                                                        11340021
BV1      DS    C                                                        11400021
BV2      DS    C                                                        11460021
ADJX1    DS    H                                                        11520021
ADJY1    DS    H                                                        11580021
ADJX2    DS    H                                                        11640021
ADJY2    DS    H                                                        11700021
IFFPKADG CSECT                                                          11760021
* 514200                                                         A29393 11790021
PARBASE  EQU   10                      BASE REGISTER FOR PARAMETERS     11820021
SCALBASE EQU   9                       BASE REGISTER FOR SCALING        11880021
*                                      CONSTANTS                        11940021
FPACC    EQU   0                                                        12000021
FPACC1   EQU   2                                                        12060021
FPACC2   EQU   4                                                        12120021
FPACC3   EQU   6                                                        12180021
ACC      EQU   0                       GENERAL ACCUMULATOR              12240021
PARLIST  EQU   1                       PARAMETER LIST REGISTER          12300021
NINC     EQU   1                       NUMBER OF VECTORS IN ABS. VECTOR 12360021
EVNACC   EQU   2                       ACCUMULATOR FOR MULTIPLICATION   12420021
*                                      AND DIVISION                     12480021
ERRX     EQU   2                       CUMULATIVE X-ERROR               12540021
ODDACC   EQU   3                       ACCUMULATOR FOR MULTIPLICATION   12600021
*                                      AND DIVISION                     12660021
ERRY     EQU   3                       CUMULATIVE Y-ERROR               12720021
ABIND    EQU   4                       POINTER TO ABSOLUTE VECTOR       12780021
*                                      BEING CONVERTED TO INCREMENTAL   12840021
ACC1     EQU   4                                                        12900021
INCIND   EQU   5                       POINTER TO STORAGE AREA FOR      12960021
*                                      INCREMENTAL VECTORS              13020021
ACC2     EQU   5                                                        13080021
ACC3     EQU   6                                                        13140021
COUNT    EQU   6                       NUMBER ABSOLUTE VECTORS          13200021
POINTS   EQU   6                                                        13260021
DELX     EQU   7                       CONSTANT X-DISPLACEMENT          13320021
MAGDELX  EQU   7                       MAGNITUDE OF DELTAX              13380021
OLPREG   EQU   7                       CURRENT VALUE OF OLP             13440021
RX       EQU   8                       FINAL X-REMAINDER                13500021
GDOACNT  EQU   8                       USABLE BYTES IN GDOA             13560021
DELY     EQU   9                       CONSTANT Y-DISPLACEMENT          13620021
MAGDELY  EQU   9                       MAGNITUDE OF DELTAY              13680021
RY       EQU   10                      Y-REMAINDER FOR LAST VECTOR      13740021
WORKBASE EQU   11                      BASE FOR SYMBOLIC REFERENCES     13800021
*                                      TO WORKAREA                      13860021
BASE     EQU   12                      BASE REGISTER FOR ROUTINE        13920021
SAVEREG  EQU   13                      POINTER TO SAVE AREA             13980021
RETREG   EQU   14                      RETURN REGISTER                  14040021
ENTREG   EQU   15                                                       14100021
         ENTRY GSDPLT                                                   14160021
GSDPLT   SAVE  (14,12)                                                  14220021
         BALR  BASE,0                  ADDRESSABILITY                   14280021
         USING *,BASE                  FOR ROUTINE                      14340021
*                                                                       14400021
         L     PARBASE,4(PARLIST)      ADDRESSABILITY                   14460021
         USING PARTAB,PARBASE          FOR PARAMETER TABLE              14520021
*                                                                       14580021
         L     EVNACC,0(PARLIST)       GET ADDRESS                      14640021
         L     WORKBASE,4(EVNACC)      OF WORKAREA                      14700021
         USING WORKAREA,WORKBASE       ADDRESSABILITY FOR WORKAREA      14760021
         XC    PTPOS(4),PTPOS          XET PT. POSITION & DEFAULT       14820021
*                                      FLAGS AND RETURN CODE WORKAREA   14880021
*                                      TO 0                             14940021
*                                                                       15000021
         ST    PARBASE,PARTABAD        S1VE ADDRESSES OF PARAMETER      15060021
         MVC   OACBAD(4),0(EVNACC)     TABLE AND OACB IN WORKBASE       15120021
*                                                                       15180021
         LA    EVNACC,SVAR1            SET UP SAVE AREA                 15240021
         ST    SAVEREG,4(EVNACC)       & CHAIN IT TO                    15300021
         ST    EVNACC,8(SAVEREG)       PREVIOUS SAVE AREA               15360021
         LR    SAVEREG,EVNACC                                           15420021
*                                                                       15480021
         CLC   N(2),H1                 SEE IF N POSITIVE                15540021
         BNL   PARMCHK                                                  15600021
         L     SAVEREG,4(SAVEREG)      N ZERO OR NEGATIVE-              15660021
         RETURN (14,12),RC=0           IMMEDIATE RETURN                 15720021
*                                                                       15780021
PARMCHK  LA    ACC,3                                                    15840021
         SPM   ACC                     UNMASK ALL PROGRAM INTERRUPTS    15900021
         LA    PARLIST,MODES           GET DATA/                        15960021
         LA    EVNACC,F                COMPUTATION                      16020021
         LA    ODDACC,4                MODE OF                          16080021
         BAL   RETREG,PRMCHKLP         INPUT                            16140021
         MVC   UMODE(1),1(PARLIST)     AND SET CONTROL SWITCHES         16200021
         MVC   VMODE(1),2(PARLIST)                                      16260021
*                                                                       16320021
         LA    ACC,2                                                    16380021
         LA    PARLIST,INPFORMS        GET FORMAT                       16440021
         LA    EVNACC,IPU              OF U-VALUE                       16500021
         LA    ODDACC,3                INPUT                            16560021
         BAL   RETREG,PRMCHKLP                                          16620021
         OC    UMODE(1),1(PARLIST)     AND SET SWITCH                   16680021
*                                                                       16740021
         LA    PARLIST,INPFORMS        GET FORMAT                       16800021
         LA    EVNACC,IPV              OF V-VALUE                       16860021
         LA    ODDACC,3                INPUT                            16920021
         BAL   RETREG,PRMCHKLP                                          16980021
         OC    VMODE(1),1(PARLIST)     AND SET SWITCH                   17040021
*                                                                       17100021
         LA    PARLIST,SMOPTS          DETERMINE                        17160021
         LA    EVNACC,SMOPT            SET MODE                         17220021
         LA    ODDACC,2                OPTIIN                           17280021
         BAL   RETREG,PRMCHKLP                                          17340021
         MVC   SMSW(1),1(PARLIST)      AND SET CONTROL SWITCH           17400021
*                                                                       17460021
         LA    PARLIST,SGOPTS          DETERMINE                        17520021
         LA    EVNACC,SGOPT            SCISSORING OPTION                17580021
         LA    ODDACC,5                REQUESTED                        17640021
         BAL   RETREG,PRMCHKLP         AND                              17700021
         MVC   PTSGSW(1),1(PARLIST)    SET CONTROL SWITCH               17760021
*                                                                       17820021
         LA    PARLIST,PTYPES          DETERMINE                        17880021
         LA    EVNACC,PTYPE            TYPE OF                          17940021
         LA    ODDACC,6                PLOT REQUESTED                   18000021
         BAL   RETREG,PRMCHKLP         AND                              18060021
         OC    PTSGSW(1),1(PARLIST)    SET CONTROL SWITCH               18120021
         TM    PTSGSW,X'80'            IF OPTIMIZED PLOT                18180021
         BZ    SCALPARM                IS REQUESTED,                    18240021
SCALPARM LA    ACC,4                                                    18300021
         LA    PARLIST,SOPTS           SEE IF SCALING REQUESTED         18360021
         LA    EVNACC,S                                                 18420021
         LA    ODDACC,2                                                 18480021
         BAL   RETREG,PRMCHKLP                                          18540021
         L     PARLIST,0(PARLIST)      BRANCH TO ROUTINE TO INITIALIZE  18600021
         L     SCALBASE,XYSCALE        SCALING REQUESTED, LOCATE        18660021
         USING SCALETAB,SCALBASE       SCALING CONTANTS                 18720021
         BR    PARLIST                                                  18780021
*                                                                       18840021
GRIDSF   LE    FPACC,SX2(EVNACC)       GET S2-S1                        18900021
         SE    FPACC,SX1(EVNACC)                                        18960021
         BC    12,RC4                  CHECK FOR LEGALITY               19020021
         LE    FPACC1,0(PARLIST)       GET COORDINATE TO BE SCALED      19080021
         SE    FPACC1,SX1(EVNACC)      SUBTRACT S1                      19140021
         ME    FPACC1,FOURKE           MULTIPLY BY 4K                   19200021
         DER   FPACC1,FPACC            DIVIDE BY S2-S1                  19260021
         STE   FPACC1,WRKAR            STORE                            19320021
         LA    PARLIST,WRKAR                                            19380021
         ST    RETREG,OPT14            SAVE RETURN REGISTER             19440021
         BAL   RETREG,FIX              FIX VALUE                        19500021
         LTR   ENTREG,ENTREG           CHECK FOR LEGALITY               19560021
         BC    7,BADTERM                                                19620021
         L     RETREG,OPT14            RETURN                           19680021
         BR    RETREG                                                   19740021
*                                                                       19800021
GRIDS    L     ACC,SX2(EVNACC)         GET S2-S1                        19860021
         S     ACC,SX1(EVNACC)         CHECK FOR LEGALITY               19920021
         BC    12,RC4                                                   19980021
         L     ODDACC,0(PARLIST)       GET COORDINATE TO BE SCALED      20040021
         S     ODDACC,SX1(EVNACC)      SUBSTRACT S1                     20100021
         ST    EVNACC,DELTAX           SAVE LOOP CONTROL                20160021
         M     EVNACC,FOURK            MULTIPLY BY 4K                   20220021
         DR    EVNACC,ACC              DIVIDE BY S2-S1                  20280021
         ST    ODDACC,WRKAR            STORE                            20340021
         L     EVNACC,DELTAX           RESTORE LOOP CONTROL             20400021
         BR    RETREG                  AND RETURN                       20460021
*                                                                       20520021
ABSGRID  MVC   WRKAR(16),GX1           MOVE GRID LIMITS TO WORKAREA     20580021
         SR    EVNACC,EVNACC           SET POINTER                      20640021
         TM    UMODE,X'10'             NEED TO FIX                      20700021
         BZ    FXABGRDV                NO, CHECK V                      20760021
FXABGRD  LA    PARLIST,WRKAR(EVNACC)   GET ADDRESS OF VALUE             20820021
         BAL   RETREG,FIX              FIX IT                           20880021
         LA    PARLIST,WRKAR+8(EVNACC) GET SECOND VALUE                 20940021
         BAL   RETREG,FIX              FIX IT                           21000021
         LTR   EVNACC,EVNACC           BOTH U AND V CHECKED             21060021
         BC    7,ABGRDXFR              YES, MOVE TO WORKAREA            21120021
FXABGRDV LA    EVNACC,4                GET POINTER TO Y VALUES          21180021
         TM    VMODE,X'10'             CHECK MODE                       21240021
         BO    FXABGRD                 FIX V VALUES                     21300021
ABGRDXFR MVC   X1(2),WRKAR+2           SAVE GRID LIMITS                 21360021
         MVC   Y1(2),WRKAR+6           IN PROPER                        21420021
         MVC   X2(2),WRKAR+10          LOCATIONS                        21480021
         MVC   Y2(2),WRKAR+14          IN THE WORKAREA                  21540021
         B     CHKGRD                  CHECK FOR VALIDITY               21600021
*                                                                       21660021
SCALGRID SR    EVNACC,EVNACC           SET UP POINTERS                  21720021
         LA    ACC2,X1                 TO U-X VALUES                    21780021
         TM    UMODE,X'10'             CHECK MODE                       21840021
         BZ    FIXGRD                  INTEGER                          21900021
FLTGRD   LA    PARLIST,GX1(EVNACC)     FLOATING- CONVERT COORDINATE OF  21960021
         BAL   RETREG,GRIDSF           LOWER-LEFT CORNER OF GRID TO     22020021
         MVC   0(2,ACC2),WRKAR+2       RASTER UNITS AND STORE           22080021
         LA    PARLIST,GX2(EVNACC)     LIKEWISE FOR                     22140021
         BAL   RETREG,GRIDSF           UPPER-RIGHT CORNER               22200021
         MVC   4(2,ACC2),WRKAR+2                                        22260021
GRDLP1   LTR   EVNACC,EVNACC           FINISHED PROCESSING Y-VALUES     22320021
         BC    7,CHKGRD                YES- CHECK                       22380021
         LA    EVNACC,4                NO- GET POINTERS TO              22440021
         LA    ACC2,Y1                 V-Y VALUES                       22500021
         TM    VMODE,X'10'             CHECK MODE                       22560021
         BO    FLTGRD                  FLOATING                         22620021
*                                                                       22680021
FIXGRD   LA    PARLIST,GX1(EVNACC)     INTEGER- EVALUATE                22740021
         BAL   RETREG,GRIDS            COORDINATES OF                   22800021
         MVC   0(2,ACC2),WRKAR+2       GRID CORNERS                     22860021
         LA    PARLIST,GX2(EVNACC)     USING                            22920021
         BAL   RETREG,GRIDS            INTEGER ARITHMETIC               22980021
         MVC   4(2,ACC2),WRKAR+2       AND STORE                        23040021
         B     GRDLP1                                                   23100021
*                                                                       23160021
CHKGRD   LH    PARLIST,ZERO            CHECK GRID                       23220021
         CH    PARLIST,X1              LIMITS TO                        23280021
         BH    RC4                     MAKE SURE                        23340021
         CH    PARLIST,Y1              THEY ARE                         23400021
         BH    RC4                     VALID                            23460021
         LH    PARLIST,ZERO+4          IF NOT,                          23520021
         CH    PARLIST,X2              SET RETURN                       23580021
         BL    RC4                     CODE FOR                         23640021
         CH    PARLIST,Y2              IMMEDIATE RETURN                 23700021
         BL    RC4                                                      23760021
         CLC   X1(2),X2                MAKE SURE LOWER GRID LIMITS      23820021
         BNL   RC4                                                      23880021
         CLC   Y1(2),Y2                ARE LESS THAN UPPER LIMITS       23940021
         BNL   RC4                                                      24000021
POSITION OI    PTSGSW,X'40'                                             24060021
         XC    ABSPTS(2),ABSPTS        SET POINT COUNT =0               24120021
         XC    INCPTS(2),INCPTS        SET NO. OF INCREMENTAL PTS.=0    24180021
         BAL   RETREG,GETNEXT          GET FIRST POINT                  24240021
         LTR   ENTREG,ENTREG           BAD DATA LIMITS                  24300021
         BP    ENDTERM                 YES, TERMINATE PROGRAM           24360021
         MVC   X(8),DELTAX             STORE                            24420021
         MVC   XP(2),DELTAX+2          IN HISTORICAL                    24480021
         MVC   YP(2),DELTAY+2          AREAS                            24540021
         LA    ACC,NXTX1               SET INITIAL                      24600021
         MVC   NXTX1(8),X              POSITION SWITCHES                24660021
         BAL   RETREG,SGCHECK          FOR FUTURE REFERENCE             24720021
         LA    POINTS,1                INITIALIZE COUNTER               24780021
         LA    ACC,4                   CHECK                            24840021
         LA    PARLIST,POSOPTS         POSITIONING                      24900021
         LA    EVNACC,POSOPT           OPTIONS                          24960021
         LA    ODDACC,3                                                 25020021
         BAL   RETREG,PRMCHKLP                                          25080021
         L     PARLIST,0(PARLIST)      GET ADDRESS OF ROUTINE           25140021
*                                                                       25200021
         L     EVNACC,OACBAD           GET NUMBER                       25260021
         L     GDOACNT,0(EVNACC)       OF FREE BYTES                    25320021
         A     GDOACNT,4(EVNACC)       IN THE GDOA                      25380021
         L     OLPREG,16(EVNACC)       AND THE VALUE                    25440021
         SR    GDOACNT,OLPREG          OF THE                           25500021
         SH    GDOACNT,H4              OLP                              25560021
         NI    PTSGSW,X'BF'                                             25620021
         MVI   BV21,X'00'              SET INCREMENTAL POSITIONING      25680021
*                                      SWITCH OFF                       25740021
         BR    PARLIST                 TO PROCESSING ROUTINE            25800021
*                                                                       25860021
ABSPOS   MVC   NXTX1(8),X              ABSOLUTE POSITIONING             25920021
         LA    ACC,NXTX1               CALL SCISSORING ROUTINE TO       25980021
         BAL   RETREG,SGCHECK          CHECK POSITIONING VECTOR         26040021
         LTR   ENTREG,ENTREG           TERMINATION CONDITION            26100021
         BP    ENDTERM                 YES, EXIT                        26160021
         TM    SUPLT1,X'FF'            NO.  PLOT SUPPRESSED             26220021
         BZ    ABSPOS1                 NO.  POSITION TO INPUT VALUE     26280021
         XC    XP(4),XP                YES, POSITION TO 0,0             26340021
ABSPOS1  MVC   WRKAR(4),XP                                              26400021
         MVC   ABSPTS(2),H1            STORE POSITION IN WORKAREA       26460021
         OI    WRKAR,X'40'             BLANK VECTOR                     26520021
         TM    PTSGSW,X'80'            OPTIMIZED PLOT                   26580021
         BZ    INCABPOS                                                 26640021
         NI    PTSGSW,X'1F'            YES,SET FOR ABSOLUTE PLOT        26700021
         OI    PTPOS,X'C0'             SIGNAL PLOT TYPE OVERIDE         26760021
         B     STRABS                  STORE DATA                       26820021
*                                                                       26880021
INCABPOS TM    PTSGSW,X'20'            INCREMENTAL PLOT                 26940021
         BZ    STRABS                  NO, STORE ABSOLUTE DATA          27000021
         OI    PTPOS,X'40'             YES, SIGNAL PTYPE OVERIDE        27060021
         NI    PTSGSW,X'DF'            OVERIDE TO ABSOLUTE PLOT         27120021
         B     STRABS                                                   27180021
*                                                                       27240021
INCPOS   CLI   SEGOPT,C'B'             IF SEG OPT B AND POS OPT C       27300021
         BE    ABSPOS                  ARE SPECIFIED, ASSUME POS OPT A  27360021
         MVI   BV21,X'FF'              BLANK OUT VECTOR                 27420021
*                                      INCREMENTAL POSITIONING          27480021
         TM    PTSGSW,X'80'            OPTIMIZED PLOT                   27540021
         BZ    ABINCPOS                                                 27600021
         OI    PTPOS,X'C0'             YES, SIGNAL PTYPE OVERIDE        27660021
         NI    PTSGSW,X'7F'            FORCE NON-OPTIMIZED PLOT         27720021
         B     MAINLOOP                                                 27780021
ABINCPOS TM    PTSGSW,X'20'            NON-OPTIMIZED INCREMENTAL        27840021
         BO    MAINLOOP                YES, PLOT POINT                  27900021
         OI    PTPOS,X'40'             NO, SIGNAL PTYPE OVERIDE         27960021
         OI    PTSGSW,X'20'            FORCE INCREMENTAL PLOT           28020021
         MVI   SMSW,X'FF'              AND SET MODE                     28080021
         B     MAINLOOP                                                 28140021
PRMCHKLP CLC   0(1,PARLIST),0(EVNACC)  COMPARE PARAMETER WITH TABLE     28200021
         BCR   8,RETREG                ENTRY. IF EQUAL, RETURN          28260021
         AR    PARLIST,ACC             NOT EQUAL, GET ADDRESS OF NEXT   28320021
         BCT   ODDACC,PRMCHKLP         ENTRY AND CHECK IT               28380021
         MVI   DEFLG,X'FF'             NO LEGAL OPTIONS TAKEN-SET       28440021
         BR    RETREG                  DEFAULT FLAG AND RETURN          28500021
MODES    DC    C'A'                    DATA COMPUTATION MODE            28560021
         DC    X'10'                   U FLOATING-POINT                 28620021
         DC    X'10'                   V FLOATING-POINT                 28680021
         DC    C'B'                                                     28740021
         DC    X'00'                   U INTEGER                        28800021
         DC    X'00'                   V INTEGER                        28860021
         DC    C'C'                                                     28920021
         DC    X'00'                   U INTEGER                        28980021
         DC    X'10'                   V FLOATING-POINT                 29040021
         DC    C'D'                                                     29100021
         DC    X'10'                   U FLOATING-POINT                 29160021
         DC    X'00'                   V INTEGER                        29220021
         DS    C                       DEFAULT                          29280021
         DC    X'10'                   U FLOATING-POINT                 29340021
         DC    X'10'                   V FLOATING-POINT                 29400021
*                                                                       29460021
*                                                                       29520021
*                                                                       29580021
INPFORMS DC    C'A'                    INPUT FORMATS                    29640021
         DC    X'20'                   ALL VALUES IN ABSOLUTE TABLE     29700021
         DC    C'B'                    FIRST VALUE IN TABLE,            29760021
         DC    X'40'                   OTHERS INCREMENTAL               29820021
         DC    C'C'                    FIRST VALUE IN TABLE,            29880021
         DC    X'80'                   OTHERS BY ADDING FIXED INCREMENT 29940021
         DS    C                       DEFAULT                          30000021
         DC    X'20'                   ALL VALUES ABSOLUTE              30060021
*                                                                       30120021
PTYPES   DC    C'A'                    PLOT TYPES                       30180021
         DC    X'10'                   ABSOLUTE VECTOR                  30240021
         DC    C'B'                                                     30300021
         DC    X'00'                   ABSOLUTE POINT                   30360021
         DC    C'C'                                                     30420021
         DC    X'30'                   INCREMENTAL VECTOR               30480021
         DC    C'D'                                                     30540021
         DC    X'20'                   INCREMENTAL POINT                30600021
         DC    C'E'                                                     30660021
         DC    X'B0'                   OPTIMIZED VECTOR                 30720021
         DC    C'F'                                                     30780021
         DC    X'A0'                   OPTIMIZED POINT                  30840021
         DS    C                       DEFAULT                          30900021
         DC    X'10'                   ABSOLUTE VECTOR                  30960021
*                                                                       31020021
SGOPTS   DC    C'A'                    OFF SCREEN/OFF GRID OPTIONS      31080021
         DC    X'00'                   SHOW ALL POINTS IN GRID          31140021
         DC    C'B'                                                     31200021
         DC    X'02'                   SHOW ALL POINTS IN SCREEN        31260021
         DC    C'C'                    SHOW ALL POINTS IN GRID          31320021
         DC    X'08'                   TERMINATE WHEN SCREEN EXCEEDED   31380021
         DC    C'D'                                                     31440021
         DC    X'04'                   TERMINATE WHEN GRID EXCEEDED     31500021
         DC    C'E'                    SHOW ALL POINTS IN SCREEN        31560021
         DC    X'0A'                   TERMINATE WHEN SCREEN EXCEEDED   31620021
         DS    C                       DEFAULT- SG OPT = E              31680021
         DC    X'0A'                                                    31740021
*                                                                       31800021
SMOPTS   DC    C'A'                                                     31860021
         DC    X'FF'                   SET MODE REQUESTED               31920021
         DC    C'B'                                                     31980021
         DC    X'00'                   PROPER MODE SET                  32040021
         DS    C                                                        32100021
         DC    X'FF'                   DEFAULT- SET MODE                32160021
*                                                                       32220021
         DS    0F                                                       32280021
POSOPTS  DC    C'A'                    POSITIONING OPTIONS              32340021
         DC    AL3(ABSPOS)             ABSOLUTE POSITIONING             32400021
         DC    C'B'                                                     32460021
         DC    AL3(FINOPT)             POSITION FOR INFORMATION ONLY    32520021
         DC    C'C'                                                     32580021
         DC    AL3(INCPOS)             INCREMENTAL POSITIONING          32640021
         DS    C                       DEFAULT                          32700021
         DC    AL3(ABSPOS)             ABSOLUTE POSITIONING             32760021
*                                                                       32820021
*                                                                       32880021
SOPTS    DC    C'A'                                                     32940021
         DC    AL3(ABSGRID)            NO SCALING                       33000021
         DC    C'B'                                                     33060021
         DC    AL3(SCALGRID)           SCALING REQUESTED                33120021
         DS    C                                                        33180021
         DC    AL3(ABSGRID)            DEFAULT - NO SCALING             33240021
*                                                                       33300021
MAINLOOP LA    POINTS,1(POINTS)        INCREMENT COUNTER BY ONE         33360021
         CH    POINTS,N                ALL POINTS PROCESSED             33420021
         BH    NORMTERM                YES, TERMINATE ROUTINE           33480021
         BAL   RETREG,GETNEXT                                           33540021
         MVC   NXTX1(8),DELTAX                                          33600021
*                                                                       33660021
         LA    ACC,NXTX1                                                33720021
         BAL   RETREG,SGCHECK                                           33780021
         LTR   ENTREG,ENTREG                                            33840021
         BC    7,STOLP                                                  33900021
         MVC   X(8),NXTX1              SAVE LOGICAL POSITION OF BEAM    33960021
         TM    SUPLT1,X'FF'                                             34020021
         BO    MAINLOOP                                                 34080021
         MVC   WRKAR(8),ADJX11                                          34140021
         TM    PTCNT1,X'F0'                                             34200021
         BZ    ONEABS                                                   34260021
         MVC   ABSPTS(2),H2                                             34320021
         B     BLANK                                                    34380021
ONEABS   MVC   ABSPTS(2),H1                                             34440021
BLANK    TM    BV11,X'FF'                                               34500021
         BZ    PTYPETST                                                 34560021
         OI    WRKAR,X'40'                                              34620021
PTYPETST TM    PTSGSW,X'A0'                                             34680021
         BZ    STRABS                                                   34740021
         TM    BV21,X'FF'              INCREMENTAL POSITIONING          34800021
         BZ    DISP                    NO                               34860021
         OI    WRKAR,X'40'             YES, BLANK ALL POSSSIBLE         34920021
         OI    WRKAR+4,X'40'           ABSOLUTE VECTORS                 34980021
         MVI   BV21,X'00'              SET SWITCH TO ZERO               35040021
*                                                                       35100021
DISP     BAL   RETREG,DISPLACE                                          35160021
         LTR   ENTREG,ENTREG           RETURN CODE NON-ZERO             35220021
         BP    STOLP                   YES, IMMEDIATE TERMINATION       35280021
         TM    PTSGSW,X'80'                                             35340021
         BZ    STRINC                                                   35400021
*                                                                       35460021
         TM    PTSGSW,X'20'            CURRENT MODE = ABSOLUTE          35520021
         BO    CURINC                  NO,                              35580021
         CLC   ABSPTS(2),H1            NUMBER OF ABSOLUTE VECTORS       35640021
         BL    KEEPMODE                   NONE                          35700021
         BH    TWOABS                     TWO                           35760021
         CLC   INCPTS(2),H1               ONE- ONLY ONE INCREMENTAL     35820021
         BE    LKAHEAD                 VECTOR REQUIRED, LOOK AHEAD      35880021
*                                      MORE THAN ONE REQUIRED           35940021
KEEPMODE MVI   SMSW,X'00'              SET SET MODE SWITCH OFF          36000021
         B     FINOPT                                                   36060021
*                                                                       36120021
TWOABS   CLC   INCPTS(2),H3            NUMBER OF INCREMENTAL VECTORS    36180021
         BE    LKAHEAD                 REQUIRED-- THREE, LOOK AHEAD     36240021
         BH    KEEPMODE                  FOUR OR MORE- STAY IN ABSOLUTE 36300021
*                                        LESS THAN THREE,               36360021
FLIPMODE XI    PTSGSW,X'20'            CHANGE MODE                      36420021
         MVI   SMSW,X'FF'              SET SET MODE SWITCH              36480021
         B     FINOPT                                                   36540021
*                                                                       36600021
LKAHEAD  MVC   OPTIMSV+8(16),U         SAVE CURRENT POSITION PARAMETERS 36660021
         BAL   RETREG,GETNEXT          GET NEXT POINT TO PLOT           36720021
         LTR   ENTREG,ENTREG           CHECK RETURN CODE                36780021
         BC    7,SKPNXT                NON-ZERO                         36840021
*                                                                       36900021
         MVC   NXTX3(8),DELTAX         SET UP SCISSORING PARAMETER LIST 36960021
         LA    ACC,NXTX3               SET UP CALL FOR SCISSORING       37020021
         BAL   RETREG,SGCHECK          SCISSOR                          37080021
         LTR   ENTREG,ENTREG           TEST RETURN CODE                 37140021
         BC    7,SKPNXT                NON-ZERO                         37200021
*                                                                       37260021
         TM    SUPLT3,X'FF'            PLOT SUPPRESSED,                 37320021
         BO    SKPNXT                  STAY IN CURRENT MODE             37380021
*                                                                       37440021
         LH    EVNACC,ADJX13           GET DELTAX                       37500021
         SH    EVNACC,XP                                                37560021
         CH    EVNACC,HILIM            IF GREATER THAN 255,             37620021
         BH    SKPNXT                  STAY IN ABSOLUTE                 37680021
         CH    EVNACC,LOWLIM           IF LESS THAN -256,               37740021
         BL    SKPNXT                  STAY IN ABSOLUTE                 37800021
*                                                                       37860021
         LH    EVNACC,ADJY13           GET DELTA Y                      37920021
         SH    EVNACC,YP                                                37980021
         CH    EVNACC,HILIM            IF GREATER THEN 255,             38040021
         BH    SKPNXT                  STAY IN CURRENT MODE             38100021
         CH    EVNACC,LOWLIM           IF LESS THAN -256                38160021
         BL    SKPNXT                  STAY IN CURRENT MODE             38220021
*                                                                       38280021
         MVC   U(16),OPTIMSV+8         RESTORE ORIGINAL BEAM POSITION   38340021
*                                      VALUES                           38400021
         B     FLIPMODE                CHANGE MODE AND EXIT             38460021
*                                                                       38520021
SKPNXT   MVC   U(16),OPTIMSV+8         RESTORE ORIGINAL BEAM POSITION   38580021
*                                      VALUES                           38640021
         B     KEEPMODE                STAY IN ABSOLUTE MODE            38700021
*                                                                       38760021
CURINC   CLC   ABSPTS(2),H2            IF ONE ABSOLUTE VECTOR           38820021
         BE    TWOABSI                 NEEDED,                          38880021
         CLC   INCPTS(2),H3            SEE HOW MANY INCREMENTALS        38940021
         BH    FLIPMODE                  MORE THAN 3- GO TO ABSOLUTE    39000021
         BNH   KEEPMODE                  3 OR LESS- STAY IN INCREMENTAL 39060021
*                                                                       39120021
TWOABSI  CLC   INCPTS(2),H5            IF TWO ABSOLUTE VECTORS,         39180021
         BH    FLIPMODE                  MORE THAN 5 INCREMENTALS       39240021
         BNH   KEEPMODE                  5 OR LESS                      39300021
FINOPT   TM    PTSGSW,X'20'                                             39360021
         BO    STRINC                                                   39420021
*                                                                       39480021
STRABS   LH    EVNACC,ABSPTS                                            39540021
         MH    EVNACC,H4                                                39600021
         TM    SMSW,X'FF'                                               39660021
         BZ    ABSPACE                                                  39720021
         LA    EVNACC,2(EVNACC)                                         39780021
ABSPACE  CR    EVNACC,GDOACNT                                           39840021
         BH    GDOAOVER                                                 39900021
         LA    ODDACC,WRKAR            GET ADDRESS OF DATA              39960021
         TM    SMSW,X'FF'                                               40020021
         BZ    STRDATAA                                                 40080021
         TM    PTSGSW,X'10'                                             40140021
         BO    ABSVECSM                                                 40200021
         MVC   0(2,OLPREG),GEPM                                         40260021
         MVC   CURMOD(2),GEPM                                           40320021
         B     SMUPDA                                                   40380021
ABSVECSM MVC   0(2,OLPREG),GEVM                                         40440021
         MVC   CURMOD(2),GEVM                                           40500021
SMUPDA   LA    OLPREG,2(OLPREG)                                         40560021
         SH    GDOACNT,H2              AVAILABLE SPACE BY 2 BYTES       40620021
         SH    EVNACC,H2               DECREMENT SPACE REQUIRED &       40680021
STRDATAA LTR   EVNACC,EVNACC           IF NO DATA IS PRESENT,           40740021
         BZ    CHKMODE                 BYPASS DATA STORAGE              40800021
         SR    GDOACNT,EVNACC          UPDATE AVAILABLE SPACE           40860021
         BCTR  EVNACC,0                                                 40920021
         EX    EVNACC,MVDATAI          MOVE DATA INTO GDOA              40980021
         LA    OLPREG,1(OLPREG,EVNACC) UPDATE OLP                       41040021
*                                      OFF                              41100021
         LH    EVNACC,ABSPTS           GET POINTER                      41160021
         MH    EVNACC,H4               TO LAST                          41220021
         SH    EVNACC,H4               ABSOLUTE                         41280021
         LA    EVNACC,WRKAR(EVNACC)    VECTOR IN WORK AREA              41340021
         MVC   XP(4),0(EVNACC)         SAVE AS LAST PHYSICAL LOCATION   41400021
*                                      OF THE BEAM                      41460021
         NI    XP,X'0F'                ELIMINATE BEAM BIT               41520021
CHKMODE  MVI   SMSW,X'00'                                               41580021
         MVI   OVERFLAG,X'00'                                           41640021
         XC    ABSPTS(2),ABSPTS        SET NUMBER OF ABSOLUTE POINTS    41700021
*                                      EQUAL TO ZERO                    41760021
         TM    PTPOS,X'40'             MODE OVERIDEN                    41820021
         BZ    SEGTEST                 NO- CONTINUE                     41880021
         TM    PTPOS,X'80'             YES- OPTIMIZATION OVERRIDEN      41940021
         BZ    RONGMODE                NO                               42000021
         OI    PTSGSW,X'80'            YES- SET OPTIMIZED MODE          42060021
         B     SEGTEST                 AND CONTINUE                     42120021
RONGMODE MVI   SMSW,X'FF'              SET MODE TO BE GENERATED         42180021
         XI    PTSGSW,X'20'            SET PROPER MODE                  42240021
SEGTEST  NI    PTPOS,X'3F'             TURN OFF OVERIDE SIGNAL          42300021
         CLI   SEGOPT,C'B'             SEE IF SEGMENT PLOT              42360021
         BE    SEGLOOP                                                  42420021
         B     MAINLOOP                                                 42480021
*                                                                       42540021
MVDATAI  MVC   0(0,OLPREG),0(ODDACC)                                    42600021
*                                                                       42660021
STRINC   LH    ODDACC,ABSPTS           GET LOCATION OF INCREMENTAL      42720021
         MH    ODDACC,H4               DATA                             42780021
         LH    EVNACC,INCPTS           GET NUMBER OF INCREMENTAL        42840021
         MH    EVNACC,H2               DATA BYTES                       42900021
         TM    SMSW,X'FF'              IF SET MODE REQUESTED,           42960021
         BZ    INCSPACE                                                 43020021
         LA    EVNACC,2(EVNACC)        INCREASE NUMBER OF BYTES         43080021
*                                      REQUIRED BY 2                    43140021
INCSPACE CR    EVNACC,GDOACNT          SEE IF ENOUGH SPACE IN GDOA      43200021
         BH    GDOAOVER                                                 43260021
         LA    ODDACC,WRKAR(ODDACC)    GET ADDRESS OF DATA              43320021
         TM    SMSW,X'FF'                                               43380021
         BZ    STRDATAA                                                 43440021
*                                                                       43500021
         TM    PTSGSW,X'10'            INSERT SET MODE INTO GDOA        43560021
         BO    INCVECSM                IF REQUESTED                     43620021
         MVC   0(2,OLPREG),GEPI2       INCREMENTAL POINT MODE           43680021
         MVC   CURMOD(2),GEPI2                                          43740021
         B     SMUPDA                  UPDATE OLP AND STORE DATA        43800021
INCVECSM MVC   0(2,OLPREG),GEVI2       INCREMENTAL VECTOR MODE          43860021
         MVC   CURMOD(2),GEVI2                                          43920021
         B     SMUPDA                  UPDATE OLP AND STORE DATA        43980021
SEGLOOP  LA    POINTS,2(POINTS)        INCREMENT COUNTER BY 2           44040021
         CH    POINTS,N                FINISHED WITH CALL               44100021
         BH    NORMTERM                YES, TERMINATE ROUTINE           44160021
         BAL   RETREG,GETNEXT                                           44220021
         MVC   NXTX1(8),DELTAX                                          44280021
*                                                                       44340021
         LM    EVNACC,ODDACC,X                                          44400021
         C     EVNACC,NXTX1                                             44460021
         BNE   NORMPROC                                                 44520021
         C     ODDACC,NXTY1                                             44580021
         BE    PROCSEC                                                  44640021
NORMPROC LA    ACC,NXTX1                                                44700021
         BAL   RETREG,SGCHECK                                           44760021
         LTR   ENTREG,ENTREG                                            44820021
         BC    7,STOLP                                                  44880021
         MVC   X(8),NXTX1              MODIFY LOGICAL POSITION          44940021
*                                      OF BEAM                          45000021
         TM    SUPLT1,X'FF'            PLOT OF 1ST POINT SUPPRESSED     45060021
         BO    PROCSEC                 YES, PROCESS 2ND POINT           45120021
         TM    PTCNT1,X'F0'            TWO VECTORS GENERATED            45180021
         BZ    ONEFRST                                                  45240021
         CLC   ADJX21(2),NXTX1+2       2ND ONE = INPUT VALUE            45300021
         BNE   PROCSEC                 NO, PROCESS 2ND POINT            45360021
         CLC   ADJY21(2),NXTY1+2                                        45420021
         BNE   PROCSEC                                                  45480021
         MVC   WRKAR(4),ADJX21         YES, GENERATE BLANKED VECTOR     45540021
         B     EPONE                   TO FIRST POINT                   45600021
*                                                                       45660021
ONEFRST  CLC   ADJX11(2),NXTX1+2       ONLY VECTOR RETURNED             45720021
         BNE   PROCSEC                 FROM SCISSORING=INPUT VALUE      45780021
         CLC   ADJY11(2),NXTY1+2       NO, PROCESS 2ND POINT            45840021
         BNE   PROCSEC                                                  45900021
         MVC   WRKAR(4),ADJX11         GENERATE BLANKED VECTOR TO       45960021
EPONE    OI    WRKAR,X'40'             TO 1ST POINT                     46020021
         OI    PTPOS,X'80'             SET SWITCH                       46080021
*                                                                       46140021
PROCSEC  BAL   RETREG,GETNEXT                                           46200021
         LA    ACC,NXTX2                                                46260021
         MVC   NXTX2(8),DELTAX                                          46320021
*                                                                       46380021
         BAL   RETREG,SGCHECK                                           46440021
         LTR   ENTREG,ENTREG                                            46500021
         BC    7,STOLP                                                  46560021
         MVC   X(8),NXTX2              MODIFY LOGICAL POSITION          46620021
*                                      OF BEAM                          46680021
         TM    SUPLT2,X'FF'            2ND POINT SUPPRESSED             46740021
         BZ    TWOTST                  NO, CHECK FURTHER                46800021
NODATA   NI    PTPOS,X'3F'             YES, GENERATE NO DATA            46860021
         B     SEGLOOP                                                  46920021
*                                                                       46980021
TWOTST   TM    PTCNT2,X'F0'            2 PTS RETURNED FROM SCISSORING   47040021
         BZ    ONETEST                 NO                               47100021
         MVC   WRKAR(8),ADJX12         YES, PLOT THEM WITH              47160021
         OI    WRKAR,X'40'             1ST BLANKED                      47220021
TWOSEG   MVC   ABSPTS(2),H2            SET POINT COUNT =2               47280021
PLTSEG   NI    PTPOS,X'3F'             SET SWITCH OFF                   47340021
         B     PTYPETST                                                 47400021
*                                                                       47460021
ONETEST  TM    BV12,X'FF'              BEAM BLANKED                     47520021
         BO    NODATA                  YES, GENERATE NO DATA            47580021
         TM    PTPOS,X'80'             POSITIONING VECTOR STORED        47640021
         BZ    ONESEG                  NO                               47700021
         MVC   WRKAR+4(4),ADJX12       YES, STORE SECOND PT             47760021
         B     TWOSEG                                                   47820021
*                                                                       47880021
ONESEG   MVC   WRKAR(4),ADJX12         ONLY ONE POINT, PLOT IT          47940021
         MVC   ABSPTS(2),H1            SET POINT COUNT =1               48000021
         B     PLTSEG                                                   48060021
*                                                                       48120021
NORMTERM L     EVNACC,OACBAD           GET ADDRESS OF THE OACB          48180021
         ST    OLPREG,16(EVNACC)       UPDATE THE VALUE OF THE OLP      48240021
*                                      IN THE OACB                      48300021
         CLC   RETCD(2),ZERO           RETURN CODE WORKAREA NON-ZERO    48360021
         BNE   BADTERM                 YES                              48420021
         TM    DEFLG,X'FF'             NO. ANY DEFAULTS TAKEN           48480021
         BO    BADTERM                 YES                              48540021
         L     SAVEREG,4(SAVEREG)      GET POINTER TO SAVE AREA         48600021
         L     RETREG,12(SAVEREG)      RESTORE REGISTER 14              48660021
         SPM   RETREG                  RESTORE USER'S PROGRAM MASK      48720021
         RETURN (15,12),RC=0           RESTORE OTHER REGISTERS          48780021
*                                                                       48840021
BADTERM  LH    ENTREG,RETCD            GET RETURN CODE                  48900021
         N     ENTREG,RRC                                               48960021
         TM    DEFLG,X'FF'             ANY DEFAULTS TAKEN               49020021
         BZ    BADOUT                  NO                               49080021
         LTR   ENTREG,ENTREG           YES. RETURN CODE                 49140021
         BM    BADOUT                  NEGATIVE-MULTIPLE ERROR FLAG SET 49200021
         BP    ORIN                    POSITIVE-OR IN MULTIPLE ERROR    49260021
         LA    ENTREG,X'28'            ZERO,SET RETURN CODE             49320021
BADOUT   L     SAVEREG,4(SAVEREG)      GET POINTER TO SAVE AREA         49380021
         L     RETREG,12(SAVEREG)      RESTORE REGISTER 14              49440021
         SPM   RETREG                  RESTORE USER'S PROGRAM MASK      49500021
         RETURN (0,12),RC=(15)                                          49560021
*                                                                       49620021
ORIN     O     ENTREG,HIGHBIT          SET MULTIPLE ERROR FLAG          49680021
         B     BADOUT                  AND EXIT                         49740021
*                                                                       49800021
STOLP    L     EVNACC,OACBAD           SAVE UPDATED OLP                 49860021
         ST    OLPREG,16(EVNACC)                                        49920021
ENDTERM  CLC   RETCD(2),ZERO           IMMEDIATE TERMINATION-           49980021
         BNE   ORIN                    SET MULTIPLE ERROR               50040021
         TM    DEFLG,X'FF'             FLAG IF ANY OTHER                50100021
         BO    ORIN                    ERROR CONDITIONS DETECTED        50160021
         B     BADOUT                  AND EXIT                         50220021
*                                                                       50280021
GDOAOVER TM    OVERFLAG,X'FF'          IS OVERFLOW FLAG SET             50340021
         BO    RC24                    YES, IMMEDIATE ERROR EXIT        50400021
         SAVE  (14,12)                 NO, SAVE REGISTERS               50460021
         LR    PARLIST,SAVEREG         SET UP CALL TO                   50520021
         L     SAVEREG,4(SAVEREG)      USER'S OVERFLOW                  50580021
         L     ENTREG,OACBAD           ROUTINE                          50640021
         ST    OLPREG,16(ENTREG)       UPDATE OLP                       50700021
         L     ENTREG,8(ENTREG)                                         50760021
         BALR  RETREG,ENTREG           CALL OVERFLOW ROUTINE            50820021
         LR    SAVEREG,PARLIST         RESTORE REGISTERS                50880021
         LM    14,12,12(SAVEREG)                                        50940021
         MVI   OVERFLAG,X'FF'                                           51000021
         L     EVNACC,OACBAD           GET NEW VALUES                   51060021
         L     OLPREG,16(EVNACC)       OF OLP                           51120021
         L     GDOACNT,0(EVNACC)       AND NUMBER OF                    51180021
         A     GDOACNT,4(EVNACC)       AVAILABLE BYTES                  51240021
         SR    GDOACNT,OLPREG          IN GDOA                          51300021
         SH    GDOACNT,H4              ALLOW SPACE FOR GTRU             51360021
         B     FINOPT                                            A29393 51420021
*                                                                       51480021
RC24     LA    ENTREG,24               OLP NOT SET TO PERMIT            51540021
         B     ENDTERM                 STORAGE OF DATA AFTER OVERFLOW   51600021
*                                                                       51660021
RC4      LA    ENTREG,4                ILLEGAL GRID LIMITS              51720021
         B     ENDTERM                                                  51780021
*                                                                       51840021
         DS    0F                                                       51900021
RRC      DC    X'800000FF'                                              51960021
HIGHBIT  DC    X'80000000'                                              52020021
*                                                                       52080021
GETNEXT  SAVE  (14,12)                 SAVE REGISTERS                   52140021
*                                                                       52200021
         LA    PARLIST,SVAR2           GET NEW SAVE AREA                52260021
         ST    SAVEREG,4(PARLIST)                                       52320021
         ST    PARLIST,8(SAVEREG)      CHAIN SAVE AREAS                 52380021
         LR    SAVEREG,PARLIST                                          52440021
*                                                                       52500021
*                                                                       52560021
*                                                                       52620021
*                                                                       52680021
UTEST    MVC   MODE(1),UMODE           MOVE MODE INTO TEMPORARY         52740021
*                                      LOCATION                         52800021
         SR    PARLIST,PARLIST         SET POINTER TO X-U VALUES        52860021
GETLOOP  TM    PTSGSW,X'40'            FIRST POINT THIS CALL            52920021
         BO    INITIAL                 YES, INITIALIZE                  52980021
*                                                                       53040021
         TM    MODE,X'80'              IF VALUES DERIVED FROM           53100021
         BO    INC                     TABLE,                           53160021
         L     EVNACC,UINDEX(PARLIST)  GET INDEX FACTOR TO TABLE        53220021
         MH    EVNACC,H4                                                53280021
         A     EVNACC,UTAB(PARLIST)    ADD ADDRESS OF LAST ENTRY USED   53340021
         ST    EVNACC,UTAB(PARLIST)    STORE ADDRESS OF CURRENT ENTRY   53400021
*                                                                       53460021
         TM    MODE,X'40'              IF VALUES INCREMENTAL            53520021
         BZ    ABS                                                      53580021
INCRMNT  TM    MODE,X'10'              CHECK MODE                       53640021
         BZ    FXINC                                                    53700021
         LE    FPACC,U(PARLIST)        EVALUATE NEW VALUE               53760021
         AE    FPACC,0(EVNACC)         IN FLOATING-POINT                53820021
         STE   FPACC,U(PARLIST)        AND STORE                        53880021
         B     SCALE                                                    53940021
*                                                                       54000021
FXINC    L     ODDACC,U(PARLIST)       EVALUATE NEW VALUE               54060021
         A     ODDACC,0(EVNACC)        IN INTEGER                       54120021
         ST    ODDACC,U(PARLIST)       AND STORE                        54180021
         B     SCALE                                                    54240021
*                                                                       54300021
INC      LA    EVNACC,UINCR(PARLIST)   GET ADDRESS OF FIXED INCREMENT   54360021
         B     INCRMNT                                                  54420021
*                                                                       54480021
INITIAL  L     EVNACC,UADDR(PARLIST)   GET ADDRESS OF FIRST ENTRY       54540021
         ST    EVNACC,UTAB(PARLIST)    INITIALIZE BOOKEEPING            54600021
*                                                                       54660021
ABS      L     ACC,0(EVNACC)           GET ABSOLUTE VALUE               54720021
         ST    ACC,U(PARLIST)          OF COORDINATE                    54780021
*                                                                       54840021
SCALE    CLI   S,C'B'                  IF SCALING NOT REQUESTED         54900021
         BNE   SKPSC                   SKIP IT                          54960021
         L     ODDACC,XALTER(PARLIST)  GET MULTIPLICATIVE CONSTANT      55020021
         LTR   ODDACC,ODDACC           IF SCALING CONSTANTS HAVE        55080021
         BZ    SCINT                   CHANGED, REEVALUATE              55140021
SCALE1   TM    MODE,X'10'              CHECK MODE                       55200021
         BZ    FXSCL                   INTEGER                          55260021
*                                                                       55320021
         LE    FPACC,XALTER(PARLIST)   MULTIPLY COORDINATE AND          55380021
         ME    FPACC,U(PARLIST)        MULTIPLICATIVE CONSTANT          55440021
         AE    FPACC,XCON(PARLIST)     ADD ADDITIVE CONSTANT            55500021
         STE   FPACC,OPTIMSV(PARLIST)  STORE SCALED VALUE               55560021
FIXVAL   ST    PARLIST,0(SAVEREG)      PRESERVE POINTER                 55620021
         LA    PARLIST,OPTIMSV(PARLIST)                                 55680021
         BAL   RETREG,FIX              CONVERT COORDINATE TO INTEGER    55740021
         L     PARLIST,0(SAVEREG)      GET POINTER                      55800021
         LTR   ENTREG,ENTREG                                            55860021
         BZ    VTEST                                                    55920021
         L     SAVEREG,4(SAVEREG)      ERROR(S) IN CONVERSION           55980021
         RETURN (14,12),RC=(15)        IMMEDIATE RETURN                 56040021
*                                                                       56100021
FXSCL    L     ODDACC,XALTER(PARLIST)  SCALE POINT                      56160021
         M     EVNACC,U(PARLIST)       USING                            56220021
         SRDA  EVNACC,12               INTEGER                          56280021
         A     ODDACC,XCON(PARLIST)    ARITMETIC                        56340021
         ST    ODDACC,OPTIMSV(PARLIST) AND STORE                        56400021
VTEST    LTR   PARLIST,PARLIST         IF NON-ZERO,                     56460021
         BC    7,GETERM                EXIT                             56520021
*                                                                       56580021
         MVC   MODE(1),VMODE           SET UP VALUES FOR                56640021
         LA    PARLIST,4               V-Y VALUES                       56700021
         B     GETLOOP                                                  56760021
SKPSC    L     ODDACC,U(PARLIST)       SET COORDINATE = UNSCALED        56820021
         ST    ODDACC,OPTIMSV(PARLIST) VALUE                            56880021
         TM    MODE,X'10'              CONVERT TO INTEGER               56940021
         BO    FIXVAL                  IF NECESSARY                     57000021
         B     VTEST                                                    57060021
SCINT    TM    MODE,X'10'              CHECK MODE                       57120021
         BO    FLTSCALE                CALL                             57180021
FIXSCALE L     ACC,GX2(PARLIST)        COMPUTE FIFFERENCE OF            57240021
         S     ACC,GX1(PARLIST)        GRID LIMITS                      57300021
         L     ACC1,SX2(PARLIST)       COMPUTE DIFFERENCE OF            57360021
         S     ACC1,SX1(PARLIST)       SCREEN LIMITS                    57420021
         L     ACC2,DX2(PARLIST)       COMPUTE DIFFERENCE OF            57480021
         S     ACC2,DX1(PARLIST)       DATA LIMITS                      57540021
         BC    12,RC16                 ILLEGAL DATA LIMITS              57600021
*                                                                       57660021
         L     ODDACC,FOURK            GET CONSTANT                     57720021
         MR    EVNACC,ACC              MULTIPLY BY GRID DIFFERENCE      57780021
         SLDA  EVNACC,12               SCALE TO PERMIT CONSTANTS        57840021
*                                      LESS THAN 1                      57900021
         DR    EVNACC,ACC1             DIVIDE BY DIFFERENCE IN SCREEN   57960021
         LR    EVNACC,ODDACC           AND DATA LIMITS                  58020021
         SRDA  EVNACC,32                                                58080021
         DR    EVNACC,ACC2                                              58140021
         ST    ODDACC,XALTER(PARLIST)  STORE MULTIPLICATIVE CONSTANT    58200021
*                                                                       58260021
         LR    ODDACC,ACC              COMPUTE 4095(GX2-GX1)            58320021
         M     EVNACC,FOURK                                             58380021
         SLDA  EVNACC,16               SCALE TO IMPROVE ACCURACY        58440021
         DR    EVNACC,ACC1             DIVIDE BY SX2-SX1                58500021
         M     EVNACC,DX1(PARLIST)     GET REST OF NUMERATOR            58560021
         SRDA  EVNACC,16               REMOVE SCALING FACTOR            58620021
         DR    EVNACC,ACC2             DIVIDE BY DX2-DX1                58680021
         ST    ODDACC,DELTAX           STORE COMPLETED TERM             58740021
*                                                                       58800021
         L     ODDACC,GX1(PARLIST)     COMPUTE GX1-SX1                  58860021
         S     ODDACC,SX1(PARLIST)                                      58920021
         M     EVNACC,FOURK            COMPUTE 4095(GX1-SX1)            58980021
         DR    EVNACC,ACC1             FINISH COMPUTATION OF TERM       59040021
         S     ODDACC,DELTAX           COMPUTE FULL ADDITIVE SONSTANT   59100021
         ST    ODDACC,XCON(PARLIST)    AND STORE IT                     59160021
         B     SCALE1                              ROUTINE              59220021
FLTSCALE LE    FPACC,GX2(PARLIST)      COMPUTE  G2-G1                   59280021
         SE    FPACC,GX1(PARLIST)                                       59340021
         LE    FPACC1,SX2(PARLIST)     COMPUTE  S2-S1                   59400021
         SE    FPACC1,SX1(PARLIST)                                      59460021
         LE    FPACC2,DX2(PARLIST)     COMPUTE  D2-D1                   59520021
         SE    FPACC2,DX1(PARLIST)                                      59580021
         BC    12,RC16                 ILLEGAL DATA LIMITS              59640021
*                                                                       59700021
         LE    FPACC3,FOURKE           GET CONSTANT (4096)              59760021
         MER   FPACC3,FPACC            MULTIPLY BY DIFFERENCE IN        59820021
*                                      GRID LIMITS                      59880021
         DER   FPACC3,FPACC1           DIVIDE BY DIFFERENCE IN SCREEN   59940021
*                                      LIMITS                           60000021
         DER   FPACC3,FPACC2           DIVIDE BY DIFFERENCE IN DATA     60060021
*                                      LIMITS                           60120021
         STE   FPACC3,XALTER(PARLIST)  STORE MULTIPLICATIVE CONSTANT    60180021
*                                                                       60240021
         LE    FPACC3,GX1(PARLIST)     COMPUTE G1-S1                    60300021
         SE    FPACC3,SX1(PARLIST)                                      60360021
         MER   FPACC3,FPACC2           COMPUTE (G1-S1)(D2-D1)           60420021
         ME    FPACC,DX1(PARLIST)      COMPUTE (D1)(G2-G1)              60480021
         SER   FPACC3,FPACC            COMPUTE VARIABLE PART OF         60540021
*                                      NUMERATOR                        60600021
         ME    FPACC3,FOURKE           COMPUTE COMPLETE NUMERATOR       60660021
         DER   FPACC3,FPACC1           DIVIDE BY DIFFERENCES IN SCREEN  60720021
         DER   FPACC3,FPACC2           AND DATA DIFFERENCES             60780021
         STE   FPACC3,XCON(PARLIST)    STORE ADDITIVE CONSTANT          60840021
*                                                                       60900021
         B     SCALE1                              SCALING CONSTANTS    60960021
*                                                                       61020021
GETERM   MVC   DELTAX(8),OPTIMSV       GET NEW COORDINATES              61080021
         L     SAVEREG,4(SAVEREG)      GET POINTER TO SAVE AREA         61140021
         RETURN (14,12),RC=0                                            61200021
*                                                                       61260021
*        ILLEGAL DATA LIMITS                                            61320021
RC16     L     SAVEREG,4(SAVEREG)      GET POINTER TO SAVE AREA         61380021
         RETURN (14,12),RC=16                                           61440021
*                                                                       61500021
FOURK    DC    F'4095'                                                  61560021
FOURKE   DC    E'4095'                                                  61620021
BEAM     DC    X'0FFFFFFF'                                              61680021
*                                                                       61740021
FIX      SAVE  (14,12)                                                  61800021
         SR    ENTREG,ENTREG                                            61860021
         L     ODDACC,0(PARLIST)       GET MANTISSA OF NUMBER           61920021
         N     ODDACC,MANTISSA         TO BE CONVERTED                  61980021
         LH    EVNACC,0(PARLIST)       GET CHARACTERISTIC OF            62040021
         N     EVNACC,CHAR             NUMBER TO BE CONVERTED           62100021
         BZ    RC12                    IF ZERO, CHECK FOR ZERO MANTISSA 62160021
         SRA   EVNACC,6                                                 62220021
         SH    EVNACC,H256             SEE IF NUMBER CAN BE CONVERTED   62280021
         BC    12,UNDERFLO             NO, EXPONENT LESS THAN 0         62340021
         CH    EVNACC,H32                                               62400021
         BH    OVERFLOW                NO, EXPONENT GREATER THAN 8      62460021
         BE    POSOVER                 OVERFLOW POSSIBLE ON CONVERSION  62520021
         SH    EVNACC,H24              GET SHIFT COUNT FOR MANTISSA     62580021
         BP    LFTSHIFT                POSITIVE, SHIFT LEFT             62640021
         LPR   EVNACC,EVNACC           NEGATIVE, CONVERT TO PROPER      62700021
         SRA   ODDACC,0(EVNACC)        SHIFT COUNT AND SHIFT RIGHT      62760021
SIGN     TM    0(PARLIST),X'80'        NUMBER TO BE CONVERTED NEGATIVE  62820021
         BZ    STFIXED                 NO, JUST STORE IT                62880021
         LNR   ODDACC,ODDACC           YES, COMPLEMENT IT               62940021
STFIXED  ST    ODDACC,0(PARLIST)                                        63000021
         RETURN (14,12),RC=(15)                                         63060021
*                                                                       63120021
LFTSHIFT SLA   ODDACC,0(EVNACC)        SHIFT MANTISSA LEFT              63180021
         B     SIGN                    CHECK SIGN                       63240021
*                                                                       63300021
UNDERFLO SR    ODDACC,ODDACC           SET NUMBER TO 0                  63360021
         B     STFIXED                                                  63420021
*                                                                       63480021
POSOVER  TM    1(PARLIST),X'80'        HIGH-ORDER BIT OF MANTISSA=1     63540021
         BZ    LFTSHIFT                NO, OVERFLOW WILL NOT OCCUR ON   63600021
*                                      CONVERSION                       63660021
OVERFLOW SR    ODDACC,ODDACC           SET NUMBER =0                    63720021
         LA    ENTREG,16               SET RETURN CODE                  63780021
         B     STFIXED                                                  63840021
*                                                                       63900021
RC12     LTR   ODDACC,ODDACC           IF MANTISSA                      63960021
         BZ    UNDERFLO                IS NON-ZERO                      64020021
         LA    ENTREG,12               SET RETURN CODE                  64080021
         B     UNDERFLO                                                 64140021
H24      DC    H'24'                                                    64200021
H32      DC    H'32'                                                    64260021
H256     DC    H'256'                                                   64320021
         DS    0F                                                       64380021
CHAR     DC    X'00007F00'             MASK FOR CHARACTERISTIC          64440021
MANTISSA DC    X'00FFFFFF'             MASK FOR MANTISSA                64500021
DISPLACE SAVE  (14,12)                 SAVE GENERAL REGISTERS           64560021
*                                                                       64620021
*   DO NOT SET UP SAVE AREA SINCE LOWESR LEVEL SUBROUTINE               64680021
*                                                                       64740021
         LA    ABIND,WRKAR             GET ADDRESS OF TEMPORARY         64800021
         LH    INCIND,ABSPTS           ORDER STORAGE AREAS              64860021
         MH    INCIND,H4                                                64920021
         AR    INCIND,ABIND                                             64980021
         LH    COUNT,ABSPTS            GET NO. OF ABSOLUTE VECTORS      65040021
         XC    INCPTS(2),INCPTS        SET NO. OF INCREMENTAL PTS.=0    65100021
         LTR   COUNT,COUNT             NO ABSOLUTE VECTORS,             65160021
         BZ    DISPRET                 GENERATE NO INCREMENTAL          65220021
         LA    EVNACC,CURMOD           GET NUMBER OF AVAILABLE BYTES    65280021
         SR    EVNACC,INCIND           IN THE WORK AREA                 65340021
         SRA   EVNACC,1                AND NUMBER OF INCREMENTAL        65400021
*                                      VECTORS THAT WILL FIT            65460021
         STH   EVNACC,BTCNT            AND STORE                        65520021
*                                                                       65580021
*   COMPUTE DISPLACEMENT TO NEXT POINT                                  65640021
*                                                                       65700021
NEXT     LH    EVNACC,XP               CURRENT X                        65760021
         N     EVNACC,REDUCE           ELIMINATE LOW-ORDE 2 BITS        65820021
         LH    ODDACC,0(ABIND)         NEXT X                           65880021
         N     ODDACC,HALFBEAM         ELIMINATE BEAM BIT               65940021
         SR    ODDACC,EVNACC           GET X-DISPLACEMENT               66000021
         ST    ODDACC,DELTAX           AND STORE                        66060021
*                                                                       66120021
         LH    EVNACC,YP               CURRENT Y                        66180021
         N     EVNACC,REDUCE           ELININATE LOW-ORDER 2 BITS       66240021
         LH    ODDACC,2(ABIND)         NEXT Y                           66300021
         SR    ODDACC,EVNACC           GET Y-DISPLACEMENT               66360021
         ST    ODDACC,DELTAY           AND STORE                        66420021
*                                                                       66480021
*                                                                       66540021
SPLITU   L     EVNACC,DELTAX           GET MAGNITUDE OF                 66600021
         LPR   MAGDELX,EVNACC          X-DISPLACEMENT                   66660021
         L     ODDACC,DELTAY           GET MAGNITUDE OF                 66720021
         LPR   MAGDELY,ODDACC          Y-DISPLACEMENT                   66780021
         CR    MAGDELX,MAGDELY                                          66840021
         BL    YHIU                    Y GREATER                        66900021
         BE    XEQYU                   EQUAL                            66960021
*                                      X GREATER                        67020021
         TM    DELTAX,X'80'            SEE IF DELTAX NEGATIVE           67080021
         BO    XHIN                                                     67140021
         LA    DELX,252                NO, ASSUME = 252 FOR STEP        67200021
         LA    ODDACC,252                                               67260021
         B     XHIUC                                                    67320021
XHIN     LH    DELX,LOWLIM             DELTAX NEGATIVE, ASSUME = -256   67380021
         LH    ODDACC,LOWLIM                                            67440021
XHIUC    M     EVNACC,DELTAY           GET Y DISPLACEMENT FOR STEP      67500021
         D     EVNACC,DELTAX                                            67560021
         LR    DELY,ODDACC             SAVE Y DISPLACEMENT              67620021
*                                                                       67680021
NOXS     L     EVNACC,DELTAX           GET NUMBER OF VECTORS            67740021
         SRDA  EVNACC,32               WITH LENGTH DELX                 67800021
         DR    EVNACC,DELX             TO DISPLAY ONE WITH              67860021
         LR    NINC,ODDACC             LENGTH DELTAX                    67920021
*                                                                       67980021
REMU     L     RX,DELTAX               COMPUTE X-DISPLACEMENT           68040021
         LR    ODDACC,DELX             REMAINING AFTER FIXED            68100021
         MR    EVNACC,NINC             LENGTH VECTORS USED              68160021
         SR    RX,ODDACC                                                68220021
*                                                                       68280021
         L     RY,DELTAY               COMPUTE Y-DISPLACEMENT           68340021
         LR    ODDACC,DELY             REMAINING AFTER                  68400021
         MR    EVNACC,NINC             OTHER VECTORS USED               68460021
         SR    RY,ODDACC                                                68520021
*                                                                       68580021
         SR    ERRX,ERRX               SET BOTH ERRORS                  68640021
         SR    ERRY,ERRY               TO ZERO                          68700021
*                                                                       68760021
CONVRTU  CH    NINC,BTCNT              MORE VECTORS NECESSARY THAN      68820021
*                                      WILL FIT INTO THE WORKAREA       68880021
         BNL   WRKOVER                 PREPARE FOR WORKAREA OVERFLOW    68940021
         LA    ACC,1                   ADD N+1                          69000021
         AH    ACC,INCPTS              TO NUMBER                        69060021
         AR    ACC,NINC                OF INCREMENTAL                   69120021
         STH   ACC,INCPTS              DATA POINTS                      69180021
         LTR   NINC,NINC               ONLY ONE INCREMENTAL VECTOR      69240021
         BZ    LASTSEG                 YES                              69300021
*                                                                       69360021
CNVRTLPU AR    ERRX,DELX               ADD CUMULATIVE ERROR TO          69420021
         L     ACC,REDUCE              X-DISPLACEMENT.                  69480021
         NR    ACC,ERRX                ELIMINATE LOW-ORDER 2 BITS       69540021
         SR    ERRX,ACC                GET ERROR FROM THIS STEP         69600021
         SRA   ACC,1                   CONVERT X-DISPLACEMENT           69660021
         STC   ACC,0(INCIND)           TO INCREMENTAL DATA FROM         69720021
         OI    0(INCIND),X'01'         AND STORE                        69780021
*                                                                       69840021
         AR    ERRY,DELY               ADD CUMULATIVE ERROR TO          69900021
         L     ACC,REDUCE              Y-DISPLACEMENT                   69960021
         NR    ACC,ERRY                ELIMINATE LOW-ORDER 2 BITS       70020021
         SR    ERRY,ACC                GET ERROR FROM THIS STEP         70080021
         SRA   ACC,1                   CONVERT Y-DISPLACEMENT TO        70140021
         STC   ACC,1(INCIND)           INCREMENTAL DATA FORM & STORE    70200021
         TM    0(ABIND),X'40'          IF ABSOLUTE VECTOR               70260021
         BO    BLNKPT                  BLANKED, BLANK                   70320021
         TM    PTSGSW,X'10'            BLANK BEAM                       70380021
         BO    UPDTU                   IF POINT PLOT                    70440021
BLNKPT   OI    1(INCIND),X'01'         REQUESTED                        70500021
*                                                                       70560021
UPDTU    LA    INCIND,2(INCIND)        INCREMENT POINTER TO WORKAREA    70620021
         BCT   NINC,CNVRTLPU           PROCESS NEXT SEGMENT             70680021
*                                                                       70740021
LASTSEG  AR    ERRX,RX                 LAST SEGMENT-ADD CUMULATIVE      70800021
         L     ACC,REDUCE              ERROR TO X-REMAINDER             70860021
         NR    ACC,ERRX                ELIMINATE LOW-ORDER 2 BITS       70920021
         SRA   ACC,1                   CONVERT TO INCREMENTAL DATA      70980021
         STC   ACC,0(INCIND)           FORM AND STORE                   71040021
         OI    0(INCIND),X'01'                                          71100021
*                                                                       71160021
         AR    ERRY,RY                 ADD CUMULATIVE ERROR TO          71220021
         L     ACC,REDUCE              Y-REMAINDER                      71280021
         NR    ACC,ERRY                ELIMINATE LOW-ORDER 2 BITS       71340021
         SRA   ACC,1                   CONVERT TO INCREMENTAL DATA FORM 71400021
         STC   ACC,1(INCIND)           & STORE WITH BEAM INTENSIFIED    71460021
         TM    0(ABIND),X'40'          IF ABSOLUTE VECTOR               71520021
         BZ    ENDTEST                 BLANKED, BLANK                   71580021
         OI    1(INCIND),X'01'         INCREMENTAL                      71640021
*                                                                       71700021
ENDTEST  MVC   XP(4),0(ABIND)          UPDATE PHYSICAL BEAM POSITION    71760021
         NI    XP,X'0F'                TURN OFF BEAM BIT                71820021
         LA    INCIND,2(INCIND)        INCREMENT                        71880021
         LA    ABIND,4(ABIND)                    POINTERS               71940021
         BCT   COUNT,NEXT              BRANCH BACK IF NOT FINISHED      72000021
*                                      AND GO THROUGH THE LOOP AGAIN    72060021
DISPRET  RETURN (14,12),RC=0           IF FINISHED, RETURN TO CALLING   72120021
*                                      PROGRAM                          72180021
*                                                                       72240021
*   ROUTINE TO SPLIT VECTOR INTO SMALLER ONES-UNBLANKED                 72300021
*                                                                       72360021
YHIU     TM    DELTAY,X'80'            SEE IF DELTAY NEGATIVE           72420021
         BO    YHIN                                                     72480021
         LA    DELY,252                NO, ASSUME = 252 FOR STEP        72540021
         LA    ODDACC,252                                               72600021
         B     YHIUC                                                    72660021
YHIN     LH    DELY,LOWLIM             DELTAY NEGATIVE, ASSUME = -256   72720021
         LH    ODDACC,LOWLIM           FOR STEP                         72780021
*                                                                       72840021
YHIUC    M     EVNACC,DELTAX           GET X-DISPLACEMENT FOR STEP      72900021
         D     EVNACC,DELTAY                                            72960021
         LR    DELX,ODDACC             AND SAVE IT                      73020021
         L     EVNACC,DELTAY           GET NUMBER OF                    73080021
         SRDA  EVNACC,32               FIXED-LENGTH                     73140021
         DR    EVNACC,DELY             VECTORS TO BE                    73200021
         LR    NINC,ODDACC             DISPLAYED                        73260021
*                                                                       73320021
         B     REMU                                                     73380021
*                                                                       73440021
XEQYU    LA    DELX,252                ASSUME DISPLACEMENTS OF          73500021
         LA    DELY,252                252 MAGNITUDE                    73560021
         TM    DELTAX,X'80'            IF DELTAX IS NAGATIVE,           73620021
         BZ    XEQU                                                     73680021
         LNR   DELX,DELX               MAKE DELX NEGATIVE               73740021
*                                                                       73800021
XEQU     TM    DELTAY,X'80'            GET SIGN OF DELTAY               73860021
         BZ    YEQU                    AND ADJUST SIGN OF DISPLACEMENT  73920021
         LNR   DELY,DELY               TO AGREE                         73980021
*                                                                       74040021
YEQU     B     NOXS                                                     74100021
*                                                                       74160021
WRKOVER  RETURN (14,12),RC=36                                           74220021
*                                                                       74280021
         DS    0F                                                       74340021
REDUCE   DC    X'FFFFFFFC'                                              74400021
HALFBEAM DC    X'00000FFF'                                              74460021
SGCHECK  SAVE  (14,12)                                                  74520021
         LR    PARBASE,ACC             ADDRESSABILITY FOR PARAMETERS    74580021
         USING SGPAR,PARBASE                                            74640021
*                                                                       74700021
         LA    PARLIST,SVAR2           CHAIN SAVE                       74760021
         ST    SAVEREG,4(PARLIST)                 AREAS                 74820021
         ST    PARLIST,8(SAVEREG)                                       74880021
         LR    SAVEREG,PARLIST                                          74940021
*                                                                       75000021
         MVI   MODE,X'C0'              SAVE FLAGS,                      75060021
         NC    MODE(1),PTPOS           IF ANY                           75120021
         IC    PARLIST,PTPOS           SET POSITION OF                  75180021
         SRL   PARLIST,3               INITIAL POINT OF VECTOR          75240021
         STC   PARLIST,PTPOS           EQUAL TO POSITION OF             75300021
         NI    PTPOS,X'07'             TERMINAL POINT OF LAST VECTOR    75360021
         OC    PTPOS(1),MODE           RESTORE FLAG                     75420021
*                                                                       75480021
         LM    EVNACC,ODDACC,NXTX      GET NEXT POINT                   75540021
         STM   EVNACC,ODDACC,PT2X      STORE IN DATA AREA FOR           75600021
*                                      SCISSORING ROUTINE               75660021
*                                                                       75720021
         CH    EVNACC,X1               X VALUE WITHIN GRID              75780021
         BL    XSCR                    NO                               75840021
         CH    EVNACC,X2               MAYBE                            75900021
         BH    XSCR                    NO                               75960021
         CH    ODDACC,Y1               Y VALUE WITHIN GRID              76020021
         BL    YSCR                    NO                               76080021
         CH    ODDACC,Y2               MAYBE                            76140021
         BH    YSCR                    NO                               76200021
         OI    PTPOS,X'08'             POINT WITHIN GRID                76260021
         B     TEST                                                     76320021
*                                                                       76380021
XSCR     CH    EVNACC,ZERO             X VALUE WITHIN SCREEN            76440021
         BL    OFFSCR                  NO                               76500021
         CH    EVNACC,ZERO+4           MAYBE                            76560021
         BH    OFFSCR                  NO                               76620021
YSCR     CH    ODDACC,ZERO             Y VALUE WITHIN SCREEN            76680021
         BL    OFFSCR                  NO                               76740021
         CH    ODDACC,ZERO+4           MAYBE                            76800021
         BH    OFFSCR                  NO                               76860021
         OI    PTPOS,X'10'             POINT BETWEEN SCREEN & GRID      76920021
         B     TEST                                                     76980021
*                                                                       77040021
OFFSCR   OI    PTPOS,X'20'             POINT OFF- SCREEN                77100021
*                                                                       77160021
TEST     TM    PTPOS,X'07'             CALL JUST TO SET SWITCHES        77220021
         BZ    GETOUT                  FOR INITIAL POINT-- EXIT         77280021
*                                                                       77340021
         TM    PTSGSW,X'10'            POINT PLOT                       77400021
         BZ    PTPLTCHK                YES - CHECK IT                   77460021
         TM    PTPOS,X'09'             VECTOR PLOT- BOTH POINTS         77520021
         BO    ONEPLOT                 WITHIN GRID, ADJUSTED X,Y VALUES 77580021
*                                      = INPUT VALUES                   77640021
         TM    PTSGSW,X'02'            SHOW ALL POINTS IN SCREEN        77700021
         BZ    GRDSCIS                 NO                               77760021
         TM    PTPOS,X'24'             YES. BOTH POINTS ON SCREEN       77820021
         BZ    ONEPLOT                 YES, PLOT VECTOR                 77880021
         MVI   MODE,X'04'              MASKS FOR PT1                    77940021
         MVI   MODE+1,X'20'            AND PT2 OUTSIDE BOUNDARY         78000021
         LA    PARLIST,ZERO            BOUNDARY                         78060021
         B     SCRTSTA                                                  78120021
*                                                                       78180021
GRDSCIS  MVI   MODE,X'06'              MASKS FOR PT1                    78240021
         MVI   MODE+1,X'30'            AND PT2 OUTSIDE BOUNDARY         78300021
         LA    PARLIST,X1              BOUNDARY                         78360021
SCRTSTA  TM    BV21,X'FF'              INCREMENTAL POSITIONING          78420021
         BO    SPTST                   CONFINE TERMINATION TESTS        78480021
*                                      TO SECOND VECTOR ONLY            78540021
         TM    PTPOS,X'24'             EITHER POINT OFF SCREEN          78600021
         BZ    GRDTSTA                 NO, TEST FOR GRID TERMINATION    78660021
SCRTST   TM    PTSGSW,X'08'            TERMINATE IF SCREEN EXCEEDED     78720021
         BO    SCRNTERM                YES                              78780021
*                                                                       78840021
*                                      TO SECOND POINT ONLY             78900021
GRDTSTA  TM    BV21,X'FF'              INCREMENTAL POSITIONING          78960021
         BO    SPTST2                  YES, CONFINE TERMINATION TESTS   79020021
GRDTST   TM    PTSGSW,X'04'            TERMINATE IF GRID EXCEEDED       79080021
         BO    GRIDTERM                YES                              79140021
GRDTSTB  ST    PARLIST,SABL            STORE POINTER TO BOUNDARY        79200021
*                                                                       79260021
         MVC   PT1X(8),X               PREVIOUS POINT                   79320021
*                                                                       79380021
         LOAD  EP=GOFFSG               LOAD OFF SCREEN/OFF GRID ROUTINE 79440021
         LR    ENTREG,ACC              GET ADDRESS OF ENTRY POINT       79500021
         LA    PARLIST,SABL            POINTER TO PARAMETER LIST        79560021
         CALL  (15)                    CALL IT                          79620021
         DELETE EP=GOFFSG                                               79680021
*                                                                       79740021
         L     EVNACC,NI               GET NUMBER OF INTERSECTIONS      79800021
         CH    EVNACC,H1                                                79860021
         BE    ONEINTS                 ONE                              79920021
         BH    TWOINTS                 TWO                              79980021
         IC    EVNACC,MODE+1           ZERO- IS END POINT ON BOUNDARY   80040021
         EX    EVNACC,TSTPOS                                            80100021
         BC    7,SUPRESS               NO, SUPRESS PLOT                 80160021
ONEPLOTB MVC   ADJX1(2),PT2X+2         YES, POSITION BEAM               80220021
         MVC   ADJY1(2),PT2Y+2                                          80280021
         MVI   BV1,X'FF'               BLANK BEAM                       80340021
         B     ONEPLT                                                   80400021
*                                                                       80460021
ONEINTS  IC    EVNACC,MODE             FIRST POINT IN BOUNDARY          80520021
         EX    EVNACC,TSTPOS                                            80580021
         BZ    ONEPLOTS                YES                              80640021
         IC    EVNACC,MODE+1           NO. SECOND POINT IN BOUNDARY     80700021
         EX    EVNACC,TSTPOS                                            80760021
         BC    7,SUPRESS               NO, SUPPRESS PLOT                80820021
         MVC   ADJX1(4),INTS1X         POSITION TO INTERSECTION         80880021
         MVC   ADJX2(2),PT2X+2         DRAW TO SECOND POINT             80940021
         MVC   ADJY2(2),PT2Y+2                                          81000021
TWOPLT   MVI   PTCNT,X'FF'             TWO VECTORS                      81060021
         MVI   BV1,X'FF'               FIRST ONE BLANKED                81120021
         MVI   SUPLT,X'00'             ALLOW PLOT                       81180021
         B     GETOUT                                                   81240021
*                                                                       81300021
ONEPLOTS MVC   ADJX1(4),INTS1X         PLOT TO POINT OF INTERSECTION    81360021
         MVI   BV1,X'00'               UNBLANKED                        81420021
         TM    PTSGSW,X'02'            SCISSORING AT GRID               81480021
         BZ    RC44                    YES                              81540021
         B     RC48                    NO                               81600021
*                                                                       81660021
TWOINTS  MVC   ADJX1(8),INTS1X         PLOT FROM FIRST TO SECOND        81720021
         B     TWOPLT                  INTERSECTION POINTS              81780021
*                                                                       81840021
ONEPLOT  MVC   ADJX1(2),PT2X+2         MOVE INPUT DATA INTO             81900021
         MVC   ADJY1(2),PT2Y+2         OUTPUT LOCATION                  81960021
         MVI   BV1,X'00'               UNBLANKED                        82020021
ONEPLT   MVI   SUPLT,X'00'             PERMIT PLOT                      82080021
         MVI   PTCNT,X'0F'             OF ONE POINT                     82140021
GETOUT   L     SAVEREG,4(SAVEREG)      RETURN TO CALLING                82200021
         RETURN (14,12),RC=0           ROUTINE                          82260021
*                                                                       82320021
SPTST    TM    PTPOS,X'20'             SECOND POINT OFF SCREEN          82380021
         BO    SCRTST                  TEST FOR OFF SCREEN TERMINATION  82440021
SPTST2   TM    PTPOS,X'30'             SECOND POINT OFF GRID            82500021
         BO    GRDTST                  TEST FOR OFF GRID TERMINATION    82560021
         B     GRDTSTB                 NO, SCISSOR BUT DO NOT END       82620021
TSTPOS   TM    PTPOS,X'00'             TEST POINT POSITION SWITCH       82680021
*                                                                       82740021
GRIDTERM L     SAVEREG,4(SAVEREG)      IMMEDIATE TERMINATION IF GRID    82800021
         RETURN (14,12),RC=28          LIMITS EXCEEDED                  82860021
*                                                                       82920021
SCRNTERM L     SAVEREG,4(SAVEREG)      IMMEDIATE TERMINATION IF SCREEN  82980021
         RETURN (14,12),RC=32          LIMITS EXCEEDED                  83040021
*                                                                       83100021
RC44     CLC   RETCD(2),ZERO           IF NOT FIRST ERROR DETECTED,     83160021
         BE    RC44A                                                    83220021
         MVI   RETCD,X'80'             SET HIGH ORDER BIT OF RC         83280021
RC44A    MVI   RETCD+1,44              SET RETURN CODE IN WORKAREA=44   83340021
         B     ONEPLT                                                   83400021
*                                                                       83460021
RC48     CLC   RETCD(2),ZERO           IF NOT FIRST ERROR DETECTED      83520021
         BE    RC48A                                                    83580021
         MVI   RETCD,X'80'             SET HIGH-ORDER BIT OF RC         83640021
RC48A    MVI   RETCD+1,48              SET RETURN CODE IN WORKAREA=48   83700021
         B     ONEPLT                                                   83760021
PTPLTCHK MVC   ADJX1(2),NXTX+2         SET UP COORDINATES OF POINT      83820021
         MVC   ADJY1(2),NXTY+2                                          83880021
         TM    PTPOS,X'08'             POINT WITHIN GRID                83940021
         BO    ONEPLOT                 PLOT IT AS IS                    84000021
         TM    PTSGSW,X'04'            TERMINATE IF                     84060021
         BO    GRIDTERM                GRID LIMITS EXCEEDED             84120021
         TM    PTPOS,X'10'             POINT BETWEEN SCREEN AND GRID    84180021
         BZ    PTOFFSCR                NO- OFF SCREEN                   84240021
         TM    PTSGSW,X'02'            YES. PLOT ALL POINTS ON SCREEN   84300021
         BO    ONEPLOT                 YES.                             84360021
         B     SUPRESS                 NO. SUPPRESS PLOT                84420021
*                                                                       84480021
PTOFFSCR TM    PTSGSW,X'08'            TERMINATE IF SCREEN LIMITS       84540021
         BO    SCRNTERM                EXCEEDED                         84600021
SUPRESS  MVI   SUPLT,X'FF'             SUPRESS PLOT OF POINT            84660021
         MVI   PTCNT,X'00'             SET POINT COUNT =0               84720021
         MVI   ABSPTS,X'00'            SET ABSOLUTE POINT COUNT =0      84780021
         B     GETOUT                                                   84840021
*                                                                       84900021
*                                                                       84960021
*                                                                       85020021
ZERO     DC    H'0,0'                  SCREEN LIMITS- LOWER LEFT CORNER 85080021
         DC    H'4095,4095'              -UPPER RIGHT CORNER            85140021
H1       DC    H'1'                                                     85200021
H2       DC    H'2'                                                     85260021
H3       DC    H'3'                                                     85320021
H4       DC    H'4'                                                     85380021
H5       DC    H'5'                                                     85440021
HILIM    DC    H'255'                  MAXIMUM POSITIVE INCREMENT       85500021
LOWLIM   DC    H'-256'                 MAXIMUM NEGATIVE INCREMENT       85560021
GEPM     DC    X'2A00'                 SET MODE ABSOLUTE POINT          85620021
GEVM     DC    X'2A02'                 SET MODE ABSOLUTE VECTOR         85680021
GEPI2    DC    X'2A04'                 SET MODE INCREMENTAL POINT       85740021
GEVI2    DC    X'2A05'                 SET MODE INCREMENTAL VECTOR      85800021
         END                                                            85860021
./  ADD  SSI=20480193,NAME=IFFPLARE
*                                                                     * 00200021
*TITLE IFFPLARE                                                       * 00400021
*                                                                     * 00600021
*STATUS: CHANGE LEVEL 000                                             * 00800021
*                                                                     * 01000021
*FUNCTION/OPERATES: RELOCATES A BUFFER SUBROUTINE WHICH WILL TRACK THE* 01200021
*   LIGHT-PEN INTO THE USER'S GDOA(S).                                * 01400021
*                                                                     * 01600021
*ENTRY POINT: PENTRK                                                  * 01800021
*                                                                     * 02000021
*INPUT: AN OUTPUT CONTROL BLOCK POINTER (OCBP) POINTING TO AN OUTPUT  * 02200021
*   AREA CONTROL BLOCK (OACB) AND AN HUNDRED-WORD WORKAREA            * 02400021
*                                                                     * 02600021
*OUTPUT: THE RELOCATED BUFFER SUBROUTINE.                             * 02800021
*                                                                     * 03000021
*EXTERNAL ROUTINES: NONE                                              * 03200021
*                                                                     * 03400021
*EXITS-NORMAL: VIA RETURN MACRO WITH ZERO RETURN CODE ON SUCESSFUL    * 03600021
*   COMPLETION                                                        * 03800021
*              VIA BALR 14,15 TO USER'S OVERFLOW ROUTINE.             * 04000021
*EXITS-ERROR: VIA RETURN MACRO WITH RETURN CODE=28 IF OVERFLOW ROUTINE* 04200021
*   DOES NOT PROVIDE ENOUGH SPACE IN THE GDOA                         * 04400021
*                                                                     * 04600021
*TABLES/WORKAREAS: AN HUNDRED-WORD USER-SUPPLIED WORKAREA             * 04800021
*                                                                     * 05000021
*ATTRIBUTES: PROBLEM STATE, REENTRANT                                 * 05200021
*                                                                     * 05400021
*NOTES: RELOCATION FACTOR=BLP+(CRSA-OLP)-(RELATIVE ADDRESS OF FIRST   * 05600021
*   ORDER IN GDOA                                                     * 05800021
*                                                                     * 06000021
IFFPLARE CSECT                                                          06200021
*                                                                       06400021
*        SYMBOLIC REGISTER ASSIGNMENTS                                  06600021
*                                                                       06800021
PARLIST  EQU   1             PARAMETER LIST REGISTER                    07000021
WORKREG1 EQU   2             TEMPORARY                                  07200021
WORKREG2 EQU   3                       WORK                             07400021
WORKREG3 EQU   4                            REGISTERS                   07600021
MINREG   EQU   5             MINIMUM RELATIVE ADDRESS IN SEGMENT        07800021
MAXREG   EQU   6             MAXIMUM RELATIVE ADDRESS IN SEGMENT        08000021
RELOCREG EQU   7             RELOCATION FACTOR                          08200021
INDEX    EQU   8             RELATIVE ADDRESS OF CURRENT ORDER          08400021
OLPREG   EQU   9             POINTER TO NEXT AVAILABLE LOCATION IN GDOA 08600021
SEGTAB   EQU   10            ADDRESS OF SEGMENT TABLE OF RELOCATION     08800021
*                            CONSTANTS                                  09000021
SEGIND   EQU   11            POINTER TO NEXT USABLE LOCATION IN THE     09200021
*                            SEGMENT TABLE                              09400021
BASE     EQU   12                      BASE REGISTER                    09600021
SAVEREG  EQU   13            SAVE AREA REGISTER                         09800021
RETREG   EQU   14            RETURN REGISTER                            10000021
ENTREG   EQU   15            ENTRY REGISTER                             10200021
*                                                                       10400021
         ENTRY PENTRK                                                   10600021
PENTRK   SAVE  (14,12)            SAVE REGISTERS &                      10800021
         BALR  BASE,0             ESTABLISH ADDRESSABILITY              11000021
         USING *,BASE                                                   11200021
         L     WORKREG1,0(PARLIST)     SET ADDRESS OF WORK/SAVE AREA    11400021
         L     WORKREG1,4(WORKREG1)                                     11600021
         ST    WORKREG1,8(SAVEREG)                                      11800021
         ST    SAVEREG,4(WORKREG1)                                      12000021
         LR    SAVEREG,WORKREG1                                         12200021
*                                                                       12400021
*   CLEAR REGISTERS                                                     12600021
*                                                                       12800021
         SR    MINREG,MINREG                                            13000021
         LR    INDEX,MINREG                                             13200021
         LR    SEGIND,MINREG                                            13400021
         STH   SEGIND,394(SAVEREG)     CLEAR SWITCHES                   13600021
         XC    390(4,SAVEREG),390(SAVEREG)                              13800021
*                            CLEAR FORWARD REFERENCE CONSTANTS          14000021
*                                                                       14200021
*   DERIVE INITIAL RELOCATION FACTORS                                   14400021
*                                                                       14600021
          LA   SEGTAB,72(SAVEREG) GET ADDRESS OF RELOCATION TABLE       14800021
          L    WORKREG1,0(PARLIST) GET ADDRESS OF OACB                  15000021
         L     WORKREG1,0(WORKREG1)                                     15200021
         L     OLPREG,16(WORKREG1)     GET VALUE OF OLP                 15400021
          L    WORKREG2,0(WORKREG1)    GET START OF GDOA                15600021
          A    WORKREG2,4(WORKREG1)    GET END OF GDOA                  15800021
         SR    WORKREG2,OLPREG         GET NUMBER OF USABLE BYTES       16000021
         CH    WORKREG2,MINGDOA        SEE IF GDOA MEETS INITIAL SIZE   16200021
         BL    OVERFLOW                REQUIREMENTS.  NO, OVERFLOW.     16400021
          SH   WORKREG2,H4                                              16600021
         LR    MAXREG,WORKREG2         MAX REL. ADDRESS IN SEGMENT      16800021
         LR    RELOCREG,OLPREG         GET DISPLACEMENT OF OLP          17000021
         S     RELOCREG,12(WORKREG1)   FROM CRSA                        17200021
         A     RELOCREG,20(WORKREG1)   ADD BLP TO GET RELOCATION        17400021
*                                      FACTOR                           17600021
*                                                                       17800021
*   RELOCATION CHECKS                                                   18000021
*                                                                       18200021
RELOCLP  LA    WORKREG1,ROUTINE(INDEX) GET ADDRESS OF LOCATION TO BE    18400021
*                                      EXAMINED                         18600021
         CLI   0(WORKREG1),X'2A'       IF AN ORDER,                     18800021
         BE    ORDER                   EXAMINE IT FURTHER               19000021
         MVI   394(SAVEREG),X'FF'      MAKE SURE DATA MODE SWITCH SET   19200021
MOVE     MVC   0(2,OLPREG),0(WORKREG1)                                  19400021
MOVEA    LA    OLPREG,2(OLPREG)        INCREMENT                        19600021
         LA    INDEX,2(INDEX)                   INDICES                 19800021
ENDTEST  CH    INDEX,RTNSIZE           ROUTINE COMPLETELY RELOCATED     20000021
         BNL   DEPART                  YES, EXIT                        20200021
         MVI   395(SAVEREG),X'00'      CLEAR OVERFLOW SWITCH            20400021
         CH    INDEX,392(SAVEREG)      WAS LAST ORDER PROCESSED THE     20600021
         BNH   OVTST                   LAST COVERED BY AN OUTSTANDING   20800021
*                                      FORWARD REFERENCE                21000021
         XC    390(4,SAVEREG),390(SAVEREG)       YES, ZERO OUT          21200021
*                                      FORWARD REFERENCE CONSTANTS      21400021
OVTST    CR    INDEX,MAXREG            IS GDOA FILLED                   21600021
         BNL   OVERFLOW                YES, OVERFLOW                    21800021
         B     RELOCLP                 NO, CONTINUE PROCESSING          22000021
DEPART   LTR   SEGIND,SEGIND           SEGMENT TABLE EMPTY              22200021
         BZ    STENT                   STORE CURRENT RELOCATION         22400021
*                                      FACTOR AS FIRST ADDRESS OF       22600021
*                                      BUFFER SUBROUTINE                22800021
         L     RELOCREG,8(SEGTAB)      GET RELOCATION FACTOR FOR        23000021
*                                      FIRST SEGMENT                    23200021
STENT    ST    RELOCREG,396(SAVEREG)   SAVE ADDRESS OF ENTRY POINT      23400021
*                                      OF RELOCATED SUBROUTINE          23600021
         L     WORKREG1,0(PARLIST)     STORE UPDATED VALUE OF OLP       23800021
         L     WORKREG1,0(WORKREG1)                                     24000021
         ST    OLPREG,16(WORKREG1)     IN OACB                          24200021
         L     SAVEREG,4(SAVEREG)      POINTER TO USER'S SAVE AREA      24400021
         RETURN (14,12),RC=0                                            24600021
ORDER    MVC   0(2,OLPREG),0(WORKREG1) STORE FIRST HALF WORD OF         24800021
         XC    394(1,SAVEREG),394(SAVEREG)  CLEAR DATA MODE SWITCH      25000021
         TM    1(WORKREG1),X'C0'       IF TWO BYTE ORDER,               25200021
         BC    12,TWOBYTE              PROCESS APPROPRIATELY            25400021
*                                      ORDER IN GDOA                    25600021
         CLI   1(WORKREG1),X'EC'       IF                               25800021
         BE    GMVD                       6-BYTE ORDER,                 26000021
         BAL   RETREG,RELOC            RELOCATE ADDRESS CONSTANT        26200021
         STH   WORKREG2,2(OLPREG)      AND STORE IT                     26400021
         MVC   396(2,SAVEREG),0(OLPREG)     SAVE FIRST TWO BYTES OF     26600021
*                                      ORDER                            26800021
         LA    OLPREG,4(OLPREG)        INCREMENT                        27000021
         LA    INDEX,4(INDEX)                    INDICES                27200021
         B     ENDTEST                 AND TEST FOR END OF LOOP         27400021
*                                                                       27600021
GMVD     BAL   RETREG,RELOC      GMVD--RELOCATE 2ND HALF-WORD,          27800021
         STH   WORKREG2,2(OLPREG)      STORE IN GDOA                    28000021
         MVC   4(2,OLPREG),4(WORKREG1) MOVE IN 3RD                      28200021
         MVC   396(2,SAVEREG),0(OLPREG)     SAVE FIRST TWO BYTES OF     28400021
*                                      ORDER                            28600021
*                                                                       28800021
UP6      LA    OLPREG,6(OLPREG)        INCREMENT                        29000021
         LA    INDEX,6(INDEX)                    INDICES                29200021
         B     ENDTEST                 TEST FOR END OF LOOP             29400021
*                                                                       29600021
TWOBYTE  MVC   396(2,SAVEREG),0(OLPREG)     SAVE FIRST TWO BYTES OF     29800021
*                                      ORDER                            30000021
         B     MOVEA                                                    30200021
*                                                                       30400021
RELOC    CLI   1(WORKREG1),X'EC'                       SIX BYTES        30600021
         BE    SIXBYTE                                           LONG   30800021
         LA  WORKREG2,4(INDEX)         NO--ONLY FOUR BYTES              31000021
LIMCHECK CR  WORKREG2,MAXREG           IF ORDER NOT OVERFLOWS SEGMENT,  31200021
         BH  OVERFLOW                  DO NOT RELOCATE                  31400021
*                                                                       31600021
REFCHECK LH  WORKREG2,2(WORKREG1)      GET CONSTANT TO RELOCATE         31800021
         CR  WORKREG2,MINREG           SEE IF BACK REFERENCE            32000021
         BL  BACKREF                   YES, PROCESS IT                  32200021
         CR  WORKREG2,MAXREG           SEE IF FORWARD REF. ACROSS       32400021
*                                      SEGMENT BOUNDARY                 32600021
         BH    OVERLAP       CHECK FOR OVERLAPPING FORWARD REFS.        32800021
         BE    CONCHK                  MAXIMUM FORWARD REFERENCE        33000021
*                                      ASSUME FOUR BYTE ORDER WILL      33200021
*                                      FOLLOW AND WILL FIT              33400021
ORCHK    LA    WORKREG3,ROUTINE(WORKREG2)                               33600021
         CLI   0(WORKREG3),X'2A'       SEE IF ADDRESS THAT OF ORDER     33800021
         BE    LIMCHK2                 YES, CONTINUE PROCESSING         34000021
         LA    WORKREG3,2(WORKREG2)    NO, SEE IF HALF WORD FITS        34200021
         B     LIMCHK2A                IN GDOA                          34400021
LIMCHK2  CLI   1(WORKREG3),X'EC'                      ORDER             34600021
         BE    SIX2                                                     34800021
         LA    WORKREG3,4(WORKREG2)    NO                               35000021
LIMCHK2A CR    WORKREG3,MAXREG         IF ORDER DOES NOT FIT WITHIN     35200021
         BH    OVERLAP       CHECK FRO OVERLAPPING FORWARD REFS.        35400021
CONCHK   CH    WORKREG2,392(SAVEREG)   STORE NEW FORWARD REFERENCE      35600021
         BNH   ADD           CONSTANTS IF REFERENCED ADDRESS EXCEEDS    35800021
         STH   WORKREG2,392(SAVEREG)   THAT OF LAST REFERENCE           36000021
         STH   INDEX,390(SAVEREG)                                       36200021
ADD      AR    WORKREG2,RELOCREG       ADD RELOCATION FACTOR            36400021
         BR    RETREG                                                   36600021
SIX2     LA    WORKREG3,6(WORKREG2)    SIX BYTE ORDER                   36800021
         B     LIMCHK2A                                                 37000021
SIXBYTE  LA  WORKREG2,6(INDEX)         SIX BYTE ORDER                   37200021
         B   LIMCHECK                                                   37400021
OVERLAP  CH    INDEX,392(SAVEREG)      LAST FORWARD REFERENCE GOES      37600021
*                                      BEYOND CURRENT LOCATION          37800021
         BH    OVERFLOW                NO, OVERFLOW                     38000021
         SH    INDEX,390(SAVEREG)      YES, BACK UP DATA POINTER        38200021
         SR    OLPREG,INDEX            AND OLP                          38400021
         LH    INDEX,390(SAVEREG)                                       38600021
         B     OVERFLOW                AND OVERFLOW                     38800021
BACKREF  SR    WORKREG3,WORKREG3            SEARCH SEGMENT TABLE        39000021
SEGCHK   C     WORKREG2,4(SEGTAB,WORKREG3)   ADDRESS CONTAINED IN       39200021
         BNL   NXTSEG                     SEGMENT                       39400021
         A     WORKREG2,8(SEGTAB,WORKREG3)   YES, RELOCATE              39600021
         BR    RETREG                                                   39800021
NXTSEG   LA    WORKREG3,12(WORKREG3)        NO, INCREMENT TO NEXT       40000021
         B     SEGCHK                       SEGMENT                     40200021
*                                                                       40400021
OVERFLOW LR    MAXREG,INDEX            GET ADDRESS OF NEXT HALF-WORD    40600021
         CR    MINREG,MAXREG           IF NO DATA STORED IN GDOA,       40800021
         BE    OVERCALL                SKIP STORAGE OF RELOCATION       41000021
*                                      CONSTANTS                        41200021
         LA    WORKREG1,0(SEGTAB,SEGIND)    GET ADDRESS OF NEXT         41400021
*                                           RELOCATION TABLE ENTRY      41600021
         STM   MINREG,RELOCREG,0(WORKREG1)  STORE RELOCATION CONSTANTS  41800021
         LA    SEGIND,12(SEGIND)                                        42000021
OVERCALL TM    395(SAVEREG),X'FF'      IS OVERFLOW SWITCH ON            42200021
         BO    ERRTRN                  YES, NOT ABLE TO STORE DATA      42400021
*                                      AFTER OVERFLOW                   42600021
         XC    390(4,SAVEREG),390(SAVEREG)       SET FORWARD REFERENCE  42800021
*                            CONSTANTS EQUAL TO 0                       43000021
         MVI   395(SAVEREG),X'FF'      SET OVERFLOW SWITCH              43200021
         CLI   397(SAVEREG),X'05'      SEE IF CURRENT ORDER             43400021
*                                      GEPI2 OR GEVI2                   43600021
         BH    CALLSVA                 NO, SET SWITCH OFF               43800021
         MVI   394(SAVEREG),X'FF'      YES, SET DATA MODE SWITCH        44000021
         B     CALLSV                                                   44200021
CALLSVA  MVI   394(SAVEREG),0                                           44400021
CALLSV   L     WORKREG1,0(PARLIST)     GET ADDRESS OF /CBP              44600021
         L     WORKREG1,0(WORKREG1)    GET ADDRESS OF OACB              44800021
         SAVE  (14,12)                 SAVE REGISTERS                   45000021
         L     ENTREG,8(WORKREG1)                     OVERFLOW ROUTINE  45200021
         ST    OLPREG,16(WORKREG1)     STORE UPDATED VALUE OF OLP       45400021
*                                      IN OACB                          45600021
         LR    PARLIST,SAVEREG         SET UP POINTERS TO SAVE AREAS    45800021
         L     SAVEREG,4(PARLIST)                                       46000021
         BALR  RETREG,ENTREG           BRANCH TO USER'S OVERFLOW RTN.   46200021
         LR    SAVEREG,PARLIST         RESTORE REGISTERS                46400021
         LM    14,12,12(SAVEREG)                                        46600021
         LR    MINREG,INDEX            DERIVE NEW RELOCATION CONSTANTS  46800021
         L     OLPREG,16(WORKREG1)                                      47000021
         L     RELOCREG,0(WORKREG1)    GET NUMBER OF AVAILABLE          47200021
         A     RELOCREG,4(WORKREG1)        BYTES                        47400021
         SR    RELOCREG,OLPREG                   IN GDOA                47600021
         CH    RELOCREG,MINOVER        IF LESS THAN 180 BYTES SUPPLIED  47800021
         BL    ERRTRN                  OVERFLOW ROUTINE, ERROR RETURN.  48000021
         AR    MAXREG,RELOCREG         GET MAX REL. ADDR. IN SEGMENT    48200021
         SH    MAXREG,H4                                                48400021
         LR    RELOCREG,OLPREG         GET DISPLACEMENT OF OLP          48600021
         S     RELOCREG,12(WORKREG1)   FROM CRSA                        48800021
         A     RELOCREG,20(WORKREG1)   GET RELOCATION FACTOR            49000021
         SR    RELOCREG,INDEX          CORRECT TO POSITION IN ROUTINE   49200021
         CLI   394(SAVEREG),X'FF'      CURRENT MODE A DATA MODE         49400021
         BE    SWOFF                   YES, CONTINUE                    49600021
         SH    OLPREG,H2               NO, DECREMENT OLP & RELOCATION   49800021
         SH    RELOCREG,H2             FACTOR BY 2                      50000021
         LA    MAXREG,2(MAXREG)        INCREMENT MAX ADDRESS BY 2       50200021
SWOFF    MVI   394(SAVEREG),0          SET SWITCH OFF                   50400021
         B     RELOCLP                                                  50600021
ERRTRN   L     SAVEREG,4(SAVEREG)                                       50800021
         RETURN (14,12),RC=24                                           51000021
*                                                                       51200021
*                                                                       51400021
H2       DC    H'2'                                                     51600021
H4       DC    H'4'                                                     51800021
MINGDOA  DC    H'8'                    MINIMUM GDOA UPON INITIAL ENTRY  52000021
MINOVER  DC    H'178'                  MINIMUM AVAILABLE GDOA AFTER     52200021
*                                      OVERFLOW                         52400021
RTNSIZE  DC    H'314'                  SIZE OF BUFFER SUBROUTINE        52600021
*                                                                       52800021
*   GRAPHIC SUBROUTINE -- LIGHT-PEN TRACKING                            53000021
*                                                                       53200021
         GINIT  BPX=500,BPY=500,BLC=0,BLP=0                             53400021
ROUTINE  GTRU  0                                                        53600021
         GTRU  INIT                                                     53800021
UPD      GEPI2                                                          54000021
DX       GDV   0,0,B                   UPDATING VECTORS                 54200021
DY       GDV   0,0,U                                                    54400021
UPTST    GTDD  ROUTINE                 EXIT IF CENTER POINT SEEN        54600021
         GMVD  UPTST,BDATA=2AFF                                         54800021
         GTRU  INIT2                                                    55000021
INIT     GDRD                                                           55200021
         GENSD                                                          55400021
         GMVD  UPTST,BDATA=2AFC                                         55600021
INIT2    GMVD  DX,BDATA=0101           INITIALIZE UPDATE VECTORS        55800021
         GMVD  DY,BDATA=0100                                            56000021
         GEPI2                                                          56200021
         GDV   0,0,U                                                    56400021
         GTND  BOX1                                                     56600021
SB       GEVI2                                                          56800021
         GDV   -36,-36,B                                                57000021
         GDV   72,0,U                                                   57200021
         GTND  *+8                                                      57400021
         GMVD  DY,BDATA=01FE                                            57600021
         GEVI2                                                          57800021
         GDV   0,72,U                                                   58000021
         GTND  *+8                                                      58200021
         GMVD  DX,BDATA=0301                                            58400021
         GEVI2                                                          58600021
         GDV   -72,0,U                                                  58800021
         GTND  *+8                                                      59000021
         GMVD  DY,BDATA=0102                                            59200021
         GEVI2                                                          59400021
         GDV   0,-72,U                                                  59600021
         GDV   36,36,B                                                  59800021
         GTND  BOX2                                                     60000021
         GMVD  DX,BDATA=FF01                                            60200021
         GTRU  BOX2                                                     60400021
BOX1     GEVI2                                                          60600021
         GDV   -36,-36,B                                                60800021
         GDV   72,0,U                                                   61000021
         GTND  *+8                                                      61200021
         GMVD  DY,BDATA=01EE                                            61400021
         GEVI2                                                          61600021
         GDV   0,72,U                                                   61800021
         GTND  *+8                                                      62000021
         GMVD  DX,BDATA=1301                                            62200021
         GEVI2                                                          62400021
         GDV   -72,0,U                                                  62600021
         GTND  *+8                                                      62800021
         GMVD  DY,BDATA=0112                                            63000021
         GEVI2                                                          63200021
         GDV   0,-72,U                                                  63400021
         GDV   36,36,B                                                  63600021
         GTND  *+8                                                      63800021
         GMVD  DX,BDATA=EF01                                            64000021
BOX2     GEVI2                                                          64200021
         GDV   -72,-72,B                                                64400021
         GDV   72,0,U                                                   64600021
         GDV   72,0,U                                                   64800021
         GTND  *+8                                                      65000021
         GMVD  DY,BDATA=01D4                                            65200021
         GEVI2                                                          65400021
         GDV   0,72,U                                                   65600021
         GDV   0,72,U                                                   65800021
         GTND  *+8                                                      66000021
         GMVD  DX,BDATA=2D01                                            66200021
         GEVI2                                                          66400021
         GDV   -72,0,U                                                  66600021
         GDV   -72,0,U                                                  66800021
         GTND  *+8                                                      67000021
         GMVD  DY,BDATA=012C                                            67200021
         GEVI2                                                          67400021
         GDV   0,-72,U                                                  67600021
         GDV   0,-72,U                                                  67800021
         GDV   72,72,B                                                  68000021
         GTND  BOX3                                                     68200021
         GMVD  DX,BDATA=D501                                            68400021
BOX3     GEVI2                                                          68600021
         GDV   -108,-108,B                                              68800021
         GDV   216,0,U                                                  69000021
         GTND  *+8                                                      69200021
         GMVD  DY,BDATA=01B4                                            69400021
         GEVI2                                                          69600021
         GDV   0,216,U                                                  69800021
         GTND  *+8                                                      70000021
         GMVD  DX,BDATA=4D01                                            70200021
         GEVI2                                                          70400021
         GDV   -216,0,U                                                 70600021
         GTND  *+8                                                      70800021
         GMVD  DY,BDATA=014C                                            71000021
         GEVI2                                                          71200021
         GDV   0,-216,U                                                 71400021
         GDV   108,108,B                                                71600021
         GTND  UPD                                                      71800021
         GMVD  DX,BDATA=B501                                            72000021
         GTRU  UPD                                                      72200021
*                                                                       72400021
         END                                                            72600021
./  ADD  SSI=20480480,NAME=IFFPPASG
         TITLE 'OFF SCREEN-GRID ROUTINE'                                00020021
*STATUS. CHANGE LEVEL 0                                               * 00040021
*                                                                     * 00060021
*FUNCTION/OPERATION. GOFFSG ROUTINE COMPUTES THE INTERSECTION POINT   * 00080021
*   COORDINATES OF A VECTOR WITH THE USER-DESIRED DISPLAY BOUNDARY    * 00100021
*                                                                     * 00120021
*ENTRY POINTS. GOFFSG VIA CALL OR LINK MACRO   ALIAS NAME IFFPPASG    * 00140021
*                                                                     * 00160021
*INPUT. STARTING ADDRESS OF BOUNDARY LIMITS USED AND THE COORDINATES  * 00180021
*   OF THE START AND END POINTS OF THE VECTOR THAT INTERSECTS THE     * 00200021
*   BOUNDARY                                                          * 00220021
*                                                                     * 00240021
*OUTPUT. THE NUMBER OF INTERSECTION POINT(S) FOUND AND ITS COORDINATES* 00260021
*                                                                     * 00280021
*EXTERNAL ROUTINES. N/A                                               * 00300021
*                                                                     * 00320021
*EXIT. COMPLETION OF TASK EXIT VIA RETURN MACRO                       * 00340021
*                                                                     * 00360021
*TABLES/WORK AREAS. POR PROVIDES A PARAMETER TABLE(PARTAB) WHICH      * 00380021
*   CONTAINS THE ABOVE MENTIONED INPUT INFORMATION,GOFFSG OUTPUT      * 00400021
*   RESPONSE AREA,AND SCRATCH AREA.                                   * 00420021
*                                                                     * 00440021
*ATTRIBUTES. READ ONLY,REENTRANT                                      * 00460021
*                                                                     * 00480021
OFFSG    CSECT                                                          00500021
GOFFSG   SAVE  (14,12),T,*              SAVE REGISTERS                  00520021
         BALR  9,0                                                      00540021
         USING *,9                                                      00560021
         L     SABREG,0(PATREG)         GET START ADDR OF BOUNDARY      00580021
        USING  LIMITB,SABREG                                            00600021
         USING PARTAB,PATREG                                            00620021
*                                                                       00640021
*   CALCULATE POINTS OF INTERSECTIONS                                   00660021
CALCUL   L     DTXREG,X2                COMPUTE DX                      00680021
         S     DTXREG,X1                                                00700021
         C     DTXREG,ZERO              IS ?X=O                         00720021
         BNE   DELTAY                   IF NOT GO TO TEST ?Y            00740021
         MVC   X3,X1                    OTHERWISE SET PT3=X1,YL         00760021
         LH    WRKREG,YL                                                00780021
         ST    WRKREG,Y3                                                00800021
         MVC   X4,X1                              SET PT4=X1,YH         00820021
         LH    WRKREG,YH                                                00840021
         ST    WRKREG,Y4                                                00860021
         B     SETNI2                   GO TO SET NI VALUE TO 2         00880021
DELTAY   L     DTYREG,Y2                COMPARE ?Y OI PT1 AND PT2       00900021
         S     DTYREG,Y1                                                00920021
         C     DTYREG,ZERO              IS ?=O                          00940021
         BNE   SETNI4                   IF NOT GO TO SET NI=4           00960021
         LH    WRKREG,XL                OTHERWISE SET PT3=XL,Y1         00980021
         ST    WRKREG,X3                                                01000021
         MVC   Y3,Y1                                                    01020021
         LH    WRKREG,XH                AND SET PT4=XH,Y1               01040021
         ST    WRKREG,X4                                                01060021
         MVC   Y4,Y1                                                    01080021
SETNI2   MVC   NI,TWO                   SET NI=2                        01100021
         B     ELIMIN                   BRANCH TO ELIMINATE OUTSIDE PTS 01120021
SETNI4   MVC   NI,FOUR                  SET NI=4                        01140021
         L     BEEREG,Y1                COMPUTE: B=Y1-MX1               01160021
         LR    MDVREG,DTYREG                                            01180021
         SRDA  MDVREG,32                                                01200021
         M     MDVREG,X1                 WHERE MX1=X1*DY/DX             01220021
         DR    MDVREG,DTXREG                                            01240021
         SR    BEEREG,PDQREG            Y1-MX1                          01260021
         LH    WRKREG,XL                                                01280021
         C     WRKREG,X1                COMPARE XL TO X1                01300021
         BE    SETPT3A                  IF EQUAL GO TO SET PT3=PT1      01320021
         C     WRKREG,X2                                                01340021
         BE    SETPT3B                  IF EQUAL GO TO SET PT3=PT2      01360021
         ST    WRKREG,X3                                                01380021
         LR    MDVREG,DTYREG            Y3=MX2+B                        01400021
         SRDA  MDVREG,32                                                01420021
         MR    MDVREG,WRKREG             WHERE MX2=X1*DY/DX             01440021
         DR    MDVREG,DTXREG                                            01460021
         AR    PDQREG,BEEREG            PLUS B TO MX2                   01480021
         ST    PDQREG,Y3                SAVE COMPUTED PT3 Y COODINATE   01500021
CKPT4    LH    WRKREG,XH                CHECK IF X1 OR X2=XH            01520021
         C     WRKREG,X1                                                01540021
         BE    SETPT4A                  IF X1=XH GO TO SET PT4=PT1      01560021
         C     WRKREG,X2                                                01580021
         BE    SETPT4B                  IF X2=XH GO TO SET PT4=PT2      01600021
         ST    WRKREG,X4                OTHERWISE X4=XH                 01620021
         LR    MDVREG,DTYREG             Y4=MXH+B                       01640021
         SRDA  MDVREG,32                                                01660021
         MR    MDVREG,WRKREG                                            01680021
         DR    MDVREG,DTXREG                                            01700021
         AR    PDQREG,BEEREG                                            01720021
         ST    PDQREG,Y4                                                01740021
CKPT5    LH    WRKREG,YL                CHECK IF Y1 OR Y2=YL            01760021
         C     WRKREG,Y1                                                01780021
         BE    SETPT5A                  IF Y1=YL GO TO SET PT5=PT1      01800021
         C     WRKREG,Y2                                                01820021
         BE    SETPT5B                  IF Y2=YL GO TO SET PT5=PT2      01840021
         ST    WRKREG,Y5                OTHERWISE Y5=YL                 01860021
         SR    WRKREG,BEEREG            X5=(YL-B)/M OR (YL-B)*DX/DY     01880021
         LR    MDVREG,DTXREG                                            01900021
         SRDA  MDVREG,32                                                01920021
         MR    MDVREG,WRKREG                                            01940021
         DR    MDVREG,DTYREG                                            01960021
         ST    PDQREG,X5                                                01980021
CKPT6    LH    WRKREG,YH                CHECK IF Y1 OR Y2=YH            02000021
         C     WRKREG,Y1                                                02020021
         BE    SETPT6A                  IF Y1=YH GO TO SET PT6=PT1      02040021
         C     WRKREG,Y2                                                02060021
         BE    SETPT6B                  IF Y2=YH GO TO SET PT6=PT2      02080021
         ST    WRKREG,Y6                OTHERWISE Y6=YH                 02100021
          SR   WRKREG,BEEREG            X6=(YH-B)/M OR(YH-B)*DX/DY      02120021
         LR    MDVREG,DTXREG            WHERE M IS EQUAL TO DY/DX       02140021
         SRDA  MDVREG,32                                                02160021
         MR    MDVREG,WRKREG                                            02180021
         DR    MDVREG,DTYREG                                            02200021
         ST    PDQREG,X6                SAVE COMPUTED X6                02220021
         B     ELIMIN                   BRANCH TO ELIMATION SUBRT       02240021
SETPT3A  MVC   PT3,PT1                  SET PT3=PT1                     02260021
         B     CKPT4                                                    02280021
SETPT3B  MVC   PT3,PT2                  SET PT3=PT2                     02300021
         B     CKPT4                                                    02320021
SETPT4A  MVC   PT4,PT1                  SET PT4=PT1                     02340021
         B     CKPT5                                                    02360021
SETPT4B  MVC   PT4,PT2                  SET PT4=PT2                     02380021
         B     CKPT5                                                    02400021
SETPT5A  MVC   PT5,PT1                  SET PT5=PT1                     02420021
         B     CKPT6                                                    02440021
SETPT5B  MVC   PT5,PT2                  SET PT5=PT2                     02460021
         B     CKPT6                                                    02480021
SETPT6A  MVC   PT6,PT1                  SET PT6=PT1                     02500021
         B     ELIMIN                                                   02520021
SETPT6B  MVC   PT6,PT2                  SET PT6=PT2                     02540021
*   ELIMINATE PTS OUSIDE BOUNDARY AND/OR LINE LIMITS SUBROUTINE         02560021
*                                                                       02580021
ELIMIN   L     ICTREG,ONE               LOAD ONE TO I COUNT             02600021
         SR    INXREG,INXREG            CLEAR INDEX REGISTER            02620021
         SR    OUTREG,OUTREG            LOAD ZERO TO ZERO COUNT         02640021
         SR    POSREG,POSREG            CLEAR POSITION REGISTER         02660021
         L     WRKREG,X1                LOAD X1                         02680021
         C     WRKREG,X2                COMPARE X1 TO X2                02700021
         BH    REVERSE                   AND SET XR=MIN(X1,X2)          02720021
         MVC   XR,X1                             XS=MAX(X1,X2)          02740021
         MVC   XS,X2                                                    02760021
         B     SETYSR                                                   02780021
REVERSE  MVC   XR,X2                                                    02800021
         MVC   XS,X1                                                    02820021
SETYSR   L     WRKREG,Y1                LOAD Y1                         02840021
         C     WRKREG,Y2                COMPARE Y1 TO Y2                02860021
         BH    REVERSEY                  AND SET YR=MIN(Y1,Y2)          02880021
         MVC   YR,Y1                             YS=MAX(Y1,Y2)          02900021
         MVC   YS,Y2                                                    02920021
         B     TSLINE                                                   02940021
REVERSEY MVC   YS,Y1                                                    02960021
         MVC   YR,Y2                                                    02980021
TSLINE   L     XIWREG,X3(INXREG)        GET COMPUTED PTS                03000021
         LH    WRKREG,XL                                                03020021
         CR    XIWREG,WRKREG            CHECK IF PT OUTSIDE LEFT LIMIT  03040021
         BL    SQEEZE                   IF YES TO SQEEZE                03060021
         C     XIWREG,XR                COMPARE WITH LINE RANGE         03080021
         BL    SQEEZE                   MASK IT IF NOT IN RANGE         03100021
         LH    WRKREG,XH                                                03120021
         CR    XIWREG,WRKREG            COMPARE THE PT WITH BOUNDARY    03140021
         BH    SQEEZE                   MASK IT IF OUTSIDE BOUNDARY     03160021
         C     XIWREG,XS                CHECK IF OUTSIDE LINE RANGE     03180021
         BH    SQEEZE                    IF YES GO TO SQEEZE            03200021
         L     YIWREG,Y3(INXREG)                                        03220021
         LH    WRKREG,YL                                                03240021
         CR    YIWREG,WRKREG            IS THE PT OUTSIDE LINE          03260021
         BL    SQEEZE                                                   03280021
         C     YIWREG,YR                IS YI.YR                        03300021
         BL    SQEEZE                                                   03320021
         LH    WRKREG,YH                                                03340021
         CR    YIWREG,WRKREG            IS THE PT OUTSIDE BOUNDARY      03360021
         BH    SQEEZE                                                   03380021
         C     YIWREG,YS                IS YI>YS                        03400021
         BH    SQEEZE                                                   03420021
         C     XIWREG,X1                IS THIS PT SAME AS P1           03440021
         BNE   P2TEST                   IF NOT COMPARE TO P2            03460021
         C     YIWREG,Y1                IS Y COORDINATE ALSO EQUAL Y1   03480021
         BE    SQEEZE                   IDENTICAL TO PT1 ELIMINATE IT   03500021
P2TEST   C     XIWREG,X2                X COORDINATE SAME AS PT2        03520021
         BNE   BUILDUP                  IF NOT GO TO BUILD UP INTS      03540021
         C     YIWREG,Y2                COMPARE Y COOR                  03560021
         BE    SQEEZE                   IF ALSO EUQAL GO TO ELIMINATE   03580021
BUILDUP  STH   XIWREG,INTS1(POSREG)     BUILD UP INTERSECTIONS          03600021
         STH   YIWREG,INTS1+2(POSREG)                                   03620021
         A     POSREG,FOUR              INDEXING BY FOUR                03640021
         B     UPDATEI                                                  03660021
SQEEZE   A     OUTREG,ONE               ADD ONE TO OUT COUNT            03680021
UPDATEI  A     ICTREG,ONE               I=I+1                           03700021
         C     ICTREG,NI                IS I>NI                         03720021
         BH    FINALNI                   IF YES GO TO COMPUTE FINAL NI  03740021
         A     INXREG,EIGHT              OTHERWISE INDEX AND CHECK NEXT 03760021
         B     TSLINE                                                   03780021
FINALNI  L     WRKREG,NI                NI=NI-OUT                       03800021
         SR    WRKREG,OUTREG                                            03820021
         ST    WRKREG,NI                                                03840021
ANALYNI  CLC   NI(4),TWO                IS NI=2                         03860021
         BH    ELIMDUP                   IF YES ELIMINATE DUPLICATE     03880021
         BE    TWOPTS                                                   03900021
         B     RET                                                      03920021
TWOPTS   CLC   INTS1,INTS2              CHECK IF TWO PTS ARE SAME       03940021
         BE    ELIMONE                  GO TO ELIMINATE A DUPLICATE     03960021
         B     RET                     OTHERWISE RETURN                 03980021
ELIMONE  MVC   NI,ONE                   SET NI=1                        04000021
RET      RETURN (14,12),T,RC=(15)                                       04020021
*                                                                       04040021
*   SUBROUTINE FOR ELIMINATING DUPLICATE POINTS                         04060021
*                                                                       04080021
ELIMDUP  CLC   INTS1,INTS2                                              04100021
         BE    TAKE23                   IF THESE TWO PT EQUAL TAKE 2&3  04120021
SETNI    MVC   NI,TWO                                                   04140021
         B     RET                      GO TO RETURN                    04160021
TAKE23   MVC   INTS1(8),INTS2           TAKE INTS2&3                    04180021
         B     SETNI                    BRANCH TO RESET NI              04200021
ZERO     DC    F'0'                     CONSTANT ZERO                   04220021
ONE      DC    F'1'                     CONSTANT ONE                    04240021
TWO      DC    F'2'                     CONSTANT TWO                    04260021
FOUR     DC    F'4'                                                     04280021
EIGHT    DC    F'8'                     CONSTANT EIGHT                  04300021
PARTAB   DSECT                                                          04320021
SABL     DS    CL4                                                      04340021
PT1      DS    CL8                                                      04360021
         ORG   PT1                                                      04380021
X1       DS    CL4                                                      04400021
Y1       DS    CL4                                                      04420021
PT2      DS    CL8                                                      04440021
         ORG   PT2                                                      04460021
X2       DS    CL4                                                      04480021
Y2       DS    CL4                                                      04500021
NI       DS    CL4                                                      04520021
INTS1    DS    CL4                                                      04540021
INTS2    DS    CL4                                                      04560021
INTS3    DS    CL4                                                      04580021
INTS4    DS    CL4                                                      04600021
PT3      DS    CL8                                                      04620021
         ORG   PT3                                                      04640021
X3       DS    CL4                                                      04660021
Y3       DS    CL4                                                      04680021
PT4      DS    CL8                                                      04700021
         ORG   PT4                                                      04720021
X4       DS    CL4                                                      04740021
Y4       DS    CL4                                                      04760021
PT5      DS    CL8                                                      04780021
         ORG   PT5                                                      04800021
X5       DS    CL4                                                      04820021
Y5       DS    CL4                                                      04840021
PT6      DS    CL8                                                      04860021
         ORG   PT6                                                      04880021
X6       DS    CL4                                                      04900021
Y6       DS    CL4                                                      04920021
XR       DS    CL4                                                      04940021
XS       DS    CL4                                                      04960021
YR       DS    CL4                                                      04980021
YS       DS    CL4                                                      05000021
LIMITB   DSECT                                                          05020021
XL       DS    CL2                                                      05040021
YL       DS    CL2                                                      05060021
XH       DS    CL2                                                      05080021
YH       DS    CL2                                                      05100021
PATREG   EQU   1                                                        05120021
DTXREG   EQU   2                                                        05140021
DTYREG   EQU   3                                                        05160021
XIWREG   EQU   2                                                        05180021
YIWREG   EQU   3                                                        05200021
WRKREG   EQU   4                                                        05220021
BEEREG   EQU   5                                                        05240021
INXREG   EQU   5                                                        05260021
MDVREG   EQU   6                                                        05280021
PDQREG   EQU   7                                                        05300021
OUTREG   EQU   6                                                        05320021
ICTREG   EQU   7                                                        05340021
PTAREG   EQU   6                                                        05360021
PTBREG   EQU   7                                                        05380021
POSREG   EQU   8                                                        05400021
SABREG   EQU   10                                                       05420021
LINREG   EQU   11                                                       05440021
         END                                                            05460021
./  ADD  SSI=81430160,NAME=IGC0007A
         TITLE 'GLOBLOCK FOR SET/FREE OF LOCAL/UCBLOCKS'    D11 ZA07645 00050001
         MACRO                                              D11 ZA07645 00100001
&LABEL   GLOBLOCK &FUNC,&REGS=,&RELATED=                    D11 ZA07645 00150001
.* REGS= 2 SYMBOLIC OR ACTUAL REGISTERS AVAIL FOR WORKREGS  D11 ZA07645 00200001
.* GENS GETLOCK LOCAL,UCBLOC ALGO,GETLOCK GLOBAL UCBLK      D11 ZA07645 00250001
.* ASSUMES THAT UCB DSECT (PREFIX=YES) IS ADDRESSIBLE       D11 ZA07645 00300001
.* DEPENDENT ON FOLLOWING DC STATEMENTS:                    D11 ZA07645 00350001
.* UCBLEN   DC    AL2(UCBBTB+L'UCBBTB-UCBOB+UCBCURPX) 2250UCBLENZA07645 00400001
.* UCBPRFXL DC    AL2(UCBCURPX)  UCB LOCKWORD PREFIX LEN                00450001
         LCLA  &NUM                                         D11 ZA07645 00500001
         LCLC  &WORK1,&WORK2,&MODE                          D11 ZA07645 00550001
         AIF   (T'&REGS NE 'O').REGSTHR                     D11 ZA07645 00600001
         MNOTE 12,'GLOBLOCK - NO WORKREGS GIVEN'            D11 ZA07645 00650001
         MEXIT                                              D11 ZA07645 00700001
.REGSTHR ANOP                                               D11 ZA07645 00750001
&NUM     SETA  N'&REGS                                      D11 ZA07645 00800001
         AIF   (&NUM EQ 2).REGSOK                           D11 ZA07645 00850001
         MNOTE 12,'GLOBLOCK - TWO (2) WORKREGS NOT GIVEN'   D11 ZA07645 00900001
         MEXIT                                              D11 ZA07645 00950001
.REGSOK  AIF   (T'&FUNC EQ 'O').NOFUNC                      D11 ZA07645 01000001
         AIF   (('&FUNC' NE 'OBTAIN') AND                              *01050001
                ('&FUNC' NE 'RELEASE')).INVFUNC             D11 ZA07645 01100001
         AIF   ('&LABEL' EQ '').NOLAB                       D11 ZA07645 01150001
&LABEL   EQU   *                                            D11 ZA07645 01200001
.NOLAB   AIF   ('&FUNC' EQ 'RELEASE').SKIPLOC               D11 ZA07645 01250001
*  GET LOCAL LOCK ........                                  D11 ZA07645 01300001
         SETLOCK OBTAIN,TYPE=LOCAL,REGS=USE,MODE=UNCOND,    D11 ZA07645*01350001
               RELATED=&RELATED                             D11 ZA07645 01400001
.SKIPLOC ANOP                                               D11 ZA07645 01450001
&WORK1   SETC  '&REGS(1)'           FIRST WORKREG           D11 ZA07645 01500001
&WORK2   SETC  '&REGS(2)'           SECOND WORKREG          D11 ZA07645 01550001
         SR    &WORK1,&WORK1       CLEAR FOR IC OF DEVNDX   D11 ZA07645 01600001
         IC    &WORK1,UCBDI        DEV INDEX                D11 ZA07645 01650001
         BCTR  &WORK1,0            DOWN BY ONE              D11 ZA07645 01700001
         MH    &WORK1,UCBLEN *2250UCBLEN=DISPL FROM 1STUCB  D11 ZA07645 01750001
         LR    &WORK2,RUCB         DUPE UCB ADDR            D11 ZA07645 01800001
         SR    &WORK2,&WORK1       BACKUP TO 1STUCB OF CU   D11 ZA07645 01850001
         SH    &WORK2,UCBPRFXL     BACKUP TO ITS LOCKWORD   D11 ZA07645 01900001
         AIF   ('&FUNC' EQ 'RELEASE').RELUCB                D11 ZA07645 01950001
*  OBTAIN UCBLOCK .......                                   D11 ZA07645 02000001
         SETLOCK OBTAIN,MODE=UNCOND,ADDR=0(&WORK2),         D11 ZA07645*02050001
               REGS=USE,RELATED=&RELATED,TYPE=IOSUCB        D11 ZA07645 02100001
         AGO   .COMUCB                                      D11 ZA07645 02150001
.RELUCB  ANOP                                               D11 ZA07645 02200001
*  RELEASE UCBLOCK ........                                 D11 ZA07645 02250001
         SETLOCK RELEASE,ADDR=0(&WORK2),REGS=USE,           D11 ZA07645*02300001
               RELATED=&RELATED,TYPE=IOSUCB                 D11 ZA07645 02350001
.COMUCB  ANOP                                               D11 ZA07645 02400001
* OTHER UCBS ON THIS SAME CONTROL UNIT SHOULD RESOLVE       D11 ZA07645 02450001
* (VIA UCBADDR AND DEVNDX TO SAME FIRST UCB).               D11 ZA07645 02500001
         SPACE 3                                            D11 ZA07645 02550001
         AIF   ('&FUNC' NE 'RELEASE').MEXIT                 D11 ZA07645 02600001
*  RELEASE LOCAL LOCK.....                                  D11 ZA07645 02650001
         SETLOCK RELEASE,TYPE=LOCAL,                        D11 ZA07645*02700001
               RELATED=&RELATED,REGS=USE                    D11 ZA07645 02750001
         MEXIT                                              D11 ZA07645 02800001
.NOFUNC  MNOTE 12,'GLOBLOCK-NO FUNCTION SUPPLIED'           D11 ZA07645 02850001
         MEXIT                                              D11 ZA07645 02900001
.INVFUNC MNOTE 12,'GLOBLOCK-FUNCTION NOT OBTAIN/RELEASE'    D11 ZA07645 02950001
.MEXIT   MEND                                               D11 ZA07645 03000001
         TITLE ' ASSIGN BUFFER SECTION OF IGC0007A'                     03050001
*********************************************************************** 03100001
*                                                                     * 03150001
* MODULE NAME:            IGC0007A (OS/VS2)                           * 03200001
*                                                                     * 03250001
* DESCRIPTIVE NAME:       BUFFER MANAGEMENT FOR 2250S                 * 03300001
*                                                                     * 03350001
* COPYRIGHT:              NONE                                        * 03400001
*                                                                     * 03450001
* STATUS:                 RELEASE 2.0                                 * 03500001
*                                                                     * 03550001
*                                                                     * 03600001
*FUNCTION/OPERATION: CONTROLS ASSIGNMENT AND RELEASE OF BUFFER STORAGE* 03650001
*   IN THE BUFFERED 2250,MODEL 1, AND IN THE 2840 DISPLAY CONTROL USED* 03700001
*   BY THE 2250, MODEL 2.                                             * 03750001
*                                                                     * 03800001
*ENTRY POINTS: IGC0007A - VIA AN SVC IN BUFFER MANAGEMENT MACROS      * 03850001
*                                                                     * 03900001
*INPUT: ADDRESS OF PARAMETER LIST BUILT BY MACROS IN REGISTER 1       * 03950001
*                                                                     * 04000001
*OUTPUT: RETURN CODES IN REGISTER 15                                  * 04050001
*                                                                     * 04100001
*              00 = REQUEST FULFILLED                                 * 04150001
*                                                                     * 04200001
*              04 = REQUEST AMT EXCEEDS AVAILABLE AMT     (ASGNBFR)   * 04250001
*                                                                     * 04300001
*              08 = CONTIGUOUS STORAGE NOT AVAILABLE     (ASGNBFR)    * 04350001
*                                                                     * 04400001
*              0C = DCB NOT OPEN                            ALL       * 04450001
*                                                                     * 04500001
*              10 = RELEASE REQUEST GT TOTAL ASSIGNED  (RELEASE)      * 04550001
*                                                                     * 04600001
*              14 = BUFFER RESTART ADDRESS NOW INVALID  (RELEASE)     * 04650001
*                                                                     * 04700001
*              18 = INVALID ASSIGN REQ (ZERO OR NEG)     (ASSIGN)     * 04750001
*                                                                     * 04800001
*              1C = INVALID INVOCATION CODE                 ALL       * 04850001
*                                                                     * 04900001
*              20 = INVALID RELEASE REQ (ZERO OR NEG)     (RELEASE)   * 04950001
*                                                                     * 05000001
*              24 = MOD1 2250 BUFFER EXHAUSTED           (ASSIGN)     * 05050001
*                                                                     * 05100001
*              28 = IOB DOESNT POINT BACK TO DCB            ALL       * 05150001
*                                                                     * 05200001
*              2C = DCB NOT GAM                             ALL       * 05250001
*                                                                     * 05300001
*              30 = ATTEMPT TO RELEASE SECTION(S) NOT OWNED (RELEASE) * 05350001
*                                                                     * 05400001
*              34 = UNABLE TO CLEAR REQUESTED BFR TO ZERO  (ASSIGN)   * 05450001
*                                                                     * 05500001
*              38 = BUFFER CONTROL TABLE ADDR NOT IN UCB    ALL       * 05550001
*                                                                     * 05600001
*EXTERNAL ROUTINES: N/A                                               * 05650001
*                                                                     * 05700001
*EXITS-NORMAL: SVC 3 FOR RETURN CODES 0 AND X'14'                     * 05750001
*                                                                     * 05800001
*     -ERROR:  ABEND16E (VIA DEBCHK) IF INVALID DEB.                  * 05850001
*     -ERROR:  XCTL TO MSG MOD (IGC0207A) W NONZERO CODE OTHER        * 05900001
*              THAN X'14'.                                            * 05950001
*                                                                     * 06000001
*TABLES/WORKAREAS: BUFFER TABLES BUILT AT SYSGEN TIME IN PROTECTED    * 06050001
*   CORE FOR EACH BUFFERED 2250 MODEL 1 AND EACH 2840 CONTROL UNIT.   * 06100001
*                                                                     * 06150001
*ATTRIBUTES: SUPERVISOR MODE, REENTERABLE.                            * 06200001
*            SUPERVISOR AND USER KEYS.                                * 06250001
*                                                                     * 06300001
*NOTE1: A HAND-EXPANDED CALL FOR MACRO GWRITE EXISTS AT LABEL 'CLRBFR'* 06350001
*NOTE2: AN INTERNAL MACRO (AT THE BEGINNING OF THIS MOD) IS USED      * 06400001
*       TO GET AND FREE THE LOCAL AND IOSUCB LOCKS NEEDED TO PROTECT  * 06450001
*       THE BUFFER TABLE GENNED FOR EACH 2840 CONTROL UNIT AS A       * 06500001
*       GLOBAL RESOURCE FOR ALL DEVICES ON THAT CONTROL UNIT.         * 06550001
*                                                                     * 06600001
*********************************************************************** 06650001
         EJECT                                                          06700001
IGC0007A CSECT                                                          06750001
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   06800001
*C081400,084200,092804,093302,096521,099242                   LF YM4067 06850001
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  06900001
*0638,025600-026000                                                JFCA 06950001
*2515,018600-019800,020000                                         TMGA 07000001
* 021200,021800,022200,025600-025800,027200,029000,049400,063200 S21016 07050001
* 063800-064400,065000-065200,077400,085400-085800               S21016 07100001
* 034200,034800,043000-043200,063000                             S21016 07150001
*0639,018800-019200                                                JFCB 07200001
* 025610-025680,070200,085900                                 LB  AOS/1 07250001
*C022600                                                         Y01021 07300001
*A027150                                                        YM1899  07350001
*A14274,23500-23580,38900-38916                               LG YM5684 07400001
*A14399-15320,A42714-42760,A12500,A12820                     LG @ZM2360 07450001
*C65300                                                     D11 ZA06400 07500001
*A42612,D43184,C42761,42788,42797,43103,43157,43202         D11 ZA07642 07550001
*A35900                                                     D11 ZA07643 07600001
*A67372,71700-50,80850-900,91600-61,92274-80,C32700-800,    D11 ZA07645 07650001
*C42602-03,67305-14,93470,93720-30,A111300-111400           D11 ZA07645 07700001
*A42645,C43174-78,A43208                                    D11 ZA07647 07750001
*A14310,42720                                               D11 ZA11044 07800001
*A18109,D90338                                              D11 ZA11045 07850001
*A42734-58,D042761                                          D11 ZA11441 07900001
*C62800,63200,63400,63690,64600,64900,65300,66100,85900     D11 ZA11442 07950001
*A67344-68,96200-40,100518,101967                           D11 ZA11442 08000001
         EJECT                                                          08050001
*                                                                       08100001
*                  REGISTERS                                            08150001
*                                                                       08200001
RX       EQU   0                                                        08250001
RY       EQU   1                                                        08300001
RZ       EQU   2                                                        08350001
RA       EQU   3                                                        08400001
RB       EQU   4                                                        08450001
RBFADDR  EQU   4             BUFFER ADDRESS REGISTER                    08500001
RTCB     EQU   4         CURRENT TCB REGISTER                           08550001
RC       EQU   5                                                        08600001
RD       EQU   6                                                        08650001
RE       EQU   7                                                        08700001
RCODE    EQU   7                       RET CODE FOR ERROR MSG MODS21016 08750001
R8       EQU   8                       ADDR EP NAME FOR XCTL     S21016 08800001
RUCB     EQU   8                                                        08850001
RDCB     EQU   9                                                        08900001
RBFTBL   EQU   10                       BUFFER TABLE DSECT REGISTER     08950001
LINK     EQU   10            REGISTER AS WORK REG                       09000001
RDSECT   EQU   11                       PARAM LIST DSECT REGISTER       09050001
RBASE    EQU   12                       CONTROL SECTION BASE REGISTER   09100001
RSAVE    EQU   13                       SAVEAREA REGISTER               09150001
RNSI     EQU   14                       RETURN LINKAGE REGISETER        09200001
R14      EQU   14                    WORK REGISTER           LG @ZM2362 09250001
RBAL     EQU   15                       LINKAGE REGISTER                09300001
RHOLD    EQU   15                                                       09350001
R15      EQU   15                    WORK REGISTER           LG @ZM2362 09400001
         EJECT                                                          09450001
*RETURN CODE EQUATES                                                    09500001
*                                                                       09550001
         SPACE 3                                                        09600001
TOOBIGAV EQU   4                   REQ GT AVAIL BFR         D11         09650001
TOOBIGZN EQU   8                   REQ GT ZONESIZE          D11         09700001
UNOPEN   EQU   X'0C'                   DCB NOT OPEN              S21016 09750001
BADRLS   EQU   X'10'               RLSE GT TOTASGND                     09800001
BADADR   EQU   X'14'               BAD RSTRT ADDR ON RLSE               09850001
BFRPRM   EQU   X'18'               ASGN REQ NOT POS.                    09900001
BADREQ   EQU   X'1C'                   BAD REQUEST CODE          S21016 09950001
RELNEG   EQU   X'20'                   RELEASE NEGATIVE COUNT    S21016 10000001
NOSECTS  EQU   X'24'                   CONTIG BUFFER UNAVAILABLE S21016 10050001
DCBBAD   EQU   X'28'                   DCB AND IOB DCB NOT EQUAL S21016 10100001
NOTGRPHC EQU   X'2C'                   NON-GRAPHIC DCB           S21016 10150001
BADREL   EQU   X'30'                   RELEASE FOR UNASSIGNED    S21016 10200001
NOCLEAR  EQU   X'34'         UNABLE TO DO I/O TO CLEAR BUFFER           10250001
NOBFTBL  EQU   X'38'         NO BUFFER TABLE ADDRESS IN UCB   LG YM5684 10300001
         SPACE                                                          10350001
* FURTHER EQUATES                                                       10400001
D0       EQU   0                       DISPLACEMENT              S21016 10450001
D8       EQU   8                       DISPLACEMENT              S21016 10500001
COMPLETE EQU   X'7F'          ECB COMPLETED WITHOUT ERROR.              10550001
MASK1    EQU   X'FF'                                                    10600001
MOD1     EQU   X'31'               DEVTYPE = MOD1 2250      D11         10650001
DECB     EQU   76      DISPL. OF DECB INTO GOTTEN CORE      D11 ZA11044 10700001
HEADER   EQU   40                                                       10750001
SVAREA   EQU   76            SIZE OF 18-WORD SAVE AREA      LG @ZM2362  10800001
DECBLEN  EQU   32            LEN OF GWRITE DECB GOTTEN      D11 ZA07642 10850001
DEBUCBAD EQU   32            DISPL OF UCBADDR IN DEB        D11         10900001
FOUR     EQU   4             CONSTANT                                   10950001
BFR      EQU   16            DISP. OF BUFFER ADDRESS IN DCB             11000001
CVT      EQU   16                                                       11050001
CVTCB    EQU   0         DISP. OF TCB TABLE ADDR. IN CVT                11100001
CURTCB   EQU   4         DISP OF CURRENT TCB ADDR. IN TABLE             11150001
SEVEN    EQU   7                     CONSTANT SEVEN(7)       LG @ZM2362 11200001
TEB      EQU   28                    OFFSET TO TEB IN UCB    LG @ZM2362 11250001
TEBGIOCR EQU   33                OFFSET TO GIOCR ADDR IN TEB LG @ZM2362 11300001
GIOCR    EQU   49                    OFFSET TO GIOCR IN DCB  LG @ZM2362 11350001
SVGIOCR  EQU   72            DISP TO GIOCR ADR IN SVAREA     LG @ZM2362 11400001
SVCDCB   EQU   X'54'         DISP TO DCB FOR SVCLIB IN CVT   LG @ZM2362 11450001
DCBBFRST EQU   16     DCB BUFFER START-ZEROED IF ERRORS     D11         11500001
         EJECT                                                          11550001
*           INITIALIZE BASE AND DSECT REGISTERS                         11600001
         SPACE 3                                                        11650001
         BALR  RBASE,RX            ESTABLISH ADDRESSABILITY             11700001
         USING *,RBASE                                                  11750001
ORG      EQU   *                   ORIGIN FOR MSG1,2,3      D11 ZA11045 11800001
         B     START                                        D11         11850001
MODID    DC    C'IGC0007A.VS2R3.&SYSDATE'       MODULE EYECATCHER ID    11900001
START    LR    RDSECT,RY           MAP PARMLIST DSECT       D11         11950001
         USING PARLST,RDSECT            ADDRESS PASSED IN GR1           12000001
*CHECK DCB FOR VALIDITY AND OPENED                                      12050001
         L     RDCB,CODE           HIORD BYTE=CODE;LOORD3=DCBADDR       12100001
         TM    48(RDCB),X'10'           CHECK DCB FOR OPENED CONDITION  12150001
         BZ    ERRDCB1                 ISSUE RET CODE IF NOT OPENS21016 12200001
         L     RZ,28(RDCB)              RZ CONTAINS IOB ADDR,TO CHECK   12250001
         CLC   DCBADR(3),21(RZ)         IOB FOR VALIDITY OF THIS DCB    12300001
         BNE   ERRDCB2                 ISSUE RET CODE-INVALID DCBS21016 12350001
         TM    27(RDCB),X'80'           VALID GAM DCB? IF NOT GO TO ERR 12400001
         BZ    ERRDCB3                 ISSUE RET CODE-INVALID DCBS21016 12450001
*ACCESS UCB                                                             12500001
         LA    RDCB,D0(RDCB)           CLEAR HI-BYTE DCB ADDR LB Y01021 12550001
         DEBCHK (RDCB),TYPE=VERIFY,AM=GAM   VALIDATE DEB      LB Y01021 12600001
         LR    R8,RY                   DEB ADDRESS            LB Y01021 12650001
         L     RUCB,DEBUCBAD(R8)        RUCB CONTAINS UCB ADR FROM DEB  12700001
         USING UCBOB,RUCB                                   D11         12750001
*SET UP BUFFER TABLE DSECT                                              12800001
         L     RBFTBL,UCBBTB-1     LOAD BFRTBL ADR FROM UCB             12850001
         LA    RBFTBL,0(RBFTBL)        ELIMINATE DEVNDX                 12900001
         LTR   RBFTBL,RBFTBL        BUFFER TABLE EXIST?       LG YM5684 12950001
         BNZ   CKCODE             YES,CONTINUE PROCESSING     LG YM5684 13000001
         LA    RCODE,NOBFTBL      LOAD RETURN CODE            LG YM5684 13050001
         B     XCTLOAD3           XCTL TO LOAD 3             D11 YM5684 13100001
CKCODE   EQU   *                                                        13150001
         USING BFRTBL,RBFTBL                                            13200001
*CHECK POSITIVELY FOR REQUEST CODE IN PARAM LIST                        13250001
         CLI   CODE,X'04'               IF CODE '04' GO TO ASSIGN SUB-  13300001
         BE    ASSIGN                   ROUTINE                         13350001
         CLI   CODE,X'08'               IF CODE '08' GO TO RELEASE SUB- 13400001
         BE    RELEASE                  ROUTINE                         13450001
         CLI   CODE,X'0C'               IF CODE '0C' GO TO RELEASE ALL  13500001
         BE    RLSEALL                          TRANSFER TO LOAD2       13550001
         CLI   CODE,X'10'          IF CODE '10' GO TO BUFINQ SUBROUTINE 13600001
         BE    BUFINQ                          TRANSFER TO LOAD2        13650001
         LA    RCODE,BADREQ         LOAD RETURN CODE             S21016 13700001
         EJECT                                                          13750001
*********************************************************************** 13800001
*                                                                     * 13850001
*              TRANSFER CONTROL MECHANISM TO LOAD 3, MESSAGES         * 13900001
*                                                                     * 13950001
*********************************************************************** 14000001
XCTLOAD3 EQU   *                       SET UP TO XCTL TO MSG MOD S21016 14050001
         LA    R8,EPLOAD3              ADDR OF NAME FOR LOAD 3   S21016 14100001
         LR    RY,RDSECT           RESTORE REG 1                YM1899  14150001
         L     RZ,CVT                  LOAD CVT ADDR                    14200001
         L     RZ,0(RZ)            LOAD TCB PTR TO DOUBLE WORD          14250001
         L     RZ,4(RZ)            LOAD CURRENT TCB ADR                 14300001
         L     RZ,0(RZ)            LOAD CURRENT RB PTR                  14350001
         LA    RBAL,96(RZ)         LOAD ADR OF REMOTE SUPRVSR PARAM LST 14400001
         LA    RZ,104(RZ)               WHICH IS AT SVRB+96, THEN SET   14450001
         ST    RZ,0(RBAL)               UP LIST AS FOLLOWS --           14500001
         SR    RA,RA                    WORD1 - PTR TO BUFINQ ADR (*+8) 14550001
         ST    RA,4(RBAL)               WORD2 - DCB ADR SET TO 0        14600001
         MVC   D8(D8,RBAL),D0(R8)           WORD 3,4 - EP NAME   S21016 14650001
         XCTL  MF=(E,(1)),SF=(E,(15)) TRANSFER CONTROL                  14700001
EPLOAD3  DC    CL8'IGC0207A'           NAME FOR MSG MODULE       S21016 14750001
         EJECT                                                          14800001
*     *     *     *     *     *    *     *     *     *     *     *      14850001
*                                                                *      14900001
*THE FOLLOWING SUBROUTINE ASSIGNS BUFFER STORAGE AND IS ACCESSED *      14950001
*WHENEVER THE ASGNBFR MACRO-INSTRUCTION IS ISSUED.               *      15000001
*                                                                *      15050001
*     *     *     *     *     *     *     *     *     *     *    *      15100001
ASSIGN   L     RA,BUFPRM                RA EQ ADDR OF HALFWORD          15150001
         LH    RA,0(RA)                 RA EQ BYTES REQUESTED           15200001
         LA    RX,MASK1                 RX CONTAINS X'FF',ADD TO RA,TO  15250001
         AR    RA,RX                    CONVERT BYTES TO SECTIONS       15300001
         SRA   RA,8                     PUT NUMB IN LO-ORDER BYTE OF RA 15350001
         SR    RX,RX                    CLEAR RX TO ZERO AND COMPARE TO 15400001
         CR    RA,RX               CHECK RA FOR NEG OR ZERO REQUEST     15450001
         BNH   ERRPRM                   GO TO RET CODE '18' RTN         15500001
ASGNGET  GLOBLOCK OBTAIN,REGS=(RB,RC),                      D11 ZA07645*15550001
               RELATED=(ASGNREL,ENABLE)                     D11 ZA07645 15600001
*INITIALIZE SUBROUTINE                                                  15650001
BASIC    LH    RB,TOTAVAIL         SET RB EQ TO TOTAVAIL IN BFRTBL      15700001
         LH    RC,NUMDEV                RC HAS NUMBER OF DEVICES/2840   15750001
         CLR   RA,RB                    IF REQUEST GREATER THAN AMT     15800001
         BH    ERRASG4                  AVAIL,LOAD RETURN CODE          15850001
*ACCESS AND SEARCH THIS DEVICE'S ZONE                                   15900001
         BAL   RNSI,INFODISP      GO TO INFO RTN                        15950001
*                                                                       16000001
         LH    RE,4(RZ)                 RE CONTAINS THIS DEVICE'S ZONSZ 16050001
         CLR   RA,RE               COMPARE REQUEST TO ZONESZ            16100001
        BH    ERRASG8             IF REQUEST GREATER NO ASGNMENT        16150001
*BEGIN SEARCH OF THIS DEVICE'S ZONE--                                   16200001
         LH    RB,2(RZ)                 RB EQ DEVICE'S ZONE DISP        16250001
         AR    RB,RBFTBL                RB EQ DISP + ADDR OF BFR TBL    16300001
         LR    RX,RZ                    SAVE DISP OF THIS DEVICE'S INFO 16350001
         SR    RY,RY               CLEAR R1 FOR TRT         D11 ZA07643 16400001
REEX     EX    RE,SEEK1            SEARCH FOR AVAIL SECTION             16450001
* SEEK1= TRT 0(1,RB),FREESCTN - FREESCTN=X'FF00000000'                  16500001
         BC    10,CONTINU1             IF NOT FOUND GO TO NEXT ZONE     16550001
         BAL   14,COMPUTE              SET UP REG AND CTRS              16600001
*OTHERWISE SEARCH FOR CONTIGUOUS STORAGE IN DEVICE'S ZONE               16650001
         EX    RA,SEEK2                 SEARCH FOR CONTIG PER REQUEST   16700001
* SEEK2= TRT 0(1,RB),CONTIG - CONTIG=X'00FFFFFFFF'                      16750001
         BC    4,GETADR                                                 16800001
         EJECT                                                          16850001
*                                                                       16900001
*UPDATE TABLES, ASSIGN STORAGE AND SET DCB FLDS                         16950001
*                                                                       17000001
SETDCB   LR    RZ,RB                    CONVERT BFR TBL ENTRY DISP TO   17050001
         SR    RZ,RBFTBL                ACTUAL BFR STORAGE ADDRESS BY   17100001
         CLI   UCBTYP,MOD1             IS IT MOD 1          D11         17150001
         BNE   MODASG              NO - BRANCH                          17200001
         S     RZ,HEAD16           SUBTRACT MOD1 BFRTBL ADR D11         17250001
         B     MULTI               CONTINUE                 D11         17300001
MODASG   S     RZ,HEADISP          SUB MOD2 BFRTBL ADDR     D11         17350001
MULTI    SLL   RZ,8                ENTYRDISP MULT BY 256                17400001
         L     RE,CVT               LOAD CVT ADDRESS          YM5684    17450001
         L     RE,0(RE)           LOAD TCB PTR TO DOUBLE WORD LG YM5684 17500001
         L     RE,4(RE)           LOAD CURRENT TCB ADDRESS    LG YM5684 17550001
         USING TCB,RE                                         LG YM5684 17600001
         MODESET EXTKEY=TCB,WORKREG=5   GOTO USERKEY TO FILLIN          17650001
         STH   RZ,16(RDCB)              SET BFRST FLD IN DCB            17700001
         LR    RZ,RA                    CONVERT SECTIONS IN REQUEST TO  17750001
         SLL   RZ,8                     BYTES BY MULTIPLYING BY 256     17800001
         LR    RC,RZ         SAVE BYTE REQUEST                          17850001
         LR    RSAVE,RA      SAVE NUMBER OF SECTIONS                    17900001
         STH   RZ,18(RDCB)              SET BFRSZ FLD IN DCB            17950001
         MODESET EXTKEY=SUPR       BACK TO SUPERKEY                     18000001
         DROP  RE                                                       18050001
         EJECT                                                          18100001
*                                                                       18150001
*ASSIGN--FILL IN BFR TABLE                                              18200001
*                                                                       18250001
         LH    RE,TOTAVAIL              UPDATE TOTAVAIL FLD OF BFR TBL  18300001
         SR    RE,RA                    SUBTRACT REQUEST                18350001
         STH   RE,TOTAVAIL              STORE UPDATED TOTAVAIL IN TBL   18400001
         LH    RZ,0(RHOLD)         LOAD TASGND FIELD TO UPDATE          18450001
         AR    RZ,RA               ADD REQUEST                          18500001
         STH   RZ,0(RHOLD)         RESTORE UPDATED TASGND               18550001
         MVC   0(1,RB),UCBDI            PUT DEVNDX IN 1ST BYTE ENTRY    18600001
         LA    RX,RY                    SET RX EQ 1                     18650001
         CLR   RX,RA               IS REQUEST EQ 1 SECTION              18700001
         BE    CLR000       GO CLEAR ASSIGNED BUFFER                    18750001
         LA    RX,RZ                    SET RX EQ 2                     18800001
         SR    RA,RX                    SET RA EQ REQUEST-2 TO USE EX   18850001
         EX    RA,ASGSCTN               INSTRUCTION WITH LNG ADJUSTED   18900001
CLR000   EQU   *                                                        18950001
ASGNREL  GLOBLOCK RELEASE,REGS=(RA,RB),                     D11 ZA07645*19000001
               RELATED=(ASGNGET)                            D11 ZA07645 19050001
         LR    RA,RSAVE      RESTORE NUMBER SECTIONS                    19100001
         LH    RBFADDR,BFR(RDCB) START OF BUFFER ASSIGNMENT             19150001
         LA    RX,FOUR       LOAD FOUR AS A CTR FOR THE 256-BYTE        19200001
*                            SECTIONS. THE BUFFER ASSIGNED WILL BE      19250001
*                            CLEARED WITH 1K GWRITES(4 SECTIONS) IF     19300001
*                            MORE THAN 1K IS REQUESTED.                 19350001
         CLR   RA,RX         MORE THAN 1K REQUESTED?                    19400001
         BH    ASGN0001      BRANCH IF YES.                             19450001
         LA    RX,SVAREA+DECBLEN(RC) SIZE=SVAREA+DECBLEN    D11 ZA07642 19500001
         BAL   LINK,ASGN0003 SUBROUTINE TO GET AND CLEAR AREA           19550001
         EJECT                                                          19600001
*INITIALIZE REGISTERS AND SET UP PARAMETERS FOR GWRITE WHICH WILL       19650001
*WRITE A ZEROED AREA TO THE PARTICULAR BUFFER SECTIONS ASSIGNED.        19700001
         LH    RZ,18(RDCB)   NUMBER OF BYTES TO CLEAR                   19750001
         STH   RBFADDR,0(RSAVE) WORD ONE OF THE SAVE AREA WILL          19800001
*                              BE USED TO SAVE THE BUFFER ADDR...       19850001
*                              ASSIGNED.                                19900001
         LA    RE,SUCCESS    GET RETURN ADDRESS FOR FREEAREA            19950001
         LA    LINK,FREEAREA  GET RETURN ADDRESS FOR CLRBFR             20000001
         B     CLRBFR        GO TO CLEAR BUFFER SUBROUTINE              20050001
*MORE THAN 1K HAS BEEN REQUESTED,THEREFORE WE WILL CLEAR THE ASSIGNED   20100001
*BUFFER IN 1K SECTIONS TO MAKE THE MOST EFFECTIVE USE OF I/O.           20150001
ASGN0001 EQU   *                                                        20200001
         L     RX,ONEK       SIZE OF AREA TO CLEAR                      20250001
         LA    RZ,SVAREA+DECBLEN  DECB/SVAREA SIZE (USED BY GIOCR)      20300001
         AR    RX,RZ         TOTAL SIZE OF AREA TO GETMAIN              20350001
         L     RC,ONEK       SAVE SIZE FOR GWRITE           D11 ZA11046 20400001
         BAL   LINK,ASGN0003 LINK TO SUBROUTINE TO CLEAR AREA           20450001
*NOW WE WILL DIVIDE THE REQUEST INTO 1K SECTIONS                        20500001
         LH    RD,18(RDCB)   AMOUNT OF BUFFER ASSIGNED                  20550001
         SRDL  RD,32         POSITION IN ODD REGISTER                   20600001
         DR    RD,RZ         DIV BY 1K(1024) -SETS BCT COUNT IN RE      20650001
ASGN0002 EQU   *                                                        20700001
         STH   RBFADDR,0(RSAVE) SAVE BUFFER ADDR FOR GWRITE             20750001
         BAL   LINK,CLRBFR   LINK TO CLEAR-BUFFER SUBROUTINE            20800001
         LA    RBFADDR,0(RZ,RBFADDR)    POINT TO NEXT SECTION           20850001
         BCT   RE,ASGN0002   CLEAR ALL SECTIONS                         20900001
         LA    RE,SUCCESS    GET RETURN ADDRESS FOR FREEAREA            20950001
         LTR   RD,RD         ANY REMAINING TO BE CLEARED?               21000001
         BZ    FREEAREA      BRANCH IF NO                               21050001
         LR    RZ,RD         SIZE OF REMAINING BUFFER SEGMENT           21100001
         LA    LINK,FREE1K   RETADR WHEN ALL CLEARED        D11 ZA07647 21150001
         EJECT                                                          21200001
*                                                                       21250001
*THE FOLLOWING INTERNAL SUBROUTINE WILL WRITE THE CLEARED AREA OUT      21300001
*TO THE 2250 BUFFER                                                     21350001
*                                                                       21400001
CLRBFR   EQU   *                                                        21450001
         XC    DECB(DECBLEN,RC),DECB(RC) CLEAR DECB         D11 OZ11044 21500001
         SPACE 3                                            D11 ZA11441 21550001
* THERE FOLLOWS A HAND-EXPANDED VERSION OF THE GWRITE MACRO D11 ZA11441 21600001
* WHICH IS USED TO ACCESS A SAFE GIOCR ADDRESS FROM THE TEB.D11 ZA11441 21650001
* THIS IS NECESSARY WHEN GWRITE IS CALLED IN A ROUTINE THAT D11 ZA11441 21700001
* RUNS IN SYSTEM MODE SO AS NOT TO GIVE A SNEAKY RD/WR      D11 ZA11441 21750001
* ROUTINE CONTROL IN SUPSTATE,KEY0 AND UNINTEGRATE THINGS.  D11 ZA11441 21800001
*        GWRITE DECB(RC),BUF,(RDCB),(RZ),(RC),(RSAVE),MF=E  D11 ZA11441 21850001
         SR    15,15               CLEAR REGISTER           D11 ZA11441 21900001
         LA    1,DECB(RC)          POINT TO DECB            D11 ZA11441 21950001
         ST    15,4(0,1)           CLEAR TYPE AREA IN DECB  D11 ZA11441 22000001
         MVI   4(1),X'A0'          BUF TYPECODE TO DECB     D11 ZA11441 22050001
         LA    15,0(RDCB)          POINT TO DCB             D11 ZA11441 22100001
         ST    15,8(0,1)           DCB ADDR TO DECB         D11 ZA11441 22150001
         LA    15,0(RZ)            LENGTH                   D11 ZA11441 22200001
         ST    15,20(0,1)          LENGTH TO DECB           D11 ZA11441 22250001
         LA    15,0(RC)            AREA ADDRESS             D11 ZA11441 22300001
         ST    15,12(0,1)          AREA ADDR TO DECB        D11 ZA11441 22350001
         LA    15,0(RSAVE)         CLEAR HI-ORDER BYTE      D11 ZA11441 22400001
         ST    15,28(0,1)          BUFFER ADDRES TO DECB    D11 ZA11441 22450001
         XC    0(4,1),0(1)         CLEAR ECB                D11 ZA11441 22500001
         L     15,SVGIOCR(RSAVE)  GET SAFE GIOCR ADDRESS    D11 ZA11441 22550001
         DS    0H                                           D11 ZA11441 22600001
         BALR  14,15               BR TO GIOCR EP           D11 ZA11441 22650001
* END OF HAND-CODED EXPANSION OF GWRITE MACRO CALL...       D11 ZA11441 22700001
         SPACE 3                                            D11 ZA11441 22750001
         LTR    RBAL,RBAL    I/O STARTED?                               22800001
         BNZ    CLRERR       BRANCH IF NO                               22850001
         WAIT   ECB=DECB(RC)   WAIT ON I/O COMPLETION       D11 ZA07642 22900001
         CLI   DECB(RC),COMPLETE I/O DONE WITHOUT ERROR?    D11 ZA07642 22950001
         BCR   8,LINK        BRANCH IF YES                              23000001
         EJECT                                                          23050001
*                                                                       23100001
CLRERR   EQU   *                                                        23150001
*                                                                       23200001
* AN ERROR WAS DISCOVERED WHEN TRYING TO CLEAR THE REQUESTED            23250001
*BUFFER.NOW WE MUST SAVE INPUT REGISTERS,CREATE A PARAMETER             23300001
* LIST FOR RELEASE BUFFER AND GO TO RELEASE BUFFER SUBROUTINE           23350001
*TO RELEASE THE BUFFER WE JUST ASSIGNED.                                23400001
*                                                                       23450001
         ST    RDSECT,0(RSAVE) SAVE INPUT REGISTER                      23500001
*CREATE RLSEBFR PARMLIST AT SAVEAREA+0 (LEN='14')           D11         23550001
         ST    RZ,4(RSAVE)    SAVE SIZE OF GETMAINED AREA               23600001
         L     RA,CODE       GET DCB ADDRESS AND CODE                   23650001
         ST    RA,8(RSAVE)    STORE ADDRESS IN PARM LIST                23700001
         LA    RA,16(RDCB)   PUT BUFFER PARAM IN LIST...                23750001
         ST    RA,12(RSAVE)   TO BE USED BY RLSEBFR                     23800001
         LA    RY,8(RSAVE)    SET INPUT REG TO ADDR OF LIST             23850001
         LR    RDSECT,RY     INITIALIZE DSECT REGISTER                  23900001
         L     RBFTBL,UCBBTB-1  RELOAD BFR TBL ADDRESS                  23950001
         LA    RBFTBL,0(RBFTBL) CLEAR OUT DEVICE INDEX                  24000001
         B     RELEASE       RELEASE THE ASSIGNED BUFFER                24050001
ASGN0003 EQU    *                                                       24100001
         GETMAIN R,LV=(0)                                               24150001
*GENERAL REGISTERS 0,1,6 AND 7 WILL NOW BE INITIALIZED FOR THE          24200001
*MOVE LONG INSTRUCTION TO CLEAR THE AREA TO BE WRITTEN TO THE BUFFER    24250001
         LR    RSAVE,RY       SAVE AREA ADDRESS                         24300001
         LA    RY,SVAREA+DECBLEN(RY) POINT PAST SAVE+DECB   D11 ZA07642 24350001
         LR    RD,RY         ADDRESS OF AREA TO CLEAR                   24400001
         LR    RX,RY         ADDRESS OF AREA TO CLEAR                   24450001
         LR    RY,RC         NUMBER OF BYTES TO CLEAR       D11 ZA11046 24500001
         LA    RE,D0         SET PADDING CHARACTER TO 0                 24550001
         MVCL  RX,RD         CLEAR GOTTEN CORE                          24600001
         LA    RC,SVAREA+DECBLEN(RSAVE) ADR STRT OF CLRAREA D11 ZA07642 24650001
         L     R15,CVT       GET ADDRESS OF CVT              LG @ZM2362 24700001
         L     R15,SVCDCB(R15) DCB ADDR FOR SVCLIB           LG @ZM2362 24750001
         LOAD  EP=IGG019OA,DCB=(R15)                         LG @ZM2362 24800001
         STCM  RX,SEVEN,SVGIOCR+1(RSAVE)                     LG @ZM2362 24850001
         BR    LINK          RETURN                                     24900001
FREE1K   EQU   *                   EP TO FREE ONE ENTIRE K  D11 ZA07647 24950001
         L     RZ,ONEK             AMOUNT TO FREE           D11 ZA07647 25000001
         EJECT                                                          25050001
FREEAREA EQU   *                                                        25100001
         LA    RX,SVAREA+DECBLEN(RZ) SIZE TO FREE           D11 ZA07642 25150001
FREECORE EQU   *                                            D11 ZA07647 25200001
         FREEMAIN R,LV=(0),A=(13)                                       25250001
         DELETE EP=IGG019OA  DELETE GIOCR                   D11 @ZM2362 25300001
         BR    RE            RETURN IN-LINE                             25350001
SUCCESS  SR    RCODE,RCODE               SET GR15 EQ 0 (X'00'           25400001
         B     EXIT1               RESTORE R1 AND EXIT      D11         25450001
         EJECT                                                          25500001
*                                                                       25550001
*                       INTERNAL  SUBROUTINES                           25600001
*                                                                       25650001
         SPACE 3                                                        25700001
*   SUBROUTINE TO SCAN ZONES FOR AVAILABLE SPACE                        25750001
COMPUTE  AR    RE,RB                   RE EQ DISP ADR + ZONESZ          25800001
         SR    RE,RY                   RE EQ REMAINING ZONESZ           25850001
         CLR   RA,RE                   IS REQUEST HIGHER THAN ZONESZ    25900001
         BH    CONTINU1                GO TO NEXT ZONE                  25950001
         LR    RB,RY                   PUT NEW TRT ADR IN RB            26000001
         BR    RNSI                    GO BACK                          26050001
         SPACE 3                                                        26100001
*   SUBROUTINE TO LOCATE PARTICULAR DEVICE INFO IN BT                   26150001
*        1. ALGO IS (DEVINDX# - 1) * 8 + BTDVADR                        26200001
*                    FROM UCB             BT+8                          26250001
*                                                                       26300001
INFODISP SR    RD,RD                    CLEAT RD TO ZERO                26350001
         IC    RD,UCBDI                 RD CONTAINS DEVNDX              26400001
         LR    RZ,RD                    RZ CONTAINS DEVNDX TO COMPUTE   26450001
*                                       LOCATION OF THIS DEVICE'S INFO  26500001
*                                       IN THE BFR TBL                  26550001
         BCTR  RZ,0                SUBTRACT ONE FROM DEVNDX (RZ)        26600001
         SLL   RZ,3                     MULTIPLY RZ BY 8                26650001
         LA    RE,8(RBFTBL)             RE EQUALS BFR TBL ADDR + 8      26700001
         AR    RZ,RE                    RZ EQUALS DISP OF THIS DEVICE'S 26750001
*                                       INFO IN BFR TBL                 26800001
         LR    RHOLD,RZ            SAVE THIS DEVICE'S INFO DISP         26850001
         B     0(RNSI)                                                  26900001
         EJECT                                                          26950001
*                   MISCELLANEOUS OUT-OF-LINE CODE                      27000001
*                                                                       27050001
GETADR   BAL   14,COMPUTE              UPDATE REG AND CTRS              27100001
         B     REEX                                                     27150001
*                                                                       27200001
         EJECT                                                          27250001
*WHEN AN ASSIGNMENT CANNOT BE FULFILLED WITHIN THE DEVICES OWN ZONE     27300001
*THE NEXT SEQUENTIAL ZONE'S UNGUARANTEED AREA IS SEARCHED, STARTING     27350001
*AT THE BOTTOM OF THE AVAILABLE AREA                                    27400001
CONTINU1 LR    RZ,RX                    LOAD BFR INFO DISP INTO RZ      27450001
         SR    RC,RD               SET RC EQ NUMDEV-DEVNDX              27500001
         AR    RD,RC                    SET RC EQ NUMDEV TO USE AS CTR  27550001
         BCT   RD,*+4              SUBTRACT ONE FROM NUMDEV (RD)        27600001
CONTINU3 SR    RX,RX                    SET RX EQ 0                     27650001
         CLR   RX,RD               NUMDEV EQ 0?                         27700001
         BE    ERRASG                  GO TO ERR RETURN RTN      S21016 27750001
         CLR   RX,RC               RC CTR EQ 0?                         27800001
         BE    TBLTOP                   GO TO RTN TO ACCESS 1ST DEVICES 27850001
*                                            ZONE                       27900001
*                                       OTHERWISE ACCESS NEXT ZONE AND  27950001
*                                            CHECK ZONE SIZE            28000001
         LA    RZ,RUCB(RZ)         ADD 8 TO BFR INFO DISP IN RZ         28050001
CONTINU4 LH    RY,6(RZ)                 LOAD TG INTO RY                 28100001
         LH    RE,4(RZ)                 LOAD RE WITH ZONESZ             28150001
         SLR   RE,RY               SUBTRACT TG FROM ZONESIZ             28200001
*                                            AVAILABLE UNGTD SIZE       28250001
         CLR   RA,RE               IS REQUEST LARGER THAN ZONESZ        28300001
         BH    CONTINU6                 GO TO DECREMENT RC,RD           28350001
         EJECT                                                          28400001
*                                                                       28450001
*OTHERWISE BEGIN BACKWARD SEARCH IN UNGTD PORTION OF THIS ZONE BY TRT   28500001
*INSTRUCTION WITH USE OF ZONESZ COUNTER                                 28550001
*                                                                       28600001
         LH    RB,2(RZ)                 SET RB EQ DISP FOR THIS ZONE    28650001
         AR    RB,RBFTBL                ADD BFR TBL ADDR TO THIS DISP   28700001
         AR    RB,RY                    ADD TG TO THIS TOTAL DISP TO PT 28750001
*                                            TO START OF UNGTD AREA     28800001
         AR    RB,RE                    ADD ZONESZ TO TOTAL DISP TO PT  28850001
*                                            TO END OF UNGTD AREA       28900001
SEARCH1  LR    RX,RZ                    SET DISP EQ REQUEST LNG FROM RB 28950001
SEARCH2  SR    RB,RA                         AFTER SAVING RZ IN RX      29000001
         EX    RA,SEEK2                 EXECUTE THE TRT-INSTRUCTION FOR 29050001
         BC    8,SETDCB                LNG OF REQUEST, IF ENOUGH        29100001
         BC    2,SETDCB                      CONTIGUOUS STORAGE GO TO   29150001
*                                            ASSIGN AND UPDATE ROUTINE  29200001
         AR    RB,RA                    OTHERWISE BEGIN SEARCH BACKWARD 29250001
*                                            FROM ADDR IN GR2 AS RESULT 29300001
*                                            OF TRT-INSTRUCTION. RB EQ  29350001
*                                            LAST END DISP OF UNGTD     29400001
*                                            AREA                       29450001
         SR    RB,RY                    SUBTRACT TRT ADDR REG (GR2)     29500001
*                                            FROM DISP FOR ZONESZ UN-   29550001
*                                            AVAILABLE                  29600001
         SR    RE,RB                    SUBTRACT THAT AMT FROM ZONESZ   29650001
         CLR   RA,RE               COMPARE REQUEST TO ZONESZ            29700001
         BH    CONTINU5                 IF HIGH GO TO DECREMENT RD,RC   29750001
*                                       OTHERWISE, LOAD TRT-ADDR INTO   29800001
         LR    RB,RY                         RB AND GO TO SEARCH2       29850001
         B     SEARCH2                                                  29900001
*                                       DECREMENT RC,RD CTRS (NUMDEV)   29950001
CONTINU5 LR    RZ,RX                         BY LOADING BFR INFO INTO   30000001
CONTINU6 LA    RX,RY                    RZ, SET RX EQ 1                 30050001
         SR    RC,RX                    SUBTRACT 1 FROM RC CTR          30100001
         SR    RD,RX                    SUBTRACT 1 FROM FROM NUMDEV     30150001
         B     CONTINU3                 GO TO CHECK CTR ROUTINE AND     30200001
*                                            CONTINUE SEARCH IN NEXT    30250001
*                                            ZONE                       30300001
TBLTOP   LR    RC,RD                    SET RC CTR TO RD CTR            30350001
         LA    RZ,RUCB(RBFTBL)     ADD 8 TO ADDR OF BFR TBL IN RZ       30400001
*RZ CONTAINS BFR INFO DISP                                              30450001
         B     CONTINU4                                                 30500001
         EJECT                                                          30550001
*                                                                       30600001
*                        EXECUTE INSTRUCTIONS                           30650001
*                                                                       30700001
         CNOP  2,4                                                      30750001
SEEK1    TRT   0(1,RB),FREESCTN         SEARCH FOR 1ST FREE SECTION     30800001
FREESCTN DC    X'FF'                                                    30850001
         DC    4X'00'                                                   30900001
         CNOP  2,4                                                      30950001
SEEK2    TRT   0(1,RB),CONTIG           SEARCH FOR SUBSEQUENT FREE      31000001
CONTIG   DC    X'00'                    SECTIONS                        31050001
         DC    4X'FF'                                                   31100001
         CNOP  2,4                                                      31150001
ASGSCTN  MVC   1(1,RB),0(RB)            INSERT DEVNDX IN BFR TBL TO     31200001
*                                       INDICATE ASSIGNMENT OF SECTIONS 31250001
         EJECT                                                          31300001
*RETURN CODE ROUTINES                                                   31350001
ERRASG4  EQU   *         CLEAR DCB DONE AT ENABLE1          D11 ZA11442 31400001
         LA    RCODE,TOOBIGAV      REQ GT AVAIL BFR                     31450001
         B     ENABLE      FREELOCKS,ZERO DCBBFST,GIVE MSG  D11 ZA11442 31500001
ERRASG8  EQU   *    CLEAR DCBBFST DONE AT ENABLE1           D11 ZA11442 31550001
         LA    RCODE,TOOBIGZN      REQ GT ZONESIZE                      31600001
         B     ENABLE       FREELOCKS,ZERO DCBBFST,GIVE MSG D11 ZA11442 31650001
ERRDCB1  EQU   *                   DCB NOT OPEN                  S21016 31700001
         LA    RCODE,UNOPEN            LOAD RETURN CODE          S21016 31750001
         B     XCTLOAD3                GO INVOKE MSG MODULE D11  S21016 31800001
ERRDCB2  EQU   *                   DCB/IOB ADDR INVALID          S21016 31850001
         LA    RCODE,DCBBAD                                      S21016 31900001
         B     XCTLOAD3                GO INVOKE MSG MODULE D11  S21016 31950001
ERRDCB3  EQU   *                   NOT A VALID GAM DCB           S21016 32000001
         LA    RCODE,NOTGRPHC          LOAD RETURN CODE          S21016 32050001
         B     XCTLOAD3                GO INVOKE MSG MODULE D11  S21016 32100001
ERRPRM   EQU   *     CLEAR DCBBFSTRT DONE AT ENABLE1        D11 ZA11442 32150001
         LA    RCODE,BFRPRM       ='18'                     D11         32200001
         B     ENABLE1    CLEAR DCB FIELDS,XCTL TO MSGR     D11 ZA11442 32250001
ERRASG   EQU   *                                                 S21016 32300001
         LA    RCODE,NOSECTS           LOAD RETURN CODE          S21016 32350001
         B     ENABLE   FREELOCKS,ZERO DCBBFST,GIVE MSG     D11 ZA11442 32400001
WRITERR  EQU   *                   LOCKS ALREADY FREED                  32450001
         L     RZ,4(RSAVE)    GET AREA SIZE FOR FREEMAIN                32500001
         L     RDSECT,0(RSAVE)     SAVE INPUT REGS                      32550001
         BAL   RE,FREEAREA   FREE SAVE AREA                             32600001
         LR    RY,RDSECT     RESTORE INPUT REGISTER                     32650001
         LA    RCODE,NOCLEAR   LOAD RETURN CODE                         32700001
         B     ENABLE1        GO ZERO DCBBFST,GIVE MSG      D11 ZA11442 32750001
HEADISP  DC    F'40'                                                    32800001
HEAD16   DC    F'16'                   HEADER LNG OF MOD1 BFRTBL        32850001
ONEK     DC    F'1024'                                                  32900001
         DS    0F                                                       32950001
MASKON   DC    4X'FF'                                                   33000001
         EJECT                                                          33050001
ENABLE   GLOBLOCK RELEASE,REGS=(RZ,RA),                     D11 ZA07645X33100001
               RELATED=(ASGNGET,RLSEGET)                    D11 ZA07645 33150001
         LTR   RCODE,RCODE         GOOD RETCODE?            D11 ZA07645 33200001
         BZ    EXIT1               YES,IMMEDIATE EXIT       D11 ZA07645 33250001
ENABLE1  EQU   *                                            D11 ZA11442 33300001
         LA    RA,X'14'            CHECK RETCODE            D11 ZA11442 33350001
         CR    RA,RCODE            IF RESTART,EXIT W 0 ,    D11 ZA11442 33400001
         BE    EXIT1               ELSE ZERO DCB IN USERKEY D11 ZA11442 33450001
         L     RA,CVT              ALL THIS                 D11 ZA11442 33500001
         L     RA,0(RA)            SIMPLY TRIES TO          D11 ZA11442 33550001
         L     RA,4(RA)            GET PTR TO CURR TCB      D11 ZA11442 33600001
         USING TCB,RA              SO WE CAN ...            D11 ZA11442 33650001
         MODESET EXTKEY=TCB,WORKREG=1 GOTO USERKEY          D11 ZA11442 33700001
         XC    DCBBFRST(4,RDCB),DCBBFRST(RDCB) ZERO BFSTRT  D11 ZA11442 33750001
         MODESET EXTKEY=SUPR       BACK TO SUPERKEY         D11 ZA11442 33800001
         DROP  RA                                           D11 ZA11442 33850001
         B     XCTLOAD3            IF HERE,NONZERO RET-XCTL D11 ZA11442 33900001
EXIT1    LR    RY,RDSECT     RESTORE PLIST, REG 1, FOR OPEN             33950001
         LR    RBAL,RCODE   GOOD(EQ 0) OR TSTRT('14') CODE  D11 ZA07645 34000001
         SVC 3                                                          34050001
         TITLE 'RELEASE PORTION OF IGC0007A'                D11         34100001
*********************************************************************** 34150001
*THE RELEASE AND RLSEALL SUBROUTINES RELEASE BUFFER STORAGE BELONGING * 34200001
*TO THE REQUESTING DEVICE AND ARE ACCESSED WHENVER THE RLSEBFR MACRO- * 34250001
*INSTRUCTION IS ISSUED.                                               * 34300001
*********************************************************************** 34350001
         SPACE 3                                                        34400001
RELEASE  L     RX,MASKON                CHECK BUFPRM FOR FULLWORD ONES  34450001
         L     RY,BUFPRM                RY HAS ADDR OF FULLWRD          34500001
         CL    RX,0(RY)            IS FULLWORD EQ TO ONES               34550001
         BE    RLSEALL             YES,THEN GO RELEASE ALL  D11         34600001
*COMPUTE REQUEST AND STARTING ADDRESS TO MULTIPLES OF 256 AFTER MASKING 34650001
*OFF SYSTEM MASK                                                        34700001
*                                                                       34750001
         LH    RA,2(RY)                NUM BYTES TO RELEASE   LB  AOS/1 34800001
         LA    RY,MASK1                 SET RY EQ X'FF'                 34850001
         AR    RA,RY                    CONVERT BYTES TO SECTIONS       34900001
         SRA   RA,8                    PUT REQUEST IN LO ORDER BYTES    34950001
         SR    RX,RX                   ZERO RX                          35000001
         CR    RA,RX                   IS REQUEST GREATER THAN 0        35050001
         BNH   PRMERR                  NO - INVALID PARAM IN            35100001
*                                         HI-ORDER BYTE OF RA           35150001
RLSEGET  GLOBLOCK OBTAIN,REGS=(RB,RC),                      D11 ZA07645*35200001
               RELATED=(RLSEREL,ENABLE)                     D11 ZA07645 35250001
*                                                                       35300001
         BAL   RNSI,INFODISP            GO TO ACCESS INFO DISP ROUTINE  35350001
*                                       LOAD TASGND FOR DEVICE IN RY    35400001
         LH    RX,0(RZ)            SET RX EQ TASGND FOR DEVICE          35450001
         CLR   RA,RX               COMPARE REQUEST TO TASGND            35500001
         BH    ERRLSE16                 GO TO ERROR AND RETURN RTN      35550001
         L     RB,BUFPRM                RB EQ ADDR OF BUFPRM            35600001
         LH    RB,0(RB)                 RB EQ START ADDR                35650001
         SRL   RB,8                     TRUNCATE ADDRESS TO 256-MULTIPL 35700001
*                                            RX EQ DISP IN BFR TBL      35750001
         EJECT                                                          35800001
*CHECK START ADDRESS FOR VALIDITY                                       35850001
*                                                                       35900001
         CLI   UCBTYP,MOD1             MOD 1                D11         35950001
         BNE   EXPCHK                  NO  - BRANCH                     36000001
         A     RB,HEAD16           ADD MOD1 TBL HEADER LNG  D11         36050001
         B     FLOW1               RETURN TO NORMAL FLOW                36100001
EXPCHK   A     RB,HEADISP          ADD A(MOD2 BFRTBLHDR)     D11        36150001
FLOW1    AR    RB,RBFTBL               ADD BUF TBL ADR TO S DISP        36200001
         LR    RY,RB                         RB PTS TO START ADR IN BFR 36250001
*                                            TBL,SAVE RB IN RY          36300001
         LR    RC,RD               LOAD DEVNDX INTO RC                  36350001
         LR    RX,RZ                    SAVE BFR INFO DISP IN RX        36400001
*COMPARE EACH ENTRY FOR LNG OF REQUEST WITH DEVICE INDEX                36450001
         SR    RD,RD                    SET RD EQ 0                     36500001
         LA    RZ,RY                    SET RZ EQ 1                     36550001
         SR    RE,RE                    SET RE EQ 0                     36600001
BXH      BXH   RE,RZ,OUT                WHEN REQUEST HAS BEEN CHECKED   36650001
*                                            GO OUT                     36700001
         IC    RD,0(RB)                 PUT ENTRY IN RD                 36750001
         CLR   RC,RD                   COMPARE DEVNDX TO ENTRY          36800001
         BNE   ERRLSE30                IF UNEQUAL,GO TO ERR RTN  S21016 36850001
         AR    RB,RZ                    INCREMENT ENTRY ADDR BY 1       36900001
         B     BXH                      BRANCH BACK TO REPEAT           36950001
         EJECT                                                          37000001
*CLEAR ENTRIES RELEASED TO ZERO                                         37050001
OUT      SR    RA,RZ                    SUBTRACT 1 FROM REQUEST TO USE  37100001
         EX    RA,CLRENT                     EX-INSTR                   37150001
*UPDATE TABLES,CHECK RESTART ADDR                                       37200001
         AR    RA,RZ                    ADD 1 TO REQUEST TO UPDATE TBLS 37250001
         LR    RZ,RX                    RESTORE BFR INFO DISP TO RZ     37300001
         LH    RX,0(RZ)                 LOAD RX WITH TASGND FOR DEVICE  37350001
         SR    RX,RA                    SUBTRACT REQUEST FROM TASGND    37400001
         STH   RX,0(RZ)                 STORE UPDATED TASGND            37450001
*                                                                       37500001
         LH    RX,6(RBFTBL)             LOAD RX WITH TOTAVAIL FLD       37550001
         AR    RX,RA                    ADD REQUEST TO TOTAVAIL         37600001
         STH   RX,6(RBFTBL)             STORE UPDATED TOTAVAIL IN BFRTB 37650001
RLSEREL  GLOBLOCK RELEASE,REGS=(RD,RE),                     D11 ZA07645*37700001
               RELATED=(RLSEGET)                            D11 ZA07645 37750001
*CHECK RESTART ADDRESS                                                  37800001
         CLI   CODE,X'04'    ENTERED FROM ASGNBFR?                      37850001
         BE    WRITERR       YES,EXIT WITH ERROR-LOCKS ALREADY FREE     37900001
*                                                                       37950001
         LH    RD,UCBSTART          LOAD RESTART ADDR IN RD D11  YM4067 38000001
         SRL   RD,8                     SET RD EQ MULTIPLE-256-DISP     38050001
         CLI   UCBTYP,MOD1             MOD 1                D11         38100001
         BNE   EXPRES                  NO  - BRANCH                     38150001
         A     RD,HEAD16           ADD MOD1 HDRDISP         D11         38200001
         B     FLOW2               RETURN TO NORMAL FLOW                38250001
EXPRES   A     RD,HEADISP          ADD 72(MOD2)TO RD                    38300001
FLOW2    AR    RD,RBFTBL           ADD BFR TBL ADR TO RD,RD NOW         38350001
*                                            HAS ADDR OF BFR TBL ENTRY  38400001
*                                            CONTAINING THAT RESTART AD 38450001
         SR    RE,RE                    CLEAR RE TO ZERO                38500001
         IC    RE,0(RD)                 SET RE EQ TO BFR TBL ENTRY      38550001
         CLR   RC,RE               COMPARE DEVNDX TO ENTRY              38600001
         BE    SUCCESS                                                  38650001
*IF RESTART ADR IS INVALID, SET ADR TO ALL ONES                         38700001
         LH    RX,MASKON           SET RX EQ TO ALL ONES                38750001
         STH   RX,UCBSTART         CHANGE ADR IN UCB        D11  YM4067 38800001
         LA    RCODE,BADADR         LOAD RETURN CODE EQ 20 (X'14')      38850001
         B     ENABLE1             NO LOCKS HELD,NO ZERO    D11 ZA07645 38900001
         EJECT                                                          38950001
ERRLSE16 LA    RCODE,BADRLS                                             39000001
         B     ENABLE   GO FREELOCKS,ZERO DCBBFST & MSG     D11 ZA07645 39050001
ERRLSE30 EQU   *                                                        39100001
         LA    RCODE,BADREL            LOAD RETURN CODE          S21016 39150001
         B     ENABLE  GO FREELOCKS,ZERODCB,GIVE MSG        D11 ZA07645 39200001
PRMERR   EQU   *                                                 S21016 39250001
         LA    RCODE,RELNEG            LOAD RETURN CODE          S21016 39300001
         B     XCTLOAD3   NOT LOCKED,NO ZERO,JUST GIVE MSG  D11 ZA11442 39350001
         CNOP  2,4                                                      39400001
CLRENT   XC    0(1,RY),0(RY)                                            39450001
    TITLE ' SINGLE LOAD 2250 BUFFER MANAGEMENT, RLSEALL  SECTION '      39500001
RIQNDX   EQU   9                                                        39550001
CVTPTR   EQU   16                                             LE AOS/1  39600001
NINTYSIX EQU   96                                             LE AOS/1  39650001
EXIT     EQU   3                                              LE AOS/1  39700001
X08      EQU   X'08'                   REQ CODE FOR REL ALL      S21016 39750001
MISALGN  EQU   X'24'                   RET CODE-INVALID TABLE    S21016 39800001
BADSIZE  EQU   X'10'                   BUFINQ TABLE TOO SMALL    S21016 39850001
TRNCATED EQU   X'20'                   BUFINQ TRUNCATED TABLE    S21016 39900001
         TITLE 'RELEASE ALL SECTION OF IGC0007A'            D11         39950001
*********************************************************************** 40000001
*THE RLSEALL SUBROUTINE ALLOWS THE USER TO RELEASE ALL BUFFER STORAGE * 40050001
*ASSIGNED TO A PARTICULAR DEVICE WITH ONE MACRO INSTRUCTION.          * 40100001
*********************************************************************** 40150001
         SPACE 3                                            D11         40200001
RLSEALL  EQU   *                                                        40250001
RELALLGT GLOBLOCK OBTAIN,REGS=(RA,RD),                      D11 ZA07645*40300001
               RELATED=(RELALLFR,ENABLE)                    D11 ZA07645 40350001
         BAL   RNSI,INFODIS             GO TO RTN  TO LOAD RZ WITH INFO 40400001
*                                            ADDRESS                    40450001
         LR    RD,RE              SAVE DEVNDX FOR FURTHER USE           40500001
         SR    RX,RX                    CLEAR RX TO ZERO                40550001
         LH    RY,0(RZ)            SET RY EQ TASGND                     40600001
         SR    RCODE,RCODE         CLEAR RETCODE-           D11 ZA07645 40650001
         CLR   RX,RY               COMPARE TASGND TO 0                  40700001
         BE    ENABLE          YES,FREELOCKS AND EXIT       D11 ZA07645 40750001
*                                                                       40800001
         LH    RA,0(RZ)                 RA EQ TASGND FOR DEVICE         40850001
         LA    RX,RY                    SET RX EQ 1                     40900001
         LH    RB,0(RBFTBL)             SET RB EQ TO TBLNGTH            40950001
         SR    RB,RX                    SUBTRACT 1 FROM TBLNGTH TO USE  41000001
*                                            IN THE EX-INSTRUCTION      41050001
         LR    RC,RD               LOAD DEVNDX INTO RC                  41100001
         SR    RC,RX                    SUBTRACT 1 FROM DEVNDX          41150001
         SLL   RC,3                     MULTIPLY RC BY 8 TO INDEX TBL   41200001
         LA    RY,TRANALL                                               41250001
         AR    RC,RY                    ADD TRANALL ADDR TO INDEX       41300001
         CLI   UCBTYP,MOD1             MOD 1                D11         41350001
         BNE   NEXPRESS                NO   -  BRANCH                   41400001
         EX    RB,TRALLEX               EXECUTE ANOTHER TR-INSTR        41450001
         B     NSI                      GOON TO UPDATE TABLE            41500001
NEXPRESS EX    RB,TRALL                 EXECUTE TR INSTRUCTION TO TRANS 41550001
*                                            LATE ENTRIES TO ZERO       41600001
         EJECT                                                          41650001
*UPDATE  BFR TBL                                                        41700001
NSI      LH    RE,6(RBFTBL)             LOAD RE WITH TOTAVAIL FLD       41750001
         AR    RE,RA                    ADD TASGND TO TOTAVAIL          41800001
         STH   RE,6(RBFTBL)             STORE UPDATED TOTAVAIL          41850001
         SR    RE,RE                    SET RE TO ZERO                  41900001
         STH   RE,0(RZ)                 SET TASGND FLD TO ZERO          41950001
         LR    RC,RD               LOAD DEVNDX INTO RC                  42000001
RELALLFR GLOBLOCK RELEASE,REGS=(RD,RE),                     D11 ZA07645*42050001
               RELATED=(RELALLGT)                           D11 ZA07645 42100001
         B     RESTART                  GO TO RESTART CHECK             42150001
*                                                                       42200001
         EJECT                                                          42250001
*                                                                       42300001
*CHECK RESTART ADDRESS                                                  42350001
*                                                                       42400001
RESTART  LH    RD,UCBSTART              RESTART ADDR IN RD  D11  YM4067 42450001
         SRL   RD,8                     SET RD EQ MULTIPLE-256-DISP     42500001
         CLI   UCBTYP,MOD1             MOD 1                D11         42550001
         BNE   NEXPRE                  NO  - BRANCH                     42600001
         A     RD,HEAD16           ADD MOD1 HDR             D11         42650001
         B     FLOW                                         D11         42700001
NEXPRE   A     RD,HEADISP              ADD 72 TO RD                     42750001
FLOW     AR    RD,RBFTBL           ADD BFR TBL ADR TO RD,RD NOW         42800001
*                                            HAS ADDR OF BFR TBL ENTRY  42850001
*                                            CONTAINING THAT RESTART AD 42900001
         SR    RE,RE                    CLEAR RE TO ZERO                42950001
         IC    RE,0(RD)                 SET RE EQ TO BFR TBL ENTRY      43000001
         CLR   RC,RE               COMPARE DEVNDX TO ENTRY              43050001
         BE    SUCCESS                                                  43100001
*IF RESTART ADR IS INVALID, SET ADR TO ALL ONES                         43150001
INVALID  LH    RX,MASKON           SET RX EQ TO ALL ONES                43200001
         STH   RX,UCBSTART         CHANGE ADR IN UCB        D11  YM4067 43250001
         LA    RCODE,BADADR         LOAD RETURN CODE EQ 20 (X'14')      43300001
         B     ENABLE1             ZERODCB,GIVE MSG         D11 ZA07645 43350001
         EJECT                                                          43400001
*                                                                       43450001
*            EXECUTE INSTRUCTIONS AND OUT-OF-LINE CODE                  43500001
*                                                                       43550001
         CNOP  2,4                                                      43600001
TRALL    TR    HEADER(1,RBFTBL),0(RC)                                   43650001
         CNOP  2,4                                                      43700001
TRALLEX  TR    16(1,RBFTBL),0(RC)       RLSEALL FOR EXPRESS PROG        43750001
*                                                                     * 43800001
*                                                                       43850001
*                                                                       43900001
INFODIS  SR    RE,RE              CLEAR RE TO ZERO                      43950001
         IC    RE,UCBDI            INSERT DEVNDX IN RE                  44000001
         LR    RZ,RE               LOAD DEVNDX INTO RZ                  44050001
         LA    RX,RY               SET RX EQ 1                          44100001
         SR    RZ,RX               SUBTRACT 1 FROM DEVNDX               44150001
         SLL   RZ,3                MULTIPLY DEVNDX-1 BY 8               44200001
         LA    RD,8(RBFTBL)        SET RD EQ BFRTBL ADR +8              44250001
         AR    RZ,RD               RZ CONTAINS THIS DEVICES INFO DISP   44300001
         BR    RNSI                               RETURN                44350001
         TITLE 'BUFFER INQUIRY SECTION OF IGC0007A'         D11         44400001
*********************************************************************** 44450001
*                                                                     * 44500001
*THE BUFINQ SUBROUTINE ALLOWS THE USER TO OBTAIN A TABLE OF ADDRESSES * 44550001
*OF THE BUFFER STORAGE ASSIGNED TO THAT DISPLAY UNIT.                 * 44600001
*                                                                     * 44650001
*********************************************************************** 44700001
*CHECK TABLE ADDR PASSED AS PARAMETER FOR VALIDITY                      44750001
BUFINQ   TM    TABADR+3,X'03'      TEST FOR FULLWORD ALIGNMENT          44800001
         BC    5,PREPMSG1          PREPARE FOR IFF532I        LE AOS/1  44850001
         L     RC,TABSIZ           SET RC EQ SIZE OF TABLE IN BYTES     44900001
         L     RB,TABADR           SET RB EQ ADDR OF TABLE              44950001
         LA    RX,RB               SET RX EQ 4                          45000001
         CR    RX,RC               IS TABSIZ LESS THAN 4-BYTES,IF YES   45050001
         BH    PREPMSG2            PREPARE FOR IFF533I        LE AOS/1  45100001
         L     RE,CVT              GET                      D11 ZA11442 45150001
         L     RE,0(RE)            TO                       D11 ZA11442 45200001
         L     RE,4(RE)            CURRENT                  D11 ZA11442 45250001
         USING TCB,RE              TCB                      D11 ZA11442 45300001
         MODESET EXTKEY=TCB,WORKREG=2  GOTO USERKEY         D11 ZA11442 45350001
         BAL   RNSI,INFODIS                                             45400001
         LH    RA,0(RZ)            SET RA EQ TASGND                     45450001
         SR    RZ,RZ               SER RZ TO 0                          45500001
         CR    RZ,RA               IS TASGND EQ ZERO, IF SO INSERT      45550001
         BE    INSERT                   RESTART, TAB END IND AND RETURN 45600001
         LH    RZ,UCBSTART         OTHERWISE INSERT RESTART D11  YM4067 45650001
         ST    RZ,0(RB)            AND BEGIN SEARCH                     45700001
         SR    RZ,RZ               SET RZ EQ TO ZERO                    45750001
         STH   RZ,0(RB)            SET 1ST HALFWORD TO ZERO             45800001
         LA    RD,RY               SET RD EQ 1                          45850001
         SR    RE,RD               SUBTRACT 1 FROM DEVNDX IN RE         45900001
         SLL   RE,4                MULTIPLY RE BY 16                    45950001
         LA    RD,INQTAB           LOAD INQ TRT TAB ADR IN RD           46000001
         AR    RE,RD               ADD ADDR TO INDEX FORMED FROM DEVNDX 46050001
         LH    RD,TBLNGTH          SET RD EQ TABLE LENGTH               46100001
         LA    RX,RY               SET RX EQ 1                          46150001
         SR    RD,RX               SUBTRACT 1 FROM TBLNGTH TO USE IN EX 46200001
         LR    RIQNDX,RBFTBL       EXECUTE SEARCH FOR FIRST SECTION     46250001
         CLI   UCBTYP,MOD1             MOD 1                D11         46300001
         BNE   MODINQ              NO BRANCH                            46350001
         LA    RX,16               SET RX EQ 16             D11         46400001
         AR    RIQNDX,RX           ADD 16 TO RIQNDX         D11         46450001
         LA    RX,RB               RESET RX TO 4 BEFORE RET D11         46500001
         B     CHECK2              RETURN TO NORMAL FLOW    D11         46550001
MODINQ   A     RIQNDX,HEADISP      FOR BASIC MOD ADD 72                 46600001
         LA    RX,RB                SET RX EQ TO 4                      46650001
CHECK2   SR    RC,RX               SUBTRACT 4 FROM TABSIZ               46700001
         AR    RB,RX               ADD 4 TO TAB ADDR                    46750001
         CR    RX,RC               CHECK TABSIZ AND AMT ASGND CTRS      46800001
         BH    CHECK1              IF SIZE LESS THAN 4 CHECK FURTHER    46850001
         SR    RZ,RZ               SET RZ EQ 0                          46900001
         CR    RZ,RA               TASGND EQ 0 ?                        46950001
         BE    ENDIND              GO TO INSERT TAB END IND AND RETURN  47000001
         EJECT                                                          47050001
*                                                                       47100001
*SEARCH BFR TABLE FOR DEVICE'S SECTIONS                                 47150001
*                                                                       47200001
INQUIRE  EX    RD,TRTINQ           SEARCH FOR SECTION BELONGING TO DEV  47250001
*COMPUTE START NG BFR ADDRESS AND PUT IN TABLE                          47300001
         SR    RY,RIQNDX           SET RY TO LNG FROM STRT OF SEARCH    47350001
         SR    RD,RY               TO STOP BYTE TO ADJUST TBLNGTH       47400001
         AR    RY,RIQNDX           SET RY BACK TO STOP-BYTE ADR         47450001
         LR    RIQNDX,RY           SAVE STOP-BYTE ADR OF TRT            47500001
         CLI   UCBTYP,MOD1             MOD 1                D11         47550001
         BNE   NEXPSUB             NO - BRANCH                          47600001
         LA    RX,16               SET RX E Q 16            D11         47650001
         SR    RY,RX               SUBTRACT HEADISP         D11         47700001
         B     BACK                RETURN TO NORMAL FLOW    D11         47750001
NEXPSUB  S     RY,HEADISP          SUBTRACT 72 FROM STOP-BYTE ADR       47800001
BACK     SR    RY,RBFTBL           SUBTRACT BFRTBL ADR FROM STOP-BYTE   47850001
*                                       ADDR TO GET AT ACTUAL BFR CORE  47900001
*                                       ADDR                            47950001
         SLL   RY,8                MULTIPLY DISP BY 256 TO GET REAL ADR 48000001
         STH   RY,0(RB)            MOVE START ADDR IN TABLE             48050001
         LR    RY,RIQNDX           RESTORE STOP-BYTE ADR IN RY          48100001
*COMPUTE LENGTH OF CONTIGUOUS SECTIONS IN BYTES                         48150001
         LA    RX,RY               SET RX EQ 1                          48200001
*                                  CLEAR RZ TO ZERO                     48250001
GETLNG   AR    RY,RX               ADD 1 TO ADR TO CHECK NEXT ENTRY     48300001
         CLC   36(1,RUCB),0(RY)    COMPARE DEVNDX TO NEXT ENTRY         48350001
         BE    GETLNG              IF EQ GO ON TO NEXT ENTRY AND COMP   48400001
         SR    RY,RIQNDX           SUBTRACT TO GET NUM OF CONTIGUOUS    48450001
*                                       SECTIONS IN RY                  48500001
         SR    RD,RY               ADJUST TBLNGTH FOR NEXT TRT          48550001
         SR    RA,RY               SUBTRACT NUMBER FROM TASGND          48600001
         AR    RIQNDX,RY           ADJUST NEW START ADR FOR TRT         48650001
*COMPUTE LNG IN BYTES AND MOVE INTO TABLE                               48700001
*                                                                       48750001
         SLL   RY,8                MULTIPLY SECTIONS BY 256 FOR BYTES   48800001
         STH   RY,2(RB)            STORE LNG OF CONTIG BYTES IN TABLE   48850001
         LA    RX,RB               SET RX EQ 4 TO UPDATE CTRS           48900001
         B     CHECK2              BEGIN SEARCH AGAIN FOR NEXT ENTRIES  48950001
INSERT   LH    RZ,UCBSTART         RZ SET EQ RESTART ADR    D11  YM4067 49000001
         ST    RZ,0(RB)            PUT RESTART ADR IN TABLE             49050001
         SR    RZ,RZ               SET RZ EQ TO ZERO                    49100001
         STH   RZ,0(RB)            SET 1ST HALFWORD TO ZERO             49150001
         SR    RC,RX               SUBTRACT 4 FROM TABSIZ               49200001
         CR    RX,RC               IS TABSIZ LESS THAN 4, IF YES RETURN 49250001
         BH    CODE0                    WITH CODE X'00'                 49300001
*                                                                       49350001
         AR    RB,RX               OTHERWISE ADD 4 TO TABADR            49400001
ENDIND   L     RZ,MASKON           SET RZ EQ ALL ONES                   49450001
         ST    RZ,0(RB)            INSERT TABLE END INDICATOR           49500001
         B     CODE0               RETURN TO CALLER                     49550001
PREPMSG1 EQU   *                                              LE AOS/1  49600001
         L     RA,ADDR1            ADDRESS OF IFF532I         LE AOS/1  49650001
         LA    RA,D0(RA,RBASE)         INTO RA                LB  AOS/1 49700001
         LA    RD,LGTH1            LENGTH OF MESSAGE          LE AOS/1  49750001
         LA    RE,MISALGN          WRONG ALIGNMENT RET CODE   LE AOS/1  49800001
         B     ISSUEMSG            GO ISSUE WTO               LE AOS/1  49850001
PREPMSG2 EQU   *                                              LE AOS/1  49900001
         L     RA,ADDR2            ADDRESS OF IFF533I         LE AOS/1  49950001
         LA    RA,D0(RA,RBASE)         INTO RA                LB  AOS/1 50000001
         LA    RD,LGTH2            LENTH OF MESSAGE 2         LE AOS/1  50050001
         LA    RE,BADSIZE          LOAD BAD SIZE RET CODE     LE AOS/1  50100001
         B     ISSUEMSG            GO ISSUE WTO               LE AOS/1  50150001
PREPMSG3 EQU   *                                              LE AOS/1  50200001
         MODESET EXTKEY=SUPR ONLY MSG3 DETECTED IN USERKEY  D11 ZA11442 50250001
         L     RA,ADDR3            ADDRESS OF IFF534I         LE AOS/1  50300001
         LA    RA,D0(RA,RBASE)         INTO RA                LB  AOS/1 50350001
         LA    RD,LGTH3            LENGTH OF MESSAGE          LE AOS/1  50400001
         LA    RE,TRNCATED         TRUNCATED RET CODE         LE AOS/1  50450001
* RA (REG3) CONTAINS THE MESSAGE ADDRESS                      LE AOS/1  50500001
* RD (REG6) CONTAINS THE MESSAGE  LNGTH                       LE AOS/1  50550001
* RE (REG7) CONTAINS THE RETURN CODE                          LE AOS/1  50600001
ISSUEMSG EQU   *                                              LE AOS/1  50650001
         L     RB,CVTPTR           ADDR OF CVT                LE AOS/1  50700001
         L     RB,RX(RB)           ADDR OF TCB PTR            LE AOS/1  50750001
         L     RB,RB(RB)           CURRENT TCB ADDRESS        LE AOS/1  50800001
         L     RB,D0(RB)               CURRENT RB ADDR                  50850001
         LA    RB,NINTYSIX(RB)     ADDR OF SVRB EXTENDED      LE AOS/1  50900001
         LR    RC,RB               PRIME RC                   LE AOS/1  50950001
         LA    RB,RB(RB)               RB=RB+4                LE  AOS/1 51000001
         MVC   RX(GMLNG,RB),GMLIST GM LIST TO SVRB EXT        LE AOS/1  51050001
         GETMAIN A=(RC),MF=(E,(RB)) GET MSG BUFFER EXT        LE AOS/1  51100001
         LTR   RBAL,RBAL           GM SUCCESSFUR?             LE AOS/1  51150001
         BNZ   SKIPWTO             NO                         LE AOS/1  51200001
* RB POINTS TO GETMAINED AREA                                 LE AOS/1  51250001
         L     RZ,RX(RC)           MSG BUFFER ADDRESS         LE AOS/1  51300001
         EX    RD,MOVELIST         MESSAGE TO BUFFER          LE AOS/1  51350001
         WTO   MF=(E,(RZ))    ISSUE WTO                       LE AOS/1  51400001
         FREEMAIN A=(RC),MF=(E,(RB)) FREE MSG BUFFER          LE AOS/1  51450001
SKIPWTO  EQU   *                                              LE AOS/1  51500001
         LR    RBAL,RE             RETURN CODE IN REG 15    D11  AOS/1  51550001
         SVC   EXIT                RETURN                               51600001
CHECK1   SR    RZ,RZ               SET RZ EQ 0                          51650001
         CR    RZ,RA               IS TASGND EQ 0, IF NOT RETURN CODE   51700001
         BNE   PREPMSG3            PREPARE FOR IFF534I        LE AOS/1  51750001
*                  OTHERWISE RETURN WITH CODE X'00'                     51800001
CODE0    MODESET EXTKEY=SUPR       BACK TO SUPERKEY         D11 ZA07645 51850001
         SR    RCODE,RCODE         INDICATE RETCODE EQ 0    D11 ZA11442 51900001
         B     EXIT1               RETURN W CODE=0          D11 ZA07645 51950001
         TITLE 'IGC0007A CONSTANTS AND DSECTS'                          52000001
*                                                                     * 52050001
TRANALL  DC   X'0000020304050607'                                       52100001
         DC    X'0001000304050607'                                      52150001
         DC    X'0001020004050607'                                      52200001
         DC    X'0001020300050607'                                      52250001
INQTAB   DC    X'00010000000000000000000000000000'                      52300001
         DC    X'00000100000000000000000000000000'                      52350001
         DC    X'00000001000000000000000000000000'                      52400001
         DC    X'00000000010000000000000000000000'                      52450001
         DC    X'00000000000100000000000000000000'                      52500001
         DC    X'00000000000001000000000000000000'                      52550001
         DC    X'00000000000000010000000000000000'                      52600001
         DC    X'00000000000000000100000000000000'                      52650001
*                                                                     * 52700001
*                                                                     * 52750001
         CNOP  2,4                                                      52800001
         SPACE 5                                                        52850001
TRTINQ   TRT   0(1,RIQNDX),0(RE)   SEARCH INSTRUCTION                   52900001
         CNOP  0,4                                                      52950001
ADDR1    DC    A(MSG1-ORG)         ADDRESS OF MSG 1           LE AOS/1  53000001
ADDR2    DC    A(MSG2-ORG)         ADDRESS OF MESSAGE 2       LE AOS/1  53050001
ADDR3    DC    A(MSG3-ORG)         ADDRESS OF MESSAGE 3       LE AOS/1  53100001
         EJECT                                                          53150001
MSG1     WTO   'IFF532I BUFINQ FOUND TABLE NOT ALIGNED ON FULL-WORD',ROX53200001
               UTCDE=11,DESC=7,MF=L                           LE AOS/1  53250001
         SPACE                                                          53300001
LGTH1    EQU   *-MSG1                                         LE AOS/1  53350001
         SPACE 3                                                        53400001
MSG2     WTO   'IFF533I BUFINQ FOUND TABLE SIZE LESS THAN FOUR',ROUTCDEX53450001
               =11,DESC=7,MF=L                                LE AOS/1  53500001
         SPACE                                                          53550001
LGTH2    EQU   *-MSG2                                         LE AOS/1  53600001
         SPACE 3                                                        53650001
MSG3     WTO   'IFF534I BUFINQ TRUNCATED TABLE',ROUTCDE=11,DESC=7,MF=L  53700001
         SPACE                                                          53750001
* THE FOLLOWING INFORMATION APPLIES TO MSG 3:                 LE AOS/1  53800001
LGTH3    EQU   *-MSG3                                         LE AOS/1  53850001
GMLIST   GETMAIN EC,LV=80,MF=L     GM FOR MESSAGE AREA        LE AOS/1  53900001
GMLNG    EQU   *-GMLIST                                       LE AOS/1  53950001
MOVELIST MVC   RX(RX,RZ),RX(RA)                               LE AOS/1  54000001
UCBLEN   DC    AL2(UCBBTB+L'UCBBTB-UCBOB+UCBCURPX) FOR 2250 D11 ZA07645 54050001
UCBPRFXL DC    AL2(UCBCURPX)       UCB LOCKWORD PREFIX LEN  D11 ZA07645 54100001
PATCH    DC    C'IGC0007A 40 BYTE PATCH AREA'               D11         54150001
         DS    0H   ITS NICE WHEN PATCH IS ON INST BOUND    D11         54200001
         DC    40X'FF'            PATCH AREA                D11         54250001
         EJECT                                                          54300001
*                                                                       54350001
*                         DSECTS                                        54400001
*                                                                       54450001
         SPACE 3                                                        54500001
BFRTBL   DSECT                                                          54550001
TBLNGTH  DS    CL2                                                      54600001
NUMDEV   DS    CL2                                                      54650001
EXPBFR   DS    CL2                                                      54700001
TOTAVAIL DS    CL2                                                      54750001
TASGND   DS    CL2                                                      54800001
DISP     DS    CL2                                                      54850001
ZONESZ   DS    CL2                                                      54900001
TG       DS    CL2                                                      54950001
         DS    CL56                                                     55000001
DVCASGND DS    CL128                                                    55050001
         SPACE 3                                                        55100001
PARLST   DSECT                          DSECT FOR PARAM LIST PASSED     55150001
CODE     DS    CL1                      REQUEST CODE                    55200001
DCBADR   DS    CL3                      DCB-ADDRESS                     55250001
BUFPRM   DS    CL4                      BUFPRAM PTR                     55300001
         ORG   BUFPRM                                                   55350001
TABADR   DS    CL4                      TABLE-ADDRESS                   55400001
TABSIZ   DS    CL4                      TABLE SIZE                      55450001
         EJECT                                                          55500001
         IHAPSA                                                         55550001
         EJECT                                                          55600001
         IKJTCB                                                         55650001
         EJECT                                              D11         55700001
         IEFUCBOB LIST=YES,PREFIX=YES                       D11         55750001
         END                                                            55800001
./  ADD  SSI=43530785,NAME=IGC0007C
         TITLE 'GRAPHIC SPECIFY ATTENTION ROUTINE'                      00050002
*********************************************************************** 00100002
*                                                                       00150002
* MODULE NAME:           IGC0007C (OS/VS2)                              00200002
*                                                                       00250002
* DESCRIPTIVE NAME:      GRAPHIC SPECIFY ATTENTION ROUTINE              00300002
*                                                                       00350002
* COPYRIGHT:             NONE                                           00400002
*                                                                       00450002
* STATUS:                RELEASE 2.0                                    00500002
* FUNCTION:              THIS MODULE PERFORMS:                          00550002
*                                                                       00600002
*FUNCTION:MAKE USER ATTENTION ROUTINE AVAILABLE FOR USE BY SYSTEM.      00650002
*        1.ENSURE A GACB NOT SPARED MORE THAN ONCE.                     00700002
*        2.CREATE AN IRB AND IQE FOR USER ROUTINE.                      00750002
*        2A. LOADS IGG019OK, ATTENTION INQUIRY MODULE                   00800002
*        3.CREATE A ROUTINE ENTRY BLOCK(REB) FOR EACH GACB SPARED.      00850002
*        4.PLACE REB INTO LIST OF REBS ACCORDING TO USER ASSIGNED       00900002
*        PRIORITY.                                                      00950002
*        5.UPDATE TASK ENTRY BLOCK'S(TE) REB CHAIN.                     01000002
*FILL IN FROM SPECS******CONTINUED*NEXT*PAGE*************************** 01050002
         EJECT                                                          01100002
*ENTRY:VIA SVC 73 FROM P/P                                              01150002
*INPUT:GR#1 POINTS TO PARAMETER LIST                                    01200002
*OUTPUT:1.IRB                                                           01250002
*       2.IQE                                                           01300002
*       3.REB                                                           01350002
*       4.UNIQUE RETURN CODES                                           01400002
*EXTERNAL ROUTINES:N/A                                                  01450002
*EXIT:VIA SVC 73                                                        01500002
*TABLES/WORK AREAS:N/A                                                  01550002
*ATTRIBUTES:1.RE-ENTRANT                                                01600002
*           2.SUPERVISOR STATE                                          01650002
*           3.PRIVILEDGED                                               01700002
*           4.OPERATES ENABLED AND DISABLED                             01750002
*NOTES:N/A                                                              01800002
* CHANGE ACTIVITY:       MODULE HAS BEEN RESTRUCTURED TO CONSOLIDATE    01850002
*                                                                       01900002
*                        FIXES DROPPED LIST:                            01950002
*                                                                       02000002
*********************************************************************** 02050002
*                                                                       02100002
IGC0007C CSECT                                                          02150002
* 019800,022000-022200,022800,026400-026600,053800-054000        S21016 02200002
* 056400                                                      LB  AOS/1 02250002
*C023000                                                         Y01021 02300002
*A096600-09690,A097100,A077100-077200,A179600,D095000        LG @ZM2357 02310000
*D058500,A097200,A165500,A160600,A166100,A161500             LG @ZM2357 02320000
         EJECT                                                          02350002
*                                                                       02400002
*                                  STANDARD SYSTEM REGISTERS ---        02450002
*                                                                       02500002
         SPACE 3                                                        02550002
PAREG0   EQU   0                       PARAM REG 0                      02600002
PAREG1   EQU   1                       PARAM REG 1                      02650002
RBASE    EQU   2                       BASE REGISTER                    02700002
LENREG   EQU   3                       LOOP COUNT REG                   02750002
GACBR    EQU   4                       GACB ADR REG                     02800002
PARMR    EQU   5                       PARM LIST ADR REG                02850002
RLISTC   EQU   6                       CURRENT LIST PTR                 02900002
RUCB     EQU   7                       UCB ADR PTR                      02950002
RTE      EQU   8                       TE ADR PTR                       03000002
R9       EQU   9                       WORK REG                         03050002
R10      EQU   10                      WORK REG                         03100002
R11      EQU   11                      WORK REG                         03150002
R12      EQU   12                      WORK REG                         03200002
R13      EQU   13                                                       03250002
R14      EQU   14                                                       03300002
RCODE    EQU   15                      RETURN CODE REGISTER             03350002
         EJECT                                                          03400002
*          CONSTANTS USED IN THIS MODULE                              * 03450002
*                                                                     * 03500002
MULTI    EQU   X'20'                   INDICATE MULTIPLE DEVICES ON REB 03550002
DEBETNT  EQU   16                      OFFSET TO DEB # OF EXTENTS       03600002
LENGTH   EQU   2                       DISP.TO LENGTH OF LIST PARAM     03650002
NEXT     EQU   4                       CONSTANT INCREMENT               03700002
ONE      EQU   1                       CONSTANT                         03750002
EXIT     EQU   3                       EXIT SVC NO.                     03800002
NOADR    EQU   X'0C'                    NO GACB ADR RET. CODE           03850002
NOTGRPHC EQU   X'04'                   DCB NOT GRAPHIC RET CODE  S21016 03900002
UODCB    EQU   X'10'                   DCB NOT OPEN RET CODE     S21016 03950002
OFLGS    EQU   48                      OFLGS FIELD OF DCB               04000002
OPEN     EQU   X'10'                   OPEN BIT                         04050002
DSORG    EQU   27                      DCB  DSORG DISP-                 04100002
GRAPHIC  EQU   X'80'                   GRAPHIC DSORG BIT                04150002
DEB      EQU   44                      DISP.TO DEB ADR                  04200002
UCB      EQU   32                      DISP.TO UCB ADR                  04250002
UTEADR   EQU   28                      USER TE ADR                      04300002
STEADR   EQU   32                      GRAPHIC INITIATOR TE ADR         04350002
TERTN    EQU   4                       ADDR OF 1ST ROUTINE ENTRY BLOCK  04400002
TETCB    EQU   8                       TCB PTR                          04450002
TEFLGS   EQU   20                      TE FLAGS                         04500002
TEGASIRB EQU   24                      GAS IRB PTR                      04550002
TEGIR    EQU   28                      GRAPHIC INTERFACE RTN EP PTR     04600002
TE       EQU   X'80'                   TE FLAG                          04650002
RENO     EQU   X'40'                   INDICATES RTNB POINTS TO A TE    04700002
RTNF     EQU   0                       LINK FIELD LOWER PRIORITY        04750002
RTNB     EQU   4                       LINK FIELD HIGHER PRIORITY       04800002
RTNUCB   EQU   8                       UCB PTR                          04850002
RTNGACB  EQU   12                      GACB PTR                         04900002
RTNIRB   EQU   16                      IRB ADR                          04950002
RTNFLGS  EQU   20                      FLAGS                            05000002
PRTY     EQU   22                      PRIORITY                         05050002
RTNTCB   EQU   32                      OFFSET FOR REB TCB ADR           05100002
RTNQ2    EQU   28                      QUEUE LIST                       05150002
PGACB    EQU   X'08'                   PREVIOUSLY SPARED                05200002
IQE      EQU   100                                                      05250002
RSVD     EQU   40                                                       05300002
ATTN     EQU   48                  IGG019OK-ADR DISPLACEMENT IN GACB    05350002
NXTAVL   EQU   96                      IRB NEXT AVL FLD                 05400002
IRBIQE   EQU   8                       IRB ADR                          05450002
IQETCB   EQU   12                      TCB PTR                          05500002
OFF      EQU   X'FF'-RENO              RESET MASK FOR REB TE FLAG       05550002
ZEROO    EQU   0                       ZERO                             05600002
CVTPTR   EQU   16                      PTR TO CVT                       05650002
CURTCB   EQU   4                       OFFSET OF CURRENT TCB VIA CVT    05700002
MVTERR   EQU   X'14'                                                    05750002
JSTCB    EQU   124                                                      05800002
XDUMY    EQU   X'00'                    IMMED. OPERAND        LB  AOS/1 05900002
         EJECT                                                          05950002
         BALR  RBASE,0                 SET UP BASE REGISTER             06000002
         USING *,RBASE                 DEFINE BASE REGISTER             06050002
         B     *+24                                                     06100002
MODID    DC    C'IGC0007C.VS2R2.74337'          MODULE EYECATCHER ID    06150000
         LA    R10,ZEROO               ZERO MULTI DEVICE REG            06200002
         LR    PARMR,PAREG1            SAVE PARAM LIST ADR              06250002
         LA    RLISTC,NEXT(0,PARMR)    LOAD PTR TO CURRENT ENTRY        06300002
         SR    LENREG,LENREG           CLEAR REGISTER                   06350002
         LH    LENREG,LENGTH(PAREG1)   LOAD LENGTH OF PARAM LIST        06400002
         LA    R12,ONE                 LOAD CONSTANT                    06450002
         SR    LENREG,R12              DETERMINE NO. OF GACB ADRS.      06500002
         LTR   LENREG,LENREG           ARE THERE ANY GACB ADRS.         06550002
         BC    3,SP01                  BRANCH IF YES                    06600002
         LA    RCODE,NOADR             LOAD RETURN CODE                 06650002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 06700002
*                                                                       06750002
SP01     L     GACBR,0(0,RLISTC)       LOAD GACB ADR                    06800002
         LTR   GACBR,GACBR             GACB ADR=0                       06850002
         BC    8,SPLOOP                BRANCH IF YES                    06900002
         L     RUCB,NEXT(0,GACBR)      LOAD DCB  ADR                    06950002
         LTR   RUCB,RUCB               DCB ADR=0                        07000002
         BC    8,SPLOOP                BRANCH IF YES                    07050002
         TM    OFLGS(RUCB),OPEN        IS DCB OPENED                    07100002
         BC    1,SP02                  BRANCH IF YES                    07150002
SP03     LA    RCODE,UODCB             INDICATE INVALID DCB             07200002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 07250002
*                                                                       07300002
SP02     TM    DSORG(RUCB),GRAPHIC     IS IT A GRAPHIC DCB              07350002
         BC    1,SP02A                 BRANCH AROUND PD ROUTINES        07400002
         LA    RCODE,NOTGRPHC          LOAD RET CODE             S21016 07450002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 07500002
         EJECT                                                          07550002
SP02A    EQU   *                                                 S21016 07600002
         LA    RUCB,ZEROO(RUCB)        CLEAR HI-BYTE DCB ADDR LB Y01021 07650002
         DEBCHK (RUCB),TYPE=VERIFY,AM=GAM   VALIDATE DEB      LB Y01021 07700002
         LTR   RCODE,RCODE           CK RET CODE             LG @ZM2357 07710000
         BNZ   SP03                                          LG @ZM2357 07720000
         LR    RUCB,PAREG1             DEB ADDRESS            LB Y01021 07750002
         CLI   DEBETNT(RUCB),ONE       IS THIS A MULTI-DEVICE DEB       07800002
         BC    8,SP14                  BRANCH IF NO                     07850002
         LA    R10,UCB(0,RUCB)         LOAD PTR TO FIRST UCB ADR PTR    07900002
         SR    R13,R13                 CLEAR REG                        07950002
         IC    R13,DEBETNT(RUCB)       INSERT # OF EXTENTS              08000002
SP14     L     RUCB,UCB(0,RUCB)        LOAD UCB ADR                     08050002
         LA    RUCB,ZEROO(0,RUCB)      CLEAR HI ORDER BYTE              08100002
         L     RTE,UTEADR(0,RUCB)      LOAD USER TE ADR                 08150002
         LTR   RTE,RTE                 TEST IF TE ADR EXIST             08200002
         BC    8,SPLOOP                BRANCH IF NO                     08250002
         TM    TEFLGS(RTE),TE          IS THIS A TASK ENTRY BLOCK       08300002
         BC    14,SPLOOP               BRANCH IF NO                     08350002
         L     R9,RSVD(GACBR)          LOAD GACB REB FIELD              08400002
         LTR   R9,R9                   TEST IF REB ADR EXITS            08450002
         BC    8,SP23                  BRANCH IF NO                     08500002
         LA    RCODE,PGACB             INDICATE PREVIOUSLY SPARED       08550002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 08600002
*                                                                       08650002
*                   PICK UP CURRENT TCB ADDRESS                         08700002
*                                                                       08750002
SP23     L     R14,CVTPTR              LOAD ADR OF CVT                  08800002
         L     R14,ZEROO(R14)          LOAD PTR TO TCB DOUBLE WORD      08850002
         L     R14,CURTCB(R14)         LOAD CURRENT TCB ADDRESS         08900002
         LA    R14,ZEROO(R14)          CLEAR HI-ORDER BYTE              08950002
         L     R9,TETCB(RTE)           LOAD TE TCB ADR                  09000002
         LA    R9,ZEROO(R9)             CLEAR HI-ORDER BYTE             09050002
         CR    R14,R9                  CURRENT TCB EQU TETCB (MVT?)     09100002
         BNE   SPMVT                   BRANCH IF NO                     09150002
         EJECT                                                          09200002
*                                                                       09250002
SP05     L     PAREG0,TEGIR(0,RTE)     LOAD INTERFACE ROUTINE ADR       09300002
         CIRB  EP=(0),SVAREA=YES,WKAREA=4                               09350002
         LR    R12,PAREG1              SAVE IRB ADR                     09400002
         LOAD  EP=IGG019OK         LOAD ATTNINQ CONTROL SECTION         09450002
         LR    R9,PAREG0             SAVE ADDRESS IGG0190K   LG @ZM2357 09500000
         L     PAREG0,REQUEST          BYTE REQUEST TO PARAM REG        09550002
         GETMAIN R,LV=(0)                                               09600002
         XC    0(40,PAREG1),0(PAREG1)  CLEAR CORE                       09650002
         USING TCB,R14               R14 HAS TCB ADDR        LG @ZM2357 09660000
         MODESET  EXTKEY=TCB,WORKREG=11  SET KEY TO USER     LG @ZM2357 09670000
         LR    PAREG0,R9             RESTORE PAREG0          LG @ZM2357 09680000
         ST    PAREG0,ATTN(GACBR)    STR ADDR IN GACB+48     LG @ZM2357 09690000
         ST    PAREG1,RSVD(GACBR)      STORE REB ADR IN GACB            09700002
         MODESET  EXTKEY=SUPR                                LG @ZM2357 09710000
         DROP  R14                                           LG @ZM2357 09720000
         ST    GACBR,RTNGACB(PAREG1)   GACB ADR TO REB                  09750002
         LTR   R10,R10                 REG=0                            09800002
         BC    8,SP15                  BRANCH IF YES                    09850002
         ST    R10,RTNUCB(PAREG1)      STORE PTR TO LIST OF UCB PTRS    09900002
         OI    RTNFLGS(PAREG1),MULTI   INDICATE UCB ADR IS A PTR AND    09950002
*                                      NOT A UCB ADR                    10000002
         STC   R13,RTNFLGS+1(PAREG1)   STORE # OF EXTENTS IN REB        10050002
         B     SP16                    BRANCH                           10100002
SP15     ST    RUCB,RTNUCB(PAREG1)     STORE UCB ADR IN REB             10150002
SP16     ST    R12,RTNIRB(PAREG1)      IRB ADR TO REB                   10200002
         ST    R14,RTNTCB(PAREG1)      STORE CURRENT TCB ADR IN REB     10250002
         L     R9,ZERO                 LOAD ZERO                        10300002
         IC    R9,0(PARMR)             INSERT PRIORITY                  10350002
         STH   R9,PRTY(PAREG1)         PRIORITY TO REB                  10400002
         XC    NXTAVL(32,R12),NXTAVL(R12)   ZERO CORE                   10450002
         LA    R9,IQE(0,R12)           LOAD IQE ADR                     10500002
         ST    R9,NXTAVL(R12)          STORE IN IRB NEXT AVL FLO        10550002
         ST    R12,IRBIQE(R9)          IRB ADR TO IQE                   10600002
         ST    R14,IQETCB(R9)          STORE CURRENT TCB ADR IN IQE     10650002
         L     R9,TERTN(0,RTE)         LOAD REB PTR (FIRST)             10700002
         LTR   R9,R9                   ANY REBS                         10750002
         BC    7,SP08                  BRANCH IF YES                    10800002
         CLI   ENABL1,XDUMY             FORCE PAGE-IN         LB  AOS/1 10850002
         EJECT                                                          10900002
*        SSM   ZERO                    DISABLE ALL INTERRUPTS           10950002
         ST    RTE,RTNB(PAREG1)        TE ADR TO RTNB FLD               11000002
         OI    RTNFLGS(PAREG1),RENO    INDICATE PTR TO A TE             11050002
         ST    PAREG1,TERTN(RTE)       REB ADR TO TE                    11100002
*        SSM   SYSMSK                  ENABLE                           11150002
ENABL1   EQU   *                        END OF DISABLED CODE  LB  AOS/1 11200002
SPLOOP   LA    RLISTC,NEXT(0,RLISTC)   INCREMENT CURRENT LIST PTR       11250002
         LA    R10,ZEROO               ZERO MULTI DEVICE REG            11300002
         BCT   LENREG,SP01             BRANCH IF MORE GACBS TO SERVICE  11350002
         L     RCODE,ZERO              LOAD RETURN CODE                 11400002
         SVC   EXIT                    RETURN TO USER                   11450002
SP08     CLC   PRTY(2,R9),PRTY(PAREG1) NEW PRIORITY HIGHEST             11500002
         BC    2,SP09                  BRANCH IF NO                     11550002
         BC    8,SP11                  BRANCH IF PRIORITYS EQUAL        11600002
         CLI   ENABL2,XDUMY             FORCE PAGE-IN         LB  AOS/1 11650002
*        SSM   ZERO                    DISABLE ALL INTERRUPTS           11700002
SP13     MVC   RTNF(4,PAREG1),TERTN(RTE) MOVE LOWER PRTY REG ADR TO     11750002
*                                        RTNF FLD OF HIGHEST PRTY REB   11800002
         MVC   RTNB(4,PAREG1),RTNB(R9) MOVE LOWER PRTY REB RTNB FLD     11850002
*                                      TO HIGHER PTRY REB RTNB FLD      11900002
         OI    RTNFLGS(PAREG1),RENO    INDICATE HIGHER PRTY REB RTNB    11950002
*                                      FLD POINTS TO A TE               12000002
         ST    PAREG1,RTNB(R9)         PLACE HIGHER PRTY REB ADR INTO   12050002
*                                      RTNB FLD OF LOWER PRTY REB       12100002
         NI    RTNFLGS(R9),OFF         TURN OFF TE FLAG IN LOWER        12150002
*                                      PRTY REB                         12200002
         ST    PAREG1,TERTN(RTE)       NEW HI PRTY REB ADR TO TE REB FD 12250002
*        SSM   SYSMSK                  ENABLE                           12300002
ENABL2   EQU   *                        END OF DISABLED CODE  LB  AOS/1 12350002
         B     SPLOOP                  BRANCH                           12400002
SP09     CLC   RTNF(4,R9),ZERO         IS THERE A LOWER PRTY REB        12450002
         BC    7,SP10                  BRANCH IF YES                    12500002
         CLI   ENABL3,XDUMY             FORCE PAGE-IN         LB  AOS/1 12550002
*        SSM   ZERO                    DISABLE ALL INTERRUPTS           12600002
         ST    PAREG1,RTNF(R9)         REB ADR TO LOWER PRTY REB PTR IN 12650002
*                                      RTNF FLD OF HIGER PRTY REB       12700002
         ST    R9,RTNB(PAREG1)         SET LOWER PRTY REB RTNB FLD TO   12750002
*                                      POINT TO HIGHER PRTY REB         12800002
*        SSM   SYSMSK                  ENABLE                           12850002
ENABL3   EQU   *                        END OF DISABLED CODE  LB  AOS/1 12900002
         B     SPLOOP                  BRANCH                           12950002
         EJECT                                                          13000002
SP10     L     R9,RTNF(0,R9)           LOAD ADR OF NEXT LOWER PRTY REB  13050002
         CLC   PRTY(2,R9),PRTY(PAREG1) PRESENT REB PRTY HIGHER THAN     13100002
*                                      NEW REB PRTY                     13150002
         BC    2,SP09                  BRANCH IF YES                    13200002
         BC    8,SP11                  BRANCH IF PRTYS EQUAL            13250002
         B     SP12                    BRANCH                           13300002
SP11     TM    RTNFLGS(R9),MULTI       PRESENT REB CONTAIN UCB ADR      13350002
         BC    1,SP17                  BRANCH IF NO                     13400002
         TM    RTNFLGS(PAREG1),MULTI   NEW REB CONTAIN UCB ADR          13450002
         BC    1,SP18                  BRANCH IF NO                     13500002
         B     SP19                    BRANCH                           13550002
SP17     TM    RTNFLGS(PAREG1),MULTI   NEW REB CONTAIN UCB ADR          13600002
         BC    1,SP19                  BRANCH IF NO                     13650002
         B     SP21                    BRANCH                           13700002
SP19     CLC   RTNUCB+1(3,R9),RTNUCB+1(PAREG1)   UCB ADRS EQUAL         13750002
         BC    7,SP09                  BRANCH IF NO                     13800002
         B     SP12                    BRANCH                           13850002
SP18     SR    R13,R13                 CLEAR REG                        13900002
         IC    R13,RTNFLGS+1(PAREG1)   IN SERT  # OF EXTENTS            13950002
         L     R10,RTNUCB(PAREG1)      LOAD PTR TO UCB ADRS             14000002
SP20     CLC   RTNUCB+1(3,R9),ONE(R10)  UCB ADRS COMPARE                14050002
         BC    8,SP12                   BRANCH IF YES                   14100002
         LA    R10,NEXT(0,R10)         LOAD PTR TO NEXT UCB ADR         14150002
         BCT   R13,SP20                BRANCH IF MORE TO CHECK          14200002
         B     SP09                     BRANCH                          14250002
SP21     L     R10,RTNUCB(0,R9)         LOAD PTR TO UCB PTRS            14300002
         SR    R13,R13                  CLEAR REG                       14350002
         IC    R13,RTNFLGS+1(R9)        INSERT # OF EXTENTS             14400002
SP22     CLC   RTNUCB+1(3,PAREG1),ONE(R10) UCB ADRS COMPARE             14450002
         BC    8,SP12                  BRANCH IF YES                    14500002
         LA    R10,NEXT(0,R10)         LOAD PTR TO NEXT UCB ADR         14550002
         BCT   R13,SP22                BRANCH IF MORE                   14600002
         B     SP09                    BRANCH                           14650002
SP12     EQU   *                                              LB  AOS/1 14700002
         CLI   ENABL4,XDUMY             FORCE PAGE-IN         LB  AOS/1 14750002
*        SSM   ZERO                     DISABLE INTERRUPTS              14800002
         TM    RTNFLGS(R9),RENO        PRESENT POINT TO A TE            14850002
         BC    1,SP13                  BRANCH IS YES                    14900002
         L     R11,RTNB(0,R9)          LOAD PREVIOUS REB ADR            14950002
         MVC   RTNF(4,PAREG1),RTNF(R11) MOVE PREVIOUS REB RTNF FLD TO   15000002
*                                       NEW PREVIOUS REB RTNF FLD TO    15050002
         ST    PAREG1,RTNF(R11)        SET PREVIOUS REB RTNF FLD TO     15100002
*                                      ADR OF NEW REB                   15150002
         MVC   RTNB(4,PAREG1),RTNB(R9) SET NEW REB RTNB EQUAL PRESENT   15200002
*                                      REB RTNB FLD                     15250002
         ST    PAREG1,RTNB(R9)         SET PRESENT REB RTND FLD EQUAL   15300002
*                                      NEW REB ADR                      15350002
*        SSM   SYSMSK                  ENABLE                           15400002
ENABL4   EQU   *                        END OF DISABLED CODE  LB  AOS/1 15450002
         B     SPLOOP                  BRANCH                           15500002
         EJECT                                                          15550002
*                                                                       15600002
*                   BEGIN OPTION 4 CHECK FOR VIOLATIONS                 15650002
*                                                                       15700002
SPMVT    LR    R12,R14                 LOAD ADDRESS OF CURRENT TCB      15750002
         L     PAREG1,JSTCB(R12)       LOAD JOBSTEP TCB ADR             15800002
         LA    PAREG1,ZEROO(PAREG1)    CLEAR HI-ORDER BYTE              15850002
         CR    R12,PAREG1              CURRENT TCB = JOBSTEP TCB        15900002
         BNE   SPMVT01                 BRANCH IF NO                     15950002
SPMVT00  LA    RCODE,MVTERR            LOAD RETURN CODE - VIOLATES MVT  16000002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 16050002
         USING TCB,R12                                       LG @ZM2357 16060000
*                                                                       16100002
SPMVT01  L     R11,TCBOTC        LOAD TCB'S ORIGINATING TCB  LG @ZM2357 16150000
SPMVT02  LA    R11,ZEROO(R11)          CLEAR HI-ORDER BYTE              16200002
         LTR   R11,R11                 CHECK FOR ZERO         LB  AOS/1 16250002
         DROP  R12                                           LG @ZM2357 16260000
         BZ    SPMVT00                 ERROR IF TCBOTC=0      LB  AOS/1 16300002
         CR    R9,R11                  DOES TCBOTC = TETCB              16350002
         BE    SP05                                                     16400002
         CR    R11,PAREG1              TCBOTC = JOBSTEP TCB             16450002
         BE    SPMVT00                 BRANCH IF YES                    16500002
         USING TCB,R11                                       LG @ZM2357 16510000
         L     R11,TCBOTC                                    LG @ZM2357 16550000
         B     SPMVT02                                                  16600002
         DROP  R11                                           LG @ZM2357 16610000
         EJECT                                                          16650002
XCTLMSG  EQU   *                       SET UP TO XCTL TO MSG RTN S21016 16700002
         LR    R7,RCODE                PASS RETURN CODE          S21016 16750002
         L     R9,CVTPTR               CVT ADDRESS               S21016 16800002
         L     R9,D0(R9)               ADDR TCB WORDS            S21016 16850002
         L     R9,D4(R9)               CURRENT TCB ADDR          S21016 16900002
         L     R9,D0(R9)               CURRENT RB ADDR           S21016 16950002
         LA    RCODE,D96(R9)           ADDR SUPVSR PARM LIST     S21016 17000002
         LA    R9,D104(R9)             ADDR FOR EP NAME          S21016 17050002
         ST    R9,D0(RCODE)            WORD1=ADDR EP NAME        S21016 17100002
         SR    R9,R9                                             S21016 17150002
         ST    R9,D4(RCODE)            WORD2=0 (DCB ADDR)        S21016 17200002
         MVC   D8(D8,RCODE),EPMSGRTN   NAME OF MSG RTN           S21016 17250002
         XCTL  MF=(E,(1)),SF=(E,(15))  TRANSFER CONTROL          S21016 17300002
EPMSGRTN DC    CL8'IGC0107C'           NAME FOR MSG MODULE       S21016 17350002
R7       EQU   7                                                 S21016 17400002
D0       EQU   0                                                 S21016 17450002
D4       EQU   4                                                 S21016 17500002
D8       EQU   8                                                 S21016 17550002
D96      EQU   96                                                S21016 17600002
D104     EQU   104                                               S21016 17650002
         DS    0F                                                       17700002
ZERO     DC    1F'0'                                                    17750002
REQUEST  DC    X'E9'                    SP 233 FOR REB        LB  A0S/1 17800002
         DC    AL3(40)                 BYTE REQUEST FOR REB             17850002
SYSMSK   DC    2XL1'FF'                                                 17900002
         CNOP  0,8                                                      17950002
         IKJTCB                                              LG @ZM2357 17960000
         END                                                            18000002
./  ADD  SSI=32760148,NAME=IGC0007D
*TITLE 'DELETE ATTENTION ROUTINE'                                       00300002
*STATUS:CHANGE LEVEL 0                                                  00600002
*FUNCTION:DELETE ROUTINES SPECIFIED BY SPAR.                            00900002
*        1.ENSURES AN ACTIVE ROUTINE CANNOT DELETE ITSELF.              01200002
*        2.FREES UP                                                     01500002
*         A.REB                                                         01800002
*         B.IRB                                                         02100002
*         C.IQES                                                        02400002
*        3.UPDATES TE REB CHAIN                                         02700002
*ENTRY:VIA SVC 74 FROM P/P                                              03000002
*INPUT:GR#1 POINTS TO PARAMETER LIST                                    03300002
*OUTPUT:1.SEE FUNCTION                                                  03600002
*       2.UNIQUE RETURN CODES                                           03900002
*EXTERNAL ROUTINES:N/A                                                  04200002
*EXIT:VIA SVC 73                                                        04500002
*TABLES/WORK AREAS:N/A                                                  04800002
*ATTRIBUTES:1.RE-ENTRANT                                                05100002
*           2.SUPERVISOR STATE                                          05400002
*           3.PRIVILEDGED                                               05700002
*           4.OPERATES ENABLED AND DISABLED                             06000002
*NOTES:N/A                                                              06300002
*                                                                       06600002
*        REGISTER DEFINITION                                            06900002
*                                                                       07200002
IGC0007D CSECT                                                          07250002
*A96700-98100,A102600-104400,A261200-263400,A333100-337400       A28803 07300002
*A775000-776000                                                  A28803 07350002
*D336000                                                         A28803 07400002
*                                                                A28803 07450002
* 096700-098100,102600-104400,261200-263400,306000-309000        S21016 07460002
* 333100-342000,348000,354000,372000-375000,381000,462000        S21016 07470002
* 441000,786000,792000,798000                                 LB  AOS/1 07480002
*C357000                                                         Y01021 07490002
         EJECT                                                          07492002
R0       EQU   0                       PARAM REG                        07500002
R1       EQU   1                       PARAM REG                        07800002
RBASE    EQU   2                       BASE REG                         08100002
RPARM    EQU   3                       PARAMETER LIST PTR               08400002
RPARMC   EQU   4                       CURRENT PARAMETER LIST PTR       08700002
RLEN     EQU   5                       LENGTH OF LIST                   09000002
RGACB    EQU   6                       GACB ADR                         09300002
R7       EQU   7                       WORK REG                         09600002
R8       EQU   8                       WORK REG                         09900002
R9       EQU   9                       WORK REG                         10200002
R10      EQU   10                      WORK REG                         10500002
RDCB     EQU   11                      DCB ADR                          10800002
REBRG    EQU   12                      REB ADR                          11100002
R13      EQU   13                      SAVE PTR                         11400002
R14      EQU   14                      RTN REG                          11700002
RCODE    EQU   15                      RTN  CODE REG                    12000002
         EJECT                                                          12300002
*          CONSTANTS USED IN THIS MODULE                              * 12350002
*                                                                     * 12400002
LENGTH   EQU   2                       PARAMETER LIST LENGTH            13200002
IRBIQE   EQU   100                     ADR OF IQE CREATED IN IRB        13500002
NEXAVL   EQU   96                      IQE NEXT AVAILABLE FIELD         13800002
ZERO     EQU   0                       ZERO                             14100002
NEXT     EQU   4                       FOUR                             14400002
ONE      EQU   1                       ONE                              14700002
RTNOTFND EQU   X'08'                   ROUTINE NOT FOUND                15000002
EXIT     EQU   3                       SVC EXIT #                       15300002
SHORTLST EQU   X'0C'                    LIST LENGTH WRONG               15600002
BADDCB   EQU   X'04'                   INVALID DCB                      15900002
OPEN     EQU   X'10'                   OPEN BIT IN OFLGS                16200002
ABENDON  EQU   29                                                       16500002
ABENDIN  EQU   33                                                       16800002
GRAPHIC  EQU   X'80'                   GRAPHIC BIT IN DSORG+1           17100002
REB      EQU   40                      REB ADR IN GACB                  17400002
RTNF     EQU   0                       LINK FLD                         17700002
RTNB     EQU   4                       LINK FLD                         18000002
RTNGACB  EQU   12                      GACB PTR                         18300002
RTNIRB   EQU   16                      IRB ADR IN REB                   18600002
FLAGS    EQU   20                      REB FLAG FLD                     18900002
RTNTCB   EQU   32                      OFFSET FOR REB TCB ADR           19200002
RTNQ2    EQU   28                      REB IQES PTR                     19500002
DEB      EQU   44                      DEB ADR                          19800002
UCB      EQU   32                      UCB ADR                          20100002
TE       EQU   28                      TE ADR                           20400002
TERTN    EQU   4                       REB PTR                          20700002
RBIQE    EQU   24                      ACTIVE IQE PTR                   21000002
IRB      EQU   16                      IRB ADR                          21300002
ACTIVE   EQU   X'10'                    ROUTINE ACTIVE                  21600002
MVTERR   EQU   X'14'                                                    21900002
NOTOPEN  EQU   X'18'                   RET CODE-DCB NOT OPEN     S21016 21970002
NOTGRPHC EQU   X'1C'                   RET CODE-DCB NOT GRAPHIC  S21016 22040002
NOTBASIC EQU   X'20'                   RET CODE-NOT BASIC ENVIRONS21016 22110002
RENO     EQU   X'40'                   REB POINTS TO TE BIT             22200002
NORMAL   EQU   0                       ZERO RTN CODE                    22500002
CVTPTR   EQU   16                      POINTER TO CVT                   22800002
CVTBTERM EQU   52                                                       23100002
CURTCB   EQU   4                       CURRENT TCB OFFSET               23400002
FLAG     EQU   29                                                       23700002
ABEND    EQU   X'80'                                                    24000002
CLSDAR   EQU   47                                                       24300002
RBSTAB2  EQU   11                       OFFSET OF STATUS BYTE 2   M4120 24600002
*                                            OF REQUEST BLOCK     M4120 24900002
IRBACTIV EQU   X'40'                    FLAG BYTE TO INDICATE     M4120 25200002
*                                            THE INTERRUPT        M4120 25500002
*                                            REQUEST BLOCK IS     M4120 25800002
*                                            ACTIVE               M4120 26100002
XDUMMY   EQU   X'00'                   IMMED. OPERAND         LB  AOS/1 26170002
GACB0    EQU   0                       GACB DISPLACEMENT      LB  AOS/1 26240002
GACBEND  EQU   55                      GACB DISPLACEMENT(END) LB  AOS/1 26310002
         EJECT                                                          26400002
         USING IHADCB,RDCB                                              26450002
         BALR  RBASE,R0                                                 26700002
         USING *,RBASE                                                  27000002
         B     *+24                                                     27050002
MODID    DC    C'IGC0007D.VS2R2.73263'          MODULE EYECATCHER ID    27100002
         LR    RPARM,R1                PARAM TO WORK REG                27600002
         LA    RPARMC,NEXT(0,RPARM)    LOAD CURRENT PARAM(ADR OF 1ST    27900002
*                                      GACB)                            28200002
         SR    RLEN,RLEN               CLEAR REGISTER                   28500002
         LH    RLEN,LENGTH(0,RPARM)    LOAD LIST LENGTH                 28800002
         LA    R7,ONE                  LOAD ONE                         29100002
         SR    RLEN,R7                 REDUCE LENGTH BY ONE             29400002
         LTR   RLEN,RLEN               REG=0                            29700002
         BC    3,DAR01                 BRANCH IF NOT ZERO               30000002
         LA    RCODE,SHORTLST          LOAD ERROR CODE                  30300002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 30700002
DAR01    L     RGACB,ZERO(0,RPARMC)    LOAD GACB  ADR                   31200002
         LA    RGACB,ZERO(0,RGACB)     CLEAR HI ORDER BYTE              31500002
         LTR   RGACB,RGACB             ADR=0                            31800002
         BC    8,DAR02                 BRANCH IF YES                    32100002
         L     RDCB,NEXT(RGACB)         LOAD DCB ADR                    32400002
         LA    RDCB,ZERO(0,RDCB)       ZERO HI ORDER BYTE               32700002
         LTR   RDCB,RDCB               REG=0                            33000002
         BC    7,DAR03                 BRANCH IF NO                     33300002
DAR04    LA    RCODE,BADDCB            LOAD RETURN CODE                 33700002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 34100002
DAR03    TM    DCBOFLGS,OPEN           IS DCB OPEN                      34500002
         BO    DAR03A                  BRANCH IF DCB OPEN        S21016 34600002
         LA    RCODE,NOTOPEN           LOAD RETURN CODE          S21016 34700002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 34800002
DAR03A   EQU   *                                                 S21016 34900002
         TM    DCBDSORG+1,GRAPHIC      IS IT A GRAPHIC DCB              35100002
         BO    DAR03B                  BRANCH IF DCB GRAPHIC     S21016 35200002
         LA    RCODE,NOTGRPHC          LOAD RETURN CODE          S21016 35300002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 35400002
         EJECT                                                          35450002
DAR03B   EQU   *                                                 S21016 35500002
         DEBCHK (RDCB),TYPE=VERIFY,AM=GAM   VALIDATE DEB      LB Y01021 35600002
         LR    R7,R1                   DEB ADDRESS            LB Y01021 35700002
         L     R7,UCB(0,R7)            LOAD UCB ADR                     36000002
         L     R7,TE(0,R7)             LOAD TE ADR                      36300002
         LTR   R7,R7                   TE ADR=0                         36600002
         BC    7,DAR05                 BRANCH IF NOT 0                  36900002
         LA    RCODE,NOTBASIC          LOAD RETURN CODE          S21016 37200002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 37500002
DAR05    CLC   TERTN+1(3,R7),ZERO1     ARE THERE ANY RTN ENTRIES        37800002
         BNE   DAR05A                  RTN ENTRIES-SKIP ERROR EX S21016 37900002
DAR07    LA    RCODE,RTNOTFND          LOAD RETURN CODE                 38000002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 38100002
DAR05A   EQU   *                                                 S21016 38200002
         L     REBRG,TERTN(0,R7)       LOAD FIRST REB PTR               38400002
DAR09    CLC   RTNGACB+1(3,REBRG),ONE(RPARMC) GACB ADRS COMPARE         38700002
         BC     8,DAR00                                                 39000002
         CLC   RTNF+1(3,REBRG),ZERO1   ANY MORE REBS                    39300002
         BC    8,DAR07                 BRANCH IF NO                     39600002
         L     REBRG,RTNF(0,REBRG)     LOAD NEXT REB PTR                39900002
         B     DAR09                   BRANCH                           40200002
*                                                                       40500002
*                   PICK UP CURRENT TCB ADR                             40800002
*                                                                       41100002
DAR00    L     R13,CVTPTR              LOAD ADR OF CVT                  41400002
         L     R13,ZERO(R13)           LOAD ADR OF TCB DOUBLE WORD      41700002
         L     R13,CURTCB(R13)         LOADCURRENT TCB ADR              42000002
         LA    R13,ZERO(R13)           CLEAR HIGH-ORDER BYTE            42300002
         L     R7,REB(RGACB)           LOAD REB ADR FROM GACB           42600002
         L     R7,RTNTCB(R7)           LOAD REB TCB ADR                 42900002
         LA    R7,ZERO(R7)             CLEAR HIGH-ORDER BYTE            43200002
         CR    R13,R7                  DOES CURRENT TCB = REBTCB        43500002
         BNE   DARMVT                  BRANCH IF NO                     43800002
DAR20    EQU   *                                              LB  AOS/1 44100002
         CLI   GACB0(RGACB),XDUMMY     FORCE PAGE-IN OF GACB  LB  AOS/1 44160002
         CLI   GACBEND(RGACB),XDUMMY   *BEFORE DISABLING      LB  AOS/1 44220002
         CLI   ENABL1,XDUMMY           FORCE PAGE-IN          LB  AOS/1 44280002
SSM1OFF  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGC0007D(*44340002
               SSM1ON)),REGS=USE                                        44370002
         XI    CLSDAR(RGACB),X'01'     TURN GACB FLG OFF SET BY CLOSE   44400002
         L     R7,IRB(0,REBRG)         LOAD IRB ADDRESS                 44700002
         CLC   RBIQE+1(3,R7),ZERO1     IQE ACTIVE                       45000002
         BC    8,DAR11                 BRANCH IF NO                     45300002
SSM1ON   SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGC0007D(SSM1OFF)), *45600002
               REGS=USE                                                 45700002
         LA    RCODE,ACTIVE            LOAD RETURN CODE                 45900002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 46200002
DAR11    TM    FLAGS(REBRG),RENO       POINT TO A TE                    46500002
         BC    1,DAR12                 BRANCH IF YES                    46800002
         CLC   RTNF+1(3,REBRG),ZERO1   LAST REB IN LAST                 47100002
         BC    7,DAR13                 BRANCH IF NO                     47400002
         L     R8,RTNB(REBRG)          LOAD PREVIOUS REB ADR            47700002
         MVC   ZERO(4,R8),ZERO1        ZERO PREVIOUS RTNF FLD           48000002
         MVC   REB(4,RGACB),ZERO1      ZERO REB PTR IN GACB             48300002
DAR14    EQU   *                                                        48600002
SSM2ON   SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGC0007D(SSM1OFF)), *48650002
               REGS=USE                                                 48750002
         LA    R8,IRBIQE(0,R7)         LOAD ADR OF THE IQE CREATED      48900002
*                                      IN THE IRB                       49200002
DAR17    CLC   NEXAVL+1(3,R7),ZERO1    ANY IQES ON IRB                  49500002
         BC    8,DAR16                 BRANCH IF NO                     49800002
         L     R9,NEXAVL(0,R7)         LOAD IQE ADR                     50100002
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               50400002
         MVC   NEXAVL+1(3,R7),ONE(R9)  UPDATE IRB NEXAVL FLD            50700002
         CLR   R8,R9                   IS THIS THE IQE CREATED          51000002
*                                      IRB                              51300002
         BC    8,DAR17                 BRANCH IF YES                    51600002
         LR    R1,R9                   IQE ADR TO PARAM REG             51900002
         L     R0,XTRAIQE          LOAD REQUEST FOR USER IQE            52200002
         FREEMAIN R,LV=(0),A=(1)                                        52500002
         B     DAR17                   BRANCH                           52800002
DAR16    CLC   RTNQ2+1(3,REBRG),ZERO1  ANY IQES ON REB Q2 FLD           53100002
         BC    8,DAR18                 BRANCH IF NO                     53400002
         L     R9,RTNQ2(0,REBRG)       LOAD IQE ADR                     53700002
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               54000002
         MVC   RTNQ2+1(3,REBRG),ONE(R9) UPDATE QI PTR FLD IN REB        54300002
         CLR   R8,R9                   IS THIS THE IQE CREATED IN       54600002
*                                      THE IRB                          54900002
         BC    8,DAR16                 BRANCH IF YES                    55200002
         LR    R1,R9                   IQE ADR TO PARAM REG             55500002
         L     R0,XTRAIQE          LOAD REQUEST FOR USER IQE            55800002
         FREEMAIN R,LV=(0),A=(1)                                        56100002
         B     DAR16                   BRANCH                           56400002
DAR18    TM    FLAG(R13),ABEND         ABEND IN PROGRESS                56700002
         BC    1,DAR02                 BRANCH IF YES                    57000002
         TM    RBSTAB2(R7),IRBACTIV     IS THIS IRB ACTIVE        M4120 57300002
         BO    DAR02                    IF YES TAKE BRANCH        M4120 57600002
         L     R1,0(R7)                LOAD PP SVAREA ADR FROM IRB      57900002
         L     R0,REQUEST2             LOAD SVAREA LNGTH                58200002
         FREEMAIN  R,LV=(0),A=(1)      FREE PP SVAREA                   58500002
         DELETE  EP=IGG019OK           DELETE ATTNINQ RTN               58800002
         XC    48(4,RGACB),48(RGACB)        CLEAR ATTNINQ ADR TO ZERO   59100002
         LR    R1,R7                   LOAD IRB ADR TO PARAM REG        59400002
         L     R0,REQUEST1             LOAD # OF BYTES                  59700002
         FREEMAIN R,LV=(0),A=(1)                                        60000002
         LR    R1,REBRG                REB ADR TO PARAM REG             60300002
         L     R0,REQUEST              LOAD NUMBR OF BYTES              60600002
         FREEMAIN R,LV=(0),A=(1)                                        60900002
DAR02    LA    RPARMC,NEXT(0,RPARMC)   STEP TO NEXT GACB ADR PTR        61200002
         BCT   RLEN,DAR01              BRANCH IF MORE GACBS TO SERVICE  61500002
         LA    RCODE,NORMAL            LOAD RET CODE                    61800002
         SVC   EXIT                    RETURN TO IOS                    62100002
DAR12    CLC   RTNF(3,REBRG),ZERO1     LAST REB                         62400002
         BC    7,DAR15                 BRANCH IF NO                     62700002
         L     R9,RTNB(0,REBRG)        LOAD TE PTR                      63000002
         MVC   TERTN(4,R9),ZERO1                                        63300002
         MVC   REB(4,RGACB),ZERO1      ZERO REB PTR IN GACB             63600002
         B     DAR14                   BRANCH                           63900002
DAR15    L     R9,RTNB(0,REBRG)        LOAD TE PTR                      64200002
         MVC   TERTN(4,R9),RTNF(REBRG) MOVE LINK FLD TO TE              64500002
         L     R10,RTNF(0,REBRG)       LOAD ADR OF NEXT REB             64800002
         MVC   RTNB(4,R10),RTNB(REBRG) UPDATE CHAIN                     65100002
         OI    FLAGS(R10),RENO         INDICATE REB PTS TO A TE         65400002
         MVC   REB(4,RGACB),ZERO1      ZERO REB PTR IN GACB             65700002
         B     DAR14                   BRANCH                           66000002
DAR13    MVC   REB(4,RGACB),ZERO1      ZERO REB PTR IN GACB             66300002
         L     R14,RTNB(0,REBRG)       LOAD PTR                         66600002
         L     R13,RTNF(0,REBRG)       LOAD PTR                         66900002
         MVC   RTNF(4,R14),RTNF(REBRG) PRESENT RTNF TP PREVIOUS RTNF    67200002
         MVC   RTNB(4,R13),RTNB(REBRG) PRESENT RTNB TO NEXT RTNB        67500002
         B     DAR14                   BRANCH                           67800002
ENABL1   EQU   *                       END OF DISABLED CODE   LB  AOS/1 67900002
         EJECT                                                          67950002
*                                                                       68100002
*                   PREVENT OPTION 4 VIOLATIONS                         68400002
*                                                                       68700002
DARMVT   TM    CLSDAR(RGACB),X'01'     DID CLOSE ISSUE  DAR             69000002
         BC    1,DARMVT1               BRANCH IF YES                    69300002
         LA    RCODE,MVTERR            LOAD RETURN CODE                 69600002
         B     XCTLMSG                 GO INVOKE MSG RTN         S21016 70000002
*                                                                       70500002
DARMVT1  TM    ABENDON(R7),X'80'       IS REBTCB IN ABEND               70800002
         BC    7,DAROUT                BRANCH IF YES                    71100002
         TM    ABENDIN(R7),X'40'       IS REBTCB TO BE ENDED BY ABEND   71400002
         BC    1,DAROUT                BRANCH IF YES                    71700002
         O     R7,HIBITON              SET CLOSE ERROR FOR 7D LB        72700002
         B     XCTLMSG1                GO INVOKE MSG RTN      LB        73700002
DAROUT  XI   CLSDAR(RGACB),X'01'       TURN FLG OFF SET BY CLOSE        76500002
         SVC   EXIT                                                     76800002
         EJECT                                                          76802002
XCTLMSG  EQU   *                       SET UP TO XCTL TO MSG RTN S21016 76810002
         LR    R7,RCODE                PASS RETURN CODE          S21016 76820002
XCTLMSG1 EQU   *                                                        76825002
         L     R9,CVTPTR               CVT ADDRESS               S21016 76830002
         L     R9,D0(R9)               ADDR TCB WORDS            S21016 76840002
         L     R9,D4(R9)               CURRENT TCB ADDR          S21016 76850002
         L     R9,D0(R9)               CURRENT RB ADDR           S21016 76860002
         LA    RCODE,D96(R9)           ADDR SUPVSR PARM LIST     S21016 76870002
         LA    R9,D104(R9)             ADDR FOR EP NAME          S21016 76880002
         ST    R9,D0(RCODE)            WORD1=ADDR EP NAME        S21016 76890002
         SR    R9,R9                                             S21016 76900002
         ST    R9,D4(RCODE)            WORD2=0 (DCB ADDR)        S21016 76910002
         MVC   D8(D8,RCODE),EPMSGRTN   NAME OF MSG RTN           S21016 76920002
         XCTL  MF=(E,(1)),SF=(E,(15))  TRANSFER CONTROL          S21016 76930002
EPMSGRTN DC    CL8'IGC0107D'           NAME FOR MSG MODULE       S21016 76940002
D0       EQU   0                                                 S21016 76950002
D4       EQU   4                                                 S21016 76960002
D8       EQU   8                                                 S21016 76970002
D96      EQU   96                                                S21016 76980002
D104     EQU   104                                               S21016 76990002
         DS    0F                                                       77100002
HIBITON  DC    X'80000000'             OPERAND TO SET BIT 0             77200002
ZERO1    DC    1F'0'                                                    77400002
DISABLE  DC    AL1(0)                                                   77700002
ENABLE   DC    X'FF'                                                    78000002
         DS    0F                                                       78300002
XTRAIQE  DC    X'EA'                   SP 234 FOR USER IQE    LB  AOS/1 78600002
         DC    AL3(32)                                                  78900002
REQUEST  DC    X'E9'                   SP 233 FOR REB         LB  AOS/1 79200002
         DC    AL3(40)                 BYTE REQUEST FOR REB             79500002
REQUEST1 DC    X'E9'                   SP 233 FOR IRB         LB  AOS/1 79800002
         DC    AL3(128)                                                 80100002
REQUEST2 DC    X'FA'                   SUBPOOL 250                      80400002
         DC    AL3(72)                 PP SVAREA LENGTH                 80700002
         CNOP  0,8                                                      81000002
         EJECT                                                          81050002
         DCBD  DSORG=GS                                                 81300002
         IHAPSA                                                         81400002
         END                                                            81600002
./  ADD  SSI=80950316,NAME=IGC0007E
         TITLE 'DEQUEUE ROUTINE'                            D11         00050000
*TITLE 'DEQUEUE ROUTINE'                                                00100000
*STATUS:CHANGE LEVEL 0                                                  00150000
*FUNCTION:PERFORM MODIFICATIONS TO PROTECTED CORE FOR ATTENTION         00200000
*   INQUIRY ROUTINE.                                                    00250000
*        1.CLEAR ALL DATA FROM REQUESTING ROUTINE'S         D11         00300000
*        INTERNAL QUEUE.(NOTE: ONE IQE MUST BE LEFT         D11         00350000
*        FOR SYSTEM TO REMOVE)                                          00400000
*        2.SELECTIVELY DEQUEUE DATA FROM REQUESTOR'S IRB OR INTERNAL    00450000
*        QUEUE AND MAKE DATA AVAILABLE IN COMAREA.                      00500000
*        3.UPDATE ALL MANIPULATED QUEUES.                               00550000
*        4.NOTIFY ATTENTION INQUIRY ROUTINE AS TO WHETHER DATA WAS      00600000
*        FOUND.                                                         00650000
*ENTRY:VIA SVC 75 FROM ATTENTION INQUIRY ROUTINE                        00700000
*INPUT:MODE=CLEAR:                                                      00750000
*       1.GR#0=RBIQE ADR                                                00800000
*       2.GR#1=GACB  ADR                                                00850000
*      ALL OTHER MODES:                                                 00900000
*       1.GR0=0                                                         00950000
*       2.GR1-HIORDER BYTE-INDEX TO 2260 FROM WHICH         D11         01000000
*                          DATA IS TO BE DEQUEUED.          D11         01050000
*            -LO-ORDER BYTES=GACB ADDRESS                   D11         01100000
*OUTPUT:MODE CLEAR:                                                     01150000
*       1.DATA REMOVED                                                  01200000
*         INVALID DCB,DEB,GACB,IQE RC=8                     D11 ZA04885 01250000
*       ALL OTHER MODES:                                                01300000
*       1.DATA TO COMAREA AND RC=X'04'                                  01350000
*       2.RC=X'00'                                                      01400000
*       ALL MODES; INV DCB,DEB,GACB ADDR RC X'08'           D11 ZA04885 01450000
*EXTERNAL ROUTINES:N/A                                                  01500000
*EXIT:VIA SVC 3                                                         01550000
*TABLES/WORK AREAS:N/A                                                  01600000
*ATTRIBUTES:1.PRIVILEDGED                                               01650000
*           2.RE-ENTRANT                                                01700000
*           3.SUPERVISOR STATE                                          01750000
*           4.OPERATES BOTH WITH/WITHOUT LOCAL LOCK HELD.   D11         01800000
*NOTE:N/A                                                               01850000
           EJECT                                            E12 ZA20103 01900000
IGC0007E CSECT                                                          01950000
*                                                                       02000000
* 2342,0390-0392,0400                                              6999 02050000
* 036600,038600                                                         02100000
* C016720,A017620-017712,A021104,D026450-026600,D028400,     LD YA01241 02150000
* A028540,D034450-034600,D036600-036660,D036860-036920,      LD YA01241 02200000
* C043400,A043520,D044570,A049900                            LD YA01241 02250000
* A017680,A017720                                             LD YM5168 02300000
* D27000-28200                                              LG @ZA00524 02350000
*A017705-017849,A034500-034720,A026804                       LG @ZM2361 02400000
*A026500-026740,A034900,A054720,A004900                      LG @ZM2361 02450000
*A016860-016920                                              LG @ZM2361 02500000
*A004300,C004900,A008700,016962-016990,C017789,017809,      D11 ZA04885 02550000
*A017810-017819,C017829,A036808-036976,C037000              D11 ZA04885 02600000
*A000100,050000-050100                                      D11         02650000
*C016985,017818,036920                                      D11 ZA10042 02700000
*C017813                                                    D11 ZA13202 02750000
*A006404,A006780,A016994,C036864                            E12 ZA20103 02800000
*A010250,C017804-017807,C017813,C017819,C019600-0200000     E12 ZA26486 02850000
*D020960,C021000,A028850,D029000,C029200,C036816,C0378-0382 E12 ZA26486 02900000
*C040000,C041200,D042280,C042300-042320,D042400,C0426-0430  E12 ZA26486 02950000
*C043800-044200,C044450-044500                              E12 ZA26486 03000000
*C017794                                                    E12 ZA27737 03050000
*C17789-17792,C17796-17800                                  E12 ZA27738 03100000
*C018400,A018402-018414,C018600,C036808,D036816-036984      E12 ZA30227 03150000
*C037200                                                    E12 ZA30227 03200000
*                                                                       03250000
         EJECT                                              E12 ZA20103 03300000
*        REGISTER DEFINITION                                            03350000
*                                                                       03400000
PAR0     EQU   0                       PARAM  REG 0                     03450000
PAR1     EQU   1                       PARAM  REG 1                     03500000
RBASE    EQU   2                       BASE REG                         03550000
RBIQE    EQU   3                       RB IQE ADR REG                   03600000
RIQE     EQU   4                       IQE ADR REG                      03650000
RGACB    EQU   5                       GACB ADR REG                     03700000
RPIQE    EQU   6                       PREVIOUS IQE ADR                 03750000
BACKREG  EQU   7                       RETURN INTERNAL                  03800000
R1       EQU   1                       USED TO VALCHK PARMS D11 ZA04885 03850000
R8       EQU   8                       WORK REG                         03900000
R9       EQU   9                       WORK REG                         03950000
R10      EQU   10                      WORK REG                         04000000
R11      EQU   11                      WORK REG                         04050000
R12      EQU   12                      WORK REG                         04100000
SAVRG    EQU   13                      SAVE AREA PTR REG                04150000
RTNRG    EQU   14                      RETURN REG                       04200000
RCODE    EQU   15                      RETURN CODE REG                  04250000
REBREG   EQU   8                       REB ADDRESS REG      E12 ZA26486 04300000
*                                                                       04350000
*        TYPE FIELD OF IQE                                              04400000
*                                                                       04450000
END      EQU   X'01'                   END CODE                         04500000
PFKB     EQU   X'02'                   PF KEY CODE                      04550000
LP       EQU   X'03'                   LP CODE                          04600000
EOS      EQU   X'04'                   END ORDER SEQUENCE CODE          04650000
CANCEL   EQU   X'05'                   CANCEL KEY CODE                  04700000
AE       EQU   X'06'                   ASYM ERROR CODE                  04750000
A2260    EQU   X'07'                   2260 CODE                        04800000
*                                                                       04850000
*        GACB ATNTYP FIELD                                              04900000
*                                                                       04950000
GEND     EQU   X'01'                   END BIT                          05000000
GLP      EQU   X'02'                   LIGHT PEN BIT                    05050000
GEOS     EQU   X'04'                   END ORDER SEQUENCE BIT           05100000
GCANCEL  EQU   X'08'                   CANCEL BIT                       05150000
GAE      EQU   X'10'                   ASYM ERROR BIT                   05200000
T2260    EQU   X'20'                   2260 BIT                         05250000
*                                                                       05300000
*                                                                       05350000
*                                                                       05400000
ZERO     EQU   0                       ZERO                             05450000
RTNIRB   EQU   16                      IRB ADR                          05500000
RBIQES   EQU   24                      IQE ADR CHAIN                    05550000
RTNQ1    EQU   24                      REB Q1 FIELD                2575 05600000
EXIT     EQU   3                       EXIT SVC NO.                     05650000
ONE      EQU   1                       ONE                              05700000
TWO      EQU   2                       TWO                              05750000
FOUR     EQU   4                       FOUR                             05800000
NEXAVL   EQU   96                      NEXT FREE IQE FLD                05850000
RTNQ2    EQU   28                      ADR OF FIRST IQE                 05900000
ALL      EQU   X'FF'                   ALL 2260 OPTION                  05950000
XDUMMY   EQU   X'00'                   IMMED. OPERAND         LB  AOS/1 06000000
COMEND   EQU   11                      COMAREA DISP(END)      LB  AOS/1 06050000
CVTPTR   EQU   16                    CVT ADDRESS             LG @ZM2361 06100000
TCBPTR   EQU   0                     CVT DLBLWD              LG @ZM2361 06150000
CURRTCB  EQU   4                     ADDR CURR TCB           LG @ZM2361 06200000
RC8      EQU   8                     RETCD OF 8              LG @ZM2361 06250000
TEREB    EQU   4                   REBPTR FROM TEB          D11 ZA04885 06300000
RTNGACB  EQU   12                  GACBPTR FROM REB         D11 ZA04885 06350000
DCBDEB   EQU   45                  DEBPTR FROM DCB          D11 ZA04885 06400000
UCBTEB   EQU   28                  TEBPTR FROM UCB          D11 ZA04885 06450000
DEBUCB   EQU   33                  UCBPTR FROM DEB          D11 ZA04885 06500000
REBGACB  EQU   40                  REBPTR FROM GACB         D11 ZA04885 06550000
RTNF     EQU   0                   NXTREB PTR FROM REB      D11 ZA10042 06600000
RWORK    EQU   15                  VALIDATE WORKREG         D11 ZA04885 06650000
M7       EQU   7                   MASK VALUE 7             E12 ZA20103 06700000
*                                                                       06750000
         BALR  RBASE,0                 SET UP BASE REG      D11         06800000
         USING *,RBASE                 DEFINE BASE REG                  06850000
         USING GACB,RGACB              DEFINE DSECT REG                 06900000
         LR    RGACB,PAR1         INIT GACB REG             D11  YM5168 06950000
         LR    RBIQE,PAR0          PARAM TO WORK REGISTER      YA01241  07000000
         USING IQEFLDS,RIQE            DEFINE DSECT REG     D11         07050000
         L     R8,DCB              LOAD DCB ADDRESS         D11 ZA13202 07100000
         LA    R8,ZERO(R8)           CLEAR HI ORDER BYTE     LG @ZM2361 07150000
         DEBCHK  (R8),TYPE=VERIFY,AM=GAM                     LG @ZM2361 07200000
         LTR   RWORK,RWORK         RC= ZERO                 E12 ZA27738 07250000
         BNZ   VALERR              DEB IS INVALID           E12 ZA27738 07300000
         ICM   RWORK,M7,DEBUCB(PAR1) GET UCB FROM DEB       E12 ZA27737 07350000
         L     RWORK,UCBTEB(,RWORK) POINT TO TEB            E12 ZA27738 07400000
         LTR   RWORK,RWORK             IS THERE ONE?        E12 ZA27738 07450000
         BZ    VALERR                NO, UCB INVALID        E12 ZA27738 07500000
         L     REBREG,TEREB(,RWORK)  POINT TO FIRST REB     E12 ZA26486 07550000
NREB1    LTR   REBREG,REBREG       IS THERE ONE?            E12 ZA26486 07600000
         BZ    VALERR              PASSED GACB NOT FOUND    D11 ZA04885 07650000
         CLM   REBREG,7,REBADR+1   THIS PASSED GACB?        E12 ZA26486 07700000
         BE    SSM1OFF             YES,GO SET LOCK          D11 ZA04885 07750000
         L     REBREG,RTNF(,REBREG)   POINT TO NEXT REB     E12 ZA26486 07800000
         B     NREB1               AND GO CHECK IT          D11 ZA04885 07850000
VALERR   LA    RCODE,RC8             LD RETCD OF 8          D11 ZA04885 07900000
         SVC   EXIT                  RETURN                  LG @ZM2361 07950000
SSM1OFF  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGC0007E(X08000000
               SSM1ON)),REGS=USE                                YA01241 08050000
         LR    PAR1,RGACB              RESTORE REG1         D11  YM5168 08100000
         LTR   RBIQE,RBIQE             RBIQE REG=0?                     08150000
         BZ    NOTCLEAR                BRANCH IF ZERO NO RB E12 ZA30227 08200000
         L     RPIQE,RTNIRB(0,REBREG)  GET IRB ADDR FR REB  E12 ZA30227 08250000
         LA    RPIQE,RBIQES(0,RPIQE)   LOAD PTR TO RBIQEFLD E12 ZA30227 08300000
         CLR   RPIQE,RBIQE             VALID PARM PASSED    E12 ZA30227 08350000
         BE    DECLEAR                 YES GO TO CLEAR FUNC E12 ZA30227 08400000
         BAL   BACKREG,SSM1ON          RELEASE LOCK         E12 ZA30227 08450000
         LA    RCODE,RC8               PASS BACK RET CODE=8 E12 ZA30227 08500000
         SVC   EXIT                    RETURN               E12 ZA30227 08550000
NOTCLEAR LR    SAVRG,PAR1              OFFSET TO SAVE REG   E12 ZA30227 08600000
         SRL   SAVRG,24                ZERO                             08650000
         LA    RTNRG,ZERO              CLEAR REG                        08700000
*                                      CLEAR FUNCTION                   08750000
         LA    RPIQE,ZERO              INITIALIZE REG                   08800000
CHECK    EQU   *                                            E12 ZA26486 08850000
         L     RIQE,RTNIRB(0,REBREG)   LOAD IRB ADR         E12 ZA26486 08900000
         L     RIQE,RBIQES(0,RIQE)     LOAD PTR TO RBIQEFLD E12 ZA26486 08950000
DE04     LA    RIQE,ZERO(0,RIQE)       ZERO HI ORDER BYTE               09000000
         LTR   RIQE,RIQE               PTR=0                            09050000
         BNZ   DE02                    BRANCH IF NO                     09100000
         B     DE01                BRANCH TO INT. QUEUE TEST            09150000
NODATA   LTR   PAR1,PAR1               HAS Q1 FIELD BEEN TESTED    2575 09200000
         BZ    DE13                    BRANCH-Q1 HAS BEEN TESTED   2575 09250000
         SR    PAR1,PAR1               CLEAR REGISTER SWITCH       2575 09300000
*        L     R8,REBADR   LOAD REB ADR LINE DELETED BY---> E12 ZA26486 09350000
         L     RIQE,RTNQ1(REBREG)      LOAD PTR TO FST IQE  E12 ZA26486 09400000
         B     DE08                    BRANCH TO TEST FOR DATA     2575 09450000
DE13     EQU   *                                                   2575 09500000
         BAL   BACKREG,SSM1ON      RELEASE LOCAL LOCK           YA01241 09550000
         LA    RCODE,ZERO              RETURN CODE=ZERO            2575 09600000
         SVC   EXIT                    RETURN TO IOS                    09650000
DE02     LR    RPIQE,RIQE              SAVE PRESENT IQE ADR             09700000
         L     RIQE,IQELNK             LOAD NEXT IQE ADR                09750000
         LA    RIQE,ZERO(0,RIQE)       ZERO HI ORDER BYTE               09800000
         LTR   RIQE,RIQE               PTR=0                            09850000
         BZ    DE01                BRANCH IF YES                        09900000
         BAL   BACKREG,CONVERT         TO TYPE CONVERSION               09950000
         L     R11,PFKMSK              LOAD PF MASK FROM GACB           10000000
         L     R12,ATNTYP              LOAD ATNTYP MASK FROM GACB       10050000
         NR    R11,R9                  CHECK FOR MATCH                  10100000
         LTR   R11,R11                 WAS THERE A MATCH                10150000
         BNZ   DE03                    BRANCH IF YES                    10200000
         NR    R12,R10                 CHECK FOR MATCH                  10250000
         LTR   R12,R12                 WAS THERE A MATCH                10300000
         BNZ   DE03                    BRANCH IF YES                    10350000
         B     DE02                    BRANCH                           10400000
DE03     CLI   TYPE,A2260              IS THIS A 2260 ATTN              10450000
         BNE   DE03A                   BRANCH IF NO                     10500000
         CLR   RTNRG,SAVRG             OFFSETS MATCH                    10550000
         BE    DE03A                   BRANCH IF YES                    10600000
         LA    RTNRG,ALL               LOAD ALL TYPE                    10650000
         CLR   RTNRG,SAVRG             OFFSETS MATCH                    10700000
         BNZ   DE02                    BRANCH IF NO                     10750000
DE03A    L     R9,COMARA               LOAD COMAREA ADR                 10800000
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               10850000
         LTR   R9,R9                   PTR=0                            10900000
         BZ    NODATA                  BRANCH IF YES                    10950000
         L     R12,CVTPTR            CVT ADDRESS             LG @ZM2361 11000000
         L     R12,TCBPTR(R12)       TCB DLBLWORD            LG @ZM2361 11050000
         L     R12,CURRTCB(R12)      CURRENT TCB ADDRESS     LG @ZM2361 11100000
         USING TCB,R12                                       LG @ZM2361 11150000
         MODESET  EXTKEY=TCB,WORKREG=11                      LG @ZM2361 11200000
         MVC   ZERO(12,R9),RSVD        DATA TO COMAREA                  11250000
         MODESET  EXTKEY=SUPR                                LG @ZM2361 11300000
*                                                                       11350000
*                                                                       11400000
* THE NEXT 7 INSTRUCTIONS WERE CHANGED TO COMMENTS TO       LG @ZA00524 11450000
* AVIOD DEQUEUEING IQES FROM THE RBIQE FIELD OF THE IRB;    LG @ZA00524 11500000
* THIS FIELD NO LONGER POINTS TO A LIST OF IQES THAT HAVE   LG @ZA00524 11550000
* BEEN SCHEDULED,BUT RATHER A SINGLE IQE.                   LG @ZA00524 11600000
*                                                           LG @ZA00524 11650000
*        LTR   RPIQE,RPIQE             PREVIOUS IQE ADR=0   LG @ZA00524 11700000
*        BZ    DE05                    BRANCH IF YES        LG @ZA00524 11750000
*        MVC   ZERO(4,RPIQE),IQELNK  REMOVE IQE FROM CHAIN  LG @ZA00524 11800000
*        B     DE06                    BRANCH               LG @ZA00524 11850000
*DE05    MVC   RBIQES(4,R8),IQELNK     NEW IQE LINK TO RBIQE FLD  ZA524 11900000
*DE06    MVC   IQELNK(4),NEXAVL(R8)    NEXT AVAIL FLD TO IQE LNK  ZA524 11950000
*        ST    RIQE,NEXAVL(R8)         IQE ADR TO NEXAVL FLD      ZA524 12000000
RCODE4   EQU   *                                              LB  AOS/1 12050000
         BAL   BACKREG,SSM1ON      RELEASE LOCAL LOCK           YA01241 12100000
         LA    RCODE,FOUR              RC=4                             12150000
         SVC   EXIT                    RETURN TO IOS                    12200000
DE01     EQU   *                                            E12 ZA26486 12250000
*DE01    L     R8,REBADR LOAD REB ADR LINE DELETED BY APAR> E12 ZA26486 12300000
         L     RIQE,RTNQ2(0,REBREG)    PTR TO FIRST REB IQE E12 ZA26486 12350000
DE08     LA    RIQE,ZERO(0,RIQE)       ZERO HI ORDER BYTE               12400000
         LTR   RIQE,RIQE               PTR=0                            12450000
         BZ    NODATA              BRANCH-NO(MORE)IQES                  12500000
         BAL   BACKREG,CONVERT         BRANCH TO CONVERT ROUTINE        12550000
         L     R11,PFKMSK              LOAD PF MASK                     12600000
         L     R12,ATNTYP              LOAD ATTNTYP                     12650000
         NR    R11,R9                  CHECK MASK                       12700000
         NR    R12,R10                 CHECK MASK                       12750000
         LTR   R11,R11                 WAS THERE A MATCH                12800000
         BNZ   DE07                    BRANCH IF YES                    12850000
         LTR   R12,R12                 WAS THERE A MATCH                12900000
         BNZ   DE07                    BRANCH IF YES                    12950000
DE11     LR    RPIQE,RIQE              SAVE ADR                         13000000
         L     RIQE,IQELNK             LOAD ADR OF NEXT IQE             13050000
         B     DE08                    BRANCH                           13100000
DE07     CLI   TYPE,A2260              IS THIS A 2260 ATTN              13150000
         BNE   DE07A                   BRANCH IF NO                     13200000
         CLR   RTNRG,SAVRG             OFFSETS MATCH                    13250000
         BZ    DE07A                   BRANCH IF YES                    13300000
         LA    RTNRG,ALL               LOAD ALL TYPE                    13350000
         CLR   RTNRG,SAVRG             OFFSETS MATCH                    13400000
         BNE   DE11                    BRANCH IF NO                     13450000
DE07A    L     R9,COMARA               LOAD COM AREA ADR                13500000
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               13550000
         LTR   R9,R9                   PTR=0                            13600000
         BZ    NODATA                  BRANCH IF YES                    13650000
         L     R12,CVTPTR            LD ADDR CVT             LG @ZM2361 13700000
         L     R12,TCBPTR(R12)       LD ADDR DLBLWD          LG @ZM2361 13750000
         L     R12,CURRTCB(R12)      LD ADR CURR TCB         LG @ZM2361 13800000
         MODESET  EXTKEY=TCB,WORKREG=11                      LG @ZM2361 13850000
         MVC   ZERO(12,R9),RSVD        DATA TO COMAREA                  13900000
         MODESET  EXTKEY=SUPR                                LG @ZM2361 13950000
         LTR   RPIQE,RPIQE             PREVIOUS IQE ADR=0               14000000
         BNZ   DE09                    BRANCH IF NO                     14050000
         LTR   PAR1,PAR1               IS THIS A Q1 SEARCH         2575 14100000
         BNZ   DE07B                   BRANCH-NOT A Q1 SEARCH      2575 14150000
         MVC   RTNQ1(4,R8),IQELNK      NEW IQE ADR TO Q1 FIELD     2575 14200000
         B     DE10                    BRANCH                      2575 14250000
DE07B    EQU   *                                                   2575 14300000
         MVC   RTNQ2(4,R8),IQELNK      NEW IQE ADR TO Q2 FLD            14350000
         B     DE10                    BRANCH                           14400000
DE09     MVC   ZERO(4,RPIQE),IQELNK    REMOVE IQE FROM CHAIN            14450000
DE10     L     R8,IQEIRB               LOAD IRB ADR                     14500000
         MVC   IQELNK,NEXAVL(R8)       NEXT AVAIL TO IQE LINK           14550000
         ST    RIQE,NEXAVL(R8)         IQE ADR TO NEXT AVL              14600000
         B     RCODE4                  GO SET RETURN CODE     LB  AOS/1 14650000
DECLEAR  EQU   *                                              LB  AOS/1 14700000
*   22 LINES FOR APAR ZA04885,10042,20103,26486 DELETED BY-->   ZA30227 14750000
         L     RIQE,ZERO(0,RBIQE)      LOAD IQE ADR         E12 ZA30227 14800000
         LA    RIQE,ZERO(0,RIQE)       ZERO HI ORDER BYTE               14850000
         LTR   RIQE,RIQE               PTR=0                            14900000
         BZ    Q2                      BRANCH IF YES                    14950000
         L     R9,IQELNK               LOAD PTR TO NEXT IQE E12 ZA26486 15000000
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE   E12 ZA26486 15050000
         LTR   R9,R9                   PTR=0                E12 ZA26486 15100000
         BZ    Q2                      BRANCH IF YES                    15150000
         LA    R10,ZERO                LOAD ZERO                        15200000
         ST    R10,IQELNK              ZERO FIRST IQE LINK FLD          15250000
DE12     L     R11,IQEIRB              LOAD IRB ADR                6999 15300000
         L     R10,NEXAVL(0,R11)       LOAD NEXT FREE IQE PTR      6999 15350000
         LA    R10,ZERO(0,R10)         ZERO HI ORDER BYTE               15400000
         LTR   R10,R10                 PTR=0                            15450000
         BNZ   NOT                     BRANCH IF NO                     15500000
         ST    R9,NEXAVL(0,R11)        IQES TO FREE CHAIN   E12 ZA26486 15550000
         B     Q2                      BRANCH                           15600000
NOT      L     R11,ZERO(0,R10)         LOAD NEXT IQE ADR                15650000
         LA    R11,ZERO(0,R11)         ZERO HI ORDER BYTE               15700000
         LTR   R11,R11                 PTR=0                            15750000
         BNZ   NOT1                    BRANCH IF NOT 0                  15800000
         ST    R9,ZERO(0,R10)          IQES TO FREE CHAIN   E12 ZA26486 15850000
         B     Q2                      BRANCH                           15900000
NOT1     LR    R10,R11                 SAVE ADR                         15950000
         B     NOT                     BRANCH                           16000000
Q2       LTR   RGACB,RGACB             PTR=0                            16050000
         BZ    YES                     BRANCH IF YES                    16100000
         LTR   PAR1,PAR1               REGISTER SWITCH=ZERO        2575 16150000
         BZ    Q2A                     BRANCH=0                    2575 16200000
         SR    PAR1,PAR1               CLEAR REGISTER SWITCH       2575 16250000
*        L     R10,REBADR   LINE DELETED BY APAR--------->  E12 ZA26486 16300000
         L     R9,RTNQ1(REBREG)        LOAD Q1 FIELD        E12 ZA26486 16350000
         LTR   R9,R9                   ANY IQES ON Q1 FIELD E12 ZA26486 16400000
         BNZ   DENOA                   BRANCH IF IQES PRESENT      2575 16450000
Q2A      EQU   *                                                   2575 16500000
*        L     R10,REBADR   LINE DELETED BY APAR----------> E12 ZA26486 16550000
         L     R9,RTNQ2(0,REBREG)      LOAD IQE ADR         E12 ZA26486 16600000
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE   E12 ZA26486 16650000
         LTR   R9,R9                   PTR=0                E12 ZA26486 16700000
         BNZ   DENO                    BRANCH IF NO                     16750000
YES      EQU   *                                             LD YA01241 16800000
         BAL   BACKREG,SSM1ON      RELEASE LOCAL LOCK           YA01241 16850000
         SVC   EXIT                                                     16900000
DENO     LR    RIQE,R9                 LOAD NEW IQE ADR     E12 ZA26486 16950000
         SR    RGACB,RGACB             ZERO REG             E12 ZA26486 17000000
         ST    RGACB,RTNQ2(REBREG)     ZERO REB IQE PTR     E12 ZA26486 17050000
         B     DE12                                                     17100000
DENOA    LR    RIQE,R9                 LOAD IQE ADR         E12 ZA26486 17150000
         SR    RPIQE,RPIQE             ZERO REG             E12 ZA26486 17200000
         ST    RPIQE,RTNQ1(REBREG)     ZERO Q1 FIELD        E12 ZA26486 17250000
         B     DE12                    BRANCH                      2575 17300000
CONVERT  CLI   TYPE,PFKB               TEST FOR PF KEY ATTN             17350000
         BE    DEPFKEY                 BRANCH IF YES                    17400000
         LA    R9,ZERO                 ZERO PF ARGUMENT REG             17450000
         LA    R10,ONE                 LOAD INITIAL ATNTYP SEARCH CODE  17500000
         CLI   TYPE,END                END KEY TYPE                     17550000
         BNE   C01                     BRANCH IF NO                     17600000
         BR    BACKREG                 RETURN TO NSI FROM CALLER        17650000
C01      SR    R11,R11                 CLEAR REG                        17700000
         IC    R11,TYPE                INSERT TYPE CODE                 17750000
         LA    R12,TWO                 LOAD CONSTANT                    17800000
         SR    R11,R12                 DETERMINE SHIFT COUNT            17850000
         SLL   R10,ZERO(R11)           DETERMINE SHIFT COUNT            17900000
         CLI   TYPE,A2260              IS THIS A 2260 ATTN              17950000
         BNE   C02                     BRANCH IF NO                     18000000
         IC    RTNRG,RSVD              INSERT OFFSET                    18050000
C02      BR    BACKREG                 RETURN TO NSI FROM CALLER        18100000
DEPFKEY  LA    R10,ZERO                ZERO TYPE ARGUMENT               18150000
         L     R9,PFCODE               LOAD INITIAL PF KEY SEARCH       18200000
         SR    R11,R11                 CLEAR REG                        18250000
         IC    R11,KEY                 INSERT KEY #                     18300000
         SRL   R9,ZERO(R11)            DETERMINE PF KEY SEARCH          18350000
         BR    BACKREG                 RETURN TO NSI AFTER CALLER       18400000
SSM1ON   SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGC0007E(SSM1OFF)), *18450000
               REGS=USE                                         YA01241 18500000
         BR    BACKREG             RETURN TO NSI AFTER CALLER   YA01241 18550000
         DS    0F                                                       18600000
DISABLE  DC    2XL1'00'                                                 18650000
ENABLE   DC    2XL1'FF'                                                 18700000
PFCODE   DC    X'80'                                                    18750000
         DC    AL3(0)                                                   18800000
MODEND   EQU   *                                             LD YA01241 18850000
PATCH    DS    0F                  PATCH AREA               D11         18900000
         DC    40AL1(255)          = ALL FOXES              D11         18950000
IQEFLDS  DSECT                                                          19000000
IQELNK   DS    1F                                                       19050000
IQEPARM  DS    1F                                                       19100000
IQEIRB   DS    1F                                                       19150000
IQETCB   DS    1F                                                       19200000
RSVD     DS    BL1                                                      19250000
OV       DS    BL1                                                      19300000
KEY      DS    BL1                                                      19350000
TYPE     DS    BL1                                                      19400000
SENSE    DS    1F                                                       19450000
GACB     DSECT                                                          19500000
COMARA   DS    1F                                                       19550000
DCB      DS    1F                                                       19600000
PFKMSK   DS    1F                                                       19650000
ATNTYP   DS    1F                                                       19700000
EP1      DS    1F                                                       19750000
EP2      DS    1F                                                       19800000
REG13    DS    1F                                                       19850000
PFKEY    DS    1F                                                       19900000
ATNTYPS  DS    1F                                                       19950000
ECB      DS    1F                                                       20000000
REBADR   DS    1F                                                       20050000
RESERVED DS    1F                                                       20100000
         IHAPSA                                                 YA01241 20150000
         IKJTCB                                              LG @ZM2361 20200000
         END                                                            20250000
./  ADD  SSI=20480909,NAME=IGC0107C
*********************************************************************** 00900021
* MODULE NAME: IGC0107C (SPAR MESSAGE MODULE)                           01800021
*                                                                       02700021
* STATUS: CHANGE LEVEL 0                                                03600021
*                                                                       04500021
* FUNCTION: ISSUE WRITE-TO-PROGRAMMER MESSAGES FOR ERRORS DISCOVERED BY 05400021
* IGC0007C(SPAR)                                                        06300021
*                                                                       07200021
* ENTRY POINT: IGC0107C VIA XCTL FROM IGC0007C                          08100021
*                                                                       09000021
* INPUT: REG4 - ADDRESS OF SPAR PARAMETER LIST                          09900021
*        REG5 - ADDRESS OF GACB BEING PROCESSED                         10800021
*        REG7 - RETURN CODE SET BY SPAR; INDEXES MSGLIST                11700021
*                                                                       12600021
* OUTPUT: WRITE-TO-PROGRAMMER MESSAGE                                   13500021
*         REGISTER 15 - RETURN CODE 04 NON-GRAPHIC DCB                  14400021
*                                   08 GACB ALREADY SPECIFIED           15300021
*                                   0C NO GACB ADDRESS FOR SPAR         16200021
*                                   10 DCB NOT OPEN                     17100021
*                                   14 SPAR NOT IN TASK THAT OPENED     18000021
*                                                                       18900021
*         REGISTER 1 - ADDRESS OF GACB BEING PROCESSED,EXCEPT FOR       19800021
*                      RETURN  CODE 0C; THEN,ADDR OF PARAM LIST         20700021
*                                                                       21600021
* EXIT: VIA SVC 3                                                       22500021
*                                                                       23400021
* TABLES: MSGLIST - DISPLACEMENTS TO LIST FORMS OF WTO FOR MESSAGES     24300021
*                                                                       25200021
* ATTRIBUTES: SUPERVISOR STATE,REENTRANT,TRANSIENT                      26100021
*                                                                       27000021
*********************************************************************** 27900021
IGC0107C CSECT                                                          28800021
* REGISTER EQUATES                                                      29700021
R0       EQU   0                                                        30600021
R1       EQU   1                                                        31500021
R2       EQU   2                       POINTER TO SVRB EXT              32400021
RGACB    EQU   4                       ADDR GACB BEING PROCESSED        33300021
RPARM    EQU   5                       ADDR PARAM LIST                  34200021
RCODE    EQU   7                       MSGLIST OFFSET(INPUT)            35100021
RWORK    EQU   8                                                        36000021
RMSG     EQU   9                       ADDR OF MSG                      36900021
RBUF     EQU   10                      POINTER TO MSG BUFFER            37800021
RLNGTH   EQU   11                      FOR LENGTH OF MSG                38700021
RBASE    EQU   12                      BASE REG                         39600021
R15      EQU   15                                                       40500021
         SPACE 3                                                        41400021
* MISC. EQUATES                                                         42300021
X0C      EQU   X'0C'                   RETURN CODE COMPARAND            43200021
EXIT     EQU   3                       SVC NUMBER FOR EXIT RTN          44100021
CVTPTR   EQU   16                      CVT POINTER                      45000021
D0       EQU   0                       DISPLACEMENT                     45900021
D4       EQU   4                       DISPLACEMENT                     46800021
D96      EQU   96                      DISPLACEMENT                     47700021
         SPACE 3                                                        48600021
         BALR  RBASE,R0                LOAD BASE REG                    49500021
         USING *,RBASE                                                  50400021
ORG      EQU   *                                                        51300021
         L     RMSG,MSGLIST(RCODE)     DISPLACEMENT OF MSG              52200021
         LA    RMSG,R0(RMSG,RBASE)     ADDRESS OF MSG                   53100021
         L     R2,CVTPTR               CVT ADDRESS                      54000021
         L     R2,D0(R2)               ADDRRSS OF TCB POINTERS          54900021
         L     R2,D4(R2)               CURRENT TCB ADDR                 55800021
         L     R2,D0(R2)               CURRENT RB ADDR                  56700021
         LA    R2,D96(R2)              ADDR OF SVRB EXT                 57600021
         MVC   D4(GMLNG,R2),GMLIST     MOVE GM LIST TO SVRB EXT         58500021
         LA    RWORK,D4(R2)            ADDR OF GM PARM LIST             59400021
         GETMAIN A=(R2),MF=(E,(RWORK))  GET MSG BUFFER                  60300021
         LTR   R15,R15                 DID GM SUCCEED                   61200021
         BNZ   SKIPWTO                 BRANCH IF GM FAILED              62100021
         L     RBUF,D0(R2)             ADDR OF MSG BUFFER               63000021
         LH    RLNGTH,D0(RMSG)         LENRTH OF MSG                    63900021
         LA    RLNGTH,D4(RLNGTH)       +4 FOR DESC,RTG CODES            64800021
         EX    RLNGTH,MOVEMSG          MOVE MSG TO BUFFER               65700021
         WTO   MF=(E,(RBUF))           ISSUE MSG                        66600021
         FREEMAIN A=(R2),MF=(E,(RWORK))  FREE BUFFER                    67500021
SKIPWTO  EQU   *                                                        68400021
         LR    R1,RGACB                CURRENT GACB ADDR                69300021
         LA    RWORK,X0C               RETURN CODE COMPARAND            70200021
         CR    RWORK,RCODE             IS ERROR FOR SHORT PARM LIST     71100021
         BNE   LEAVE                   IF NOT,RETURN GACB ADDR          72000021
         LR    R1,RPARM                RETURN ADDR OF BAD PARM LIST     72900021
LEAVE    EQU   *                                                        73800021
         LR    R15,RCODE               SET RETURN CODE                  74700021
         SVC   EXIT                                                     75600021
         EJECT                                                          76500021
MOVEMSG  MVC   D0(D0,RBUF),D0(RMSG)                                     77400021
GMLIST   GETMAIN EC,LV=80,MF=L         GM PARM LIST                     78300021
GMLNG    EQU   *-GMLIST                LENGTH OF GMLIST                 79200021
         DS    0F                                                       80100021
MSGLIST  EQU   *-4                     MESSAGE SELECTION TABLE          81000021
* RCODE PASSED AS INPUT IS DISPLACEMENT FROM MSGLIST ORIGIN             81900021
         DC    A(MSG1-ORG)                                              82800021
         DC    A(MSG2-ORG)                                              83700021
         DC    A(MSG3-ORG)                                              84600021
         DC    A(MSG4-ORG)                                              85500021
         DC    A(MSG5-ORG)                                              86400021
MSG1     WTO   'IFF303I SPAR, USING GACB INPUT, FOUND DCB NOT GRAPHIC',X87300021
               ROUTCDE=11,DESC=7,MF=L                                   88200021
MSG2     WTO   'IFF304I SPAR ISSUED FOR GACB ALREADY SPECIFIED BY SPAR'X89100021
               ,ROUTCDE=11,DESC=7,MF=L                                  90000021
MSG3     WTO   'IFF301I SPAR PARAMETER LIST TOO SHORT TO CONTAIN GACB AX90900021
               DDRESS',ROUTCDE=11,DESC=7,MF=L                           91800021
MSG4     WTO   'IFF302I SPAR, USING GACB INPUT, FOUND DCB NOT OPENED', X92700021
               ROUTCDE=11,DESC=7,MF=L                                   93600021
MSG5     WTO   'IFF305I SPAR ISSUED BY TASK OTHER THAN ONE FOR WHICH DCX94500021
               B WAS OPENED',ROUTCDE=11,DESC=7,MF=L                     95400021
         END                                                            96300021
./  ADD  SSI=20480933,NAME=IGC0107D
*********************************************************************** 00600021
* MODULE NAME: IGC0107D (DAR MESSAGE MODULE)                            01200021
*                                                                       01800021
* STATUS: CHANGE LEVEL 0                                                02400021
*                                                                       03000021
* FUNCTION: ISSUE WRITE-TO-PROGRAMMER MESSAGES FOR ERRORS DISCOVERED BY 03600021
* IGC0007D (DAR)                                                        04200021
*                                                                       04800021
* ENTRY POINT: IGC0107D VIA XCTL FROM IGC0007D                          05400021
*                                                                       06000021
* INPUT: REG3 - ADDRESS OF DAR PARAMETER LIST                           06600021
*        REG6 - ADDRESS OF GACB BEING PROCESSED                         07200021
*        REG7 - RETURN CODE SET BY DAR; INDEXES MSGLIST                 07800021
*                                                                       08400021
* OUTPUT: WRITE-TO-PROGRAMMER MESSAGE                                   09000021
*         REGISTER 15 - RETURN CODE 04 NO DCB ADDRESS IN GACB           09600021
*                                   08 GACB NOT SPEC BY SPAR            10200021
*                                   0C NO GACB ADDRESS FOR DAR          10800021
*                                   10 ATTN RTN STILL ACTIVE            11400021
*                                   14 DAR NOT IN SAME TASK AS SPAR     12000021
*                                   18 DCB NOT OPEN                     12600021
*                                   1C NON-GRAPHIC DCB                  13200021
*                                   20 NOT BASIC ATTN ENVIRONMENT       13800021
*                                                                       14400021
*         REGISTER 1 - ADDRESS OF GACB BEING PROCESSED,EXCEPT FOR       15000021
*                      RETURN  CODE 0C; THEN,ADDR OF PARAM LIST         15600021
*                                                                       16200021
* EXIT: VIA SVC 3                                                       16800021
*                                                                       17400021
* TABLES: MSGLIST - DISPLACEMENTS TO LIST FORMS OF WTO FOR MESSAGES     18000021
*                                                                       18600021
* ATTRIBUTES: SUPERVISOR STATE,REENTRANT,TRANSIENT                      19200021
*                                                                       19800021
*********************************************************************** 20400021
IGC0107D CSECT                                                          21000021
* REGISTER EQUATES                                                      21600021
R0       EQU   0                                                        22200021
R1       EQU   1                                                        22800021
R2       EQU   2                       POINTER TO SVRB EXT              23400021
RPARM    EQU   3                       PARAM LIST  ADDR          S21016 24000021
RGACB    EQU   6                       ADDR OF GACB              S21016 24600021
RCODE    EQU   7                       MSGLIST OFFSET(INPUT)            25200021
RWORK    EQU   8                                                        25800021
RMSG     EQU   9                       ADDR OF MSG                      26400021
RBUF     EQU   10                      POINTER TO MSG BUFFER            27000021
RLNGTH   EQU   11                      FOR LENGTH OF MSG                27600021
RBASE    EQU   12                      BASE REG                         28200021
R14      EQU   14                                                       28800021
R15      EQU   15                                                       29400021
         SPACE 3                                                        30000021
* MISC. EQUATES                                                         30600021
X80      EQU   X'80'                   DUMP CODE                        31200021
X01      EQU   X'01'                                                    31800021
X061     EQU   X'061'                  ABEND CODE/CLOSE-DAR BAD         32400021
SHFT12   EQU   12                      SHIFT COUNT                      33000021
SHFT24   EQU   24                      SHIFT COUNT                      33600021
CVTBTERM EQU   52                      DISP OF ABTERM ADDR IN CVT       34200021
D47      EQU   47                      DISP OF GACB FLAG BYTE           34800021
X0C      EQU   X'0C'                   RETURN CODE COMPARAND            35400021
EXIT     EQU   3                       SVC NUMBER FOR EXIT RTN          36000021
CVTPTR   EQU   16                      CVT POINTER                      36600021
D0       EQU   0                       DISPLACEMENT                     37200021
D4       EQU   4                       DISPLACEMENT                     37800021
D96      EQU   96                      DISPLACEMENT                     38400021
         SPACE 3                                                        39000021
         BALR  RBASE,R0                LOAD BASE REG                    39600021
         USING *,RBASE                                                  40200021
ORG      EQU   *                                                        40800021
         LTR   RCODE,RCODE             CHK FOR CLOSE-DAR BAD            41400021
         BP    GETDISP                 BR IF NOT CLOSE-DAR              42000021
         L     RMSG,CLMSGDSP           DISP OF CLOSEMSG                 42600021
         B     GETADDR                 BR TO GET ADDRESS OF MSG         43200021
GETDISP  EQU   *                                                        43800021
         L     RMSG,MSGLIST(RCODE)     DISPLACEMENT OF MSG              44400021
GETADDR  EQU   *                                                        45000021
         LA    RMSG,R0(RMSG,RBASE)     ADDRESS OF MSG                   45600021
         L     R2,CVTPTR               CVT ADDRESS                      46200021
         L     R2,D0(R2)               ADDRRSS OF TCB POINTERS          46800021
         L     R2,D4(R2)               CURRENT TCB ADDR                 47400021
         L     R2,D0(R2)               CURRENT RB ADDR                  48000021
         LA    R2,D96(R2)              ADDR OF SVRB EXT                 48600021
         MVC   D4(GMLNG,R2),GMLIST     MOVE GM I&ST TO SVRB EXT         49200021
         LA    RWORK,D4(R2)            ADDR OF GM PARM LIST             49800021
         GETMAIN A=(R2),MF=(E,(RWORK))  GET MSG BUFFER                  50400021
         LTR   R15,R15                 DID GM SUCCEED                   51000021
         BNZ   SKIPWTO                 BRANCH IF GM FAILED              51600021
         L     RBUF,D0(R2)             ADDR OF MSG BUFFER               52200021
         LH    RLNGTH,D0(RMSG)         LENGTH OF MSG                    52800021
         LA    RLNGTH,D4(RLNGTH)       +4 FOR DESC,RTG CODES            53400021
         EX    RLNGTH,MOVEMSG          MOVE MSG TO BUFFER               54000021
         WTO   MF=(E,(RBUF))           ISSUE MSG                        54600021
         FREEMAIN A=(R2),MF=(E,(RWORK))  FREE BUFFER                    55200021
SKIPWTO  EQU   *                                                        55800021
         LTR   RCODE,RCODE             CHK FOR CLOSE-DAR BAD            56400021
         BNP   CLOSEDAR                BR IF CLOSE-DAR BAD              57000021
         LR    R1,RGACB                CURRENT GACB ADDR                57600021
         LA    RWORK,X0C               RETURN CODE COMPARAND            58200021
         CR    RWORK,RCODE             IS ERROR FOR SHORT PARM LIST     58800021
         BNE   LEAVE                   IF NOT,RETURN GACB ADDR          59400021
         LR    R1,RPARM                RETURN ADDR OF BAD PARM LIST     60000021
LEAVE    EQU   *                                                        60600021
         LR    R15,RCODE               SET RETURN CODE                  61200021
         SVC   EXIT                                                     61800021
CLOSEDAR EQU   *                       ABTERM TASK THAT ISSUED SPAR     62400021
         LA    R0,X80                  LOAD DUMP CODE                   63000021
         SLL   R0,SHFT24               DUMP CODE TO HI-BYTE             63600021
         LA    R1,X061                 LOAD ABEND CODE                  64200021
         SLL   R1,SHFT12               SHIFT ABEND CODE                 64800021
         OR    R1,R0                   DUMP CODE TO HI-BYTE             65400021
         LR    R0,RCODE                GET REB TCB ADDRESS              66000021
         L     R15,CVTPTR              ADDR OF CVT                      66600021
         L     R15,CVTBTERM(R15)       EP ADDRESS OF ABTERM             67200021
         BALR  R14,R15                 BRANCH TO ABTERM                 67800021
         XI    D47(RGACB),X01          TURN OFF FLAG SET BY CLOSE       68400021
         SVC   EXIT                    EXIT                             69000021
         EJECT                                                          69600021
MOVEMSG  MVC   D0(D0,RBUF),D0(RMSG)                                     70200021
GMLIST   GETMAIN EC,LV=80,MF=L         GM PARM LIST                     70800021
GMLNG    EQU   *-GMLIST                LENGTH OF GMLIST                 71400021
         DS    0F                                                       72000021
MSGLIST  EQU   *-4                     MESSAGE SELECTION TABLE          72600021
* RCODE PASSED AS INPUT IS DISPLACEMENT FROM MSGLIST ORIGIN             73200021
         DC    A(MSG1-ORG)                                              73800021
         DC    A(MSG2-ORG)                                              74400021
         DC    A(MSG3-ORG)                                              75000021
         DC    A(MSG4-ORG)                                              75600021
         DC    A(MSG5-ORG)                                              76200021
         DC    A(MSG6-ORG)                                              76800021
         DC    A(MSG7-ORG)                                              77400021
         DC    A(MSG8-ORG)                                              78000021
MSG1     WTO   'IFF342I DAR FOUND ZERO IN DCB ADDRESS FIELD OF GACB',  X78600021
               ROUTCDE=11,DESC=7,MF=L                                   79200021
MSG2     WTO   'IFF346I DAR ISSUED FOR GACB NOT SPECIFIED BY SPAR MACROX79800021
               ',ROUTCDE=11,DESC=7,MF=L                                 80400021
MSG3     WTO   'IFF341I DAR PARAMETER LIST TOO SHORT TO CONTAIN GACB ADX81000021
               DRESSES',ROUTCDE=11,DESC=7,MF=L                          81600021
MSG4     WTO   'IFF349I DAR, USING GACB INPUT, FOUND ATTENTION ROUTINE X82200021
               STILL ACTIVE',ROUTCDE=11,DESC=7,MF=L              S21016 82800021
MSG5     WTO   'IFF347I DAR NOT ISSUED BY SAME TASK THAT ISSUED SPAR FOX83400021
               R THE GACB',ROUTCDE=11,DESC=7,MF=L                       84000021
MSG6     WTO   'IFF343I DAR, USING GACB INPUT, FOUND DCB NOT OPEN',    X84600021
               ROUTCDE=11,DESC=7,MF=L                                   85200021
MSG7     WTO   'IFF344I DAR, USING GACB INPUT, FOUND DCB NOT GRAPHIC', X85800021
               ROUTCDE=11,DESC=7,MF=L                                   86400021
MSG8     WTO   'IFF345I DAR ISSUED FOR GACB, BUT ATTENTION ENVIRONMENT X87000021
               NOT BASIC',ROUTCDE=11,DESC=7,MF=L                        87600021
CLMSGDSP DC    A(CLOSEMSG-ORG)         DISP OF CLOSEMSG                 88200021
CLOSEMSG WTO   'IFF348I DAR ISSUED BY CLOSE, BUT GACB STILL SPECIFIED BX88800021
               Y ANOTHER TASK',ROUTCDE=11,DESC=7,MF=L                   89400021
         END                                                            90000021
./  ADD  SSI=40430439,NAME=IGC0207A
*********************************************************************** 00700021
* MODULE NAME: IGC0207A (BUFFER MANAGEMENT MESSAGE MODULE)              01400021
*                                                                       02100021
* STATUS: CHANGE LEVEL 0                                                02800021
*                                                                       03500021
* FUNCTION: ISSUE WRITE-TO-PROGRAMMER MESSAGES FOR ERRORS DISCOVERED BY 04200021
* IGC0007A (BUFFER MNGT-LOAD 1)                                         04900021
*                                                                       05600021
* ENTRY POINT: IGC0207A VIA XCTL FROM IGC0007A                          06300021
*                                                                       07000021
* INPUT: REG7 - RETURN CODE SET BY IGC0007A; INDEXES MSGLIST            07700021
*                                                                       08400021
* OUTPUT: WRITE-TO-PROGRAMMER MESSAGE                                   09100021
*         REGISTER 15 - RETURN CODE 04 REQUEST EXCEEDS AVAILABLE        09800021
*                                   08 REQUEST EXCEEDS ZONE             10500021
*                                   0C DCB NOT OPEN                     11200021
*                                   10 RELEASE EXCEEDS ASSIGNED         11900021
*                                   18 ASSIGN BYTE COUNT BAD            12600021
*                                   1C INVALID REQUEST CODE             13300021
*                                   20 RELEASE BYTE COUNT BAD           14000021
*                                   24 CONTIG SECT NOT AVAILABLE        14700021
*                                  28 DCB-IOB LINK BAD                  15400021
*                                   2C NON-GRAPHIC DCB                  16100021
*                                   30 RELEASE FOR UNASSIGNED SECTION   16800021
*                                                                       17500021
*         REGISTER 1 - PARAMETER LIST ADDRESS RESTORED EXCEPT FOR       18200021
*                      RETURN CODES 1C AND 24                           18900021
*                                                                       19600021
* EXIT: VIA SVC 3                                                       20300021
*                                                                       21000021
* TABLES: MSGLIST - DISPLACEMENTS TO LIST FORMS OF WTO FOR MESSAGES     21700021
*                                                                       22400021
* ATTRIBUTES: SUPERVISOR STATE,REENTRANT,TRANSIENT                      23100021
*                                                                       23800021
*********************************************************************** 24500021
IGC0207A CSECT                                                          25200021
*A745500,900500-901000                                        LG YM5684 25250000
* REGISTER EQUATES                                                      25900021
R0       EQU   0                                                        26600021
R1       EQU   1                                                        27300021
R2       EQU   2                       POINTER TO SVRB EXT              28000021
RCODE    EQU   7                       MSGLIST OFFSET(INPUT)            28700021
RWORK    EQU   8                                                        29400021
RMSG     EQU   9                       ADDR OF MSG                      30100021
RBUF     EQU   10                      POINTER TO MSG BUFFER            30800021
RLNGTH   EQU   11                      FOR LENGTH OF MSG                31500021
RBASE    EQU   12                      BASE REGISTER                    32200021
RSAVE    EQU   13                                                       32900021
R15      EQU   15                                                       33600021
* MISC. EQUATES                                                         34300021
EXIT     EQU   3                       SVC NUMBER FOR EXIT              35000021
X1C      EQU   X'1C'                   RETURN CODE COMPARAND            35700021
X24      EQU   X'24'                   RETURN CODE COMPARAND            36400021
CVTPTR   EQU   16                      CVT POINTER                      37100021
D0       EQU   0                       DISPLACEMENT                     37800021
D4       EQU   4                       DISPLACEMENT                     38500021
D96      EQU   96                      DISPLACEMENT                     39200021
         BALR  RBASE,R0                LOAD BASE REG                    39900021
ORG      EQU   *                                                        40600021
         USING *,RBASE                                                  41300021
         L     RMSG,MSGLIST(RCODE)     ADDRESS OF MESSAGE               42000021
         LA    RMSG,R0(RMSG,RBASE)     **IS DISP + BASE                 42700021
         L     R2,CVTPTR               CVT ADDRESS                      43400021
         L     R2,D0(R2)               ADDRRSS OF TCB POINTERS          44100021
         L     R2,D4(R2)               CURRENT TCB ADDR                 44800021
         L     R2,D0(R2)               CURRENT RB ADDR                  45500021
         LA    R2,D96(R2)              ADDR OF SVRB EXT                 46200021
         MVC   D4(GMLNG,R2),GMLIST     MOVE GM LIST TO SVRB EXT         46900021
         LA    RWORK,D4(R2)            ADDR OF GM PARM LIST             47600021
         GETMAIN A=(R2),MF=(E,(RWORK))  GET MSG BUFFER                  48300021
         LTR   R15,R15                 DID GM SUCCEED                   49000021
         BNZ   SKIPWTO                 BRANCH IF GM FAILED              49700021
         L     RBUF,D0(R2)             ADDR OF MSG BUFFER               50400021
         LH    RLNGTH,D0(RMSG)         LENGTH OF MSG                    51100021
         LA    RLNGTH,D4(RLNGTH)       +4 FOR DESC,RTG CODES            51800021
         EX    RLNGTH,MOVEMSG          MOVE MSG TO BUFFER               52500021
         WTO   MF=(E,(RBUF))           ISSUE MSG                        53200021
         FREEMAIN A=(R2),MF=(E,(RWORK))  FREE BUFFER                    53900021
SKIPWTO  EQU   *                                                        54600021
         LA    R15,X1C                                                  55300021
         CR    RCODE,R15                                                56000021
         BE    LEAVE                   GO TO EXIT                       56700021
         LA    R15,X24                                                  57400021
         CR    RCODE,R15                                                58100021
         BE    LEAVE                   GO TO EXIT                       58800021
         LR    R1,RSAVE                RESTORE PARMLIST ADDR FOR OPEN   59500021
LEAVE    EQU   *                                                        60200021
         LR    R15,RCODE               SET RETURN CODE                  60900021
         SVC   EXIT                                                     61600021
MOVEMSG  MVC   D0(D0,RBUF),D0(RMSG)                                     62300021
GMLIST   GETMAIN EC,LV=80,MF=L         GM PARM LIST                     63000021
GMLNG    EQU   *-GMLIST                LENGTH OF GMLIST                 63700021
         DS    0F                                                       64400021
MSGLIST  EQU   *-4                     MESSAGE SELECTION TABLE          65100021
* RCODE PASSED AS INPUT IS DISPLACEMENT FROM MSGLIST ORIGIN             65800021
         DC    A(MSG1-ORG)                                              66500021
         DC    A(MSG2-ORG)                                              67200021
         DC    A(MSG3-ORG)                                              67900021
         DC    A(MSG4-ORG)                                              68600021
         DC    1F'0'                   RCODE X'14' SHOULD NOT OCCUR     69300021
         DC    A(MSG5-ORG)                                              70000021
         DC    A(MSG6-ORG)                                              70700021
         DC    A(MSG7-ORG)                                              71400021
         DC    A(MSG8-ORG)                                              72100021
         DC    A(MSG9-ORG)                                              72800021
         DC    A(MSG10-ORG)                                             73500021
         DC    A(MSG11-ORG)                                             74200021
         DC    A(MSG12-ORG)                                             74500002
         DC    A(MSG13-ORG)                                   LG YM5684 74550000
MSG1     WTO   'IFF512I ASGNBFR FOUND BUFFER STORAGE REQUESTED EXCEEDS X74900021
               FREE SECTIONS',ROUTCDE=11,DESC=7,MF=L             S21016 75600021
MSG2     WTO   'IFF513I ASGNBFR FOUND BUFFER STORAGE REQUESTED EXCEEDS X76300021
               DEVICE''S ZONE',ROUTCDE=11,DESC=7,MF=L            S21016 77000021
MSG3     WTO   'IFF501I IGC0007A FOUND DCB NOT OPEN',ROUTCDE=11,DESC=7,X77700021
               MF=L                                                     78400021
MSG4     WTO   'IFF522I RLSEBFR REQUEST BYTE COUNT EXCEEDS BUFFER ASSIGX79100021
               NED TO DEVICE',ROUTCDE=11,DESC=7,MF=L             S21016 79800021
MSG5     WTO   'IFF511I ASGNBFR REQUESTED WITH NON-POSITIVE BYTE COUNT'X80500021
               ,ROUTCDE=11,DESC=7,MF=L                           S21016 81200021
MSG6     WTO   'IFF504I IGC0007A FOUND INVALID REQUEST CODE IN PARAMETEX81900021
               R LIST',ROUTCDE=11,DESC=7,MF=L                    S21016 82600021
MSG7     WTO   'IFF521I RLSEBFR REQUESTED WITH NON-POSITIVE BYTE COUNT'X83300021
               ,ROUTCDE=11,DESC=7,MF=L                           S21016 84000021
MSG8     WTO   'IFF514I ASGNBFR FOUND NO CONTIGUOUS SECTIONS TO SATISFYX84700021
                REQUEST',ROUTCDE=11,DESC=7,MF=L                  S21016 85400021
MSG9     WTO   'IFF502I IGC0007A FOUND DCB UNEQUAL TO DCB ADDRESS IN ASX86100021
               SOCIATED IOB',ROUTCDE=11,DESC=7,MF=L              S21016 86800021
MSG10    WTO   'IFF503I IGC0007A FOUND DCB NOT GRAPHIC',ROUTCDE=11,DESCX87500021
               =7,MF=L                                           S21016 88200021
MSG11    WTO   'IFF523I RLSEBFR REQUEST SPECIFIES BUFFER SECTION NOT ASX88900021
               SIGNED TO DEVICE',ROUTCDE=11,DESC=7,MF=L          S21016 89600021
MSG12    WTO   'IFF515I ASGNBFR UNABLE TO CLEAR REQUESTED BUFFER STORAGX89800002
               E',ROUTCDE=11,DESC=7,MF=L                                90000002
MSG13    WTO   'IFF505I IGC0007A FOUND NO BUFFER TABLE ADDRESS IN UCB',X90050000
               ROUTCDE=11,DESC=7,MF=L                         LG YM5684 90100000
         END                                                            90300021
./  ADD  SSI=72850142,NAME=IGC070
         TITLE 'GRAPHIC ATTENTION SERVICE ROUTINE'                      00020002
*********************************************************************** 00032002
*                                                                       00034002
* MODULE NAME:           IGC070 (OS/VS2)                                00036002
*                                                                       00038002
* DESCRIPTIVE NAME:      GRAPHIC ATTENTION SERVICE ROUTINE              00038402
*                                                                       00038802
* COPYRIGHT:             NONE                                           00039202
*                                                                       00039602
* STATUS:                RELEASE 2.0                                    00039702
*                                                                       00039802
* FUNCTION:              THIS MODULE PERFORMS FUNCTIONS FOR             00039902
*FILL IN FROM SPECS******CONTINUED*NEXT*PAGE*************************** 00046602
         EJECT                                                          00048602
         ENTRY SVC070                                                   00048702
IGC070   CSECT                                                          00049002
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   00050602
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  00051002
*C010000                                                         Y01021 00053200
*A007100,A009820,A010120                                     LD YA00813 00054200
*A008240-008280,A007120-007180,A009920-010200                LG @ZM2359 00055200
*A005700,A006300,A006500,A006900                             LG @ZM2359 00056200
*C010100-010130,A010160                                     D11 ZA04881 00057200
*A008290,A010350-010800                                     D11 ZA04882 00058200
*C012000,A012200-012240,015430-015460                       D11 ZA13197 00059200
*C010250                                                    E12 ZA25652 00059800
*A011205,A012185,A015925                                    E12 ZA26470 00060400
*                                                                       00061000
*                                                                       00061902
*STATUS:CHANGE LEVEL 0                                                  00066602
*FUNCTION/OPERATION:THIS ROUTINE RESETS TO 0  BIT 6 OR BIT 7 OR BOTH    00073302
*   THAT ARE LOCATED IN THE GRAPHIC CONTROL BYTE APPENDAGE TO THE       00080002
*   UNIT CONTROL BLOCK(UCB).                                            00100002
*ENTRY POINTS:SVC  070  OR USE GSERV MACRO.RESET BITS 6 AND/OR 7 IN GCB 00120002
*INPUT:GR#1 IS THE PARAMETER REGISTER.ITS CONTENTS ARE AS FOLLOWS:      00140002
*   ******************                                                  00160002
*   MASK*DCBLIST ADR*  MASK=01 FOR BIT7,02 FOR BIT6,03 FOR BOTH.        00180002
*   ******************                                                  00200002
*   DCBLIST ADR CONTAINS THE FOLLOWING INFORMATION:                     00220002
*   ****************                                                    00240002
*   * IX * DCB ADR * IX=DEB EXTENT TO ACCESS UCB ADDRESS.               00260002
*   ****************                                                    00280002
*OUTPUT:N/A                                                             00300002
*EXTERNAL ROUTINES:DEBVERIFY VIA BRANCH ENTRY.                          00320000
*EXITS NORMAL:RETURN MADE TO CALLING ROUTINE VIA SVC 3.                 00340002
*EXITS ERROR:ABNORMAL TERMINATION OF TASK.SYSTEM COMPLETION CODES ARE   00360002
*   AS FOLLOWS:                                                         00380002
*               056=INVALID UNIT CONTROL BLOCK(UCB).                    00400002
*               057=NOT A GRAPHIC UCB.                                  00420002
*TABLES/WORK AREAS:N/A                                                  00440002
*ATTRIBUTES:RE-ENTRANT                                                  00460002
*NOTES:N/A                                                              00480002
         EJECT                                                          00552002
*                                                                       00554002
*                                  STANDARD SYSTEM REGISTERS ---        00556002
*                                                                       00558002
PARMRG   EQU   1                        PARAMETER REGISTER              00560002
R1       EQU   1                       WORK REGISTER         LG @ZM2359 00570000
BASERG   EQU   2                        WORK REG                        00580002
SVCRG1   EQU   3                        WORK REG                        00600002
SVCRG2   EQU   4                        WORK REG                        00620002
CVTREG   EQU   4                                             LG @ZM2359 00630000
SVCRG3   EQU   5                        WORK REG                        00640002
CVTEXTRG EQU   5                                             LG @ZM2359 00650000
SVCRG4   EQU   6                        WORK REG                        00660002
SVCRG5   EQU   7                        WORK REG                        00680002
ASCBREG  EQU   7                                             LG @ZM2359 00690000
SVCRG6   EQU   8                        WORK REG                        00700002
R8       EQU   8                  WORK REGISTER              LG @ZM2359 00702000
SVCRG7   EQU   9                        WORK REG             LD YA00813 00710002
TCBREG   EQU   10                      LG @ZM2359                       00710400
R0       EQU   0                     WORK REGISTER           LG @ZM2359 00712000
R11      EQU   11                    WORK REGISTER           LG @ZM2359 00714000
R14      EQU   14                    WORK REGISTER           LG @ZM2359 00716000
BRREG    EQU   15                    WORK REGISTER           LG @ZM2359 00718000
R15      EQU   15                 GENERAL REGISTER 15        LG @ZM2359 00718400
*                                                                       00720002
*          CONSTANTS USED IN THIS MODULE                              * 00722002
*                                                                     * 00724002
ZERO     EQU   0                       ZERO DISPLACEMENT      LB Y01021 00730002
UCBADR   EQU   32                       START OF UCB LIST IN DEB        00740002
DEBADR   EQU   44                       START OF DEB ADDRESS IN DCB     00760002
GCBADR   EQU   24                       START OF UCB GRAPHIC EXTENSION  00780002
EXIT     EQU   3                                                        00800002
GUCBTYP  EQU   18                  LOCATION OF DEVTYPE IN UCB           00810000
RC4      EQU   4                     RETCD VALUE OF 4        LG @ZM2359 00824000
CRNTASCB EQU   12                                            LG @ZM2359 00826000
CRRNTTCB EQU   4                                             LG @ZM2359 00828000
NUMUCB   EQU   16                  DISPL IN DEB OF NUMUCBS  D11 ZA04882 00829000
         EJECT                                                          00830002
SVC070   DS    0D                      ALIGN SVC TO A DBLE WORD BNDRY   00880002
         BALR  BASERG,0                 SET UP BASE REGISTER            00900002
         USING *,BASERG                 DEFINE BASE REGISTER            00920002
         B     MODID2              HOP AROUND EYECATCHER                00930000
MODID    DC    C'IGC070.VS2R3.&SYSDATE'         MODULE EYECATCHER ID    00940000
MODID2   L     SVCRG4,0(0,PARMRG)       LOAD DCB ADDRESS AND INDX FACTR 00950000
         LR    SVCRG1,SVCRG4            TRANSFER INDEX FACTOR           00960002
         SRL   SVCRG1,24                POSITION INDEX FACTOR           00980002
         LR    SVCRG7,PARMRG            SAVE REG1            LD YA00813 00982002
         LA    SVCRG4,ZERO(SVCRG4)     DCB ADDRESS            LB Y01021 00990002
         LR    R8,R14                SAVE REG 14             LG @ZM2359 00992000
         L     R1,DEBADR(SVCRG4)       LD DEB ADDR           LG @ZM2359 00994000
         USING CVT,CVTREG              BASE FOR CVT          LG @ZM2359 00996000
         USING CVTXTNT2,CVTEXTRG       BASE FOR CVT EXT2     LG @ZM2359 00998000
         L     CVTREG,CVTPTR           LD ADDR CVT           LG @ZM2359 00998400
         L     CVTEXTRG,CVTEXT2        LD ADDR CVT EXT2      LG @ZM2359 00998800
         L     TCBREG,CVTTCBP          LD TCB PTRS           LG @ZM2359 00999200
         L     ASCBREG,CRNTASCB(TCBREG)  LD ADDR CURR ASCB   LG @ZM2359 00999600
         L     TCBREG,CRRNTTCB(TCBREG)  LD ADDR CURR TCB     LG @ZM2359 00999700
         L     BRREG,CVTDEBVR          LD ADDR DEB VERIFY    LG @ZM2359 00999800
         SR    R0,R0                   CLEAR REGISTER        LG @ZM2359 00999900
         BALR  R14,BRREG               GO DO DEBVERIFY       LG @ZM2359 01004900
         B     GOODCB              DEB IS VALID (+0)        D11 ZA04881 01010000
         LR    R14,R8              RESTORE R14              D11 ZA04881 01013000
         B     BADDCB              DEB INVALID              D11 ZA04881 01016000
GOODCB   LR    R14,R8              RESTORE R14              D11 ZA04881 01019000
         LR    SVCRG4,R1               PUT DEB ADDR IN R4   E12 ZA25652 01025000
         LR    PARMRG,SVCRG7            RESTORE REG1         LD YA00813 01030002
         CLM   SVCRG1,1,NUMUCB(SVCRG4) USERUCB GT DEBUCB?   D11 ZA04882 01032000
         BH    BADDCB              YES,INVALID PARAMETER    D11 ZA04882 01042000
         SLL   SVCRG1,2            X4(EACH UCB IN DEB LN=4) D11 ZA04882 01052000
         L     SVCRG4,UCBADR(SVCRG1,SVCRG4)  LOAD UCB ADDR  D11 ZA04882 01062000
         TM    2(SVCRG4),X'FF'          TEST FOR VALID UCB  ID          01100002
         BO    GCBCHK                   BRANCH IF VALID     D11         01120000
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(IEAVESVC)      E12 ZA26470 01123000
         WTO   'IFF421I GSERV FOUND INVALID UCB',                S21016X01126002
               ROUTCDE=11,DESC=7                                 S21016 01132002
         LA    1,X'056'                LOAD ABEND ERROR CODE            01140002
         SLL   1,12                    POSITION CODE                    01160002
         ABEND (1),DUMP                                                 01180002
BADDCB   EQU   *                                             LG @ZM2359 01182000
         LA    R15,RC4               LD RETCD OF 4           LG @ZM2359 01184000
         BR    R14                   RETURN                  LG @ZM2359 01186000
         EJECT                                                          01190002
GCBCHK   CLC   GUCBTYP(2,SVCRG4),G2250  IS UCB FOR A 2250?  D11 ZA13197 01200000
         BE    RESET                    BRANCH IF VALID UCB D11 ZA13197 01206000
         CLC   GUCBTYP(2,SVCRG4),G2260  IS UCB FOR A 2260?  D11 ZA13197 01212000
         BE    RESET                    BRANCH IF VALID UCB D11 ZA13197 01218000
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(IEAVESVC)      E12 ZA26470 01222000
         WTO   'IFF422I DEVICE NOT SUPPORTED BY GAM',       D11 ZA13197X01226000
               ROUTCDE=11,DESC=7                                 S21016 01232002
         LA    1,X'057'                LOAD ABEND ERROR CODE            01240002
         SLL   1,12                    POSITION CODE                    01260002
         ABEND (1),DUMP                                                 01280002
RESET    SRL   PARMRG,24                POSITION BIT INDICATOR          01300002
         LA    SVCRG1,3                 LOAD PROTECT MASK FOR GRAPHIC   01320002
*                                       SUPERVISOR BITS IN GCB          01340002
         NR    PARMRG,SVCRG1            MASK OUT ANY USER REQUEST TO    01360002
*                                       RESET PROTECTED GRAPHIC         01380002
*                                       SUPERVISOR BITS IN GCB          01400002
         LA    SVCRG1,X'FF'             LOAD INITIAL RESET MASK         01420002
         XR    PARMRG,SVCRG1            DETERMINE FINAL RESETMASK       01440002
         L     SVCRG1,GCBADR(0,SVCRG4)  LOAD GCB                        01460002
         NR    PARMRG,SVCRG1            RESET SPECIFIED GCB BITS        01480002
         STC   PARMRG,GCBADR+3(0,SVCRG4)     STORE NEW GCB BYTE         01500002
         LA    PARMRG,0                 INDICATE NORMAL RETURN          01520002
         BR    14                                                       01540002
G2250    DC    X'1002'             UCBTYPE FOR 2250         D11 ZA13197 01543000
G2260    DC    X'1003'             UCBTYPE FOR 2260         D11 ZA13197 01546000
PATCH    DS    0F                 40 BYTE PATCH AREA        D11 @ZM2359 01550000
         DC    40X'FF'                                      D11         01560000
         CNOP  0,8                                                      01580002
         EJECT                                                          01590002
         CVT   DSECT=YES                                                01592002
         IHAPSA                                             E12 ZA26470 01596000
         END                                                            01600002
./  ADD  SSI=72360275,NAME=IGC084
         TITLE 'IGC084  ---- STORE BUFFER RESTART ADDRESS'  D11         03000000
*STATUS: CHANGE LEVEL 000                                               06000002
*FUNCTION/OPERATION: STORES THE BUFFER RESTART ADDRESS IN THE UCB       09000002
*ENTRY POINT:  IGC084                                       D11         12000000
*INPUT: IN REGISTER 0 -THE 16 HIGH ORDER BITS CONTAIN THE BUFFER        14000000
*   RESTART ADDRESS; THE 16 LOW ORDER BITS CONTAIN THE ADDRESS OF       16000000
*   THE UCB.                                                            18000000
*       IN REGISTER 1-ADDRESS DCB                            LG @ZM2358 21050000
*OUTPUT: THE BUFFER RESTART ADDRESS STORED IN THE UCB                   24000002
*EXTERNAL ROUTINES: DEBCHK(VIA BRANCH ENTRY)                D11         27000000
*EXITS-NORMAL: RETURN TO GIOCR VIA REG14                                30000002
*     -ERRORS: NONE                                                     33000002
*TABLES/WORK AREAS: NONE                                                36000002
*ATTRIBUTES: TYPE 1, RESIDENT, SUPERVISOR STATE, REENTRANT              39000002
*NOTES - NONE                                                           42000002
         EJECT                                                          45000002
IGC084   CSECT                                                          48000002
*C630000,840000                                               LF YM4067 48050002
*A84100-849500,A720500-723000,A540500-54900,A550000          LG @ZM2358 48060000
*D570000-630000                                              LG @ZM2358 48070000
*A547650-547950,660200,847200                               D11 ZA04879 48080000
*C546000-546500,A547000                                     D11 ZA04880 48090000
*A547960-547980,A660300                                     D11 ZA13198 48990000
*A54220002,C54760002,A72125002                              D11 ZA13201 49890000
         EJECT                                              D11         51000000
         BALR  BASE,0              EST BASE REG                         52000000
         USING *,BASE              AM USING REG 12                      54000002
         B     MODID               HOP AROUND EYECATCHER                54010000
         DC    C' IGC084.VS2R3.&SYSDATE'    MODULE EYECATCHER           54040000
MODID    LR    R8,REGZERO            SAVE REGISTER 0         LG @ZM2358 54070000
         LR    R5,REGONE             SAVE REGISTER 1         LG @ZM2358 54100000
         LR    R6,REG14              SAVE REGISTER 14        LG @ZM2358 54150000
         L     DEBREG,DCBDEB(DCBREG) LD DEB ADDR             LG @ZM2358 54200000
         LR    R2,DEBREG THO I WALK THRU THE SHADOW OF MVS  D11 ZA13201 54220000
         USING CVT,CVTREG              BASE FOR CVT          LG @ZM2358 54250000
         USING CVTXTNT2,CVTEXTRG       BASE FOR EXT2         LG @ZM2358 54300000
         L     CVTREG,CVTPTR           LD ADDR CVT           LG @ZM2358 54350000
         L     CVTEXTRG,CVTEXT2        LD ADDR EXT2          LG @ZM2358 54400000
         L     TCBREG,CVTTCBP          LD TCB PTRS           LG @ZM2358 54450000
         L     ASCBREG,CRNTASCB(TCBREG) LD ADR CURR ASCB     LG @ZM2358 54500000
         L     TCBREG,CRRNTTCB(TCBREG)  LD ADR CURR TCB      LG @ZM2358 54550000
         L     BRREG,CVTDEBVR          LD ADDR DEBVERIFY     LG @ZM2358 54560000
         SR    REGZERO,REGZERO         CLR REG 0             LG @ZM2358 54570000
         BALR  REG14,BRREG             GO TO DEB VERIFY      LG @ZM2358 54580000
         B     GOODEB              DEB IS GOOD (+0)         D11 ZA04880 54600000
         B     LEAVE               DEB IS INVALID (+4)      D11 YA04880 54650000
GOODEB   SRDL  R8,SIXTEEN            SHIFT UCB TO REG 9     D11 YA04880 54700000
         SRL   R9,SIXTEEN            RIGHT JUSTIFY UCB@      LG @ZM2358 54750000
         LR    R5,R2          I SHALL NOT FEAR DEBCHECK     D11 ZA13201 54760000
         SR    R11,R11             FOR IC                   D11 YA04879 54765000
         IC    R11,NUMUCB(R5)      GET NUMUCBS FROM DEB     D11 YA04879 54770000
         SLL   R11,2               X4(EACH DSCRPTR 4 LONG)  D11 YA04879 54775000
         LA    R11,32(R11,R5) DEBADR+DEBLEN+NUMUCBS(EACH4)  D11 YA04879 54780000
* PREV INSTR POINTS R11 TO 1ST SBRTN LOADED BY OPEN         D11 YA04879 54785000
         CLC   0(2,R11),SBNAME     BETTER BE 'OA'!!         D11 YA04879 54790000
         BNE   LEAVE  ITS NOT,SO NOT GAM,SO INVALID DEB     D11 YA04879 54795000
         CLC   GUCBTYP(2,R9),G2250 PASSED UCB A 2250?       D11 ZA13198 54796000
         BNE   LEAVE               NO,SORRY BOUT THAT       D11 ZA13198 54797000
         CLM   R9,SEVEN,DEBUCB(R5)   IS PASSED UCB VALID?    LG @ZM2358 54800000
         BNE   LEAVE                 NO...LEAVE              LG @ZM2358 54850000
         STH   R8,UCBBSTR(R9)        STR RESTART ADDRESS     LG @ZM2358 54900000
LEAVE    EQU   *                                                        54950000
         LR    REG14,R6              RESTORE RETURN REG      LG @ZM2358 55000000
         BR    REG14                    RETURN TO GIOCR                 66000002
SBNAME   DC    C'OA' LST 2CHRS 1ST GAM MOD LOADED BY OPEN   D11 YA04879 66020000
G2250    DC    X'1002'             2250 DEVTYPE IN UCB      D11 ZA13198 66030000
PATCH    DS    0F                                           D11 @ZM2358 66050000
         DC    40X'FF'            40 BYTE PATCH AREA        D11 @ZM2358 67050000
REGZERO  EQU   0                        REGISTER 0                      69000002
REGONE   EQU   1                        REGISTER 1                      72000002
DCBREG   EQU   1                                             LG @ZM2358 72050000
DEBREG   EQU   1                                             LG @ZM2358 72100000
R2       EQU   2              SAFE HOLDER FOR DEBADDR       D11 ZA13201 72120000
CVTREG   EQU   3                                             LG @ZM2358 72150000
CVTEXTRG EQU   4                                             LG @ZM2358 72200000
R5       EQU   5                                             LG @ZM2358 72250000
R6       EQU   6                  GENERAL REG 6              LG @ZM2358 72260000
ASCBREG  EQU   7                                             LG @ZM2358 72300000
TCBREG   EQU   10                                            LG @ZM2358 72350000
BASE     EQU   12                       BASE REGISTER                   75000002
REG14    EQU   14                       RETURN REGISTER                 78000002
SIXTEEN  EQU   16                       CONSTANT                        81000002
UCBBSTR  EQU   24              BUFFER RESTART ADDR            LF YM4067 84000002
GUCBTYP  EQU   18                  UCBTYPE DISPL IN UCB     D11         84100000
R8       EQU   8                     WORK REGISTER           LG @ZM2358 84120000
R9       EQU   9                     WORK REGISTER           LG @ZM2358 84150000
R11      EQU   11                    WORK REGISTER           LG @ZM2358 84250000
R15      EQU   15                    WORK REGISTER           LG @ZM2358 84300000
SEVEN    EQU   7                       VALUE OF 7            LG @ZM2358 84600000
DEBUCB   EQU   33                      DISP OF UCB IN DEB    LG @ZM2358 84650000
DCBDEB   EQU   44                      DISP DEB IN DCB       LG @ZM2358 84700000
NUMUCB   EQU   16     DISPL IN DEB OF NUMUCBS BYTE          D11 YA04879 84720000
CRNTASCB EQU   12                                            LG @ZM2358 84750000
BRREG    EQU   15                                            LG @ZM2358 84800000
CRRNTTCB EQU   4                                             LG @ZM2358 84850000
CVT      DSECT                                               LG @ZM2358 84900000
         CVT   LIST=YES                                      LG @ZM2358 84950000
         END                                                            87000002
./  ADD  SSI=72360082,NAME=IGE0010A
         TITLE 'IGE0010A LOCAL 2250 ERROR RECOVERY PROCEDURE'           00100000
IGE0010A CSECT                                                          00200000
*********************************************************************** 00300000
*                                                                     * 00400000
* MODULE NAME:                                                        * 00500000
*    IGE0010A                                                         * 00600000
*                                                                     * 00700000
* DESCRIPTIVE NAME:                                                   * 00800000
*    LOCAL 2250 ERROR RECOVERY PROCEDURE                              * 00900000
*                                                                     * 01000000
* COPYRIGHT:                                                          * 01100000
*    NONE                                                             * 01200000
*                                                                     * 01300000
* STATUS:                                                             * 01400000
*    CHANGE LEVEL 000                                                 * 01500000
*                                                                     * 01600000
* FUNCTION:                                                           * 01700000
*    THIS MODULE IS THE ERP FOR LOCALLY ATTACHED  DEVICES OF THE      * 01800000
*    2250 DISPAY SYSTEM. THE MODULE IS SCHEDULED BY IOS.              * 01900000
*    THE FOLLOWING FUNCTIONS ARE PERFORMED BY THIS MODULE:            * 02000000
*        * DETERMINES IF AN ERROR IS RETRYABLE BY THE ERP AND RETRIES * 02100000
*          THOSE THAT ARE.                                            * 02200000
*        * DETERMINES IF ERP RETRIES ARE SUCCESSFUL.                  * 02300000
*        * MAINTAINS THE STATISTICS TABLE FOR THE DEVICE.             * 02400000
*        * REQUESTS OBR LOGOUT WHEN REQUIRED.                         * 02500000
*        * REQUESTS INT REQ OR PERM ERROR MESSAGES WHEN REQUIRED.     * 02600000
*                                                                     * 02700000
* NOTES:                                                              * 02800000
*    DEPENDENCIES:                                                    * 02900000
*        NONE                                                         * 03000000
*    RESTRICTIONS:                                                    * 03100000
*        THIS ERP IS FOR LOCALLY ATTACHED DEVICES ONLY USING EXCP     * 03200000
*    REGISTER CONVENTIONS:                                            * 03300000
*        SEE 'REGISTER DEFINITIONS' BELOW                             * 03400000
*                                                                     * 03500000
* PATCH LABEL:                                                        * 03600000
*    PACHAREA (80 BYTES)                                              * 03700000
*                                                                     * 03800000
* MODULE TYPE:                                                        * 03900000
*    PROCEDURE                                                        * 04000000
*    PROCESSOR:                                                       * 04100000
*        BAL                                                          * 04200000
*    MODULE SIZE:                                                     * 04300000
*        784 BYTES                                                    * 04400000
*    ATTRIBUTES:                                                      * 04500000
*        REENTRANT, ENABLED, KEY 0, SUPERVISOR STATE, NO LOCKS HELD   * 04600000
*                                                                     * 04700000
* ENTRY POINT:                                                        * 04800000
*    IGE0010A                                                         * 04900000
*    PURPOSE:                                                         * 05000000
*        THIS MODULE IS ENTERED WHEN ONE OR MORE OF THE FOLLOWING     * 05100000
*        CONDITIONS IS ENCOUNTERED:                                   * 05200000
*            UNIT CHECK                                               * 05300000
*            UNIT EXCEPTION                                           * 05400000
*            INVALID COMMAND SEQUENCE                                 * 05500000
*            INCORRECT LENGTH                                         * 05600000
*            PROGRAM CHECK                                            * 05700000
*            PROTECTION CHECK                                         * 05800000
*            CHAINING CHECK                                           * 05900000
*            CHANNEL DATA CHECK                                       * 06000000
*            INTERFACE CONTROL CHECK                                  * 06100000
*            CHANNEL CONTROL CHECK                                    * 06200000
*            COMMAND REJECT                                           * 06300000
*    LINKAGE:                                                         * 06400000
*        THIS MODULE IS SCHEDULED FOR EXECUTION BY THE INPUT/OUTPUT   * 06500000
*        SUPERVISOR. IT RUNS UNDER AN SIRB.                           * 06600000
*    INPUT:                                                           * 06700000
*        REG 1 = ADDRESS OF IOSB                                      * 06800000
*    OUTPUT:                                                          * 06900000
*        RECOVERABLE ERRORS:                                          * 07000000
*            IOSERR IS SET ON FOR RETRY                               * 07100000
*            IF A MESSAGE IS TO BE ISSUED, EXIT IS MADE TO IGE0025C   * 07200000
*            IF NO MESSAGE, SVC 15 IS ISSUED, THEN EXIT IS VIA SVC 3  * 07300000
*        CORRECTED ERRORS:                                            * 07400000
*            IOSEX AND IOSERR ARE SET OFF                             * 07500000
*            IOSB IS CLEANED UP                                       * 07600000
*            EXIT IS TO IGE0025D TO UPDATE STATISTICS TABLE           * 07700000
*        PERMANENT ERRORS:                                            * 07800000
*            AN OBR LOGOUT IS SCHEDULED                               * 07900000
*            A STATISTIC TABLE UPDATE IS SCHEDULED                    * 08000000
*            IOSEX IS SET ON                                          * 08100000
*            IOSERR IS SET OFF                                        * 08200000
*            EXIT IS TO IGE0025C TO ISSUE PERM ERROR MESSAGE          * 08300000
*        PROGRAMMING ERRORS:                                          * 08400000
*            SVC 15 IS ISSUED                                         * 08500000
*            IOSEX IS SET ON                                          * 08600000
*            IOSERR IS SET OFF                                        * 08700000
*            EXIT IS VIA SVC 3                                        * 08800000
*                                                                     * 08900000
* EXITS-NORMAL:                                                       * 09000000
*    SUPERVISOR VIA SVC 3                                             * 09100000
*    STATISTICS UPDATE ROUTINE (IGE0025D) VIA BRANCH ENTRY TO XCTL    * 09200000
*    IOS-WTO ROUTINE (IGE0025C) VIA BRANCH ENTRY TO XCTL              * 09300000
*                                                                     * 09400000
* EXITS-ERROR:                                                        * 09500000
*    NONE                                                             * 09600000
*                                                                     * 09700000
* EXTERNAL REFERENCES:                                                * 09800000
*    ROUTINES:                                                        * 09900000
*        SVC 15 ERROR EXCP                                            * 10000000
*    DATA AREAS                                                       * 10100000
*        CHANNEL PROGRAM                                              * 10200000
*        ERP WORKAREA (MAPPED BY IECDERWA)                            * 10300000
*    CONTROL BLOCKS                                                   * 10400000
*        UCB          (MAPPED BY IEFUCBOB)                            * 10500000
*        IOSB         (MAPPED BY IECDIOSB)                            * 10600000
*        CVT          (MAPPED BY CVT)                                 * 10700000
*        RQE          (MAPPED BY IECDRQE)                             * 10800000
*        IOB          (MAPPED BY IEZIOB)                              * 10900000
*        DCB          (MAPPED BY DCBD)                                * 11000000
*                                                                     * 11100000
* TABLES-WORKAREAS:                                                   * 11200000
*    ERP WORKAREA                                                     * 11300000
*                                                                     * 11400000
* MACROS:                                                             * 11500000
*    NONE                                                             * 11600000
*                                                                     * 11700000
* CHANGE ACTIVITY:                                                    * 11800000
*    YM02594K (11/6/73)                                               * 11900000
*    ZA14030  (10/7/76)                                     D11       * 12000000
*                                                                     * 12100000
*********************************************************************** 12200000
         EJECT                                                          12300000
*/*IGE0010A: CHART */                                                   12400000
*/* E IGE0010A */                                                       12500000
*/* D (YES,,NO,PERMER) EXCP */                                          12600000
*/* D (YES,,NO,START) FIRST ENTRY */                                    12700000
*/* P CLEAR EWASTUP */                                                  12800000
*/*START: P SET ERP IN CONTROL */                                       12900000
*/* D (YES,RECOVER,NO,) ICC OR CCC */                                   13000000
*/* D (YES,SEROUT,NO,) BAD STATUS */                                    13100000
*/* D (YES,MODEL23,NO,) MOD 2 OR 3 */                                   13200000
*/* D (YES,,NO,SEROUT) MOD 1 */                                         13300000
*/* D (YES,SEROUT,NO,) BAD MOD 1 STATUS */                              13400000
*/*MODEL23: D (YES,SEROUT,NO,) BAD MOD 2 OR 3 STATUS */                 13500000
*/*ER224: D (YES,MAINER,NO,) UNIT CHECK */                              13600000
*/*TESTST: D (YES,TESTCONT,NO,) CDC */                                  13700000
*/* D (YES,WTORTN,NO,) CDC RETRIED */                                   13800000
*/* P (,RETRY) INDICATE CDC RETRIED */                                  13900000
*/*TESTCONT: D (YES,,NO,PERMER) PROG OR PROT CHECK */                   14000000
*/* D (YES,,NO,CLEARUC) INCORRECT LENGTH */                             14100000
*/* P (,PERMER) RESET ERP ENTERED IN IOB */                             14200000
*/*CLEARUC: P (,NOERR) RESET UNIT CHECK IN IOSB */                      14300000
*/*NOERR: P (,RESET) RESET IOB AND IOSB ERP FLAGS */                    14400000
*/*MAINER: P RESET ERROR CORRECTION FLAGS IN DCB */                     14500000
*/* D (YES,SEROUT,NO,) IOSB INTERCEPT */                                14600000
*/* D (YES,MODL23,NO,) MOD 2 OR 3 */                                    14700000
*/* D (YES,,NO,SEROUT) MOD 1 */                                         14800000
*/* D (YES,MOD1BSC,NO,) BAD SENSE BYTE 1 */                             14900000
*/* D (YES,SEROUT,NO,NEXT) BAD SENSE BYTE 2 */                          15000000
*/*MODL23: D (YES,CKINTREQ,NO,) BAD SENSE BYTE 1 */                     15100000
*/* D (YES,SEROUT,NO,) BAD SENSE BYTE 2 */                              15200000
*/*NEXT: D (YES,SEROUT,NO,) COM REJ AND BUF RUN */                      15300000
*/* D (YES,ISCEDE,NO,) CHAN END AND DEV END */                          15400000
*/* D (YES,NOERR,NO,) ATTENTION */                                      15500000
*/* D (YES,BO1CHK,NO,) BUS OUT CHK */                                   15600000
*/* D (YES,PERMER,NO,) COM REJ, BUF RUN, DATA CHK */                    15700000
*/* D (YES,MOD1BSC,NO,) EQUIP CHECK */                                  15800000
*/* D (YES,SEROUT,NO,TESTST) INPUT/OUTPUT CHECK */                      15900000
*/*BO1CHK: D (YES,WTORTN,NO,) BUSOUT RETRIED */                         16000000
*/* P (,RETRY) SET BUSOUT RETRIED */                                    16100000
*/*ISCEDE: D (YES,BUSERR,NO,) BUS ERR */                                16200000
*/* D (YES,DATACX,NO,) DATA CHECK */                                    16300000
*/* D (YES,MODTWO,NO,TESTST) MOD 2 OR 3 */                              16400000
*/*DATACX: D (YES,WTORTN,NO,) DATA CHK RETRIED */                       16500000
*/* P (,RETRY) SET DATA CHECK RETRIED */                                16600000
*/*BUSERR: D (YES,WTORTN,NO,) BUS ERR RETRIED */                        16700000
*/* P (,RETRY) SET BUS ERR RETRIED */                                   16800000
*/*MODTWO: D (YES,INPERR,NO,) INPUT ERROR */                            16900000
*/* D (YES,OUTERR,NO,) OUTPUT ERROR */                                  17000000
*/* D (YES,,NO,TESTST) EQUIP CHECK */                                   17100000
*/* D (YES,WTORTN,NO,) ERROR RETRIED */                                 17200000
*/* P (,RETRY) SET EQUIP CHECK RETRIED */                               17300000
*/*RETRY: S SVC 15: ERROR EXCP */                                       17400000
*/* R SVC 3 */                                                          17500000
*/*INPERR: D (YES,WTORTN,NO,) INPUT ERR RETRIED */                      17600000
*/* P (,RETRY) SET INPUT ERR RETRIED */                                 17700000
*/*OUTERR: D (YES,WTORTN,NO,) OUTPUT ERR RETRIED */                     17800000
*/* P (,RETRY) SET OUTPUT ERR RETRIED */                                17900000
*/*SEROUT: P INDICATE LOGOUT REQUIRED */                                18000000
*/*PERMER: P INDICATE PERMANENT ERROR */                                18100000
*/*RESET: P CLEAR ALL RETRY FLAGS */                                    18200000
*/* P (,XCTL) LOAD STAT UPDATE ROUTINE NAME */                          18300000
*/*MOD1BSC: D (YES,,NO,CKINTREQ) EQUIP CHECK */                         18400000
*/* D (YES,NOERR,NO,WTORTN) ATTENTION */                                18500000
*/*CKINTREQ: D (YES,WTORTN,NO,SEROUT) INT REQ */                        18600000
*/*RECOVER: D (YES,ASROUT,NO,) ICC OR CCC RETRIED */                    18700000
*/* D (YES,ASROUT,NO,) IOSB INTERCEPT */                                18800000
*/* D (YES,ASROUT,NO,) UNCOND NO RETRY */                               18900000
*/* D (YES,MORETEST,NO,RETRY2) ERPIB CODE 2 */                          19000000
*/*RETRY2: P SET ICC OR CCC RETRIED */                                  19100000
*/* P (,RETRY) ZERO OUT ERPIB */                                        19200000
*/*MORETEST: D (YES,SIOTST,NO,) SIO */                                  19300000
*/* D (YES,,NO,ASROUT) VALID COMMAND */                                 19400000
*/* P FIND PREVIOUS CCW */                                              19500000
*/* D (YES,ASROUT,NO,) PAST START OF CCWS */                            19600000
*/*CONTCCW: D (YES,ASROUT,NO,) READXY */                                19700000
*/* D (YES,ASROUT,NO,RETRY2) READMI */                                  19800000
*/*SIOTST: P (,CONTCCW) POINT TO SIO CCW AND IOSB */        D11 ZA14030 19900000
*/*ASROUT: P (,WTORTN) ZERO ERPIB */                                    20000000
*/*WTORTN: D (YES,SEROUT,NO,) OP CONSOLE */                             20100000
*/* P SET PERM ERROR AND LOGOUT REQUIRED */                             20200000
*/* P CLEAR RETRY INDICATORS */                                         20300000
*/* P (,XCTL) LOAD WTO ROUTINE NAME */                                  20400000
*/*XCTL: P MOVE SENSE TO STAT ROUTINE FIELD IN IOSB */                  20500000
*/* R BRANCH REG 14 */                                                  20600000
         EJECT                                                          20700000
         USING *,BASERG                                                 20800000
         LR    BASERG,ERREG2       BASE PROGRAM                         20900000
         USING EWA,ERPWAREG                                             21000000
         USING CVTMAP,CVTREG                                            21100000
         USING IOSB,IOSBREG                                             21200000
         USING UCBSET,UCBREG                                            21300000
         USING IOBSTDRD,IOBREG                                          21400000
         USING RQE,RQEREG                                               21500000
         LR    IOSBREG,PARMREG          LOAD IOSB POINTER               21600000
         L     CVTREG,CVTPTR            LOAD CVT POINTER                21700000
         L     UCBREG,IOSUCB            BASE UCB                        21800000
         L     ERPWAREG,IOSERP          LOAD ERP WORKAREA POINTER       21900000
         L     RQEREG,IOSUSE            BASE RQE                        22000000
         L     IOBREG,RQEIOB            BASE IOB                        22100000
         DROP  RQEREG                                                   22200000
         CLI   IOSDVRID,IOSXCPID        EXCP I/O                        22300000
         BNE   PERMER                   NO,PERM ERROR                   22400000
         TM    IOSFLA,IOSERR           FIRST ENTRY                      22500000
         BO    START                   NO                               22600000
         XC    EWASTUP(N2),EWASTUP     CLEAR STAT UPDATE AREA           22700000
START    EQU   *                                                        22800000
         OI    IOSFLA,IOSERR+IOSEX      TURN ON ERROR BITS IN IOSB      22900000
         OI    IOBFLAG1,IOBERRTN+IOBIOERR   ALSO IN IOB                 23000000
         OI    IOBERRCT,HEX01+HEX02     FLAGS FOR CHANNEL END APPENDAGE 23100000
         TM    IOSTSB,ASRCHK            TEST FOR CCC OR ICC             23200000
         BNZ   RECOVER                  ANY OR ALL ON                   23300000
         TM    IOSTSB,CHAIN             SHOULD NOT OCCUR STATUS         23400000
         BNZ   SEROUT                   BRANCH IF ANY OR ALL SET        23500000
         TM    UCBTBYT1,MODEL2          2250 MODEL 2 OR 3               23600000
         BO    MODEL23                  YES                             23700000
         TM    UCBTBYT1,MODEL1          2250 MODEL 1                    23800000
         BNO   SEROUT                   NO                              23900000
         TM    IOSTSA,BADSTAT1          BAD STATUS FOR MOD 1            24000000
         BNZ   SEROUT                   BRANCH IF ANY OR ALL            24100000
MODEL23  EQU   *                                                        24200000
         TM    IOSTSA,BADSTAT2          BAD STATUS FOR MOD 2/3          24300000
         BNZ   SEROUT                   BRANCH IF ANY OR ALL            24400000
         TM    IOSTSB,CDCBIT            CHECK IF CHAN RETRY POSSIBLE    24500000
         BNO   ER224                    IF CHANNEL OK, CONTINUE         24600000
         OI    EWASTUP+N1,HEX01         SET CDC FOR STAT UPDATE         24700000
ER224    EQU   *                                                        24800000
         TM    IOSTSA,UNITCK            UC PRIORITY OVER CDC            24900000
         BO    MAINER                   BRANCH IF UNIT CHECK PRESENT    25000000
TESTST   EQU   *                                                        25100000
         TM    IOSTSB,CDCBIT            CHECK IF CHAN RETRY POSSIBLE    25200000
         BNO   TESTCONT                 IF CHANNEL OK, CONTINUE         25300000
         TM    EWACNTR2,CDCIND          FIRST RETRY                     25400000
         BO    WTORTN                   IF NOT, NOTIFY OPERATOR         25500000
         OI    EWACNTR2,CDCIND          IF YES, SET SWITCH              25600000
         B     RETRY                    RESTART CHANNEL                 25700000
TESTCONT EQU   *                                                        25800000
         TM    IOSTSB,ST2ALL            PROGRAM CHECK/PROTECTION CHECK  25900000
         BNZ   PERMER                   BRANCH IF ANY OR ALL PRESENT    26000000
         TM    IOSTSB,INCLEN            INCORRECT LENGTH                26100000
         BNO   CLEARUC                  NO                              26200000
         NI    IOBERRCT,N255-HEX02      RESET ERP ENTERED               26300000
         B     PERMER                   GO SET REST OF INDICATORS       26400000
CLEARUC  EQU   *                                                        26500000
         NI    IOSTSA,N255-UNITCK       RESET UNIT CHECK STATUS         26600000
NOERR    EQU   *                                                        26700000
         NI    IOSFLA,N255-IOSEX-IOSERR   CLEAR IOSB ERROR FLAGS        26800000
         NI    IOBFLAG1,N255-IOBERRTN-IOBIOERR   ALSO IN IOB            26900000
         NI    IOSFLB,N255-IOSMSG-IOSLOG   CLEAR IOSB ERROR FLAGS       27000000
         NI    IOBERRCT,N255-HEX02      RESET ERP ENTERED               27100000
         B     RESET                    LEAVE                           27200000
MAINER   EQU   *                                                        27300000
         USING IHADCB,ERREG5                                            27400000
         L     ERREG5,IOBDCBPT          BASE DCB                        27500000
         NI    DCBIFLGS,N255-DCBIFEC    RESET ERROR CORRECTION FLAGS    27600000
         DROP  ERREG5                                                   27700000
         CLI   IOSCOD,IOSFINTC          IOSB INTERCEPT                  27800000
         BE    SEROUT                   IF YES TAKE BRANCH              27900000
         TM    UCBTBYT1,MODEL2          2250 MOD 2 OR 3                 28000000
         BO    MODL23                   YES                             28100000
         TM    UCBTBYT1,MODEL1          2250 MOD 1                      28200000
         BNO   SEROUT                   NO                              28300000
         TM    IOSSNS,SNOCUR            SHOULD NOT OCCUR SENSE          28400000
         BNZ   MOD1BSC                  TEST FOR EC OR IR               28500000
         TM    IOSSNS+N1,SNOCUR12       SHOULD NOT OCCUR MOD 1 SENSE    28600000
         BNZ   SEROUT                   BRANCH IF ANY OR ALL PRESENT    28700000
         B     NEXT                     CONTINUE TESTING                28800000
MODL23   EQU   *                                                        28900000
         TM    IOSSNS,SNOCUR2           TEST FOR SHOULD NOT OCCUR       29000000
         BNZ   CKINTREQ                 ANY OR ALL PRESENT              29100000
         TM    IOSSNS+N1,SNOCUR22       TEST FOR SHOULD NOT OCCUR       29200000
         BNZ   SEROUT                   ANY OR ALL PRESENT              29300000
NEXT     EQU   *                                                        29400000
         TM    IOSSNS,CRJBRN            COMMAND REJECT/BUFFER RUNNING   29500000
         BO    SEROUT                   BRANCH IF BOTH PRESENT          29600000
         TM    IOSTSA,CHNEND+DEVEND     CHAN END/DEV END                29700000
         BO    ISCEDE                   BRANCH IF YES                   29800000
         TM    IOSTSA,ATTENT            TEST FOR ATTENTION              29900000
         BO    NOERR                    BRANCH IF PRESENT               30000000
         TM    IOSSNS,BUSOUT            TEST FOR BUS OUT CHECK          30100000
         BO    BO1CHK                   BRANCH IF PRESENT               30200000
         TM    IOSSNS,CRJBRN+DATACK     COMMAND REJECT/DATA CHECK       30300000
*                                       OR BUFFER RUNNING               30400000
         BNZ   PERMER                   BRANCH ANY OR ALL PRESENT       30500000
         TM    IOSSNS,EQPCHK            EQUIPMENT CHECK                 30600000
         BO    MOD1BSC                  YES                             30700000
         TM    IOSSNS+N1,INCHK+OUTCHK   INPUT/OUTPUT CHECK              30800000
         BNZ   SEROUT                   BRANCH ANY OR ALL PRESENT       30900000
         B     TESTST                   BRANCH                          31000000
BO1CHK   EQU   *                                                        31100000
         TM    EWACNTR1,BO1IND          HAS ERROR BEEN RETRIED          31200000
         BO    WTORTN                   BRANCH IF YES                   31300000
         OI    EWACNTR1,BO1IND          SET RETRY INDICATOR             31400000
         B     RETRY                    BRANCH TO RETRY EXIT            31500000
ISCEDE   EQU   *                                                        31600000
         TM    IOSSNS,BUSOUT            TEST FOR BUS OUT                31700000
         BO    BUSERR                   BRANCH IF YES                   31800000
         TM    IOSSNS,DATACK            TEST FOR DATA CHECK             31900000
         BO    DATACX                   BRANCH IF YES                   32000000
         TM    UCBTBYT1,MODEL2          2250 MODEL 2 OR 3               32100000
         BO    MODTWO                   YES                             32200000
         B     TESTST                   BRANCH                          32300000
DATACX   EQU   *                                                        32400000
         TM    EWACNTR1,DC1IND          HAS ERROR BEEN RETRIED          32500000
         BO    WTORTN                   BRANCH IF YES                   32600000
         OI    EWACNTR1,DC1IND          SET RETRY INDICATOR             32700000
         B     RETRY                    BRANCH                          32800000
BUSERR   EQU   *                                                        32900000
         TM    EWACNTR1,BO2IND          HAS ERROR BEEN RETRIED          33000000
         BO    WTORTN                   BRANCH IF YES                   33100000
         OI    EWACNTR1,BO2IND          TURN ON RETRY INDICATOR         33200000
         B     RETRY                    BRANCH                          33300000
MODTWO   EQU   *                                                        33400000
         TM    IOSSNS+N1,INCHK          TEST FOR INPUT CHECK            33500000
         BO    INPERR                   BRANCH IF PRESENT               33600000
         TM    IOSSNS+N1,OUTCHK         TEST FOR OUTPUT CHECK           33700000
         BO    OUTERR                   BRANCH IF PRESENT               33800000
         TM    IOSSNS,EQPCHK            TEST FOR EQUIPMENT CHECK        33900000
         BZ    TESTST                   BRANCH IF NOT EQUIPMENT CHECK   34000000
         TM    EWACNTR1,ECIND           HAS ERROR BEEN RETRIED          34100000
         BO    WTORTN                   BRANCH IF YES                   34200000
         OI    EWACNTR1,ECIND           SET RETRY INDICATOR             34300000
RETRY    EQU   *                                                        34400000
         SVC   EXCPER                   ERROR EXECUTE CHANNEL PROGRAM   34500000
         SVC   RETURN                   RETURN TO SUPERVISOR            34600000
INPERR   EQU   *                                                        34700000
         TM    EWACNTR1,INPIND          HAS ERROR BEEN RETRIED          34800000
         BO    WTORTN                   BRANCH IF YES                   34900000
         OI    EWACNTR1,INPIND          SET RETRY INDICATOR             35000000
         B     RETRY                    BRANCH TO RETRY EXIT            35100000
OUTERR   EQU   *                                                        35200000
         TM    EWACNTR1,OUTIND          HAS ERROR BEEN RETRIED          35300000
         BO    WTORTN                   BRANCH IF YES                   35400000
         OI    EWACNTR1,OUTIND          SET RETRY INDICATOR             35500000
         B     RETRY                    BRANCH TO RETRY EXIT            35600000
SEROUT   EQU   *                                                        35700000
         OI    IOSFLB,IOSLOG            LOGOUT REQUIRED                 35800000
PERMER   EQU   *                                                        35900000
         NI    IOSFLA,N255-IOSERR       PERMANENT ERROR                 36000000
         NI    IOBFLAG1,N255-IOBERRTN   ALSO IN IOB                     36100000
RESET    EQU   *                                                        36200000
         XC    EWACNTR1(N2),EWACNTR1    RESET RETRY INDICATORS          36300000
         LA    ERREG3,ERRNM1            LOAD STAT ROUTINE ID            36400000
         B     XCTL                     GO TO XCTL TO STAT ROUTINE      36500000
MOD1BSC  EQU   *                                                        36600000
         TM    IOSSNS,N255-ECIND        EQUIPMENT CHECK                 36700000
         BNZ   CKINTREQ                 IF NOT GO CHECK INT. REQ.       36800000
         TM    IOSTSA,ATTENT            TEST FOR ATTENTION              36900000
         BO    NOERR                    IF PRESENT TAKE BRANCH          37000000
         B     WTORTN                   SET AS PERMANENT ERROR          37100000
CKINTREQ EQU   *                                                        37200000
         TM    IOSSNS,INTREQ            INTERVENTION REQUIRED           37300000
         BNO   SEROUT                   IF NOT GO LOG ERROR             37400000
         B     WTORTN                   PERMANENT ERROR AND MESSAGE     37500000
RECOVER  EQU   *                                                        37600000
         TM    EWACNTR2,ICCCCC          HAS OPERATION BEEN RETRIED      37700000
         BO    ASROUT                   GO TO PERM ERROR IF YES         37800000
         CLI   IOSCOD,IOSFINTC          IOSB INTERCEPT                  37900000
         BE    ASROUT                   YES, GO POST IT AS PERM         38000000
         TM    EWARGFG1,EWANORTY        IS NO RETRY BIT SET             38100000
         BO    ASROUT                   YES, PERM ERROR                 38200000
         TM    EWAXCSW2,HEX80           CODE GREATER THAN OR EQUAL 2    38300000
         BO    MORETEST                 IF YES, TEST FURTHER            38400000
RETRY2   EQU   *                                                        38500000
         OI    EWACNTR2,ICCCCC          TURN ON RETRY BIT               38600000
         XC    EWAERPIB(N8),EWAERPIB    ZERO ERPIB                      38700000
         B     RETRY                    GO RETRY OPERATION              38800000
MORETEST EQU   *                                                        38900000
         TM    EWARGFG1,HEX80           TEST FOR START I/O              39000000
         BO    SIOTST                   YES, GET START CCW ADR          39100000
         TM    EWAXCSW1,HEX04           CHECK FOR VALID COMMAND         39200000
         BNO   ASROUT                   NOT VALID, NO RETRY             39300000
         L     CCWREG,IOSCC             GET CCW ADDR                    39400000
         LA    CCWREG,ZERO(CCWREG)      GET RID OF UNWANTED BYTE        39500000
         SH    CCWREG,EIGHT             SUBRACT 8                       39600000
         LTR   CCWREG,CCWREG            ADDRESS NEGATIVE                39700000
         BM    ASROUT                   YES, ERROR                      39800000
CONTCCW  EQU   *                                                        39900000
         CLI   ZERO(CCWREG),READXY      CHECK FOR READXY COMMAND        40000000
         BE    ASROUT                   NO RETRY IF YES                 40100000
         CLI   ZERO(CCWREG),READMI      CHECK FOR READMI COMMAND        40200000
         BE    ASROUT                   NO RETRY IF YES                 40300000
         OI    EWAFLG2,EWAWTEMP         INDICATE WRITE FOR UPDATE RTN   40400000
         B     RETRY2                   GO RETRY OPERATION              40500000
SIOTST   EQU   *                                                        40600000
         L     CCWREG,IOSRST            LOAD ADDRESS OF SIO CCW         40700000
         LR    PARMREG,CCWREG      SET AS PARAMETER            YM02594K 40800000
         L     ERREG2,CVTPTRV      POINT TO TRANSLATOR         YM02594K 40900000
         BALR  RTNREG,ERREG2       REAL TO VIRTUAL             YM02594K 41000000
         LTR   ERREG2,ERREG2       GOOD COMPLETION             YM02594K 41100000
         BNZ   SEROUT              NO, PERM ERROR              YM02594K 41200000
         LR    CCWREG,PARMREG      RESET CCW REG               YM02594K 41300000
         LR    PARMREG,IOSBREG     RESET PARMREG TO IOSB    D11 ZA14030 41400000
         B     CONTCCW                  CHECK CCW              YM02594K 41500000
ASROUT   EQU   *                                                        41600000
         XC    EWAERPIB(N8),EWAERPIB    CLEAR ERPIB                     41700000
WTORTN   EQU   *                                                        41800000
         TM    UCBSTAT,UCBSYSR          OPERATOR CONSOLE                41900000
         BO    SEROUT                   YES                             42000000
         OI    IOSFLB,IOSMSG+IOSLOG     PERM ERROR MSG AND LOGOUT       42100000
         NI    IOSFLA,N255-IOSERR       PERMANENT ERROR                 42200000
         NI    IOBFLAG1,N255-IOBERRTN   ALSO IN IOB                     42300000
         XC    EWACNTR1(N2),EWACNTR1    CLEAR RETRY INDICATORS          42400000
         LA    ERREG3,WTO               LOAD WTO ID                     42500000
XCTL     EQU   *                                                        42600000
         L     RTNREG,CVTXTLER          BRANCH ENTRY POINT OF XCTL      42700000
         BR    RTNREG                   BRANCH TO TRANSFER CONTROL      42800000
         EJECT                                                          42900000
**********                                                              43000000
*                                                                       43100000
*        CONSTANTS                                                      43200000
*                                                                       43300000
**********                                                              43400000
EIGHT    DC    H'8'                     EIGHT                           43500000
PACHAREA EQU   *                                                        43600000
         DC    20C'010A'               PATCH AREA FOR MAINTENANCE       43700000
         SPACE 2                                                        43800000
**********                                                              43900000
*                                                                       44000000
*        REGISTER DEFINITIONS                                           44100000
*                                                                       44200000
**********                                                              44300000
ERREG4   EQU   0                        WORK REG                        44400000
PARMREG  EQU   1                        PARAMETER REG                   44500000
ERREG1   EQU   3                        WORK REG                        44600000
CVTREG   EQU   4                        CVT BASE                        44700000
ERREG5   EQU   5                        WORK REG                        44800000
IOBREG   EQU   6                        IOB BASE                        44900000
ERPWAREG EQU   7                        ERP WORKAREA BASE               45000000
RQEREG   EQU   8                        RQE BASE                        45100000
CCWREG   EQU   9                        CHANNEL STATUS WORD REG         45200000
IOSBREG  EQU   10                       IOSB BASE                       45300000
UCBREG   EQU   11                       UCB BASE                        45400000
BASERG   EQU   12                       PROGRAM BASE                    45500000
ERREG3   EQU   13                       WORK REG                        45600000
RTNREG   EQU   14                       EXIT REG                        45700000
ERREG2   EQU   15                       WORK REG                        45800000
         SPACE 2                                                        45900000
**********                                                              46000000
*                                                                       46100000
*        MISCELLANEOUS EQUATES                                          46200000
*                                                                       46300000
**********                                                              46400000
ZERO     EQU   0                        ZERO                            46500000
N1       EQU   1                        ONE                             46600000
N2       EQU   2                        TWO                             46700000
N8       EQU   8                        EIGHT                           46800000
N9       EQU   9                        NINE                            46900000
N255     EQU   255                      MASK FOR AND IMMEDIATE          47000000
EXCPER   EQU   15                       ERROR EXCP (SVC 15)             47100000
RETURN   EQU   3                        RETURN TO SUPERVISOR (SVC 3)    47200000
WTO      EQU   253                      WRITE TO OPERATOR ROUTINE       47300000
ERRNM1   EQU   254                      STATICS UPDATE ROUTINE          47400000
HEX01    EQU   X'01'                    MASK                            47500000
HEX02    EQU   X'02'                    MASK                            47600000
HEX04    EQU   X'04'                    MASK                            47700000
HEX7D    EQU   X'7D'                    MASK                            47800000
HEX80    EQU   X'80'                    MASK                            47900000
         SPACE 2                                                        48000000
**********                                                              48100000
*                                                                       48200000
*        STATUS FLAGS                                                   48300000
*                                                                       48400000
**********                                                              48500000
ATTENT   EQU   X'80'                    ATTENTION                       48600000
STATSMOD EQU   X'40'                    STATUS MODIFIER                 48700000
CONTUEND EQU   X'20'                    CONTROL UNIT END                48800000
CHNEND   EQU   X'08'                    CHANNEL END                     48900000
DEVEND   EQU   X'04'                    DEVICE END                      49000000
UNITCK   EQU   X'02'                    UNIT CHECK                      49100000
UNITEXCP EQU   X'01'                    UNIT EXECPTION                  49200000
BADSTAT1 EQU   STATSMOD+CONTUEND+UNITEXCP   BAD STATUS MODEL 1          49300000
BADSTAT2 EQU   UNITEXCP                 BAD STATUS MODEL 2 OR 3         49400000
INCLEN   EQU   X'40'                    INCORRECT LENGTH                49500000
PROGCK   EQU   X'20'                    PROGRAM CHECK                   49600000
PROTCK   EQU   X'10'                    PROTECTION CHECK                49700000
CHAIN    EQU   X'01'                    CHAINING CHECK                  49800000
ST2ALL   EQU   PROGCK+PROTCK            PROGRAM AND PROTECTION CHECK    49900000
ASRCHK   EQU   X'06'                    TOTAL OF INTERFACE AND          50000000
*                                       CHANNEL CONTROL CHECKS          50100000
CDCBIT   EQU   X'08'                    CHANNEL DATA CHECK              50200000
         SPACE 2                                                        50300000
**********                                                              50400000
*                                                                       50500000
*        SENSE BITS                                                     50600000
*                                                                       50700000
**********                                                              50800000
COMREJ   EQU   X'80'                    COMMAND REJECT                  50900000
BUSOUT   EQU   X'20'                    BUS OUT                         51000000
EQPCHK   EQU   X'10'                    EQUIPMENT CHECK                 51100000
DATACK   EQU   X'08'                    DATA CHECK                      51200000
BUFRUN   EQU   X'02'                    BUFFER RUNNING                  51300000
CRJBRN   EQU   COMREJ+BUFRUN            COMMAND REJECT+BUFFER RUNNING   51400000
INTREQ   EQU   X'40'                    INTERVENTION REQUIRED           51500000
SNOCUR   EQU   X'55'                    BAD SENSE BYTE 0 MODEL 1        51600000
SNOCUR12 EQU   X'1F'                    BAD SENSE BYTE 1 MODEL 1        51700000
SNOCUR2  EQU   X'45'                    BAD SENSE BYTE 0 MODEL 2 OR 3   51800000
SNOCUR22 EQU   X'19'                    BAD SENSE BYTE 1 MODEL 2 OR 3   51900000
INCHK    EQU   X'02'                    2840 INPUT CHECK                52000000
OUTCHK   EQU   X'04'                    2840 OUTPUT CHECK               52100000
         SPACE 2                                                        52200000
**********                                                              52300000
*                                                                       52400000
*        ERROR RETRY INDICATORS                                         52500000
*                                                                       52600000
**********                                                              52700000
BO1IND   EQU   X'80'                    BUS OUT 1                       52800000
BO2IND   EQU   X'40'                    BUS OUT 2                       52900000
DC1IND   EQU   X'20'                    DATA CHECK 1                    53000000
ECIND    EQU   X'10'                    EQUIPMENT CHECK                 53100000
INPIND   EQU   X'08'                    2840 INPUT CHECK                53200000
OUTIND   EQU   X'04'                    2840 OUTPUT CHEK                53300000
ICCCCC   EQU   X'80'                    ICC AND CCC                     53400000
CDCIND   EQU   X'40'                    CHANNEL DATA CHECK              53500000
         SPACE 2                                                        53600000
**********                                                              53700000
*                                                                       53800000
*       MODEL TYPES USED WITH UCBTBYT1                                  53900000
*                                                                       54000000
**********                                                              54100000
MODEL1   EQU   X'31'                    2250 MODEL 1 ID                 54200000
MODEL2   EQU   X'32'                    2250 MODEL 2 ID                 54300000
         SPACE 2                                                        54400000
**********                                                              54500000
*                                                                       54600000
*        COMMAND CODES                                                  54700000
*                                                                       54800000
**********                                                              54900000
READXY   EQU   X'12'                    READ X - Y REGISTERS            55000000
READMI   EQU   X'0E'                    READ MANUAL INPUT               55100000
         EJECT                                                          55200000
CVTSET   DSECT                                                          55300000
         CVT                                                            55400000
         EJECT                                                          55500000
         IECDIOSB                                                       55600000
         EJECT                                                          55700000
UCBSET   DSECT                                                          55800000
         IEFUCBOB                                                       55900000
         EJECT                                                          56000000
         IEZIOB                                                         56100000
         EJECT                                                          56200000
         IECDRQE                                                        56300000
         EJECT                                                          56400000
         IECDERWA                                                       56500000
         EJECT                                                          56600000
         DCBD                                                           56700000
         END                                                            56800000
./  ADD  SSI=61760128,NAME=IGE0010B
         TITLE 'IGE0010B - LOCAL 2260 ERROR RECOVERY PROCEDURE'         00100000
IGE0010B CSECT                                                          00200000
*********************************************************************** 00300000
*                                                                     * 00400000
* MODULE NAME:                                                        * 00500000
*    IGE0010B                                                         * 00600000
*                                                                     * 00700000
* DESCRIPTIVE NAME:                                                   * 00800000
*    LOCAL 2260 ERROR RECOVERY PROCEDURE                              * 00900000
*                                                                     * 01000000
* COPYRIGHT:                                                          * 01100000
*    NONE                                                             * 01200000
*                                                                     * 01300000
* STATUS:                                                             * 01400000
*    CHANGE LEVEL 000                                                 * 01500000
*                                                                     * 01600000
* FUNCTION:                                                           * 01700000
*    THIS MODULE IS THE ERP FOR LOCALLY ATTACHED DEVICES OF THE       * 01800000
*    2260 DISPAY SYSTEM. THE MODULE IS SCHEDULED BY IOS.              * 01900000
*    THE FOLLOWING FUNCTIONS ARE PERFORMED BY THIS MODULE:            * 02000000
*        * DETERMINES IF AN ERROR IS RETRYABLE BY THE ERP AND RETRIES * 02100000
*          THOSE THAT ARE.                                            * 02200000
*        * DETERMINES IF ERP RETRIES ARE SUCCESSFUL.                  * 02300000
*        * MAINTAINS THE STATISTICS TABLE FOR THE DEVICE.             * 02400000
*        * REQUESTS OBR LOGOUT WHEN REQUIRED.                         * 02500000
*        * REQUESTS INT REQ OR PERM ERROR MESSAGES WHEN REQUIRED.     * 02600000
*                                                                     * 02700000
* NOTES:                                                              * 02800000
*    DEPENDENCIES:                                                    * 02900000
*        NONE                                                         * 03000000
*    RESTRICTIONS:                                                    * 03100000
*        THIS ERP IS FOR LOCALLY ATTACHED DEVICES ONLY USING EXCP     * 03200000
*    REGISTER CONVENTIONS:                                            * 03300000
*        SEE 'REGISTER DEFINITION' BELOW                              * 03400000
*                                                                     * 03500000
* PATCH LABEL:                                                        * 03600000
*    PACHAREA (88 BYTES)                                              * 03700000
*                                                                     * 03800000
* MODULE TYPE:                                                        * 03900000
*    PROCEDURE                                                        * 04000000
*    PROCESSOR:                                                       * 04100000
*        BAL                                                          * 04200000
*    MODULE SIZE:                                                     * 04300000
*        882 BYTES                                                    * 04400000
*    ATTRIBUTES:                                                      * 04500000
*        REENTRANT, ENABLED, KEY 0, SUPERVISOR STATE, NO LOCKS HELD   * 04600000
*                                                                     * 04700000
* ENTRY POINT:                                                        * 04800000
*    IGE0010B                                                         * 04900000
*    PURPOSE:                                                         * 05000000
*        THIS MODULE IS ENTERED WHEN ONE OR MORE OF THE FOLLOWING     * 05100000
*        CONDITIONS IS ENCOUNTERED:                                   * 05200000
*            UNIT CHECK                                               * 05300000
*            UNIT EXCEPTION                                           * 05400000
*            INVALID COMMAND SEQUENCE                                 * 05500000
*            INCORRECT LENGTH                                         * 05600000
*            PROGRAM CHECK                                            * 05700000
*            PROTECTION CHECK                                         * 05800000
*            CHAINING CHECK                                           * 05900000
*            CHANNEL DATA CHECK                                       * 06000000
*            INTERFACE CONTROL CHECK                                  * 06100000
*            CHANNEL CONTROL CHECK                                    * 06200000
*            COMMAND REJECT                                           * 06300000
*    LINKAGE:                                                         * 06400000
*        THIS MODULE IS SCHEDULED FOR EXECUTION BY THE INPUT/OUTPUT   * 06500000
*        SUPERVISOR. IT RUNS UNDER AN SIRB.                           * 06600000
*    INPUT:                                                           * 06700000
*        REG 1 = ADDRESS OF IOSB                                      * 06800000
*    OUTPUT:                                                          * 06900000
*        RECOVERABLE ERRORS:                                          * 07000000
*            IOSERR IS SET ON FOR RETRY                               * 07100000
*            IF A MESSAGE IS TO BE ISSUED, EXIT IS MADE TO IGE0025C   * 07200000
*            IF NO MESSAGE, SVC 15 IS ISSUED, THEN EXIT IS VIA SVC 3  * 07300000
*        CORRECTED ERRORS:                                            * 07400000
*            IOSEX AND IOSERR ARE SET OFF                             * 07500000
*            IOSB IS CLEANED UP                                       * 07600000
*            EXIT IS TO IGE0025D TO UPDATE STATISTICS TABLE           * 07700000
*        PERMANENT ERRORS:                                            * 07800000
*            AN OBR LOGOUT IS SCHEDULED                               * 07900000
*            A STATISTIC TABLE UPDATE IS SCHEDULED                    * 08000000
*            IOSEX IS SET ON                                          * 08100000
*            IOSERR IS SET OFF                                        * 08200000
*            EXIT IS TO IGE0025C TO ISSUE PERM ERROR MESSAGE          * 08300000
*        PROGRAMMING ERRORS:                                          * 08400000
*            SVC 15 IS ISSUED                                         * 08500000
*            IOSEX IS SET ON                                          * 08600000
*            IOSERR IS SET OFF                                        * 08700000
*            EXIT IS VIA SVC 3                                        * 08800000
*                                                                     * 08900000
* EXITS-NORMAL:                                                       * 09000000
*    SUPERVISOR VIA SVC 3                                             * 09100000
*    STATISTICS UPDATE ROUTINE (IGE0025D) VIA BRANCH ENTRY TO XCTL    * 09200000
*    IOS-WTO ROUTINE (IGE0025C) VIA BRANCH ENTRY TO XCTL              * 09300000
*                                                                     * 09400000
* EXITS-ERROR:                                                        * 09500000
*    NONE                                                             * 09600000
*                                                                     * 09700000
* EXTERNAL REFERENCES:                                                * 09800000
*    ROUTINES:                                                        * 09900000
*        SVC 15 ERROR EXCP                                            * 10000000
*    DATA AREAS                                                       * 10100000
*        CHANNEL PROGRAM                                              * 10200000
*        ERP WORKAREA (MAPPED BY IECDERWA)                            * 10300000
*    CONTROL BLOCKS                                                   * 10400000
*        UCB          (MAPPED BY IEFUCBOB)                            * 10500000
*        CVT          (MAPPED BY CVT)                                 * 10600000
*        IOSB         (MAPPED BY IECDIOSB)                            * 10700000
*        RQE          (MAPPED BY IECDRQE)                             * 10800000
*        IOB          (MAPPED BY IEZIOB)                              * 10900000
*                                                                     * 11000000
* TABLES-WORKAREAS:                                                   * 11100000
*    ERP WORKAREA                                                     * 11200000
*                                                                     * 11300000
* MACROS:                                                             * 11400000
*    NONE                                                             * 11500000
*                                                                     * 11600000
* CHANGE ACTIVITY:                                                    * 11700000
*A188000-190500,A215000-217500                              D11 YM02594 11800000
*A149200                                                    D11 ZA10438 11900000
*                                                                     * 12000000
*********************************************************************** 12100000
         EJECT                                                          12200000
*/*IGE0010B: CHART */                                                   12300000
*/* E IGE0010B */                                                       12400000
*/* D (YES,,NO,PERMER) EXCP */                                          12500000
*/* D (YES,,NO,START) FIRST ENTRY */                                    12600000
*/* P CLEAR EWASTUP */                                                  12700000
*/*START: P SET ERP IN CONTROL FLAGS */                                 12800000
*/* D (YES,RECOVER,NO,) CCC OR ICC */                                   12900000
*/* D (YES,SEROUT,NO,) INVALID STATUS */                                13000000
*/* D (YES,SEROUT,NO,) UNIT EXCEPTION */                                13100000
*/*TESTUC: D (YES,MAINER,NO,TESTST) UNIT CHECK */                       13200000
*/*TESTST: D (YES,TESTCONT,NO,) CHANNEL OK */                           13300000
*/* D (YES,WTORTN,NO,) CDC RETRIED */                                   13400000
*/* P (,RECOVER) SET CDC RETRIED */                                     13500000
*/*TESTCONT: D (YES,PERMER,NO,) PROT OR PROG CHECK */                   13600000
*/* D (YES,SEROUT,NO,) OUR CHAN PRG RUNNING */                          13700000
*/* D (YES,,NO,NOERRS) INT REQ */                                       13800000
*/* D (YES,NOERRS,NO,) INT REQ RETRIED */                               13900000
*/* P (,RETRY) SET INT REQ RETRIED */                                   14000000
*/*MAINER: D (YES,IS2260,NO,) DEVICE A 2260 */                          14100000
*/* D (YES,,NO,SEROUT) DEVICE A 1053 */                                 14200000
*/* D (YES,SEROUT,NO,AROUND) BAD SENSE */                               14300000
*/*IS2260: D (YES,CKINTREQ,NO,) BAD SENSE BYTE 1 */                     14400000
*/* D (YES,SEROUT,NO,AROUND) BAD SENSE BYTE 2 */                        14500000
*/*AROUND: D (YES,ISCEDE,NO,) CHAN END AND DEV END */                   14600000
*/* D (YES,PERMER,NO,) COMM REJECT */                                   14700000
*/* D (YES,,NO,CKBUSOUT) INT REQ */                                     14800000
*/* D (YES,WTORTN,NO,) 1053 INT REQ RETRIED */                          14900000
*/* P (,WTOIR) SET 1053 INT REQ RETRIED */                              15000000
*/*CKBUSOUT: D (YES,BO1,NO,TESTST) BUS OUT CHECK */                     15100000
*/*BO1: D (YES,WTORTN,NO,) BUSOUT RETRIED */                            15200000
*/* P (,RETRY) SET BUS OUT RETRIED */                                   15300000
*/*RETRY: S SVC 15: ERROR EXCP */                                       15400000
*/* R SVC 3 */                                                          15500000
*/*ISCEDE: D (YES,ISBUSOUT,NO,) BUSOUT CHECK */                         15600000
*/* D (YES,,NO,TESTST) EQUIP CHECK */                                   15700000
*/* D (YES,WTORTN,NO,) RETRIED */                                       15800000
*/* P (,RECOVER) SET EQUIP CHECK RETRIED */                             15900000
*/*ISBUSOUT: D (YES,WTORTN,NO,) BUSERR RETRIED */                       16000000
*/* P (,RECOVER) SET BUS ERROR RETRIED */                               16100000
*/*SEROUT: P (,PERMER) INDICATE LOGOUT REQUIRED */                      16200000
*/*PERMER: P (,RESET) INDICATE PERMANENT ERROR */                       16300000
*/*RESET: P (,POST) CLEAR RETRY FLAGS */                                16400000
*/*POST: P (,XCTLOUT) LOAD STAT TABLE UPDATE ROUTINE ID */              16500000
*/*NOERRS: P CLEAR ERROR FLAGS IN IOSB AND IOB */                       16600000
*/* P (,RESET) CLEAR STATUS INDICATORS */                               16700000
*/*WTORTN: D (YES,SEROUT,NO,) OP CONSOLE */                             16800000
*/* P CLEAR RETRY FLAGS */                                              16900000
*/* P (,WOPOST) SET PERM ERROR MESSAGE AND PERM ERROR */                17000000
*/*WOPOST: P (,WTOIR) INDICATE LOGOUT NEEDED */                         17100000
*/*WTOIR: P (,XCTLOUT) LOAD WTO ROUTINE ID */                           17200000
*/*XCTLOUT: P MOVE SENSE INTO STAT ROUTINE COMM AREA */                 17300000
*/* R BRANCH REG 14 */                                                  17400000
*/*CKINTREQ: D (YES,WTORTN,NO,SEROUT) INT REQ */                        17500000
*/*RECOVER: D (YES,,NO,RESET1) IOSB INTERCEPT */                        17600000
*/* P (,ZERERPIB) RESET CODE TO X7F */                                  17700000
*/*RESET1: D (YES,ZERERPIB,NO,) UNCOND NO RETRY */                      17800000
*/* D (YES,ZERERPIB,NO,) ICC OR CCC RETRIED */                          17900000
*/* D (YES,RETRYB,NO,) SIO ERROR */                                     18000000
*/* D (YES,CAVALID,NO,ZERERPIB) RETRY CODE VALID */                     18100000
*/*CAVALID: P GET STARTING CCW */                                       18200000
*/* D (YES,SETSW,NO,) VALID ADDRESS */                                  18300000
*/* D (YES,ZERERPIB,NO,) CHAINING */                                    18400000
*/* S GETCMD: GET COMMAND CODE */                                       18500000
*/* P (,RTRY14) CHECK CODE */                                           18600000
*/*SETSW: S GETCMD: GET COMMAND CODE */                                 18700000
*/*RTRY14: D (YES,RETRYA,NO,) RETRY CODE 1 OR 4 */                      18800000
*/* D (YES,ZERERPIB,NO,) READ MI */                                     18900000
*/* D (YES,ZERERPIB,NO,) SHORT READ MI */                               19000000
*/* D (YES,,NO,RETRYA) WRITE BUFFER */                                  19100000
*/* D (YES,RETRYA,NO,) 1053 WRITE */                                    19200000
*/* D (YES,,NO,ZERERPIB) COMMAND CHAINED */                             19300000
*/* P POINT TO START OF CHANNEL PROGRAM */                              19400000
*/* D (YES,ZERERPIB,NO,TICTEST) IS FAILING CCW FIRST CCW */             19500000
*/*TICTEST: D (YES,TICTEST2,NO,) IS IT A TIC */                         19600000
*/* P (,TICTEST1) POINT TO NEXT CCW */                                  19700000
*/*TICTEST1: D (YES,TICTESTX,NO,TICTEST) FOUND FAILING CCW */           19800000
*/*TICTEST2: P (,TICTEST1) POINT TO NEXT CCW */                         19900000
*/*TICTESTX: P GET PREVIOUS CCW */                                      20000000
*/* D (YES,,NO,ZERERPIB) IS PREVIOUS AN ERASE COMMAND */                20100000
*/* P (,RETRYA) RESTORE FAILING CCW ADDRESS */                          20200000
*/*RETRYA: D (YES,,NO,RETRYB) COMMAND CHAINED */                        20300000
*/* P (,RETRYB) STORE BAD CCW AS RESTART ADDRESS */                     20400000
*/*RETRYB: D (YES,,NO,RETRY) ICC OR CCC */                              20500000
*/* P ZERO ERPIB */                                                     20600000
*/* P (,RETRY) SET ICC AND CCC RETRIED */                               20700000
*/*ZERERPIB: P (,WTORTN) ZERO ERPIB */                                  20800000
*/*GETCMD: E GETCMD */                                                  20900000
*/* P GET COMMAND ADDR FROM CSW */                                      21000000
*/* P SUBTRACT 8 FROM COMMAND ADDRESS */                                21100000
*/* D (YES,ZERERPIB,NO,) PAST CCW 1 */                                  21200000
*/* P MOVE COMMAND CODE TO WORK AREA */                                 21300000
*/* R BRANCH REG */                                                     21400000
         EJECT                                                          21500000
         USING *,BASERG                                                 21600000
         LR    BASERG,ERREG15      BASE MODULE                          21700000
         USING EWA,EWAREG                                               21800000
         USING UCBSET,UCBREG                                            21900000
         USING CVTMAP,CVTREG                                            22000000
         USING IOSB,IOSBREG                                             22100000
         USING RQE,ERREG2                                               22200000
         USING IOBSTDRD,IOBREG                                          22300000
         LR    IOSBREG,PARMREG     BASE IOSB                            22400000
         L     CVTREG,CVTPTR       BASE CVT                             22500000
         L     UCBREG,IOSUCB       BASE UCB                             22600000
         L     EWAREG,IOSERP       BASE EWA                             22700000
         L     ERREG2,IOSUSE       BASE RQE                             22800000
         L     IOBREG,RQEIOB       BASE IOB                             22900000
         DROP  ERREG2                                                   23000000
         CLI   IOSDVRID,IOSXCPID   EXCP I/O                             23100000
         BNE   PERMER              NO, PERM ERROR                       23200000
         TM    IOSFLA,IOSERR       FIRST TIME THROUGH                   23300000
         BO    START               NO                                   23400000
         XC    EWASTUP(N2),EWASTUP   CLEAR OUT STAT UPDATE DATA         23500000
START    EQU   *                                                        23600000
         OI    IOSFLA,IOSERR+IOSEX   ERP IN CONTROL AND PERMANENT ERROR 23700000
         OI    IOBFLAG1,IOBERRTN+IOBIOERR   ALSO IN IOB                 23800000
         OI    IOBERRCT,HEX01+HEX02   FLAGS FOR CHANNEL END APPENDAGE   23900000
         TM    IOSTSB,ASRCHK       TEST FOR CCC OR ICC                  24000000
         BNZ   RECOVER             ANY OR ALL ON                        24100000
         TM    IOSTSB,CHAIN        SHOULD NOT OCCUR STATUS              24200000
         BO    SEROUT              BRANCH IF PRESENT                    24300000
         TM    IOSTSA,UNTEXC       UNIT EXCEPTION                       24400000
         BO    SEROUT              BRANCH IF PRESENT                    24500000
         TM    IOSTSB,CDCBIT       CHECK IF CHANNEL RETRY POSSIBLE      24600000
         BNO   TESTUC              IF CHANNEL OK, CONTINUE              24700000
         OI    EWASTUP+N1,X01      SET CDC IN STAT UPDATE DATA          24800000
TESTUC   EQU   *                                                        24900000
         TM    IOSTSA,UNITCK       UNIT CHECK                           25000000
         BO    MAINER              BRANCH IF YES                        25100000
TESTST   EQU   *                                                        25200000
         TM    IOSTSB,CDCBIT       CHECK IF CHANNEL RETRY POSSIBLE      25300000
         BNO   TESTCONT            IF CHANNEL OK, CONTINUE              25400000
         TM    EWACNTR1,CDCIND     FIRST RETRY                          25500000
         BO    WTORTN              NO                                   25600000
         OI    EWACNTR1,CDCIND     IF YES, SET SWITCH                   25700000
         B     RECOVER             CHECK FOR RETRY                      25800000
TESTCONT EQU   *                                                        25900000
         TM    IOSTSB,PROGCK+PROTCK  PROGRAM AND PROTECTION CHECK       26000000
         BNZ   PERMER              BRANCH IF PRESENT                    26100000
         TM    EWACNTR1,ECRTRY     IS ERR RTN CHAN PRG IN CONTROL       26200000
         BO    SEROUT              YES                                  26300000
         TM    IOBERRCT+N1,INTREQFD   WAS INTERVENTION                  26400000
*                                  REQUIRED FOUND                       26500000
         BZ    NOERRS              NO                                   26600000
         TM    IOBERRCT+N1,INTREQRY   HAS INTERVENTION                  26700000
*                                  REQUIRED BEEN RETRIED                26800000
         BO    NOERRS              YES                                  26900000
         OI    IOBERRCT+N1,INTREQRY   SET INTERVENTION                  27000000
*                                  REQUIRED RETRY SWITCH                27100000
         B     RETRY               GO RETRY                             27200000
MAINER   EQU   *                                                        27300000
         CLI   UCBTBYT4,A2260      IS DEVICE A 2260                     27400000
         BE    IS2260              YES                                  27500000
         CLI   UCBTBYT4,A1053      IS DEVICE A 1053                     27600000
         BNE   SEROUT              NO                                   27700000
         TM    IOSSNS,SNOCUR3      SHOULD NOT OCCUR 1053 SENSE          27800000
         BNZ   SEROUT              BRANCH IF ANY OR ALL PRESENT         27900000
         TM    IOSSNS+N1,SNOCUR32   SHOULD NOT OCCUR SECOND BYTE SENSE  28000000
         BNZ   SEROUT              BRANCH IF ANY OR ALL PRESENT         28100000
         B     AROUND              BRANCH                               28200000
IS2260   EQU   *                                                        28300000
         TM    IOSSNS,SNOCUR0      SHOULD NOT OCCUR 2260 SENSE          28400000
         BNZ   CKINTREQ            BRANCH IF ANY OR ALL                 28500000
         TM    IOSSNS+N1,SNOCUR02   SHOULD NOT OCCUR SECOND BYTE SENSE  28600000
         BNZ   SEROUT              BRANCH IF ANY OR ALL PRESENT         28700000
AROUND   EQU   *                                                        28800000
         TM    IOSTSA,CHNEND+DEVEND  CHANNEL END AND DEVICE END         28900000
         BO    ISCEDE              BRANCH IF BOTH PRESENT               29000000
         TM    IOSSNS,CMDREJ       COMMAND REJECT                       29100000
         BO    PERMER              BRANCH IF PRESENT                    29200000
         TM    IOSSNS,INTREQ       INTERVENTION REQUIRED                29300000
         BNO   CKBUSOUT            NO                                   29400000
         TM    IOBERRCT+N1,INTREQRY   PREVIOUS INTERVENTION             29500000
*                                  REQUIRED RETRIED ON 1053             29600000
         BO    WTORTN              YES                                  29700000
         OI    IOBERRCT+N1,INTREQFD   SET FOUND FLAG FOR                29800000
*                                  INTERVENTION REQUIRED                29900000
         B     WTOIR               GO NOTIFY OPERATOR                   30000000
CKBUSOUT EQU   *                                                        30100000
         TM    IOSSNS,BUSOUT       BUS OUT CHECK                        30200000
         BNO   TESTST              NO                                   30300000
BO1      EQU   *                                                        30400000
         TM    EWACNTR1,BO1IND     HAS ERROR BEEN RETRIED               30500000
         BO    WTORTN              YES                                  30600000
         OI    EWACNTR1,BO1IND     SET RETRY INDICATOR                  30700000
RETRY    EQU   *                                                        30800000
         LR    PARMREG,IOSBREG     RESTORE POINTER TO IOSB  D11 ZA10438 30900000
         SVC   EXCPER              ERROR EXECUTE CHANNEL PROGRAM        31000000
         SVC   EXIT                RETURN TO IOS                        31100000
ISCEDE   EQU   *                                                        31200000
         TM    IOSSNS,BUSOUT       BUS OUT CHECK                        31300000
         BO    ISBUSOUT            YES                                  31400000
         TM    IOSSNS,EQPCHK       EQUIPMENT CHECK                      31500000
         BNO   TESTST              NO                                   31600000
         TM    EWACNTR1,IOBEC      PREVIOUS RETRY                       31700000
         BO    WTORTN              YES                                  31800000
         OI    EWACNTR1,IOBEC      TURN ON RETRY FLAG                   31900000
         B     WTORTN              CONTINUE                             32000000
ISBUSOUT EQU   *                                                        32100000
         TM    EWACNTR1,BO2IND     PREVIOUS RETRY                       32200000
         BO    WTORTN              YES                                  32300000
         OI    EWACNTR1,BO2IND     SET RETRY INDICATOR                  32400000
         B     RECOVER             CHECK FOR RETRY                      32500000
SEROUT   EQU   *                                                        32600000
         OI    IOSFLB,IOSLOG       INDICATE LOG OUT REQUIRED            32700000
PERMER   EQU   *                                                        32800000
         NI    IOSFLA,N255-IOSERR   INDICATE PERMANENT ERROR            32900000
         NI    IOBFLAG1,N255-IOBERRTN   ALSO IN IOB                     33000000
RESET    EQU   *                                                        33100000
         MVI   IOBERRCT+N1,ZERO    RESET INTERVENTION REQUIRED FLAGS    33200000
         MVI   EWACNTR1,ZERO       RESET RETRY INDICATORS               33300000
         MVI   EWACNTR2,ZERO       RESET RETRY INDICATORS               33400000
POST     EQU   *                                                        33500000
         LA    ERREG13,ERRNM1      LOAD STAT UPDATE ROUTINE ID          33600000
         B     XCTLOUT             XCTL TO IT                           33700000
NOERRS   EQU   *                                                        33800000
         NI    IOSFLA,N255-IOSEX-IOSERR   CLEAR ERROR FLAGS IN IOSB     33900000
         NI    IOBFLAG1,N255-IOBERRTN-IOBIOERR   ALSO IN IOB            34000000
         NI    IOSFLB,N255-IOSLOG-IOSMSG   CLEAR ERROR FLAGS IN IOSB    34100000
         NI    IOSTSA,UCUEXFC      CLEAR STATUS                         34200000
         NI    IOSTSB,ILXBF        CLEAR STATUS                         34300000
         NI    IOBERRCT,N255-HEX02   RESET ERP ENTERED                  34400000
         B     RESET               BRANCH                               34500000
WTORTN   EQU   *                                                        34600000
         TM    UCBSTAT,UCBSYSR     IS THIS AN OPERATOR'S CONSOLE        34700000
         BO    SEROUT              YES                                  34800000
         MVI   IOBERRCT+N1,ZERO    RESET INTERVENTION REQUIRED FLAGS    34900000
         MVI   EWACNTR2,ZERO       RESET RETRY INDICATORS               35000000
         MVI   EWACNTR1,ZERO       RESET RETRY INDICATORS               35100000
         NI    IOSFLA,N255-IOSERR   INDICATE PERMANENT ERROR            35200000
         NI    IOBFLAG1,N255-IOBERRTN   ALSO IN IOB                     35300000
         OI    IOSFLB,IOSMSG       INDICATE PERM ERROR MESSAGE          35400000
WOPOST   EQU   *                                                        35500000
         OI    IOSFLB,IOSLOG       INDICATE LOGOUT NEEDED               35600000
WTOIR    EQU   *                                                        35700000
         LA    ERREG13,WTO         LOAD WTO ROUTINE ID                  35800000
XCTLOUT  EQU   *                                                        35900000
         L     RTNREG,CVTXTLER     LOAD ADDRESS OF XCTL                 36000000
         BR    RTNREG              BRANCH TO XCTL                       36100000
CKINTREQ EQU   *                                                        36200000
         TM    IOSSNS,N255-INTREQ   INTERVENTION REQUIRED ONLY          36300000
         BNZ   SEROUT              NO                                   36400000
         B     WTORTN              YES, GO POST AS PERMANENT ERROR      36500000
RECOVER  EQU   *                                                        36600000
         NI    EWACNTR1,N255-SWITCH   RESET SWITCH FOR CHAINING         36700000
         CLI   IOSCOD,IOSFINTC     INTERCEPT CONDITION                  36800000
         BNE   RESET1              NO                                   36900000
         MVI   IOSCOD,IOSNRMC      RESET TO X'7F'                       37000000
         B     ZERERPIB            EXIT                                 37100000
RESET1   EQU   *                                                        37200000
         TM    EWARGFG1,EWANORTY   IS NO RETRY SET                      37300000
         BO    ZERERPIB            YES, PERMANENT ERROR                 37400000
         TM    EWACNTR2,ICCCCC     PREVIOUS RETRY ICC/CCC               37500000
         BO    ZERERPIB            YES, PERMANENT ERROR                 37600000
         TM    IOSCC,SIOINSTR      ERROR ON SIO                         37700000
         BO    RETRYB              YES, GO ZERO ERPIB AND RETRY         37800000
         TM    EWAXCSW1,ERPVRTRY   IS RETRY CODE VALID                  37900000
         BZ    ZERERPIB            NO                                   38000000
         TM    EWAXCSW2,RETRY7     IS RETRY CODE ZERO                   38100000
         BZ    ZERERPIB            YES                                  38200000
         BO    CAVALID             IF SEVEN TAKE BRANCH                 38300000
         TM    EWAXCSW2,RETRY6     IS RETRY CODE SIX                    38400000
         BO    ZERERPIB            YES, PERMANENT ERROR                 38500000
CAVALID  EQU   *                                                        38600000
         L     PARMREG,IOSRST      GET STARTING CCW            YM02594K 38700000
         L     ERREG15,CVTPTRV     POINT TO TRANSALTOR         YM02594K 38800000
         BALR  RTNREG,ERREG15      REAL TO VIRTUAL             YM02594K 38900000
         LTR   ERREG15,ERREG15     GOOD COMPLETION             YM02594K 39000000
         BNZ   SEROUT              NO, PERM ERROR              YM02594K 39100000
         LR    ERREG8,PARMREG      SET FOR TESTS               YM02594K 39200000
         TM    EWAXCSW1,ERPVCMAD   IS COMMAND ADDRESS VALID             39300000
         BO    SETSW               YES                                  39400000
         TM    N4(ERREG8),CCWCHAIN   CHAINING ON                        39500000
         BNZ   ZERERPIB            YES                                  39600000
         BAL   RTNREG,GETCMD       GET COMMAND CODE                     39700000
         B     RTRY14              RETRY                                39800000
SETSW    EQU   *                                                        39900000
         BAL   RTNREG,GETCMD       GET COMMAND CODE                     40000000
         LA    ERREG8,ZERO(ERREG8)   CLEAR HI-ORDER BYTE                40100000
         CR    ERREG8,ERREG6       START CCW EQUAL FAILING CCW          40200000
         BE    RTRY14              YES                                  40300000
         OI    EWACNTR1,SWITCH     SET SWITCH FOR RESTART               40400000
RTRY14   EQU   *                                                        40500000
         TM    EWAXCSW2,RETRY1     RETRY CODE 1                         40600000
         BZ    RETRYA              YES                                  40700000
         TM    EWAXCSW2,RETRY4     RETRY CODE OF FOUR                   40800000
         BZ    RETRYA              YES                                  40900000
         CLI   EWACNTR3,RDMI       COMMAND READ MI                      41000000
         BE    ZERERPIB            YES                                  41100000
         CLI   EWACNTR3,SRDMI      COMMAND SHORT RD MI                  41200000
         BE    ZERERPIB            YES                                  41300000
         CLI   EWACNTR3,WRTDSB     COMMAND WRITE BUFFER                 41400000
         BNE   RETRYA              NO                                   41500000
         CLI   UCBTBYT4,A1053      IS WRITE TO 1053                     41600000
         BE    RETRYA              IF YES CHECK CHAINING                41700000
         TM    EWAXCSW2,HEX01      IS RETRY CODE TWO                    41800000
         BZ    RETRYA              YES                                  41900000
         TM    EWACNTR1,SWITCH     IS COMMAND CHAINED                   42000000
         BZ    ZERERPIB            NO CHAINING, PERMANENT ERROR         42100000
*                                  THE FOLLOWING CODE PERFORMS          42200000
*                                  A ONE CCW BACK UP FUNCTION TO        42300000
*                                  TEST THE CCW IN FRONT OF THE         42400000
*                                  FAILING ONE                          42500000
         L     RTNREG,IOSVST       POINT TO START OF CCWS               42600000
         CLC   ZERO(N8,RTNREG),ZERO(ERREG6)   FIRST COMMAND             42700000
         BE    ZERERPIB            YES, NO ERASE COMMAND                42800000
TICTEST  EQU   *                                                        42900000
         CLI   ZERO(RTNREG),TIC    TIC                                  43000000
         BE    TICTEST2            YES                                  43100000
         LR    ERREG7,RTNREG       SAVE OLD ADDRESS                     43200000
         LA    RTNREG,N8(RTNREG)   POINT TO NEXT CCW                    43300000
TICTEST1 EQU   *                                                        43400000
         CLC   ZERO(N8,RTNREG),ZERO(ERREG6)   FOUND FAILING             43500000
         BE    TICTESTX            YES, CHECK PREVIOUS FOR ERASE        43600000
         B     TICTEST             RESET, AND GO                        43700000
TICTEST2 EQU   *                                                        43800000
         L     RTNREG,ZERO(RTNREG)   POINT TO NEXT CCW                  43900000
         LA    RTNREG,ZERO(RTNREG)   CLEAR OUT OP CODE                  44000000
         LR    PARMREG,RTNREG      SET AS PARAMETER            YM02594K 44100000
         L     ERREG15,CVTPTRV     POINT TO TRANSLATOR         YM02594K 44200000
         BALR  RTNREG,ERREG15      REAL TO VIRTUAL             YM02594K 44300000
         LTR   ERREG15,ERREG15     GOOD COMPLETION             YM02594K 44400000
         BNZ   SEROUT              NO, PERM ERROR              YM02594K 44500000
         LR    RTNREG,PARMREG      RESET CCW REG               YM02594K 44600000
         B     TICTEST1            CHECK IT                             44700000
TICTESTX EQU   *                                                        44800000
         CLI   ZERO(ERREG7),ERASECMD   IS THIS AN ERASE COMMAND         44900000
         BNE   ZERERPIB            NO                                   45000000
         L     ERREG6,IOSCC        GET COMMAND POINTER                  45100000
         LA    ERREG6,ZERO(ERREG6)   CLEAR HIGH BYTE                    45200000
         SH    ERREG6,EIGHT        RESTORE FAILING CCW ADDRESS          45300000
RETRYA   EQU   *                                                        45400000
         TM    EWACNTR1,SWITCH     IS COMMAND CHAINED                   45500000
         BZ    RETRYB              NO, GO RETRY                         45600000
         LRA   ERREG6,ZERO(ERREG6)   GET REAL ADDRESS FOR IOS           45700000
         ST    ERREG6,IOSRST       STORE RESTART ADDRESS                45800000
RETRYB   EQU   *                                                        45900000
         TM    IOSTSB,ASRCHK       ICC OR CCC                           46000000
         BZ    RETRY               NO, JUST RETRY                       46100000
         XC    EWAERPIB(N8),EWAERPIB   ZERO ERPIB                       46200000
         OI    EWACNTR2,ICCCCC     SET ICC/CCC RETRY INDICATORS         46300000
         B     RETRY               RETRY                                46400000
GETCMD   EQU   *                                                        46500000
         L     ERREG6,IOSCC        GET COMMAND POINTER                  46600000
         LA    ERREG6,ZERO(ERREG6)   CLEAR HIGH BYTE                    46700000
         SH    ERREG6,EIGHT        GET FAILING CCW                      46800000
         LTR   ERREG6,ERREG6       ADDRESS NEGATIVE                     46900000
         BM    ZERERPIB            YES, ERROR                           47000000
         MVC   EWACNTR3(N1),ZERO(ERREG6)   GET CMD CODE                 47100000
         NI    EWACNTR3,CMDMASK    RID UNWANTED BITS                    47200000
         BR    RTNREG              RETURN GOODIES TO MAINLINE           47300000
ZERERPIB EQU   *                                                        47400000
         XC    EWAERPIB(N8),EWAERPIB   ZERO ERPIB                       47500000
         B     WTORTN              GO TO PERMANENT ERROR                47600000
         EJECT                                                          47700000
**********                                                              47800000
*                                                                       47900000
*        CONSTANTS                                                      48000000
*                                                                       48100000
**********                                                              48200000
EIGHT    DC    H'8'                EIGHT                                48300000
PACHAREA EQU   *                                                        48400000
         DC    22X'FF'             PATCH AREA               D11         48500000
         SPACE 2                                                        48600000
**********                                                              48700000
*                                                                       48800000
*        REGISTER DEFINITION                                            48900000
*                                                                       49000000
**********                                                              49100000
ERREG0   EQU   0                   WORK REGISTER                        49200000
PARMREG  EQU   1                   INPUT PARAMETER REGISTER             49300000
ERREG2   EQU   2                   WORK REGISTER                        49400000
CVTREG   EQU   3                   CVT BASE                             49500000
IOBREG   EQU   4                   IOB BASE                             49600000
EWAREG   EQU   5                   ERP WORKAREA BASE                    49700000
ERREG6   EQU   6                   WORK REGISTER                        49800000
ERREG7   EQU   7                   WORK REGISTER                        49900000
ERREG8   EQU   8                   WORK REGISTER                        50000000
ERREG9   EQU   9                   WORK REG                             50100000
IOSBREG  EQU   10                  IOSB BASE                            50200000
UCBREG   EQU   11                  UCB BASE                             50300000
BASERG   EQU   12                  PROGRAM BASE                         50400000
ERREG13  EQU   13                  WORK REGISTER                        50500000
RTNREG   EQU   14                  RETURN REGISTER                      50600000
ERREG15  EQU   15                  WORK REG                             50700000
         SPACE 2                                                        50800000
**********                                                              50900000
*                                                                       51000000
*        SENSE INDICATORS                                               51100000
*                                                                       51200000
**********                                                              51300000
CMDREJ   EQU   X'80'               COMMAND REJECT                       51400000
INTREQ   EQU   X'40'               INTERVENTION REQUIRED                51500000
BUSOUT   EQU   X'20'               BUS OUT CHECK                        51600000
EQPCHK   EQU   X'10'               EQUIPMENT CHECK                      51700000
SNOCUR0  EQU   X'4F'               SHOULD NOT OCCUR 2260 FIRST BYTE     51800000
SNOCUR3  EQU   X'1F'               SHOULD NOT OCCUR 1053 FIRST BYTE     51900000
SNOCUR02 EQU   X'FF'               SHOULD NOT OCCUR 2260 SECOND BYTE    52000000
SNOCUR32 EQU   X'FF'               SHOULD NOT OCCUR 1053 SECOND BYTE    52100000
         SPACE 2                                                        52200000
**********                                                              52300000
*                                                                       52400000
*        CSW STATUS INDICATORS                                          52500000
*                                                                       52600000
**********                                                              52700000
CHNEND   EQU   X'08'               CHANNEL END                          52800000
DEVEND   EQU   X'04'               DEVICE END                           52900000
UNITCK   EQU   X'02'               UNIT CHECK                           53000000
UNTEXC   EQU   X'01'               UNIT EXCEPTION                       53100000
PROGCK   EQU   X'20'               PROGRAM CHECK                        53200000
PROTCK   EQU   X'10'               PROTECTION CHECK                     53300000
CDCBIT   EQU   X'08'               CHANNEL DATA CHECK                   53400000
ASRCHK   EQU   X'06'               INTERFACE/CHANNEL CONTROL CHECK      53500000
CHAIN    EQU   X'01'               CHAINING CHECK                       53600000
ILXBF    EQU   X'BF'               INCORRECT LENGTH                     53700000
UCUEXFC  EQU   X'FC'               UNIT EXCEPTION/UNIT CHECK            53800000
         SPACE 2                                                        53900000
**********                                                              54000000
*                                                                       54100000
*        RETRY INDICATORS                                               54200000
*                                                                       54300000
**********                                                              54400000
BO1IND   EQU   X'80'               BUS OUT 1                            54500000
BO2IND   EQU   X'40'               BUS OUT 2                            54600000
ECRTRY   EQU   X'02'               ERP CHANNEL PROGRAM                  54700000
IOBEC    EQU   X'10'               EQUIPMENT CHECK                      54800000
SWITCH   EQU   X'08'               COMMAND CHAINING FOUND               54900000
CDCIND   EQU   X'04'               CHANNEL DATA CHECK                   55000000
ICCCCC   EQU   X'80'               ICC/CCC                              55100000
INTREQFD EQU   X'40'               INTERVENTION REQUIRED                55200000
*                                  PREVIOUSLY FOUND FOR 1053            55300000
INTREQRY EQU   X'20'               INTERVENTION REQUIRED RETRIED ONCE   55400000
*                                  AFTER DEVICE WAS MADE READY          55500000
         SPACE 2                                                        55600000
**********                                                              55700000
*                                                                       55800000
*         FLAGS USED WITH UCBTBYT4                                      55900000
*                                                                       56000000
**********                                                              56100000
A2260    EQU   X'03'               2260                                 56200000
A1053    EQU   X'04'               1053                                 56300000
         SPACE 2                                                        56400000
**********                                                              56500000
*                                                                       56600000
*        MISCELLANEOUS                                                  56700000
*                                                                       56800000
**********                                                              56900000
TIC      EQU   X'08'               TIC OP CODE                          57000000
EXCPER   EQU   15                  ERROR EXCP (SVC 15)                  57100000
EXIT     EQU   3                   RETURN TO SUPERVISOR (SVC 3)         57200000
NOTUSE   EQU   X'7F'               BIT NOT USED IN STAT TABLE           57300000
ZERO     EQU   0                   ZERO                                 57400000
N255     EQU   X'FF'               AND MASK                             57500000
N1       EQU   1                   ONE                                  57600000
N2       EQU   2                   TWO                                  57700000
N4       EQU   4                   FOUR                                 57800000
N8       EQU   8                   EIGHT                                57900000
WTO      EQU   253                 WTO ROUTINE ID                       58000000
ERRNM1   EQU   254                 STAT TABLE UPDATE ROUTINE ID         58100000
HEX01    EQU   X'01'               '00000001'                           58200000
HEX02    EQU   X'02'               '00000002'                           58300000
RETRY1   EQU   6                   RETRY CODE 1                         58400000
RETRY4   EQU   3                   RETRY CODE 4                         58500000
RETRY6   EQU   6                   RETRY CODE 6                         58600000
RETRY7   EQU   7                   RETRY CODE 7                         58700000
SIOINSTR EQU   X'10'               SIO FAIL MASK                        58800000
ERPVRTRY EQU   X'10'               RETRY CODE VALID                     58900000
ERPVCMAD EQU   X'04'               COMMAND ADDRESS VALID                59000000
X01      EQU   X'01'               STAT UPDATE CDC BIT                  59100000
         SPACE 2                                                        59200000
**********                                                              59300000
*                                                                       59400000
*        COMMAND CODES                                                  59500000
*                                                                       59600000
**********                                                              59700000
CCWCHAIN EQU   X'40'               COMMAND CHAINING                     59800000
CMDMASK  EQU   X'0F'               ZERO OUT KEYBOARD/UNLOCK             59900000
RDMI     EQU   X'02'               READ MI                              60000000
SRDMI    EQU   X'0A'               SHORT READ MI                        60100000
WRTDSB   EQU   X'01'               WRITE DSB                            60200000
ERASECMD EQU   X'07'               ERASE                                60300000
         EJECT                                                          60400000
         IECDIOSB                                                       60500000
         EJECT                                                          60600000
UCBSET   DSECT                                                          60700000
         IEFUCBOB                                                       60800000
         EJECT                                                          60900000
         IECDERWA                                                       61000000
         EJECT                                                          61100000
CVTSET   DSECT                                                          61200000
         CVT                                                            61300000
         EJECT                                                          61400000
         IEZIOB                                                         61500000
         EJECT                                                          61600000
         IECDRQE                                                        61700000
         END                                                            61800000
./  ADD  SSI=81600565,NAME=IGE0010D
         TITLE 'IGE0010D - LOCAL 5450 ERROR RECOVERY PROCEDURE'         00250002
IGE0010D CSECT                                                          00300002
*********************************************************************** 00350002
*                                                                     * 00400002
* MODULE NAME:                                                        * 00450002
*    IGE0010D                                                         * 00500002
*                                                                     * 00550002
* DESCRIPTIVE NAME:                                                   * 00600002
*    LOCAL 5450 ERROR RECOVERY PROCEDURE                              * 00650002
*                                                                     * 00700002
* COPYRIGHT:                                                          * 00750002
*    NONE                                                             * 00800002
*                                                                     * 00850002
* STATUS:                                                             * 00900002
*    CHANGE LEVEL 000                                                 * 00950002
*                                                                     * 01000002
* FUNCTION:                                                           * 01050002
*    THIS MODULE IS THE ERP FOR LOCALLY ATTACHED DEVICES OF THE       * 01100002
*    5450 DISPLAY SYSTEM OR 3066 CONSOLE. IT IS SCHEDULED BY IOS.     * 01150000
*    THE FOLLOWING FUNCTIONS ARE PERFORMED BY THIS MODULE:            * 01200002
*        * DETERMINES IF AN ERROR IS RETRYABLE BY THE ERP AND RETRIES * 01250002
*          THOSE THAT ARE.                                            * 01300002
*        * DETERMINES IF ERP RETRIES ARE SUCCESSFUL.                  * 01350002
*        * MAINTAINS THE STATISTICS TABLE FOR THE DEVICE.             * 01400002
*        * REQUESTS OBR LOGOUT WHEN REQUIRED.                         * 01450002
*                                                                     * 01500002
* NOTES:                                                              * 01550002
*    DEPENDENCIES:                                                    * 01600002
*        NONE                                                         * 01650002
*    RESTRICTIONS:                                                    * 01700002
*        THIS ERP IS FOR LOCALLY ATTACHED DEVICES ONLY USING EXCP     * 01750002
*    REGISTER CONVENTIONS:                                            * 01800002
*        SEE 'REGISTER DEFINITIONS' BELOW                             * 01850002
*                                                                     * 01900002
* PATCH LABEL:                                                        * 01950002
*    PACHAREA (40 BYTES)                                              * 02000002
*                                                                     * 02050002
* MODULE TYPE:                                                        * 02100002
*    PROCEDURE                                                        * 02150002
*    PROCESSOR:                                                       * 02200002
*        BAL                                                          * 02250002
*    MODULE SIZE:                                                     * 02300002
*        378 BYTES                                                    * 02350002
*    ATTRIBUTES:                                                      * 02400002
*        REENTRANT, ENABLED, KEY 0, SUPERVISOR STATE, NO LOCKS HELD   * 02450002
*                                                                     * 02500002
* ENTRY POINT:                                                        * 02550002
*    IGE0010D                                                         * 02600002
*    PURPOSE:                                                         * 02650002
*        THIS MODULE IS ENTERED WHEN ONE OR MORE OF THE FOLLOWING     * 02700002
*        CONDITIONS IS ENCOUNTERED:                                   * 02750002
*            UNIT CHECK                                               * 02800002
*            UNIT EXCEPTION                                           * 02850002
*            INVALID COMMAND SEQUENCE                                 * 02900002
*            INCORRECT LENGTH                                         * 02950002
*            PROGRAM CHECK                                            * 03000002
*            PROTECTION CHECK                                         * 03050002
*            CHAINING CHECK                                           * 03100002
*            CHANNEL DATA CHECK                                       * 03150002
*            INTERFACE CONTROL CHECK                                  * 03200002
*            CHANNEL CONTROL CHECK                                    * 03250002
*            COMMAND REJECT                                           * 03300002
*    LINKAGE:                                                         * 03350002
*        THIS MODULE IS SCHEDULED FOR EXECUTION BY THE INPUT/OUTPUT   * 03400002
*        SUPERVISOR. IT RUNS UNDER AN SIRB.                           * 03450002
*    INPUT:                                                           * 03500002
*        REG 1 = ADDRESS OF IOSB                                      * 03550002
*    OUTPUT:                                                          * 03600002
*        RECOVERABLE ERRORS:                                          * 03650002
*            IOSERR IS SET ON FOR RETRY                               * 03700002
*            SVC 15 IS ISSUED                                         * 03750002
*            RETURN VIA SVC 3                                         * 03800002
*        CORRECTED ERRORS:                                            * 03850002
*            IOSEX AND IOSERR ARE SET OFF                             * 03900002
*            IOSB IS CLEANED UP                                       * 03950002
*            EXIT IS TO IGE0025D TO UPDATE STATISTICS TABLE           * 04000002
*        PERMANENT ERRORS:                                            * 04050002
*            AN OBR LOGOUT IS SCHEDULED                               * 04100002
*            A STATISTIC TABLE UPDATE IS SCHEDULED                    * 04150002
*            IOSEX IS SET ON                                          * 04200002
*            IOSERR IS SET OFF                                        * 04250002
*            EXIT IS TO IGE0025D TO UPDATE STATISTICS TABLE           * 04300002
*        PROGRAMMING ERRORS:                                          * 04350002
*            SVC 15 IS ISSUED                                         * 04400002
*            IOSEX IS SET ON                                          * 04450002
*            IOSERR IS SET OFF                                        * 04500002
*            EXIT IS VIA SVC 3                                        * 04550002
*                                                                     * 04600002
* EXITS-NORMAL:                                                       * 04650002
*    SUPERVISOR VIA SVC 3                                             * 04700002
*    STATISTICS UPDATE ROUTINE (IGE0025D) VIA BRANCH ENTRY TO XCTL    * 04750002
*                                                                     * 04800002
* EXITS-ERROR:                                                        * 04850002
*    NONE                                                             * 04900002
*                                                                     * 04950002
* EXTERNAL REFERENCES:                                                * 05000002
*    ROUTINES:                                                        * 05050002
*        SVC 15 ERROR EXCP                                            * 05100002
*    DATA AREAS                                                       * 05150002
*        CHANNEL PROGRAM                                              * 05200002
*        ERP WORKAREA (MAPPED BY IECDERWA)                            * 05250002
*    CONTROL BLOCKS                                                   * 05300002
*        UCB          (MAPPED BY IEFUCBOB)                            * 05350002
*        CVT          (MAPPED BY CVT)                                 * 05400002
*        IOSB         (MAPPED BY IECDIOSB)                            * 05450002
*        RQE          (MAPPED BY IECDRQE)                             * 05500002
*        IOB          (MAPPED BY IEZIOB)                              * 05550002
*        DCB          (MAPPED BY DCBD)                                * 05600002
*                                                                     * 05650002
* TABLES-WORKAREAS:                                                   * 05700002
*    ERP WORKAREA                                                     * 05750002
*                                                                     * 05800002
* MACROS:                                                             * 05850002
*    NONE                                                             * 05900002
*                                                                     * 05950002
* CHANGE ACTIVITY:                                                    * 06000002
*    YM02594K (11/6/73)                                               * 06050002
*    OZ25331 (09/15/77)           OZ26007 (09/15/77)                  * 06070000
*    OZ29608 (02/15/78)           OZ33003 (06/05/78)                  * 06100000
*********************************************************************** 06150002
         EJECT                                                          06200002
*/*IGE0010D: CHART */                                                   06250002
*/* E IGE0010D */                                                       06300002
*/* D (YES,,NO,ERR603) EXCP */                                          06310002
*/* D (YES,,NO,START) FIRST ENTRY */                                    06320002
*/* P CLEAR EWASTUP */                                                  06330002
*/*START: P SET ERP IN CONTROL */                                       06350002
*/* D (YES,ERR670,NO,) IOSB INTERCEPT */                                06400000
*/* D (YES,ERR630,NO,) ICC OR CCC */                                    06450002
*/* D (YES,,NO,ERR600) CDC */                                           06500002
*/* D (YES,ERR603,NO,) CDC RETRIED */                                   06550002
*/* P (,ERR650) SET CDC RETRIED */                                      06600002
*/*ERR600: D (YES,,NO,ERR618) UNIT CHECK */                             06650002
*/*ERR601: S INTERPRETER RTN: CHECK SENSE AND BRANCH */                 06700000
*/* D (YES,ERR606,NO,) BUS OUT CHECK */                                 06750002
*/* D (YES,ERR605,NO,) DATA CHECK */                                    06800002
*/* D (YES,ERR607,NO,) BUF ADDR PARITY */                               06850002
*/* D (YES,ERR608,NO,) INVALID NUF ADDR */                              06900002
*/* D (YES,ERR609,NO,) COMMAND REJECT */                                06950002
*/* P (,ERR603) TEST END, PERM ERROR */                                 07000002
*/*ERR603: P INDICATE LOGOUT REQUIRED */                                07050002
*/* P INDICATE PERMANENT ERROR */                                       07100002
*/* P (,ERR626) RESET RETRY FLAGS */                                    07150002
*/*ERR626: P MOVE SENSE TO STAT TABLE ROUTINE COMM AREA */              07200002
*/* P LOAD STAT UPDATE ROUTINE ID */                                    07250002
*/* R BRANCH REG 14 */                                                  07300002
*/*ERR606: D (YES,ERR603,NO,) BUS OUT RETRIED */                        07350002
*/* P (,ERR650) SET BUS OUT RETRIED */                                  07400002
*/*ERR650: S SVC 15: ERROR EXCP */                                      07450002
*/* R SVC 3 */                                                          07500002
*/*ERR605: D (YES,ERR603,NO,) DATA CHK RETRIED */                       07550002
*/* P (,ERR650) SET DATA CHECK RETRIED */                               07600002
*/*ERR607: D (YES,ERR603,NO,) ADDR PARITY RETRIED */                    07650002
*/* P (,ERR650) SET ADDR PARITY RETRIED */                              07700002
*/*ERR608: D (YES,ERR603,NO,) BUF ADDR RETRIED */                       07750002
*/* P (,ERR650) SET BUFFER ADDRESS RETRIED */                           07800002
*/*ERR609: D (YES,ERR603,NO,) COMM REJ RETRIED */                       07850002
*/* P (,ERR650) SET COMMAND REJECT RETRIED */                           07900002
*/*ERR618: D (YES,,NO,ERR603) UNIT EXCEPTION? */                        07920000
*/* D (YES,,NO,ERR621) PROT OR PROG CHK */                              07950000
*/* P (,ERR650) INDICATE PERMANENT ERROR */                             08000002
*/*ERR670: D (YES,,NO,ERR603) UNIT CHECK */                             08005000
*/* D (YES,,NO,ERR603) BAD SENSE */                                     08010000
*/* D (YES,,NO,ERR603) EQUIPT CHECK */                                  08015000
*/* P SET EQUIPT CHECK IN STAT TBL */                                   08020000
*/* P CLEAR INTERCEPT INDICATOR */                                      08025000
*/* P CLEAR PERM ERROR IN IOSB */                                       08030000
*/* P CLEAR SENSE IN IOSB */                                            08035000
*/* P MODESET TCB KEY */                                                08036000
*/* P CLEAR DCB ERROR FLAGS */                                          08037000
*/* P (,ERR650) MODESET SUPVR KEY */                                    08040000
*/*ERR621: P MODESET TCB KEY */                                         08050000
*/* P RESET ERROR FLAGS IN DCB */                                       08060000
*/* P MODESET SUPVR KEY */                                              08070000
*/* P RESET ERROR FLAGS IN IOB AND IOSB */                              08100002
*/* P CLEAR RETRY FLAGS */                                              08150002
*/* P (,ERR626) RESET UNIT CHECK IN CSW */                              08200002
*/*ERR630: D (YES,ERR685,NO,) ICC OR CCC RETRIED */                     08250002
*/* D (YES,ERR685,NO,) IOSB INTERCEPT */                                08300002
*/* D (YES,ERR685,NO,) UNCOND NO RETRY */                               08350002
*/* P SET ICC OR CCC RETRIED */                                         08400002
*/* P (,ERR650) ZERO ERPIB */                                           08450002
*/*ERR685: P (,ERR603) ZERO ERPIB */                                    08500002
         EJECT                                                          08550002
         USING UCBSET,XUCB                                              08600002
         USING CVTMAP,XVEC                                              08650002
         USING IOSB,XIOSB                                               08700002
         USING EWA,XERP                                                 08750002
         USING *,PBASE                                                  08800002
         LR    XIOSB,XPARM         BASE IOSB                            08850002
         L     XERP,IOSERP         BASE ERP WORKAREA                    08900002
         L     XUCB,IOSUCB         BASE UCB                             08950002
         L     XVEC,CVTPTR         BASE CVT                             09000002
         L     XER11,IOSUSE        BASE RQE                 E12 ZA29608 09010000
         USING RQE,XER11                                    E12 ZA29608 09020000
         L     XER4,RQEIOB         BASE IOB                             09150002
         USING IOBSTDRD,XER4                                            09250002
         CLI   IOSDVRID,IOSXCPID   EXCP I/O                             09300002
         BNE   ERR603              NO, PERM ERROR                       09350002
         L     XER2,IOBDCBPT       BASE DCB                 E12 ZA26007 09360000
         USING IHADCB,XER2                                  E12 ZA26007 09370000
         TM    IOSFLA,IOSERR       FIRST ENTRY                          09400002
         BO    START               NO                                   09450002
         XC    EWASTUP(N2),EWASTUP   CLEAR STAT UPDATE AREA             09500002
START    EQU   *                                                        09550002
         OI    IOSFLA,IOSEX+IOSERR   INDICATE ERP IN CONTROL            09600002
         OI    IOBFLAG1,IOBERRTN+IOBIOERR   ALSO IN IOB                 09650002
         LA    XLNK,ERR618         SET ADDR TO SVC 15/SVC3 RETURN       09700002
         CLI   IOSCOD,IOSFINTC     INTERCEPT CONDITION                  09750002
         BE    ERR670              YES, ANALYZE             E12 ZA26007 09800000
         TM    IOSTSB,CSWCCC+CSWICC   ICC OR CCC                        09850002
         BNZ   ERR630              YES, CHECK CHANNEL ERROR             09900002
         TM    IOSTSB,CSWCDC       CHANNEL DATA CHECK                   09950002
         BNO   ERR600              NO, CHECK FOR UNIT CHECK             10000002
         OI    EWASTUP+N1,CDCBIT   SET CDC FOR STAT UPDATE              10050002
         TM    EWACNTR1,IOBRTCDC   HAS CHAN DATA CHECK BEEN RETRIED     10100002
         BO    ERR603              YES, EXIT                            10150002
         OI    EWACNTR1,IOBRTCDC   TURN ON RETRY FLAG                   10200002
         B     ERR650              GO RETRY                             10250002
ERR600   EQU   *                                                        10300002
         TM    IOSTSA,CSWUCK       UNIT CHECK                           10350002
         BNO   ERR618              NO, CHECK STATUS INFO                10400002
         LR    XPARM,XIOSB         SET UP IOSB POINTER                  10450002
         LR    XSAV,PBASE          YES, CHECK SENSE                     10500002
         L     PBASE,CVTXITP       POINT TO RESIDENT INTERPRETER RTN    10550002
ERR601   EQU   *                                                        10600002
         BALR  XCTL,PBASE          LINK TO INTERPRET SENSE INFO         10650002
         DC    X'02'               BUS OUT CHECK                        10700002
         DC    AL1(ERR606-ERR601-N2)   ADDRESS TO BRANCH TO             10750002
         DC    X'04'               DATA CHECK                           10800002
         DC    AL1(ERR605-ERR601-N4)   ADDRESS TO BRANCH TO             10850002
         DC    X'07'               BUFFER ADDRESS PARITY CHECK          10900002
         DC    AL1(ERR607-ERR601-N6)   ADDRESS TO BRANCH TO             10950002
         DC    X'06'               INVALID BUFFER ADDRESS               11000002
         DC    AL1(ERR608-ERR601-N8)   ADDRESS TO BRANCH TO             11050002
         DC    X'00'               COMMAND REJECT                       11100002
         DC    AL1(ERR609-ERR601-N10)   ADDRESS TO BRANCH TO            11150002
         DC    X'2F'                TEST END - PERMANENT ERROR          11200002
         DC    AL1(ERR603-ERR601-N12)   ADDRESS TO BRANCH TO            11250002
ERR603   EQU   *                                                        11300002
         OI    IOSFLB,IOSLOG        SET LOG OUT FLAG                    11350002
         NI    IOSFLA,N255-IOSERR   MARK AS PERMANENT ERROR             11400002
         NI    IOBFLAG1,N255-IOBERRTN   ALSO IN IOB                     11450002
         NI    EWACNTR1,N255-IOBCHN-IOBRTCDC   RESET CHAN RETRY FLAGS   11500002
ERR626   EQU   *                                                        11550002
         OC    EWASTUP(N1),IOSSNS   SET SENSE IN COMMUNICATIONS AREA    11600002
         L     XCTL,CVTXTLER       GET BRANCH ENTRY ADDRESS             11650002
         LA    XNAME,STATUP        ADDRESS OF STAT ROUTINE              11700002
         BR    XCTL                XCTL TO STATISTICS UPDATE ROUTINE    11750002
ERR606   EQU   *                                                        11800002
         TM    EWACNTR1,IOBBOE     BUS OUT RETRIED                      11850002
         BO    ERR603              YES, CONSIDER PERM ERROR             11900002
         OI    EWACNTR1,IOBBOE     INDICATE BUS OUT RETRY               11950002
ERR650   EQU   *                                                        12000002
         SVC   EXCPER              ERROR EXCP                           12050002
         SVC   ERRETURN            RETURN                               12100002
ERR605   EQU   *                                                        12150002
         TM    EWACNTR1,IOBDCE     DATA CHECK RETRIED                   12200002
         BO    ERR603              YES, PERM ERROR                      12250002
         OI    EWACNTR1,IOBDCE     INDICATE DATA CHECK RETRY            12300002
         B     ERR650              GO RETRY                             12350002
ERR607   EQU   *                                                        12400002
         TM    EWACNTR1,IOBBPC     BAD ADDRESS PARITY RETRIED           12450002
         BO    ERR603              YES, PERM ERROR                      12500002
         OI    EWACNTR1,IOBBPC     INDICATE RETRY                       12550002
         B     ERR650              GO RETRY                             12600002
ERR608   EQU   *                                                        12650002
         TM    EWACNTR1,IOBIBA     BAD BUFFER ADDRESS RETRIED           12700002
         BO    ERR603              YES, PERM ERROR                      12750002
         OI    EWACNTR1,IOBIBA     INDICATE RETRY                       12800002
         B     ERR650              GO RETRY                             12850002
ERR609   EQU   *                                                        12900002
         TM    EWACNTR1,IOBCRJ     COMMAND REJECT RETRIED               12950002
         BO    ERR603              YES, PERM ERROR                      13000002
         OI    EWACNTR1,IOBCRJ     INDICATE RETRY                       13050002
         B     ERR650              GO RETRY                             13100002
ERR618   EQU   *                                                        13150002
         TM    IOSTSB,CSWUEX       UNIT EXCEPTION           E12 ZA25331 13160000
         BO    ERR603              YES, NO RETRY            E12 ZA25331 13170000
         TM    IOSTSB,CSWPC+CSWPCK   PROTECTION OR PROGRAM CHECK        13200002
         BZ    ERR621              NO, THEN ENTERED FOR NORMAL END      13250002
         NI    IOSFLA,N255-IOSERR   SET  PERM ERROR                     13300002
         NI    IOBFLAG1,N255-IOBERRTN   ALSO IN IOB                     13350002
         B     ERR650              ISSUE SVC 15 AND SVC 3               13400002
ERR670   EQU   *                   INTERCEPT RETRY          E12 ZA26007 13402000
         TM    IOSTSA,CSWUCK       UNIT CHECK SENSE         E12 ZA26007 13404000
         BNO   ERR603              NO, PERM ERROR           E12 ZA26007 13406000
         TM    EWAFLG1,EWABDSNS    BAD SENSE                E12 ZA26007 13408000
         BO    ERR603              YES, CAN'T RETRY         E12 ZA26007 13410000
         CLI   IOSSNS,SENEC        EQUIPT CHECK             E12 ZA26007 13412000
         BNE   ERR603              NO, PERM. ERROR          E12 ZA26007 13414000
         OC    EWASTUP(N1),IOSSNS  SET SENSE IN COM AREA    E12 ZA26007 13416000
         MVI   IOSCOD,IOSNRMC      CLEAR INTCPT INDICATOR   E12 ZA26007 13418000
         NI    IOSFLA,N255-IOSEX   CLR PERM FLAG            E12 ZA26007 13420000
         NI    IOBFLAG1,N255-IOBIOERR  ALSO IN IOB          E12 ZA26007 13422000
         MVI   IOSSNS,ZERO         CLEAR SENSE              E12 ZA26007 13424000
         L     XER12,RQETCB         TCB ADDR IN RQE         E12 ZA29608 13424200
         DROP  XER11                                        E12 ZA29608 13424300
         USING TCB,XER12                                    E12 ZA29608 13424500
         MODESET EXTKEY=TCB,WORKREG=11                      E12 ZA29608 13424800
         MVI   IOBSENS0,ZERO       CLEAR SENSE IN IOB       E12 ZA33003 13426000
         NI    DCBIFLGS,N255-DCBIFEC CLEAR DCB ERR FLAGS    E12 ZA26007 13428000
         DROP  XER2                DCB NO LONGER NEEDED     E12 ZA26007 13430000
         MODESET EXTKEY=SUPR                                E12 ZA29608 13430200
         B     ERR650              EXIT TO RETRY            E12 ZA26007 13432000
ERR621   EQU   *                                                        13450002
         USING RQE,XER11                                    E12 ZA29608 13500000
         L     XER12,RQETCB             TCB FROM RQE        E12 ZA29608 13501000
         DROP  XER11                                        E12 ZA29608 13502000
         USING TCB,XER12                                    E12 ZA29608 13506000
         MODESET EXTKEY=TCB,WORKREG=11                      E12 ZA29608 13508000
         USING IHADCB,XER2                                              13550000
         NI    DCBIFLGS,N255-DCBIFEC   RESET ERROR INDICATORS           13600002
         DROP  XER2                                                     13650002
         MODESET EXTKEY=SUPR                                E12 ZA29608 13655000
         NI    IOSFLA,N255-IOSERR-IOSEX   RESET ERROR AND RESTART       13700002
         NI    IOBFLAG1,N255-IOBERRTN-IOBIOERR   ALSO IN IOB            13750002
         MVI   EWACNTR1,N0         CLEAR ERROR COUNTS                   13800002
         NI    IOSTSA,N255-CSWUCK   RESET CSW UNIT CHECK                13850002
         B     ERR626              GO TO STATISTIC UPDATE ROUTINE       13900002
ERR630   EQU   *                                                        13950002
         TM    EWACNTR1,IOBCHN     ICC OR CCC RETRIED                   14000002
         BO    ERR685              YES                                  14050002
         CLI   IOSCOD,IOSFINTC     IOSB INTERCEPTED                     14100002
         BE    ERR685              YES                                  14150002
         TM    EWARGFG1,EWANORTY   UNCONDITIONAL NO RETRY               14200002
         BO    ERR685              YES                                  14250002
         OI    EWACNTR1,IOBCHN     SET RETRY                            14300002
         XC    EWAERPIB(N8),EWAERPIB   CLEAR ERPIB                      14350002
         B     ERR650              GO ISSUE RETRY AND RETURN            14400002
ERR685   EQU   *                                                        14450002
         XC    EWAERPIB(N8),EWAERPIB   CLEAR ERPIB                      14500002
         B     ERR603              GO LOG OUT AND EXIT                  14550002
         EJECT                                                          14600002
**********                                                              14650002
*                                                                       14700002
*        CONSTANTS                                                      14750002
*                                                                       14800002
**********                                                              14850002
PACHAREA EQU   *                                                        14900002
         DC    35C'010D'           PATCH AREA FOR MAINT     E12 ZA26007 14950000
         SPACE 2                                                        15000002
**********                                                              15050002
*                                                                       15100002
*        REGISTER DEFINITIONS                                           15150002
*                                                                       15200002
**********                                                              15250002
XER0     EQU   0                   WORK REG                             15300002
XPARM    EQU   1                   PARAMETER REG                        15350002
XER2     EQU   2                   WORK REG                             15400002
XERP     EQU   3                   ERP WORKAREA BASE                    15450002
XER4     EQU   4                   WORK REG                             15500002
XER5     EQU   5                   WORK REG                             15550002
XUCB     EQU   6                   UCB BASE                             15600002
XLNK     EQU   7                   LINK REG                             15650002
XVEC     EQU   8                   CVT BASE                             15700002
XSAV     EQU   9                   SAVE REG                             15750002
XIOSB    EQU   10                  IOSB BASE                            15800002
XER11    EQU   11                  WORK REG                             15850002
XER12    EQU   12                  WORK REG                             15900002
XNAME    EQU   13                  XCTL NAME                            15950002
XCTL     EQU   14                  XCTL ENTRY POINT                     16000002
PBASE    EQU   15                  PROGRAM BASE                         16050002
         SPACE 2                                                        16100002
**********                                                              16150002
*                                                                       16200002
*        MISCELLANEOUS EQUATES                                          16250002
*                                                                       16300002
TCBADR   EQU   0                   CVT DOUBLE WORD          E12 ZA29608 16301000
CURRTCB  EQU   4                   ADDRESS CURRENT TCB      E12 ZA29608 16302000
**********                                                              16350002
CDCBIT   EQU   X'01'               STAT TABLE CDC ERROR BIT             16400002
EXCPER   EQU   15                  ERROR EXCP (SVC 15)                  16450002
ERRETURN EQU   3                   RETURN TO SUPERVISOR (SVC 3)         16500002
N0       EQU   0                   ZERO                                 16550002
N1       EQU   1                   ONE                                  16600002
N2       EQU   2                   TWO                                  16650002
N4       EQU   4                   FOUR                                 16700002
N5       EQU   5                   FIVE                                 16750002
N6       EQU   6                   SIX                                  16800002
N8       EQU   8                   EIGHT                                16850002
N10      EQU   10                  TEN                                  16900002
N12      EQU   12                  TWELVE                               16950002
N255     EQU   255                 AND MASK                             17000002
SENEC    EQU   X'10'               EQUIPTMENT CHECK SENSE   E12 ZA26007 17020000
STATUP   EQU   254                 STATISTIC UPDATE ROUTINE             17050002
ZERO     EQU   X'00'               ONE BYTE OF ZEROS        E12 ZA26007 17070000
         SPACE 2                                                        17100002
**********                                                              17150002
*                                                                       17200002
*        WORK AREA RETRY FLAGS                                          17250002
*                                                                       17300002
**********                                                              17350002
IOBCHN   EQU   X'80'               ICC/CCC                              17400002
IOBRTCDC EQU   X'40'               CHANNEL DATA CHECK                   17450002
IOBBOE   EQU   X'20'               BUSOUT ERROR                         17500002
IOBDCE   EQU   X'10'               DATA CHECK                           17550002
IOBBPC   EQU   X'08'               BUFFER ADDRESS PARITY                17600002
IOBIBA   EQU   X'04'               INVALID BUFFER ADDRESS               17650002
IOBCRJ   EQU   X'02'               COMMAND REJECT                       17700002
         SPACE 2                                                        17750002
**********                                                              17800002
*                                                                       17850002
*        CSW STATUS INDICATORS                                          17900002
*                                                                       17950002
**********                                                              18000002
CSWPC    EQU   X'20'               PROGRAM CHECK                        18050002
CSWPCK   EQU   X'10'               PROTECTION CHECK                     18100002
CSWUCK   EQU   X'02'               UNIT CHECK                           18150002
CSWCCC   EQU   X'04'               CHANNEL CONTROL CHECK                18200002
CSWICC   EQU   X'02'               INTERFACE CONTROL CHECK              18250002
CSWCDC   EQU   X'08'               CHANNEL DATA CHECK                   18300002
CSWUEX   EQU   X'01'               UNIT EXCEPTION                       18350002
         EJECT                                                          18400002
UCBSET   DSECT                                                          18450002
         IEFUCBOB                                                       18500002
         EJECT                                                          18550002
         IECDERWA                                                       18600002
         EJECT                                                          18650002
CVTSET   DSECT                                                          18700002
         CVT                                                            18750002
         EJECT                                                          18800002
         IECDIOSB                                                       18850002
         EJECT                                                          18900002
         IEZIOB                                                         18950002
         EJECT                                                          19000002
         IECDRQE                                                        19050002
         EJECT                                                          19100002
         DCBD                                                           19150002
         EJECT                                              E12 ZA29608 19151000
         IKJTCB                                             E12 ZA29608 19152000
         END                                                            19200002
./  ADD  SSI=81600559,NAME=IGE0010E
         TITLE 'IGE0010E - LOCAL 3270 ERROR RECOVERY PROCEDURE'         00150002
IGE0010E CSECT                                                          00200002
*                                                              @YA02128 00210002
*        FOLLOWING CHANGES APPLIED:                            @YA02128 00220002
*              YA02128   OCT 1973                              @YA02128 00230002
*              YM2594    OCT 1973                              @YM2594K 00232002
*              YA01064   OCT 1973                              @YA01064 00234002
*              YA02456   OCT 1973                              @YA02456 00236002
*              YA00844   OCT 1973                              @YA00844 00238002
*              YA01061   NOV 1973                              @YA01061 00238402
*              YA02483   NOV 1973                              @YA02483 00238802
*              YA02484   NOV 1973                              @YA02484 00239202
*              YA03227   NOV 1973                              @YA03227 00239602
*              YM5690    JAN 1974                              @YM5690K 00239700
*              YA03250   JAN 1974                              @YA03250 00239800
*         ZA02301    JAN 1975          ZA02807    JAN 1975            * 00241800
*         ZA02808    JAN 1975          ZA02809    JAN 1975            * 00243800
*         ZA02815  (01/20/75)          ZA02841  (03/03/75)            * 00245800
*         ZA03552  (03/03/75)          ZA03553  (03/03/75)            * 00247800
*         AZ03951  (04/29/75)          AZ04166  (08/25/75)            * 00249800
*         AZ06396  (11/07/75)          AZ11043  (06/01/76)            * 00251800
*         AZ15403  (11/17/76)          AZ25106  (08/19/77)            * 00253800
*         AZ25738  (08/19/77)          AZ27951  (11/09/77)            * 00254801
*         AZ27984  (11/10/77)          AZ25921  (12/27/77)            * 00255801
*         (AZ30723-(03/06/78)G51AKXX-(05/24/77))                      * 00259800
*         AZ30908  (06/07/78)                                         * 00261800
*                                                                     * 00268400
*********************************************************************** 00285502
*                                                                     * 00300002
* MODULE NAME:                                                        * 00350002
*    IGE0010E                                                         * 00400002
*                                                                     * 00450002
* DESCRIPTIVE NAME:                                                   * 00500002
*    LOCAL 3270 ERROR RECOVERY PROCEDURE                              * 00550002
*    ALSO USED FOR GRAPHIC CONSOLES                         D11       * 00570000
*                                                                     * 00600002
* COPYRIGHT:                                                          * 00650002
*    NONE                                                             * 00700002
*                                                                     * 00750002
* STATUS:                                                             * 00800002
*    CHANGE LEVEL 000                                                 * 00850002
*                                                                     * 00900002
* FUNCTION:                                                           * 00950002
*    THIS MODULE IS THE ERP FOR LOCALLY ATTACHED  DEVICES OF THE      * 01000002
*    3270 DISPLAY SYSTEM, AND IS ALSO USED FOR GRAPHIC CONSOLES       * 01050001
*    OF THE 3270 SYSTEM , 3056 AND 3036 CONSOLES.            @G51AKXX * 01060001
*    THE MODULE IS SCHEDULED BY IOS.                                  * 01070000
*    THE FOLLOWING FUNCTIONS ARE PERFORMED BY THIS MODULE:            * 01100002
*        * DETERMINES IF AN ERROR IS RETRYABLE BY THE ERP AND RETRIES * 01150002
*          THOSE THAT ARE.                                            * 01200002
*        * DETERMINES IF ERP RETRIES ARE SUCCESSFUL.                  * 01250002
*        * MAINTAINS THE STATISTICS TABLE FOR THE DEVICE.             * 01300002
*        * REQUESTS OBR LOGOUT WHEN REQUIRED.                         * 01350002
*        * REQUESTS INT REQ OR PERM ERROR MESSAGES WHEN REQUIRED.     * 01400002
*                                                                     * 01450002
* NOTES:                                                              * 01500002
*    DEPENDENCIES:                                                    * 01550002
*        NONE                                                         * 01600002
*    RESTRICTIONS:                                                    * 01650002
*        THIS ERP IS FOR LOCALLY ATTACHED DEVICES ONLY USING EXCP     * 01700002
*    REGISTER CONVENTIONS:                                            * 01750002
*        SEE 'REGISTER EQUATES' BELOW                                 * 01800002
*                                                                     * 01850002
* PATCH LABEL:                                                        * 01900002
*    PACHAREA (140 BYTES)                                             * 01950002
*                                                                     * 02000002
* MODULE TYPE:                                                        * 02050002
*    PROCEDURE                                                        * 02100002
*    PROCESSOR:                                                       * 02150002
*        BAL                                                          * 02200002
*    MODULE SIZE:                                                     * 02250002
*        APPROX. 1800 BYTES                                           * 02300002
*    ATTRIBUTES:                                                      * 02350002
*        REENTRANT, ENABLED, KEY 0, SUPERVISOR STATE,LOCAL LOCK HELD  * 02400000
*                                                                     * 02450002
* ENTRY POINT:                                                        * 02500002
*    IGE0010E                                                         * 02550002
*    PURPOSE:                                                         * 02600002
*        THIS MODULE IS ENTERED WHEN ONE OR MORE OF THE FOLLOWING     * 02650002
*        CONDITIONS IS ENCOUNTERED:                                   * 02700002
*            UNIT CHECK                                               * 02750002
*            UNIT EXCEPTION                                           * 02800002
*            INVALID COMMAND SEQUENCE                                 * 02850002
*            INCORRECT LENGTH                                         * 02900002
*            PROGRAM CHECK                                            * 02950002
*            PROTECTION CHECK                                         * 03000002
*            CHAINING CHECK                                           * 03050002
*            CHANNEL DATA CHECK                                       * 03100002
*            INTERFACE CONTROL CHECK                                  * 03150002
*            CHANNEL CONTROL CHECK                                    * 03200002
*            COMMAND REJECT                                           * 03250002
*    LINKAGE:                                                         * 03300002
*        THIS MODULE IS SCHEDULED FOR EXECUTION BY THE INPUT/OUTPUT   * 03350002
*        SUPERVISOR. IT RUNS UNDER AN SIRB WITH ADDRESSABILITY TO     * 03400002
*        THE APPLICATION'S ADDRESS SPACE.                             * 03420002
*    INPUT:                                                           * 03450002
*        REG 1 = ADDRESS OF IOSB                                      * 03500002
*        REG 15= ADDRESS OF ENTRY POINT                               * 03510002
*    OUTPUT:                                                          * 03550002
*      REG 1 = ADDRESS OF IOSB AND,                                   * 03560002
*        RECOVERABLE ERRORS:                                          * 03600002
*            IOSERR IS SET ON FOR RETRY                               * 03650002
*            IF A MESSAGE IS TO BE ISSUED, EXIT IS MADE TO IGE0025C   * 03700002
*            IF NO MESSAGE, SVC 15 IS ISSUED, THEN EXIT IS VIA SVC 3  * 03750002
*        CORRECTED ERRORS:                                            * 03800002
*            IOSEX AND IOSERR ARE SET OFF                             * 03850002
*            IOSB IS CLEANED UP                                       * 03900002
*            EXIT IS TO IGE0025D TO UPDATE STATISTICS TABLE           * 03950002
*        PERMANENT ERRORS:                                            * 04000002
*            AN OBR LOGOUT IS SCHEDULED                               * 04050002
*            A STATISTIC TABLE UPDATE IS SCHEDULED                    * 04100002
*            IOSEX IS SET ON                                          * 04150002
*            IOSERR IS SET OFF                                        * 04200002
*            EXIT IS TO IGE0025C TO ISSUE PERM ERROR MESSAGE          * 04250002
*        PROGRAMMING ERRORS:                                          * 04300002
*            SVC 15 IS ISSUED                                         * 04350002
*            IOSEX IS SET ON                                          * 04400002
*            IOSERR IS SET OFF                                        * 04450002
*            EXIT IS VIA SVC 3                                        * 04500002
*                                                                     * 04550002
* EXITS-NORMAL:                                                       * 04600002
*    SUPERVISOR VIA SVC 3                                             * 04650002
*    STATISTICS UPDATE ROUTINE (IGE0025D) VIA BRANCH ENTRY TO XCTL    * 04700002
*    IOS-WTO ROUTINE (IGE0025C) VIA BRANCH ENTRY TO XCTL              * 04750002
*                                                                     * 04800002
* EXITS-ERROR:                                                        * 04850002
*    NONE                                                             * 04900002
*                                                                     * 04950002
* EXTERNAL REFERENCES:                                                * 05000002
*    ROUTINES:                                                        * 05050002
*        SVC 15 ERROR EXCP                                            * 05100002
*    DATA AREAS                                                       * 05150002
*        CHANNEL PROGRAM                                              * 05200002
*        ERP WORKAREA (MAPPED BY IECDERWA)                            * 05250002
*    CONTROL BLOCKS                                                   * 05300002
*        UCB          (MAPPED BY IEFUCBOB)                            * 05350002
*        DCB          (MAPPED BY DCBD)                                * 05400002
*        IOSB         (MAPPED BY IECDIOSB)                            * 05450002
*        CVT          (MAPPED BY CVT)                                 * 05500002
*        IOB          (MAPPED BY IEZIOB)                              * 05550002
*        RQE          (MAPPED BY IECDRQE)                             * 05600002
*                                                                     * 05650002
* TABLES-WORKAREAS:                                                   * 05700002
*    ERP WORKAREA                                                     * 05750002
*                                                                     * 05800002
* MACROS:                                                             * 05850002
*    NONE                                                             * 05900002
*                                                                     * 05950002
*********************************************************************** 06150002
         EJECT                                                          06200002
*/*IGE0010E: CHART (AREF) */                                            06250002
*/* HEADER                                                              06260002
*/*    LOCAL 3270 ERP ROUTINE FOR BTAM AND DIDOCS (OS/VS2 REL. 037)     06270001
*/*0)                    JUNE 30, 1977                 PAGE # */        06275001
*/* E IGE0010E */                                                       06300002
*/* D (YES,,NO,RETEXIT) EXCP METHOD (IOSDVRID) */                       06410000
*/* P SET ERP IN CONTROL (IOB + IOSB) */                                06412000
*/* D (YES,,NO,CHKCLOS) FIRST TIME THROUGH (EWACNTR2 ) */               06420002
*/* P SET 1ST TIME FLAG (EWA) AND RESET ERROR CNT (IOBERRCT) */         06430000
*/* P RESET BITS FOR STAT UPDATE (EWASTUP) */                           06432002
*/* D (YES,,NO,UNREC1) SUPPORTED GRAPHICS DEVICE (UCBTYP)*/ E12 ZA15403 06450000
*/*CHKCLOS: D (YES,SNOEXIT,NO,) CLOSE IN PROCESS (DCBOFLGS) */          06700002
*/* D (YES,ANALINT,NO,) IOSB INTERCEPT (X'7E' COMP) */                  06750000
*/* D (YES,,NO,CHKINT) IOSSNS = X'10FE' */                              06760000
*/* D (YES,SNOEXIT,NO,) SIO CC=3 (IOSCC) */                             06770000
*/*CHKINT: D (YES,ANALCHAN,NO,) CHANNEL ERROR (CDC,CCC,ICC)*/           06780000
*/*CHKUCK: D (YES,ANALUCK,NO,) UNIT CHECK */                            06850002
*/* D (YES,ANALUEX,NO,) UNIT EXCEPTION */                               06900002
*/* D (YES,UNREC1,NO,) OTHER STATUS ERRORS */                           06950002
*/* D (YES,SNOEXIT,NO,) INVALID SIOCC FOR STATUS */         E12 ZA25738 06970000
*/*NOERR: P RESET IOSB AND IOB ERROR FLAGS */                           07000002
*/* P RESET IOSMSG, IOSLOG, FLAGS FOR APPENDAGE */                      07010002
*/* P (,CHKSTAT) RESET DCB ERROR INDICATORS (DCBIFLGS) */               07050002
*/*ANALINT: D (YES,,NO,SNOEXIT) UNIT CHECK STATUS */                    07070000
*/* D (YES,SNOEXIT,NO,) EWA SHOW BAD SENSE RECEIVED */                  07090000
*/* D (YES,SETEC,NO,) EQUIP CHECK (IOSSNS) */                           07110000
*/* D (YES,,NO,SNOEXIT) DATA CK,UNIT SPEC? */               E12 ZA15403 07130000
*/*SETDCUS: P (,SNOEXIT)  SET DC,US FOR STAT UPDATE */                  07150000
*/*SNOEXIT: N */                                                        07170000
*/*UNREC1: P (,SETPER) INDICATE LOGOUT REQUIRED (IOSLOG) */             07190000
*/*SETPER: P (,CHKSTAT) INDICATE PERMANENT ERROR IN IOB + IOSB */       07300002
*/*CHKSTAT: D (YES,STATEXIT,NO,) LOGOUT NEEDED (IOSLOG) */              07400000
*/* D (YES,STATEXIT,NO,CHKMULTI) SINGLE BIT ENTRIES (EWASTUP) */        07450002
*/*CHKMULTI: D (YES,,NO,RETEXIT) MULTI BIT ENTRIES (EWASTUP + 1) */     07500002
*/*STATEXIT: P LOAD STAT UPDATE ROUTINE ID (IGE0025D) */                07550002
*/* N (,XCTLEXIT) IF IOSLOG=1, STAT UPDATE ALWAYS GOES TO OBR           07560002
*/*(IGE0025F) */                                                        07570002
*/*RTYCNT: D (YES,PERMEXIT,NO,) RETRY COUNT AT MAX (MAX = 3) */         07650002
*/* P UP RETRY COUNT BY ONE (IOBERRCT) */                               07700000
*/* S GETCMD: GET FAILING AND RESTART CCW ADDR. */                      07704000
*/* D (NO,,YES,RESTART) FAILING CCW ERASE WRITE ? */                    07708000
*/* D (NO,,YES,RESTART) FAILING CCW ER/WRT ALT ? */         E12 ZA25921 07709001
*/* D (NO,,YES,PERMEXIT) D.C. U.S. IN SENSE ? */                        07712000
*/* D (NO,,YES,EWAFLGOF) FAILING CCW A READ */                          07716000
*/* D (NO,,YES,RESTART) FAILURE ON SELECT CCW */                        07720000
*/* D (NO,,YES,RESTART) ERASE ALL UNPROTECTED */                        07724000
*/* D (NO,,YES,WRITECHK) FAILING CCW A WRITE (X'01') */                 07728000
*/* D (NO,SNOEXIT,YES,RESTART) FAILURE ON A NOP */                      07732000
*/*EWAFLGOF: P (,RESTART) TURN OFF BIT 1 IN EWAFLG2 */                  07736000
*/*WRITECHK: D (NO,,YES,RESTART) CHANNEL END IN STATUS */               07740000
*/* D (NO,,YES,CHKSBA) CONTROL CHECK IN SENSE */                        07744000
*/* D (NO,PERMEXIT,YES,) E.C. U.S. IN SENSE */                          07748000
*/*CHKSBA: D (NO,PERMEXIT,YES,) SBA FOLLOWING THE WCC */                07752000
*/*RESTART: P CHANGE VIRTUAL RESTART ADDR. TO REAL */                   07756000
*/* P STORE RESTART ADDR. IN IOSRST */                                  07760000
*/* S XLATEVTV: XLATE VIRTUAL REAL TO VIRTUAL VIRTUAL */                07764000
*/* P (,CHKSTAT) STORE RESTART ADDR. IN IOBSTART */                     07768000
*/*RETEXIT: S SVC 15: ERROR EXCP (REG 1 = @IOSB) */                     07783302
*/* R SVC 3 */                                                          07800002
*/*PERMEXIT: P INDICATE LOGOUT REQUIRED (IOSLOG) */            @YA02128 07810002
*/*PERMNOBR: D (YES,UNREC1,NO,) OP CONSOLE (UCB) */            @YA02128 07850002
*/* P (,WTOEXIT) SET PERM ERROR (IOB + IOB) AND ERROR MESSAGE (IOSMSG)  08050002
*/**/                                                                   08060002
*/*WTOEXIT: P LOAD WTO ROUTINE ID (IGE0025C) */                         08100002
*/* N IF IOSLOG=1, WTO GOES TO OBR OR STAT UPDATE */                    08150002
*/*XCTLEXIT: N WTO, STAT UPDATE OR OBR WILL DO THE SVC 15, SVC 3 */     08160002
*/* R BRANCH TO XCTL ROUTINE */                                         08200002
*/*ANALUCK: D (YES,UNREC1,NO,)  IOSSNS = X'10FC'*/                      08250000
*/* S STATUP: SET APPROPRIATE BITS FOR STAT UPDATE */                   08253000
*/*CHKIR: D (YES,INTVREQ,NO,) INT REQ (IOSSNS) */             @YA02128  08260000
*/* D (NO,,YES,RTYCNT) CONTROL CK. IN SENSE ? */                        08310000
*/* D (NO,,YES,RTYCNT) D.C., U.S. IN SENSE ? */                         08350000
*/* D (NO,,YES,EWAFLGON) DATA CHECK IN SENSE ? */                       08390000
*/* D (NO,,YES,RTYCNT) B.O.C. IN SENSE ? */                             08430000
*/* D (NO,SNOEXIT,YES,RTYCNT) E.C., U.S. IN SENSE ? */                  08470000
*/*EWAFLGON: P (,RTYCNT) TURN ON BIT 1 IN EWAFLG2 */                    08510000
*/*ANALUEX: D (YES,CKCECMDS,NO,) CHAN END AND DEV END */                10550000
*/* D (YES,CKDECMDS,NO,SNOEXIT) DEV END ALONE */                        10600002
*/*CKCECMDS: P GET FIRST REAL CCW (IOSRST) */                           10650002
*/* S TRANSRTV: GET VIRTUAL ADDRESS OF REAL CCW */                      10660002
*/* D (YES,SNOEXIT,NO,RETEXIT) SENSE OR NO-OP CCW */                    10700000
*/*CKDECMDS: P GET FIRST REAL CCW (IOSRST) */                           10850002
*/* S TRANSRTV: GET VIRTUAL ADDRESS OF REAL CCW */                      10900002
*/* D (YES,RETEXIT,NO,SNOEXIT) SELECT OR ERASE UNPROT CCW */            10950000
*/*INTVREQ: D (YES,,NO,IRPERM) 3284 OR 3286 DEVICE (UCBTYP) */ @YA02128 12970000
*/*TESTCONS: D (YES,IRMSG,NO,) OP CONSOLE (UCB) */             @YA02128 12990000
*/*IRPERM: P TURN OFF UCBIVRR + UCBIVRS (UCBFLC) */                     12990201
*/* D (YES,SNOEXIT,NO,) BTAM OPEN CCW? (TP OP CODE AT IOB+ X'45' */     12990401
*/* P (,PERMNOBR) SET 'DEVICE NOT READY' FLAG (UCBGRAF) */     @YA02128 12990601
*/*IRMSG: D (NO,IRRETRY,YES,) DEVICE END ONLY? */                       12990801
*/* S GETCMD: GET FAILING AND RESTART CCW ADDR. */                      12991001
*/* D (YES,DEIRRTY,NO,) WRITE CCW */                           @YA02484 12991201
*/* D (YES,,NO,UNREC1) ERASE WRITE OR EWA CCW */            E12 ZA25921 12992001
*/*MAKEWRT: P CHANGE CCW CMD TO WRT */                      E12 ZA25921 12994001
*/*DEIRRTY: P CHANGE RESTART VIRTUAL ADDR. TO REAL */                   13009700
*/* P SET TO RETRY WITH RESTART CCW (IOSRST) */                         13029700
*/* S XLATEVTV: XLATE VIRTUAL REAL TO VIRTUAL VIRTUAL */                13049700
*/* P SET IOBSTART TO RESTART ADDR. */                                  13069700
*/*IRRETRY: P (,WTOEXIT) SET FOR INT REQ MESSAGE (IOSMSG = 0) */        13089700
*/*ANALCHAN: D (NO,CHECKCHN,YES,) CDC ?*/                               13109700
*/* S (,RTYCNT) STATUP: SET CDC FOR STAT UPDATE */                      13129700
*/*CHECKCHN: D (NO,,YES,UNREC1) IS THE ERPIB ZERO */                    13149700
*/* D (YES,,NO,UNREC1) CAN RETRY BE DONE*/                              13169700
*/* D (YES,,NO,UNREC1) INTER @, SEQ CODE & CHAN @ VALID*/               13300000
*/* D (NO,,YES,UNREC1) HALT I/O OR TEST I/O*/                           13350000
*/* D (YES,,NO,TSTRESET) START I/O*/                                    13400000
*/* D (YES,,NO,UNREC1) DEVICE ADDRESS VALID*/                           13450000
*/*TSTRESET: D (NO,,YES,SNOEXIT) SYSTEM RESET*/                         13500000
*/* D (NO,,YES,SNOEXIT) SEQUENCE CODE 0*/                               13550000
*/* D (NO,,YES,SNOEXIT) SEQUENCE CODE 6*/                               13600000
*/* D (NO,,YES,SNOEXIT) SEQUENCE CODE 7*/                               13650000
*/* D (NO,,YES,UNREC1) SIO COND CODE 3*/                                13700000
*/* D (YES,,NO,CKCMDVAL) SIO COND CODE 1*/*                             13750000
*/* P (,SEQ5CHK) GET ADDR OF FAILING CCW FROM IOSVST*/                  13800000
*/*CKCMDVAL: D (YES,,NO,UNREC1) COMMAND ADDRESS VALID*/                 13850000
*/* S GETCMD: GET ADDRESS OF FAILING COMMAND*/                          13900000
*/*SEQ5CHK: D (NO,,YES,SEQ5PROC) SEQUENCE CODE 5*/                      13950000
*/* D (NO,,YES,SEQ4PROC) SEQUENCE CODE 4*/                              14000000
*/* D (NO,,YES,SEQ3PROC) SEQUENCE CODE 3*/                              14050000
*/* D (NO,,YES,SNOEXIT) COMMAND A TIC*/                                 14100000
*/* D (NO,,YES, SEQ2PROC) SEQUENCE CODE 2*/                             14150000
*/*SEQ1PROC: D (NO,,YES,CONDRTRY) TERMINATION CODE 2*/                  14200000
*/*SEQ1TRM1: D (YES,SNOEXIT,NO,RETRY) TERMINATION CODE 1*/              14250000
*/*SEQ2PROC: D (YES,RETRY,NO,SEQ1TRM1) TERMINATION CODE 2*/             14300000
*/*SEQ3PROC: D (NO,,YES,SNOEXIT) SELECT*/                               14350000
*/* D (NO,,YES,SNOEXIT) ERASE ALL UNPROTECTED*/                         14400000
*/* D (NO,RETRY,YES,SNOEXIT) NO-OP*/                                    14402000
*/*SEQ4PROC: D (NO,,YES,CONDRTRY) TERMINATION CODE 2*/                  14402400
*/*RETRY: D (YES,,NO,RTYERR) WRITE COMMAND*/                            14402800
*/* D (YES,,NO,UNREC1) 2ND BYTE OF WRITE DATA AN SBA*/                  14403200
*/*RTYERR: D (NO,,YES,PERMEXIT) IS RETRY COUNT MAX*/                    14403300
*/* P (,RESTART) INCR RETRY COUNT BY ONE */                             14403400
*/*CONDRTRY: D (NO,,YES,UNREC1) IS FAILING COMMAND 1ST CCW*/            14403800
*/* D (NO,RETRY,YES,UNREC1) IS FAILING COMMAND CHAINED*/                14403900
*/*SEQ5PROC: D (NO,,YES,SEQ3PROC) CSW STORED AFTER SIO*/                14404000
*/* D (YES,,NO,UNREC1) CSW STORED AFTER INTERRUPT*/                     14405000
*/* M CLEAR RETRY FIELDS*/                                              14407000
*/* M (,RETEXIT) TURN OFF ERP IN CONTROL (IOB & IOSB) */                14407400
*/* E TRANSRTV */                                                       14407902
*/* S IEAPTRV: TRANSLATE TO VIRTUAL ADDRESS */                 @YM2594K 14410002
*/* D (YES,,NO,UNREC1) RETURN CODE = 0 */                     @YM2594K  14412000
*/* R TO CALLER */                                                      14414002
*/* E GETCMD */                                                         14416000
*/* P GET CCW ADDR FROM IOSCSW & CLEAR HI ORDER BYTE */                 14418000
*/* D (NO,,YES,CHKDE) IS THE CCW ADDR 0 */                              14420000
*/* P SUBTRACT 8 TO POINT TO FAILING CCW */                             14422000
*/* D (NO,SNOEXIT,YES,GETSTART) IS THE ADDRESS VALID ? */               14424000
*/*CHKDE: D (NO,,YES,SNOEXIT) CHNL. END IN CSW STATUS */                14426000
*/* D (YES,,NO,SNOEXIT) DVC. END IN CSW STATUS */                       14428000
*/*GETSTART: P GET START OF CHANNEL PROG. (IOSVST) */                   14430000
*/*CHNLOOP: D (NO,,YES,FOUNDCMD) FAILING CCW ? */                       14432000
*/* D (NO,,YES,TICRTN) IS THIS A TIC CCW ? */                           14434000
*/* D (YES,,NO,TSTCMDCH) IS THE CCW DATA CHAINED */                     14436000
*/* P (,CHNLOOP) ADD 8 TO FAILING CCW ADDRESS */                        14438000
*/*TSTCMDCH: D (YES,,NO,SEEIFDE) IS CCW CMD. CHAINED */                 14440000
*/* P (,CHNLOOP) ADD 8 TO FAIL CCW ADDR. AND UPDATE RST ADDR. */        14442000
*/*SEEIFDE: D (YES,FOUNDCMD,NO,SNOEXIT) IS CSW ADDR. ZERO */            14444000
*/*TICRTN: S TRANSRTV: XLATE TICED TO ADDR. REAL TO VIRTUAL */          14446000
*/* D (NO,,YES,TICTOADR) IS PREVIOUS CCW DATA CHAINED */                14448000
*/* P SET RESTART ADDR. TO ADDR. TICED TO */                            14450000
*/*TICTOADR: P (,CHNLOOP) FAILING CCW ADDR. TO CCW TICED TO */          14452000
*/*FOUNDCMD: D (YES,,NO,CMDOUT) IS RESTART CCW A TIC */                 14454000
*/* S TRANSRTV: GET VIRTUAL ADDR. OF CCW TICED TO */                    14456000
*/* P SET RESTART ADDR. TO ADDR. TICED TO */                            14458000
*/*CMDOUT: R RETURN TO CALLER */                                        14460000
*/* E XLATEVTV */                                                       14462000
*/* P PUT CCW ADDR. TO BE TRANSLATED IN REG. ZERO */                    14464000
*/* P GET ADDR. OF TCCW OUT OF RQETCCW & PUT IN REG. ONE */             14466000
*/* P SET TCCWOPTN TO X'04' */                                          14468000
*/* P GET ADDR. OF IOCOM OUT OF CVT (CVTIXAVL) */                       14477700
*/* P GET ADDR. OF TRANSLATE ROUTINE OUT OF IOCOM (IOCTCCW) */          14478400
*/* S IECVTCCW: LINK TO TRANSLATE ROUTINE */                            14479100
*/* D (YES,,NO,UNREC1) RETURN CODE ZERO */                              14479800
*/* R RETURN TO CALLER */                                               14480500
*/* E STATUP */                                                         14484300
*/* D (NO,,YES,UNREC1) C.R. OR OP. CK. */                               14485100
*/* D (NO,,YES,CHKIRUS) U.S. IN STATUS ? */                             14485900
*/* D (NO,,YES,SETCDC) CHNL DATA CHECK IN STATUS */                     14486700
*/* P (,STATRTN) OR SENSE BYTE IN EWASTUP FOR STAT UPDATE */            14487500
*/*CHKIRUS: D (YES,,NO,CKIRECUS) IR,US IN SENSE ? */                    14488300
*/* P (,STATRTN) OR ON BIT 4 EWASTUP+1 */                               14489100
*/*CKIRECUS: D (YES,,NO,CHKDCUS) IR, EC, US ? */                        14502800
*/* P (,STATRTN) OR ON BIT 5 IN EWASTUP+1 */                            14504800
*/*CHKDCUS: D (YES,,NO,CHKECUS) DC, US ? */                             14506800
*/* P (,STATRTN) OR ON BIT 3 IN EWASTUP+1 */                            14508800
*/*CHKECUS: D (YES,,NO,STATRTN) EC, US ? */                             14510800
*/* P (,STATRTN) OR ON BIT 6 IN EWASTUP+1 */                            14512800
*/*SETCDC: P OR ON BIT 7 IN EWASTUP+1 */                                14514800
*/*STATRTN: R RETURN TO CALLER */                                       14516800
*/*IGE0010E: END */                                                     14522700
         EJECT                                                          14526600
         USING IOSB,IOSBREG                                             14538302
         USING UCBSET,UCBREG                                            14550002
         USING CVTMAP,CVTREG                                            14600002
         USING RQE,DCBREG                                               14650002
         USING IOBSTDRD,IOBREG                                          14700002
         USING EWA,EWAREG                                               14750002
         USING START,BASREG                                    @ZA04166 14800000
START    B     CONTIN                  BRANCH AROUND ID        @YA02128 14810000
         DC    CL8'IGE0010E'             MODULE ID             @YA02128 14820002
         DC    X'8158'                     AND DATE            @ZA30908 14830000
         DC    C'&SYSDATE'          DATE LAST ASSEMBLY                  14832002
CONTIN   DS    0H                                              @YA02128 14840002
         LR    IOSBREG,PARMREG          BASE IOSB                       14850002
         CLI   IOSDVRID,IOSXCPID        EXCP I/O               @YM5690K 14860000
         BNE   RETEXIT                  NO, PERM ERROR         @YM5690K 14870000
         L     UCBREG,IOSUCB            BASE UCB                        14900002
         L     EWAREG,IOSERP            BASE ERP WORKAREA               14950002
         L     CVTREG,CVTPTR            BASE CVT               @YM2594K 15000002
         L     DCBREG,IOSUSE            BASE RQE                        15050002
         L     IOBREG,RQEIOB            BASE IOB                        15100002
         DROP  DCBREG                                                   15150002
         USING IHADCB,DCBREG                                            15200002
         L     DCBREG,IOBDCBPT          BASE DCB                        15250002
         OI    IOSFLA,IOSERR+IOSEX      INDICATE ERP IN CONTROL         15310002
         OI    IOBFLAG1,IOBERRTN+IOBIOERR      ALSO IN IOB              15320002
*              2 LINES MOVED TO NEAR LINE 148500               @YM5690K 15370000
         TM    EWACNTR2,FIRSTFLG        FIRST TIME THRU ERP             15450002
         BO    CHKCLOS                  NO, CONTINUE                    15500002
         MVI   EWACNTR1,ZERO            RESET COUNTER                   15550002
         OI    EWACNTR2,FIRSTFLG        FIRST TIME THRU ERP             15600002
         XC    EWASTUP,EWASTUP         RESET INTERFACE TO STAT UPDATE   15610002
         MVI   IOBERRCT+ONE,HEX07       FLAGS FOR CHANNEL END APPENDAGE 15650002
*   TEN LINES OF CODE REDUCED TO FOUR BY APAR------------->    @ZA15403 15700000
         CLC   UCBTBYT3(2),LOWDVC       IS DEVICE 3270         @ZA15403 15750000
         BL    UNREC1                   NO EXIT WITH ERROR     @ZA15403 15850000
         CLC   UCBTBYT3(2),HIGHDVC    MAYBE TEST FURTHER       @G51AKXX 15900001
         BH    UNREC1                   NO EXIT WITH ERROR     @ZA15403 15950000
CHKCLOS  EQU   *                                                        16200002
         TM    DCBOFLGS,DCBOFOPN+DCBOFIOF   IS CLOSE IN PROGRESS        16250002
         BO    SNOEXIT                  YES, EXIT WITH ERROR            16300002
*              7 LINES DELETED                                 @YM5690K 16310000
         CLI   IOSCOD,IOSFINTC          IS I/O REQUEST INTERCEPTED      16350002
         BE    ANALINT                  YES, ANALYZE                    16400002
         TM    EWAFLG1,EWABDSNS        TEST BAD SENSE          @YM5690K 16402000
         BO    CHKINT                   TO ELEMINATE SIO CC=3  @YM5690K 16404000
         CLC   IOSSNS(TWO),CC3SNS       SENSE FOR SIOCC=3      @YM5690K 16410000
         BNE   CHKINT                   NO                     @YM5690K 16420000
         TM    IOSCC,IOSCC3             SIOCC=3                @YM5690K 16430000
         BO    SNOEXIT            YES, PERM ERROR, NO MESSAGE  @YM5690K 16440000
CHKINT   DS    0H                                              @YM5690K 16442000
         TM    IOSTSB,CATCHAN           ANY CHANNEL ERRORS              16450002
         BNZ   ANALCHAN                 YES, CHECK THEM                 16500002
CHKUCK   EQU   *                                                        16550002
         TM    IOSTSA,CSWUCK            UNIT CHECK                      16600002
         BO    ANALUCK                  IF YES-ANALYZE                  16650002
         TM    IOSTSA,CSWUEX            UNIT EXCEPTION                  16700002
         BO    ANALUEX                  YES, ANALYZE                    16750002
         TM    IOSTSB,CATERR            ANY OTHER STATUS ERRORS         16800002
         BNZ   UNREC1                   YES, EXIT WITH ERROR            16850002
         TM    IOSCC,IOSCC3       NON-ZERO SIOCC            E12 ZA25738 16860000
         BNZ   NOERR                 YES,RETURN TO IOS      E12 ZA25738 16870000
         TM    IOSTATUS,CSWSMBSY        STAT MOD OR BUSY    E12 ZA25738 16880000
         BNZ   SNOEXIT             SNO FOR SIOCC=0          E12 ZA25738 16890000
NOERR    EQU   *                                                        16900002
         NI    IOSFLA,N255-IOSERR-IOSEX   CLEAR IOSB ERROR FLAGS        16950002
         NI    IOBFLAG1,N255-IOBERRTN-IOBIOERR    ALSO IN IOB           16960002
         NI    IOSFLB,N255-IOSMSG-IOSLOG   CLEAR IOSB ERROR FLAGS       17000002
         NI    IOBERRCT+ONE,N255-HEX07   RESET APPENDAGE FLAGS          17050002
         NI    DCBIFLGS,N255-DCBIFEC    CLEAR DCB ERROR FLAGS           17100002
***** THE FOLLOWING LINE OF CODE DELETED. *****************    @ZA03951 17105000
******   XC    UCBSNS(TWO),UCBSNS       CLEAR SENSE         LD @ZA02807 17110000
         B     CHKSTAT                  EXIT TO STAT UPDATE OR RETURN   17150002
ANALINT  EQU   *                                                        17200002
         TM    IOSTSA,CSWUCK       UNIT CHECK SENSE?           @YM5690K 17202000
         BNO   SNOEXIT            NO, PERM ERROR (ONLT LIKELY) @YM5690K 17204000
         TM    EWAFLG1,EWABDSNS        BAD SENSE               @YM2594K 17210002
         BO    SNOEXIT                 YES,  GET OUT           @YM2594K 17220002
         CLI   IOSSNS,SENEC             EQUIP CHECK                     17250002
         BE    SETEC                   YES, STAT UPDATE, RETRY          17300002
         CLI   IOSSNS,SENDCUS          DATA CHK, UNIT SPECIFY           17310002
*    TWO LINES REDUCED TO ONE AND THREE MOVED HERE BY APAR-->  @ZA15403 17320000
         BNE   SNOEXIT                 NO, EXIT WITH ERROR     @ZA15403 17326000
SETDCUS  DS    0H                                                       17332000
         OI    EWASTUP+ONE,STDCUS      INDICATE DC, US IN STAT TABLE    17338000
         B     SNOEXIT                 EXIT WITH ERROR                  17344000
SETEC    EQU   *                                                        17350002
         OI    EWASTUP,STATEC          INDICATE EC IN          @YA01061 17360002
*                                                STAT TABLE    @YA01061 17370002
         MVI   IOSCOD,IOSNRMC           CLEAR INTCPT INDICATOR          17400002
         NI    IOSFLA,N255-IOSEX        CLEAR PER FLAG                  17450002
         NI    IOBFLAG1,N255-IOBIOERR            ALSO IN IOB            17460002
         MVI   IOSSNS,ZERO              CLEAR SENSE                     17500002
         MVI   IOBSENS0,ZERO               ALSO IN IOB                  17510002
         NI    IOBERRCT+ONE,N255-HEX07   RESET APPENDAGE FLAGS          17550002
         NI    DCBIFLGS,N255-DCBIFEC    CLEAR DCB ERROR FLAGS           17600002
         B     RETEXIT                  EXIT TO RETRY                   17650002
*                                                                       17660002
ANALUCK  EQU   *                                                        19950002
         TM    EWAFLG1,EWABDSNS         BAD SENSE                       20000002
         BO    UNREC1                   YES, EXIT WITH ERROR            20050002
         CLI   IOSSNS,SENIR             INTER. REQ. SENSE?  E12 ZA27951 20052001
         BNE   CONTUC                   NO DON'T TEST FLAG  E12 ZA27951 20054001
         TM    UCBGRAF,UCBDWNR          FLAG SET            E12 ZA27951 20056001
         BO    INTVREQ                  YES,RECORD AND POST E12 ZA27951 20058001
*         TWO LINES OF CODE DELETED BY APAR ---------------->  @ZA06396 20060000
CONTUC   TM    IOSTSA,CSWCDE            CHAN END AND D. E.  E12 ZA27951 20100001
         BO    CHKCESNS                 YES, CHECK CE SENSE COND        20150002
         TM    IOSTSA,CSWDVE            DEVICE END ALONE                20200002
         BO    ANALDERR                 YES                             20250002
*              2 LINES MOVED TO NEAR LINE 200500               @YM5690K 20300000
         BAL   LNKREGB,CHKDIAG          CHECK FOR DIAG CMD              20400002
         B     BRTAB3(IXREG)            DIAG CHK RTN BR TBL             20450002
BRTAB3  EQU   *                                                         20500002
         B     PERMEXIT                 DIAG CMD, PERM ERR EXIT         20550002
         CLI   IOSSNS,SENBOC            BUS OUT CHECK                   20600002
         BNE   CHKCR                   NO, CHECK FOR CR                 20650002
         OI    EWASTUP,STATBOC    YES, SET BOC FOR STAT UPDATE @YA01061 20660002
*     ONE LINE DELETED AND ELEVEN MOVED HERE BY APAR------>    @ZA15403 20670000
RTYCNT   EQU   *                                                        20680000
         CLI   EWACNTR1,THREE           RETRY COUNT AT MAX              20690000
         BNL   PERMEXIT                 MAX CNT-PER ERR EXIT            20700000
         SR    ICREG,ICREG              CLEAR REG                       20705000
         IC    ICREG,EWACNTR1           PICK UP COUNT                   20710000
         LA    ICREG,ONE(ICREG)         BUMP BY ONE                     20715000
         STC   ICREG,EWACNTR1           SAVE COUNT                      20720000
RETEXIT  EQU   *                                                        20725000
         LR    PARMREG,IOSBREG     RESTORE REG 1 TO IOSB ADDR  @YM2594K 20730000
         SVC   EREXCP                   ERROR EXCP                      20735000
         SVC   RETURN                   RETURN TO SVPR                  20740000
CHKCR    EQU   *                                                        20750002
         CLI   IOSSNS,SENCR             COMMAND REJECT                  20800002
         BE    UNREC2                   YES                             20850002
         CLI   IOSSNS,SENIR            INTERVENTION REQ        @ZA06396 20860000
*    TWO LINES REDUCED TO ONE AND FIFTY ONE MOVED HERE BY ---> @ZA15403 20870000
         BNE   UNREC1                NO UNRECOV ERROR          @ZA15403 20880000
         EJECT                                                          20890000
*                                                              @YA02128 20900000
*              HANDLE INTERVENTION REQUIRED AS                 @YA02128 20910000
*              PERMANENT ERRORS                                @YA02128 20920000
*              EXCEPT THAT THE 3284 AND 3286 PRINTERS          @YM5690K 20930000
*              WILL BE PROCESSED FOR INTERVENTION REQUIRED     @YM5690K 20940000
*              IF BEING USED AS CONSOLES                       @YM5690K 20950000
*                                                              @YA02128 20960000
INTVREQ  DS    0H                                              @YM5690K 20970000
         BAL   LNKREGB,CHKDIAG          CHECK FOR DIAG CMD     @YA02128 20980000
         B     BRTAB1(IXREG)    DIAG CHECK RETURN BRANCH TABLE @YA02128 20990000
BRTAB1   EQU   *                                               @YA02128 21000000
         B     SNOEXIT          DIAGNOSE COMMAND PERM ERROR    @YM5690K 21010000
         OI    EWASTUP,STATIR          SET IR FOR STAT UPDATE  @YA02128 21020000
*      FIVE LINES OF CODE REMOVED BY APAR------------------>   @ZA15403 21030000
TESTCONS EQU   *                                               @YA02128 21040000
         TM    SRTESTAT,UCBONLI+UCBSYSR   DEV. AN ONLINE       @YA02128 21050000
*                                             ACTIVE CONSOLE   @YA02128 21060000
         BNO   IRPERM             NO,SET PERM ERROR         E12 ZA25106 21062000
         CLI   UCBTBYT4,DEV3284    HARDCOPY CONSOLE         E12 ZA25106 21064000
         BE    IRMSG                YES, EXIT IR MESSAGE    E12 ZA25106 21066000
         CLI   UCBTBYT4,DEV3286     HARDCOPY CONSOLE        E12 ZA25106 21068000
         BE    IRMSG                 IF YES-EXIT IR MESSAGE E12 ZA25106 21070000
IRPERM   DS    0H                                              @YM5690K 21080000
         NI    UCBFLC,N255-(UCBIVRR+UCBIVRS)    TURN OFF       @YM5690K 21090000
*                                             SINCE NO IR MSG  @YM5690K 21100000
         MVC   IOBWORK(ONE),IOBCPA+FIVE  SET UP TP CODE...  LD @ZA02301*21110000
                                   ...IN WORK AREA.         LD @ZA02301 21120000
         NI    IOBWORK,N255-(CCWCD+CCWCC) CLEAR UNUSED BITS LD @ZA02301 21130000
         CLI   IOBWORK,BTAMOPEN    OPEN TP OP CODE          LD @ZA02301 21140000
         BE    SNOEXIT             OPEN, PERMANENT ERROR... LD @ZA02301*21150000
                                   ...NO MSG OR LOG.        LD @ZA02301 21160000
*     THE FOLLOWING CODE CHANGED DUE TO BTAM READYQ CHANGE  E12 ZA27984 21161001
*  ERP SHOULD NOT SET UCBDWNR SINCE BTAM IS THE ONLY USER   E12 ZA27984 21162001
* BTAM WILL NOW BE RESPONSIBLE TO SET AND RESET IT. IF ANY  E12 ZA27984 21163001
*  OTHER ACCESS METHODS OR APPLICATIONS USE THIS THEY MUST  E12 ZA27984 21164001
*  SET AND RESET IT ALSO. IT IS ONLY VALID FOR INTERVENTION E12 ZA27984 21165001
*  REQUIRED SITUATIONS. AS AN INTERM MEASURE THE FOLLOWING  E12 ZA27984 21166001
*  BRANCH MAY BE NO-OPED TO ALLOW ERP TO SET IT.            E12 ZA27984 21167001
         B     PERMNOBR                                     E12 ZA27984 21168001
         OI    UCBGRAF,UCBDWNR       SET FAILED FLAG IN GCB    @YA02128 21170000
         B     PERMNOBR                                        @YA02128 21180000
IRMSG    EQU   *                                               @YM5690K 21190000
         TM    IOSTSA,CSWDVE       DEVICE END?                 @YM5690K 21200000
         BNO   IRRETRY             NO, SHOULD BE SIO CC=1      @YM5690K 21210000
         TM    IOSTSA,CSWCHE       CHANNEL END                 @YM5690K 21220000
         BO    IRRETRY     YES, ERROR BEFORE BUFFER COMPLETE   @YM5690K 21230000
*                    NO, ERROR WHILE PRINTER DUMPING BUFFER    @YM5690K 21240000
         BAL   LNKREG,CMDSRCH           FIND LAST COMMAND               21250000
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           21260000
         BE    DEIRRTY                  YES-RETRY WCC ONLY              21270000
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     21280000
         BE    MAKEWRT                  YES, CHANGE TO WRT  E12 ZA25921 21283001
         CLI   CCWCMD(CCWREG),CCWEWA    ER/WRT ALTERNATE    E12 ZA25921 21284001
         BNE   UNREC1                  NO-SNO, LOG             @YM5690K 21290000
MAKEWRT  EQU   *                                            E12 ZA25921 21295001
         MVI   CCWCMD(CCWREG),CCWWRT   CHANGE TO WRITE         @YM5690K 21300000
DEIRRTY  EQU   *                                                        21310000
         LA    WKREG1,ONE               PICK UP RTY BYTE CNT            21320000
         STH   WKREG1,CCWCNT(CCWREG)    SET CNT TO RETRY WCC            21330000
         NI    CCWFLGS(CCWREG),N255-CCWCD   NO DATA CHAINING   @YM5690K 21340000
         LRA   CCWREG,ZERO(CCWREG)      SET REAL ADDRESS FOR IOS        21350000
         ST    CCWREG,IOSRST            RETRY LAST/ONLY CMD             21360000
IRRETRY  DS    0H                                              @YM5690K 21370000
         NI    IOBERRCT+ONE,N255-HEX07   RESET APPENDAGE FLAGS @YM5690K 21380000
         NI    IOSFLB,N255-IOSMSG       INT REQ MSG INDICATOR           21390000
         B     WTOEXIT                  EXIT TO WTO AND RETRY           21400000
CHKCESNS EQU   *                                                        21800002
         BAL   LNKREGB,CHKDIAG          CHECK FOR DIAG CMD              21850002
         B     BRTAB2(IXREG)            DIAG CMD RTN BR TBL             21900002
BRTAB2   EQU   *                                                        21950002
         B     PERMEXIT                 DIAG CMD, PER ERR EXIT          22000002
         SR    CCWREG,CCWREG            GET CCW ADDR WITH      @ZA15403 22050000
         ICM   CCWREG,M7,IOSCSWCA       HI BYTE CLEAR          @ZA15403 22100000
         SH    CCWREG,CONEIGHT          FAILING CCW ADDR                22150002
         BNP   UNREC1               BRANCH IF ADDRESS WAS ZERO @YA03250 22250000
         CLI   IOSSNS,SENBOC            BUS OUT CHECK                   22300002
         BE    BOCCMDS                  YES-CHECK CMDS                  22350002
         CLI   IOSSNS,SENDC             DATA CHECK                      22400002
         BE    CMDCHK                   YES-CHECK CMDS                  22450002
         CLI   IOSSNS,SENCC             CONTROL CHECK                   22500002
         BE    CMDCHK                   YES-CHECK CMDS                  22550002
         CLI   IOSSNS,SENDCUS           DATA CHK,UNIT SPECIFY           22600002
         BE    CMDCHK                   YES-CHECK CMDS                  22650002
         CLI   IOSSNS,SENOC             OPERATION CHECK                 22700002
         BNE   UNREC1                   NO                     @YA03250 22750000
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           22800002
         BE    UNREC2                   YES                             22850002
*          *****LINES 228600-228700 REMOVED BY ZA02841****  L5 @ZA02841 22870000
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     22900002
         BE    UNREC2                   YES,USER RETRYABLE  E12 ZA25921 22910001
         CLI   CCWCMD(CCWREG),CCWEWA    ER/WRT ALTERNATE?   E12 ZA25921 22920001
*   TWO LINES REDUCED TO ONE AND THREE MOVED HERE BY APAR--->  @ZA15403 22950000
         BNE   UNREC1                   NO, EXIT WITH ERROR    @ZA15403 22980000
UNREC2   EQU   *                                                        23010000
         NI    IOBERRCT+ONE,N255-HEX01  INDICATE USER RETRYABLE         23040000
         B     SETPER                   EXIT                            23070000
BOCCMDS  EQU   *                                                        23100002
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           23150002
         BE    UNREC1                   YES, EXIT                       23200002
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     23250002
         BE    BOCSTAT                  YES,SET STAT FLAG   E12 ZA25921 23260001
         CLI   CCWCMD(CCWREG),CCWEWA    ER/WRT ALTERNATE?   E12 ZA25921 23270001
         BNE   UNREC1                   NO, EXIT WITH ERR      @YA03250 23300000
BOCSTAT  EQU   *                                            E12 ZA25921 23320001
         OI    EWASTUP,STATBOC         SET BOC FOR STAT UPDATE @YA01061 23350002
         B     RTYCNT                   RETRY CHAN PGM                  23400002
CMDCHK   EQU   *                                                        23450002
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           23550002
         BE    CKFSTCCW                 YES, IS FST IS EWR  L5 @ZA02841 23600000
*      ****LINES 236100-236200 REMOVED BY ZA02841*****      L5 @ZA02841 23630000
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     23650002
         BE    RECRTY                   YES-RETRY                       23700002
         CLI   CCWCMD(CCWREG),CCWEWA   ER/WRT ALTERNATE?    E12 ZA25921 23710001
         BE    RECRTY                  YES, RETRY           E12 ZA25921 23720001
         CLI   CCWCMD(CCWREG),CCWSEL    SELECT                          23750002
         BE    RECRTY                   YES-RETRY                       23800002
         CLI   CCWCMD(CCWREG),CCWEUP    ERASE UNPROTECTED               23850002
         BE    RECRTY                   YES-RETRY                       23900002
         CLI   IOSSNS,SENDCUS           DATA CHK,UNIT SPECIFY           24000002
         BE    RDERR                    YES-CHK RD CMDS                 24050002
         CLI   CCWCMD(CCWREG),CCWRDM    READ MODIFIED                   24100002
         BE    CHKWRCMD                 YES-CHECK CHAN PGN              24150002
         CLI   CCWCMD(CCWREG),CCWRDB    READ BUFFER                     24200002
         BE    CHKWRCMD                LOOK FOR WRITE       L5 @ZA02841 24250000
*                                      BEFORE FAILING       L5 @ZA02841 24260000
         TM    CCWFLGS(CCWREG),CCWCD   DATA CHAIN?          L5 @ZA02841 24270000
         BZ    UNREC1                  NO,SET UNRECOVERABLE L5 @ZA02841 24280000
CKFSTCCW EQU   *                                            L5 @ZA02841 24282000
         L     PARMREG,IOSRST          REAL ADDR FST CCW    L5 @ZA02841 24284000
         BAL   ICREG,TRANSRTV          GET VIRT ADDR REAL   L5 @ZA02841 24286000
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG     L5 @ZA02841 24288000
         CLI   CCWCMD(CCWREG),CCWEWR   IS IT EWR?           L5 @ZA02841 24290000
         BE    RECRTY                  YES,RETRY CHAN PROG  L5 @ZA02841 24292000
         CLI   CCWCMD(CCWREG),CCWEWA    ER/WRT ALTERNATE?   E12 ZA25921 24292901
         BE    RECRTY                   YES RETRY CHA PROG  E12 ZA25921 24293501
*  ONE LINE DELETED AND NINETEEN MOVED HERE BY APAR-------->   @ZA15403 24294800
UNREC1   EQU   *                                                        24295000
         OI    IOSFLB,IOSLOG            INDICATE OBR LOGOUT             24295200
SNOEXIT  EQU   *                                                        24295400
         NI    IOBERRCT+ONE,N255-HEX04   RESET APPENDAGE CORRECTABLE    24295600
SETPER   EQU   *                                                        24295800
         NI    IOSFLA,N255-IOSERR       INDICATE PER IN IOSB FLAGS      24296000
         NI    IOBFLAG1,N255-IOBERRTN     ALSO IN IOB                   24296200
CHKSTAT  EQU   *                                                        24296400
         MVI   EWACNTR1,ZERO            CLEAR RETRY COUNT               24296600
         TM    IOSFLB,IOSLOG            OBR LOGOUT REQUIRED             24296800
         BO    STATEXIT                 IF YES-EXIT TO STAT UPDATE      24297000
         CLI   EWASTUP,ZERO            CHECK FOR SINGLE BIT ENTRIES     24297200
         BNE   STATEXIT                 IF PRESENT, EXIT TO STAT UPDATE 24297400
CHKMULTI EQU   *                                                        24297600
         CLI   EWASTUP+ONE,ZERO         CHECK FOR MULTI BIT ENTRIES     24297800
         BE    RETEXIT                  IF NONE, STAT UPDATE NOT REQD   24298000
STATEXIT EQU   *                                                        24298200
         LA    LDNAMREG,STATUP          ADDRESS OF STAT UPDATE ROUTINE  24298400
         B     XCTLEXIT                 EXIT VIA XCTL BRANCH ENTRY      24298600
CHKWRCMD EQU   *                                                        24300002
         LA    CMDREG,CCWWRT            WRITE CMD                       24350002
         BAL   LNKREG,CHKCMD            LINK TO CHK CHAN PGM            24400002
         B     BRTAB5(IXREG)            RETURN BRANCH TABLE             24450002
BRTAB5   EQU   *                                                        24500002
         B     UNREC1                   WRT IN CHAN PGM-EXIT            24550002
         CLI   IOSSNS,SENDC            DATA CHECK                       24560002
         BE    SETDC                 YES, SET DATA CHK ERR     @ZA15403 24570000
         OI    EWASTUP,SENCC           NO, SET CC FOR STAT UPDATE       24580002
         B     RTYCNT                   RETRY CHAN PGM                  24600002
*   THREE LINES DELETED BY APAR----------------------------->  @ZA15403 24610000
*                                                                       24642002
RECRTY   EQU   *                                                        24644002
         CLI   IOSSNS,SENDC            DATA CHECK                       24646002
         BE    SETDC                   YES, SET ERROR                   24648002
         CLI   IOSSNS,SENCC            CTRL CHK                         24648402
         BE    SETCC                   YES, SET CC                      24648802
         OI    EWASTUP+ONE,STDCUS      SET DC, US FOR STAT UPDATE       24649602
         B     RTYCNT                  RETRY CHANNEL PROG               24649702
*                                                                       24649802
SETDC    EQU   *                                                        24649902
         OI    EWASTUP,STATDC          SET DC FOR STAT UPDATE  @YA01061 24666602
         B     RTYCNT                  RETRY CHAN PROG                  24676602
*                                                                       24678602
SETCC    EQU   *                                                        24680602
         OI    EWASTUP,SENCC           SET CC FOR STAT UPDATE           24682602
         B     RTYCNT                  RETRY                            24683002
*                                                                       24683102
RDERR    EQU   *                                                        24683302
         CLI   CCWCMD(CCWREG),CCWRDM    READ MODIFIED                   24700002
         BE    UNREC1                   YES-EXIT WITH ERROR             24750002
         CLI   CCWCMD(CCWREG),CCWRDB    READ BUFFER                     24800002
         BE    UNREC1                   YES-EXIT WITH ERROR             24850002
         B     UNREC1                   EXIT                   @YA03250 24900000
ANALUEX  EQU   *                                                        24950002
         BAL   LNKREGB,CHKDIAG          CHECK FOR DIAG CMD              25000002
         B     BRTAB4(IXREG)            DIAG CHK RTN BR TBL             25050002
BRTAB4   EQU   *                                                        25100002
         B     PERMEXIT                 DIAG CMD-PER ERR EXIT           25150002
*  THREE LINES MOVED HERE BY APAR-------------------------->   @ZA15403 25160000
         L     PARMREG,IOSRST      REAL ADDRESS OF FIRST CCW   @YM2594K 25170000
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDRESS OF REAL @YM2594K 25180000
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG        @YM2594K 25190000
         TM    IOSTSA,CSWCDE            CHANNEL END AND DEVICE END      25200002
         BO    CKCECMDS                 YES-CHECK FIRST CMD ON CE/DE    25250002
         TM    IOSTSA,CSWDVE            DEVICE END ALONE                25300002
         BNO   SNOEXIT                  EXIT                            25350002
*  ONE LINE DELETED AND SEVEN MOVED HERE BY APAR------------>  @ZA15403 25360000
CKDECMDS EQU   *                                                        25850002
*    THREE LINES DELETED BY APAR--------------------------->   @ZA15403 25855000
         CLI   CCWCMD(CCWREG),CCWSEL    SELECT                          25950002
         BE    UERETRY                  YES                             26000002
         CLI   CCWCMD(CCWREG),CCWEUP    ERASE UNPROTECTED               26100002
         BE    UERETRY                  YES                             26150002
         B     SNOEXIT                  EXIT                            26250002
CKCECMDS EQU   *                                                        26255000
         CLI   CCWCMD(CCWREG),CCWSNS    SENSE                           26260000
         BE    SNOEXIT                  EXIT                            26265000
         CLI   CCWCMD(CCWREG),CCWNOP    NO-OP                           26270000
         BE    SNOEXIT                  EXIT                            26275000
UERETRY  EQU   *                                                        26280000
         OI    IOBERRCT+ONE,UEXRETRY    UNIT EXCEPTION RETRIED          26285000
*                                      ONE LINE DELETED        @YA02483 26290000
         B     RETEXIT                  EXIT TO RETRY                   26295000
ANALDERR EQU   *                                                        26300002
         BAL   LNKREGB,CHKDIAG          CHECK FOR DIAG CMD              26350002
         B     BRTABLE1(IXREG)          DIAG CMD RTN BR TBL             26400002
BRTABLE1 EQU   *                                                        26450002
         B     PERMEXIT                 DIAG CMD-PER ERR EXIT           26500002
         LA    IXREG,4            SET NOSELECT RETRY           @YA02456 26510002
         SR    CCWREG,CCWREG      GET FAILING CCW ADDRESS      @ZA15403 26520000
         ICM   CCWREG,M7,IOSCSWCA WITH ERROR FLAGS CLEAR       @ZA15403 26530000
         SH    CCWREG,CONEIGHT    BACK UP ONE CCW              @YA02456 26540002
         BNP   ANDERCNT           IF NOT VALID ADDRESS,        @YA02456 26542002
*                                 GO CHECK LAST CCW            @YA02456 26544002
         L     PARMREG,IOSRST      REAL ADDRESS OF FIRST CCW   @YM2594K 26544402
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDRESS OF REAL @YM2594K 26544802
         LA    WKREG1,ZERO(PARMREG)    INTO CORRECT REG        @YM2594K 26545202
         CR    CCWREG,WKREG1      FAILING IS FIRST?            @YA02456 26548402
         BNE   ANDERCNT           NO,CHECK LAST                @YA02456 26548802
         CLI   CCWCMD(CCWREG),CCWSEL FAIL ON SELECT?           @YA02456 26549202
         BNE   ANDERCNT           NO,CHECK LAST                @YA02456 26549602
         LA    IXREG,0            SET RETRY SELSCT             @YA02456 26549702
ANDERCNT EQU   *                  RETRY SELECT ARGUMENT SET    @YA02456 26549802
*              2 LINES DELETED                                 @YM5690K 26550000
         CLI   IOSSNS,SENIR    INTV REQ WITH DE UC STATUS IS   @ZA06396 26580000
         BE    IRMSG                   ASYNC ERROR - RETRY     @ZA06396 26610000
         CLI   IOSSNS,SNIRECUS          IR,EQUIP CHK,UNIT SP            26650002
         BE    CHKEC(IXREG)             YES-CHECK CHAN PGM     @YA02456 26700002
         CLI   IOSSNS,SENECUS           EQUIP CHK,UNIT SP               26750002
         BE    CHKEC(IXREG)             YES-CHECK CHAN PGM     @YA02456 26800002
         CLI   IOSSNS,SENDC             DATA CHECK                      26850002
         BE    ANALCMD(IXREG)           YES-CHECK CHAN PGM     @YA02456 26900002
         CLI   IOSSNS,SENCC             CONTROL CHECK                   26950002
         BE    ANALCMD(IXREG)           YES-CHECK CHAN PGM     @YA02456 27000002
         CLI   IOSSNS,SENDCUS           DATA CHK,UNIT SPECIFY           27050002
         BE    ANALCMD(IXREG)           YES-CHECK CHAN PGM     @YA02456 27100002
         B     UNREC1                   EXIT                   @YA03250 27150000
*              22 LINES MOVED TO NEAR LINE 314465 OR DELETED   @YM5690K 27200000
CHKEC    EQU   *                                                        27900002
         B     RECRTY1            RETRY THE SELECT             @YA02456 27910002
         BAL   LNKREG,CMDSRCH           FIND LAST COMMAND               27950002
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           28050002
         BE    PERMEXIT                 YES-PER ERROR EXIT              28100002
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     28150002
         BE    PERMEXIT                 YES PER ERROR EXIT  E12 ZA25921 28160001
         CLI   CCWCMD(CCWREG),CCWEWA     ER/WRT ALTERNATE?  E12 ZA25921 28170001
*     TWO LINES REDUCED TO ONE AND SIXTEEN MOVED HERE BY APAR  @ZA15403 28200000
         BNE   UNREC1                   NO, EXIT WITH ERROR    @ZA15403 28207000
PERMEXIT EQU   *                                                        28214000
         OI    IOSFLB,IOSLOG            INDICATE OBR LOGOUT    @YA02128 28221000
PERMNOBR DS    0H                                              @YA02128 28228000
         TM    SRTESTAT,UCBONLI+UCBSYSR   DEV. AN ONLINE ACTIVE CONSOLE 28235000
         BO    UNREC1                   IF YES-LOG WITHOUT ERROR MSG    28242000
         NI    IOBERRCT+ONE,N255-HEX04   RESET USER CORRECTABLE         28249000
         MVI   EWACNTR1,ZERO            CLEAR RETRY COUNT               28256000
*              1 LINE MOVED                                    @YA02128 28263000
         NI    IOSFLA,N255-IOSERR       INDICATE PER IN IOSB FLAGS      28270000
         NI    IOBFLAG1,N255-IOBERRTN      ALSO IN IOB                  28277000
         OI    IOSFLB,IOSMSG            PERM ERROR MSG REQUIRED         28284000
WTOEXIT  EQU   *                                                        28291000
         LA    LDNAMREG,IOSWTO          ADDRESS OF IOS WTO ROUTINE      28298000
XCTLEXIT EQU   *                                                        28305000
         LR    PARMREG,IOSBREG     RESTORE REG 1 TO IOSB ADDR  @YM2594K 28312000
         L     RETREG,CVTXTLER          POINT TO BRANCH ENTRY           28319000
         BR    RETREG                   EXIT VIA XCTL BRANCH ENTRY      28326000
ANALCMD  EQU   *                                                        28350002
         B     RECRTY1            RETRY THE SELECT             @YA02456 28360002
         BAL   LNKREG,CMDSRCH           FIND LAST COMMAND               28400002
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           28500002
         BE    UNREC1                   YES-EXIT WITH ERROR             28550002
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     28600002
         BE    RECRTY1                  YES-RETRY                       28650002
         CLI   CCWCMD(CCWREG),CCWEWA   ER/WRT ALTERNATE?    E12 ZA25921 28680001
         BE    RECRTY1                 YES RETRY            E12 ZA25921 28690001
         CLI   CCWCMD(CCWREG),CCWSEL    SELECT                          28750002
         BE    CHKRTY                   YES-CHECK FOR RETRY             28800002
         CLI   CCWCMD(CCWREG),CCWEUP    ERASE UNPROTECTED               28850002
         BNE   UNREC1                   NO, EXIT               @YA03250 28900000
CHKRTY   EQU   *                                                        29000002
         CLI   IOSSNS,SENDCUS           DATA CHK,UNIT SPECIFY           29050002
         BE    UNREC1                   YES-EXIT WITH ERROR             29100002
RECRTY1  EQU   *                                                        29110002
         CLI   IOSSNS,SENDC            DATA CHECK?                      29120002
         BE    SETDC1                  YES,SET ERROR                    29130002
         CLI   IOSSNS,SENCC            CTRL CHK?                        29140002
         BE    SETCC1                  YES, SET CC                      29142002
         OI    EWASTUP+ONE,STDCUS      SET DC, US FOR STAT UPDATE       29144002
*     ONE LINE DELETED AND FOUR MOVED HERE BY APAR------->     @ZA15403 29150000
STORCCW  EQU   *                                                        29152000
         LRA   CCWREG,ZERO(CCWREG)      GET REAL ADDRESS FOR IOS        29154000
         ST    CCWREG,IOSRST            RETRY CCW ADDR                  29156000
         B     RTYCNT                                                   29158000
*                                                                       29160002
SETDC1   EQU   *                                                        29170002
         OI    EWASTUP,STATDC          SET DC FOR STAT UPDATE  @YA01061 29180002
         B     STORCCW                 RETRY CCW ADDR                   29190002
*                                                                       29192002
SETCC1   EQU   *                                                        29194002
         OI    EWASTUP,SENCC           SET CC FOR STAT UPDATE           29196002
         B     STORCCW                 RETRY CCW ADDR                   29198002
CDCERR   EQU   *                                                        29700002
         L     CCWREG,IOSCC             ADDR OF CCW                     29750002
         LA    CCWREG,ZERO(CCWREG)      CLEAR HI BYTE                   29800002
         SH    CCWREG,CONEIGHT          FAILING CCW ADDR                29850002
         BNP   UNREC1              BRANCH IF ADDRESS WAS ZERO  @YA03250 29950000
         TM    CCWCMD(CCWREG),CCWX07    TIC COMMAND                     30000002
         BNZ   CDCNTIC                 CAN NOT BE A TIC        @YA01064 30010002
         TM    CCWCMD(CCWREG),CCWTIC   TIC BIT PRESENT         @YA01064 30020002
         BO    UNREC1                   YES-UNREC EXIT         @YA01064 30050002
CDCNTIC  DS    0H                                              @YA01064 30100002
         CLI   CCWCMD(CCWREG),CCWWRT    WRITE                           30150002
         BE    UNREC1                   YES-UNREC EXIT                  30200002
         CLI   CCWCMD(CCWREG),CCWEWR    ERASE WRITE                     30250002
         BE    CHKCHAIN                 YES-CHECK CHAINING              30300002
         CLI   CCWCMD(CCWREG),CCWEWA    ER/WRT ALTERNATE?   E12 ZA25921 30330001
         BE    CHKCHAIN                 YES CHECK CHAINING  E12 ZA25921 30340001
         CLI   CCWCMD(CCWREG),CCWRDM    READ MODIFIED                   30400002
         BE    CHKWRTCM                 YES-CHECK CHAN PGM FOR WRITE    30450002
         CLI   CCWCMD(CCWREG),CCWRDB    READ BUFFER                     30500002
         BE    CHKWRTCM                 YES-CHECK CHAN PGM FOR WRITE    30550002
RTYCCW   EQU   *                                                        30560002
         OI    EWASTUP+ONE,STCDC       SET CDC FOR STAT UPDATE          30570002
         B     STORCCW                  RETRY FAILING CMD               30600002
CHKCHAIN EQU   *                                                        30650002
         TM    IOSFLA,IOSDCHN           DATA CHAIN IN CH PGM            30700002
         BO    RTYCHPGM                 YES-RETRY CHAN PGM              30750002
         B     RTYCCW                   NO-RETRY FAILING CMD            30800002
CHKWRTCM EQU   *                                                        30850002
         LA    CMDREG,CCWWRT            ANY WRITE CMD                   30900002
         BAL   LNKREG,CHKCMD            LINK TO CHK CHAN PGM            30950002
         B     BRTABLE3(IXREG)          RETURN BRANCH TABLE             31000002
BRTABLE3 EQU   *                                                        31050002
         B     UNREC1                   WRT IN CHAN PGM-EXIT            31100002
RTYCHPGM EQU   *                                                        31110002
         OI    EWASTUP+ONE,STCDC       SET CDC FOR STAT UPDATE          31120002
         B     RTYCNT                   RETRY CHAN PGM                  31150002
         SPACE 3                                                        31352002
*                                                           LD @ZA02809 31354002
ANALCHAN EQU   *                                                        31354600
         BAL   LNKREGB,CHKDIAG          CHECK FOR DIAG CMD              31355200
         B     BRTABLE2(IXREG)          DIAG CMD RTN BR TBL             31356000
BRTABLE2 EQU   *                                                        31356500
         B     PERMEXIT                 DIAG CMD-PER ERR EXIT           31357000
         TM    IOSTSB,CSWCDC            CHANNEL DATA CHECK              31357500
         BO    CDCERR                   YES-CHECK FOR RETRY             31358000
         TM    IOSTSB,CSWCCC+CSWICC     CCC OR ICC                      31358400
         BZ    SNOEXIT                  NO, EXIT                        31358800
         TM    CVTOPTA,CVTCCH      CCH IN SYSTEM            LD @ZA02809 31359200
*   TWO LINES REDUCED TO ONE AND TWELVE MOVED HERE BY APAR-->  @ZA15403 31359700
         BNO   PERMEXIT                  NO-PER ERR EXIT       @ZA15403 31359900
*                                                           LD @ZA02809 31360000
*              PROCESS CHANNEL ERRORS (ICC AND CCC)         LD @ZA02809 31360100
*                                                           LD @ZA02809 31360200
*                                                           LD @ZA02809 31360300
CHKCHAN  EQU   *                                            LD @ZA02809 31360400
         MVC   ERPIBTRM(ONE),EWAXCSW2  MOVE TRM CODE        LD @ZA02809 31360500
         NI    ERPIBTRM,EWACTEC    CLEAR UNWANTED BITS      LD @ZA02809 31360600
         MVC   ERPIBSEQ(ONE),EWAXCSW2  MOVE SEQ CODE        LD @ZA02809 31360700
         NI    ERPIBSEQ,EWACSEQ    CLEAR UNWANTED BITS      LD @ZA02809 31360800
         TM    EWARGFG1,EWANORTY   CAN RETRY BE DONE        LD @ZA02809 31361702
         BO    UNREC1              NO, UNREC                LD @ZA02809 31362102
         TM    EWAXCSW1,EWACSQV+EWACCHV  SEQ CODE AND...    LD @ZA02809*31362502
                                   ...CHAN ADDR VALID ?     LD @ZA02809 31362902
         BNO   UNREC1              NO, UNREC                LD @ZA02809 31363302
         TM    EWARGFG1,EWACTIO+EWACHIO  HALT I/O OR...     LD @ZA02809*31363402
                                   ...TEST I/O ?            LD @ZA02809 31363502
         BM    UNREC1              YES, UNREC               LD @ZA02809 31363602
         TM    EWARGFG1,EWACSIO    START I/O ?              LD @ZA02809 31363702
         BZ    TSTRESET            NO, BRANCH               LD @ZA02809 31363802
         TM    EWAXCSW1,EWACDAV    DEVICE ADDR VALID ?      LD @ZA02809 31363902
         BNO   UNREC1              NO, UNREC                LD @ZA02809 31364002
TSTRESET EQU   *                                            LD @ZA02809 31364102
         CLI   ERPIBTRM,EWATER3    SYSTEM ERROR ?           LD @ZA02809 31364202
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31364302
         CLI   ERPIBSEQ,EWASEQ0    SEQ CODE 0 ?             LD @ZA02809 31364402
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31364502
         CLI   ERPIBSEQ,EWASEQ6    SEQ CODE 6 ?             LD @ZA02809 31364602
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31364702
         CLI   ERPIBSEQ,EWASEQ7    SEQ CODE 7 ?             LD @ZA02809 31364802
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31364902
         TM    IOSCC,IOSCC3        SIO COND CODE 3 ?        LD @ZA02809 31365002
         BO    UNREC1              YES, UNREC               LD @ZA02809 31365102
         TM    IOSCC,IOSCC1        SIO COND CODE 1 ?        LD @ZA02809 31365302
         BNO   CKCMDVAL            NO, BRANCH               LD @ZA02809 31365702
         L     PARMREG,IOSRST      REAL ADDR OF CCW         LD @ZA02809 31366102
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDR OF REAL LD @ZA02809 31366502
         LA    CCWREG,ZERO(PARMREG)  INTO CORRECT REG       LD @ZA02809 31366902
         B     SEQ5CHK             BRANCH                   LD @ZA02809 31367002
CKCMDVAL EQU   *                                            LD @ZA02809 31367102
         TM    EWAXCSW1,EWACCMD    CMD ADDR VALID ?         LD @ZA02809 31369002
         BNO   UNREC1              NO, UNREC                LD @ZA02809 31369402
         BAL   LNKREG,GETCMD       GET ADDR OF...           LD @ZA02809*31371402
                                   ...FAILING CCW           LD @ZA02809 31371802
SEQ5CHK  EQU   *                                            LD @ZA02809 31372202
         CLI   ERPIBSEQ,EWASEQ5    SEQ CODE 5 ?             LD @ZA02809 31372302
         BE    SEQ5PROC            YES, HANDLE              LD @ZA02809 31372402
         CLI   ERPIBSEQ,EWASEQ4    SEQ CODE 4 ?             LD @ZA02809 31372502
         BE    SEQ4PROC            YES, HANDLE              LD @ZA02809 31372902
         CLI   ERPIBSEQ,EWASEQ3    SEQ CODE 3 ?             LD @ZA02809 31373302
         BE    SEQ3PROC            YES, HANDLE              LD @ZA02809 31373702
         CLI   ZERO(CCWREG),CCWTIC CMD A TIC ?              LD @ZA02809 31373802
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31373902
         CLI   ERPIBSEQ,EWASEQ2    SEQ CODE 2 ?             LD @ZA02809 31374302
         BE    SEQ2PROC            YES,HANDLE               LD @ZA02809 31374702
SEQ1PROC EQU   *                                            LD @ZA02809 31375102
         CLI   ERPIBTRM,EWATER2    SELECTIVE RESET          LD @ZA02809 31375202
         BE    CONDRTRY            YES, MAY BE RETRIED      LD @ZA02809 31375302
SEQ1TRM1 EQU   *                                            LD @ZA02809 31375702
         CLI   ERPIBTRM,EWATER3-EWATER2  NORMAL TERMINATION LD @ZA02809 31376102
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31376502
         B     RETRY               NO, RETRY                LD @ZA02809 31376602
SEQ2PROC EQU   *                                            LD @ZA02809 31376702
         CLI   ERPIBTRM,EWATER2    SELECTIVE RESET          LD @ZA02809 31378502
         BE    RETRY               YES, RETRY               LD @ZA02809 31378902
         B     SEQ1TRM1            NO, BRANCH               LD @ZA02809 31379302
SEQ3PROC EQU   *                                            LD @ZA02809 31379702
         CLI   ZERO(CCWREG),CCWSEL SELECT CMD ?             LD @ZA02809 31380102
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31380202
         CLI   ZERO(CCWREG),CCWEUP ERASE ALL UNPROCTECTED ? LD @ZA02809 31380602
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31381002
         CLI   ZERO(CCWREG),CCWNOP NO-OP ?                  LD @ZA02809 31381402
         BE    SNOEXIT             YES, SNO                 LD @ZA02809 31381502
         B     RETRY               NO, RETRY                LD @ZA02809 31381602
SEQ4PROC EQU   *                                            LD @ZA02809 31381702
         CLI   ERPIBTRM,EWATER2    SELECTIVE RESET          LD @ZA02809 31381802
         BE    CONDRTRY            YES, MAY BE RETRIED      LD @ZA02809 31381902
RETRY    EQU   *                                            LD @ZA02809 31382002
         CLI   ZERO(CCWREG),CCWWRT WRITE CMD ?              LD @ZA02809 31382102
         BNE   RTYERR              NO, BRANCH               LD @ZA02809 31382502
         L     PARMREG,ZERO(CCWREG)    GET REAL DATA ADDR   L5 @ZA03552 31382900
         BAL   ICREG,TRANSRTV          GET VIRT DATA ADDR   L5 @ZA03552 31383000
         LA    ICREG,ZERO(PARMREG)     INTO CORRECT REG     L5 @ZA03552 31383100
         CLI   SBABYTE(ICREG),SBA  2ND BYTE AN SBA ?        LD @ZA02809 31383302
         BNE   UNREC1              NO, UNREC                LD @ZA02809 31383402
RTYERR   EQU   *                                            LD @ZA02809 31383802
         LRA   CCWREG,ZERO(CCWREG) SET REAL ADDR FOR IOS    LD @ZA02809 31384102
         ST    CCWREG,IOSRST       POINT TO FAILING CMD     LD @ZA02809 31384502
         B     RTYCNT              GO RETRY                 LD @ZA02809 31384902
CONDRTRY EQU   *                                            LD @ZA02809 31385002
         L     PARMREG,IOSRST      REAL ADDR OF 1ST CCW     LD @ZA02809 31385102
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDR OF REAL LD @ZA02809 31385502
         LA    ICREG,ZERO(PARMREG)  INTO CORRECT REG        LD @ZA02809 31385902
         CR    ICREG,CCWREG        IS FAILING CMD 1ST...    LD @ZA02809*31386302
                                   ...IN STRING ?           LD @ZA02809 31386802
         BE    UNREC1              YES, UNREC               LD @ZA02809 31387202
         B     RETRY               GO RETRY                 LD @ZA02809 31387602
SEQ5PROC EQU   *                                            LD @ZA02809 31387702
         TM    EWARGFG1,EWACSIO    CSW STORE AFTER SIO ?    LD @ZA02809 31387802
         BO    SEQ3PROC            YES, HANDLE AS SEQ 3     LD @ZA02809 31387902
         B     RETRY               NO, RETRY                LD @ZA02809 31388102
         SPACE 3                                                        31388502
*********************************************************************** 31388602
*                                                                     * 31389002
*                  GETCMD SUBROUTINE                                  * 31389402
*                                                                     * 31390002
*        THIS SUBROUTINE STORES THE ADDR OF FAILING                   * 31390102
*        COMMAND IN CCWREG, IF THE FAILING CCW HAS DATA               * 31390202
*        CHAINIG ON, THIS ROUTINE BACKS UP THE ADDR TO                * 31390602
*        THE 1ST CCW IN THE STRING WITH DATA CHAINING.                * 31390702
*        IF THE FAILING CCW IS A TIC, THE ADDRESS OS THE              * 31390802
*        CCW TIC'ED TO IS USED.                                       * 31390902
*        NOTE: IF THE CSW ADDRESS IS ZERO AND DEVICE END,             * 31391302
*        THE FAILING CCW IS THE LAST IN THE CHAIN.                    * 31392002
*                                                                     * 31392802
*********************************************************************** 31393402
         SPACE 2                                                        31393502
GETCMD   EQU   *                                            LD @ZA02809 31393802
         SR    ICREG,ICREG         GET CCW ADDR FR CSW WITH    @ZA15403 31395200
         ICM   ICREG,M7,IOSCSWCA   HIGH BYTE CLEAR             @ZA15403 31395300
         LTR   ICREG,ICREG         IS ADDR ZERO ?           LD @ZA02809 31395402
         BZ    CHKDE               YES,SEE IF DE WITHOUT CE LD @ZA02809 31395502
         SH    ICREG,CONEIGHT      NO, BACK UP TO...        LD @ZA02809*31395602
                                   ...FAILING CCW.          LD @ZA02809 31395702
         BNP   SNOEXIT             IF BAD, GET OUT          LD @ZA02809 31395802
         B     GETSTART            GO TO GET CPA ADDR       LD @ZA02809 31395902
CHKDE    EQU   *                                            LD @ZA02809 31396002
         TM    IOSTSA,CSWCHE       IS CHAN END ON ?         LD @ZA02809 31396100
         BO    SNOEXIT             ADDR SHOULD NOT BE ZERO  LD @ZA02809 31396302
         TM    IOSTSA,CSWDVE       IS DVC END ON ?          LD @ZA02809 31396702
         BNO   SNOEXIT             NO, SHOULDN'T OCCUR.     LD @ZA02809 31396802
GETSTART EQU   *                                            LD @ZA02809 31396902
         LR    WKREG1,ICREG        SAVE CCW ADDR            LD @ZA02809 31397002
         L     PARMREG,IOSRST      SET PARM FOR TRANSLATION LD @ZA02809 31397100
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDR OF REAL LD @ZA02809 31397202
         LA    CCWREG,ZERO(PARMREG)  INTO CORRECT REG.      LD @ZA02809 31397302
         LR    ICREG,WKREG1        RESTORE CCW ADDRESS      LD @ZA02809 31397702
         LR    WKREG1,CCWREG                                LD @ZA02809 31398102
CHNLOOP  EQU   *                                            LD @ZA02809 31398202
         CR    WKREG1,ICREG        IS THIS THE FAILING CCW  LD @ZA02809 31398602
         BE    FOUNDCMD            YES, BRANCH              LD @ZA02809 31398702
         CLI   CCWCMD(WKREG1),CCWTIC  IS THIS CCW A TIC ?   LD @ZA02809 31398802
         BE    TICRTN              YES, HANDLE              LD @ZA02809 31398902
         TM    CCWFLGS(WKREG1),CCWCD IS THIS CCW DATA CHN'D LD @ZA02809 31400002
         BNO   TSTCMDCH            NO,CONTINUE CHECKING     LD @ZA02809 31402402
         AH    WKREG1,CONEIGHT     UP FAILING CCW ADDR      LD @ZA02809 31402802
         B     CHNLOOP             CHECK NEXT CCW           LD @ZA02809 31403202
TSTCMDCH EQU   *                                            LD @ZA02809 31403302
         TM    CCWFLGS(WKREG1),CCWCC IS THIS CCW CMD CHN'D  LD @ZA02809 31403402
         BNO   SEEIFDE             NO, END OF CHAN PGM      LD @ZA02809 31403500
         AH    WKREG1,CONEIGHT     UPDATE FAILING CCW...    LD @ZA02809*31403600
                                   ...ADDR AND              LD @ZA02809 31404102
         LR    CCWREG,WKREG1       RESTART ADDR             LD @ZA02809 31404502
         B     CHNLOOP             CHECK NEXT CCW           LD @ZA02809 31404902
SEEIFDE  EQU   *                                            LD @ZA02809 31405002
         LTR   ICREG,ICREG         IS CSW ADDR ZERO ?       LD @ZA02809 31405102
         BNZ   SNOEXIT             NO, SHOULD HAVE FOUND... LD @ZA02809*31405402
                                   ...FAILING CCW.          LD @ZA02809 31405802
         B     FOUNDCMD            YES, FOUND               LD @ZA02809 31406202
TICRTN   EQU   *                                            LD @ZA02809 31406302
         SH    WKREG1,CONEIGHT     BACK UP TO PREV. CCW     LD @ZA02809 31406402
         TM    CCWFLGS(WKREG1),CCWCD  IS IT DATA CHN'D ?    LD @ZA02809 31406502
         BO    TICTOADR            YES, BRANCH              LD @ZA02809 31406602
         LR    WKREG7,ICREG             SAVE ICREG          L5 @ZA03552 31406700
         L     PARMREG,ZERO(CCWREG)   GET REAL TICD TO ADDR L5 @ZA03552 31407400
         BAL   ICREG,TRANSRTV          GET VIRT TICD ADDR   L5 @ZA03552 31408100
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG     L5 @ZA03552 31410100
         LR    ICREG,WKREG7            RESTORE ICREG        L5 @ZA03552 31412100
TICTOADR EQU   *                                            LD @ZA02809 31413202
         AH    WKREG1,CONEIGHT     GET FAILING TIC ADDR     LD @ZA02809 31413902
         LR    WKREG7,ICREG            SAVE ICREG           L5 @ZA03552 31414600
         L     PARMREG,ZERO(WKREG1)   GET REAL TICD TO ADDR L5 @ZA03552 31415300
         BAL   ICREG,TRANSRTV         GET VIRT TICD TO ADDR L5 @ZA03552 31416000
         LA    WKREG1,ZERO(PARMREG)    INTO CORRECT REG     L5 @ZA03552 31416400
         LR    ICREG,WKREG7            RESTORE ICREG        L5 @ZA03552 31416500
         B     CHNLOOP             CONTINUE                 LD @ZA02809 31416702
FOUNDCMD EQU   *                                            LD @ZA02809 31417402
         CLI   ZERO(WKREG1),CCWTIC IS RESTART CCW A TIC ?   LD @ZA02809 31418102
         BNE   CMDOUT              NO, RETURN               LD @ZA02809 31418802
         SH    WKREG1,CONEIGHT     BACK UP TO PREV. CCW     LD @ZA02809 31419502
         TM    CCWFLGS(WKREG1),CCWCD  DATA CHAINED ?        LD @ZA02809 31420202
         BO    CMDOUT              YES,RETURN               LD @ZA02809 31420902
         L     PARMREG,EIGHT(WKREG1)  GET REAL TICD TO ADDR L5 @ZA03552 31421600
         BAL   ICREG,TRANSRTV         GET VIRT TICD TO ADDR L5 @ZA03552 31422300
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG     L5 @ZA03552 31423000
CMDOUT   EQU   *                                            LD @ZA02809 31423702
         BR    LNKREG              RETURN TO CALLER         LD @ZA02809 31424402
         EJECT                                                          31521900
*********************************************************************** 31522700
*              CHKDIAG SUBROUTINE                                     * 31526600
*        THIS  SUBROUTINE PLACES A DIAGNOSTIC WRITE / DIAGNOSTIC READ * 31538302
*        COMMAND CODE IN CMDREG AND LINKS TO THE CHKCMD SUBRTN. THE   * 31550002
*        CHKCMD SUBRTN CHECKS IF EITHER COMMAND IS CONTAINED IN THE   * 31600002
*        CHANNEL PROGRAM.THE RETURN CODE RETURNED BY THE CHKCMD SUBRTN* 31650002
*        IS PASSED BACK TO THE CALLER.                                * 31700002
*********************************************************************** 31750002
CHKDIAG  EQU   *                                                        31800002
         LA    CMDREG,CCWDWR            DIAG WRITE CMD                  31850002
         BAL   LNKREG,CHKCMD            LINK TO CHECK CMD               31900002
         B     BRTABD(IXREG)            RETURN BRANCH TABLE             31950002
BRTABD   EQU   *                                                        32000002
         BR    LNKREGB                  DWR FOUND-RETURN                32050002
         NOPR  TEMPREG                  PAD FOR RET CODE INDEX          32100002
         LA    CMDREG,CCWDRD            DIAG READ CMD                   32150002
         BAL   LNKREG,CHKCMD            LINK TO CHECK CMD               32200002
         BR    LNKREGB                  RETURN WITH RET CODE            32250002
         SPACE 3                                                        32260000
*********************************************************************** 32300002
*              CHKCMD SUBROUTINE                                      * 32350002
*        THIS SUBROUTINE COMPARES THE COMMAND CODE OF EACH CCW IN A   * 32400002
*        CHANNEL PROGRAM TO THE COMMAND CODE CONTAINED IN CMDREG.     * 32450002
*        IF THE COMMAND IS FOUND,A RETURN CODE OF ZERO IS PLACED IN   * 32500002
*        IXREG. IF IT IS NOT FOUND,THE RETURN CODE IS FOUR.           * 32550002
*********************************************************************** 32600002
CHKCMD   EQU   *                                                        32650002
         L     PARMREG,IOSRST      REAL ADDRESS OF FIRST CCW   @YM2594K 32660002
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDRESS OF REAL @YM2594K 32670002
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG        @YM2594K 32680002
         SR    IXREG,IXREG              CLEAR FOR CMD          @YM2594K 32750002
CMDLOOP  EQU   *                                                        32800002
         IC    IXREG,CCWCMD(CCWREG)     PICK UP COMMAND        @YM2594K 32850002
         CLR   CMDREG,IXREG             CHECK FOR COMMAND      @YM2594K 32900002
         BE    SETCFND                  YES-SET COMMAND FOUND RET CODE  32950002
         CLI   CCWCMD(CCWREG),CCWTIC   IS IT TIC?           L5 @ZA02841 33000000
         BE    ADJADR1                 YES                  L5 @ZA02841 33050000
CMDNOTIC EQU   *                                                        33200002
         TM    CCWFLGS(CCWREG),CCWCC+CCWCD CHAINING INDICATED           33250002
         BZ    SETCNFND                 NO-SET CMD NOT FOUND RET CODE   33300002
         LA    CCWREG,EIGHT(CCWREG)     YES-INCR TO NEXT CCW            33350002
         CLM   CCWREG,SEVEN,IOSCSWCA   IS NXT CCW FAIL CCW? L5 @ZA02841 33360000
*  TWO LINES REDUCED TO ONE AND THREE MOVED HERE BY APAR-->    @ZA15403 33370000
         BNE   CMDLOOP                 NO  CONTINUE CHECKING   @ZA15403 33380000
SETCNFND EQU   *                                                        33390000
         LA    IXREG,FOUR               SET CMD NOT FOUND RC            33400000
         BR    LNKREG                   RETURN TO CALLER                33410000
ADJADR1  EQU   *                                                        33450002
         L     PARMREG,ZERO(CCWREG)     PICK UP NEXT CCW ADDR  @YM2594K 33500002
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDRESS OF REAL @YM2594K 33520002
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG        @YM2594K 33530002
         B     CMDLOOP                  CONTINUE TO CHECK COMMAND       33550002
SETCFND  EQU   *                                                        33750002
         LA    IXREG,ZERO               SET CMD FOUND RC                33800002
         BR    LNKREG                   RETURN TO CALLER                33850002
         SPACE 3                                                        33860000
*********************************************************************** 33900002
*              CMDSRCH SUBROUTINE                                     * 33950002
*        THE CMDSRCH SUBROUTINE SEARCHS A CHANNEL PROGRAM,BEGINNING   * 34000002
*        WITH THE ADDRESS IN IOBSTART,TO FIND THE ADDRESS OF THE LAST * 34050002
*        COMMAND IN THE CHANNEL PROGRAM. THAT IS,THE LAST CCW THAT IS * 34100002
*        NOT A TIC AND DOES NOT HAVE THE COMMAND CHAINING FLAG ON.    * 34150002
*        WHEN CONTROL IS RETURNED TO THE CALLER,THE LAST COMMAND      * 34200002
*        ADDRESS IS IN CCWREG.                                        * 34250002
*********************************************************************** 34300002
CMDSRCH  EQU   *                                                        34350002
         L     PARMREG,IOSRST      REAL ADDRESS OF FIRST CCW   @YM2594K 34360002
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDRESS OF REAL @YM2594K 34370002
         LA    CCWREG,ZERO(PARMREG)    INTO CORRECT REG        @YM2594K 34380002
         LR    WKREG1,CCWREG            ESTABLISH WORK REG              34500002
CHKLOOP  EQU   *                                                        34550002
         TM    CCWFLGS(WKREG1),CCWCC    CMD CHAINING                    34600002
         BO    NEXTCCWA                 YES-CHECK NEXT CCW              34650002
         TM    CCWFLGS(WKREG1),CCWCD    DATA CHAINING                   34700002
         BO    NEXTCCWB                 YES-CHECK NEXT CCW              34750002
         TM    CCWCMD(WKREG1),CCWX07    LOW ORDER BITS 0'S     @YA01064 34760002
         BNZ   NOTICCMD                 BRANCH IF NOT          @YA01064 34770002
         TM    CCWCMD(WKREG1),CCWTIC    TIC COMMAND            @YA01064 34780002
         BO    ADJADR2                  YES-ADJUST ADDR        @YA01064 34790002
NOTICCMD EQU   *                                               @YA01064 34792002
         BR    LNKREG                   NO-LAST FOUND,RETURN            34900002
NEXTCCWA EQU   *                                                        34950002
         LA    WKREG1,EIGHT(WKREG1)     NEXT CCW ADDR                   35000002
         LR    CCWREG,WKREG1            MAINTAIN LAST CMD ADR           35050002
         B     CHKLOOP                  CONTINUE CHAINING CHK           35100002
NEXTCCWB EQU   *                                                        35150002
         LA    WKREG1,EIGHT(WKREG1)     NEXT CCW ADDR                   35200002
         B     CHKLOOP                  CONTINUE CHAINING CHK           35250002
ADJADR2  EQU   *                                                        35300002
         L     PARMREG,ZERO(WKREG1)      NEXT CCW ADDR         @YM2594K 35350002
         BAL   ICREG,TRANSRTV      GET VIRTUAL ADDRESS OF REAL @YM2594K 35370002
         LA    WKREG1,ZERO(PARMREG)    INTO CORRECT REG        @YM2594K 35380002
         LR    CCWREG,WKREG1            MAINTAIN LAST CMD ADR           35400002
         B     CHKLOOP                  CONTINUE CHAINING CHK           35450002
         SPACE 3                                                        35450100
*********************************************************************** 35450402
*                                                                       35452002
*              TRANSLATE REAL TO VIRTUAL SUBROUTINE                     35454002
*        HANDLES INTERFACE TO THE PAGE SUPERVISOR'S ROUTINE WHICH       35456002
*        TRANSLATES REAL ADDRESS INTO VIRTUAL ADDRESSES                 35458002
*                                                                       35458402
*        NOTE THAT THIS DESTROYS WKREG7 (REG 7) AS WELL AS THE          35458802
*        INTERFACE REGS USED GOING TO IEAPTRV AND ICREG (REG 9)         35459202
*        WHICH IS USED AS A RETURN REG.                                 35459602
*                                                                       35459702
*********************************************************************** 35462202
TRANSRTV DS    0H                     ENTER TRANSLATE ROUTINE  @YM2594K 35465002
         LA    PARMREG,ZERO(PARMREG)   CLEAR BYTE ZERO         @YM2594K 35467502
*                                                                       35469500
*              1 LINE DELETED FOR ----->                    LD @ZA02815 35471500
*                                                                       35471900
         STM   ICREG,BASREG,EWAIERP+16  SAVE REGS              @ZA11043 35473900
         SR    WKREG7,WKREG7                                   @ZA11043 35474700
         USING RQE,RQEBASE             BASE RQE                @ZA04166 35475500
         L     RQEBASE,IOSUSE          LOAD RQE BASE REG       @ZA04166 35476300
         TM    RQETYPE,RQE1TO1         DOES V EQUAL R ?        @ZA04166 35477100
         BO    TRRETRN           YES RETURN NO TRANSLATION     @ZA11043 35477900
         DROP  RQEBASE                                         @ZA04166 35478700
         L     BASREG,CVTPTRV          GET ENTRY TO TRANSLATE  @YM2594K 35480002
*                                              REAL TO VIRTUAL @YM2594K 35490002
*        GETLOCK SETLOCK OBTAIN DELETED BY APAR-------->    E12 ZA30908 35490400
         BALR  EWAREG,BASREG           GO DO TRANSLATION       @YM2594K 35492002
         LR    WKREG7,BASREG       SAVE RETURN CODE         LD @ZA02815 35492400
*                                                                       35492800
*              2 LINES DELETED FOR ----->                   LD @ZA02815 35494000
*                                                                       35494400
*        FREELOCK SETLOCK RELEASE DELETED BY APAR---------> E12 ZA30908 35496800
         USING START,BASREG                                    @ZA04166 35497200
         L     EWAREG,IOSERP           RESTORE BASE FOR EWA LD @ZA02815 35497300
TRRETRN  LM    ICREG,BASREG,EWAIERP+16  RESTORE REGS           @ZA11043 35497600
         LTR   WKREG7,WKREG7       CHECK RETURN CODE...     LD @ZA02815*35498100
                                   ...FROM CCW TRANSLATOR.  LD @ZA02815 35498200
         BNZ   UNREC1                  BRANCH ON BAD           @YA03250 35498400
*                                                TRANSLATION   @YM2594K 35498802
         BR    ICREG                   RETURN TO CALLER        @YM2594K 35499202
         EJECT                                                          35500002
**********                                                              35550002
*                                                                       35600002
*        REGISTER DEFINITIONS                                           35650002
*                                                                       35700002
**********                                                              35750002
TEMPREG  EQU   0                        SELDOM USED WORKREG             35800002
PARMREG  EQU   1                        INPUT PARAMETER REG             35850002
IOSBREG  EQU   2                        IOSB ADDRESS                    35900002
DCBREG   EQU   3                        DCB ADDRESS                     35950002
UCBREG   EQU   4                        UCB ADDRESS                     36000002
CVTREG   EQU   5                        CVT ADDRESS                     36050002
CCWREG   EQU   6                        CCW ADDRESS                     36100002
WKREG7   EQU   7                        WORK REG                        36150002
WKREG1   EQU   8                        WORK REG                        36200002
CMDREG   EQU   WKREG1                   COMMAND REG                     36250002
ICREG    EQU   9                        CHAR REG                        36300002
LNKREG   EQU   10                       LINK REG                        36350002
IXREG    EQU   11                       INDEX REG                       36400002
LNKREGB  EQU   12                       SECOND LINK REG                 36450002
LDNAMREG EQU   13                       NEXT LOAD MODULE NAME           36500002
IOBREG   EQU   LDNAMREG                 IOB BASE                        36550002
RETREG   EQU   14                       BRANCH ENTRY ADDR TO XCTL       36600002
EWAREG   EQU   RETREG                   ERP WORKAREA BASE               36650002
BASREG   EQU   15                       ERP BASE REG                    36700002
RQEBASE  EQU   ICREG                                           @ZA11043 36720000
         SPACE 2                                                        36750002
**********                                                              36800002
*                                                                       36850002
*        DEVICE TYPE FLAGS USED WITH UCBTBYT4                           36900002
*                                                                       36950002
**********                                                              37000002
DEV3277  EQU   X'09'                    3277 DEVICE                     37050002
DEV3284  EQU   X'0A'                    3284 DEVICE                     37100002
DEV3286  EQU   X'0B'                    3286 DEVICE                     37150002
DEV3158  EQU   X'0C'                    3158 DEVICE                     37200002
         SPACE 2                                                        37250002
**********                                                              37300002
*                                                                       37350002
*        CSW  FLAGS                                                     37400002
*                                                                       37450002
**********                                                              37500002
CSWATTN  EQU   X'80'                    ATTENTION           E12 ZA25738 37508000
CSWSTMOD EQU   X'40'                    STATUS MODIFIER     E12 ZA25738 37516000
CSWCUE   EQU   X'20'                    CONTROL UNIT END    E12 ZA25738 37524000
CSWBUSY  EQU   X'10'                    BUSY                E12 ZA25738 37532000
CSWSMBSY EQU   CSWSTMOD+CSWBUSY         ST. MOD. AND BUSY   E12 ZA25738 37540000
CSWCHE   EQU   X'08'                    CHANNEL END                     37550002
CSWDVE   EQU   X'04'                    DEVICE END                      37600002
CSWCDE   EQU   CSWCHE+CSWDVE            CHANNEL END AND DEVICE END      37650002
CSWUCK   EQU   X'02'                    UNIT CHECK                      37700002
CSWUEX   EQU   X'01'                    UNIT EXCEPTION                  37750002
CSWIL    EQU   X'40'                    INCORRECT LENGTH                37800002
CSWPGC   EQU   X'20'                    PROGRAM CHECK                   37850002
CSWPTC   EQU   X'10'                    PROTECTION CHECK                37900002
CSWCDC   EQU   X'08'                    CHANNEL DATA CHECK              37950002
CSWCCC   EQU   X'04'                    CHANNEL CONTROL CHECK           38000002
CSWICC   EQU   X'02'                    INTERFACE CONTROL CHECK         38050002
CSWCCK   EQU   X'01'                    CHAINING CHECK                  38100002
CATCHAN  EQU   CSWCDC+CSWCCC+CSWICC     CATASTROPHIC CHANNEL ERRORS     38150002
CATERR   EQU   CSWIL+CSWPGC+CSWPTC+CSWCCK STATUS ERRORS                 38200002
         SPACE 2                                                        38250002
**********                                                              38300002
*                                                                       38350002
*        SENSE FLAGS                                                    38400002
*                                                                       38450002
**********                                                              38500002
SENCR    EQU   X'80'                    COMMAND REJECT                  38550002
SENIR    EQU   X'40'                    INTERVENTION REQUIRED           38600002
SENBOC   EQU   X'20'                    BUS OUT CHECK                   38650002
SENEC    EQU   X'10'                    EQUIPMENT CHECK                 38700002
SENDC    EQU   X'08'                    DATA CHECK                      38750002
SENCC    EQU   X'02'                    CONTROL CHECK                   38800002
SENOC    EQU   X'01'                    OPERATION CHECK                 38850002
SENDCUS  EQU   X'0C'                  DATA CHECK,UNIT SPECIFY  @YA00844 38900002
SNIRECUS EQU   X'54'                    INT REQ,EQUIP CHK,UNIT SPECIFY  38950002
SENECUS  EQU   X'14'                    EQUIP CHECK,UNIT SPECIFY        39000002
         SPACE 2                                                        39050002
*                                                              @YA01061 39060002
*        THE FOLLOWING FLAGS ARE USED TO SET THE PROPER BITS   @YA01061 39070002
*        IN EWASTUP (INTERFACE TO STATISTICS TABLE UPDATE      @YA01061 39080002
*        ROUTINE) SO THERE WILL BE PROPER EDITING AND PRINTING @YA01061 39090002
*        WHEN IFCEREP0 PRINTS SYS1.LOGREC.                     @YA01061 39092002
*                                                              @YA01061 39094002
STATDC   EQU   X'80'                   DATA CHECK              @YA03227 39096002
STATEC   EQU   X'10'                   EQUIPMENT CHECK         @YA03227 39098002
STATBOC  EQU   X'20'                   BUS OUT CHECK           @YA03227 39098402
STATIR   EQU   X'40'                   INTERVENTION REQUIRED   @YA03227 39098802
**********                                                              39100002
*                                                                       39150002
*        STATISTICS TABLE MULTI BIT SENSE FLAGS                         39200002
*                                                                       39250002
**********                                                              39300002
STDCUS   EQU   X'10'                    DATA CHECK,UNIT SPECIFY         39350002
STCDC    EQU   X'01'                    CHANNEL DATA CHECK              39400002
STIRUS   EQU   X'08'                    INT REQ,UNIT SPECIFY            39450002
STIRECUS EQU   X'04'                    INT REQ,EQUIP CHK,UNIT SPECIFY  39500002
STECUS   EQU   X'02'                    EQUIP CHECK,UNIT SPECIFY        39550002
         SPACE 2                                                        39700002
**********                                                              39750002
*                                                                       39800002
*        CCW COMMAND CODES , DEFINITIONS AND FLAGS                      39850002
*                                                                       39900002
**********                                                              39950002
CCWCPY   EQU   X'07'                    COPY                            39960002
CCWWRT   EQU   X'01'                    WRITE                           40000002
CCWEWR   EQU   X'05'                    ERASE WRITE                     40050002
CCWRDM   EQU   X'06'                    READ MODIFIED                   40100002
CCWSNS   EQU   X'04'                    SENSE                           40150002
CCWNOP   EQU   X'03'                    NO-OP                           40200002
CCWRDB   EQU   X'02'                    READ BUFFER                     40250002
CCWDWR   EQU   X'09'                    DIAGNOSTIC WRITE                40300002
CCWDRD   EQU   X'0A'                    DIAGNOSTIC READ                 40350002
CCWSEL   EQU   X'0B'                    SELECT                          40400002
CCWEWA   EQU   X'0D'                    ER/WRT ALTERNATE    E12 ZA25921 40410001
CCWEUP   EQU   X'0F'                    ERASE ALL UNPROTECTED           40450002
CCWCC    EQU   X'40'                    COMMAND CHAINING                40500002
CCWCD    EQU   X'80'                    DATA CHAINING                   40550002
CCWTIC   EQU   X'08'                    TIC OP CODE                     40600002
CCWX07   EQU   X'07'                    TIC ISOLATER                    40650002
CCWCMD   EQU   0                        COMMAND FIELD                   40700002
CCWFLGS  EQU   4                        FLAGS FIELD                     40750002
CCWCNT   EQU   6                        COUNT FIELD                     40800002
         SPACE 2                                                        40850002
**********                                                              40900002
*                                                                       40950002
*        MISC   DEFINITIONS,FLAGS AND CONSTANTS                         41000002
*                                                                       41050002
**********                                                              41100002
FIRSTFLG EQU   X'80'                    FIRST TIME FLAG                 41110002
INTRETRY EQU   X'10'                    AEA FLAG                        41120002
UEXRETRY EQU   X'20'                   AEA FLAG                         41130002
ZERO     EQU   0                        ZERO                            41150002
ONE      EQU   1                        ONE                             41200002
TWO      EQU   2                        TWO                             41250002
THREE    EQU   3                        THREE                           41300002
FOUR     EQU   4                        FOUR                            41350002
FIVE     EQU   5                   FIVE                        @YM5690K 41360000
EIGHT    EQU   8                        EIGHT                           41400002
NINE     EQU   9                        NINE                            41450002
IOSWTO   EQU   253                      IOS WTO ROUTINE ID              41550002
STATUP   EQU   254                      STATISTICS UPDATE ROUTINE ID    41600002
RETURN   EQU   3                        RETURN SVC                      41700002
EREXCP   EQU   15                       ERROR SVC                       41750002
N255     EQU   255                      AND MASK                        41800002
HEX01    EQU   X'01'                    APPENDAGE FLAG                  41900002
HEX04    EQU   X'04'                    APPENDAGE FLAG                  41950002
HEX07    EQU   X'07'                    APPENDAGE FLAG                  42000002
BTAMOPEN EQU   X'24'       TP OP-CODE USED BY BTAM OPEN        @YM5690K 42010000
SBABYTE  EQU   1           DISP OF SBA IN DATA STREAM.      LD @ZA02809 42020002
SBA      EQU   X'11'       SET BUFFER ADDRESS CHAR          LD @ZA02809 42040002
SEVEN    EQU   7                       VALUE OF SEVEN       L5 @ZA02841 42042000
HIGHDVC  DC    X'100D'            HIGH DEVICE TYPE SUPPORTED   @ZA30723 42044000
LOWDVC   DC    X'1009'             LOW DEVICE TYPE SUPPORTED   @ZA15403 42046000
M7       EQU   7              MASK VALUE OF SEVEN              @ZA15403 42048000
         SPACE 2                                                        42050002
**********                                                              42100002
*                                                                       42150002
*        CONSTANTS                                                      42200002
*                                                                       42250002
**********                                                              42300002
CONEIGHT DC    H'8'                     CONSTANT EIGHT                  42400002
CC3SNS   DC    XL2'10FE'                SPECIAL SENSE FOR SIOCC=3       42410002
PACHAREA EQU   *                                                        42450002
         DC    35C'010E'                PATCH AREA FOR MAINTENANCE      42500002
         EJECT                                                          42550002
UCBSET   DSECT                                                          42600002
         IEFUCBOB                                                       42650002
         EJECT                                                          42700002
CVTSET   DSECT                                                          42710002
         CVT                                                            42750002
         EJECT                                                          42800002
         IEZIOB                                                         42850002
ERPIBTRM EQU   IOBWORK             TERM CODE FROM ERPIB     LD @ZA02809 42860002
ERPIBSEQ EQU   IOBWORK+ONE         SEQ CODE FROM ERPIB      LD @ZA02809 42870002
         EJECT                                                          42900002
         IECDRQE                                                        42950002
         EJECT                                                          43000002
         IECDERWA  (NONE)                                               43050002
         EJECT                                                          43100002
         IECDIOSB                                                       43150002
         EJECT                                                          43200002
         DCBD  DSORG=CX                                                 43250001
         EJECT                                                          43252000
         IHAPSA                                                         43260000
         END                                                            43300002
./  ADD  SSI=43530811,NAME=IGG019OA
         TITLE 'GRAPHIC INPUT/OUTPUT CONTROL ROUTINE'                   00100021
*********************************************************************** 00200021
*                                                                     * 00300021
*              GRAPHIC INPUT/OUTPUT CONTROL ROUTINE                   * 00400021
*                                                                     * 00500021
*STATUS CHANGE LEVEL 1                                                  00600021
*                                                                     * 00700021
* FUNCTION: TAKES THE PARAMETER LIST WHICH IS BUILDED BY THE I/O      * 00800021
*           MACRO AND BUILDS THE APPROPIATE CHANNEL COMMAND WORDS.    * 00900021
*           IF REQUIRED PARAMETERS ARE MISSING, THE ROUTINE WILL      * 01000021
*           ABEND. IF COUNT INCORRECT, OR BUFFER                      * 01100021
*           LIMITS EXCEEDED, A CODE IS RETURNED IN REGISTER 15 AND    * 01200021
*           CONTROL IS RETURNED TO PROBLEM PROGRAM.                   * 01300021
*                                                                     * 01400021
* ENTRY POINT: IGG019OA, GIOCR VIA BALR IN I/O MACRO                  * 01500021
*                                                                     * 01600021
* INPUT: ADDRESS OF DECB IN REGISTER 1                                * 01700021
*                                                                     * 01800021
* OUTPUT: RETURN CODE IN REGISTER 15-00 = NORMAL                      * 01900021
*                                    04 = BUFFER LIMITS VIOLATED      * 02000021
*                                    08 = BYTE COUNT IMPROPER         * 02100021
*                                    0C = 2ND DCB USE INVALID (STR)   * 02200021
*                                                                     * 02300021
* EXTERNAL ROUTINES - IGC084 VIA SVC 084                              * 02400021
*                                                                     * 02500021
* EXITS: NORMAL -'RETURN'                                             * 02600021
*        ERROR - 'ABEND'                                              * 02700021
*                                                                     * 02800021
* TABLE: OGATABLE - TABLE OF COMMAND CODES AND COUNTS ASSOCIATED WITH * 02900021
*                   TABLE LOOK-UP USING 1ST FIVE BITS OF TYPE CODE    * 03000021
*                   IN MACRO.                                         * 03100021
*                                                                     * 03200021
* WORK AREA: N/A                                                      * 03300021
*                                                                     * 03400021
* ATTRIBUTES: PROBLEM PROGRAM RESIDENCE, PROBLEM PROGRAM STATE AND    * 03500021
*             REENTRANT                                               * 03600021
*                                                                     * 03700021
* NOTES: N/A                                                          * 03800021
*                                                                     * 03900021
*********************************************************************** 04000021
*                                                                       04100021
*                                                                       04200021
*              REGISTER USE IN THIS ROUTINE                             04300021
*                                                                       04400021
*                                                                       04500021
REG0     EQU   0                                                        04600021
RX       EQU   0                                                        04700021
RDECB    EQU   1                        DECB ADDRESS REGISTER           04800021
RY       EQU   1                                                        04900021
RDCB     EQU   2                        DCB ADDRESS REGISTER            05000021
RZ       EQU   2                                                        05100021
RBASE    EQU   3                        BASE REGISTER                   05200021
RIOB     EQU   4                        IOB ADDRESS REGISTER            05300021
RB       EQU   4                                                        05400021
REG5     EQU   5                                                        05500021
REG6     EQU   6                                                        05600021
REG7     EQU   7                                                        05700021
REG8     EQU   8                                                        05800021
RUCB     EQU   8                                                        05900021
REG9     EQU   9                                                        06000021
RBFTBL   EQU   9                                                        06100021
REG10    EQU   10                       CCW ADDRESS REGISTER            06200021
REG11    EQU   11                                                       06300021
REG12    EQU   12                                                       06400021
ROACB    EQU   12                                                       06500021
RA       EQU   12                                                       06600021
RSAVE    EQU   13                       SAVE ADDRESS REGISTER           06700021
REG14    EQU   14                                                       06800021
REG15    EQU   15                                                       06900021
T2250    EQU   X'02'                                               3841 06950021
*                                                                       07000021
IGG019OA CSECT                                                          07100021
* 090000,094050-094800,565100-565600                             A33619 07140021
*2515,024000,036000,467000                                              07180021
* A219090-212900,A554500                                      LI A44376 07183000
* C216000                                                     LI A44376 07186000
* 327000,328000,426000-430000                                     AOS/1 07190021
*C466000                                                     LG @ZM2358 07192000
*A460500,C461000                                            LG @Z30AALG 07194000
         ENTRY GIOCR                                                    07200021
GIOCR    SAVE  (14,12),,*               SAVE REGISTERS IN USER AREA     07300021
         BALR  RBASE,0                                                  07400021
         USING *,RBASE                                                  07500021
         B     *+24      BRANCH AROUND EYECATCHER                       07550000
MODID    DC    C'IGG019OA.VS2R3.74350'                                  07560000
*                                                                       07600021
*       LOAD DCB ADDRESS IN REGISTER AND CHECK FOR LEGAL DCB            07700021
*                                                                       07800021
         L     RDCB,8(0,RDECB)          DCB ADDRESS                     07900021
         LA    RDCB,0(0,RDCB)           STRIP HIGH ORDER BITS           08000021
         C     RDCB,FZERO               CHECK IF DCB IN PRAM            08100021
         BNE   OGANO                                                    08200021
         WTO   'IFF201I GIOCR FOUND NO DCB ADDRESS IN DECB',ROUTCDE=11,X08230021
               DESC=7                                                   08260021
         LA    REG15,X'10'              DECB DOES NOT HAVE         JFCD 08300021
         B     OGASTR                   DCB ADDR--RETURN           JFCD 08400021
OGANO    L     RIOB,28(0,RDCB)          1ST IOB ADDRESS IN DCB          08600021
         L     REG5,20(0,RIOB)          DCB PTR IN IOB                  08700021
         LA    REG5,0(0,REG5)           DROP HIGH ORDER BITS            08800021
         CR    RDCB,REG5                CHECK IF LEGAL DCB              08900021
         BE    TESTDEB                 YES                       A33619 09000021
         WTO   'IFF202I GIOCR FOUND UNEQUAL DCB ADDRESSES IN DECB AND AX09050021
               SSOCIATED IOB',ROUTCDE=11,DESC=7                         09100021
         LA    REG15,X'14'              ILLEGAL DCB ADDRESS             09150021
         B     OGASTR                   IN DECB--RETURN            JFCD 09200021
*                                                                       09400021
TESTDEB  L     REG6,DCBDEBAD(RDCB)     GET DEB ADDR FROM DCB     A33619 09405021
         L     REG7,DEBDCBAD(REG6)     GET DCB ADDR FROM DEB     A33619 09410021
         LA    REG7,ZERO(REG7)        CLEAR HIGH-ORDER BYTE      A33619 09415021
         CR    REG7,RDCB               DCB ADDRESSES MATCH?      A33619 09420021
         BE    TESTINDX                YES                       A33619 09425021
         WTO   'IFF203I GIOCR FOUND UNEQUAL DCB ADDRESSES IN DECB AND AX09426021
               SSOCIATED DEB',ROUTCDE=11,DESC=7                         09427021
         LA    REG15,X'28'             INVALID DEB - DEB DOES    A33619 09430021
*                                      NOT CONTAIN CORRECT DCB   A33619 09435021
*                                      ADDRESS                   A33619 09440021
         B     OGASTR                  RETURN                    A33619 09445021
TESTINDX CLC   DEBNMEXT(ONE,REG6),UNITINDX(RDECB)    NUMBER IN   A33619 09450021
*                                      DEBNMEXT IN DEB MUST BE   A33619 09455021
*                                      LARGER THAN NUMBER IN     A33619 09460021
*                                      UNIT INDEX FIELD IN DEB   A33619 09465021
         BH    OGAOCBP                 COMPARE VALID - CONTINUE  A33619 09470021
         WTO   'IFF204I GIOCR FOUND DECB UNIT INDEX EXCEEDS UNITS SPECIX09471021
               FIED IN DD RECORD',ROUTCDE=11,DESC=7                     09472021
         LA    REG15,X'2C'             DECB REFERENCING UCB NOT  A33619 09475021
*                                      IN DEB                    A33619 09480021
         B     OGASTR                  RETURN                    A33619 09485021
*       TEST IF OCBP USED, IF SO, LOAD ADDRESSES TO REGISTERS           09500021
*       FROM OACB. IF NOT, LOAD REGISTERS FROM DECB.                    09600021
*                                                                       09700021
OGAOCBP  TM    4(RDECB),X'C0'           IF 2260 READ/WRITE              09800021
         BO    OGACOMP                  OCBP NOT USED                   09900021
         TM    4(RDECB),X'70'           IF 2260 ERASE                   10000021
         BO    OGACOMP                  OCBP NOT USED                   10100021
         TM    4(RDECB),X'80'           READ/WRITE                      10200021
         BC    12,OGACOMP               OCBP NOT USED                   10300021
         TM    20(RDECB),X'80'          TEST FOR OCBP USED              10400021
         BZ    OGACOMP                  NOT SPECIFIED                   10500021
         L     REG7,20(0,RDECB)         OCBP ADDRESS                    10600021
         LA    REG7,0(0,REG7)           STRIP HIGH ORDER BITS           10700021
         C     REG7,FZERO               CHECK IF OCBP IN PRAM           10800021
         BNE   OGANO1                                                   10900021
         WTO   'IFF205I GIOCR FOUND NO OCBP ADDRESS IN DECB',ROUTCDE=11X10930021
               ,DESC=7                                                  10960021
         LA    REG15,X'18'              DECB DOES NOT HAVE         JFCD 11000021
         B     OGASTR                   OCBP PTR--RETURN           JFCD 11100021
OGANO1   L     REG8,0(0,REG7)           LOAD OACB ADDRESS               11300021
         L     REG6,12(0,REG8)          CRSA ADDRESS (AREA ADDRESS)     11400021
         LA    REG5,22(0,REG8)          START ADDRESS (BUFFER ADDRESS)  11500021
         L     REG0,24(0,RDECB)         START ADDRESS IN REGISTER       11600021
         C     REG0,FZERO               CHECK IF START ADDRESS          11700021
         BNE   OGAOLP                   YES                             11800021
         LR    REG0,REG5                BUFFER ADDRESS TO START REG     11900021
OGAOLP   L     REG8,16(0,REG8)          OLP                             12000021
         LA    REG8,0(0,REG8)           STRIP HIGH ORDER BITS           12100021
         LA    REG6,0(0,REG6)           STRIP HIGH ORDER BITS           12200021
         SR    REG8,REG6                LENGTH                          12300021
         BC    11,OGARWS                NOT NEGATIVE LENGTH             12400021
         WTO   'IFF206I GIOCR, USING OACB, COMPUTED NEGATIVE BYTE COUNTX12450021
                FOR I/O OPERATION',ROUTCDE=11,DESC=7                    12500021
         LA    REG15,X'08'              LOAD THE RETURN CODE            12550021
         B     OGASTR                   RESTORE REGISTERS AND EXIT      12600021
*                                                                       12700021
*       TEST IF TYPE CODE IN DECB, IF START ADDRESS EVEN                12800021
*                                                                       12900021
OGACOMP  L     REG0,24(0,RDECB)         START ADDRESS IN REGISTER       13000021
         L     REG8,20(0,RDECB)         LENGTH IN REGISTER              13100021
         TM    4(RDECB),X'80'           FOR TYPE CODE IN LENGTH         13200021
         BZ    OGAPASS                                                  13300021
         C     REG8,FZERO               TEST IF NEGATIVE                13400021
         BC    11,OGAPASS               YES                      S21016 13430021
         WTO   'IFF207I GIOCR FOUND NEGATIVE LENGTH IN DECB',ROUTCDE=11X13460021
               ,DESC=7                                                  13490021
         LA    REG15,X'3C'             LOAD RETURN CODE          S21016 13520021
         B     OGASTR                  GO RETURN                        13550021
OGAPASS  L     REG6,12(0,RDECB)         AREA ADDRESS TO REGISTER        13600021
         L     REG5,28(0,RDECB)         BUFFER ADDRESS TO REGISTER      13700021
         LA    REG5,0(0,REG5)           DROP EIGHT HIGH ORDER BITS      13800021
OGARWS   L     REG7,4(0,RDECB)          TYPE CODE                       13900021
         C     REG7,FZERO               CHECK IF TYPE IN PARM           14000021
         BNE   OGABUF2                  YES                             14100021
         WTO   'IFF208I GIOCR FOUND NO TYPE CODE IN DECB',ROUTCDE=11,DEX14130021
               SC=7                                                     14160021
         LA    REG15,X'1C'              DECB DOES NOT HAVE         JFCD 14200021
         B     OGASTR                   TYPE CODE--RETURN          JFCD 14300021
*                                                                       14500021
*       CHECK IF BUFFER LIMIT TEST REQUIRED, IF SO, GO TO BUFFER        14600021
*       TEST ROUTINE.                                                   14700021
*                                                                       14800021
OGABUF2  TM    4(RDECB),X'C0'           2260 READ/WRITE                 14900021
         BC    1,OGANEXT                NO BUFFER CHECK                 15000021
         TM    4(RDECB),X'70'           2260 ERS                        15100021
         BC    1,OGANEXT                NO BUFFER CHECK                 15200021
         TM    4(RDECB),X'80'           TEST FOR READ/WRITE             15300021
         BC    1,OGAMAN                 YES                             15400021
         TM    4(RDECB),X'48'           TEST FOR HLT/INS/STR            15500021
         BC    1,OGAMAN0                YES                             15600021
         TM    4(RDECB),X'62'           TEST FOR RMV                    15700021
         BC    1,OGAMAN                 YES                             15800021
         B     OGANEXT                                                  15900021
OGAMAN0  TM    4(RDECB),SRTYP           SEE IF STR TYPE IN DECB.        16000021
         BZ    OGAMAN                   NO                              16100021
         TM    24(RDECB),DCB2           SEE IF 2ND DCB PRESENT.         16200021
         BZ    OGAMAN                   NO DCB2 SPECIFIED               16300021
         L     RDCB,12(0,RDECB)         LOAD 2'ND DCB ADDR.             16400021
         LA    RDCB,0(0,RDCB)           ZERO HI-ORDER BYTE.             16500021
         L     REG10,28(0,RDCB)        IOB ADDRESS FROM DCB.            16600021
         L     REG10,20(0,REG10)       DCB PTR FROM IOB.                16700021
         LA    REG10,0(0,REG10)         ZERO HI-ORDER BYTE.             16800021
         CR    REG10,RDCB               DOES IOB POINT TO DCB2.         16900021
         BE    CONT1                    NO-INVALID DCB           S21016 16930021
         WTO   'IFF209I GIOCR FOUND DCB2 ADDRESS IN DECB NOT EQUAL TO DX16960021
               CB ADDRESS IN IOB',ROUTCDE=11,DESC=7                     16990021
         LA    REG15,X'38'             LOAD RETURN CODE          S21016 17020021
         B     OGASTR                  GO RETURN                        17050021
CONT1    EQU   *                                                 S21016 17070021
         L     REG10,44(0,RDCB)         DEB ADDR FROM DCB2              17100021
         L     REG10,32(0,REG10)        UCB ADDR IN DEB.                17200021
         L     REG11,8(0,RDECB)         DCB1 ADDR TO REG 11.            17300021
         L     REG11,44(0,REG11)        DEB ADDR FROM DCB1.             17400021
         L     REG11,32(0,REG11)        UCB ADDR IN DEB                 17500021
         CLC   BTBL(3,REG10),BTBL(REG11)  ARE BUF TBL ADDR EQUAL.       17600021
         BE    SWITCH                     YES.                          17700021
         WTO   'IFF210I GIOCR FOUND DEVICES FOR DCB AND DCB2 ON DIFFEREX17730021
               NT CONTROL UNITS',ROUTCDE=11,DESC=7                      17760021
         LA    REG15,OGA0CR                                             17800021
         B     OGASTR                                                   17900021
SWITCH   MVC   12(4,RDECB),8(RDECB)     REVERSE DCB POINTERS            18000021
         ST    RDCB,8(0,RDECB)          IN DECB FOR BUFFER CHECK.       18100021
OGAMAN   LR    REG14,REG8               STORE REG. 8                    18200021
         LR    REG11,RIOB               STORE REG. 4                    18300021
         LR    REG10,REG0               STORE REG. 0                    18400021
         LA    REG10,0(0,REG10)        CLEAR HIGH ORDER BYTE            18500021
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 18600021
*        BUFFER PROTECT ROUTINE                                       * 18700021
*FUNCTION/OPERATION: CHECK BUFFER ADDRESSES INVOLVED IN INPUT/OUTPUT  * 18800021
*   OPERATIONS AGAINST THE LIMITS OF THE BUFFER ASSIGNMENT TO THAT    * 18900021
*   DEVICE TO PROTECT BUFFER STORAGE ASSIGNED TO OTHER DEVICES.       * 19000021
*ENTRY POINT: IGG019OC                                                * 19100021
*INPUT: ADDRESS OF DECB IN REGISTER 1                                 * 19200021
*OUTPUT: RETURN CODE IN REGISTER 15 - 00 = PROCEED WITH I/O           * 19300021
*                                     04 = ERROR, DO NOT PROCEED      * 19400021
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 19500021
*                                                                       19600021
IGGBUFPR EQU   *                                                  AOS/1 19700021
         USING DECB,RDECB                                               19800021
*                                                                       19900021
         L     RUCB,DCBAD          LOAD RUCB WITH DCB ADR               20000021
         L     RUCB,44(RUCB)       LOAD RUCB WITH DEB ADR               20100021
         L     RUCB,32(RUCB)       LOAD RUCB WITH UCB ADR               20200021
         L     RBFTBL,36(RUCB)     LOAD RBFTBL WITH BFR TBL ADR         20300021
*                                                                       20400021
         TM    OCBP,X'80'          TEST OACB INDICATOR BYTE             20500021
         BC    1,COMPUTE                                                20600021
*                                                                       20700021
         TM    TYPE,SRTYP          CHK FOR STR TYPE                     20800021
         BO    CHKSTR              BRANCH IF START TYPE                 20900021
         L     RA,BUFFER           NO - ACCESS BFR START ADDR           21000021
         LA    RA,ZERO(RA)             CLEAR HI BYTE             S21016 21020021
         LTR   RA,RA                   IS BFR START ADDR PRESENT S21016 21040021
         BZ    NOBUFAD                 BRANCH IF BFR ADDR ZERO   S21016 21060021
         LH    RA,0(RA)                                                 21100021
         LH    RB,LENGTH           ACCESS LENGTH FROM DECB              21200021
         TM    4(RDECB),X'06'      TEST FOR 2260              LI A44376 21209000
         BNO   NOT2260             BRANCH IF NOT              LI A44376 21218000
         CLC   4(RDECB),ERSTYPE    TEST FOR 2260 GCNTRL       LI A44376 21227000
         BE    NOLNGTH             BRANCH IF YES              LI A44376 21236000
         B     ADJUST              NOT 2260 GCNTRL            LI A44376 21245000
NOT2260  EQU   *                                              LI A44376 21254000
         TM    4(RDECB),X'40'      IS THIS 2250 GCNTRL        LI A44376 21263000
         BNO   ADJUST              NO, USE LENGTH             LI A44376 21272000
NOLNGTH  EQU   *                                              LI A44376 21281000
         SR    RB,RB               ZERO LRNGTH REG            LI A44376 21290000
         B     ADJUST                                                   21300021
CHKSTR   L     RA,START            ACCESS BUFFER START ADDR IN DECB     21400021
         LH    RA,0(RA)                                                 21500021
         SR    RB,RB               ZERO LENGTH REG            LI A44376 21600000
*                                                                       21700021
*POSITIVE CHECK FOR LEGAL ADR, I.E., WITHIN BUFFER SIZE                 21800021
*                                                                       21900021
ADJUST   LH    RX,0(RBFTBL)        LOAD TBLNGTH IN RX                   22000021
         SLL   RX,8                MULTIPLY TBLNGTH BY 256              22100021
         CLR   RA,RX                IS ADR LARGER THAN SIZE             22200021
         BH    ERROR1        YES GO TO ERROR ROUTN               S21016 22300021
         AR    RA,RB               ADD LENGTH TO START ADR FOR END ADR  22400021
         CLR   RA,RX               IS END ADR LARGER THAN SIZE          22500021
         BH    ERROR2        YES GO TO ERROR ROUTN               S21016 22600021
         SR    RA,RB               OTHERWISE SET RA EQ START ADR AND GO 22700021
         SRL   RA,8                BUFFER ADR ROUNDED DOWN TO MULT 256  22800021
         CLI   16(RUCB),X'31'           SEE IF MODEL ONE                22900021
         BE    MOD1                     YES                             23000021
         LA    RX,HEADISP          LOAD RX EQ 72                        23100021
*                                                                       23200021
GOON     AR    RA,RX               ADD HEADER LENGTH TO ADR             23300021
         AR    RA,RBFTBL           ADD ADDR OF BFR TBL, RA EQ DISP OF   23400021
*                                       SECTION ENTRY FOR THAT BFR ADR  23500021
*                                       IN BFR TBL                      23600021
*ADJUST LENGTH TO 256-BYTE SECTIONS                                     23700021
*                                                                       23800021
         LA    RX,MASK1            LOAD RX WITH ALL ONES                23900021
         AR    RB,RX               ADD CONVERSION FACTOR                24000021
         SRL   RB,8                PUT NUMBER OF SECTIONS IN LO-ORDER   24100021
*                                       BYTES OF RB                     24200021
         CL    RB,FZERO            CHK FOR ZERO LENGTH                  24300021
         BH    INITRX              BRANCH IF NOT ZERO                   24400021
         LA    RB,RY                                                    24500021
INITRX   LA    RX,RY               SET RX EQ 1                          24600021
CHECKALL CLC   0(1,RA),36(RUCB)    COMPARE BFR TBL ENTRY TO DEVNDX      24700021
         BNE   ERROR3        NOT EQUAL GO TO ERROR ROUTN         S21016 24800021
         AR    RA,RX               INCREMENT ENTRY DISP BY 1            24900021
         BCT   RB,CHECKALL                                              25000021
         B     OUT                                                      25100021
*                                                                       25200021
MOD1     LA    RX,16                LOAD MOD 1 BFRTBL HEADER LNGYH      25300021
         B     GOON                                                     25400021
*                                                                       25500021
COMPUTE  L     ROACB,OCBP          LOAD ADDR OF OCBP IN ROACB           25600021
         L     ROACB,0(ROACB)      LOAD ADDR OF OACB IN ROACB           25700021
         USING OACB,ROACB          SET UP OACB DSECT REGISTER           25800021
         L     RB,OLP              LOAD RB WITH OLP ADDR                25900021
         S     RB,CRSA             SUBTRACT CRSA TO GET LNG IN BYTES    26000021
         L     RA,BLP              LOAD BUFFER START ADDR IN RA         26100021
         B     ADJUST              GO TO CONVERT ROUTINE                26200021
*                                                                       26300021
ERROR1   WTO   'IFF211I GIOCR FOUND BUFFER START ADDRESS EXCEEDS BUFFERX26350021
                SIZE',ROUTCDE=11,DESC=7                                 26400021
         LA    REG15,X'04'             LOAD RETURN CODE          S21016 26450021
         B     CHKRET                                                   26500021
OUT      LA    15,0(0,0)                LOAD RETURN CODE.               26600021
         B     CHKRET                  BRANCH TO RETURN          S21016 26610021
ERROR2   WTO   'IFF212I GIOCR FOUND BUFFER ENDING ADDRESS EXCEEDS BUFFEX26620021
               R SIZE',ROUTCDE=11,DESC=7                                26630021
         LA    REG15,X'30'             LOAD RETURN CODE          S21016 26640021
         B     CHKRET                  GO RESTORE REGS           S21016 26650021
ERROR3   WTO   'IFF213I GIOCR FOUND I/O OPERATION VIOLATES BUFFER STORAX26660021
               GE ASSIGNED',ROUTCDE=11,DESC=7                           26670021
         LA    REG15,X'34'             LOAD RETURN CODE          S21016 26680021
         B     CHKRET                   BRANCH TO PD PROCESSING  S21016 26690021
CHKRET   EQU   *                                                        26700021
*                                                                       26800021
         LR    REG8,REG14               RESTORE REG. 8                  26900021
         LR    RIOB,REG11               RESTORE REG. 4                  27000021
         LR    REG0,REG10               RESTORE REG. 0                  27100021
         C     REG15,FZERO              TEST IF BEYOND LIMITS           27200021
         BNE   OGASTR                   BUFFER ERROR-RETURN.            27300021
OGAMAN1  TM    24(RDECB),DCB2           WAS DCB2 CHECKED BY BUF PROTECT 27400021
         BZ    OGAMAN2                  NO.                             27500021
         MVC   8(4,RDECB),12(RDECB)     RESTORE DCB PTRS                27600021
         ST    RDCB,12(0,RDECB)         IN DECB.                        27700021
         L     RDCB,8(0,RDECB)          RELOAD DCB1 ADDR.               27800021
         B     OGANEXT                                                  27900021
OGAMAN2  CLI   4(RDECB),X'92'           TEST FOR FND                    28000021
         BNE   OGANEXT                                                  28100021
         A     REG8,FONE                ONE TO LENGTH FOR FIND TYPE     28200021
*                                                                       28300021
*        FIND NEXT IOB AND ASSIGN                                       28400021
*                                                                       28500021
OGANEXT  LR    REG10,RIOB               FIND NEXT IOB AVAILABLE         28600021
OGALOOP  TS    36(REG10)                IS THIS IOB AVAILABLE           28700021
         BZ    OGASGN                   YES - ASGN                      28800021
         LA    REG10,36(0,REG10)        LOCATION OF NEXT IOB            28900021
         CLC   1(3,REG10),FZERO         TEST FOR ZERO                   29000021
         BZ    OGAWAIT                  NON-AVAILABLE, WAIT             29100021
         L     REG10,0(0,REG10)         LOAD NEXT IOB AVAILABLE         29200021
         B     OGALOOP                                                  29300021
OGAWAIT  LR    REG11,RDECB              STORE REGISTER 1                29400021
         LR    REG12,REG0               STORE REGISTER 0                29500021
         LR    RDECB,RIOB               FIRST IOB LOCATION              29600021
         S     RDECB,FOUR               LOCATION                        29700021
         MVC   0(4,RDECB),FZERO         CLEAR ECB                       29800021
         WAIT  ECB=(1)                                                  29900021
         LR    REG0,REG12               RESTORE REGISTER 0              30000021
         LR    RDECB,REG11              RESTORE REGISTER 1              30100021
         B     OGANEXT                  FIND AVAIL IOB                  30200021
OGASGN   LR    RIOB,REG10               IOB REG WITH NEW IOB ASGN       30300021
         LA    REG10,40(0,RIOB)         CCW LOCATION ADDRESS            30400021
         L     REG9,4(0,RDECB)          TYPE CODE TO REGISTER           30500021
*                                                                       30600021
*        IS NON-STOP REGENERATION TYPE CODE                             30700021
*                                                                       30800021
         TM    4(RDECB),X'C0'           2260 READ/WRITE                 30900021
         BC    1,OGACCW                 BUILD CCW                       31000021
         TM    4(RDECB),X'70'           2260 ERASE                      31100021
         BC    1,OGACCW                 BUILD CCW                       31200021
         CLI   4(RDECB),X'4A'           HLT TYPE                        31300021
         BE    OGACCW                   BUILD CCW                       31400021
         CLI   4(RDECB),X'08'           MIP TYPE                        31500021
         BE    OGACCW                   BUILD CCW                       31600021
         CLI   4(RDECB),X'10'           XYP TYPE                        31700021
         BE    OGACCW                   BUILD CCW                       31800021
         CLI   4(RDECB),X'40'           ALM TYPE                        31900021
         BE    OGACCW                   BUILD CCW                       32000021
         CLI   4(RDECB),X'50'           IND TYPE                        32100021
         BE    OGACCW                   BUILD CCW                       32200021
         CLI   4(RDECB),X'6C'           STR TYPE                        32300021
         BE    OGACCW                   BUILD CCW                       32400021
         CLI   4(RDECB),X'A8'           UNB TYPE                        32500021
         BE    OGACCW                   BUILD CCW                       32600021
         CLI   4(RDECB),X'00'           DEV TYPE                        32700021
         BE    OGACCW                   BUILD CCW                       32800021
         CLI   4(RDECB),X'18'           'SEN' TYPE               A25397 32830021
         BE    OGACCW                   IF YES GO BUILD CCW      A25397 32860021
*                                                                       32900021
*       BUILD  -  SET BUFFER ADDRESS REGISTER AND STOP - CHANNEL        33000021
*       COMMAND WORD WITH CHAINING                                      33100021
*                                                                       33200021
OGAHALT  SR    REG11,REG11              CLEAR REGISTER                  33300021
         ST    REG11,4(0,REG10)         CLEAR FIELD                     33400021
         IC    REG11,HLTCT              HALT COMMAND CODE COUNT         33500021
         STC   REG11,7(0,REG10)         COUNT IN CCW FOR HALT           33600021
         C     REG5,FZERO               BUFFER ADDRESS IN PRAM          33700021
         BNE   OGANO3                                                   33800021
NOBUFAD  EQU   *                                                 S21016 33820021
         WTO   'IFF214I GIOCR FOUND NO BUFFER ADDRESS IN DECB',ROUTCDE=X33840021
               11,DESC=7                                                33860021
         LA    REG15,X'20'              DECB DOES NOT HAVE         JFCD 33900021
         MVI   36(RIOB),X'00'           MARK IOB AS NOW          A29793 33930021
*                                            AVAILABLE           A29793 33960021
         B     OGASTR                   BUFF ADR.--RETURN          JFCD 34000021
OGANO3   ST    REG5,0(0,REG10)          BUFFER ADDRESS IN CCW           34200021
         SR    REG11,REG11              CLEAR REGISTER                  34300021
         IC    REG11,HALT               HALT COMMAND CODE               34400021
         STC   REG11,0(0,REG10)         COMMAND CODE IN CCW FOR HALT    34500021
         MVI   4(REG10),X'60'           CCW FLAG BITS                   34600021
         A     REG10,EIGHT              UPDATE CCW POINTER              34700021
*                                                                       34800021
*       BUILD APPROPIATE CHANNEL COMMAND WORD FOR I/O OPERATION. IF     34900021
*       ANOTHER COMMAND FOLLOW, BRANCH BACK WITH CHAINING. IF LAST      35000021
*       COMMAND, TEST FOR UNBUFFERED.                                   35100021
*                                                                       35200021
OGACCW   LR    REG12,REG8               SHIFT LENGTH TO REG12           35300021
OGACCW1  SR    REG8,REG8                CLEAR REGISTER                  35400021
         ST    REG8,4(0,REG10)          CLEAR FIELD                     35500021
         SLDL  REG8,5                    TYPE CODE 5 HIGH ORDER BITS    35600021
         TM    4(RDECB),X'06'           FOR ONE                         35700021
         BC    4,OGABUF                 NEXT TEST                       35800021
         ST    REG6,0(0,REG10)          AREA ADDRESS TO CCW             35900021
         B     OGACODE                  COMMAND CODE AND COUNT          36000021
OGABUF   TM    4(RDECB),X'02'           FOR BUFFER CODE                 36100021
         BC    12,OGASTART              START CODE                      36200021
         ST    REG5,0(0,REG10)          BUFFER ADDRESS TO CCW           36300021
         B     OGACODE                  COMMAND CODE AND COUNT          36400021
OGASTART TM    4(RDECB),X'04'           FOR START CODE                  36500021
         BC    12,OGACODE               COMMAND CODE AND COUNT          36600021
         ST    REG0,0(0,REG10)          START ADDRESS TO CCW            36700021
OGACODE  LA    REG11,OGATABLE           COMMAND CODE AND COUNT TABLE    36800021
         L     REG15,44(RDCB)           DEB ADDR                        36820021
         L     REG15,32(REG15)          UCB ADDR                        36840021
         CLI   UCBTYP(REG15),T2260      2260                            36860021
         BNE   OGACODE1                 NO                              36880021
         CLI    29(RDECB),X'01'                                         36900021
         BE    DATENTRY                                                 37000021
OGACODE1 CLI   4(RDECB),X'40'           FOR ALM TYPE                    37100021
         BE    OGANCK                                                   37200021
         CLI   4(RDECB),X'70'           FOR ERS TYPE 2260               37300021
         BE    OGANCK                                                   37400021
         L     REG15,0(0,REG10)         DATA ADDRESS IN CCW             37500021
         C     REG15,FZERO              CHECK IF ADDRESS PRESENT        37600021
         BNE   OGANCK                                                   37700021
         MVI   36(RIOB),X'00'           MARK IOB AS NOW          A29793 37730021
*                                            AVAILABLE           A29793 37760021
         WTO   'IFF215I GIOCR DISCOVERED AREA,BUFFER, OR START ADDRESS X37770021
               MISSING',ROUTCDE=11,DESC=7                               37780021
         LA    REG15,X'24'              DECB DOES NOT HAVE         JFCD 37800021
         B     OGASTR                   AREA ADR.--RETURN          JFCD 37900021
DATENTRY  A  REG11,THRESIX                                              38100021
         B     OGANCK                                                   38200021
OGANCK   AR    REG8,REG8                DOUBLE BITS IN REGISTER         38300021
         LH    REG11,0(REG8,REG11)      COMMAND CODE AND COUNT          38400021
         STC   REG11,7(0,REG10)         COUNT IN CCW                    38500021
         SRL   REG11,8                  SHIFT OUT COUNT                 38600021
         STC   REG11,0(0,REG10)         COMMAND CODE INTO CCW           38700021
         TM    7(REG10),X'FF'           IS COUNT ZERO                   38800021
         BC    5,OGACMD                 NO                              38900021
         ST    REG12,4(0,REG10)         LENGTH FROM REGISTER TO CCW     39000021
OGACMD   L     REG11,FZERO              ZERO TO REGISTER                39100021
         STH   REG11,4(0,REG10)         CLEAR UNUSED AREA IN CCW        39200021
         TM    4(RDECB),X'92'           TYPE CODE FOR FIND              39300021
         BC    12,OGAREAD               NO                              39400021
         SR    REG11,REG11              CLEAR REGISTER                  39500021
         IC    REG11,FNDB               FIND FLAG BITS                  39600021
         STC   REG11,4(0,REG10)         BITS IN FLAG IN CCW FOR FIND    39700021
         B     OGABIT                   NEXT TYPE CODE                  39800021
OGAREAD  TM    4(RDECB),X'80'           TYPE CODE FOR READ/WRITE        39900021
         BC    12,OGAOTHB               OTHER CODES                     40000021
         SR    REG11,REG11              CLEAR REGISTER                  40100021
         CLI   4(RDECB),X'88'           TEST IF CUR TYPE                40200021
         BE    OGABIT                   YES                             40300021
         CLI   4(RDECB),X'D8'           TEST FOR SMI READ               40400021
         BE    OGABIT                   YES                             40500021
         CLI   4(RDECB),X'E0'           TEST IF DSM READ TYPE           40600021
         BE    OGABIT                   YES                             40700021
         CLI   4(RDECB),X'E8'           TEST IF DSB READ TYPE           40800021
         BE    OGABIT                   YES                             40900021
         IC    REG11,RDWTB              READ/WRITE FLAG BITS            41000021
         STC   REG11,4(0,REG10)         BITS IN FLAG OF CCW FOR RD/WR   41100021
         B     OGABIT                   NEXT TYPE CODE                  41200021
OGAOTHB  SR    REG11,REG11              CLEAR REGISTER                  41300021
         CLI   4(RDECB),X'4A'           TEST IF HLT TYPE                41400021
         BE    OGABIT                   YES                             41500021
         CLI   4(RDECB),X'6C'           TEST IF STR TYPE                41600021
         BE    OGABIT                   YES                             41700021
         CLI   4(RDECB),X'50'           TEST IF IND TYPE                41800021
         BE    OGABIT                   YES                             41900021
         CLI   4(RDECB),X'08'           TEST IF MIP TYPE                42000021
         BE    OGABIT                   YES                             42100021
         CLI   4(RDECB),X'10'           TEST IF XYP TYPE                42200021
         BE    OGABIT                   YES                             42300021
         CLI   4(RDECB),X'18'           TEST IF DFS TYPE                42400021
         BE    OGABIT                   YES                             42500021
OGASIL   IC    REG11,FLAG               BITS FOR OTHERS FLAG            43100021
         STC   REG11,4(0,REG10)         BITS IN FLAG OF CCW FOR OTHERS  43200021
OGABIT   SLDL  REG8,3                   SHIFT OUT LAST BITS             43300021
         L     REG11,4(0,RDECB)         TYPE CODE                       43400021
         SLL   REG11,8                  1ST TYPE CODE                   43500021
         ST    REG11,4(0,RDECB)         TYPE CODE BACK                  43600021
         TM    4(RDECB),X'FF'           ANOTHER TYPE CODE FOLLOWS       43700021
         BC    8,OGASET                 NON-FOLLOW                      43800021
         TM    4(REG10),X'40'           TEST IF COMMAND CHAINING        43900021
         BC    5,OGAUPD                 YES                             44000021
         L     REG11,4(0,REG10)         FLAG FIELD                      44100021
         O     REG11,BFOUR              TURN ON COMMAND CHAIN FLAG      44200021
         ST    REG11,4(0,REG10)         FLAG W/COMMAND CHAINING IN CCW  44300021
OGAUPD   A     REG10,EIGHT              UPDATE CCW POINTER              44400021
         B     OGACCW1                  LOOP FOR NEXT CCW               44500021
OGASET   ST    REG7,4(0,RDECB)          RESTORE TYPE CODE IN DECB       44600021
*                                                                       44700021
*       TURN OFF APPROPIATE FLAGS IN CCW AND STORE RESTART ADDRESS      44800021
*       IN DCB. STORE ECB ADDRESS IN IOB AND SET ECB TO ZERO            44900021
*                                                                       45000021
         TM    4(REG10),X'40'           TEST IF COMMAND CHAINING        45100021
         BC    8,OGAECB                 OFF                             45200021
         L     REG11,4(0,REG10)         FLAG OF CCW                     45300021
         N     REG11,BNTWO              TURN OFF                        45400021
         ST    REG11,4(0,REG10)         FLAG TO CCW                     45500021
OGAECB   LR    REG11,REG0                                               45600021
         CLI   0(REG10),X'27'           WAS LAST COMMAND A START   3841 45630021
         BNE   OGASKIP1                 NO SKIP ADDR SAVE          3841 45660021
         MVC   12(2,RDCB),0(REG11)      RESTART BUF ADD IN DCB          45700021
         L     REG5,44(0,RDCB)          DEB ADDRESS FROM DCB            45800021
         LR    REG10,RDECB              SAVE REG 1.                     45900021
         DEBCHK (RDCB),TYPE=VERIFY,AM=GAM   VALIDATE DEB      LB Y01021 45950001
         LH    REG0,0(0,REG11)          GET RESTART ADDRESS.            46000021
         SR    RDECB,RDECB        CLEAR WORK REGISTER       LG @Z30AALG 46050000
         ICM   RDECB,3,34(REG5)   UCB ADDRESS FROM DEB      LG @Z30AALG 46100000
         CLI   UCBTYP(RDECB),T2250                                 3841 46200021
         BH    OGASKIP                                             3841 46300021
         SLL   REG0,16                  LEFT JUSTIFY IN REG0.           46400021
         OR    REG0,RDECB               UCB AND BUFF ADDR TO REG 0.     46500021
         LR    RY,RDCB             LD DCB ADDR               LG @ZM2358 46550000
         SVC   84                  RESTART ADDRESS TO UCB          TMGA 46700021
OGASKIP  LR    RDECB,REG10              RESTORE DECB ADDR IN REG1       46800021
OGASKIP1 ST    RDECB,4(0,RIOB)          ECB ADDR IN IOB            3841 46900021
OGAEXCP  L     REG11,FZERO              ZERO TO REGISTER                47000021
         STH   REG11,30(0,RIOB)         CLEAR COUNT AREA IN IOB         47100021
         L     REG7,28(0,RDECB)         BUFFER ADDRESS                  47200021
         SRL   REG7,24                                                  47300021
         STC   REG7,32(0,RIOB)          UCB INDEX INTO IOB              47400021
*                                                                       47500021
*       ISSUE SVC 0 FOR EXCP AND RETURN                                 47600021
*                                                                       47700021
         LR    RDECB,RIOB               IOB POINTER TO REG 1            47800021
         SVC   0                        EXCP                            47900021
         LA    REG15,ZERO              LOAD RETURN CODE          S21016 48000021
OGASTR   RETURN (14,12),RC=(15)                                         48100021
*                                                                       48200021
*       ABEND AND DUMP ON PROPER CODE                                   48300021
*                                                                       48400021
         DS    0D                                                       48600021
*                                                                       48700021
*                                                                       48800021
*       COMMAND CODE AND COUNT TABLE ON HALH WORD BOUNDARY USED         48900021
*       FOR BUILDING CCW'S. THE FIRST BYTE IS THE COMMAND CODE          49000021
*       AND THE LAST BYTE IS THE COUNT ASSOCIATED WITH EACH COMMAND     49100021
*       IF APPROPIATE. THE MACRO ID REQUIRED TO HAVA A COUNT IF THE     49200021
*       COUNT IS ZERO.                                                  49300021
*                                                                       49400021
*                                                                       49500021
OGATABLE DS    0F                                                       49600021
OGADEV   DC    X'1612'                  0                               49700021
OGAMIP   DC    X'0E03'                  1                               49800021
OGAXYP   DC    X'1204'                  2                               49900021
OGADFS   DC    X'0404'                  3                               50000021
OGADCS   DC    X'0404'                  4                               50100021
         DC    X'0000'                  5    UNASSIGNED                 50200021
         DC    X'0000'                  6    UNASSIGNED                 50300021
         DC    X'0000'                  7    UNASSIGNED                 50400021
OGAALM   DC    X'0B02'                  8                               50500021
OGASTOP  DC    X'0702'                  9                               50600021
OGAIND   DC    X'1B04'                  10                              50700021
OGAINS   DC    X'0F02'                  11                              50800021
OGARMV   DC    X'1F02'                  12                              50900021
OGASTR1  DC    X'2702'                  13                              51000021
OGAERS   DC    X'0702'                  14                              51100021
         DC    X'0000'                  15   UNASSIGNED                 51200021
OGABUF1  DC    X'0200'                  16                              51300021
OGACUR   DC    X'0600'                  17                              51400021
OGAFND   DC    X'0600'                  18                              51500021
         DC    X'0000'                  19   UNASSIGNED                 51600021
OGAWBUF  DC    X'0100'                  20                              51700021
OGAUNB   DC    X'0100'                  21                              51800021
         DC    X'0000'                  22   UNASSIGNED                 51900021
         DC    X'0000'                  23   UNASSIGNED                 52000021
         DC    X'0000'                  24   UNASSIGNED                 52100021
         DC    X'0000'                  25   UNASSIGNED                 52200021
         DC    X'0000'                  26   UNASSIGNED                 52300021
OGASMI   DC    X'0A00'                  27   2260                       52400021
OGADSM   DC    X'0200'                  28   2260                       52500021
OGADSB   DC    X'0600'                  29   2260                       52600021
OGAWDSB  DC    X'0100'                  30   2260                       52700021
OGALNE   DC    X'0500'                  31   2260                       52800021
OGAERSW  DC    X'1702'                                                  52900021
         DC    24X'00'                                                  53000021
OGASMIW  DC    X'1A00'             DATA ENTRY COMMANDS                  53100021
OGADSMW  DC    X'1200'                                                  53200021
OGADSBW  DC    X'1600'                                                  53300021
OGADSBWW DC    X'1100'                                                  53400021
OGALNEW  DC    X'1500'                                                  53500021
*                                                                       53600021
*                                                                       53700021
*        CONSTANT                                                       53800021
*                                                                       53900021
         DS    0F                                                       54000021
FONE     DC    XL4'01'                                                  54100021
FZERO    DC    XL4'0'                                                   54200021
TWO      DC    F'2'                                                     54300021
FOUR     DC    F'4'                                                     54400021
EIGHT    DC    F'8'                                                     54500021
BFOUR    DC    X'40000000'                                              54600021
BNTWO    DC    X'20FFFFFF'                                              54700021
FLAG     DC    X'20'                                                    54800021
CONCF    DC    C'C0'                                                    54900021
HLTCT    DC    X'02'                                                    55000021
T2260    EQU   X'03'                                                    55100021
HALT     DC    X'07'                                                    55200021
FNDB     DC    X'30'                                                    55300021
RDWTB    DC    X'20'                                                    55400021
ERSTYPE  DC    X'7000'             2260 GCNTRL TYPE           LI A44376 55450000
PATCH    DC    C'IGG019OA 50 BYTE PATCH AREA.'                          55460000
         DC    C'50 BYTE AREA ENDS HERE'                                55470000
THRESIX  DC  F'36'                                                      55500021
OGA4R    EQU   4                                                        55600021
OGA8R    EQU   8                                                        55700021
OGA0CR   EQU   12                                                       55800021
OGA10R   EQU   16                                                       55900021
UCBTYP   EQU   19                                                       56000021
BTBL     EQU   37                                                       56100021
HEADISP  EQU   40                                                       56200021
SRTYP    EQU   X'6C'                                                    56300021
DCB2     EQU   X'80'                                                    56400021
MASK1    EQU   X'FF'                                                    56500021
DCBDEBAD EQU   44                      DISP IN DCB FOR DEB ADDR  A33619 56510021
DEBDCBAD EQU   24                      DISP IN DEB FOR DCB ADDR  A33619 56520021
DEBNMEXT EQU   16                      DISP IN DEB FOR NUMBER OF A33619 56530021
*                                      EXTENTS                   A33619 56540021
UNITINDX EQU   28                      DISP TO UNIT INDEX IN DECBA33619 56550021
ZERO     EQU   0                       DISPLACEMENT              A33619 56560021
ONE      EQU   1                       LENGTH OF UNIT INDEX ENTRYA33619 56570021
         CNOP  0,8                                                      56600021
*DUMMY SECTIONS                                                         56700021
DECB     DSECT                                                          56800021
         DS    F                                                        56900021
TYPE     DS    F                                                        57000021
DCBAD    DS    F                                                        57100021
AREADR   DS    F                                                        57200021
         DS    F                                                        57300021
OCBP     DS    CL2                                                      57400021
LENGTH   DS    CL2                                                      57500021
START    DS    F                                                        57600021
BUFFER   DS    F                                                        57700021
*                                                                       57800021
*                                                                       57900021
OACB     DSECT                                                          58000021
SLOA     DS    F                                                        58100021
         DS    2F                                                       58200021
CRSA     DS    F                                                        58300021
OLP      DS    F                                                        58400021
BLP      DS    F                                                        58500021
         END                                                            58600021
./  ADD  SSI=80300146,NAME=IGG019OB
CEAF     TITLE 'GRAPHIC ACCESS METHOD CHANNEL END AND EXCEPTIONAL CHANN-00020021
               EL END MODULE'                                           00040021
*********************************************************************** 00060021
*                                                                     * 00080021
*        GRAPHIC CHANNEL END AND EXCEPTIONAL CHANNE END APPENDAGE     * 00100021
*                                                                     * 00120021
*STATUS CHANGE LEVEL 1                                                  00140021
*                                                                     * 00160021
* FUNCTION:                                                           * 00180021
*        CHANNEL END                                                  * 00200021
*            1 IF THE DEVICE IS A FILM UNIT GO TO 5, ELSE GO TO 2.    * 00220021
*            2 IF GIOCR IS WAITING FOR AN IOB, POST THE SPECIAL ECB   * 00240021
*              AND GO TO 3.                                           * 00260021
*            3 TURN OFF THE AVAILABILITY BIT IN THE IOB AND GO TO 4.  * 00280021
*            4 NORMAL RETURN TO I/O SUPERVISOR.                       * 00300021
*            5 TURN OFF THE DEVICE END POST FLAG AND GO TO 2.         * 00320021
*        ABNORMAL END APPENDAGE                                       * 00340021
*            1 IF GRAPHIC DEVICE PERFORMING VARIABLE LENGTH INPUT     * 00360021
*              COMMAND HAS CAUSED INCORRECT LENGTH STATUS, RETRIEVE   * 00380021
*              RESIDUAL COUNT AND GO TO 3,  OTHERWISE GO TO 2.        * 00400021
*            2 IF FILM UNIT WITH PERMANENT ERROR CONDITION, ESTABLISH * 00420021
*              STATUS INDICATOR POINTER AND GO TO 3, ELSE GO TO 3.    * 00440021
*            3 GO TO CHANNEL-END-FUNCTION-2.                          * 00460021
*                                                                     * 00480021
* ENTRY POINT: IGG019OB, CEAPPEND VIA BALR IN IOS                     * 00500021
*                                                                     * 00520021
* INPUT  USE OF REGISTERS OF IOS                                   3574 00523021
*                                                                  3574 00526021
*              IN REGISTER  1 TWELVE STAR ADDRESS (RQE) IF THERE   3574 00529021
*                                           IS ONE                 3574 00532021
*              IN REGISTER  2 IOB ADDRESS                          3574 00535021
*              IN REGISTER  3 DEB ADDRESS                          3574 00538021
*              IN REGISTER  4 DCB ADDRESS                          3574 00541021
*              IN REGISTER  6 UNIT ADDRESS                         3574 00544021
*              IN REGISTER  7 UCB ADDRESS                          3574 00547021
*              IN REGISTER 14 RETURN ADDRESS TO IOS                3574 00550021
*              IN REGISTER 15 ENTRY POINT ADDRESS OF APPENDAGE     3574 00553021
*                                                                     * 00560021
* OUTPUT: N/A                                                         * 00580021
*                                                                     * 00600021
* EXTERNAL ROUTINES: N/A                                              * 00620021
*                                                                     * 00640021
* EXITS  NORMAL RETURN TO IOS                                      3574 00660021
*                                                                     * 00680021
* TABLE: N/A                                                          * 00700021
*                                                                     * 00720021
* WORK AREA: N/A                                                      * 00740021
*                                                                     * 00760021
* ATTRIBUTES: PROBLEM PROGRAM RESIDENCE, SUPERVISOR ENTERED           * 00780021
*                                                                     * 00800021
* NOTES: N/A                                                          * 00820021
*                                                                     * 00840021
*2928,005400,006600,014800,015200-016400,017600-020800,            3574 00845021
*     022000-022400,024800-027200,029400,031000-033600,            3574 00850021
*     039000-039200,039800-040000                                  3574 00855021
*                                                                       00856021
*1933,010660,010720                                            PTM 2173 00857021
* 014400,014700,015180-015480,022600-030800                       AOS/1 00858021
* A19800-20200,C21000,D21600                                    YA03230 00858400
* A11900,C38800,A38802-38818,C39330                         D11 ZA15423 00858800
*A010420-010440,A11820-11880,A12140-12141,C16265            E12 ZA26484 00859200
*A16270-16520,A17400,C17702,A17750,C17760-17850             E12 ZA26484 00859600
*D039330,A039360                                            E12 ZA29494 00859700
*C010800,C011600,A011801,D012600,A013002-013010,A039340     E12 ZA29656 00859800
*********************************************************************** 00860021
*                                                                       00880021
*                                                                       00900021
*       THESE ARE THE SYMBOLIC REGISTERS                                00920021
*                                                                       00940021
REG0     EQU   0                                                        00960021
REG1     EQU   1                                                        00980021
RIOB     EQU   2                                                        01000021
RDEB     EQU   3                                                        01020021
RDCB     EQU   4                                                        01040021
RWORK    EQU   5                                            E12 ZA26484 01046000
RTCB     EQU   6                                            E12 ZA26484 01052000
RUCB     EQU   7                                                        01060021
RBASE    EQU   9                       BASE ADDRESS         E12 ZA29656 01070000
REG10    EQU   10                                                       01100021
REG11    EQU   11                                                       01120021
REG12    EQU   12                                                       01140021
RCCW     EQU   12                       CHANNEL COMMAND WORD   PTM 2173 01146021
*                                       REGISTER               PTM 2173 01152021
RSAVE    EQU   13                      SAVE AREA ADDRESS    E12 ZA29656 01156000
RRETRN   EQU   14                                                       01180021
RENTRY   EQU   15                      ENTRY ADDRESS        E12 ZA29656 01182000
*                   DISPLACEMENTS FOR CVT,TCB               E12 ZA26484 01184000
CVTPTR   EQU   16                      CVT ADDRESS          E12 ZA26484 01188000
TCBPTR   EQU   0                       CVT DOUBLE WORD      E12 ZA26484 01192000
CURRTCB  EQU   4                       ADDRESS CURR TCB     E12 ZA26484 01196000
*                                                                       01200021
*                                                                  3574 01200221
*                                                                  3574 01200421
*                  IOB DISPLACEMENTS                               3574 01200621
*                                                                  3574 01200821
*                                                                  3574 01201021
SENSE2   EQU   3                       SECOND SENSE BYTE           3574 01201221
ECBCODE  EQU   4                       EVENT CONTROL BLOCK POST    3574 01201421
*                                      CODE                        3574 01201621
STATUS   EQU   12                      FIRST BYTE OF CHANNEL       3574 01201821
*                                      STATUS WORK                 3574 01202021
STATUS2  EQU   13                      SECOND BYTE OF CHANNEL      3574 01202221
*                                      STATUS WORK                 3574 01202421
CSWCOUNT EQU   14                      BYTE COUNT FIELD OF CHANNEL 3574 01202621
*                                      STATUS WORK                 3574 01202821
CCWSTAD  EQU   16                       CHANNEL COMMAND START      3574 01203021
*                                       ADDRESS AT TOP OF THE      3574 01203221
*                                       CHAIN                      3574 01203421
IOBCOUNT EQU   30                      ERROR RECOVERY FIELD USED   3574 01203621
*                                      FOR COMMUNICATION BETWEEN   3574 01203821
*                                      THE ABNORMAL END APPENDAGE  3574 01204021
*                                      AND THE ERROR RECOVERY      3574 01204221
*                                      PROGRAM                     3574 01204421
*                                                                  3574 01204621
*                                                                  3574 01204821
*                     CHANNEL COMMAND WORD FIELDS AND FLAGS        3574 01205021
*                                                                  3574 01205221
COMMCODE EQU   0                        CHANNEL COMMAND WORD       3574 01205421
*                                       COMMAND CODE DISPLACEMENT  3574 01205621
CCWFLAGS EQU   4                        CHANNEL COMMAND WORD FLAG  3574 01205821
*                                       FIELD DISPLACEMENT         3574 01206021
CMDCHAIN EQU   X'40'                    COMMAND CHAINING BIT OF    3574 01206221
*                                       CHANNEL COMMAND WORD       3574 01206421
*                                                                  3574 01206621
*                   UNIT CONTROL BLOCK DISPLACEMENTS               3574 01206821
*                                                                  3574 01207021
UNITTYPE EQU   19                      UNIT TYPE FIELD             3574 01207221
*                  UNIT TYPE MASKS                                 3574 01207421
A2250    EQU   X'02'                   2250 TYPE CODE              3574 01207621
A2260    EQU   X'03'                   2260 TYPE CODE              3574 01207821
*                                                                  3574 01208021
*                                                                  3574 01208221
*                        DATA EVENT CONTROL BLOCK DISPLACEMENTS    3574 01208421
*                                                                  3574 01208621
STATUSPT EQU   16                       STATUS INDICATOR POINTER   3574 01208821
*                                       (IOB)                      3574 01209021
*                                                                  3574 01209221
IOSERFG  EQU   44                      IOS ERROR FLAGS             3574 01209421
*                   FLAG MEANING                                   3574 01209621
ERRCRT   EQU   X'40'                   ERROR CORRECTION IN         3574 01209821
*                                      PROGRESS                    3574 01210021
PECOND   EQU   X'80'                   PERMANENT ERROR CONDITION   3574 01210221
*                                      EXISTS                      3574 01210421
*                                                                  3574 01210621
*                   CHANNEL STATUS WORD STATUS MASKS               3574 01210821
*                                                                  3574 01211021
ATTN     EQU   X'80'                   ATTENTION                   3574 01211221
INCLNGTH EQU   X'40'                   INCORRECT LENGTH            3574 01211421
UNITCK   EQU   X'02'                   UNIT CHECK                  3574 01211621
ATTNUC   EQU   ATTN+UNITCK             ATTENTION PLUS UNIT CHECK   3574 01211821
ICC      EQU   X'02'              INTERFACE CONTROL CHECK          3574 01212021
*                                      CSW INDICATOR               3574 01212221
CCC      EQU   X'04'              CHANNEL CONTROL CHECK            3574 01212421
*                                      CSW INDICATOR               3574 01212621
CDC      EQU   X'08'              CHANNEL DATD CHECK               3574 01212821
*                                      CSW INDICATOR               3574 01213021
CHNLERR  EQU   ICC+CCC+CDC        CHANNEL ERROR CONDITIONS         3574 01213221
*                                 STATUS INDICATORS                3574 01213421
*                                                                  3574 01213621
*                   OTHER MASKS                                    3574 01213821
XFF      EQU   X'FF'                   ALL ONES BYTE MASK   E12 ZA26484 01214000
ZEROMASK EQU   X'00'                   ALL ZEROS BYTE MASK         3574 01214221
ZERO     EQU   0                       A VALUE OF ZERO             3574 01214421
ANEIGHT  EQU   8                        DISPLACEMENT VALUE OF 8    3574 01214621
PRMERR   EQU   X'02'                   PERMANENT ERROR FLAG IN     3574 01214821
*                                      IOB ERROR COUNT FIELD       3574 01215021
ERPENTRY EQU   X'01'                    ERP HAS BEEN ENTERED       3574 01215221
*                                       INDICATOR                  3574 01215421
PRMERRCD EQU   X'41'                   PERMANNNT I/O ERROR CODE    3574 01215621
*                                      TO BE PLACED IN ECB CODE    3574 01215821
*                                      FIELD                       3574 01216021
NOERRORS EQU   X'7F'                    SUCCESSFUL COMPLETION OF   3574 01216221
*                                       I/O                        3574 01216421
*                   READ COMMAND                                   3574 01216621
READCUR  EQU   X'06'                   GREAD COMMAND CODE FOR      3574 01216821
*                                      READ TO CORSOR TYPE ON      3574 01217021
*                                      2250                        3574 01217221
HEX04    EQU   X'04'                   HEX VALUE OF FOUR    E12 ZA26484 01217400
         EJECT                                                     3574 01218200
IGG019OB CSECT                                                          01220021
         ENTRY CEAPPEND                                                 01240021
         USING *,RBASE                                                  01300021
CEAPPEND EQU   *                                            E12 ZA29656 01303000
         STM   REG0,RENTRY,ZERO(RSAVE) SAVE IOS REGS        E12 ZA29656 01306000
         LR    RBASE,RENTRY             SET UP BASE REG     E12 ZA29656 01309000
         B     BEGIN                   BRANCH AROUND ID     E12 ZA29656 01312000
MODID    DC    C'IGG019OB.VS2R3.&SYSDATE'  MODULE ID        E12 ZA29656 01315000
*                                                                       01320021
*       IF ABNORMAL CHANNEL END, TEST FOR INCORRECT LENGTH AND          01340021
*       TURN ON OR OFF APPROPIATE BITS FOR THE ERROR ROUTINE RETRY      01360021
*       CHECKING FOR 2250 AND 2260 ERROR CONDITIONS                     01380021
*                                                                       01400021
BEGIN    TM    0(RIOB),X'04'            TEST IOB EXCEPTION BIT          01420000
         BZ    OHAIOB                  NORMAL CHANNEL END         AOS/1 01440021
         TM    30(RIOB),X'02'           TEST FOR ABNORMAL END APPEND.   01460021
         BO    OHAIOB                  PERMANENT ERROR SET BY ERP AOS/1 01470021
         OI    30(RIOB),X'02'           TURN ON AEA BIT                 01500021
         TM    STATUS2(RIOB),CHNLERR   WAS THERE AN ERROR IN THE   3574 01506021
*                                      CHANNEL                     3574 01512021
         BNZ   OHARTN                  CHANNEL ERROR-GO TO ERP    AOS/1 01518021
CKUNITCK TM    STATUS(RIOB),UNITCK      WAS THE ERROR IN THE UNIT  3574 01554021
         BZ    ZEROSNSE                NO TAKE BRANCH              3574 01560021
         TM    SENSE2(RIOB),XFF         DID SENSE FAIL      E12    3574 01566000
         BNO   TST2260                 IF DID NOT FAIL TAKE BRANCH 3574 01572021
ZEROSNSE NI    SENSE2(RIOB),ZEROMASK        ZERO OUT SECOND SENSE  3574 01578021
*                                      BYTE                        3574 01584021
TST2260  CLI   UNITTYPE(RUCB),A2260          IS DEVICE A 2260      3574 01590021
         BNE   OHALPD                  IF NOT TAKE BRANCH          3574 01596021
         TM    STATUS(RIOB),UNITCK     WAS THE ERROR IN THE UNIT   3574 01602021
         BO    OHARTN                  YES TAKE BRANCH             3574 01608021
         CLI   STATUS2(RIOB),INCLNGTH        WAS ERROR INCORRECT   6574 01614021
*                                      LENGTH ONLY                 3574 01620021
         BNE   OHARTN                  IF NOT TAKE BRANCH          3574 01626021
STORECSW EQU   *                                            E12 ZA26484 01627000
         USING IHADCB,RDCB             DCB ADDRESSIBILITY   E12 ZA26484 01628000
         USING TCB,RTCB                TCB ADDRESSIBILITY   E12 ZA26484 01629000
         L     RTCB,CVTPTR             GET CVT ADDR         E12 ZA26484 01630000
         L     RTCB,TCBPTR(RTCB)       GET DBLWRD ADDR      E12 ZA26484 01632000
         L     RTCB,CURRTCB(RTCB)      GET CURRENT TCB      E12 ZA26484 01639000
         LH    REG10,CSWCOUNT(RIOB)    COUNT FROM IOB CSW   E12 ZA26484 01646000
         L     REG11,4(0,RIOB)          ECB ADDRESS FROM IOB            01660021
         LA    REG11,0(0,REG11)         DROP HIGH ORDER BYTE            01680021
         MODESET  EXTKEY=TCB,WORKREG=5                      E12 ZA26484 01700000
         ST    REG10,16(0,REG11)        COUNT IN DECB                   01750000
         MVI   16(REG11),X'43'          INCORRECT LENGTH CODE TO DECB   01760000
CLRDCBFG NI    DCBIFLGS,XFF-DCBIFEC             RESET IOS   E12 ZA26484 01770000
*                                        ERROR FLAGS IN DCB E12 ZA26484 01771000
         MODESET  EXTKEY=SUPR          RETURN TO KEY ZERO   E12 ZA26484 01772000
         NI    0(RIOB),XFF-HEX04     TURN OFF IOB EXEC BIT  E12 ZA26484 01773000
         MVI   ECBCODE(RIOB),NOERRORS  SET IOBECBCC TO      E12 ZA26484 01774000
*                         INDICATE SUCCESSFUL OPERATION     E12 ZA26484 01780000
         B     OHAIOB                  GO RELEASE IOB       E12 ZA26484 01783000
OHALPD   CLI   UNITTYPE(RUCB),A2250         IS DEVICE A 2250       3574 01790021
         BNE   OHARTN                  IF NOT TAKE BRANCH          3574 01800021
         CLI   STATUS(RIOB),ATTNUC     IS STATUS ATTENTION PLUS    3574 01810021
*                                      UNIT CHECK                  3574 01820021
         BE    OHAOFF                  IF YES TAKE BRANCH          3574 01830021
         TM    STATUS(RIOB),UNITCK     WAS THE ERROR IN THE UNIT   3574 01840021
         BO    OHARTN                  IF YES TAKE BRANCH          3574 01850021
         CLI   STATUS2(RIOB),INCLNGTH        WAS ERROR INCORRECT   3574 01860021
*                                      LENGTH ONLY                 3574 01870021
         BNE   OHARTN                  IF NOT TAKE BRANCH          3574 01880021
         L     RCCW,CCWSTAD(RIOB)      GET CCW START ADDRESS       3574 01890021
         TM    CCWFLAGS(RCCW),CMDCHAIN       IS FIRST COMMAND      3574 01900021
*                                      CHAINED TO THE SECOND       3574 01910021
         BZ    OHARTN                  IF NOT TAKE BRANCH          3574 01920021
         LA    RCCW,ANEIGHT(RCCW)      GET NEXT CCW ADDRESS        3574 01930021
         CLI   COMMCODE(RCCW),READCUR        WAS COMMAND READ      3574 01940021
*                                       TO CURSOR                  3574 01950021
         BNE   OHARTN                  IF NOT TAKE BRANCH          3574 01960021
         B     STORECSW                GO STORE COUNT INTO DECB    3574 01970021
OHAOFF   EQU   *                                                YA03230 01980000
         NI    0(RIOB),XFF-HEX04       RESET IOB EXCEPT BIT E12 ZA26484 02020000
         TM    3(RIOB),X'80'            LIGHT PEN               YA03230 02100000
         BZ    OHARTN                                       E12 ZA26484 02120000
*          ONE LINE DELETED BY APAR-------------------->    E12 ZA26484 02180000
*                                                                     * 03380021
*       NORMAL CHANNEL END FOR RELEASE OF IOB AND POSTING COMPLETE      03400021
*       IF GIOCR WAITING FOR AN AVAILABLE IOB                           03420021
*                                                                       03440021
*        TEST IF GIOCR WAITING FOR IOB TO BECOME AVAILABLE            * 03460021
*                                                                     * 03480021
OHAIOB   L     REG11,28(0,RDCB)         FIRST IOB ADDRESS               03500021
         S     REG11,FOUR               ECB ADDRESS                     03520021
         TM    0(REG11),X'80'           TEST IF WAITING IN GIOCR        03540021
         BZ    OHANEXT                                                  03560021
*                                                                     * 03580021
*        POST WAITING ECB BY GIOCR COMPLETE                           * 03600021
*                                                                     * 03620021
         SR    REG10,REG10              SET COMPLETION CODE TO ZERO     03640021
         L     REG12,0(RDEB)            PLACE TCB ADDRESS               03660021
         L     15,16(0,REG10)           CVT ADDRESS                     03680021
         L     15,152(0,15)             POST ROUTINE                    03700021
         LR    RIOB,RRETRN              SAVE RETURN ADDRESS             03720021
         BALR  14,15                    POST ROUTINE                    03740021
         LR    RRETRN,RIOB              RESTORE RETURN ADDR             03760021
         L     RIOB,4(0,REG1)           RESTORE RIOB REG                03780021
*                                                                     * 03800021
*        TURN OFF NON-AVAILABLE BIT IN IOB WHICH WILL MAKE THIS       * 03820021
*        IOB NOW AVAILABLE                                            * 03840021
*                                                                     * 03860021
OHANEXT  S     REG11,FOUR          BACK UP TO IOB SAVEWORD  D11 ZA15423 03861000
         L     REG10,0(REG11)      AND LOAD ADR OF SAVED IOBD11 ZA15423 03862000
         LTR   REG10,REG10         IS THERE A PREVIOUS IOB? D11 ZA15423 03863000
         BZ    NOIOB               NO,SAVE CURR-DONT FREE   D11 ZA15423 03864000
         L     REG12,28(0,RDCB)    ADDR 1ST IOB FROM DCB    D11 ZA15423 03865000
CHKIOB   CLM   REG12,7,1(REG11)   DCBCHAIN IOB EQ SAVED IOB?D11 ZA15423 03866000
         BE    MAKAVAIL            YES,MAKE SAVED IOB AVAIL D11 ZA15423 03867000
         L     REG12,36(REG12)     POINT TO NEXT CHAINIOB   D11 ZA15423 03868000
         LTR   REG12,REG12         ANY MORE IOBS ON CHAIN?  D11 ZA15423 03869000
         BZ    NOIOB               NO,GO SAVE CURRENT       D11 ZA15423 03870000
         B     CHKIOB              YES,GO CHECK NEXT IOB    D11 ZA15423 03871000
MAKAVAIL NI    36(REG10),X'00'     FREE SAVED (FOUND) IOB   D11 ZA15423 03872000
NOIOB    ST    RIOB,0(REG11)       SAVE CURIOB IN IOBSAVEWD D11 ZA15423 03873000
*                                  CLEAR PERMANENT ERROR AND       3574 03880000
*                                  ERP ENTRY FLAGS IN              3574 03882000
*                                  IOB ERROR COUNT FIELD           3574 03882700
         NI    IOBCOUNT(RIOB),XFF-PRMERR-ERPENTRY           E12    3574 03883400
*                                                                  3574 03885021
*              ERP HAS THE RESPONSIBILITY FOR TURNING OFF          3574 03886000
*              ALL OTHER FLAGS IN THE IOB ERROR COUNT FIELD.       3574 03886600
*                                                                  3574 03888021
*                                                                  3574 03889021
*                                                                  3574 03890021
*              THE APPENDAGE WILL BE ENTERED TWICE FOR AN ERROR    3574 03891021
*              RECOVERY PROCESS ONCE AT IOS FINDING THE ERROR      3574 03892021
*              CONDITION AND THE SECOND JUST BEFORE IOS GOES TO    3574 03893021
*              POST THE PROBLEM PROGRAM ON COMPLETION OF I/O.      3574 03894021
*              THE APPENDAGE HAS THE RESPONSIBILITY OF FINDING OUT 3574 03895000
*              IF THE INCORRECT LENGTH ON A READ OPERATION IS A    3574 03896021
*              VALID ERROR OR EXPECTED.                            3574 03897021
*              A PROBLEM ARISES WITH THE ERP ABILITY TO RECOVER    3574 03898000
*              FROM CHANNEL ERRORS BUT STILL HAVE INCORRECT LENGTH.3574 03899021
*              THE ERP MUST LET THE APPENDAGE KNOW THAT THERE IS AN3574 03900000
*              ERROR CONDITION THAT MIGHT BE EXPECTED.             3574 03901021
*                                                                  3574 03902021
*              SO THE ERP HAS BEEN MODIFIED TO TREAT THE           3574 03903021
*              INCORRECT LENGTH AS A PERMANENT ERROR BUT TO        3574 03904000
*              LET THE APPENDAGE HAVE THE LAST TRY AT CHECKING     3574 03904800
*              THE ERROR OVER AND INDICATING THAT THERE IS NOT     3574 03905600
*              AN ERROR CONDITION.                                 3574 03906400
*              THIS IS DONE BY THE ERP BIT SETTINGS SWITCHES IN    3574 03908021
*              THE IOB ERROR COUNT FIELD IN THE FIRST BYTE , THE   3574 03909021
*              LAST TWO BITS AND THE IOB FLAGS 2 FIELD             3574 03910021
*              THE MAIN INTENT IS SO THAT THE APPENDAGE WILL       3574 03911000
*              KNOW THAT THE ERP HAS CHECKED OVER THE ERROR        3574 03912021
*              CONDITION SO WHEN THE APPENDAGE RETURNS TO IOS THE  3574 03913021
*              ERROR RECOVERY IS OVER AND THE IOB MUST BE PLACED   3574 03914021
*        BACK ON TO THE FREE LIST TO KEEP FROM BEING LOST OR       3574 03915021
*        HAVING GAM IN THE WAIT STATE WAITING ON THE IOB.          3574 03916021
*                                                                  3574 03917021
*              THE BIT SETTINGS AND THERE MEANING ARE              3574 03918021
*                  IOB ERROR COUNT FIELD IN HEX                    3574 03919021
*                                                                  3574 03920021
*              '00'     NORMAL CHANNEL END NO ERROR                3574 03921021
*                       RECOVERY DONE                              3574 03922021
*                  '03'   PERMANENT ERROR FOUND BY ERP             3574 03923000
*                        IOB EXECPTION BIT WILL BE ON ALSO         3574 03924021
*                   '01'   ERP HAS BEEN ENTERED SO IOB MUST BE     3574 03925000
*                          FREED                                   3574 03926021
*                          WITH IOB EXCEPTION BIT ON THERE COULD   3574 03927000
*                                 BE AN ERROR CONDITION            3574 03927600
*                                      WITH IOB EXECPTION BIT OFF  3574 03929021
*                                      ERROR RECOVERY SUCCESSFUL   3574 03930021
OHARTN   TM    IOBCOUNT(RIOB),ERPENTRY       HAS ERP BEEN ENTERED  3574 03931021
         BO    OHAIOB                  YES GO FREE IOB             3574 03932021
         LM    REG0,RENTRY,ZERO(RSAVE)  RESTORE REGS        E12 ZA29656 03933000
         BR    RRETRN           RETURN TO IOS               E12 ZA29498 03935000
*                                                                       03940021
FOUR     DC    F'4'                                                     03960021
*                                                                       04020021
         CNOP  0,8                                                      04040021
         IKJTCB                                             E12 ZA26484 04046000
         IHADCB                                             E12 ZA26484 04052000
         END                                                            04060021
./  ADD  SSI=61760130,NAME=IGG019OC
         TITLE 'IGG019OC - GRAPHICS PAGE FIX APPENDAGE'                 00900000
*********************************************************************** 01800000
*                                                                     * 02700000
*                   GRAPHIC PAGE FIX APPENDAGE                        * 03600000
*                                                                     * 04500000
* STATUS CHANGE LEVEL: 0                                              * 05400000
*                                                                     * 06300000
* FUNCTION: RETURN THE VIRTUAL BOUNDS OF THE 'DECB' IN THE IOS PAGE   * 07200000
*           FIX WORK AREA TO BE FIXED BY IOS IN ORDER TO PREVENT      * 08100000
*           PAGING EXCEPTIONS FROM OCCURRING IN THE CE-XCE APPENDAGE  * 09000000
*           AND IN THE 2250/2260 ERP.                                 * 09900000
*                                                                     * 10800000
* ENTRY POINT: IGG019OC VIA BALR 14,15+4 IN IOS                       * 11700000
*                                                                     * 12600000
* INPUT: REG2:  ADDRESS OF THE INPUT/OUTPUT BLOCK (IOB)               * 13500000
*        REG10: IOS SEVEN DOUBLEWORDS WORK AREA.                        14400000
*                                                                     * 15300000
* OUTPUT:REG10: ADDRESS OF THE FIRST ENTRY IN THE IOS WORK AREA       * 16200000
*        REG11: NUMBER OF ENTRIES PUT INTO THE WORK AREA              * 17100000
*                                                                     * 18000000
*        EACH ENTRY IN THE IOS PAGE FIX WORK AREA IS EIGHT BYTES IN   * 18900000
*        LENGTH:                                                      * 19800000
*                                                                     * 20700000
*              BYTE   BIT     MEANING                                 * 21600000
*                                                                     * 22500000
*              0              MUST BE ZERO                            * 23400000
*              1-3            START VIRTUAL ADDR OF AREA TO BE FIXED  * 24300000
*              4      0       IF ON INDICATES LAST ENTRY              * 25200000
*              5-7            END VIRTUAL ADDR OF AREA TO BE FIXED + 1* 26100000
*                                                                     * 27000000
* EXTERNAL ROUTINES: N/A                                              * 27900000
*                                                                     * 28800000
* EXITS: NORMAL                                                       * 29700000
*                                                                     * 30600000
* TABLES: N/A                                                         * 31500000
*                                                                     * 32400000
* WORK AREAS: N/A                                                     * 33300000
*                                                                     * 34200000
* ATTRIBUTES: PROBLEM PROGRAM RESIDENT, SUPERVISOR ENTERED            * 35100000
*                                                                     * 36000000
* NOTES: 20 BYTES X'FF' LABELLED PATCH  RESERVED FOR MAINTENANCE      * 36900000
*                                                                     * 37800000
*********************************************************************** 38700000
         SPACE 3                                                        39600000
*A622000-628000,A901000-908000                              D11 ZA10012 40500000
         SPACE 3                                                        41400000
         EJECT                                                          42300000
*                                                                       43200000
*                                                                       44100000
*              REGISTERS USED IN THIS ROUTINE                           45000000
*                                                                       45900000
*                                                                       46800000
RIOB     EQU   2                        ADDRESS OF IOB                  47700000
RWRKAREA EQU   10                       ADDRESS OF IOS WORK AREA        48600000
RENTRIES EQU   11                       NUMBER OF ENTRIES IN WORK AREA  49500000
RWORK    EQU   11                       WORK REGISTER                   50400000
RRETURN  EQU   14                       RETURN REGISTER                 51300000
*                                                                       52200000
*                                                                       53100000
*              EQUATES                                                  54000000
*                                                                       54900000
*                                                                       55800000
ZERO     EQU   0                                                        56700000
ONE      EQU   1                                                        57600000
TWO      EQU   2                                            D11 ZA10012 58500000
FOUR     EQU   4                                                        59400000
EIGHT    EQU   8                                            D11 ZA10012 60300000
TWELVE   EQU   12                                           D11 ZA10012 61200000
TWENTY   EQU   20                                           D11 ZA10012 62100000
TWENTY8  EQU   28                                           D11 ZA10012 63000000
THIRTWO  EQU   32                                                       63900000
X80      EQU   X'80'                                                    64800000
*                                                                       65700000
*                                                                       66600000
IGG019OC CSECT                                                          67500000
*                                                                       68400000
*        SINCE GAM DOES NOT HAVE AN SIO APPENDAGE, THE FIRST 4 BYTES    69300000
*        OF THE PAGE FIX APPENDAGE WILL CONTAIN A BR 14 TO CAUSE NORMAL 70200000
*        PROCESSING OF THE I/O REQUEST TO CONTINUE                      71100000
*                                                                       72000000
         BR    RRETURN                  RETURN TO IOS                   72900000
         DC    X'0000'                                                  73800000
*                                                                       74700000
*        PAGE FIX APPENDAGE ROUTINE                                     75600000
*                                                                       76500000
         L     RWORK,FOUR(RIOB)         ADDRESS OF ECB IN IOB           77400000
         LA    RWORK,ZERO(RWORK)        CLEAR HIGH ORDER BYTE           78300000
*                                                                       79200000
*        BECAUSE THE ECB IS THE FIRST WORD OF THE DECB, THIS IS THE     80100000
*        STARTING VIRTUAL ADDRESS OF THE AREA TO BE FIXED               81000000
*                                                                       81900000
         ST    RWORK,ZERO(RWRKAREA)     STORE IN IOS WORK AREA          82800000
*                                                                       83700000
*        THE DECB IS 32 BYTES LONG. DECB+32 SHOULD BE THE ENDING        84600000
*        VIRTUAL ADDRESS OF THE AREA TO BE FIXED PLUS ONE               85500000
*                                                                       86400000
         LA    RWORK,THIRTWO(RWORK)     DECB + 32                       87300000
         ST    RWORK,FOUR(RWRKAREA)     STORE IN IOS WORK AREA          88200000
         L     RWORK,TWENTY(RIOB)  POINT TO DCB             D11 ZA10012 89100000
         L     RWORK,TWENTY8(RWORK)  POINT BACK TO 1ST IOB  D11 ZA10012 90000000
         BCTR  RWORK,0             MAKE SURE PAGE FIXED     D11 ZA10012 90900000
         ST    RWORK,EIGHT(RWRKAREA) SAVE START 1STIOB      D11 ZA10012 91800000
         LA    RWORK,47(RWORK)     BUMP TO END ADDR         D11 ZA10012 92700000
         ST    RWORK,TWELVE(RWRKAREA) SAVE END 1STIOB       D11 ZA10012 93600000
         OI    TWELVE(RWRKAREA),X80     INDICATE LAST ENTRY D11 ZA10012 94500000
         LA    RENTRIES,TWO        SET R11 W NUMENTRIES     D11 ZA10012 95400000
         BR    RRETURN                  RETURN TO IOS                   96300000
PATCH    DS    0F                                           D11         97200000
         DC    20X'FF'                 MAINTENANCE SPACE    D11         98100000
         END                                                            99000000
./  ADD  SSI=72360083,NAME=IGG019OE
         TITLE 'GRAPHIC ATTENTION ROUTING ROUTINE'                      00020002
**********************************************************************  00032002
*                                                                       00034002
* MODULE NAME:            IGG019OE (OS/VS2)                             00036002
*                                                                       00038002
* DESCRIPTIVE NAME:       GRAPHIC ATTENTION ROUTING ROUTINE             00038402
*                                                                       00038802
* COPYRIGHT:              NONE                                          00039202
*                                                                       00039602
* STATUS:                 RELEASE 2.0                                   00039702
*                                                                       00039802
*                                                                       00039902
*******FILL IN FROM SPECS*****CONTINUED* NEXT*PAGE********************  00046602
         EJECT                                                          00048602
*FUNCTION:SECOND LEVEL GRAPHIC ATTENTION HANDLING MODULE.               00060002
*        1.DECODE ATTENTION TYPE.                                       00080002
*        2.PROVIDE MI DATA ON 2250 KEYBOARD(A/N OR PF)ATTENTIONS.       00100002
*        3.PROVIDE XY BEAN POSITION REGISTER READOUT ON LP ATTENTIONS.  00120002
*        4.PROVIDE BUFFER RESTART ON LP ATTENTION IF USER REQUESTS IT.  00140002
*        5.QUEUE DATA ON ATTENTION ROUTINE THAT IS:                     00160002
*         A.ACTIVE FOR THAT DEVICE.(ROUTINE MAY BE IN WAIT STATE.IF THE 00180002
*           ROUTINE DESIRES A PARTICULAR ATTENTION IT WILL BE POSTED.)  00200002
*         B.WILL BECOME ACTIVE SOONEST FOR THAT DEVICE IF:ALREADY HAS   00220002
*           DATA ON ITS INTERNAL QUEUE WAITING TO BE DISPATCHED.        00240002
*         C.DESIRES THE ATTENTION TYPE.                                 00260002
*         D.IF THE ATTENTION IS UNABLE TO SATISFY A,B OR C IT IS        00280002
*           DISCARDED.                                                  00300002
*        6.SCHEDULE THIRD LEVEL GRAPHIC CONTROL PROGRAM.                00320002
*ENTRY POINT:SCHEDULED BY PRIMARY GRAPHIC CONTROL PROGRAM VIA AN        00340002
*        IQE TO AEE STAGE II.                                           00360002
*INPUT:1.GR#0=IQE ADDRESS                                               00380002
*      2.GR#1=UCB ADDRESS AND STATUS BITS 32-39.                        00400002
*      3.GR#S13,14,15 AS PER CONVENTIONS.                               00420002
*OUTPUT:IQE TO AEE STAGE II TO SCHEDULE THIRD LEVEL CONTROL PROGRAM.    00440002
*       IQE CONTAINS THE DATA THAT WILL BE PLACED IN USER COMAREA.      00460002
*EXTERNAL ROUTINES:ASYNCHRONOUS EXIT EFFECTOR(AEE)STAGE TWO AND IOS.    00480002
*EXIT:VIA RETURN MACRO                                                  00500002
*TABLES/WORK AREAS:N/A                                                  00520002
*ATTRIBUTES:1.SUPERVISOR STATE                                          00540002
*           2.PRIVILEGED                                                00560000
*           3.RE-ENTRANT                                                00580002
*           4.OPERATES WITH AND WITHOUT LOCAL LOCK          D11         00600000
*NOTES:N/A                                                              00620002
IGG019OE CSECT                                                          00632002
*    SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE  00632102
*C025400                                                      LF YM4067 00632202
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  00632302
*A27115,A61060-61120,A64260-64320,A64630-64750,A75500,A89660  LI F40815 00634002
*C48000-48400,C52000,C61060,C64260                            LI A42794 00636002
*1708,065600-066000,084800,088000,089000-0892000                   0803 00638002
*D29665                                                       LI A39419 00638402
*C89720                                                       LI A39419 00638802
*1190,084700                                                   PTM 2173 00639202
* 087404                                                         A27773 00639602
*A16630-16660,A29710-30510,A65490-65510,A92810-92900             A34795 00639702
*C88000                                                          A34795 00639802
*D29695-30400                                                    A34795 00639902
*C91900,C92100-92300                                             A35022 00646602
*A29400                                                          A35022 00648602
* 042800-043200,065510,076800,079410,080040                   LB  AOS/1 00650602
*A068700,D087539,D087548                                        YM1901  00652602
*A051700                                                     LD YA00804 00653002
* A066900-066960,C067000,D067800-068000,A068500,D077000,     LD YA01555 00653102
* C078200,D079420-079440                                     LD YA01555 00653202
* A7900,A84490-84550,C84554                                      YM5683 00655202
*A27190,D30000,A30004-30008                                  LG Z30AALG 00655400
*A26500-26520,A26909-29627,A37500-37588                      LG @ZM2360 00655600
*A86900-86984,A87708-87749,A88000,A93020                     LG @ZM2360 00655800
*C30120,C43600,C55200,C57200,C58400,C68500                  LG @ZA00524 00656000
*C87408,C87416,C87432,C87448,C87498,C87548                  LG @ZA00524 00656200
*D68600-71000,D76000                                        LG @ZA00524 00656400
*A006700,037500-037720,086900-087130,087708-087740          D11 ZA13194 00656600
*A074760-074794,075300,093195-093197                        D11 ZA13195 00656800
*A087140-087150                                             D11 ZA13196 00657300
*                                                                       00659200
         EJECT                                                          00659302
PAR0     EQU   0                       PARAM REG 0                      00659702
PAR1     EQU   1                       PARAM REG 1                      00660002
R1       EQU   1  REFERENCE REG FOR GIOCR HAND-EXPANSIONS   D11 ZA13194 00670000
BASERG   EQU   2                       BASE REG                         00680002
MAINREG  EQU   3                       REG FOR WORK AREA DSECT          00700002
RIQE     EQU   4                       IQE ADR REG                      00720002
RTCB     EQU   4                       TCB REG                          00730002
RUCB     EQU   5                       UCB ADR REG                      00740002
REBRG    EQU   6                       REB ADR REG                      00760002
R7       EQU   7                       WORK REG                         00780002
RASCB    EQU   7                       ASCB REG                  YM5683 00790002
R8       EQU   8                       WORK REG                         00800002
R9       EQU   9                       WORK REG                         00820002
R10      EQU   10                      WORK REG                         00840002
R11      EQU   11                      WORK REG                         00860002
R12      EQU   12                      WORK REG                         00880002
SAVEREG  EQU   13                      SAVE AREA REG                    00900002
R14      EQU   14                      RTN REG                          00920002
R15      EQU   15                      RTN CODE REG                     00940002
         EJECT                                                          00950002
*                                                                       00960002
*        GACB CONSTRUCTION                                              00980002
*                                                                       01000002
COMAREA  EQU   0                       OFFSET TO COMAREA ADR            01020002
DCBADR   EQU   4                       OFFSET TO DCB ADR                01040002
PFKMSK   EQU   8                       OFFSET TO PFK MASK               01060002
ATNTYP   EQU   15                      OFFSET TO ATTENTION TYPE         01080002
EP1      EQU   16                      OFFSET TO ENTRY POINT ONE ADR    01100002
EP2      EQU   20                      OFFSET TO ENTRY POINT TWO ADR    01120002
SAVE13   EQU   24                      REG 13 SAVE AREA FOR R MODE      01140002
PFKEY    EQU   28                      FUNCTION KEY SAVE AREA           01160002
SAVETYP  EQU   32                      ATTN TYPE SAVE AREA              01180002
ECB      EQU   36                      EVENT CONTROL BLOCK FOR MODE W   01200002
REBADR   EQU   40                      ROUTINE ENTRY BLOCK ADR          01220002
GACBRSVD EQU   44                      RESERVED AREA                    01240002
*                                                                       01260002
*        COMAREA CONTRUCTION                                            01280002
*                                                                       01300002
COMRSVD1 EQU   0                       RESERVED                         01320002
COMOVCOD EQU   1                       OVERLAY CODE                     01340002
COMKEY   EQU   2                       PF KEY NUMBER                    01360002
COMTYPE  EQU   3                       ATTENTION TYPE                   01380002
SENSE    EQU   4                       SENSE AREA                       01400002
COMMI    EQU   4                       MANUAL INPUT AREA                01420002
XYPOS    EQU   8                       XY POSITION REGISTERS            01440002
COMRSVD3 EQU   12                      RESERVED                         01460002
*                                                                       01480002
*        COMAREA TYPE FIELD                                             01500002
*                                                                       01520002
ENDORANK EQU   X'01'                   END OR A/N KEYBOARD ATTENTION    01540002
PFKB     EQU   X'02'                   PF KEYBOARD ATTENTION            01560002
LP       EQU   X'03'                   LIGHT PEN ATTENTION              01580002
EOS      EQU   X'04'                   END ORDER SEQUENCE ATTENTION     01600002
CANCEL   EQU   X'05'                   CANCEL KEY ATTENTION             01620002
AE       EQU   X'06'                   ASYNCHRONOUS ERROR ATTENTION     01640002
A2260    EQU   X'07'                   2260 ATTENTION                   01660002
HEX82    EQU   X'82'              CSW STATUS BITS INDICATING A LIGHT    01663002
*                            PEN  ATTENTION                             01666002
         EJECT                                                          01670002
*                                                                       01680002
*        GACB ATTNTYP FIELD                                             01700002
*                                                                       01720002
GENAN    EQU   X'01'                   END OR A/N KEYBOARD ATTENTION    01740002
GLP      EQU   X'02'                   LIGHT PEN ATTENTION              01760002
GEOS     EQU   X'04'                   END ORDER SEQUENCE ATTENTION     01780002
GCANCEL  EQU   X'08'                   CANCEL KEY ATTENTION             01800002
GAE      EQU   X'10'                   ASYNCHRONOUS ERROR ATTENTION     01820002
T2260    EQU   X'20'                   2260 KEYBOARD ATTENTION          01840002
*                                                                       01860002
*                                                                       01880002
ANKBD    EQU   X'80'                   A/N BIT                          01900002
AT2260   EQU   X'03'                   TYPE=2260                        01920002
CANCELD  EQU   X'10'                   CANCEL KEY BIT                   01940002
COMPLETE EQU   X'7F'                   POST CODE                        01960002
CVTADR   EQU   16                      CVT  ADR                         01980002
ENDD     EQU   X'20'                   END KEY BIT                      02000002
EOSDET   EQU   X'40'                   END ORDER SEQUENCE BIT           02020002
FLAGS    EQU   X'40'                   TE PTR FLAG                      02040002
GACBADR  EQU   12                      GACB ADR                         02060002
IQELNK   EQU   0                       LINK FLD                         02080002
IQEPAR   EQU   4                       PARAM FLD                        02100002
IQEIRB   EQU   8                       IRD ADR FLD                      02120002
IQETCB   EQU   12                      TCB ADR FLD                      02140002
IQEDATA  EQU   16                      DATA FLD                         02160002
LPDET    EQU   X'80'                   LIGHT PEN BIT                    02180002
NEXAVL   EQU   96                      NEXT AVAILABLE  IQE  PTR         02200002
ONE      EQU   1                       ONE                              02220002
PFKBD    EQU   X'40'                   PF BIT                           02240002
RBIQE    EQU   24                      ADR OF FIRST INPUT IQE           02260002
RTNB     EQU   4                       HIGHER REB PTR                   02280002
RTNF     EQU   0                       PTR TO NEXT REB                  02300002
RTNFLG   EQU   20                      FLAG FLD                         02320002
RTNGACB  EQU   12                      GACB ADR                         02340002
RTNIRB   EQU   16                      IRB ADR                          02360002
RTNQ1    EQU   24                      EP=0  QUEUE FIELD           2575 02370002
RTNQ2    EQU   28                      Q2 LIST PTR                      02380002
REBTCB   EQU   33                      OFFSET TO TCB ADR IN REB         02400002
RTNUCB   EQU   8                       UCB PTR                          02420002
STAGE2   EQU   4                       STAGE 2 ADR                      02440002
TEREB    EQU   4                       REB PTR                          02460002
TETCB    EQU   8                       TE TCB ADR FLD                   02480002
TWO      EQU   2                       TWO                              02500002
TYPE4    EQU   19                      UCB TYPE FLD                     02520002
UCBSEN   EQU   32                      START OF UCB SENSE     LF YM4067 02540002
UCBTE    EQU   28                      USER TE ADR                      02560002
WAITST   EQU   X'80'                   WAIT BIT                         02580002
ZERO     EQU   0                       ZERO                             02600002
MULTI    EQU   X'20'                   INDICATES MULTIPLE 2260          02620002
NEXT     EQU   4                       CONSTANTS TO STEP ADR SEARCH     02640002
TEBGIOCR EQU   32                    GIOCR ADDRESS IN TEB    LG @ZM2360 02650000
GIOCR    EQU   49                    GIOCR ADDRESS IN DCB    LG @ZM2360 02652000
ALL      EQU   X'FF'                   ACCEPT ANY 2260                  02660002
RSTRT    EQU   45                      GACB LP RESTART FLAG             02680002
RESTART  EQU   X'01'                   AUTO RESTART BIT IN GFLGS        02700002
DEBDEB   EQU   4                   DEB CHAIN IN DEB                RSTD 02702002
DEBDCB   EQU   24                  DCB IN DEB                      RSTD 02703002
DEBUCB   EQU   32                  UCB IN DEB                      RSTD 02704002
CAN      EQU   12                  CANCEL KEY RTN ADDR/SW          RSTD 02705002
T2250    EQU   X'02'               2250 BIT IN UCB TYPE FIELD      RSTD 02706002
GCB      EQU   27                                                  RSTD 02707002
*GJPBIT  EQU   X'80'               GJP NO LONGER SPTD       D11         02708000
WODMP    EQU   X'00'                                               RSTD 02709002
RTNCD    EQU   X'40'                                               RSTD 02710002
ABND     EQU   X'80'                                               RSTD 02711002
ATTNERR  EQU   X'41'                                             F40815 02711502
FOUR     EQU   4                                                        02712002
FIVE     EQU   5                                                        02713002
SIX      EQU   6                                                        02714002
ECBLN    EQU   32                                                       02714502
SIXTN    EQU   16                                                       02715002
INDGAR   EQU   X'04'                                                    02716002
REBUCB   EQU   8                       UCB ADDR                         02717002
DQCKQE   EQU   X'02'                   DEQUEUE CKQE                     02718002
EIGHT    EQU   8                       DISPLACEMENT                     02718602
THREE    EQU   3                       MASK OF 3             LG Z30AALG 02719000
         EJECT                                                          02719202
         SAVE  (14,12)                                                  02750002
         BALR  BASERG,PAR0             SET UP BASE REG                  02760002
         USING *,BASERG                DEFINE BASE REG                  02780002
         USING WORKAREA,MAINREG        DEFINE CSECT REG                 02800002
         B     MODID1                                       D11         02810000
MODID    DC    C'IGG019OE.VS2R2.&SYSDATE' EYECATCHER        D11         02820000
MODID1   LR    RIQE,PAR0               SAVE PARAMETER                   02830000
         LR    RUCB,PAR1               SAVE PARAMETER                   02840002
         L     PAR0,REQUEST            LOAD BYTE REQUEST                02860002
         GETMAIN R,LV=(0)                                               02880002
         ST    PAR1,EIGHT(SAVEREG)     BACK CHAIN SAVE AREAS            02890002
         LR    MAINREG,PAR1            LOAD DSECT REG                   02900002
         XC    RSVD(120),RSVD          CLEAR CORE                       02920002
         ST    SAVEREG,CHAIN           CHAIN SAVE AREA                  02940002
         LA    SAVEREG,SAVE             ESTABLISH NEW SAVE AREA         02960402
         L     R11,UCBTE(ZERO,RUCB)     LOAD TE ADDRESS FROM UCB        02960502
         L     R10,TEBGIOCR(R11)     GIOCR ADDR FROM TEB     LG @ZM2360 02960900
         ST    R10,SAVGIOCR          SAVE IN WORK AREA       LG @ZM2360 02962700
         L     R10,CAN(R11)            LOAD CKQE POINTER                02967602
DEQLOOP  LA    R10,ZERO(R10)           CLEAR HIGH ORDER BYTE            02969402
         LTR   R10,R10                 CKQE POINTER ZERO                02971202
         BZ    GASBACK                 YES TEST FOR ABEND               02973002
         EJECT                                                          02974802
*    CANCEL KEY PROCESSING                                              02976602
         USING CKQE,R10                BASE REG FOR CKQE DSECT          02978402
         TM    CKQEFLGA,CKQEDEQ        SHOULD CKQE BE DEQUEUED          02980202
         BZ    CKCHECK                 NO                               02982002
*                                      YES REBUILD CHAIN                02983802
         L     R12,CKQENEXT            GET NEXT CKQE ADDRESS            02985602
         ST    R12,CAN(R11)            STORE NEW CKQE ADDRESS IN TE     02987402
         LR    PAR1,R10                LOAD CKQE ADDRESS FOR FREEMAIN   02989202
         L     PAR0,CKQECORE           LOAD SUBPOOL AND BYTE REQUEST    02991002
         FREEMAIN  R,LV=(0),A=(1)      FREE CKQE                        02992802
         LR    R10,R12                 PUT NEW CKQE PTR IN REG 10 AND   02994602
         B     DEQLOOP                 TEST FOR DEQUEUE NECESSARY       02996402
CKCHECK  ST    RUCB,IOSTAT         SAVE IO STATUS                   CAN 02998202
         LA    RUCB,ZERO(RUCB)     CLEAR HIGH ORDER BYTE         CAN01  03000002
         SR    R12,R12                 CLEAR REGISTER        LG Z30AALG 03000400
         ICM   R12,THREE,CKQEUCB       GET UCB ADDRESS       LG Z30AALG 03000800
         CR    RUCB,R12                COMPARE UCB ADDRS                03002002
         BE    CHKATTN                 MATCH FOUND-CAN KEY IN CONTROL   03004002
         L     R10,ZERO(R10)           GET NEXT CKQE                    03006002
         B     DEQLOOP                 CHECK FOR MORE CKQE'S            03008002
         EJECT                                                          03008402
CHKATTN  TM    CKQEFLGA,CKQEATTN       IS ATTN EXPECTED FROM 2250       03010002
         BZ    SSM6A                 NO                    D11 @ZA00524 03012000
         TM    IOSTAT,HEX82        IS IT A LIGHT PEN ATTENTION   CAN01  03014002
         BNO   GASRMI             BRANCH TO UNLOCK KYBD          CAN01  03016002
         L     PAR1,UCBTE(RUCB)   GET TEB ADDRESS                CAN01  03018002
         MVC   SENSED(FOUR),UCBSEN(RUCB)    MOVE SENSE DATA TO WORKAREA 03020002
         TM    SENSED+ONE,LPDET        TEST FOR LIGHT PEN DETECT        03022002
         BZ    GASRMI                  NOT LP - FREE KEYBOARD           03024002
         OI    FIVE(R10),INDGAR        IND ENTRY FROM GAR W/LP ATTN     03026002
         B     GAS60                   PLACE CKQE ON TEB CKQE LIST      03028002
GASRMI   L     REBRG,TEREB(PAR1)       LOAD REB ADDRESS                 03030002
REBLOOPA LA    REBRG,ZERO(REBRG)       CLEAR HIGH ORDER BYTE            03032002
         LTR   REBRG,REBRG             DOES REB EXIST                   03034002
         BNZ   REBGOOD            BRANCH IF REB ADDR IS GOOD            03036002
         L     R8,CKQEDCB         GET DCB ADDRESS                       03038002
         B     NOREBRMI           BRANCH IF REB IS NOT FOUND            03040002
         DROP  R10                                                      03042002
REBGOOD  L     R10,REBUCB(REBRG)  GET UCB FROM REB                      03044002
         CR    R10,R12                 RIGHT REB                        03046002
         BE    DCBRMI                  YES                              03048002
         L     REBRG,ZERO(REBRG)       NO TRY ANOTHER                   03050002
         B     REBLOOPA                REB                              03052002
DCBRMI   L     R8,GACBADR(REBRG)       GET GACB ADDRESS                 03054002
         L     R8,DCBADR(R8)           GET DCB ADDRESS                  03056002
         LA    R8,ZERO(R8)             CLEAR HIGH ORDER BYTE            03058002
NOREBRMI XC    IOREQ(ECBLN),IOREQ CLEAR ECB                             03060002
         LA    PAR1,IOREQ              LOAD DECB ADDRESS                03062002
         LA    R9,MI                   INPUT AREA ADDRESS               03064002
         BAL   R7,COMNREAD            GO EXECUTE GREADR FOR RMI         03066002
         B     GASHSKP                                                  03068002
         EJECT                                                          03068402
GASBACK  L     R11,UCBTE(0,RUCB)       LOAD TE ADR FROM UCB             03070002
         L     REBRG,TEREB(0,R11)      LOAD PTR TO FIRST REB            03072002
         LR    R10,RUCB                PARAM TO WORK REG(UCB ADR)       03074002
         LA    R10,0(0,R10)            ZERO HI ORDER BYTE               03076002
GAS02    LTR   REBRG,REBRG             PTR 0                            03078002
         BZ    GASCHAIN            BRANCH IF YES            D11    RSTD 03080000
         TM    RTNFLG(REBRG),MULTI     REB POINT TO A LIST OF           03100002
*                                      UCB ADRS                         03120002
         BNO   GAS24                   BRANCH IF NO                     03140000
         SR    R15,R15                 CLEAR REG                        03160002
         IC    R15,RTNFLG+1(REBRG)     LOAD NO OF UCB ADRS              03180002
         L     R14,RTNUCB(REBRG)       LOAD PTR TO LIST                 03200002
GAS25    L     R12,ZERO(0,R14)         LOAD UCB ADR                     03220002
         LA    R12,ZERO(0,R12)         ZERO HI ORDER BYTE               03240002
         CLR   R10,R12                 UCB ADRS EQUAL                   03260002
         BE    GAS01                   BRANCH IF YES        D11         03280000
         LA    R14,NEXT(0,R14)         UPDATE PTR                       03300002
         BCT   R15,GAS25               BRANCH IF MORE UCB ADRS          03320002
         B     GAS05                   BRANCH                           03340002
GAS24    L     R12,RTNUCB(0,REBRG)     LOAD REB UCB ADR                 03360002
         CLR   R10,R12                 ADDRESSES COMPARE                03380002
         BE    GAS01                   BRANCH IF YES        D11         03400000
GAS05    L     REBRG,RTNF(0,REBRG)     LOAD PTR TO NEXT REB             03420002
         B     GAS02                                                    03440002
         EJECT                                                          03450002
*     UCB MATCH FOUND                                                   03452002
GAS01    L     R12,CODETYP             LOAD MASK                        03460002
         NR    R12,RUCB                LOAD R12 WITH ATN TYPE           03480002
         LTR   R12,R12                 TEST FOR KYBD ATTN               03500002
         BZ    GAS03                   BRANCH IF KYBD ATTN  D11         03520000
         MVC   SENSED(4),UCBSEN(RUCB)  SENSE DATA TO WORK AREA          03540002
         TM    SENSED+1,LPDET          TEST FOR LIGHT PEN               03560002
         BNO   GAS04                   BRANCH IF NOT LP     D11         03580000
         LA    R10,LP                  LOAD LP CODE                     03600002
         L     R8,GACBADR(0,REBRG)     LOAD GACB ADR                    03620002
         L     R8,DCBADR(0,R8)         LOAD DCB ADR                     03640002
         LA    R8,ZERO(0,R8)           ZERO HI ORDER BYTE               03660002
         LTR   R8,R8                   DCB ADR=0                        03680002
         BZ    GAS05                   BRANCH IF YES        D11         03700000
         XC    IOREQ(32),IOREQ              CLEAR ECB              AHD6 03710002
         LA    PAR1,IOREQ              LOAD DECB ADR                    03720002
         LA    R9,XYP                  LOAD XYP ADR                     03740002
         SPACE 3                                            D11 ZA13194 03750000
* THERE FOLLOWS A HAND-CODED EXPANSION OF THE GREADR MACRO  D11 ZA13194 03751000
*    IN ORDER TO ACCESS THE ADDRESS OF GIOCR FROM A PRO-    D11 ZA13194 03752000
*    TECTED AREA (SAVGIOCR IN TEB) IN ORDER TO AVOID A      D11 ZA13194 03753000
*    SYSTEM INTEGRITY EXPOSURE.                             D11 ZA13194 03754000
*        GREADR (1),XYP,(8),(9),MF=E                        D11 ZA13194 03760000
         SR    R15,R15             CLEAR REG                D11 ZA13194 03761000
         ST    R15,4(R1)           CLEAR TYPE AREA IN DECB  D11 ZA13194 03762000
         MVI   4(R1),X'10'         XYP TYPE TO DECB         D11 ZA13194 03763000
         LA    R15,0(R8)           DCB ADDRESS              D11 ZA13194 03764000
         ST    R15,8(0,R1)         DCB ADDRESS IN DECB      D11 ZA13194 03765000
         LA    R15,0(R9)           AREA ADDRESS             D11 ZA13194 03766000
         ST    R15,12(0,R1)        AREA ADDRESS IN DECB     D11 ZA13194 03767000
         XC    0(4,R1),0(R1)       CLEAR ECB                D11 ZA13194 03768000
         L     R15,SAVGIOCR        SAFE GIOCR ADDR FROM TEB D11 ZA13194 03769000
         BALR  R14,R15             BRANCH TO GIOCR          D11 ZA13194 03770000
*  END OF HAND-CODED EXPANSION OF GREADR MACRO              D11 ZA13194 03771000
         SPACE 3                                            D11 ZA13194 03772000
         BAL   R7,COMNWAIT             TEST FOR GOOD I/O AND WAIT       03780002
         B     TRANSLAT                BRANCH                           03800002
GAS04    TM    SENSED+1,EOSDET         TEST FOR END ORDER SEQUENCE      03820002
         BNO   GAS06                   BRANCH IF NOT EOS    D11         03840000
         LA    R10,EOS                 LOAD EOS CODE                    03860002
         B     TRANSLAT                BRANCH                           03880002
GAS06    LA    R10,AE                  LOAD AE CODE                     03900002
         B     TRANSLAT                BRANCH                           03920002
         EJECT                                                          03930002
*     KEYBOARD ATTENTION, SO CHECK DEVICE TYPE                          03932002
GAS03    CLI   TYPE4(RUCB),AT2260      IS THIS A 2260                   03940002
         BNE   GAS08                   BRANCH IF NO         D11         03960000
         LA    R10,A2260               LOAD 2260 CODE                   03980002
         B     TRANSLAT                BRANCH                           04000002
*   FOR 2250 KEYBOARD ATTENTION                                         04010002
GAS08    L     R8,GACBADR(0,REBRG)     LOAD GACB ADR                    04020002
         L     R8,DCBADR(0,R8)         LOAD DCB ADR                     04040002
         LA    R8,ZERO(0,R8)           ZERO HI ORDER BYTE               04060002
         LTR   R8,R8                   DCB ADR=0                        04080002
         BZ    GAS05                   BRANCH IF YES TO TRY D11         04100000
*                                      ANOTHER UCB ADR MATCH            04120002
         XC    IOREQ(32),IOREQ              CLEAR ECB              AHD6 04130002
         LA    PAR1,IOREQ              LOAD DECB ADR                    04140002
         LA    R9,MI                   LOAD INPUT AREA ADR              04160002
         BAL   R7,COMNREAD            GO EXECUTE GREADR FOR RMI         04190002
         TM    MI,PFKBD                TEST FOR PF KYBD ATTN            04220002
         BO    GASPF                   BRANCH IF YES        D11         04240000
GAS10    TM    MI,CANCELD              TEST FOR CANCEL KEY              04260002
         BO    GAS132                  BR IF CANCEL KEY       LB  AOS/1 04280002
GAS22    TM    MI,ANKBD+ENDD           TEST FOR AN OR END KEY ATTENTIOM 04340002
         BZ    SSM6A             BRANCH IF NOT A/N OR END  D11 @ZA00524 04360000
         LA    R10,ENDORANK            LOAD END OR A/N CODE             04380002
         EJECT                                                          04390002
TRANSLAT STC   R10,TYPE                PUT TYPE IN DATA AREA            04400002
         LA    R7,ONE                  LOAD TYPE MASK                   04420002
         LA    R8,ZERO                 ZERO PF MASK                     04440002
         CLI   TYPE,ENDORANK           TEST FOR END OR A/N              04460002
         BE    SEARCH              YES,GO SEARCH            D11         04480000
         LA    R9,TWO                  LOAD CONSTANT                    04500002
         SR    R10,R9                  DETERMINE SHIFT COUNT            04520002
         SLL   R7,ZERO(R10)            DETERMINE SEARCH ARGUMENT        04540002
         B     SEARCH                  BRANCH                           04560002
GASPF    MVC   KEY(1),MI+1             KEY NUMBER TO WORH AREA          04580002
         MVC   OV(1),MI+2              OVERLAY COSE TO WORK AREA        04600002
         MVI   TYPE,X'02'              PF CODE TO TYPE FIELD            04620002
         SR    R10,R10                 CLEAR REG                        04640002
         IC    R10,KEY                 INSERT KEY NUMBER                04660002
         LA    R7,ZERO                 ZERO TYPE REG                    04680002
         L     R8,PFKCODE              LOAD PF MASK                     04700002
         SRL   R8,ZERO(R10)            DETERMINE PF SEARCH ARGUMENT     04720002
SEARCH   L     REBRG,UCBTE(0,RUCB)     LOAD TE ADR FROM UCB             04740002
         L     REBRG,TEREB(0,REBRG)    LOAD PTR TO FIRST REB            04760002
         LA    RUCB,ZERO(0,RUCB)       ZERO HIGH ORDER BYTE             04780002
GAS28    SR    R15,R15             CLEAR REG                  LI A42794 04800002
         TM    RTNFLG(REBRG),MULTI  REB POINT TO MULTI UCBS   LI A42794 04820002
         BNO   GAS12               BRANCH IF NO             D11  A42794 04840000
         IC    R15,RTNFLG+1(REBRG)     LOAD # OF UCB ADRS               04860002
         L     R14,RTNUCB(0,REBRG)     LOAD PTR                         04880002
GAS27    L     R9,ZERO(0,R14)          LOAD UCB ADR                     04900002
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               04920002
         CLR   R9,RUCB                 UCB ADRS COMPARE                 04940002
         BE    GAS26                   BRANCH IF YES        D11         04960000
         LA    R14,NEXT(0,R14)         LOAD PTR TO NEXT UCB ADR         04980002
         BCT   R15,GAS27               BRANCH IF MORE                   05000002
         B     GAS13                   BRANCH                           05020002
GAS26    SR    R14,R14                 CLEAR REG                        05040002
         IC    R14,RTNFLG+1(REBRG)     INSERT # OF EXTENTS              05060002
         LA    R14,ONE(0,R14)          INCREMENT COUNT BY ONE           05080002
         SR    R14,R15                 DETERMINE OFFSET TO UCB ADR      05100002
         STC   R14,RSVD                2260 OFFSET TO DATA AREA         05120002
         B     GAS11                   BRANCH                           05140002
GAS12    L     R9,RTNUCB(0,REBRG)      LOAD UCB ADR                     05160002
         LA    R15,ONE(R15)            INCREMENT DEV INDEX   LD YA00804 05170002
         CLR   R9,RUCB                 ADRS COMPARE                     05180002
         BE    GAS26               BRANCH IF YES            D11  A42794 05200000
GAS13    L     REBRG,RTNF(0,REBRG)     LOAD NEXT REB PTR                05220002
         LTR   REBRG,REBRG             PTR = 0                          05240002
         BNZ   GAS28                   BRANCH IF PTR NOT 0  D11         05260000
         L     REBRG,UCBTE(0,RUCB)     LOAD TE ADR                      05280002
         L     REBRG,TEREB(0,REBRG)    LOAD PTR TO FIRST REB            05300002
         LA    RUCB,0(0,RUCB)          ZERO HI ORDER BYTE               05320002
GAS56    TM    RTNFLG(REBRG),MULTI     REB POINT TO LIST OF UCB ADRS    05340002
         BNO   GAS53                   BRANCH IF NO                     05360000
         SR    R9,R9                   CLEAR REG                        05380002
         IC    R9,RTNFLG+1(REBRG)      LOAD # OF UCB ADRS               05400002
         L     R11,RTNUCB(REBRG)       LOAD PTR TO LIST                 05420002
GAS55    L     R12,ZERO(0,R11)         LOAD UCB ADR                     05440002
         LA    R12,ZERO(0,R12)         ZERO HI ORDER BYTE               05460002
         CLR   RUCB,R12                UCB ADRS COMPARE                 05480002
         BNE   GAS54                   BRANCH IF NO         D11         05500000
         LA    R12,SSM6A             LOAD RETURN ADR       D11 @ZA00524 05520000
         CLI   TYPE,LP                 IS THIS A LP ATTN                05540002
         BNER  R12                     BRANCH IF NO         D11         05560000
         L     R9,RTNGACB(0,REBRG)     LOAD GACB ADRESS                 05580002
         B     LPSTART1                BRANCH                           05600002
GAS54    LA    R11,4(0,R11)            INCREMENT PTR                    05620002
         BCT   R9,GAS55                BRANCH IF MORE UCBS              05640002
GAS57    L     REBRG,RTNF(0,REBRG)     LOAD NEXT REB PTR                05660002
         LA    REBRG,ZERO(0,REBRG)     ZERO HI ORDER BYTE               05680002
         LTR   REBRG,REBRG             PTR=0                            05700002
         BZ    SSM6A                   BRANCH IF YES       D11 @ZA00524 05720000
         B     GAS56                   BRANCH                           05740002
GAS53    L     R12,RTNUCB(0,REBRG)     LOAD UCB ADR                     05760002
         LA    R12,ZERO(0,R12)         ZERO HI ORDER BYTE               05780002
         CLR   R12,RUCB                UCB ADRS COMPARE                 05800002
         BNE   GAS57                   BRANCH IF NO         D11         05820000
         LA    R12,SSM6A               LOAD RETURN ADR     D11 @ZA00524 05840000
         CLI   TYPE,LP                 IS THIS A LP ATTN                05860002
         BNER  R12                     BRANCH IF NO         D11         05880000
         L     R9,RTNGACB(0,REBRG)     LOAD GACB ADRESS                 05900002
         B     LPSTART1                BRANCH                           05920002
GAS11    L     R10,RTNIRB(0,REBRG)     LOAD IRB ADR                     05940002
         L     R9,RBIQE(0,R10)         LOAD RB IQE PTR                  05960002
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               05980002
         LTR   R9,R9                   PTR=0                            06000002
         BNZ   GAS14                   BRANCH IF NOT 0      D11         06020000
         L     R9,RTNGACB(0,REBRG)     LOAD GACB ADR                    06040002
         LA    R9,ZERO(0,R9)           ZERO HIGH ORDER BYTE             06060002
         LTR   R9,R9                   GACB ADR=0                       06080002
         BZ    GAS58                   BRANCH IF YES        D11         06100000
         CLC   ECB(FOUR,R9),INIT   WAS ECB INITALIZED         LI A42794 06106002
         BE    POSTERR             YES, BRANCH                   F40815 06112002
         TM    ECB(R9),X'80'           ECB=WAIT                         06120002
         BO    GAS16                   BRANCH IF YES        D11         06140000
GAS58    L     R9,RTNQ2(0,REBRG)       LOAD QZ PTR                      06160002
         LTR   R9,R9                   PTR=0                            06180002
         BNZ   GAS15                   BRANCH IF NO         D11         06200000
         L     R9,RTNGACB(0,REBRG)     LOAD GACB ADR                    06220002
         L     R11,PFKMSK(0,R9)        LOAD PFKMSK MASK FROM GACB       06240002
         L     R12,PFKMSK+4(0,R9)      LOAD ATTNTYP MASK FROM GACB      06260002
         NR    R12,R7                  DETERMINE IF MATCH               06280002
         NR    R11,R8                  DETERMINE IF MATCH               06300002
         LTR   R12,R12                 REG=0                            06320002
         BNZ   GAS15                   NOT 0-ATTN TYP MATCH D11         06340000
         LTR   R11,R11                 REG=0                            06360002
         BNZ   GAS15                   NOT 0-PF KEY MATCH   D11         06380000
         B     GAS13                   BRANCH                           06400002
GAS14    L     R9,RTNGACB(0,REBRG)     LOAD GACB ADR                    06420002
         CLC   ECB(FOUR,R9),INIT        WAS ECB INITALIZED    LI A42794 06426002
         BE    POSTERR             YES, BRANCH                   F40815 06432002
         TM    ECB(R9),WAITST          ROUTINE IN WAIT STATE            06440002
         BO    GAS16                   BRANCH IF YES        D11         06460000
         B     GAS15               NO, BRANCH TO LP RESTART      F40815 06463002
POSTERR  LA    PAR0,ATTNERR        LOAD ERR CODE                 F40815 06466002
         SLL   PAR0,24             SHIFT TO HIGH ORDER BYTE      F40815 06469002
         LA    PAR1,ECB(R9)        LOAD ECB ADDR                 F40815 06472002
         POST  (1),(0)             POST ECB WITH ERROR           F40815 06475002
GAS15    BAL   R12,LPSTART             BRANCH TO LP RESTART CYCLE       06480002
GAS15A   L     R9,NEXAVL(0,R10)        LOAD NEXT AVAIL IQE FLD          06500002
         LTR   R9,R9                   PTR=0                            06520002
         BNZ   GAS17                   BRANCH IF NO         D11         06540000
         LA    R9,GMAINADR             SET UP RE-ENTRANT ADR LOC   0803 06547002
         LA    PAR1,GMAINLST       POINT TO LIST                 A34795 06549002
         GETMAIN EC,LV=32,A=(9),SP=234,MF=(E,(1))             LB  AOS/1 06551002
         LTR   R15,R15               IS CORE AVAILABLE             0803 06561002
         BZ    GAS15B                  IF YES, CONTINUE PROCESSING 0803 06568002
         BNZ   GASHSKP                                                  06588002
GAS15B   EQU   *                                             LG ZA00524 06591000
         LA    SAVEREG,LOCKSAVE        GET SAVE AREA ADDR    LG ZA00524 06594000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGG019OE(X06597000
               SSM3)),REGS=SAVE                              LG ZA00524 06600000
         LA    SAVEREG,SAVE            RESTORE SVAREA ADDR   LG ZA00524 06603000
         L     R9,GMAINADR           CLEAR IQE                     0803 06610000
         XC    ZERO(32,R9),ZERO(R9)    CLEAR CORE                       06620002
         ST    R10,IQEIRB(0,R9)        IRB ADR TO IQE                   06640002
         L     PAR1,UCBTE(0,RUCB)      LOAD TE ADR                      06660002
         MVC   IQETCB+1(3,R9),REBTCB(REBRG)    SPAR TCB ADR TO IQE      06680002
GAS17    EQU   *                                             LD YA01555 06690002
         CLI   ENABL1,ALL              FORCE PAGE-IN         LD YA01555 06692002
         CLI   EP1(R7),ALL             FORCE PAGE-IN OF GACB LD YA01555 06694002
         LA    SAVEREG,LOCKSAVE        POINT TO SETLOCK SAVE AREA       06694402
SSM1     SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGG019OE(X06696002
               SSM3)),REGS=SAVE                                         06698002
         LA    SAVEREG,SAVE            RESTORE SAVE AREA ADDRESS        06698402
         MVC   NEXAVL(4,R10),IQELNK(R9) LINK ADR TO IRB NEXAVL FLD      06700002
         L     R11,RTNGACB(0,REBRG)    LOAD GACB ADR                    06720002
         ST    R11,IQEPAR(R9)          GACB ADR TO IQE                  06740002
         MVC   IQEDATA(12,R9),RSVD     DATA TO IQE                      06760002
         MVC   IQELNK(4,R9),RTNQ2(REBRG) QZ PTR TO IQE LNK FIELD        06820002
         ST    R9,RTNQ2(REBRG)         IQE ADR TO Q2 PTR FLD            06840002
         B     SSM6A                                       D11 @ZA00524 06850000
GAS16    L     R12,RTNGACB(0,REBRG)    LOAD GACB ADR                    07120002
         L     R11,PFKMSK(0,R12)       LOAD PFKMSK                      07140002
         L     R14,PFKMSK+4(0,R12)     LOAD ATTNTYP MASK                07160002
         NR    R11,R8                  DETERMINE IF MATCH               07180002
         NR    R14,R7                  DETERMINE IF MATCH               07200002
         LTR   R11,R11                 REG=0                            07220002
         BNZ   GAS19               BRANCH NOT 0-HAD A MATCH D11         07240000
         LTR   R14,R14                 REG=0                            07260002
         BZ    GAS15                                                    07290002
GAS19    BAL   R12,LPSTART             BRANCH TO LP RESTART CYCLE       07320002
         L     R12,RTNGACB(0,REBRG)    LOAD GACB ADR                    07340002
         CLI   TYPE,A2260              IS THIS A 2260 ATTN              07360002
         BNE   GAS19A                  BRANCH IF NOT 2260   D11         07380000
         CLI   GACBRSVD(R12),ALL       ACCEPT ANY 2260 ATN              07400002
         BE    GAS19A                  BRANCH IF YES        D11         07420000
         CLC   GACBRSVD(1,R12),RSVD    IS THIS THE 2260 RTN WAITING FOR 07440002
         BNZ   GAS15A                  NO                               07470002
GAS19A   L     R11,REBTCB-1(0,REBRG)   LOAD TCB ADDRESS     D11 ZA13195 07476000
         USING TCB,R11                                      D11 ZA13195 07482000
         MODESET EXTKEY=TCB,WORKREG=1   GO TO USERKEY       D11 ZA13195 07488000
         DROP  R11                                          D11 ZA13195 07494000
         L     R11,COMAREA(0,R12)      LOAD COMAREA ADR                 07500000
         MVC   ZERO(12,R11),RSVD       DATA TO COMAREA                  07520002
         MODESET EXTKEY=SUPR           BACK TO SUPERKEY     D11 ZA13195 07530000
         LA    PAR0,COMPLETE           LOAD POST CODE                   07540002
         SLL   PAR0,24             SHIFT TO HIGH ORDER BYTE      F40815 07550002
         LA    PAR1,ECB(0,R12)         LOAD ECB ADR                     07560002
         POST  (1),(0)                                                  07580002
GAS18    EQU   *                                              LB  AOS/1 07680002
         LA    SAVEREG,LOCKSAVE        POINT TO SETLOCK SAVE AREA       07690002
SSM6     SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGG019OE(SSM7)),REGSX07700002
               =SAVE                                                    07710002
         LA    SAVEREG,SAVE            RESTORE SAVE AREA ADDRESS        07712002
SSM6A    L     REBRG,UCBTE(RUCB)       LOAD TE ADDRESS      D11   AOS/1 07720000
         L     REBRG,TEREB(0,REBRG)    LOAD PTR TO FIRST REB            07760002
         LA    REBRG,0(0,REBRG)        ZERO HI ORDER BYTE               07780002
         LTR   REBRG,REBRG                                              07800002
         BZ    ENABL1                  BRANCH IF YES        D11 YA01555 07820000
GAS23    L     R7,RTNF(0,REBRG)        LOAD PTR TO NEXT REB             07840002
         LTR   R7,R7                   REG 0                            07860002
         BZ    GAS20                   BRANCH IF YES        D11         07880000
         LR    REBRG,R7                SAVE ADR                         07900002
         B     GAS23                   BRANCH                           07920002
* REBR6 CONTAINS ADR OF LOWEST PRIORITY REB                        2575 07927002
* R7,R8 AND PAR1 REGS AVAILABLE AS WORK REGS                       2575 07934002
GAS20    EQU   *                                              LB  AOS/1 07941002
         LA    SAVEREG,LOCKSAVE        POINT TO SETLOCK SAVE AREA       07943002
SSM7     SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGG019OE(X07945002
               SSM6)),REGS=SAVE                                         07947002
         LA    SAVEREG,SAVE            RESTORE SAVE AREA ADDRESS        07947402
GAS103   L     R7,RTNGACB(REBRG)       LOAD GACB ADR FROM REB      2575 07948002
         CLC   ZERO1(4),EP1(R7)        ENTRY POINT=0               2575 07955002
         BE    GAS100                  BRANCH-EP=0                 2575 07962002
GAS110   CLC   ZERO1(4),RTNQ1(REBRG)   ANY IQES ON Q1 FIELD        2575 07969002
         BNE   GAS101                  BRANCH-Q1 HAS IQES          2575 07976002
GAS104   CLC   ZERO1(4),RTNQ2(REBRG)   ANY IQES ON Q2 FIELD        2575 07983002
         BNE   GAS102                  BRANCH-Q2 HAS IQES          2575 07990002
GAS113   TM    RTNFLG(REBRG),FLAGS     REB POINT TO A TE           2575 07997002
         BO    ENABL1                  BR IF REB POINTS TO TE LB  AOS/1 08004002
         L     REBRG,RTNB(REBRG)       LOAD NEXT REB POINTER       2575 08011002
         B     GAS103                  BRANCH TO CHECK NEXT REB    2575 08018002
GAS102   L     R7,RTNQ2(REBRG)         LOAD IQE ADR                2575 08025002
         MVC   RTNQ2(4,REBRG),IQELNK(R7)  UPDATE CHAIN             2575 08032002
         LNR   PAR1,R7                 COMPLEMENT IQE ADR TO PARAM 2575 08039002
         L     R15,CVTADR              GET CVT TABLE ADR           2575 08046002
         L     R15,STAGE2(R15)         GET ADR OF AEE STAGE 2      2575 08053002
         BALR  R14,R15                 LINK TO AEE STAGE 2         2575 08060002
         B     GAS104                  BRANCH TO TEST FOR MORE IQE 2575 08067002
GAS101   L     PAR1,RTNQ1(REBRG)       LOAD ADR OF FIR0T IQE       2575 08074002
         SR    R7,R7                   ZERO PREVIOUS IQE REG       2575 08081002
GAS106   CLC   IQELNK(4,PAR1),ZERO1    LAST IQE ON CHAIN           2575 08088002
         BE    GAS105                  BRANCH-LAST IQE ON CHAIN    2575 08095002
         LR    R7,PAR1                 SAVE ADR THIS IQE           2575 08102002
         L     PAR1,IQELNK(PAR1)       LOAD NEXT IQE ADR ONCHAIN   2575 08109002
         B     GAS106                  BRANCH TO TEST FOR END OF C 2575 08116002
GAS105   LTR   R7,R7                   PREVIOUS IQE REG = 0        2575 08123002
         BZ    GAS107                  BRANCH-YES           D11    2575 08130000
         MVC   IQELNK(4,R7),IQELNK(PAR1) REMOVE IQE FROM END OF 01 2575 08137002
         B     GAS108                  BRANCH                      2575 08144002
GAS107   MVC   RTNQ1(4,REBRG),IQELNK(PAR1)   UPDATE 01 CHAIN       2575 08151002
GAS108   XC    IQELNK(4,PAR1),IQELNK(PAR1)   ZERO IQE LINK FIELD   2575 08158002
         CLC   ZERO1(4),RTNQ2(REBRG)   02 FIE TO ZERO              2575 08165002
         BNE   GAS109                  BRANCH-02 NOT ZERO          2575 08172002
         ST    PAR1,RTNQ2(REBRG)       ADD IQE TO Q2 FIELD         2575 08179002
         B     GAS110                  BRANCH TO TEST 01 FIELD     2575 08186002
GAS109   L     R7,RTNQ2(REBRG)         LOAD 1ST IQE ADR            2575 08193002
GAS112   CLC   ZERO1(4),IQELNK(R7)     LAST IQE ON CHAIN           2575 08200002
         BE    GAS111                  BRANCH-LAST IQE ON CHAIN    2575 08207002
         L     R7,IQELNK(R7)           LOAD ADR OF NEXT IQE        2575 08214002
         B     GAS112                  BRANCH TO FIND END OF Q2 CH 2575 08221002
GAS111   ST    PAR1,IQELNK(R7)         ADD IQE TO END OF CHAIN     2575 08228002
         B     GAS110                  BRANCH TO TEST Q1 FIELD     2575 08235002
GAS100   CLC   ZERO1(4),RTNQ2(REBRG)   ANU IQES ON Q2 FIELD        2575 08242002
         BE    GAS113                  BRANCH-NO IQES ON Q2 FIELD  2575 08249002
         L     PAR1,RTNQ2(REBRG)       LOAD ADR OF FIRST IQE       2575 08256002
         SR    R7,R7                   ZERO PREVIOUS IQE REG       2575 08263002
GAS114   CLC   ZERO1(4),IQELNK(PAR1)   LAST IQE ON CHAIN           2575 08270002
         BE    GAS115                  BRANCH LAST IQE ON CH       2575 08277002
         LR    R7,PAR1                 SAVE ADR THIS IQE           2575 08284002
         L     PAR1,IQELNK(PAR1)       LOAD NEXT IQE ADR ON CHAIN  2575 08291002
         B     GAS114                  BRANCH TO TEST FOR END OF   2575 08298002
GAS115   LTR   R7,R7                   PREVIOUS IQE REG= 0         2575 08305002
         BZ    GAS116                  BRANCH-YES           D11    2575 08312000
         MVC   IQELNK(4,R7),IQELNK(PAR1) REMOVE IQE FROM END OF Q  2575 08319002
         B     GAS117                  BRANCH                      2575 08326002
GAS116   MVC   RTNQ2(4,REBRG),IQELNK(PAR1) UPDATE Q2 CHAIN         2575 08333002
GAS117   XC    IQELNK(4,PAR1),IQELNK(PAR1) ZERO IQE LINK FIELD     2575 08340002
         CLC   ZERO1(4),RTNQ1(REBRG)   Q1 FIELD ZERO               2575 08347002
         BNE   GAS118                  BRANCH-Q1 NOT ZERO          2575 08354002
         ST    PAR1,RTNQ1(REBRG)       ADD IQE TO Q1 FIELD         2575 08361002
         B     GAS100                  BRANCH TO TEST 02 FIELD     2575 08368002
GAS118   L     R7,RTNQ1(REBRG)         LOAD 1SR IQE ADR            2575 08375002
GAS119   CLC   ZERO1(4),IQELNK(R7)     LAST IQE ON CHAIN           2575 08382002
         BE    GAS120                  BRANCH LAST IQE ON CHAI     2575 08389002
         L     R7,IQELNK(R7)           LOAD ADR OF NEXT IQE        2575 08396002
         B     GAS119                  BRANCH TO FIND END OF CHA   2575 08403002
GAS120   ST    PAR1,IQELNK(R7)         ADD IQE TO END OF CHAIN     2575 08410002
         B     GAS100                  BRANCH                      2575 08417002
ENABL1   EQU   *                       LIMIT OF DISABLED CODE LB  AOS/1 08420002
GASHSKP  L     SAVEREG,CHAIN            RESTORE SAVE AREA POINTER       08427002
         LR    PAR1,MAINREG            LOAD ADDRESS TO FREE             08437002
         L     PAR0,REQUEST            LOAD BYTE COUNT                  08447002
         L     RTCB,CVTADR          GET CVT ADDRESS              YM5683 08449002
         L     RTCB,0(RTCB)         ADDRESS OF TCB TABLE         YM5683 08451002
         L     RASCB,12(RTCB)       ADDRESS OF CURRENT ASCB      YM5683 08453002
         L     RTCB,4(RTCB)         ADDRESS OF CURRENT TCB       YM5683 08455002
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                      YM5683 08455402
SSM4     SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGG019OE(SSM5)),REGSX08507002
               =USE                                                     08509002
GASHSKP1 RETURN (14,12)                                            RSTD 08512002
         EJECT                                                          08516002
LPSTART  CLI   TYPE,LP                 IS THIS A LP ATTN                08520002
         BNER  R12                     BRANCH IF NOT LP     D11         08540000
         L     R9,RTNGACB(0,REBRG)     LOAD GACB ADR                    08560002
         TM    RSTRT(R9),RESTART       AUTO RESTART REQUESTED           08580002
         BNOR  R12                     BRANCH IF NO         D11         08600000
LPSTART1 L     R11,DCBADR(0,R9)        LOAD DCB ADDRESS                 08620002
         LA    R9,SENSED+TWO           LOAD RESTART ADR                 08640002
         XC    IOREQ(32),IOREQ         CLEAR DECB                       08660002
         LA    PAR1,IOREQ              LOAD DECB ADR                    08680002
*        SPACE 3                                            D11 ZA13194 08690000
*   THERE FOLLOWS A HAND-CODED EXPANSION OF THIS GCNTRL     D11 ZA13194 08698400
*   MACRO CALL IN ORDER TO ACCESS A SAFE GIOCR ADDR(TEB)    D11 ZA13194 08700000
*        GCNTRL (1),STR,(11),(9),MF=E                       D11 ZA13194 08701000
         SR    R15,R15             CLEAR REG                D11 ZA13194 08702000
         ST    R15,4(R1)           CLEAR TYPE AREA IN DECB  D11 ZA13194 08703000
         MVI   4(R1),X'6C'         STR TYPE CODE TO DECB    D11 ZA13194 08704000
         LA    R15,0(R11)          DCB ADDRESS              D11 ZA13194 08705000
         ST    R15,8(R1)           DCB ADDRESS IN DECB      D11 ZA13194 08706000
         LR    R15,R9              AREA ADDRESS             D11 ZA13194 08707000
         ST    R15,24(0,R1)        START ADDRESS IN DECB    D11 ZA13194 08708000
         XC    0(4,R1),0(R1)       CLEAR ECB                D11 ZA13194 08709000
         L     R15,SAVGIOCR        SAFE GIOCR ADDR FROM TEB D11 ZA13194 08710000
         BALR  R14,R15             BRANCH TO GIOCR          D11 ZA13194 08711000
*  END OF HAND-CODED EXPANSION OF GCNTRL MACRO CALL         D11 ZA13194 08712000
         SPACE 3                                            D11 ZA13194 08713000
         LTR   R15,R15             STARTED OK?              D11 ZA13196 08714000
         BNZ   GAS06               NO,SHOW ASYNCH ERR       D11 ZA13196 08717000
         WAIT  ECB=(1)                                                  08720002
         CLI   IOREQ,COMPLETE               I/O COMPLETED          AHD6 08726002
         BNE   GAS06                        BRANCH IF NO           AHD6 08732002
         BR    R12                                                      08740002
GASCHAIN CLI   TYPE4(RUCB),T2250       IS THIS A 2250            A27773 08740402
         BNE   SSM6A                 NO                    D11 @ZA00524 08740800
         L     R12,CODETYP         LOAD MASK                       RSTD 08742002
         NR    R12,RUCB                                            RSTD 08742402
         LTR   R12,R12                                             RSTD 08742802
         BNZ   SSM6A                 IS THIS A KYBD ATTN?  D11 @ZA00524 08743200
         L     REBRG,TETCB(R11)    LOAD TCB ADDR FIELD             RSTD 08743602
         USING TCB,REBRG                                    D11         08743800
         L     REBRG,TCBDEB        LOAD DEB QUEUE                  RSTD 08744000
         DROP  REBRG                                        D11         08744200
GAS130   LTR   REBRG,REBRG         ANOTHER DEB                     RSTD 08744402
         BZ    SSM6A                 NO...RETURN           D11 @ZA00524 08744800
         L     R15,DEBUCB(REBRG)   LOAD UCB                        RSTD 08745202
         LA    R15,0(R15)          ZERO HI ORDER BYTE              RSTD 08745602
         CR    R10,R15             SAME UCB                        RSTD 08746002
         BE    GAS131              YES                             RSTD 08746402
         L     REBRG,DEBDEB(REBRG) LOAD NEXT DECB                  RSTD 08746802
         LA    REBRG,0(REBRG)      ZERO HI ORDER BYTE              RSTD 08747202
         B     GAS130              CONTINUE SEARCH                 RSTD 08747602
GAS131   L     R8,DEBDCB(REBRG)                                         08748002
         LA    R8,0(R8)            ZERO HI ORDER BYTE              RSTD 08748402
         XC    IOREQ(32),IOREQ              CLEAR ECB              AHD6 08748602
         LA    PAR1,IOREQ          LOAD DECB ADDR                  RSTD 08748802
         LA    R9,MI               INPUT AREA ADDR                 RSTD 08749202
         BAL   R7,COMNREAD            GO TO EXECUTE GREADR              08749402
         TM    MI,CANCELD              TEST FOR CANCEL KEY     RSTD     08749602
         BNO   SSM6A                 NO...RETURN           D11 @ZA00524 08749800
GAS132   L     PAR0,CKQECORE           LOAD REQUEST FOR GETMAIN         08750002
         GETMAIN  R,LV=(0)      GET CORE FOR CKQE                       08750202
         LR    R10,PAR1                 LOAD ADDR OF CORE FOR CKQE      08750402
         XC    ZERO(SIXTN,R10),ZERO(R10)       ZERO CKQE                08750602
         STH   RUCB,SIX(R10)            PUT UCB PTR IN CKQE             08750802
         LA    SAVEREG,LOCKSAVE       POINT TO SETLOCK SAVE AREA        08750902
SSM5     SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGG019OE(X08751002
               SSM4)),REGS=SAVE                                         08751102
         LA    SAVEREG,SAVE           RESTORE SAVE AREA POINTER         08751202
         L     PAR1,UCBTE(RUCB)        LOAD TE ADDRESS                  08752202
         ST    R8,CAN(R10)              STORE DCB ADDR IN CKQE          08752302
         MVC   ZERO(FOUR,R10),CAN(PAR1)    ADD NEW CKQE TO TOP OF       08752402
         ST    R10,CAN(PAR1)              TE CKQE LIST                  08752502
GAS60    L     R9,ZERO(PAR1)           LOAD CANCEL KEY IRB ADDR         08752602
         L     R7,NEXAVL(R9)          GET NEXT AVAILABLE CKIQE          08752702
         LA    R7,ZERO(R7)           CLEAR HIGH ORDER BYTE              08752802
         LTR   R7,R7                 CKIQE AVAILABLE                    08752902
         BNE   UPDATE                                                   08753002
         OI    FOUR(R10),DQCKQE        CKQE NO LONGER NEEDED            08753102
         B     GASHSKP                                                  08753202
UPDATE   MVC   NEXAVL(FOUR,R9),ZERO(R7)    UPDATE NEXT AVAIL CKIQE PTR  08753502
         ST    R10,FOUR(R7)            PUT CKQE PTR IN CKIQE            08753802
         LNR   PAR1,R7                COMPLEMENT IQE ADDR TO PARM LIST  08754102
         L     R15,CVTADR              GET CVT TABLE ADDRESS            08754502
         L     R15,STAGE2(R15)         GET ADDR OF AEE STAGE 2          08754602
         BALR  R14,R15                 LINK TO AEE STAGE 2              08754702
         B     GAS18                                        LG @ZA00524 08754800
         EJECT                                                          08756802
***                                                                     08758802
*                                                                       08760802
*              COMMON GREADR FOR READ MANUAL INPUT                      08762802
*                                                                       08764802
***                                                                     08766802
COMNREAD EQU   *                                                        08768802
         SPACE 3                                            D11 ZA13194 08770800
*  THERE FOLLOWS A HAND-CODED EXPANSION OF THIS CALL OF THE D11 ZA13194 08771000
*    GREADR MACRO IN ORDER TO ACCESS A SAFE GIOCR ADDR      D11 ZA13194 08771200
*    FROM THE TASK ENTRY BLOCK IN PROTECTED STORAGE.        D11 ZA13194 08771400
*        GREADR (1),MIP,(8),(9),MF=E                        D11 ZA13194 08771600
         SR    R15,R15             CLEAR REGISTER           D11 ZA13194 08771800
         ST    R15,4(0,R1)         CLEAR TYPE AREA IN DECB  D11 ZA13194 08772000
         MVI   4(R1),X'08'         MIP TYPE TO DECB         D11 ZA13194 08772200
         LA    R15,0(R8)           DCB ADDRESS              D11 ZA13194 08772400
         ST    R15,8(0,R1)         DCB ADDRESS IN DECB      D11 ZA13194 08772600
         LA    R15,0(R9)           AREA ADDRESS             D11 ZA13194 08772800
         ST    R15,12(0,R1)        AREA ADDRESS IN DECB     D11 ZA13194 08773000
         XC    0(4,R1),0(R1)       CLEAR ECB                D11 ZA13194 08773200
         L     R15,SAVGIOCR        SAFE GIOCR ADDR FROM TEB D11 ZA13194 08773400
         BALR  R14,R15             BRANCH TO GIOCR          D11 ZA13194 08773600
*  END OF HAND-EXPANSION OF GREADR MACRO CALL               D11 ZA13194 08773800
         SPACE 3                                            D11 ZA13194 08774000
COMNWAIT LTR   R15,R15                 I/O STARTED                      08777502
         BNZ   GASHSKP                 NO -- LEAVE                      08780002
         LA    PAR1,IOREQ                                               08782502
         WAIT  ECB=(1)                                                  08785002
         CLI   IOREQ,COMPLETE          I/O GOOD                         08787502
         BNE   GAS06                   NO -- BRANCH                     08790002
         BR    R7                     RETURN                            08792502
         EJECT                                                          08795002
ZERO1    DC    1F'0'                   ZERO                        2575 08797502
REQUEST  DC    A(164)              WORK AREA DSECT SPACE     LG @ZM2360 08800000
CODETYP  DC    X'02'                                                    08820002
         DC    AL3(0)                                                   08840002
PFKCODE  DC    X'80'                                                    08860002
         DC    AL3(0)                                                   08880002
DISABLE  DC    X'00'                                                    08940002
ENABLE   DC    X'FF'                                                    08960002
         DS    0F                                                       08964002
INIT     DC    X'00FFFFFF'                                       F40815 08966002
CKQECORE DC    X'E9'                   SP 233 FOR CKQE        LB  AOS/1 08968002
         DC    AL3(26)                 LENGTH OF CKQE         LI A39419 08972002
HOLDREG0 DC    F'0'                                                     08976002
         DS    0F                                                       08980002
         CNOP  0,8                                                      09000002
         EJECT                                                          09010002
WORKAREA DSECT                                                          09020002
         ORG   WORKAREA+0                                               09040002
RSVD     DS    BL1                                                      09060002
OV       DS    BL1                                                      09080002
KEY      DS    BL1                                                      09100002
TYPE     DS    BL1                                                      09120002
MI       DS    0BL3                                                     09140002
SENSED   DS    F                                                        09160002
XYP      DS    F                                                        09180002
         ORG   WORKAREA+16                                       A35022 09190002
IOREQ    DS    4D                                                       09200002
         ORG   WORKAREA+48                                       A35022 09210002
SAVE     DS    F                                                 A35022 09220002
CHAIN    DS    F                                                 A35022 09230002
         DS    16F                                                      09240002
         ORG   WORKAREA+120                                        0803 09268002
GMAINADR DS    F                       CORE ADR FOR IQE            0803 09272002
         ORG   WORKAREA+124                                      A34795 09276002
GMAINLST DS    F                   LENGTH FOR E-TYPE GETMAIN     A34795 09280002
         DS    F                   ADDR OF ADDR LIST             A34795 09284002
         DS    C                   EC MODE GETMAIN               A34795 09288002
         DS    C                   SUB POOL VALUE                A34795 09292002
         ORG   WORKAREA+136                                             09296002
IOSTAT   DS    F                                                        09300002
LOCKSAVE DS    5F                                                       09302002
SAVGIOCR DS    F                    SAVEAREA FOR GIOCR ADDR  LG @ZM2360 09302400
         CVT   DSECT=YES                                                09304002
         SPACE 3                                                        09310002
CKQE     DSECT                                                          09312302
CKQENEXT DS    F                       CHAIN POINTER TO NEXT CKQE       09312602
CKQEFLGA DS    XL1                     TWO BYTE SWITCHES USED TO        09312902
CKQEGJP  EQU   X'80'                   CALLER IS GJP                    09313202
CKQEDUMP EQU   X'40'                   CORE DUMP REQUESTED BY USER      09313502
CKQEATTN EQU   X'20'                   SYS CAN KEY RTN EXPECTING ATTN   09313802
CKQECKPT EQU   X'10'                   CKCB POINTER VALID               09314102
CKQERESV EQU   X'08'                   RESERVED                         09314402
CKQEGJPE EQU   X'04'                   GJP ECB ADDR VALID-GJP WAITING   09314702
CKQEDEQ  EQU   X'02'                   DEQUEUE CKQE                     09315002
CKQEBUF  EQU   X'01'                   2250 BUFFER RUNNING              09315302
CKQEFLGB DS    XL1                     COMMUNICATE WITH GAR,GJP ABEND   09315602
*                                      HOOK,IFFCAN01 AND IFFCAN02.      09315902
CKQEGETA EQU   X'80'                   GETMAIN FOR USER BUFFER          09316202
CKQERLOT EQU   X'40'                   USER BUFFER FOLLED OUT           09316502
CKQEGETB EQU   X'20'                   GETMAIN 2250 I/P BUFFER AND DECB 09316802
CKQEGETC EQU   X'10'                   GETMAIN OPCB,DECB AND O/P LINES  09317102
CKQESBD  EQU   X'08'                   SYSBFDMP O/P DCB IS OPEN         09317402
CKQEGAR  EQU   X'04'                   ENTRY FROM GAR WITH LP ATTN      09317702
CKQEUCB  DS    H                       POINTER TO ASSOCIATED UCB        09318002
CKQECKCB DS    F                       POINTER TO CAN KEY CONTROL BLOCK 09318302
CKQEDCB  DS    F                       DCB ADDR FOR ASSOCIATED DEVICE   09318602
         EJECT                                                          09319002
         IHAPSA                                                         09319302
         EJECT                                              D11 ZA13195 09319500
         IKJTCB                                             D11 ZA13195 09319700
         END                                                            09320002
./  ADD  SSI=32760156,NAME=IGG019OJ
         TITLE 'GRAPHIC ENTRY INTERFACE ROUTINE'                        00020002
*********************************************************************** 00030002
*                                                                       00032002
* MODULE NAME:           IGG019OJ (OS/VS2)                              00034002
*                                                                       00036002
* DESCRIPTIVE NAME:      GRAPHIC ENTRY INTERFACE ROUTINE                00038002
*                                                                       00038402
* COPYRIGHT:             NONE                                           00038802
*                                                                       00039202
* STATUS:                RELEASE 2.0                                    00039602
*                                                                       00039702
* FUNCTION:              THIS MODULE PERFORMS FUNCTIONS FOR             00039802
*                                                                       00039902
*FILL IN FROM SPECS******CONTINUED*NEXT*PAGE*************************** 00046602
         EJECT                                                          00048602
IGG019OJ CSECT                                                          00050602
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   00052602
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  00053002
*STATUS:CHANGE LEVEL 0                                                  00053302
*FUNCTION:THIRD LEVEL GRAPHIC CONTROL PROGRAM THAT GIVES CONTROL TO     00060002
*         USER SPECIFIED ATTENTION ROUTINE AND PLACES ATTENTION DATA    00080002
*         IN USERS COMAREA.                                             00100002
*         1.DETERMINE IF USER ROUTINE DESIRES THE ATTENTION TYPE BEING  00120002
*         SERVICES.IF NOT,THE DATA IS DISCARDED.                        00140002
*         2.DETERMINE WHERE TO GIVE USER CONTROL IE:VIA EP2 OR EP IN    00160002
*         GACB.                                                         00180002
*         3.PLACE DATA IN COMAREA.                                      00200002
*ENTRY POINT:SCHEDULED BY SECOND LEVEL GRAPHIC CONTROL PROGRAM VIA AEE  00220002
*         STAGE 2.                                                      00240002
*INPUT:1.GR#0=IQE ADDRESS.                                              00260002
*      2.GR#1=GACB ADDRESS.                                             00280002
*      3.GR'S 13,14,15 AS PER CONVENTIONS.                              00300002
*OUTPUT:DATA TO USER'S COMAREA.                                         00320002
*EXTERNAL ROUTINES:1.USER ATTENTION ROUTINE.                            00340002
*                  2.SVC 3 (EXIT SVC)                                   00360002
*EXITS:1.TO USER VIA GR#15 ON ACCEPTED ATTENTIONS.                      00380002
*      2.TO IOS VIA SVC 3 ON USER REJECTED ATTENTIONS.                  00400002
*TABLES/WORKAREAS:1.USER COMAREA                                        00420002
*                 2.USER GACB                                           00440002
*ATTRIBUTES:1.RESIDENT WITH GRAPHIC JOB(LOADED AT OPEN TIME).           00460002
*           2.RE-ENTRANT                                                00480002
*NOTES:N/A                                                              00500002
         EJECT                                                          00510002
*                                                                       00520002
*        REGISTER DEFINITION                                            00540002
*                                                                       00560002
R0       EQU   0                                                        00580002
R1       EQU   1                                                        00600002
R2       EQU   2                                                        00620002
RBASE    EQU   3                                                        00640002
RPFK     EQU   4                                                        00660002
RTYP     EQU   5                                                        00680002
R6       EQU   6                                                        00700002
R7       EQU   7                                                        00720002
R8       EQU   8                                                        00740002
R9       EQU   9                                                        00760002
R10      EQU   10                                                       00780002
RIQE     EQU   11                                                       00800002
RGACB    EQU   12                                                       00820002
RSAVE    EQU   13                                                       00840002
RTNRG    EQU   14                                                       00860002
ENTRG    EQU   15                                                       00880002
*                                                                       00900002
*        GACB  TYPE VALUES                                              00920002
*                                                                       00940002
ENDAN    EQU   X'01'                   END KEY OR A/N ATTN              00960002
PFKB     EQU   X'02'                                                    00980002
*                                                                       01000002
*                                                                       01020002
*                                                                       01040002
ONE      EQU   1                       ONE                              01060002
TWO      EQU   2                       TWO                              01080002
ZERO     EQU   0                       ZERO                             01100002
         EJECT                                                          01110002
         SAVE  (14,12)                                                  01140002
         BALR  RBASE,R0                SET UP BASE REG                  01160002
         USING *,RBASE                 DEFINE BASE REG                  01180002
         B     *+24                                                     01190002
MODID    DC    C'IGG019OJ.VS2R2.73270'          MODULE EYECATCHER ID    01192002
         LR    RGACB,R1                SAVE PARAM                       01200002
         LR    RIQE,R0                 SAVE PARM                        01220002
         USING IQEFLDS,RIQE                                             01240002
         USING GACBFLDS,RGACB                                           01260002
         LA    RPFK,ZERO               ZERO REG                         01280002
         L     RTYP,SEARCH             LOAD ATNTYP SEARCH MASK          01300002
         CLI   TYPE,ENDAN              END KEY                          01320002
         BC    8,GEIR01                BRANCH IF YES                    01340002
         CLI   TYPE,PFKB               PF KEY ATTN                      01360002
         BC    8,GEIR02                BRANCH IF YES                    01380002
         SR    R2,R2                   CLEAR REG                        01400002
         IC    R2,TYPE                 INSERT TYPE FIELD                01420002
         LA    R6,TWO                  LOAD CONSTANT                    01440002
         SR    R2,R6                   DETERMINE SHIFT COUNT            01460002
         SLL   RTYP,ZERO(R2)           DETERMINE SEARCH ARGUMENT        01480002
         B     GEIR01                  BRANCH TO SEARCH                 01500002
GEIR02   LA    RTYP,ZERO               ZERO REG                         01520002
         SR    R6,R6                   ZERO REG                         01540002
         IC    R6,KEY                  INSERT KEY NO.                   01560002
         L     RPFK,PFKSRCH            LOAD PFK SEARCH ARGUMENT         01580002
         SRL   RPFK,ZERO(R6)           DETERMINE PF SEARCH ARGUMENT     01600002
GEIR01   L     R6,PFKMSK               LOAD ARGUMENT                    01620002
         L     R7,ATNTYP               LOAD ARGUMENT                    01640002
         NR    R6,RPFK                 SEE IF MATCH                     01660002
         NR    R7,RTYP                 SEE IF MATCH                     01680002
         LTR   R6,R6                   WAS THERE A MATCH                01700002
         BC    7,GEIR07                BRANCH IF YES                    01720002
         LTR   R7,R7                   WAS THERE AMATCH                 01740002
         BC    7,GEIR07                BRANCH IF YES                    01760002
GEIROUT  SVC   3                       RETURN TO SUPV                   01780002
         EJECT                                                          01790002
GEIR07   L     R7,EP2                        LOAD ADR                   01800002
         LTR   R7,R7                   EP2=0                            01820002
         BC    7,GEIR08                BRANCH IF NO                     01840002
         L     R7,EP1                  EP1=0                            01860002
         LTR   R7,R7                   EP1=0                            01880002
         BC    8,GEIROUT               BRANCH IF YES                    01900002
         LR    ENTRG,R7                ENTRY ADR TO REG                 01920002
         L     R10,COMARA              LOAD COMAREA ADR                 01940002
         MVC   ZERO(12,R10),RSVD       DATA TO COMAREA                  01960002
         LM    0,12,20(13)             RESTORE REGS                     01980002
         BR    ENTRG                   TO USER ATTENTION ROUTINE        02000002
GEIR08   LR    ENTRG,R7                ADR TO ENTRY REG                 02020002
         LA    R7,ZERO                 ZERO REG                         02040002
         ST    R7,EP2                  ZERO EP2                         02060002
         L     R10,COMARA              LOAD COMAREA ADR                 02080002
         MVC   ZERO(12,R10),RSVD       MOVE DATA TO COMAREA             02100002
         L     RSAVE,REG13             LOAD REG 13                      02120002
         LM    0,12,20(13)             RESTORE REGS                     02140002
         BR    ENTRG                   TO USER ATTENTION ROUTINE        02160002
         EJECT                                                          02170002
         DS    0F                                                       02180002
PFKSRCH  DC    X'80'                                                    02200002
         DC    AL3(0)                                                   02220002
SEARCH   DC    AL3(0)                                                   02240002
         DC    X'01'                                                    02260002
         SPACE 3                                                        02270002
IQEFLDS  DSECT                                                          02280002
IQELNK   DS    1F                                                       02300002
IQEPARM  DS    1F                                                       02320002
IQEIRB   DS    1F                                                       02340002
IQETCB   DS    1F                                                       02360002
RSVD     DS    BL1                                                      02380002
OV       DS    BL1                                                      02400002
KEY      DS    BL1                                                      02420002
TYPE     DS    BL1                                                      02440002
SENSEMI  DS    1F                                                       02460002
         SPACE 3                                                        02470002
GACBFLDS DSECT                                                          02480002
COMARA   DS    1F                                                       02500002
DCB      DS    1F                                                       02520002
PFKMSK   DS    1F                                                       02540002
ATNTYP   DS    1F                                                       02560002
EP1      DS    1F                                                       02580002
EP2      DS    1F                                                       02600002
REG13    DS    1F                                                       02620002
PFKEY    DS    1F                                                       02640002
ATNTYPS  DS    1F                                                       02660002
ECB      DS    1F                                                       02680002
Q2       DS    1F                                                       02700002
RESERVED DS    1F                                                       02720002
         END                                                            02740002
./  ADD  SSI=80120229,NAME=IGG019OK
*TITLE 'ATTENTION INQUIRY ROUTINE'                                      00300002
*STATUS:CHANGE LEVEL 0                                                  00600002
*FUNCTION:MODE DEPENDENT                                                00900002
*        1.MODE=R-RELINQUISH CONTROL FOR USER ATTENTION ROUTINE IF EP   01200002
*         IN GACB NOT EQUAL TO ZERO. WHEN USER GAINS CONTROL IT WILL    01500002
*         BE GIVEN AT NSI AFTER MODE=R.IF EP IN GACB=0 R IS TREATED AS  01800002
*         MODE=W.                                                       02100002
*        2.MODE=W-IF REQUESTED DATA NOT AVAILABLE IT WILL PLACE ISSUING 02400002
*          ROUTINE IN WAIT STATE.IF DATA IS AVAILABLE,MOVES DATA TO     02700002
*          USER COMAREA AND RETURNS CONTROL TO NSI AFTER MODE=W.        03000002
*        3.MODE=C-IF DATA DESIRED IS AVAILABLE IT IS SELECTIVELY        03300002
*          DEQUEUED AND PLACED IN COMAREA;CONTROL RETURNED VIA BRANCH   03600002
*          ADDRESS.IF DATA NOT AVAILABLE CONTROL RETURNED TO NSI        03900002
*          AFTER MODE=C.                                                04200002
*        4.MODE=CLEAR-REMOVES ALL DATA FROM USER INPUT QUEUE(MUST LEAVE 04500002
*          ONE IQE ON USER IRB RBIQE FIELD FOR SYSTEM TO REMOVE)AND     04800002
*          RETURNS CONTROL TO THE ROUTINE THAT WAS INTERRUPTED TO GIVE  05100002
*          ATTENTION ROUTINE CONTROL.                                   05400002
*ENTRY POINT:VIA BALR 14,15 FROM ISSUING ROUTINE.                       05700002
*INPUT:GR#1 POINTS TO PARAMETER LIST;GRS#13,14,15 AS PER CONVENTIONS.   06000002
*OUTPUT:MODE DEPENDENT;SEE FUNCTION.                                    06300002
*EXTERNAL ROUTINES:DEQUEUE(SVC 72)                                      06600002
*EXITS:VIA RETURN MACRO OR SVC 3.                                       06900002
*TABLES/WORK AREAS:N/A                                                  07200002
*ATTRIBUTES:1.RESIDENT WITH GRAPHIC JOB                                 07500002
*           2.RE-ENTRANT                                                07800002
*           3.PROBLEM PROGRAM STATE                                     08100002
*NOTES:N/A                                                              08400002
*                                                                       08700002
*        REGISTER DEFINITION                                            09000002
*                                                                       09300002
PAR0     EQU   0                       PARAM REG 0                      09600002
PAR1     EQU   1                       PARAM REG 1                      09900002
BASERG   EQU   2                       BASE REG                         10200002
RGACB    EQU   3                       GACB ADR REG                     10500002
REBRG    EQU   4                       ROUTINE ENTRY BLOCK ADR REG      10800002
RLIST    EQU   5                       LIST DSECT REG                   11100002
RPFK     EQU   6                       SAVE REG FOR PFK MASK            11400002
RSAVE    EQU   7                       SAVE REG FOR GACB MASK ATTNTYP   11700002
R8       EQU   8                       WORK REG                         12000002
R9       EQU   9                       WORK REG                         12300002
R10      EQU   10                      WORK REG                         12600002
R11      EQU   11                      WORK REG                         12900002
R12      EQU   12                      WORK REG                         13200002
SAVRG    EQU   13                      SAVE AREA PTR                    13500002
RTNRG    EQU   14                      RETURN REG                       13800002
RCODE    EQU   15                      RETURN CODE REG                  14100002
*                                                                       14400002
*                                                                       14700002
FOUR     EQU   4                       FOUR                             15000002
ZERO     EQU   0                       ZERO                             15300002
REL      EQU   X'01'                   RELINQUISH MODE                  15600002
WAIT     EQU   X'02'                   WAIT MODE                        15900002
COND     EQU   X'04'                   CONDITIONAL MODE                 16200002
CLEAR    EQU   X'08'                   CLEAR MODE                       16500002
ANY      EQU   X'00'                   TYPE ANY(USE GACB MASK)          16800002
END      EQU   X'01'                   END OR A/N TYPE                  17100002
LP       EQU   X'02'                   LIGAT PEN TYPE                   17400002
EOS      EQU   X'03'                   END ORDER SEQUENCE TYPE          17700002
CANCEL   EQU   X'04'                   CANCEL TYPE                      18000002
AE       EQU   X'05'                   ASYNCHRONOUS ERROR               18300002
A2260    EQU   X'06'                   2260 TYPE                        18600002
POSTED   EQU   X'00'                   WAIT/POST BYTE OF ECB    YA03228 18650002
IRB      EQU   16                      IRB ADR IN REB                   18900002
CVTADR   EQU   16                      ADR OF CVT TABLE                 19200002
TCBP     EQU   0                       TABLE OF TCB ADRS                19500002
TCBCUR   EQU   4                       CURRENT TCB ADR                  19800002
TCBIRB   EQU   0                       CURRENT(ACTIVE)RB                20100002
EXIT     EQU   3                       EXIT FROM ROUTINE SVC NO.        20400002
DEQUEUE  EQU   75                      DEQUEUE RTN SVC NO.              20700002
WAITST   EQU   X'80'                   WAIT BIT                         21000002
RTN      EQU   12                      OFF SET TO RTN REG IN SAVE AREA  21300002
RTNIRB   EQU   16                      IRB ADR                          21600002
RTNTCB   EQU   32                      OFFSET FOR REB TCB ADR           21900002
SIX      EQU   6                       SIX                              22200002
EIGHT    EQU   8                       EIGHT                            22500002
ONE      EQU   1                       ONE                              22800002
RBIQE    EQU   24                      NEXT IQE OFF IRB                 23100002
ATTNERR  EQU   X'41'                                          LI F40815 23200002
IGG019OK CSECT                                                          23400002
* 465000-470000,516000                                           A31230 23800002
*A232000,A442000-445000,A541000-542000,A697000                LI F40815 24000002
*A186500,A443500-443600,A516500,D528000                         YA03228 24050002
*C496000-497000,A684020-687050                              E12 ZA20103 24100000
*                                                                       24150002
*                                                                       24200002
         SAVE  (14,12)                                                  24300002
         BALR  BASERG,PAR0             SET UP BASE REG                  24600002
         USING *,BASERG                DEFINE BASE REG                  24900002
         USING PARLIST,RLIST           DEFINE DSECT REG                 25200002
         USING GACB,RGACB              DEFINE DSECT REG                 25500002
         LR    RLIST,PAR1              LOAD PARAM LIST REG              25800002
         L     RGACB,GACBADR           LOAD GACB ADDRESS                26100002
         LA    RGACB,ZERO(0,RGACB)     ZERO HIGH ORDER BYTE             26400002
         LTR   RGACB,RGACB             REG=0                            26700002
         BC    7,AT01                  BRANCH IF NO                     27000002
         WTO   'IFF321I ATTNINQ FOUND NO GACB ADDRESS IN PARAMETER LISTX27100002
               ',ROUTCDE=11,DESC=7                               S21016 27200002
         LA    RCODE,X'10'              NO GACB ADDR IN            JFCC 27300002
         B     RTNUSCD                  PARAM LIST--RETURN         JFCC 27600002
AT01     L     R8,EP2                  LOAD EP2 ADR                     27900002
         LA    R8,ZERO(0,R8)           ZERO HI ORDER BYTE               28200002
         LTR   R8,R8                   EP2=0                            28500002
         BC    8,AT02                  BRANCH IF YES                    28800002
         WTO   'IFF322I ATTNINQ FOUND NON-ZERO VALUE IN WORD SIX OF GACX28900002
               B',ROUTCDE=11,DESC=7                              S21016 29000002
         LA    RCODE,X'14'              EP2 CONTAINS ERRONEOUS     JFCC 29100002
         B     RTNUSCD                  DATA--RETURN               JFCC 29400002
AT02     L     REBRG,REBADR            LOAD REB ADR FROM GACB           29700002
         LA    REBRG,ZERO(0,REBRG)      ZERO HI ORDER BYTE              30000002
         LTR   REBRG,REBRG              ADDRESS EQUAL ZERO              30300002
         BC    7,AT00                  BRANCH IF NOT ZERO               30600002
         WTO   'IFF323I ATTNINQ FOUND GACB NOT INITIALIZED BY SPAR MACRX30700002
               O',ROUTCDE=11,DESC=7                              S21016 30800002
         LA    RCODE,X'18'              GACB NOT SPARED            JFCC 30900002
         B     RTNUSCD                  RETURN                     JFCC 31200002
*                                                                       31500002
*                   GET CURRENT TCB ADDRESS                             31800002
*                                                                       32100002
AT00     L     R8,CVTADR               LOAD CVT ADR                     32400002
         L     R8,TCBP(R8)             LOAD OLD/NEW TCB                 32700002
         L     R8,TCBCUR(R8)           LOAD CURRENT TCB ADR             33000002
         LA    R8,ZERO(R8)             CLEAR HI-ORDER BYTE              33300002
         L     R9,RTNTCB(REBRG)        LOAD REB TCB ADR                 33600002
         LA    R9,ZERO(R9)             CLEAR HI-ORDER BYTE              33900002
         CR    R8,R9                   DOES CURRENT TCB ADR = REBTCB    34200002
         BE    AT14                    BRANCH IF WQUAL                  34500002
         WTO   'IFF324I ATTNINQ NOT ISSUED IN SAME TASK AS SPAR MACRO FX34600002
               OR GACB',ROUTCDE=11,DESC=7                        S21016 34700002
         LA    RCODE,X'1C'              ATTNINQ ISSUED FROM OTHER  JFCC 34800002
         B     RTNUSCD                  THAN SPARED TASK--RETURN   JFCC 35100002
*                                                                       35400002
AT14     CLI   MODE,REL                 MODE=R                          35700002
         BC    7,AT03                  BRANCH IF NO                     36000002
         L     R8,EP1                  LOAD EP1 ADR FROM GACB           36300002
         LA    R8,ZERO(0,R8)           ZERO HI ORDER BYTE               36600002
         LTR   R8,R8                   EP1=0                            36900002
         BC    8,AT04                  BRANCH IF YES                    37200002
         L     R8,IRB(0,REBRG)         LOAD ROUTINE IRB ADR             37500002
         LA    R8,ZERO(0,R8)           ZERO HIGH ORDER BYTE             37800002
         L     R9,CVTADR               LOAD CVT TABLE ADR               38100002
         L     R9,TCBP(0,R9)           LOAD OLD/NEW TCBS                38400002
         L     R9,TCBCUR(0,R9)         LOAD CURRENT TCB ADR             38700002
         L     R9,TCBIRB(0,R9)         LOAD CURRENT IRB ADR             39000002
         LA    R9,ZERO(0,R9)           ZERO HI ORDER BYTE               39300002
         CLR   R8,R9                   IRB ADRS COMPARE                 39600002
         BC    7,AT04                  BRANCH IF NO                     39900002
         ST    RTNRG,EP2               STORE IN LINE RETURN ADR OF      40200002
*                                      CALLING ROUTINE IN EP2 FIELD     40500002
*                                      OF GACB                          40800002
         ST    SAVRG,REG13             STORE CALLING ROUTINES SAVE      41100002
*                                      AREA PTR IN GACB                 41400002
         SVC   EXIT                    RETURN TO IOS                    41700002
AT03     CLI   MODE,CLEAR              MODE=CLEAR                       42000002
         BC    8,ATCLEAR               BRANCH IF YES                    42300002
         CLI   MODE,COND               MODE=C                           42600002
         BC    8,ATCOND                BRANCH IF YES                    42900002
         CLI   MODE,WAIT               MODE=W                           43200002
         BC    8,AT04                  BRANCH IF YES                    43500002
         WTO   'IFF325I ATTNINQ FOUND INVALID MODE FIELD IN PARAMETER LX43600002
               IST',ROUTCDE=11,DESC=7                            S21016 43700002
         LA    RCODE,X'20'              INVALID MODE IN PARAM      JFCC 43800002
         B     RTNUSCD                  LIST--RETURN               JFCC 44100002
AT04     TM    ECB,WAITST              ALREADY IN WAIT        LI F40815 44200002
         BO    AT04A                   YES, BRANCH            LI F40815 44300002
         CLI   ECB,POSTED            ECB ALREADY POSTED?        YA03228 44350002
         BNE   AT04A                 YES,DON'T INITIALIZE       YA03228 44360002
         MVC   ECB(FOUR),INIT          INITIALIZE ECB         LI F40815 44400002
AT04A    LR    PAR1,RGACB              GACB ADDRESS IN REG 1  LI F40815 44500002
         LA    PAR0,ZERO               ZERO PAR REG0                    44700002
         IC    R10,RSVD                INSERT OFFSET                    45000002
         SLL   R10,24                  POSITION OFFSET                  45300002
         OR    PAR1,R10                ADD OFF SET TO PARAM             45600002
         SVC   DEQUEUE                 CALL DEQUEUE ROUTINE             45900002
         CLI   MODE,COND               MODE=C                           46200002
         BNE   AT06                    BRANCH IF NO              A31230 46600002
         CLI   TYPE,ANY                ATTNINQ TYPE=ANY?         A31230 47000002
         BC    7,AT05                  BRANCH IF NO TO RESTORE GACB     47400002
*                                      MASKS                            47700002
AT06     LA    R8,ZERO                 LOAD ZERO                        48000002
         CLR   RCODE,R8                RETURN CODE=0                    48300002
         BC    8,AT07                  BRANCH IF YES                    48600002
         LA    R8,FOUR                 LOAD FOUR                        48900002
         CLR   RCODE,R8                RETURN CODE=4                    49200002
         BC    8,AT08                  BRANCH IF YES                    49500002
DEQUEBAD WTO   'IFF326I ATTNINQ UNSUCCESSFUL DUE TO INTERNAL DEQUEUE ERX49600000
               ROR',ROUTCDE=11,DESC=7                       E12 ZA20103 49700000
         LA    RCODE,X'24'              RTN CODE FROM DEQUEUE      JFCC 49800002
         B     RTNUSCD                  NOT ZERO--RETURN           JFCC 50100002
AT07     CLI   MODE,WAIT               MODE=W                           50400002
         BC    8,AT09                  BRANCH IF YES                    50700002
         CLI   MODE,REL                MODE=R                           51000002
         BC    8,AT09                  BRANCH IF YES                    51300002
RTNUSER  SR    RCODE,RCODE             SET RC=0 - OK             A31230 51600002
         ST    RCODE,ECB             CLEAR ECB                  YA03228 51650002
RTNUSCD  RETURN (14,12),RC=(15)                                         51900002
AT09     TM    ECB,WAITST              RTN ALREADY IN WAIT STATE        52200002
         BC    1,AT10                  BRANCH IF YES                    52500002
         SRL   R10,24                  POSITION OFFSET                  53100002
         STC   R10,RESERVED            STORE OFFSET IN GACB             53400002
         LA    PAR1,ECB                LOAD ECB ADR                     53700002
         WAIT  ECB=(1)                                                  54000002
         CLI   ECB,ATTNERR             COMP. CODE=X'41'       LI F40815 54100002
         BE    AT04A                   YES, RETRY             LI F40815 54200002
         B     RTNUSER                 BRANCH                           54300002
AT10     EQU   *                                                        54400002
         WTO   'IFF327I ATTNINQ FOR MODE=R OR W FOUND ATTENTION ROUTINEX54500002
                ALREADY WAITING',ROUTCDE=11,DESC=7               S21016 54600002
         LA    RCODE,X'28'              ROUTINE ALREADY IN       JFCC   54700002
         B     RTNUSCD                  WAIT STATE--RETURN         JFCC 54900002
AT05     ST    RPFK,PFKMSK             RESTORE PF MASK IN GACB          55200002
         ST    RSAVE,ATNTYP            RESTORE ATTNTYP MASK IN GACB     55500002
         B     AT06                    BRANCH                           55800002
AT08     CLI   MODE,WAIT               MODE=W                           56100002
         BC    8,RTNUSER               RETURN IN LINE TO CALLER         56400002
         CLI   MODE,REL                MODE=R                           56700002
         BC    8,RTNUSER               BRANCH IF YES                    57000002
         L     R8,BRADR                LOAD BRANCH ADR                  57300002
         LA    R8,ZERO(0,R8)           ZERO HIGH ORDER BYTE             57600002
         LTR   R8,R8                   BRANCH ADR=0                     57900002
         BC    8,AT11                  BRANCH IF YES                    58200002
         ST    R8,RTN(SAVRG)           REPLACE IN LINE ADR WITH         58500002
*                                      BRANCH ADR                       58800002
         B     RTNUSER                 BRANCH                           59100002
AT11     EQU   *                                                        59200002
         WTO   'IFF328I ATTNINQ FOR MODE=C FOUND NO BRANCH ADDRESS IN PX59300002
               ARAMETER LIST',ROUTCDE=11,DESC=7                  S21016 59400002
         LA    RCODE,X'2C'              MODE 'C' BR ADDR          JFCC  59500002
         B     RTNUSCD                  EQUAL ZERO--RETURN         JFCC 59700002
ATCOND   CLI   TYPE,ANY                ATTNINQ TYPE=ANY                 60000002
         BC    8,AT04                  BRANCH IF YES                    60300002
         L     RPFK,PFKMSK             SAVE PFK MASK FROM GACB          60600002
         L     RSAVE,ATNTYP            SAVE ATNTYP MASK FROM GACB       60900002
         SR    R8,R8                   CLEAR REGISTER                   61200002
         IC    R8,TYPE                 INSERT TYPE FIELD                61500002
         LA    R9,SIX                  LOAD CONSTANT                    61800002
         CLR   R8,R9                   COMPARE                          62100002
         BC    2,AT13                  BRANCH IF TYPE GREATER THAN SIX  62400002
         LA    R9,ONE                  LOAD CONSTANT                    62700002
         SR    R8,R9                   SUBTRACT ONE FROM TYPE           63000002
         SLL   R9,0(R8)                DETERMINE SEARCH ARGUMENT        63300002
         ST    R9,ATNTYP               PUT NEW TYPE IN GACB             63600002
         LA    R9,ZERO                 LOAD ZERO                        63900002
         ST    R9,PFKMSK               PUT NEW TYPE IN GACB             64200002
         B     AT04                    BRANCH                           64500002
AT13     LA    R9,EIGHT                LOAD CONSTANT                    64800002
         SR    R8,R9                   DETERMINE KEY NUMBER             65100002
         L     R9,PFKCODE              LOAD MASK                        65400002
         SRL   R9,ZERO(R8)             DETERMINE PF KEY ARGUMENT        65700002
         ST    R9,PFKMSK               STORE NEW PF MASK IN GACB        66000002
         LA    R9,ZERO                 ZERO REG                         66300002
         ST    R9,ATNTYP               STORE NEW ATNTYP MASK IN GACB    66600002
         B     AT04                    BRANCH                           66900002
ATCLEAR  LR    PAR1,RGACB              GACB ADR TO PARAM REG            67200002
         L     R8,RTNIRB(0,REBRG)      LOAD IRB ADR                     67500002
         LA    R8,RBIQE(0,R8)          LOAD RBIQE ADR                   67800002
         LR    PAR0,R8                 ADR TO PARAM REG                 68100002
         SVC   DEQUEUE             CALL DEQUEUE ROUTINE                 68400002
         LTR   RCODE,RCODE             RETURN CODE = ZERO   E12 ZA20103 68450000
         BZ    RTNUSCD             RETURN TO USER ATTN RTN  E12 ZA20103 68700000
         B     DEQUEBAD               GIVE MSG,NON-ZERO RC  E12 ZA20103 68750000
         DS    0F                                                       69000002
PFKCODE  DC    X'80'                                                    69300002
         DC    AL3(0)                                                   69600002
INIT     DC    X'00FFFFFF'                                    LI F40815 69700002
         CNOP  0,8                                                      69900002
PARLIST  DSECT                                                          70200002
GACBADR  DS    1F                                                       70500002
MODE     DS    BL1                                                      70800002
RSVD     DS    BL1                                                      71100002
TYPE1    DS    BL1                                                      71400002
TYPE     DS    BL1                                                      71700002
BRADR    DS    1F                                                       72000002
GACB     DSECT                                                          72300002
COMARA   DS    1F                                                       72600002
DCB      DS    1F                                                       72900002
PFKMSK   DS    1F                                                       73200002
ATNTYP   DS    1F                                                       73500002
EP1      DS    1F                                                       73800002
EP2      DS    1F                                                       74100002
REG13    DS    1F                                                       74400002
PFKEY    DS    1F                                                       74700002
ATNTYPS  DS    1F                                                       75000002
ECB      DS    1F                                                       75300002
REBADR   DS    1F                                                       75600002
RESERVED DS    1F                                                       75900002
         END                                                            76200002
./  ADD  SSI=80300147,NAME=IGG0193Y
         TITLE ' GRAPHICS OPEN EXECUTOR '                               00050002
*********************************************************************** 00100002
*                                                                       00150002
* MODULE NAME:           IGG0193Y (OS/VS2)                              00200002
*                                                                       00250002
* DESCRIPTIVE NAME:      GRAPHICS OPEN EXECUTOR                         00300002
*                                                                       00350002
* COPYRIGHT:             NONE                                           00400002
*                                                                       00450002
* STATUS:                RELEASE 2.0                                    00500002
*                                                                       00550002
* FUNCTION:              THIS MODULE PERFORMS ALL OPEN FUNCTIONS FOR    00600002
*                        THE 2250S AND 2260S SUPPORTED BY GPS.          00650002
*                                                                       00700002
*                        THIS INCLUDES:                                 00750002
*                          1. VALIDITY CHECKS.                          00800002
*                                A. UCB IS A GRAPHICS SUPPORTED DEVICE  00850002
*                                     1. 2250 )   ALL MODELS SUPPORTED  00900002
*                                     2. 2260 )))       AND             00950002
*                                     3. 1053 )   ALL LOCALLY ATTACHED  01000002
*                                B. GNCP RANGE IN DCB IS 1 THRU 99      01050002
*                                C. SAME TASK IN CONTROL IF MULTI DCBS  01100002
*                                     PER DEVICE ARE USED               01150002
*                          2. BUILDING AND INITIALIZING THE REQUIRED    01200002
*                             CONTROL BLOCKS.                           01250002
*                                A. DCB                                 01260002
*                                B. DEB                                 01300002
*                                C. IOB                                 01350002
*                                D. UCB                                 01400002
*                                E. BASIC TEB                           01450002
*                                F. BASIC IRBS & IQES                   01500002
*                                     1. IGG019OE                       01550002
*                                     2. IFFCAN03                       01600002
*                                G. EXPRESS USER POLL LIST              01650002
*                                H. EXPRESS 2250 BUFFER TABLE           01700002
*                          3. LOADING THE NECESSARY I/O AND ATTENTION   01750002
*                             HANDLING MODULES.                         01800002
*                                A. IGG019OA FOR GRAPHICS I/O           01850002
*                                B. IGG019OB     CHANNEL ENDS           01900002
*                                C. IGG019OC     PAGE FIXING            01950002
*                                D. IGG019OE     BASIC ATTN ROUTER      02000002
*                                E. IGG019OJ     BASIC ATTN USER ENTRY  02050002
*                                F. IFFCAN03     BASIC 2250 CANCEL KEY  02100002
*                          4. UNLOCK 2250 KEYBOARDS IF PRESENT.         02150002
*                                                                       02200002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 02250002
         EJECT                                                          02300002
*********************************************************************** 02350002
* NOTES:                                                                02400002
*                                                                       02450002
*     DEPENDENCIES:      KEY 5 CONTROL IS RECEIVED FROM SYSTEM OPEN.    02500002
*                        USER DCB ADDRESS, KEY AVAIL FROM SYS WORKAREA. 02550002
*                        SYSTEM NUCLEUS, KEY 0, IS NOT FETCH PROTECTED. 02600002
*                        IF FIRST UCB ON TIOT IS GRAPHIC TYPE,          02650002
*                           ALL FOLLOWING UCBS WILL BE GRAPHIC.         02700002
*                                                                       02750002
*     RESTRICTION:       FOR 2250S, ONE DEVICE PER DCB WHICH RESULTS    02800002
*                                   IN ONE UCB PER DEB.                 02850002
*                                                                       02900002
*     RESISTERS:         SEE EQUATE DEFINITIONS FOLLOWING PROLOG        02950002
*                                                                       03000002
*     PATCH LABEL:       PATCH, A 50 BYTE DC AREA AT END OF MODULE      03050002
*                                                                       03100002
* MODULE TYPE:           EXECUTABLE CODE                                03150002
*                                                                       03200002
*    PROCESSOR:          ASSEMBLER XF                                   03250002
*                                                                       03300002
*    MODULE SIZE:        SEE PAGE 1 OF THIS LISTING                     03350002
*                                                                       03400002
*    ATTRIBUTES:                                                        03450002
*       AT ENTRY:        REENTRANT  ENABLED  SUPERVISOR STATE IN KEY 5  03500002
*       ASSUMED KEYS:    0, USER (AS RECORDED IN SYSTEM OPEN WORKAREA)  03550002
*                                                                       03600002
* ENTRY POINT:           IGG0193Y                                       03650002
*                                                                       03700002
*    PURPOSE:            SEE 'FUNCTION' HEADING ABOVE                   03750002
*                                                                       03800002
*    LINKAGE:            SEE 'INPUT', NEXT HEADING                      03850002
*                                                                       03900002
* INPUT:                 REGISTERS 5 THRU 8 AS FOLLOWS:                 03950002
*                          5 ADDR OF: TOP OF DCB LIST BEING PROCESSED   04000002
*                          6          TOP OF WHERE-TO-GO TABLE          04050002
*                          7          CURRENT ENTRY OF DCB LIST         04100002
*                          8          CURRENT ENTRY OF WHERE-TO-GO TAB  04150002
*                            NOTE: 4 CONTAINS A VALID WORKAREA ADDR     04200002
*                               ONLY IF CONTROL RECEIVED FROM SYS OPEN  04250002
*                                                                       04300002
* OUTPUT:                SEE 'FUNCTION' HEADING ABOVE                   04350002
*                                                                       04400002
* EXITS:                                                                04450002
*                                                                       04500002
*    NORMAL:             XCTL, USING WTG TABLE FOR MODULE ID            04550002
*                                                                       04600002
*    ERROR:              XCTL, USING PROBLEM DETERMINATION MACRO        04650002
*                          DMABCOND FOR MODULE ID                       04700002
*                                                                       04750002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 04800002
         EJECT                                                          04850002
*********************************************************************** 04900002
*                                                                       04950002
* EXTERNAL REFERENCES:                                                  05000002
*                                                                       05050002
*     ROUTINES:          IGC0007A TO ASSIGN EXPRESS 2250 BUFFER         05100002
*                        EXCP        UNLOCK 2250 KEYBOARDS              05150002
*                                                                       05200002
*     DATA AREAS:        SEE DSECT SECTION AT END OF LISTING            05250002
*                                                                       05300002
*     CONTROL BLOCKS:    SEE DSECT SECTION AT END OF LISTING            05350002
*                                                                       05400002
* TABLES:                TABLE OF TCB/ASCB ADDRESSES                    05450002
*                        WHERE-TO-GO TABLE (SEE IECDSECS DSECT)         05500002
*                                                                       05550002
* MACROS:                ASGNBFR       FREEMAIN       SETLOCK           05600002
*                        CIRB          GETMAIN        WAIT              05650002
*                        DEBCHK        LOAD           XCTL              05700002
*                        DMABCOND      MODESET        XCTLTABL          05750002
*                                                                       05800002
* CHANGE ACTIVITY:       MODULE HAS BEEN RESTRUCTURED TO CONSOLIDATE    05850002
*                        THE THREE PREVIOUS OPEN LOADS INTO A SINGLE    05900002
*                        LOAD MODULE.  CSECT FLAGS UPDATED WHERE        05950002
*                        APPROPIATE.                                    06000002
*                                                                       06050002
*                        FIXES DROPPED LIST:                            06100002
*                          SM3010   DEB CALCULATION CODE REWRITTEN      06150002
*                          SA40953  APPLIES TO GRAPHICS 2280 DEVICES    06200002
*                                   WHICH ARE NOT SUPPORTED IN VS       06250002
*                                                                       06300002
*********************************************************************** 06350002
         SPACE 3                                                        06400002
IGG0193Y CSECT                                                          06450002
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.PTF NO 06500000
*A409100                                                      LF YM5685 06510002
*A441000                                                      LF YM5684 06550002
*C402500,A475500-476000                                       LF YM4068 06590002
*C361000,C368000                                              LF YM4054 06640002
*A340000-340500                                              LD YA00809 06690002
*C177500                                                         YM1962 06740002
*A202000                                                         Y01021 06790002
*A111500-112000,274500-277000,278000-282000,479000-486500,5045 LB AOS/1 06840002
*A337000-339500,383000-383500                                   SA40756 06890002
*A492000,495000,497500                                           S21016 06940002
*D445500,A463700-463900                                      LG YM08088 06942000
*A474100-474200                                      LG ZA00500,YM08809 06944000
* C104000,A262600,A362100,C510000,A576600                    LG @ZM2360 06946000
*C336000,A336100-336200,A336520-336670A338300               E12 ZA25969 06947000
*C34050                                                     E12 ZA26129 06948000
          EJECT                                                         06950002
*********************************************************************** 07000002
*                                                                     * 07050002
*                        REGISTER ASSIGNMENTS                         * 07100002
*                                                                     * 07150002
*               TEMPORARY ASSIGNMENTS IN LOW NUMBER REGS              * 07200002
*               PERMANENT ASSIGNMENTS IN HIGH NUMBER REGS             * 07250002
*               INPUT NAMES IDENTICAL TO THOSE IN SYSTEM OPEN         * 07300002
*********************************************************************** 07350002
         SPACE                                                          07400002
RE       EQU   0    TEMPORARY:         ENTRY POINT ADDRESSES            07450002
RSIZE    EQU   0                       GETMAIN SIZES                    07500002
RADR     EQU   1                       ADDR WORK REG                    07550002
RCALC    EQU   1                       CALCULATIONS                     07600002
RBACK    EQU   14                      RETURN ADDRESS FOR LINKAGES      07650002
RLINK    EQU   15                      BRANCH ADDRESS FOR LINKAGES      07700002
RCODE    EQU   15                      RETURN CODES FROM LINKAGES       07750002
         SPACE                                                          07800002
RBASE    EQU   2    CONVENTIONS:       BASE REGISTER                    07850002
RDCB     EQU   3                       DCB ADDRESS REGISTER             07900002
RGMTCB   EQU   4                       TCB   FOR GETMAIN                07950002
RASCB    EQU   7                       ASCB  FOR GETMAIN                08000002
         SPACE                                                          08050002
RDDCTR   EQU   4    CALCULATIONS:      COUNTER OF DD ENTRIES            08100002
RCTR     EQU   4                       GENERAL COUNTER                  08150002
RDEL     EQU   5                       TOT DEVICE ENTRY LENGHT OF TIOT  08200002
RIDX     EQU   5                       UCB INDEX NUMBER                 08250002
RLOC     EQU   5                       LOCATION REG FOR INDEXING        08300002
RLGH     EQU   6                       LENGTH OF DEB IN BYTES           08350002
RDBWD    EQU   7                       LENGTH OF DEB IN DOUBLE WORDS    08400002
RCLR     EQU   8                       DEB LGH TO BE CLEARED IN BYTES   08450002
REXT     EQU   8                       NUMBER OF EXTENTS FOR IQES       08500002
RCOUNT   EQU   10                      LOOP COUNTER FOR NBR OF IQES     08550002
         SPACE                                                          08600002
RCORE    EQU   4   INPUT ADDRESSES:    WORKAREA ONLY IF FROM SYS OPEN   08650002
RPAR     EQU   5                       PARAMETER LIST OF DCB ADDRS      08700002
RWTG     EQU   6                       WTG TABLE, EG. LABEL 'DXXWTG'    08750002
RPARC    EQU   7                       CURRENT PARAMETER LIST ENTRY     08800002
RWTGC    EQU   8                       CURRENT WGT TABLE ENTRY          08850002
         SPACE                                                          08900002
RIRB     EQU   6   ADDRESSES:          IRB BEING INITIALIZED            08950002
RDEB     EQU   9                       DEB BEING CONSTRUCTED            09000002
RTCB     EQU   10                      CURRENT TCB FROM CVT TCB TABLE   09050002
RIOB     EQU   11                      IOB USED TO UNLOCK 2250 KEYBRDS  09060002
RTEB     EQU   11                      TEB BEING CONSTRUCTED/UPDATED    09100002
RTIOT    EQU   11                      TIOT DD ENTRY                    09150002
RUCB     EQU   12                      CURRENT UCB                      09200002
RSAVE    EQU   13                      SAVE AREA FOR OPEN               09250002
RSCB1    EQU   14                      TEMP SYS CB ADDRESSES            09300002
RSCB2    EQU   15                      TEMP SYS CB ADDRESSES            09350002
          EJECT                                                         09400002
*********************************************************************** 09450002
*                                                                     * 09500002
*                        EQUATES                                      * 09550002
*                                                                     * 09600002
*********************************************************************** 09650002
ACURASCB EQU   12     CURRENT ASCB ADDR LOC IN TCB TABLE                09700002
ACURTCB  EQU   4      CURRENT TCB ADDR LOC IN TCB TABLE                 09750002
ADR      EQU   4      ADDR LENGTH IS 4 BYTES                            09800002
BLANK    EQU   X'40'  CHECK FOR BLANK IN NAME FIELD                     09850002
DBLWRD   EQU   7                      ROUND TO DOUBLE WORD BDRY  SM1831 09900002
DBWD     EQU   3      DOUBLE WORD CALCULATIONS                          09950002
DCBADR   EQU   0      CURRENT DCB ADDR FROM INPUT PLIST                 10000002
ECBCC    EQU   X'7F'  ECB COMPLETION CODE FOR SUCCESSFUL I/O            10050002
FULLMASK EQU   X'FF'                   MASK OF ALL ONES         SA25381 10100002
POLSTACT EQU   X'FF'  ACTIVE FLAG FOR POLL LIST IN EXPRESS GRAPHICS     10150002
         SPACE                                                          10200002
DEBSIZE  EQU   79     MINIMUM DEB IS APG+PFX+BASE+ID                    10250002
DECBSIZE EQU   32     DECB USED FOR UNLOCKING 2250 KEYBOARD             10300002
IOBSIZE  EQU   72     MINIMUM IOB IS STD+EXT                            10350002
TEBSZ    EQU   36     SIZE OF TEB IN BYTES                   LG @ZM2360 10400000
         SPACE                                                          10450002
TTROFF   EQU   14                                                       10500002
TIOTOFF  EQU   17                                                       10550002
WAOFF    EQU   32                                                       10600002
WGOFF    EQU   8                                                        10650002
         SPACE                                                          10700002
ZERO     EQU   0      DECIMAL/HEX NUMBERS FOR GENERAL USE               10750002
ONE      EQU   1                                                        10800002
TWO      EQU   2                                                        10850002
THREE    EQU   3                                                        10900002
FOUR     EQU   4                                                        10950002
SIX      EQU   6                                                        11000002
SEVEN    EQU   7                                                        11050002
EIGHT    EQU   8                                                        11100002
SHFT11   EQU   11                      SHIFT COUNT                AOS/1 11150002
SHFT24   EQU   24                      SHIFT COUNT                AOS/1 11200002
         SPACE                                                          11250002
EXCP     EQU   0      SVC NUMBERS                                       11300002
         EJECT                                                          11350002
*********************************************************************** 11400002
*                                                                     * 11450002
*                        INITIALIZATION                               * 11500002
*                                                                     * 11502002
*         1. USING STATEMENTS IDENTIFY DSECT BASE REGISTERS           * 11510002
*         2. BASE ESTABLISHED FOR ADDRESSABILITY OF MODULE            * 11520002
*         3. MODULE EYECATCHER ID FOR RELEASE LEVEL VERIFICATION      * 11530002
*                                                                     * 11550002
*********************************************************************** 11600002
         SPACE 2                                                        11650002
         USING CVT,RSCB1         CVT DSECT INITZ FROM LOC 16            11700002
         USING FORCORE,RCORE     IECDSECS, KEY 5, REFERENCED ONLY       11750002
         USING IHADCB,RDCB       DCB DSECT; KEY 5: COPIED; KEY >7: USER 11800002
         USING IECTDEB,RDEB      DEB DSECT, KEY 5, CREATED BY GAM OPEN  11850002
         USING SAVEAREA,RSAVE    SAVE/WORK AREA, KEY 5, FOR GAM OPEN    11900002
         USING TCB,RTCB          STD DSECTS, KEY 0:  TCB                11950002
         USING TIOENTRY,RTIOT                        TIOT               12000002
         USING UCB,RUCB                              UCB                12050002
         SPACE 3                                                        12100002
         BALR  RBASE,0                                                  12150002
         USING *,RBASE                          SET UP BASE REGISTER    12200002
         B     *+24                                                     12250002
MODID    DC    C'IGG0193Y.VS2R2.14548'         MODULE EYECATCHER ID     12300000
         EJECT                                                          12350002
*********************************************************************** 12400002
*                                                                     * 12450002
*                        INITIALIZATION                               * 12520002
*                                                                     * 12570002
*         4. SAVE/WORK AREA IS USED TO PRESERVE REENTRANT STATUS.     * 12580002
*            INPUT REGS ARE SAVED NOW TO EXPAND NUMBER OF WORK REGS   * 12600002
*            DURING CONTROL BLOCK CONSTRUCTION.                       * 12700002
*         5. ACCESS TIOT DD ENTRY SO DEVICE TYPES CAN BE VALIDATED    * 12750002
*                                                                     * 12800002
*********************************************************************** 12850002
         L     RSIZE,SAVSPSIZ     GET SAVE/WORK AREA FOR GRAPHIC OPEN   12900002
         GETMAIN R,LV=(0)                                               12950002
         LR    RSAVE,RADR                                               13000002
OPEN0010 EQU *                                                          13050002
         STM   RPAR,RWTGC,R5         SAVE INPUT/UPDATED REGS            13100002
         L     RSCB1,CVTPTR          GET CVT ADDR FROM FIXED LOCATION   13150002
         L     RTCB,CVTTCBP          GET ADDRS OF TCB TABLE             13200002
         L     RSCB2,ACURASCB(RTCB)               ASCB                  13250002
         ST    RSCB2,ASCBADR                        KEEP FOR BR ENTRIES 13300002
         L     RTCB,ACURTCB(RTCB)                 CURRENT TCB           13350002
         L     RTIOT,TCBTIO                       TIOT                  13400002
         L     RDCB,DCBADR(RPARC) GET ADDR OF:  DCB TO BE PROCESSED     13450002
         L     RCORE,ADR(RWTGC)                 WORK AREA FOR THIS DCB  13500002
         ST    RCORE,R4                           KEEP AVAIL FOR USE    13550002
         L     RSCB2,DXUDCBAD                   USER'S DCB              13600002
         ST    RSCB2,UDCBADR                      KEEP AVAIL FOR I/O    13650002
         AH    RTIOT,DCBTIOT                    DD ENTRY                13700002
         EJECT                                                          13750002
*********************************************************************** 13800002
*                                                                     * 13850002
*                          VALIDITY CHECKS                            * 13900002
*                                                                     * 13950002
*        1. VALID DEVICE TYPES                                        * 14000002
*              A.  ASSUME ALL UCBS OK IF FIRST IS OK                  * 14050002
*        2. NUMBER OF CHANNEL PROGRAMS                                * 14100002
*        3. MULTIPLE TASKING, DONE LATER DURING ATTN HANDLING INITZ   * 14150002
*                                                                     * 14200002
*********************************************************************** 14250002
         L     RUCB,TIOESTTB     GET FIRST UCB ADDR                     14300002
         LA    RUCB,ZERO(RUCB)                                          14350002
         CLI   UCBTBYT3,UCB3DISP     IS DEVICE GRAPHICS TYPE            14400002
         BNE   IEC158I                  IF NO, ISSUE MSG AND ABEND D13  14450002
         CLI   UCBTBYT4,UCBT2250     IS DEVICE 2250 TYPE                14500002
         BE    OPEN0020                 IF YES,  OK TO PROCESS          14550002
         CLI   UCBTBYT4,UCBT2260     IS DEVICE 2260 TYPE                14600002
         BE    OPEN0020                 IF YES, OK TO PROCESS           14650002
         CLI   UCBTBYT4,UCBT1053     IS DEVICE 1053                     14700002
         BNE   IEC158I                  IF NO, ISSUE MSG AND ABEND D13  14750002
OPEN0020 EQU   *                                                        14800002
         CLI   DCBGNCP,DCBGNCPH      IS GNCP GREATER THAN 99            14850002
         BH    IEC159I                  IF YES, SET UP PD MSG & EXIT    14900002
         CLI   DCBGNCP,DCBGNCPL      IS GNCP LESS OR EQUAL TO 0         14950002
         BNH   IEC159I                  IF YES, SET UP PD MSG & EXIT    15000002
         EJECT                                                          15050002
*********************************************************************** 15100002
*                                                                     * 15150002
*                         DEB CONSTRUCTION                            * 15200002
*                                                                     * 15250002
*        1.   CALCULATE TOTAL DEB SIZE FOR GETMAIN                    * 15300002
*           A. SIZE IS FOUR BYTES PER DEVICE ENTRY PLUS DEB SIZE      * 15350002
*           B. DEB SIZE IS SUM OF PREFIX, BASIC, ETC.                 * 15400002
*                                                                     * 15450002
*********************************************************************** 15500002
         LR    RSCB1,RTIOT       USE TEMP REG FOR ADR CALC              15550002
         DROP RTIOT                                                     15600002
         USING TIOENTRY,RSCB1                                           15650002
         SR    RCALC,RCALC       INITZ FOR  CALC WORK REG               15700002
         SR    RDDCTR,RDDCTR                DD COUNT                    15750002
         SR    RDEL,RDEL                    DD ENTRY LGH IN BYTES       15800002
OPEN0030 LA    RDDCTR,ONE(RDDCTR)       COUNT EACH DD ENTRY             15850002
         IC    RCALC,TIOELNGH           GET LGH OF THIS DD ENTRY        15900002
         AR    RSCB1,RCALC              CALC ADR OF NXT DD ENTRY        15950002
         SH    RCALC,SIXTEEN            CALC LGH OF DEV ENTRIES         16000002
         AR    RDEL,RCALC                ACCUMULATE TOTAL LGH           16050002
         L     RSCB2,TIOELNGH            CK IF END OF TABLE             16100002
         LTR   RSCB2,RSCB2                                              16150002
         BZ    OPEN0040                    IF YES, CONTINUE WITH GM     16200002
         CLI   TIOEDDNM,BLANK              IF NO, CK FOR BLANK NAME     16250002
         BE    OPEN0030                      IF BLANK, COUNT CONCAT DD  16300002
OPEN0040 LA    RLGH,DEBSIZE(RDEL)    LOAD TOTAL DEB SIZE                16350002
         LA    RLGH,DBLWRD(RLGH)   ROUND UP TO DOUBLE WORD BDRY         16400002
         SRL   RLGH,DBWD           SHIFT OUT 7-ADDED FOR DB WD B        16450002
         LR    RDBWD,RLGH          SAVE FOR LATER USE IN DEB INITZ      16500002
         SLL   RLGH,DBWD           ROUND UP TO DB WORD IN BYTES         16550002
         LR    RSIZE,RLGH          KEEP FOR LATER USE IN CLEARING DEB   16600002
         O     RSIZE,DEBSPOOL      SUBPOOL NO INTO HIGH ORDER BYTE      16650002
         GETMAIN R,LV=(0)          DEB SIZE IN REGISTER 0               16700002
         LR    RDEB,RADR           DEB SIZE = 52 + 20 + 7 + UCB         16750002
         DROP  RSCB1               DROP TEMP REG USED FOR ADR CALC      16800002
         USING TIOENTRY,RTIOT                                           16850002
         EJECT                                                          16900002
*********************************************************************** 16950002
*                                                                     * 17000002
*                         DEB CONSTRUCTION                            * 17050002
*                                                                     * 17100002
* 2. CLEAR AND INITIALIZE DEB:                                        * 17150002
*  A. PREFIX SECTION FIRST, THEN BASIC SECTION BY ASCENDING LOCATIONS.* 17200002
*  B. APPENDAGE TABLE IS DONE AFTER DEB IS ADDED USING DEBCHK.        * 17250002
*  C. ID SECTION IS DONE AS MODULES ARE LOADED.                       * 17300002
*                                                                     * 17350002
*     REG CONTENTS:     RDBWD HAS  DEB SIZE IN DOUBLE WORDS           * 17400002
*                       RDEB       ADDR OF DEBEOEA (BEGINING OF APDG) * 17450002
*                       RLGH       DEB SIZE IN BYTES                  * 17500002
*                                                                     * 17550002
*********************************************************************** 17600002
OPEN0050 EQU   *                                                        17650002
         CH    RLGH,HWC256       CK IF DEB SIZE LESS THAN 256 BYTES     17700002
         BNH   OPEN0060             IF YES, SKIP CLEARING LOOP   YM1962 17750002
         LA    RCLR,FULLMASK            LENGTH IN RCLR FOR EX INSTR     17800002
         SH    RLGH,HWC256              SUBTRACT FOR SIZE CLEARED       17850002
         EX    RCLR,CLEAR               EXECUTE CLEAR DEB INSTRUCTION   17900002
         AH    RADR,HWC256              INCREMENT FOR NEXT SECTION      17950002
         B     OPEN0050                 REPEAT TIL DONE                 18000002
OPEN0060 EQU   *                                                        18050002
         BCTR  RLGH,RSIZE             DECREMENT BY 1 FOR EX INSTR       18100002
         EX    RLGH,CLEAR             LAST DEB SIZE CLEARED             18150002
         STC   RDBWD,DEBLNGTH             MOVE IN DOUBLE WORDS OF DEB   18200002
         ST    RTCB,DEBNMSUB              DEBTCBAD OVERLAYS DEBNMSUB    18250002
         SRL   RDEL,2                     DIVIDE UCBS BY 4              18300002
         STC   RDEL,DEBNMEXT              MOVE NO OF EXTENTS INTO DEB   18350002
         EJECT                                                          18400002
*********************************************************************** 18450002
*                                                                     * 18500002
*                         DEB CONSTRUCTION                            * 18550002
*                                                                     * 18600002
*     2. INITIALIZING DEB:                                            * 18650002
*         A. BASIC SECTION, CONT.: CHAIN DEB TO OTHER CONTROL BLOCKS  * 18700002
*           1). DCB           USER DCB FOR DEBCHK MACRO               * 18750002
*           2). TCB           KEY 0 CB                                * 18800002
*                                                                     * 18900002
*********************************************************************** 18950002
         L     RSCB1,UDCBADR          GET USER DCB ADDR                 19000002
         ST    RSCB1,DEBPROTG            USER DCB ADDR TO DEBDCBAD      19050002
         LA    RADR,DEBNMSUB          ACCESS ADDR OF BASIC DEB          19100002
         STCM  RADR,SEVEN,DCBDEBA        CHAIN TO COPIED DCB            19150002
         DROP  RCORE                                                    19200002
         USING FORCORE,RSCB2     IECDSECS, KEY 5, REFERENCED ONLY       19250002
         L     RSCB2,R4     GET ADDR OF WORKAREA                        19300002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             19350002
         DROP  RDCB                                                     19400002
         USING IHADCB,RSCB1           USER DCB ADDRESSING               19450002
         STCM  RADR,SEVEN,DCBDEBA        CHAIN TO USER DCB              19500002
         DROP  RSCB1                                                    19550002
         USING IHADCB,RDCB            COPY DCB ADDRESSING               19600002
         MODESET  EXTKEY=ZERO                                           19650002
         L     RSCB2,TCBDEB           GET FIRST DEB ADDR                19700002
OPEN0065 LA    RSCB2,ZERO(RSCB2)        INITZ DEBAMLNG TO ZERO          19750002
         ST    RSCB2,DEBAMLNG           STORE AMLNG/DEBPTR              19800002
         CS    RSCB2,RADR,TCBDEB      PUT NEW DEB ON TCB CHAIN          19850002
         BNE   OPEN0065               REPEAT IF FIRST DEB ADDR CHANGED  19900002
         EJECT                                                          19910002
*********************************************************************** 19920002
*                                                                     * 19930002
*                         DEB CONSTRUCTION                            * 19940002
*                                                                     * 19942002
*     2. INITIALIZING DEB:                                            * 19944002
*         A. BASIC SECTION, CONT.: CHAIN DEB TO OTHER CONTROL BLOCKS  * 19946002
*           3). DEB CHAIN     KEY 5 WITH DEBCHK MACRO                 * 19948002
*         B. BASIC SECTION, CONT.: ATTACH UCB ADDRESSES FROM TIOT     * 19948402
*         C. APPENDAGE TABLE, USING IOS RETURN ADDRESS                * 19948802
*                                                                     * 19949202
*********************************************************************** 19949602
         MODESET  EXTKEY=DATAMGT                                        19950002
         MVC   DEBPROTG,TCBPKF         STORAGE KEY TO DEB               20000002
         OI    DEBPROTG,DEBID          PROTECTION TAG FOR DEB ID        20050002
         ST    RDEB,DEBEXSCL             STORE DEB APPENDAGE TABLE ADR  20100002
         MVI   DEBEXSCL,X'02'           MOVE IN 2 FOR NON-DIR ACC DEV   20150002
         DEBCHK (RSCB1),TYPE=ADD,AM=GAM     ADD TO DEB TABLE  LB Y01021 20200002
         LA    RDEL,DEBUCBAD              ACCESS DEBUCB ADDRESS         20750002
OPEN0070 EQU   *                                                        20800002
         SR    RCALC,RCALC                 CLEAR LENGTH REGISTER        20850002
         IC    RCALC,TIOELNGH              LOCATE STARTING TIOT         20900002
         SH    RCALC,SEVNTEEN              UCBS PLUS 1 FOR EX INSTR     20950002
         EX    RCALC,UCBMOVE               MOVE UCBS FROM TIOT TO DEB   21000002
         LA    RDEL,ONE(RDEL,RCALC)        INCREMENT DEB POS BY LENGTH  21050002
         LA    RTIOT,TIOTOFF(RTIOT,RCALC)  INCREMENT TO PT TO NEXT TIOT 21100002
         BCT   RDDCTR,OPEN0070             GO GET NEXT UCB, IF ANY MORE 21150002
         DROP  RTIOT                                                    21200002
         USING CVT,RSCB1                                                21250002
         L     RSCB1,CVTPTR          ACCESS PTR TO CVT                  21300002
         L     RADR,CVTXAPG          LOAD IOS APPENDAGE TABLE ADDR      21350002
         L     RADR,ZERO(RADR)       LOAD IOS RETURN ADDR               21400002
         ST    RADR,DEBEOEA               STORE INTO DEB APPENDAGE      21450002
         ST    RADR,DEBSIOA                                             21500002
         ST    RADR,DEBPCIA                                             21550002
         EJECT                                                          21600002
*********************************************************************** 21650002
*                                                                     * 21700002
*                         IOB CONSTRUCTION                            * 21750002
*                                                                     * 21800002
*        1.   CALCULATE TOTAL IOB SIZE FOR GETMAIN                    * 21850002
*           A. SIZE IS IOBSIZE*(GNCP+1)+ECB IF GNCP<99                * 21900002
*           B. ECB SIZE IS 8 BYTES TO INCL POINTER TO NEXT AVAIL IOB  * 21950002
*                                                                     * 22000002
*********************************************************************** 22050002
         SR    RCTR,RCTR          CLEAR MULTIPLIER REG                  22100002
         SR    RSIZE,RSIZE        CLEAR FOR MULTIPLY PAIR               22150002
         IC    RCTR,DCBGNCP       GET GNCP INTO MULTIPLIER REG          22200002
         CLI   DCBGNCP,DCBGNCPH     IS GNCP EQUAL TO MAXIMUM            22250002
         BE    OPEN0080               IF YES, DON'T BUILD EXTRA IOB     22300002
         LA    RCTR,ONE(RCTR)         IF NO, ADD ONE FOR EXTRA IOB      22350002
OPEN0080 EQU   *                                                        22400002
         LA    RCALC,IOBSIZE      GET MINIMUM IOB SIZE                  22450002
         LR    RLGH,RCALC          SAVE LENGHT FOR LATER USE            22500002
         MR    RSIZE,RCTR          MULTIPLY IOB SIZE BY GNCP            22550002
         LA    RSIZE,EIGHT(RCALC)  TOTAL IOB CORE INTO REG 0            22600002
         MODESET EXTKEY=ZERO                                            22650002
         O     RSIZE,IOBSPOOL         SUBPOOL NO INTO HIGH ORDER BYTE   22700002
         GETMAIN R,LV=(0)           GET CORE FOR IOB S                  22750002
         XC    0(8,RADR),0(RADR)    CLEAR  1ST IOB -8                   22800002
         LA    RADR,EIGHT(RADR)     POINT PAST 1ST AVAIL PTR            22850002
         EJECT                                                          22900002
*********************************************************************** 22950002
*                                                                     * 23000002
*                         IOB CONSTRUCTION                            * 23050002
*                                                                     * 23100002
*       2. CHAIN IOB TO BOTH COPIED AND USER'S DCB (KEY 5 AND >7)     * 23150002
*       3. CLEAR AND INITIALIZE IOB FIELDS                            * 23200002
*  RADR:  IOB ADDRESS FROM GETMAIN AFTER TOP 8 BYTES ALLOCATED TO ECB * 23250002
*                                                                     * 23300002
*********************************************************************** 23350002
         MODESET  EXTKEY=DATAMGT                                        23400002
         ST    RADR,DCBIOBAD          CHAIN IOB TO COPY DCB             23450002
         L     RSCB1,UDCBADR          GET USER DCB ADDR                 23500002
         L     RSCB2,R4     GET ADDR OF WORKAREA                        23550002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             23600002
         DROP  RDCB                                                     23650002
         USING IHADCB,RSCB1           USER DCB ADDRESSING               23700002
         ST    RADR,DCBIOBAD          CHAIN IOB TO USER DCB             23750002
         DROP  RSCB1                                                    23800002
         USING IHADCB,RDCB            COPY DCB ADDRESSING               23850002
         MODESET  EXTKEY=ZERO                                           23900002
         USING DXIOB,RADR            TEMP BASE FOR IOB INITZ            23950002
         SR    RIDX,RIDX            CLEAR INDEX REGISTER                24000002
         BCTR  RLGH,RSIZE           DECREMENT BY 1 FOR EX INSTR         24050002
OPEN0090 EX    RLGH,CLEAR           CLEAR 1 IOB                         24150002
         MVI   IOBFLAG1,X'C2'       SET BITS 0, 1, AND 6                24200002
         MVI   IOBCSW+4,X'0F'       IND CHANNEL OPERATION COMP          24250002
         LA    RSIZE,IOBCCW1        GET CCW START ADDR                  24300002
         ST    RSIZE,IOBSIOCC       START ADDRESS IN IOB                24350002
         ST    RSCB1,IOBWGHT        STORE DCB ADDRESS                   24400002
         MVI   IOBWGHT,X'00'        CLEAR HIGH ORDER BYTE               24450002
         STC   RIDX,IOBUCBX         INDEX ZERO FOR FIRST UCB            24500002
         LA    RIDX,ONE(RIDX)       INCREMENT UCB INDEX COUNT           24550002
         CH    RCTR,NUMONE            IS THIS LAST IOB                  24610002
         BE    OPEN0100                 IF YES, SKIP UPDATE TO NEXT IOB 24650002
         LA    RSIZE,IOBSIZE(RADR)      IF NO, GET NEXT IOB LINK ADDR   24700002
         ST    RSIZE,IOBNXTPT                  PUT INTO IOB LINK ADR    24750002
OPEN0100 LA    RADR,ONE(RADR,RLGH)  BUMP FOR NEXT IOB CLEAR             24850002
         BCT   RCTR,OPEN0090        CLEAR NEXT IOB, IF ANY              24900002
         DROP  RADR                                                     24910002
         EJECT                                                          24950002
*********************************************************************** 25000002
*                                                                     * 25050002
*                        LOAD GRAPHICS ROUTINES                       * 25100002
*                                                                     * 25150002
*           DONE IN KEY 5 SUPERVISOR STATE FOR DEB SUBID UPDATES      * 25200002
*                AND CORRECT SUBPOOL FOR SYSTEM CLOSE DELETES         * 25250002
*               (SEE FUNCTION HEADING IN PROLOGUE FOR DETAILS)        * 25300002
*                                                                     * 25350002
*         1.     LOAD GIOCR  (MODULE NAME IGG019OA)                   * 25400002
*                                                                     * 25450002
*********************************************************************** 25500002
         MODESET  EXTKEY=DATAMGT                                        25550002
         SR    RCALC,RCALC         CALC LOC OF DEBSUBID FIELDS          25600002
         LA    RLOC,DEBUCBAD            ID SECTION FOLLOWS UCB ADDRS    25650002
         IC    RCALC,DEBNMEXT              GET NBR OF UCBS (EXTENTS)    25700002
         SLL   RCALC,2                     EXTENT SIZE IS 4 BYTES/ENTRY 25750002
         AR    RLOC,RCALC               POINT TO DEBSUBID FOR UPDATES   25800002
         SR    RCTR,RCTR           CLEAR FOR NBR OF RTNS LOADED         25850002
         USING CVT,RSCB1                                                25900002
         L     RSCB1,CVTPTR          GET PTR TO CVT                     25950002
         L     RADR,CVTSVDCB         GET SVC DCB PTR                    26000002
         LOAD  EP=IGG019OA,DCB=(RADR)                                   26050002
         MVC   ZERO(TWO,RLOC),IDGIOCR  MOVE ID TO DEB                   26100002
         LA    RLOC,TWO(RLOC)          POINT TO NEXT DEB SUB ID SECTION 26150002
         LA    RCTR,ONE(RCTR)          INCREMENT ROUTINES LOADED COUNT  26200002
         STCM  RE,SEVEN,DCBGIOCA     PLACE ENTRY POINT IN COPY DCB      26250002
         STCM  RE,SEVEN,R0+1         SAVE GIOCR ADDR FOR TEB LG @ZM2360 26260000
         L     RSCB1,UDCBADR         GET USER DCB ADDR                  26300002
         DROP  RDCB                                                     26350002
         USING IHADCB,RSCB1           USER DCB ADDRESSING               26400002
         L     RSCB2,R4              GET ADDR OF WORKAREA               26450002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             26500002
         STCM  RE,SEVEN,DCBGIOCA     PLACE ENTRY POINT IN USER DCB      26550002
         DROP  RSCB1,RSCB2                                              26600002
         USING IHADCB,RDCB            ADDRESSING:  COPY DCB             26650002
         USING FORCORE,RCORE                       CURRENT WORK AREA    26700002
         EJECT                                                          26750002
*********************************************************************** 26800002
*                                                                     * 26850002
*                        LOAD GRAPHICS ROUTINES                       * 26900002
*                                                                     * 26950002
*         2.      CHANNEL ENDS (MODULE NAME IGG019OB)                 * 27000002
*         3.      PAGE FIX     (MODULE NAME IGG019OC)                 * 27050002
*                                                                     * 27100002
*********************************************************************** 27150002
         MODESET EXTKEY=DATAMGT                                         27200002
         USING CVT,RSCB1                                                27250002
         L     RSCB1,CVTPTR              GET PTR TO CVT                 27300002
         L     RADR,CVTSVDCB             GET SVC DCB PTR                27350002
         LOAD  EP=IGG019OB,DCB=(RADR)                                   27400002
         MVC   ZERO(TWO,RLOC),IDCEXCE MOVE ID TO DEB              AOS/1 27450002
         LA    RLOC,TWO(RLOC)          NEXT DEB SUB ID SECTION    AOS/1 27500002
         LA    RCTR,ONE(RCTR)          INCR RTNS LOADED COUNT     AOS/1 27550002
         BAL   RBACK,PAGECTR           GO COMPUTE PAGE COUNT      AOS/1 27600002
         ST    RE,DEBCEA               STORE ADDRESS IN DEB AVT   AOS/1 27650002
         ST    RE,DEBXCEA              STORE ADDRESS IN DEB AVT   AOS/1 27700002
         L     RSCB1,CVTPTR               GET PTR TO CVT                27750002
         L     RADR,CVTSVDCB             GET SVC DCB PTR          AOS/1 27800002
         LOAD  EP=IGG019OC,DCB=(RADR)                             AOS/1 27850002
         MVC   ZERO(TWO,RLOC),IDPGFIX     MOVE ID TO DEB                27900002
         LA    RLOC,TWO(RLOC)          POINT TO NEXT DEB SUB ID SECTION 27950002
         LA    RCTR,ONE(RCTR)          INCREMENT ROUTINES LOADED COUNT  28000002
         STC   RCTR,DEBNMSUB             CT FINAL IF EXPR GRAPHICS      28050002
         BAL   RBACK,PAGECTR           GO COMPUTE PAGE COUNT      AOS/1 28100002
         ST    RE,DEBSIOA              STORE ADDRESS                    28150002
         OI    DEBSIOA,DEBPGFX         INDICATE FIX APPNDG THERE  AOS/1 28200002
         TM    DCBGTYPE,DCBGTBAS  IS THIS BASIC ATTN HANDLING           28250002
         BNO   OPEN0110             IF NO, SKIP BASIC LOADS             28300002
         EJECT                                                          28350002
*********************************************************************** 28400002
*                                                                     * 28450002
*                  LOADS FOR BASIC ATTENTION HANDLING                 * 28500002
*                                                                     * 28550002
*         1.     GAR   (MODULE NAME IGG019OE)                         * 28600002
*         2.     GEIR  (MODULE NAME IGG019OJ)                         * 28650002
*                                                                     * 28700002
*********************************************************************** 28750002
         L     RSCB1,CVTPTR               GET PTR TO CVT                28800002
         L     RADR,CVTSVDCB          GET SVC DCB ADDRESS               28850002
         LOAD  EP=IGG019OE,DCB=(1)                                      28900002
         ST    RE,EPGAR                SAVE GAR ADDRESS                 28950002
         MVC   ZERO(TWO,RLOC),IDGAR   MOVE ID TO DEB                    29000002
         LA    RLOC,TWO(RLOC)     POINT TO NEXT DEB SUBID SECTION       29050002
         LA    RCTR,ONE(RCTR)         INCREMENT ROUTINES LOADED COUNT   29100002
         L     RSCB1,CVTPTR               GET PTR TO CVT                29150002
         L     RADR,CVTSVDCB             GET SYSTEM SVC DCB ADDRESS     29200002
         LOAD  EP=IGG019OJ,DCB=(1)                                      29250002
         ST    RE,EPGEIR               SAVE GEIR ADDRESS                29300002
         MVC   ZERO(TWO,RLOC),IDGEIR MOVE ID TO DEB                     29350002
         LA    RLOC,TWO(RLOC)          POINT TO NEXT SUB ID SECTION     29400002
         LA    RCTR,ONE(RCTR)         INCREMENT ROUTINE LOADED COUNT    29450002
         STC   RCTR,DEBNMSUB             STORE COUNT IN DEB             29500002
         EJECT                                                          29550002
*********************************************************************** 29600002
*                                                                     * 29650002
*                  LOADS FOR BASIC ATTENTION HANDLING                 * 29700002
*                      IF DEVICE IS 2250                              * 29750002
*                                                                     * 29800002
*          3.    CANCEL KEY  (MODULE NAME IFFCAN03)                   * 29850002
*                                                                     * 29900002
*********************************************************************** 29950002
         L     RUCB,DEBUCBAD     GET 1ST UCB ADDRESS FROM DEB    SM4218 30000002
         CLI   UCBTBYT4,UCBT2250    IS DEVICE A 2250                    30050002
         BNE   OPEN0110             IF NO, DO NOT LOAD IFFCAN03  SM4218 30100002
         LOAD  EP=IFFCAN03                                              30150002
         ST    RE,EPCAN03              SAVE IFFCAN03 ADDRESS            30200002
*   NOTE:  IFFCAN03 CAN NOT BE RECORDED IN DEBSUBID FOR SYSTEM CLOSE    30250002
*          TO DELETE BECAUSE IGG019 IS AFFIXED TO ID TO OBTAIN NAME.    30300002
         EJECT                                                          30350002
*********************************************************************** 30400002
*                                                                     * 30450002
*                  INCREMENT UCBOPEN USER COUNT                       * 30500002
*                                                                     * 30550002
*                1.  ALSO, IF THIS IS FIRST OPEN FOR DEVICE,          * 30600002
*                      A.  RESET UCBGCB, BITS 6 AND 7, TO ZERO        * 30650002
*                                                                     * 30700002
*     SUPERVISOR KEY 0 AND LOCAL LOCK ARE USED TO UPDATE SYSTEM AND   * 30750002
*        GRAPHIC CONTROL BLOCKS.                                      * 30800002
*                                                                     * 30850002
*********************************************************************** 30900002
OPEN0110 EQU *                                                          30950002
         MODESET EXTKEY=ZERO                                            31000002
LL1OBT   SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGG0193Y(X31050002
               LL1REL)),REGS=SAVE                                       31100002
         SR    RCTR,RCTR           CLEAR REG FOR UCB CT INSERT          31150002
         SR    REXT,REXT                     FOR NBR OF UCBS            31200002
         SR    RLOC,RLOC                     FOR INDEXING DEBUCBAD      31250002
         IC    REXT,DEBNMEXT                 INSERT NO. OF UCBS         31300002
OPEN0120 L     RUCB,DEBUCBAD(RLOC)  GET UCB ADDR.                       31350002
         IC    RCTR,UCBOPEN         GET UCB USE CT                      31400002
         LA    RCTR,ONE(RCTR)            INCREMENT USE COUNT            31450002
         STC   RCTR,UCBOPEN         REPLACE NEW USE COUNT               31500002
         CLI   UCBOPEN,ONE           IS USE CT ONE                      31550002
         BNE   OPEN0130                IF NOT FIRST, SKIP EXPRESS CLEAR 31600002
         NI    UCBGCB,UCBGATNB         IF FIRST, RESET BITS 6&7 IN GCB  31650002
OPEN0130 LA    RLOC,ADR(RLOC)          INCREMENT  INDEX                 31700002
         BCT   REXT,OPEN0120        BRANCH IF MORE UCBS TO SERVICE      31750002
         TM    DCBGTYPE,DCBGTBAS    IS THIS BASIC ATTN HANDLING         31800002
         BNO   EAH0310                 IF NO, FINISH WITH EXPRESS       31850002
         EJECT                                                          31900002
*********************************************************************** 31950002
*                                                                     * 32000002
*                     BASIC ATTENTION HANDLING                        * 32050002
*                                                                     * 32100002
*   1.  VALIDITY CHECKS FOR TASK CONTROL OF DEVICE:                   * 32150002
*                                                                     * 32200002
*       IF TEB ALREADY EXISTS FOR THIS DEVICE:                        * 32250002
*                A. VERIFY SAME TASK (IF TCBS MISMATCH, ISSUE IEC158I * 32300002
*                                     AND ABEND C13 THRU SYSTEM OPEN) * 32350002
*                B. SKIP ALL INITIALIZATION                           * 32400002
*                                                                     * 32450002
*********************************************************************** 32950002
         L     RSCB2,UCBTEB             DOES TEB EXIST FOR DEVICE       33000002
         LTR   RSCB2,RSCB2                IF NO, OK TO CONTNUE          33050002
         BZ    BAH0140                    IF YES, TEB TCB AND CUR TCB   33100002
         USING TEB,RSCB2                          MUST BE EQUAL         33150002
         L     RSCB1,TEBTCB                                             33200002
         CR    RSCB1,RTCB                                               33250002
         DROP  RSCB2                                                    33300002
         BNE   IEC157I                      IF NO, USE PD EXIT/MSG C13  33350002
         B     OPEN0240                     IF YES, INITZ DONE          33400002
         EJECT                                                          33410002
*********************************************************************** 33420002
*                                                                     * 33430002
*                     BASIC ATTENTION HANDLING                        * 33440002
*                                                                     * 33442002
*   1.  VALIDITY CHECKS FOR TASK CONTROL OF DEVICE ,CONT.:            * 33444002
*                                                                     * 33446002
*       IF TEB ALREADY EXISTS FOR THIS TASK:                          * 33448002
*           A. SKIP IRB INITIALIZATION SINCE IRBS ALREADY EXIST       * 33448402
*           B. ADD EXTRA IQES TO HANDLE ATTENTIONS FOR THESE UCBS     * 33448802
*                                                                     * 33449202
*                                                                     * 33449602
*          NOTE: TO FIND TASK TEB, SCAN TASK DEB CHAIN FOR OTHER      * 33449702
*                GRAPHIC DEVICES AND SEE IF TEB ADDRESS IS AVAILABLE  * 33449802
*                FROM THEIR UCBS.                                     * 33449902
*                                                                     * 33456602
*********************************************************************** 33466602
BAH0140  L     RSCB2,TCBDEB             DOES TEB EXIST FOR TASK         33470002
         LA    RSCB2,ZERO(RSCB2)          SCAN TASK DEB CHAIN           33500002
         USING DEBNMSUB,RSCB2                                           33550002
BAH0150  SR    RE,RE                 CLR EXTENT REGISTER    E12 ZA25969 33600000
         IC    RE,DEBNMEXT             GET EXTENTS          E12 ZA25969 33610000
         LTR   RE,RE                     ARE THERE ANY      E12 ZA25969 33620000
         BZ    BAH0170                 IF NONE, GET NEXT DEB    SA25381 33650002
         SR    RLOC,RLOC                 CLR DCB REGISTER   E12 ZA25969 33651000
         ICM   RLOC,SEVEN,DEBDCBAD       GET DCB ADDRESS    E12 ZA25969 33653000
         USING IHADCB,RLOC                                  E12 ZA25969 33654000
         TM    DCBDSRG2,DCBDSGGS         GRAPHICS A.M.?     E12 ZA25969 33657000
         DROP  RLOC                                         E12 ZA25969 33659000
         BNO   BAH0170                   NO, GET NEXT DEB   E12 ZA25969 33664000
         SR    RLOC,RLOC               IF YES, INITZ INDEX      SA40756 33700002
BAH0160  L     RUCB,DEBUCBAD(RLOC)  LOAD FIRST UCB ADDRESS      SA40756 33750002
         LA    RUCB,ZERO(RUCB)              CLEAR HIGH BYTE             33800002
         BCT   RE,BAH0170          GET EXTNT-1 IF ZERO NDEB E12 ZA25969 33820000
         LA    RLOC,FOUR(RLOC)      POINT TO NEXT UCB ADDRESS   SA40756 33850002
         LTR   RUCB,RUCB               IS ADDRESS ZERO          SA40756 33900002
         BZ    BAH0160                   IF YES, GET NEXT UCB   SA40756 33950002
         TM    UCBID,FULLMASK            IF NO, CK ID        LD YA00809 34000002
         BNO   BAH0160                  IF NOT ID, GET NXT  E12 ZA26129 34050000
         CLI   UCBTBYT3,UCB3DISP       CHECK IF GRAPHIC UCB             34100002
         BNE   BAH0170                   IF NO, CONTINUE SEARCH         34150002
         CLI   UCBTBYT4,UCBT2250         CK IF GRAPHIC DEVICE           34200002
         BE    BAH0350                     IF YES, CK IF TEB AVAIL      34250002
         CLI   UCBTBYT4,UCBT2260                                        34300002
         BE    BAH0350                                                  34350002
         CLI   UCBTBYT4,UCBT1053                                        34400002
         BE    BAH0350                                                  34450002
BAH0170  L     RSCB2,DEBAMLNG          LOAD DEB LINK FIELD              34500002
         LA    RSCB2,ZERO(RSCB2)       CLEAR HIGH ORDER BYTE            34550002
         LTR   RSCB2,RSCB2             ANY MORE DEBS                    34600002
         BNZ   BAH0150                   IF YES, REPEAT SEARCH          34650002
         DROP  RSCB2                                                    34700002
         EJECT                                                          34750002
*********************************************************************** 34800002
*                                                                     * 34850002
*                     BASIC ATTENTION HANDLING                        * 34900002
*                                                                     * 34950002
*      2. ISSUE GETMAIN FOR TEB SINCE NONE EXISTS FOR THIS TASK       * 35000002
*           A.  USE BRANCH ENTRY SINCE LOCAL LOCK IS HELD             * 35050002
*                                                                     * 35100002
*********************************************************************** 35150002
         L     RSIZE,TEBSIZE    INITZ SIZE                              35200002
         LR    RGMTCB,RTCB            CURRENT TCB ADDR                  35250002
         L     RASCB,ASCBADR          CURRENT ASCB ADDR                 35300002
         GETMAIN  R,LV=(0),BRANCH=YES                                   35350002
         XC    ZERO(TEBSZ,RADR),ZERO(RADR)    CLEAR TE CORE TO ZERO     35400002
         LR    RTEB,RADR                  SAVE TE ADDRESS               35450002
         USING TEB,RTEB                                                 35500002
         EJECT                                                          35550002
*********************************************************************** 35600002
*                                                                     * 35650002
*                     BASIC ATTENTION HANDLING                        * 35700002
*                                                                     * 35750002
*       3. CREATE IRBS FOR GAR AND IFFCAN03; KEEP ADDRESSES IN TEB    * 35800002
*                                                                     * 35850002
*********************************************************************** 35900002
         USING RBBASIC,RADR                                             35950002
         L     RE,EPGAR            LOAD GAR ADDRESS                     36000002
         CIRB  EP=(0),SVAREA=YES,WKAREA=1,MODE=SUPR,KEY=SUPR,BRANCH=YESX36050002
               ,RETIQE=NO,RETRN=YES                           LF YM4054 36100002
         ST    RADR,TEBGARB        STORE GAR IRB ADDRESS IN TE          36150002
         ST    RGMTCB,TEBTCB       STORE CURRENT TCB ADDRESS IN TE      36200002
         MVC   TEBGIOCR(FOUR),R0  STORE GIOCR ADR IN TEB     LG @ZM2360 36210000
         MVC   TEBGEIR(FOUR),EPGEIR  STORE GEIR ADDRESS IN TE           36250002
         OI    TEBFLGS,TEBFLAG       INDICATE THIS IS A TE              36300002
         XC    RBNEXAV(FOUR),RBNEXAV CLEAR IRB FIELD                    36350002
BAH0180  L     RUCB,DEBUCBAD                                     SM4218 36400002
         CLI   UCBTBYT4,UCBT2250   IS THIS A 2250                SM4218 36450002
         BNE   BAH0200              IF NO, SKIP CREATE CAN03 IRB SM4218 36500002
         L     RIRB,TEBCKRB         IF YES, CK IF IRB EXISTS    SA38909 36550002
         LTR   RIRB,RIRB                                                36600002
         BNZ   BAH0190                 IF YES, SKIP CREATE      SA38909 36650002
         L     RE,EPCAN03              LOAD IFFCAN03 ADDRESS    SA38909 36700002
         CIRB  EP=(0),SVAREA=YES,WKAREA=1,MODE=SUPR,KEY=SUPR,BRANCH=YESX36750002
               ,RETIQE=NO,RETRN=YES                           LF YM4054 36800002
         ST    RADR,TEBCKRB             STORE IFFCAN03 IRB ADDR IN TEB  36850002
         XC    RBNEXAV(FOUR),RBNEXAV    CLEAR FIELD IN IRB              36900002
         LR    RIRB,RADR                   KEEP ADDR AND ADD IQE        36910002
         DROP  RADR                                                     36950002
         EJECT                                                          37000002
*********************************************************************** 37050002
*                                                                     * 37100002
*                     BASIC ATTENTION HANDLING                        * 37150002
*                                                                     * 37200002
*     4.  CREATE AND INITIALIZE IQES FOR THE IRBS                     * 37250002
*           A. IF 2250S:  ONE IQE FOR CANCEL KEY'S IRB                * 37300002
*                         THREE IQES FOR GAR'S IRB (THREE ATTN TYPES) * 37350002
*           B. IF 2260S:  ONE IQE FOR GAR'S IRB (ONE ATTN TYPE)       * 37400002
*                                                                     * 37450002
*********************************************************************** 37500002
BAH0190  L     RSIZE,IQESIZE        INITZ SIZE                          37550002
         GETMAIN  R,LV=(0),BRANCH=YES                                   37600002
         USING IQESECT,RADR                                             37650002
         USING RBBASIC,RIRB                                             37700002
         ST    RIRB,IQEIRB            PUT CAN03 IRB INTO IQE            37800002
         MVC   IQELNK(FOUR),RBNEXAV    CHAIN OLD IQE TO NEW IQE         37850002
         ST    RADR,RBNEXAV            PUT IQE ADDR IN IRB              37900002
         XC    IQEPARAM(FOUR),IQEPARAM   ZERO PARM FIELD IN IQE         37950002
         ST    RGMTCB,IQETCB           PUT TCB ADDR INTO IQE            38000002
         LA    RCOUNT,THREE         GAR IQE LOOP COUNT FOR 2250         38050002
BAH0200  SR    REXT,REXT            CLEAR REGISTER                      38100002
         SR    RLOC,RLOC            SET INDEX TO ZERO                   38150002
         IC    REXT,DEBNMEXT         LOAD NUMBER OF UCB EXTENTS         38200002
BAH0210  L     RUCB,DEBUCBAD(RLOC)   LOAD UCB ADDR                      38250002
         LTR   RUCB,RUCB                IS UCB ADDR ZERO        SA40756 38300002
         BZ    BAH0230                     IF YES, CK NEXT UCB  SA40756 38350002
         CLI   UCBTBYT4,UCBT2250     IS DEVICE A 2250           SA35615 38400002
         BE    BAH0220                  IF NO, GET ONE IQE      SA35615 38450002
         EJECT                                                          38500002
*********************************************************************** 38550002
*                                                                     * 38600002
*                     BASIC ATTENTION HANDLING                        * 38650002
*                                                                     * 38700002
*     4.  CREATE AND INITIALIZE IQES FOR THE IRBS, CONT.              * 38750002
*     5.  SET UCB GCB TO INDICATE OK TO PROCESS ATTENTIONS            * 38800002
*                                                                     * 38850002
*********************************************************************** 38900002
         LA    RCOUNT,ONE               GAR IQE LOOP COUNT FOR 2260     38950002
BAH0220  L     RIRB,TEBGARB             REINITIALIZE GAR'S IRB   SM4218 39000002
         L     RSIZE,IQESIZE    INITZ SIZE                              39050002
         GETMAIN  R,LV=(0),BRANCH=YES                                   39100002
         ST    RIRB,IQEIRB              PUT GAR IRB ADDR IN IQE         39150002
         MVC   IQELNK(FOUR),RBNEXAV      CHAIN OLD IQE TO NEW IQE       39200002
         ST    RADR,RBNEXAV              PUT IQE ADDR IN IRB            39250002
         XC    IQEPARAM(FOUR),IQEPARAM    ZERO PARM FIELD IN IQE        39300002
         ST    RGMTCB,IQETCB            PUT TCB ADDR IN IQE             39350002
         BCT   RCOUNT,BAH0220           REPEAT IF MORE IQES FOR DEVICE  39400002
         ST    RTEB,UCBTEB              STORE TE ADDRESS IN UCB         39450002
         OI    UCBGCB,UCBGINIT+UCBGBAS    OK FOR BASIC ATTNS    SA32068 39500002
         L     RCALC,TEBUCBCT              LOAD TE USE COUNT            39550002
         LA    RCALC,ONE(RCALC)              INCREMENT USE COUNT BY ONE 39600002
         ST    RCALC,TEBUCBCT              STORE UPDATED COUNT          39650002
BAH0230  LA    RLOC,ADR(RLOC)     POINT TO NEXT UCB ADDRESS     SA40756 39700002
         BCT   REXT,BAH0210          REPEAT IF MORE 2260S TO SERVICE    39750002
         DROP  RADR,RIRB                                                39800002
         EJECT                                                          39850002
*********************************************************************** 39900002
*                                                                     * 39950002
*                     OPEN I/O PROCESSING FOR 2250S                   * 40000002
*                                                                     * 40050002
*                1. UNLOCK 2250 KEYBOARDS IF PRESENT                  * 40100002
*                                                                     * 40150002
*          NOTE:  BALR TO GIOCR FOR SA19907 HAS BEEN REPLACED         * 40160002
*                 WITH DIRECT I/O (EXCP)                              * 40170002
*                                                                     * 40180002
*********************************************************************** 40200002
OPEN0240 BAL   RBACK,LL1REL          RELEASE LOCAL LOCK       LF YM4068 40250002
         LM    RCORE,RWTGC,R4        RESTORE INPUT REGS & WORK AREA     40300002
         CLI   UCBTBYT4,UCBT2250     IS DEVICE A 2250                   40350002
         BNE   OPEN0270                  IF NO, SKIP KYBRD UNLOCK CODE  40400002
         L     RADR,UCBBTA        LOAD BFR TABLE ADR                    40450002
         LA    RADR,ZERO(RADR)       ZERO HIGH ORDER BYTE               40500002
         LTR   RADR,RADR             CHECK IF A BUFFER TABLE EXISTS     40550002
         BNZ   OPEN0260                IF YES, OK TO UNLOCK KEYBOARD    40600002
OPEN0250 TM    UCBTBYT2,UCBTPFK      IS PFK BIT SET                     40650002
         BNO   OPEN0270                IF NO, SKIP KEYBOARD UNLOCK      40700002
OPEN0260 L     RIOB,DCBIOBAD      GET ADDR OF IOB JUST CREATED  SA19907 40850002
         LM    RSCB1,RSCB2,RMICCW   GET CCW WHILE STILL IN DATAMGT KEY  40900002
         MODESET KEYADDR=DXUKEY,WORKREG=1                     LF YM5685 40910002
         USING DXIOB,RIOB         TEMPORARY BASE FOR IOB I/O            40910402
         TS    IOBAVAIL             SET IOB TO NOT AVAILABLE FOR USE    40912002
         STM   RSCB1,RSCB2,IOBCCW1  IOB FOR I/O IS RENTRANT & USER KEY  40920002
         LA    RSCB1,IOBCCW2         USE CCW2 AS TEMP ECB FOR I/O       40950002
         ST    RSCB1,IOBECBPT          PUT ECB ADDR INTO IOB            41000002
         LA    RSCB1,IOBCCW3         USE CCW3 AS TEMP OUTPUT AREA       41050002
         STCM  RSCB1,SEVEN,IOBCCW1+1   INSERT AREA ADDR INTO CCW LOC    41100002
         LR    RADR,RIOB             PUT IOB ADDR INTO REG 1 &          41110002
         SVC   EXCP                  ISSUE EXCP TO START I/O            41150002
         WAIT  ECB=IOBCCW2                                              41200002
         CLI   IOBCCW2,ECBCC              WAS I/O SUCCESSFUL            41250002
         BNE   IEC158I                     IF NO, ISSUE PD MSG/ABEND    41300002
         DROP  RIOB                                                     41350002
         EJECT                                                          41400002
*********************************************************************** 41450002
*                                                                     * 41500002
*               OPEN CHECK FOR ADDITIONAL DCBS TO PROCESS             * 41550002
*                                                                     * 41600002
*********************************************************************** 41650002
OPEN0270 EQU   *                                                        41700002
         MODESET  EXTKEY=DATAMGT                                        41750002
         XC    ZERO(TWO,RWTGC),ZERO(RWTGC)   CLEAR ID IND COMPLETION    41800002
OPEN0280 EQU   *                                                        41850002
         LA    RWTGC,WGOFF(RWTGC)      BUMP CURRENT WTG REGISTER        41900002
         LA    RPARC,ADR(RPARC)      BUMP CUR PARM REG TO NEXT ENTRY    41950002
         CLC   ZERO(TWO,RWTGC),GIDCNST1     CHECK NEXT WTG ENTRY        42000002
         BE    OPEN0010          YES START AGAIN                        42050002
         SPACE                                                          42100002
         CLC   ZERO(TWO,RWTGC),OPIDCNST    NO TEST FOR END OF TABLE     42150002
         BNE   OPEN0280                 NOT EQUAL CHECK NEXT ENTRY      42200002
         LR    RPARC,RPAR               RESET CURRENT PARM REG          42250002
         LA    RWTGC,WAOFF(RWTG)        RESET CURRENT WTG REG           42300002
OPEN0290 EQU   *                                                        42350002
         CLI   ZERO(RWTGC),ZERO         TEST FOR ZERO ENTRY             42400002
         BNE   OPEN0300                 NOT - XCTL                      42450002
         SPACE                                                          42500002
         LA    RWTGC,WGOFF(RWTGC)      ZERO - GET NEXT ENTRY AND        42550002
         LA    RPARC,ADR(RPARC)      RETURN TO ZCHECK                   42600002
         B     OPEN0290                RETURN                           42650002
         EJECT                                                          42700002
*********************************************************************** 42750002
*                                                                     * 42800002
*              FREE OPEN SAVE AREA AND XCTL TO SYSTEM OPEN            * 42850002
*                   OR ANOTHER ACCESS METHOD EXECUTOR                 * 42900002
*                                                                     * 42950002
*********************************************************************** 43000002
OPEN0300 EQU *                                                          43050002
         LR    RADR,RSAVE         PRIME ADDR REG                        43100002
         L     RSIZE,SAVSPSIZ     GET SAVE/WORK AREA DESCRIPTION        43150002
         FREEMAIN R,LV=(0),A=(1)                                        43200002
         MVC   SIX(TWO,RWTG),ZERO(RWTGC)     MOVE ID TO NAME            43250002
         MVC   TTROFF(THREE,RWTG),TWO(RWTGC)     MOVE TO TTR ROUTINE    43300002
         LA    RLINK,DXCCW12        GET ADDRESS OF NEW NAME FOR XCTL    43350002
         L     RE,DXREG0              RELOAD R0 FOR PD ID               43400002
         XCTL  DE=(RWTG),SF=(E,(RLINK))                                 43450002
         EJECT                                                          43500002
*********************************************************************** 43550002
*                                                                     * 43600002
*                   EXPRESS ATTENTION HANDLING                        * 43650002
*                                                                     * 43700002
*        1. PROCESS POLL LIST OF DCBS USED FOR ATTENTION HANDLING     * 43750002
*           A. IF LIST IS NOT ACTIVE, SET HIGH BYTE TO SHOW INITZ     * 43800002
*           B. ADD DCBS TO LIST AND INDEX, FIRST ENTRY IS 00          * 43850002
*                                                                     * 43900002
*               NOTE:  POLL LIST PROCESSING DONE IN USER'S KEY        * 43950002
*                                                                     * 44000002
*********************************************************************** 44050002
EAH0310  BAL   RBACK,LL1REL         RELEASE LOCAL LOCK        LF YM5684 44100002
         L     RADR,DCBPOLST             GET POLL LIST ADR              44150002
         LA    RADR,ZERO(RADR)              CLEAR HI ORDER BYTE         44200002
         SR    REXT,REXT            CLEAR REG                           44250002
         IC    REXT,DEBNMEXT          INSERT NO. OF UCBS                44300002
         L     RDCB,UDCBADR         GET USER DCB                        44350002
         IC    RDEB,DCBOFLGS        SAVE OFLGS FOR I/O WITH 2250 AND    44400002
         L     RCORE,R4                 GET WORK AREA                   44450002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             44500002
         LTR   RADR,RADR                 DOES POLL LIST EXIST           44600002
         BE    EAH0340                     IF NO, SKIP PROCESSING       44650002
         SR    RCTR,RCTR           CLEAR REG                            44700002
         TM    ZERO(RADR),POLSTACT   IS LIST ACTIVE (HAS DCB ADDRS)     44750002
         BO    EAH0320                IF YES, KEEP END OF LIST PTR      44800002
         ST    RADR,ZERO(RADR)         IF NO, START IS END OF LIST      44850002
EAH0320  L     RLOC,ZERO(RADR)      GET POLST PTR                       44900002
EAH0330  LA    RLOC,FOUR(RLOC)     BUMP LAST DCB PTR TO NEXT ENTRY      44950002
         ST    RDCB,ZERO(RLOC)     USER DCB ADDRESS TO POLST            45000002
         STC   RCTR,ZERO(RLOC)         INDEX TO POLST                   45050002
         LA    RCTR,ONE(RCTR)            ADJUST INDEX                   45100002
         BCT   REXT,EAH0330            BRANCH IF MULTIPLE DEVICES       45150002
         ST    RLOC,ZERO(RADR)         STORE UPDATED END OF LIST PTR    45200002
         OI    ZERO(RADR),POLSTACT     SHOW LIST IS ACTIVE (HAS ENTRY)  45250002
         EJECT                                                          45300002
*********************************************************************** 45350002
*                                                                     * 45400002
*                   EXPRESS ATTENTION HANDLING                        * 45450002
*                                                                     * 45500002
*      2. ASSIGN 2250 BUFFER IF FEATURE IS ON DEVICE                  * 45550002
*      3. IF 2250 AND NO BUFFER, SEE IF PFKS ARE AVAILABLE AND        * 45600002
*         NEED UNLOCKING                                              * 45650002
*                                                                     * 45700002
*********************************************************************** 45750002
EAH0340  MODESET  EXTKEY=DATAMGT                                        45850002
         LM    RCORE,RWTGC,R4        RESTORE INPUT REGS & WORK AREA     45900002
         CLI   UCBTBYT4,UCBT2250     CHECK FOR 2250 TYPE IN UCB         45950002
         BNE   OPEN0270               IF NOT, SKIP 2250 CODE            46000002
         L     RADR,UCBBTA            IF YES, CHECK FOR BFR TABLE ADDR  46050002
         LA    RADR,ZERO(RADR)                ZERO HIGH ORDER BYTE      46100002
         LTR   RADR,RADR                                                46150002
         BNZ   EAH0345                  IF BFR TAB EXISTS, ASSIGN BFR   46200002
         L     RDCB,DCBADR(RPARC)       IF NONE, GET COPIED DCB &       46300002
         B     OPEN0250                          CK FOR PFKS TO CLEAR   46310002
         USING BUFTAB,RADR                                              46350002
EAH0345  EQU   *                                                        46360000
         MODESET KEYADDR=DXUKEY,WORKREG=14                   LG YM08088 46370000
         MVI   DCBOFLGS,X'12'   MOVE IN DUMMY FLAGS          LG YM08088 46380000
         MODESET EXTKEY=DATAMGT                              LG YM08088 46390000
         LA    RCOUNT,BTEXPSIZ       LOAD ADR OF EXPRESS BUFFER SIZE    46400000
         LA    RADR,SAVEAREA          USE FIRST TWO WORDS AS PLIST      46450002
         ASGNBFR (RDCB),(RCOUNT),MF=(E,(RADR))                          46500002
         MODESET  KEYADDR=DXUKEY,WORKREG=14                             46550002
         STC   RDEB,DCBOFLGS          RESTORE OFLGS                     46600002
         LTR   RCODE,RCODE       BUFFER ASSIGNED OK?                    46650002
         BNZ   IEC158I              IF NO, ISSUE PD MSG/ABEND           46700002
         L     RSCB1,DCBBFRST       IF YES, REFRESH COPY DCB            46750002
         MODESET  EXTKEY=DATAMGT                                        46800002
         L     RDCB,DCBADR(RPARC)      GET ADDR OF COPY DCB             46850002
         ST    RSCB1,DCBBFRST          REFRESH BFR FIELDS               46900002
         B     OPEN0260          END OF EXPRESS PROCESSING; UNLOCK KBRD 46950002
         EJECT                                                          47000002
*********************************************************************** 47050002
*               OUT-OF-LINE CODE AND INTERNAL SUBROUTINES             * 47100002
*********************************************************************** 47150002
         SPACE                                                          47200002
BAH0350  L     RTEB,UCBTEB        LOAD TE FIELD FROM UCB                47250002
         LA    RTEB,ZERO(RTEB)    CLEAR HIGH ORDER BYTE                 47300002
         LTR   RTEB,RTEB            DOES TEB EXIST                      47350002
         BZ    BAH0170                IF NO, CONT SEARCH                47400002
         LR    RGMTCB,RTCB       CURRENT TCB PTR     LG ZA00500,YM08809 47410000
         L     RASCB,ASCBADR     CURRENT ASCB PTR    LG ZA00500,YM08809 47420000
         B     BAH0180                IF YES, SKIP GARIRB/TEB INITZ     47450002
         SPACE                                                          47500002
LL1REL   SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGG0193Y(LL1OBT)),  X47550002
               REGS=SAVE                                      LF YM4068 47600002
         BR    RBACK                                                    47650002
         SPACE                                                          47700002
*     INTERNAL SUBROUTINE TO DETERMINE NUMBER OF PAGES IN MODULE JUST   47750002
*     LOADED.  NUMBER MUST BE OR'ED INTO HIGH BYTE OF EP IN REG 0       47800002
*     BEFORE SAVING ADDR IN APPENDAGE TABLE.                            47850002
PAGECTR  EQU   *                                                  AOS/1 47900002
* CONVERT MODULE SIZE TO UPPER BOUND                              AOS/1 47950002
         LR    RLGH,RE                 GET LOAD ADDR IN WORK REG  AOS/1 48000002
         SLL   RCALC,THREE               BYTE COUNT= 8* DBLWRCTRS AOS/1 48050002
         AR    RCALC,RLGH                 UPPER BOUND+1           AOS/1 48100002
         BCTR  RCALC,RSIZE                UPPER BOUND-1           AOS/1 48150002
* ROUND LOAD ADDRESS DOWN TO PAGE BOUNDARY                        AOS/1 48200002
         SRL   RLGH,SHFT11                                        AOS/1 48250002
         SLL   RLGH,SHFT11             LOWER PAGE BOUNDARY        AOS/1 48300002
* COMPUTE NUMBER OF PAGES SPANNED BY MODULE                       AOS/1 48350002
         SR    RCALC,RLGH                 BYTES SPANNED BY MODULE AOS/1 48400002
         SRL   RCALC,SHFT11              NUMBER OF PAGE BOUNDS    AOS/1 48450002
         LA    RCALC,ONE(RCALC)            NUMBER OF PAGES        AOS/1 48500002
         SLL   RCALC,SHFT24              SHIFT TO HIGH BYTE       AOS/1 48550002
         OR    RE,RCALC               PREFIX TO LOAD ADDRESS      AOS/1 48600002
         BR    RBACK                   RETURN                     AOS/1 48650002
         EJECT                                                          48700002
*********************************************************************** 48750002
*   ISSUE PROBLEM DETERMINATION MESSAGES THRU SYSTEM OPEN MACRO       * 48800002
*********************************************************************** 48850002
         SPACE 2                                                        48900002
IEC157I  EQU   *                                                        48950002
         BAL   RBACK,LL1REL        RELEASE LOCAL LOCK                   49000002
         MODESET  EXTKEY=DATAMGT                                        49050002
         LM    RCORE,RWTGC,R4        RESTORE INPUT REGS                 49100002
         USING FORCORE,RCORE                                            49150002
         DMABCOND    91,PDLOAD,RES=NO,REGSAVE=YES                S21016 49200002
         ST    RE,DXREG0           SAVE R0 PD ID                        49250002
         B    OPEN0300                                                  49300002
         SPACE 2                                                        49350002
IEC158I  EQU   *                                                        49400002
         MODESET  EXTKEY=DATAMGT                                        49450002
         DMABCOND     92,PDLOAD,RES=NO,REGSAVE=YES               S21016 49500002
         ST    RE,DXREG0           SAVE R0 PD ID                        49550002
         B     OPEN0300                                                 49600002
         SPACE 3                                                        49650002
IEC159I  EQU   *                                                        49700002
         DMABCOND    93,PDLOAD,RES=NO,REGSAVE=YES                S21016 49750002
         ST    RE,DXREG0           SAVE R0 PD ID                        49800002
         B     OPEN0300                                                 49850002
         EJECT                                                          49900002
*********************************************************************** 49950002
*                                                                     * 50000002
*                        CONSTANTS                                    * 50050002
*                                                                     * 50100002
*********************************************************************** 50150002
         SPACE 1                                                        50200002
*                  DEB ID'S FOR MODULES LOADED                          50250002
*         (APPENDED TO IGG019 BY SYSTEM CLOSE FOR DELETION)             50300002
IDGIOCR  DC    C'OA'                                                    50350002
IDCEXCE  DC    C'OB'                                                    50400002
IDPGFIX  DC    C'OC'              ID OF PAGE FIX APPNDG           AOS/1 50450002
IDGAR    DC    C'OE'                                                    50500002
IDGEIR   DC    C'OJ'                                                    50550002
OPIDCNST DC    C'0S'                                                    50600002
GIDCNST1 DC    C'3Y'                                                    50650002
         DS    0F       ALIGN BOUNDARIES FOR LOAD INSTRUCTIONS          50700002
RMICCW   DC    X'0E00000000000003'   CCW FOR RMI I/O TO CLEAR 2250 KBRD 50750002
DEBSPOOL DC    X'E6000000'     SP 230 FOR DEB        LB  AOS/1          50800002
IOBSPOOL DC    X'FA000000'        250     IOB                           50850002
SAVSPSIZ DC    X'E600005C'     SP 230 FOR 92 BYTE SAVE/WORK AREA        50900002
IQESIZE  DC    X'E9000010'     SP 233 FOR 16 BYTE IQE                   50950002
TEBSIZE  DC    X'EB000024'     SP 235 FOR 32 BYTE TEB        LG @ZM2360 51000000
NUMONE   DC    H'01'                                                    51050000
SIXTEEN  DC    H'16'                                                    51100002
HWC256   DC    H'256'                                                   51150002
SEVNTEEN DC    H'17'                                                    51200002
CLEAR    XC    0(1,RADR),0(RADR)                                        51250002
         USING TIOENTRY,RTIOT                                           51300002
UCBMOVE  MVC   0(1,RDEL),TIOESTTB                                       51350002
         SPACE 5                                                        51450002
**********************************************************************  51500002
*                                                                    *  51550002
*                SPECIAL MAINTENANCE PATCH AREA FOR FIELD USE        *  51600002
*                                                                    *  51650002
**********************************************************************  51700002
PATCH    DC    C'IGG0193Y 50 BYTE PATCH AREA.'                          51750002
         DC    C'50 BYTE AREA ENDS HERE'                                51800002
         EJECT                                                          51850002
*********************************************************************** 51900002
*  LENGTH AND PATCH PARAMETERS HAVE BEEN ADDED TO XCTLTABL TO         * 51950002
*  BYPASS PROBLEMS CAUSED BY DEFAULT TO 1K SIZE MODULES               * 52000002
*********************************************************************** 52050002
         XCTLTABL ID=(PDLOAD,6M),SVC=19,LENGTH=3000,PATCH=100           52100002
         EJECT                                                          52150002
*********************************************************************** 52200002
*                                                                     * 52250002
*                        DSECTS                                       * 52300002
*                                                                     * 52310002
*        BUFTAB         FORCORE             TEB                       * 52350002
*        CVT            IQE                 TIOT                      * 52400002
*        DCB            PSA                 UCB                       * 52450002
*        DEB            RB                  SAVEAREA                  * 52500002
*                       TCB                                           * 52550002
*                                                                     * 52560002
*********************************************************************** 52600002
         SPACE 5                                                        52650002
BUFTAB   DSECT                                                          52700002
*                                                                       52750002
BTTOTSEG DS    CL2     HEADER:  TOTAL NUMBER OF 256 BYTE SECTIONS       52800002
BTNUMDEV DS    CL2                              DEVICES SHARING BUFFER  52850002
BTEXPSIZ DS    CL2                              SECTIONS FOR EXPRESS    52900002
BTTOTAVL DS    CL2                              SECTIONS STILL AVAIL    52950002
*                                                                       53000002
BTDVTOTA DS    CL2     DEVICES: TOTAL NUMBER OF SECTIONS AVAIL THIS DEV 53050002
BTDVDISP DS    CL2              DISPL INTO BT FOR THIS DEV ZONE         53100002
BTDVZONE DS    CL2              NBR OF SECTIONS IN THIS DEV ZONE        53150002
BTDVGAR  DS    CL2              NBR OF GUARANTEED SECTIONS FOR THIS DEV 53200002
*                                                                       53250002
BTASGMT  DS    CL56    ASGMT:   ASSIGNMENTS WILL CONTAIN DEVICE IDS     53300002
         EJECT                                                          53350002
*        CVT   DSECT=YES,LIST=YES                                       53400002
         CVT   DSECT=YES                                                53450002
         EJECT                                                          53500002
*********************************************************************** 53550002
*                                                                     * 53600002
*                        DCB DSECT                                    * 53650002
*                                                                     * 53700002
*********************************************************************** 53750002
         SPACE 1                                                        53800002
         DCBD  DSORG=GS                                                 53850002
**********************************************************************  53900002
*                                                                     * 53950002
*                    ADDITIONAL DCB EQUATES FOR DSECT                 * 54000002
*                                                                     * 54050002
*********************************************************************** 54100002
DCBGNCPL EQU   X'00'   LOW END OF RANGE FOR CHANNEL PROGRAMS IS 1       54150002
DCBGNCPH EQU   X'63'   HIGH END OF RANGE FOR CHANNEL PROGRAMS IS 99     54200002
         EJECT                                                          54250002
*********************************************************************** 54300002
*                                                                     * 54350002
*                        GRAPHIC DEB DUMMY SECTION                    * 54400002
*                                                                     * 54450002
*********************************************************************** 54500002
         SPACE 1                                                        54550002
IECTDEB  DSECT                                                          54600002
DEBEOEA  DS    CL4                     END OF EXTENT APP ROUTINE PTR    54650002
DEBSIOA  DS    CL4                     START I/O APP ROUTINE PTR        54700002
DEBPGFX  EQU   X'80'      ADDR AVAILABLE FOR PAGE FIX ENTRY POINT AOS/1 54750002
DEBPCIA  DS    CL4                     PROG CONTROL APP ROUTINE PTR     54800002
DEBCEA   DS    CL4                     CHANNEL END APP ROUTINE PTR      54850002
DEBXCEA  DS    CL4                     EX CHANNEL END APP ROUTINE PTR   54900002
DEBWKARA DS    CL1                     I/O SUPPORT WORK AREA            54950002
DEBDSCBA DS    CL7                     I/O SUPPORT DSCB AREA            55000002
DEBDCBMK DS    CL4                     I/O DCB MODIFICATION MASK        55050002
DEBLNGTH DS    CL4                     DEB LENGTH IN DOUBLE WORDS       55100002
DEBNMSUB DS    CL1                     NO. SUBROUTINES LOADED BY OPEN   55150002
DEBTCBAD DS    CL3                     TCB ADDR OF THIS DEB             55200002
DEBAMLNG DS    CL1                     NO. BYTES IN ACCESS METHOD SECT  55250002
DEBDEBAD DS    CL3                     NEXT DEB PTR IN THIS TASK        55300002
DEBOFLGS DS    CL1                     DATA SET STATUS FLAG             55350002
DEBIRBAD DS    CL3                     IRB ADDR FOR ERROR EXIT          55400002
DEBOPATB DS    CL1                     FILE TYPES                       55450002
DEBSYSPG DS    CL3                     SYSTEM PURGE CHAIN               55500002
DEBNMEXT DS    CL1                     NO. OF EXTENTS BUILT FOR DSCB'S  55550002
DEBUSRPG DS    CL3                     USER PURGE CHAIN                 55600002
DEBPRIOR DS    CL1                     TCB PRIORITY-IOS CH QUEING IOB   55650002
DEBECBAD DS    CL3                     IOS INTERNAL ECB ADDR            55700002
DEBPROTG DS    CL1                     TASK PROTECTION TAG              55750002
DEBID    EQU   X'0F'          DEB ID IN LOW ORDER BITS OF DEBPROTG      55800002
DEBDCBAD DS    CL3                     DCB ADDR                         55850002
DEBEXSCL DS    CL1                     EXTENT SCALE                     55900002
DEBAPPAD DS    CL3                     I/O APP BLOCK PTR                55950002
DEBUCBAD DS    CL4                     UCB PTR FOR GIVEN DATA EXTENT    56000002
         IECDSECS  MAIN,EXPAND=YES                                      56050002
*                                                                       56100002
*        ADDITIONAL IOB LABELS FOR GAM EXTENSION                        56150002
*                                                                       56200002
         ORG   DXIOB                                                    56250002
IOBDX    DS    8F      USE WORK AREA LABELS FOR STD FIELDS              56300002
*       GAM EXTENSION                                                   56350002
IOBUCBX  DS    0CL1    UCB INDEX                                        56400002
IOBADRPT DS    F       ADDRESSING LIST POINTER                          56450002
IOBAVAIL DS    0CL1    BIT 0:  ON IF IOB NOT AVAILABLE FOR USE          56460002
IOBNXTPT DS    F       NEXT IOB POINTER                                 56500002
IOBCCW1  DS    2F      MAX NBR OF CCWS FOR A GRAPHIC CHANNEL PGM IS 4   56550002
IOBCCW2  DS    2F                                                       56600002
IOBCCW3  DS    2F      * USED AS ECB FOR RMI I/O *                      56650002
IOBCCW4  DS    2F      * USED FOR INFO FROM RMI I/O *                   56700002
         EJECT                                                          56750002
         IHAIQE                                                         56800002
         EJECT                                                          56850002
         IHAPSA                                                         56900002
         EJECT                                                          56950002
         IHARB                                                          57000002
         EJECT                                                          57050002
         IKJTCB                                                         57100002
         EJECT                                                          57150002
TEB      DSECT                                                          57200002
TEBCKRB  DS    F       ADDR OF:      IRB FOR CANCEL KEY (IFFCAN03)      57250002
TEBREB   DS    F                     GAM ROUTINE ENTRY BLOCK            57300002
TEBTCB   DS    F                     TCB                                57350002
TEBCKQE  DS    F                     LIST OF CANCEL KEY IQES            57400002
TEBUCBCT DS    F       USE COUNT:    NBR OF UCBS USING THIS TEB         57450002
TEBFLGS  DS    F       FLAG BYTES:                                      57500002
TEBFLAG  EQU   X'80'                 TEB ID FLAG                        57550002
TEBGARB  DS    F       ADDR OF:      IRB FOR GAR (IGG019OE)             57600002
TEBGEIR  DS    F                     GEIR (IGG019OJ) ENTRY POINT        57650002
TEBGIOCR DS    F               GIOCR(IGG0190A) ENTRY POINT   LG @ZM2360 57660000
         EJECT                                                          57700002
TIOT     DSECT                                                          57750002
         IEFTIOT1                                                       57800002
         EJECT                                                          57850002
UCB      DSECT                                                          57900002
*        IEFUCBOB  LIST=YES                                             57950002
         IEFUCBOB                                                       58000002
         EJECT                                                          58050002
**********************************************************************  58100002
*                                                                     * 58150002
*                    ADDITIONAL UCB EQUATES FOR DSECT                 * 58200002
*                                                                     * 58250002
*********************************************************************** 58300002
         SPACE 3                                                        58350002
*          UCBTYP, BYTE 2, BIT SETTINGS                                 58400002
UCBTPFK  EQU   X'10'           UNIT TYPE BIT 3 FOR PFK FEATURE          58450002
         SPACE 3                                                        58500002
*          UCBTYP, BYTE 4, BIT SETTINGS                                 58550002
         SPACE                                                          58600002
UCBT2250 EQU   X'02'           UNIT TYPE ID FOR 2250 DEVICE             58650002
UCBT2260 EQU   X'03'                        FOR 2260                    58700002
UCBT1053 EQU   X'04'                        FOR 1053                    58750002
         SPACE 2                                                        58800002
*          UCBGCB, BIT SETTINGS                                         58850002
         SPACE                                                          58900002
UCBGINIT EQU   X'40'           OK TO ACCEPT ATTNS NOW           SA32068 58950002
UCBGBAS  EQU   X'08'           BASIC ATTENTION HANDLING BEING USED      59000002
UCBGATNB EQU   X'FC'           RESET ATTENTION BITS FOR/FROM EXPRESS    59050002
         EJECT                                                          59100002
*********************************************************************** 59150002
*                                                                     * 59200002
*                        SAVE AREA DSECT                              * 59250002
*                                                                     * 59300002
*********************************************************************** 59350002
SAVEAREA DSECT                                                          59400002
WKSA     DS    5F             WORK WORDS FOR LOCAL LOCK WHEN REGS=SAV   59450002
R0       DS    F                       REG ZERO    *  REGS MAP INTO  *  59520002
./  ADD  SSI=51410034,NAME=IGG0203Y
     TITLE ' GRAPHICS CLOSE EXECUTOR '                                  00050002
*********************************************************************** 00100002
*                                                                       00150002
* MODULE NAME:           IGG0203Y (OS/VS2)                              00200002
*                                                                       00250002
* DESCRIPTIVE NAME:      GRAPHICS CLOSE EXECUTOR                        00300002
*                                                                       00350002
* COPYRIGHT:             NONE                                           00400002
*                                                                       00450002
* STATUS:                RELEASE 2.0                                    00500002
*                                                                       00550002
* FUNCTION:              THIS MODULE PERFORMS ALL CLOSE FUNCTIONS FOR   00600002
*                        THE 2250S AND 2260S SUPPORTED BY GPS.          00610002
*                                                                       00660002
*                        THIS INCLUDES:                                 00710002
*                          1. VALIDITY CHECKS.                          00760002
*                                A. UCB IS A GRAPHICS SUPPORTED DEVICE  00810002
*                                     1. 2250 )   ALL MODELS SUPPORTED  00860002
*                                     2. 2260 )))       AND             00910002
*                                     3. 1053 )   ALL LOCALLY ATTACHED  00960002
*                                B. CORRECT TASK IS REQUESTING CLOSE IF 01010002
*                                   DCB SHOWS BASIC ATTN HDLING IS USED 01060002
*                          2. DELETING SPECIAL ROUTINES NOT HANDLED BY  01110002
*                             SYSTEM CLOSE.                             01160002
*                               A. IFFCAN03 FOR BASIC 2250 CANCEL KEY   01210002
*                          3. RESET OR RELEASE CONTROL BLOCKS           01260002
*                               A. DCB                                  01310002
*                               B. IOB (PURGE & FREE)                   01360002
*                               C. UCB                                  01410002
*                               D. BASIC REBS & TEB FOR THIS DCB        01460002
*                               E. BASIC IRBS & IQES FOR:               01510002
*                                    1. IGG019OE                        01560002
*                                    2. IFFCAN03                        01610002
*                               F. EXPRESS USER POLL LIST               01660002
*                          4. SHUTDOWN I/O FOR 2250S                    01710002
*                               A. SOUND ALARM TO NOTIFY 2250 OPERATOR  01760002
*                               B. HALT REGENERATION OF SCREEN          01810002
*                               C. TURN OFF PFK LIGHTS                  01820002
*                               D. RELEASE 2250 BUFFER                  01830002
*                                                                       01832002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 01840002
         EJECT                                                          01850002
*********************************************************************** 01900002
* NOTES:                                                                01950002
*                                                                       02000002
*     DEPENDENCIES:      KEY 5 CONTROL IS RECEIVED FROM SYSTEM CLOSE.   02050002
*                        USER DCB ADDRESS, KEY AVAIL FROM SYS WORKAREA. 02100002
*                        SYSTEM NUCLEUS, KEY 0, IS NOT FETCH PROTECTED. 02110002
*                        IF FIRST UCB ON TIOT IS GRAPHIC TYPE,          02150002
*                           ALL FOLLOWING UCBS WILL BE GRAPHIC.         02200002
*                                                                       02250002
*     RESTRICTION:       FOR 2250S, ONE DEVICE PER DCB WHICH RESULTS    02300002
*                                   IN ONE UCB PER DEB.                 02350002
*                                                                       02400002
*     RESISTERS:         SEE EQUATE DEFINITIONS FOLLOWING PROLOG        02450002
*                                                                       02500002
*     PATCH LABEL:       PATCH, A 50 BYTE DC AREA AT END OF MODULE      02550002
*                                                                       02600002
* MODULE TYPE:           EXECUTABLE CODE                                02650002
*                                                                       02700002
*    PROCESSOR:          ASSEMBLER XF                                   02750002
*                                                                       02800002
*    MODULE SIZE:        SEE PAGE 1 OF THIS LISTING                     02850002
*                                                                       02900002
*    ATTRIBUTES:                                                        02950002
*       AT ENTRY:        REENTRANT  ENABLED  SUPERVISOR STATE IN KEY 5  03000002
*       ASSUMED KEYS:    0, USER (AS RECORDED IN SYSTEM CLOSE WORKAREA) 03050002
*                                                                       03100002
* ENTRY POINT:           IGG0203Y                                       03150002
*                                                                       03200002
*    PURPOSE:            SEE 'FUNCTION' HEADING ABOVE                   03250002
*                                                                       03300002
*    LINKAGE:            SEE 'INPUT', NEXT HEADING                      03350002
*                                                                       03400002
* INPUT:                 REGISTERS 5 THRU 8 AS FOLLOWS:                 03450002
*                          5 ADDR OF: TOP OF DCB LIST BEING PROCESSED   03500002
*                          6          TOP OF WHERE-TO-GO TABLE          03550002
*                          7          CURRENT ENTRY OF DCB LIST         03600002
*                          8          CURRENT ENTRY OF WHERE-TO-GO TAB  03650002
*                            NOTE: 4 CONTAINS A VALID WORKAREA ADDR     03700002
*                               ONLY IF CONTROL RECEIVED FROM SYS CLOSE 03750002
*                                                                       03800002
* OUTPUT:                SEE 'FUNCTION' HEADING ABOVE                   03850002
*                                                                       03900002
* EXITS:                                                                03950002
*                                                                       04000002
*    NORMAL:             XCTL, USING WTG TABLE FOR MODULE ID            04050002
*                                                                       04100002
*    ERROR:              XCTL, USING PROBLEM DETERMINATION MACRO        04150002
*                          DMABCOND FOR MODULE ID                       04200002
*                                                                       04250002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 04300002
         EJECT                                                          04350002
*********************************************************************** 04400002
*                                                                       04450002
* EXTERNAL REFERENCES:                                                  04500002
*                                                                       04550002
*     ROUTINES:          EXCP     TO  SHUTDOWN 2250                     04600002
*                        IGC0007A     RELEASE 2250 BUFFER               04610002
*                        IGC0007D     RELEASE REBS ON TEB FOR THIS DCB  04620002
*                        PURGE        STOP I/O PENDING                  04630002
*                                                                       04650002
*     DATA AREAS:        SEE DSECT SECTION AT END OF LISTING            04700002
*                                                                       04750002
*     CONTROL BLOCKS:    SEE DSECT SECTION AT END OF LISTING            04800002
*                                                                       04850002
* TABLES:                TABLE OF TCB/ASCB ADDRESSES                    04900002
*                        WHERE-TO-GO TABLE (SEE IECDSECS DSECT)         04950002
*                                                                       05000002
* MACROS:                ABEND   DEBCHK   DELETE   FREEMAIN   GETMAIN   05050002
*                        MODESET RLSEBFR  SETLOCK  WAIT       XCTL      05060002
*                                                                       05100002
* CHANGE ACTIVITY:       MODULE HAS BEEN RESTRUCTURED TO CONSOLIDATE    05150002
*                        THE TWO PREVIOUS CLOSE LOADS INTO A SINGLE     05200002
*                        LOAD MODULE.  CSECT FLAGS UPDATED WHERE        05250002
*                        APPROPIATE.                                    05300002
*                                                                       05350002
*                        FIXES DROPPED LIST:                            05400002
*                         YA01037 OBSOLETE CLOSE MODULE, IGG0203X, DID  05450002
*                                 NOT RECOGNIZE 1053 DEVICE.            05500002
*                         SA54346 MODULES LOADED BY OPEN ARE DELETED BY 05550002
*                                 SYSTEM CLOSE USING DEBSUBID FIELD.    05600002
*                         SA42281 GRAPHICS 2280 DEVICES NOT SUPPORTED   05610002
*                                 IN VS SYSTEMS.                        05620002
*                         SA37923 OBSOLETE CLOSE MODULE, IGG0203X, DID  05630002
*                                 NOT RECOGNIZE EXPRESS ATTN HANDLING.  05640002
*                                                                       05650002
*********************************************************************** 05700002
         SPACE                                                          05750002
IGG0203Y CSECT                                                          05800002
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   05850002
*D271100,A277000                                              LF YM7703 05860002
*A136000                                                      LF YM4062 05900002
*A102000-102500,154000-154500,157000                         LD YA01258 06000002
*C123500,124000                                               LB Y01021 06050002
*A135000,C343000-345000                                       LB  AOS/1 06100002
*C180000-181000                                               LC S21016 06150002
*A179000-179500                                              LI SA45407 06200002
*A155000-155500,157500,339000-340500                         LI SA42814 06300002
*C267000-269500                                              LI SA42542 06400002
*A125500,126000                                              LI SA37402 06500002
*C235500-236500,C239000                                      LG ZA00500 06510000
*C345000,A392100                                             LG @ZM2360 06520000
*A157600                                                    L5 @ZA03992 06530000
         EJECT                                                          06550002
*********************************************************************** 06600002
*                                                                     * 06650002
*                        REGISTER ASSIGNMENTS                         * 06700002
*                                                                     * 06750002
*               TEMPORARY ASSIGNMENTS IN LOW NUMBER REGS              * 06800002
*               PERMANENT ASSIGNMENTS IN HIGH NUMBER REGS             * 06850002
*               INPUT NAMES IDENTICAL TO THOSE IN SYSTEM OPEN         * 06900002
*********************************************************************** 06950002
         SPACE                                                          07000002
RE       EQU   0    TEMPORARY:         ENTRY POINT ADDRESSES            07050002
RSIZE    EQU   0                       GETMAIN SIZES                    07100002
RADR     EQU   1                       ADDR WORK REG                    07150002
RCALC    EQU   1                       CALCULATIONS                     07200002
RCCW1    EQU   5                       *  CCWS FOR I/O SHUTDOWN  *      07210002
RCCW2    EQU   8                             *  HELD IN REGS  *         07220002
RCCW3    EQU   10                         *  DURING KEY CHANGE  *       07230002
RBACK    EQU   14                      RETURN ADDRESS FOR LINKAGES      07250002
RLINK    EQU   15                      BRANCH ADDRESS FOR LINKAGES      07300002
RCODE    EQU   15                      RETURN CODES FROM LINKAGES       07350002
         SPACE                                                          07400002
RBASE    EQU   2    CONVENTIONS:       BASE REGISTER                    07450002
RDCB     EQU   3                       DCB ADDRESS REGISTER             07500002
RGMTCB   EQU   4                       TCB   FOR GETMAIN                07550002
RASCB    EQU   7                       ASCB  FOR GETMAIN                07600002
         SPACE                                                          07650002
RCTR     EQU   4    CALCULATIONS:      GENERAL COUNTER                  07700002
RLOC     EQU   5                       LOCATION REG FOR INDEXING        07750002
RLAST    EQU   6                       ADDR OF LAST ENTRY IN POLL LIST  07800002
RNEXT    EQU   7                       ADDR OF NEXT ENTRY IN POLL LIST  07850002
REXT     EQU   8                       NUMBER OF UCB EXTENTS FROM DEB   07900002
RCOUNT   EQU   10                      LOOP COUNTER FOR NBR OF IQES     07950002
         SPACE                                                          08000002
RCORE    EQU   4   INPUT ADDRESSES:    WORKAREA ONLY IF FROM SYS OPEN   08050002
RPAR     EQU   5                       PARAMETER LIST OF DCB ADDRS      08100002
RWTG     EQU   6                       WTG TABLE, EG. LABEL 'DXXWTG'    08150002
RPARC    EQU   7                       CURRENT PARAMETER LIST ENTRY     08200002
RWTGC    EQU   8                       CURRENT WGT TABLE ENTRY          08250002
         SPACE                                                          08300002
RGACB    EQU   5   ADDRESSES:          GACB                             08350002
RIRB     EQU   6                       IRB FOR IQES BEING RELEASED      08400002
RREB     EQU   6                       REB                              08450002
RDEB     EQU   9                       DEB FOR DEVICES BEING CLOSED     08500002
RDECB    EQU   10                      DECB FOR I/O                     08550002
RTCB     EQU   10                      CURRENT TCB FROM CVT TCB TABLE   08600002
RIOB     EQU   11                      IOB USED FOR SHUTDOWN I/O        08610002
RTEB     EQU   11                      TEB BEING DEACTIVATED            08650002
RUCB     EQU   12                      CURRENT UCB                      08700002
RSAVE    EQU   13                      SAVE AREA FOR OPEN               08750002
RSCB1    EQU   14                      TEMP SYS CB ADDRESSES            08800002
RSCB2    EQU   15                      TEMP SYS CB ADDRESSES            08850002
        EJECT                                                           08900002
*********************************************************************** 08950002
*                                                                     * 09000002
*                        EQUATES                                      * 09050002
*                                                                     * 09100002
*********************************************************************** 09150002
ACURASCB EQU   12     CURRENT ASCB ADDR LOC IN TCB TABLE                09200002
ACURTCB  EQU   4      CURRENT TCB ADDR LOC IN TCB TABLE                 09250002
ADR      EQU   4                                                        09300002
DCBADR   EQU   0      CURRENT DCB ADDR FROM INPUT PLIST                 09400002
IOBSIZE  EQU   72     IOB BLOCK SIZE IN BYTES                           09450002
THRTWO   EQU   32                                                       09500002
TTROFF   EQU   14                                                       09550002
WAOFF    EQU   32     OFFSET OF FIRST ENTRY OF WTG TAB                  09600002
WGOFF    EQU   8      OFFSET OF WTG ENTRIES                             09650002
         SPACE                                                          09700002
ZERO     EQU   0      DECIMAL/HEX NUMBERS FOR GENERAL USE               09750002
ONE      EQU   1                                                        09800002
TWO      EQU   2                                                        09850002
THREE    EQU   3                                                        09900002
FOUR     EQU   4                                                        09950002
SIX      EQU   6                                                        10000002
SEVEN    EQU   7                                                        10050002
EIGHT    EQU   8                                                        10100002
         SPACE                                                          10150002
CCW24    EQU   24                  LENGTH OF HALT+PFK CCW    LD YA01258 10200002
CCW16    EQU   16                  LENGTH OF HALT CCW        LD YA01258 10250002
         SPACE                                                          10260002
EXCP     EQU   0      SVC NUMBERS                                       10270002
DAR      EQU   74                                                       10280002
         EJECT                                                          10300002
*********************************************************************** 10350002
*                                                                     * 10400002
*                        INITIALIZATION                               * 10450002
*                                                                     * 10460002
*         1. USING STATEMENTS IDENTIFY DSECT BASE REGISTERS           * 10470002
*         2. BASE ESTABLISHED FOR ADDRESSABILITY OF MODULE            * 10480002
*         3. MODULE EYECATCHER ID FOR RELEASE LEVEL VERIFICATION      * 10490002
*                                                                     * 10500002
*********************************************************************** 10550002
         SPACE 2                                                        10600002
         USING CVT,RSCB1         CVT DSECT INITZ FROM LOC 16            10650002
         USING FORCORE,RCORE     IECDSECS, KEY 0, REFERENCED ONLY       10700002
         USING IHADCB,RDCB       DCB DSECT; KEY 5: COPIED; KEY >7: USER 10750002
         USING DEBBASIC,RDEB     DEB DSECT, KEY 5, CREATED BY GAM OPEN  10800002
         USING SAVEAREA,RSAVE    SAVE/WORK AREA, KEY 5, FOR GAM CLOSE   10850002
         USING TCB,RTCB          STD DSECTS, KEY 0:  TCB                10900002
         USING TEB,RTEB                              TEB                10950002
         USING UCB,RUCB                              UCB                11000002
         SPACE 3                                                        11050002
         BALR  RBASE,0                 SET UP CSECT BASE REGISTER       11100002
         USING *,RBASE                 DEFINE CSECT BASE REGISTER       11150002
         B     *+24                                                     11200002
MODID    DC    C'IGG0203Y.VS2R2.75106'          MODULE EYECATCHER ID    11250000
         EJECT                                                          11300002
*********************************************************************** 11350002
*                                                                     * 11400002
*                        INITIALIZATION                               * 11450002
*                                                                     * 11460002
*         4. SAVE/WORK AREA IS USED TO PRESERVE REENTRANT STATUS.     * 11470002
*            INPUT REGS ARE SAVED NOW TO EXPAND NUMBER OF WORK REGS.  * 11480002
*                                                                     * 11500002
*********************************************************************** 11510002
         L     RSIZE,SAVSPSIZ     GET SAVE/WORK AREA FOR GRAPHIC OPEN   11800002
         GETMAIN R,LV=(0)                                               11850002
         LR    RSAVE,RADR                                               11900002
CLOS0010 EQU   *                                                        11950002
         STM   RPAR,RWTGC,R5         SAVE INPUT/UPDATED REGS            12000002
         L     RDCB,ZERO(RPARC)      LOAD: COPIED DCB ADDRESS           12050002
         L     RCORE,ADR(RWTGC)            WORK AREA FOR THIS DCB       12100002
         L     RSCB1,DXUDCBAD              USER'S DCB ADDRESS           12150002
         LA    RSCB1,ZERO(RSCB1)              CLEAR HIGH BYTE           12200002
         ST    RCORE,R4                       KEEP AVAIL FOR USE        12250002
         ST    RSCB1,DECBDCB                  KEEP AVAIL FOR USE        12300002
         EJECT                                                          12310002
*********************************************************************** 12320002
*                                                                     * 12330002
*                          VALIDITY CHECKS                            * 12340002
*                                                                     * 12340402
*         1.  VALID DEVICE TYPE                                       * 12342002
*               A.  ASSUME ALL UCBS OK IF FIRST OK                    * 12344002
*                                                                     * 12346002
*********************************************************************** 12348002
         DEBCHK (RSCB1),TYPE=VERIFY,AM=GAM    VALIDATE DEB    LB Y01021 12350002
         LR    RDEB,RADR             INITIALIZE DEB BASE      LB Y01021 12400002
         LA    RDEB,ZERO(RDEB)         CLEAR HIGH ORDER BYTE            12450002
         ST    RDEB,R9                 KEEP AVAIL FOR USE               12460002
         L     RUCB,DEBSUCBA         GET FIRST UCB ADR                  12500002
         CLI   UCBTBYT3,UCB3DISP     IS DEVICE GRAPHICS TYPE  LF A37402 12550002
         BNE   CLOS0240                IF NO, SKIP PROCESSING LI A37402 12600002
         CLI   UCBTBYT4,UCBT1053     IS DEVICE 1053 TYPE                12650002
         BE    CLOS0020                IF YES,  OK TO PROCESS           12700002
         CLI   UCBTBYT4,UCBT2260     IS DEVICE 2260 TYPE                12750002
         BE    CLOS0020                IF YES,  OK TO PROCESS           12800002
         CLI   UCBTBYT4,UCBT2250     IS DEVICE 2250 TYPE                12850002
         BNE   CLOS0240                IF NO, SKIP ALL PROCESSING       12900002
         EJECT                                                          12950002
*********************************************************************** 13000002
*                                                                     * 13010002
*               COMMON PROCESSING FOR EVERY CLOSE ENTRANCE            * 13050002
*                                                                     * 13060002
*        1.  DELETE SPECIAL ROUTINES LOADED BY OPEN (IGG0193Y)        * 13100002
*            AND NOT DELETED BY SYSTEM CLOSE USING DEBSUBID           * 13150002
*               A.  IFFCAN03 LOADED FOR 2250 BASIC ATTN HANDLING UCBS * 13200002
*        2.  DECREMENT DCBS OPEN COUNT IN UCB (KEY 0)                 * 13250002
*                                                                     * 13300002
*********************************************************************** 13350002
         TM    DCBGTYPE,DCBGTBAS   IS THIS A BASIC SYSTEM?              13400002
         BNO   CLOS0020              BRANCH IF EXPRESS                  13450002
         DELETE EP=IFFCAN03                                       AOS/1 13500002
CLOS0020 EQU   *                                                        13550002
         MODESET EXTKEY=ZERO                                  LF YM4062 13600002
         SR    RCTR,RCTR           CLEAR REG FOR UCB CT INSERT          13650002
         SR    REXT,REXT                     FOR NBR OF UCBS            13700002
         SR    RLOC,RLOC                     FOR INDEXING DEBUCBAD      13750002
         IC    REXT,DEBNMEXT                 GET NBR OF UCBS            13800002
CLOS0030 EQU   *                                                        13900002
         L     RUCB,DEBSUCBA(RLOC) LOAD FIRST/NEXT UCB ADDRESS          13950002
         IC    RCTR,UCBOPEN          GET DCB OPEN COUNT                 14000002
         LTR   RCTR,RCTR                    IS OPEN COUNT ALREADY ZERO  14050002
         BZ    CLOS0040                       IF YES, GET NEXT UCB      14100002
         BCTR  RCTR,0                         IF NO, REDUCE BY ONE      14150002
         STC   RCTR,UCBOPEN          REPLACE NEW USECT IN UCB           14200002
         LTR   RCTR,RCTR           IS USE CT NOW ZERO                   14250002
         BP    CLOS0040               IF NO, SKIP BIT RESETS            14300002
         NI    UCBGCB,UCBGSET         IF YES, RESET TO IGNORE   SA32068 14350002
CLOS0040 LA    RLOC,FOUR(RLOC)           INCREMENT INDEX                14400002
         BCT   REXT,CLOS0030             BRANCH IF MORE UCBS TO SERVICE 14450002
         CLI   UCBTBYT4,UCBT2250      IS THIS A 2250                    14500002
         BNE   CLOS0090                IF NO, SKIP 2250 I/O             14550002
         CLI   UCBOPEN,ZERO            IS 2250 STILL BEING USED         14600002
         BNE   CLOS0090                 IF YES, SKIP 2250 SHUTDOWN I/O  14650002
         EJECT                                                          14700002
*********************************************************************** 14750002
*                                                                     * 14800002
*                        2250 I/0 SHUTDOWN                            * 14850002
*                                                                     * 14900002
*          1.    SOUND ALARM TO NOTIFY 2250 OPERATOR OF SHUTDOWN      * 14950002
*          2.    HALT REGENERATION OF SCREEN                          * 15000002
*          3.    TURN OFF PFK LIGHTS IF FEATURE INSTALLED             * 15050002
*                                                                     * 15110002
*********************************************************************** 15150002
         L     RCORE,R4           GET CURRENT WORK AREA ADDR            15210002
         LM    RCCW1,RCCW3,HLTCCW                                       15250002
         L     RIOB,DCBIOBAD      IOB ADDR FROM COPY DCB                15300002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             15310002
         USING DXIOB,RIOB         TEMP BASE FOR IOB I/O                 15312002
CLOS0050 TS    IOBAVAIL           CHECK IF IOB AVAILABLE FOR USE        15320002
         BZ    CLOS0060            IF YES, USE FOR SHUTDOWN I/O         15330002
         LR    RSCB1,RIOB          IF NO, SAVE & USE IF NO OTHER AVAIL  15332002
         L     RIOB,IOBNXTPT              CHECK IF ANOTHER IOB ON CHAIN 15340002
         LA    RIOB,ZERO(RIOB)                  CLEAR HIGH BYTE         15342002
         LTR   RIOB,RIOB                        CHECK FOR ADDR          15344002
         BNZ   CLOS0050                     IF YES, CHECK IF AVAILABLE  15346002
         LR    RIOB,RSCB1                   IF NO, USE LAST IOB         15348002
CLOS0060 LA    RSCB1,IOBCCW4                                            15348402
         ST    RSCB1,IOBECBPT      INITZ IOB WITH ECB ADDR       SM2858 15350002
         TM    UCBTBYT2,UCBTPFK   IS PFK FEATURE INSTALLED   LD YA01258 15400002
         BZ    CLOS0070             IF NO, SKIP PFK I/O      LD YA01258 15450002
         STM   RCCW1,RCCW3,IOBCCW1      CCWS INTO IOB           SA42814 15510002
         LA    RLOC,ZEROS           LOAD ADDRESS OF ZEROS       SA42814 15520002
         STCM  RLOC,SEVEN,IOBCCW3+1 PUT MASK ADR IN CCW         SA42814 15550002
         B     CLOS0080                 ISSUE EXCP FOR I/O              15650002
CLOS0070 STM   RCCW1,RCCW2,IOBCCW1      CCWS INTO IOB           SA42814 15750002
         NI    IOBCCW1+12,X'9F'    TURN OFF CMD CHAIN       L5 @ZA03992 15760000
CLOS0080 LR    RADR,RIOB                PUT IOB ADDR IN REG 1 &         15800002
         SVC   EXCP                     ISSUE EXCP                      15850002
         WAIT  ECB=IOBCCW4              WAIT ON I/O              SM2858 15950002
         DROP  RIOB                                                     15952002
         EJECT                                                          15960002
*********************************************************************** 15970002
*                                                                     * 15980002
*                        2250 I/0 SHUTDOWN                            * 15990002
*                                                                     * 15992002
*          4.    RELEASE BUFFER IF FEATURE INSTALLED                  * 15994002
*                                                                     * 15996002
*********************************************************************** 15998002
         MODESET EXTKEY=DATAMGT                                         15998402
         CLC   UCBBTB(THREE),ZEROS DOES BUFFER TABLE EXIST              16000002
         BE    CLOS0090                 IF NO, SKIP BFR RELEASE         16050002
         L     RSCB1,DXUDCBAD      GET USER DCB                         16150002
         LA    RDECB,DECBECB                                            16160002
         RLSEBFR    (RSCB1),ALL,MF=(E,(RDECB))   RELEASE BUFFER  SM2858 16200002
         EJECT                                                          16250002
*********************************************************************** 16300002
*                                                                     * 16350002
*                   ATTENTION HANDLING SHUTDOWN                       * 16400002
*                                                                     * 16450002
*         1.  DETERMINE TYPE OF ATTENTION HANDLING BEING USED         * 16500002
*               A.  IF BASIC, RELEASE CONTROL BLOCKS                  * 16550002
*               B.  IF EXPRESS, RELEASE/COMPRESS POLLING LIST         * 16600002
*                                                                     * 16650002
*********************************************************************** 16700002
CLOS0090 EQU   *                                                        16750002
         MODESET EXTKEY=ZERO                                            16760002
         L     RDEB,R9              GET DEB FOR LATER USE               16770002
         L     RSCB1,CVTPTR         GET CVT ADDR FROM FIXED LOCATION    16800002
         L     RTCB,CVTTCBP         GET ADDRS OF: TCB TABLE             16850002
         L     RSCB2,ACURASCB(RTCB)               ASCB                  16900002
         ST    RSCB2,ASCBADR                        KEEP FOR BR ENTRIES 16950002
         L     RTCB,ACURTCB(RTCB)                 CURRENT TCB           17000002
         TM    DCBGTYPE,DCBGTBAS    IS THIS A BASIC SYSTEM?             17050002
         BNO   EAH0280                IF NO, DO EXPRESS PROCESSING      17100002
         EJECT                                                          17150002
*********************************************************************** 17200002
*                                                                     * 17250002
*                   BASIC ATTENTION HANDLING SHUTDOWN                 * 17300002
*                                                                     * 17350002
*        1.  VALIDATE CORRECT TASK IS REQUESTING CLOSE                * 17400002
*              A.  IF INCORRECT AND NOT ABENDING, ISSUE ABEND         * 17450002
*                                                                     * 17500002
*********************************************************************** 17550002
         USING TEB,RTEB                                                 17560002
         L     RTEB,UCBTEB       DOES TEB EXIST                         17600002
         LTR   RTEB,RTEB           IF NO, SKIP BASIC PROCESSING &       17650002
         BZ    CLOS0210                   CK IF OK TO PURGE IOBS        17700002
         L     RSCB1,TEBTCB        IF YES, TEB TCB AND CUR TCB          17750002
         CR    RSCB1,RTCB                  MUST BE EQUAL OR ABENDING    17800002
         BE    BAH0100                 IF EQUAL, OK TO PROCESS          17850002
         TM    TCBFLGS1,TCBFA    IS ABEND IN PROGRESS        LI SA45407 17900002
         BO    CLOS0240            IF YES, DONE PROCESSING   LI SA45407 17950002
         LA    RADR,X'D14'              LOAD ABEND CODE       LC S21016 18000002
         SLL   RADR,12                  SHIFT CODE            LC S21016 18050002
         ABEND (1),DUMP                 ABEND TASK            LC S21016 18100002
         EJECT                                                          18150002
*********************************************************************** 18200002
*                                                                     * 18250002
*                   BASIC ATTENTION HANDLING SHUTDOWN                 * 18300002
*                                                                     * 18350002
*            2.    DAR ANY REBS ASSOCIATED WITH THE DCB               * 18400002
*                                                                     * 18450002
*********************************************************************** 18500002
BAH0100  EQU   *                                                        18550002
         USING GACB,RGACB                                               18600002
         USING REB,RREB                                                 18650002
         L     RREB,TEBREB            LOAD FIRST REB                    18700002
         LTR   RREB,RREB              ANY REBS ON THIS TEB              18750002
         BE    BAH0130                  IF NO, SKIP DAR PROCESSING      18800002
BAH0110  EQU   *                                                        18850002
         L     RGACB,REBGACB          LOAD GACB ADDRESS                 18900002
         L     RREB,REBL              LOAD NEXT REB ADDR                18950002
         L     RSCB1,DECBDCB          GET USER DCB                      19000002
         L     RSCB2,GACBDCB          GET DCB ADR                       19050002
         LA    RSCB2,ZERO(RSCB2)        CLEAR HIGH ORDER BYTE           19100002
         L     RCORE,R4                 GET WORK AREA                   19150002
         CLR   RSCB1,RSCB2            DO  DCB ADRS MATCH                19200002
         BNE   BAH0120                   IF NO, SKIP DAR & CK NEXT REB  19250002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             19300002
         OI    GACBFLGS+1,GACBCLOS     SET BIT FOR DAR TO CLOSE         19350002
         MODESET EXTKEY=ZERO                                            19400002
         LA    RADR,DARPLGH            GET ADDR OF DAR'S PLIST          19450002
         LA    RE,TWO                  LOAD LIST LENGTH                 19500002
         ST    RGACB,DARGACB            STORE GACB ADR IN PARM LIST     19550002
         ST    RE,DARPLGH               STORE LENGTH IN PARM LIST       19600002
         SVC   DAR                     ISSUE SVC FOR DAR (IGC0007D)     19650002
BAH0120  EQU   *                                                        19700002
         LTR   RREB,RREB               ARE THERE MORE REBS              19750002
         BNZ   BAH0110                    IF YES, REPEAT PROCESSING     19800002
         DROP  RGACB                                                    19850002
         DROP  RREB                                                     19900002
         EJECT                                                          19950002
*********************************************************************** 20000002
*                                                                     * 20050002
*                   BASIC ATTENTION HANDLING SHUTDOWN                 * 20100002
*                                                                     * 20150002
*          3.     FREE IQES ON IRB FOR CANCEL KEY                     * 20200002
*                                                                     * 20250002
*********************************************************************** 20300002
         USING RBBASIC,RIRB                                             20350002
BAH0130  EQU   *                                                        20400002
         CLI   UCBOPEN,ZERO      CHECK DCB OPEN COUNT                   20450002
         BNE   CLOS0210            IF NO, SKIP FREEMAINS                20500002
         SR    REXT,REXT           IF YES, OK TO FREE IQES, ETC         20550002
         IC    REXT,DEBNMEXT         GET NBR OF UCBS FROM DEB           20600002
         LA    RLOC,DEBSUCBA         GET PTR TO FIRST UCB               20650002
         LR    RGMTCB,RTCB            CURRENT TCB ADDR                  20700002
         L     RASCB,ASCBADR          CURRENT ASCB ADDR                 20750002
LL1ON    SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,IGG0203Y(X20800002
               LL1OFF)),REGS=SAVE                                       20850002
BAH0140  EQU   *                                                        20900002
         L     RUCB,ZERO(RLOC)        LOAD UCB ADDRESS                  20950002
         LA    RUCB,ZERO(RUCB)        CLEAR HIGH ORDER BYTE             21000002
         CLI   UCBTBYT4,UCBT2250      IS DEVICE A 2250                  21050002
         BNE   BAH0150                 IF NO, ONLY ONE IQE TO FREE      21100002
         LA    RCOUNT,THREE            IF YES, THREE IQES TO FREE       21150002
         L     RIRB,TEBCKRB         LOAD CANCEL KEY IRB FROM TE         21200002
         L     RADR,RBNEXAV              LOAD CANCEL KEY IQE ADDRESS    21250002
         LTR   RADR,RADR          DOES CKQE EXIST                       21300002
         BZ    BAH0160                 IF NO, CHECK GAR'S IRB           21350002
         MVC   RBNEXAV(FOUR),ZERO(RADR)       UPDATE CKIQE FLD          21400002
         L     RE,IQESIZE              LOAD IQE BYTE REQUEST            21450002
         FREEMAIN  R,LV=(0),A=(1),BRANCH=YES      FREE CANCEL KEY IQE   21500002
         B     BAH0160                 NOW CHECK GAR'S IRB              21550002
         EJECT                                                          21600002
*********************************************************************** 21650002
*                                                                     * 21700002
*                   BASIC ATTENTION HANDLING SHUTDOWN                 * 21750002
*                                                                     * 21800002
*       4.   FREE IQES ON IRB FOR GAR                                 * 21850002
*           A. IF 2250S:  ONE IQE FOR CANCEL KEY'S IRB                * 21900002
*                         THREE IQES FOR GAR'S IRB (THREE ATTN TYPES) * 21950002
*           B. IF 2260S:  ONE IQE FOR GAR'S IRB (ONE ATTN TYPE)       * 22000002
*                                                                     * 22050002
*********************************************************************** 22100002
BAH0150  EQU   *                                                        22150002
         LA    RCOUNT,ONE                  LOAD 2260 COUNT              22200002
BAH0160  EQU   *                                                        22250002
         L     RIRB,TEBGARB         LOAD GAR'S IRB ADDRESS FROM TEB     22300002
BAH0170  EQU   *                                                        22350002
         L     RADR,RBNEXAV         LOAD CANCEL KEY IQE ADDRESS         22400002
         LTR   RADR,RADR                  ANY MORE IQES                 22450002
         BZ    BAH0180                 NO                               22500002
         MVC   RBNEXAV(FOUR),ZERO(RADR)    UPDATE CKIQE FLD             22550002
         L     RE,IQESIZE              LOAD IQE BYTE REQUEST            22600002
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES      FREE IQE               22650002
         BCT   RCOUNT,BAH0170              BRANCH IF MORE IQES TO FREE  22700002
         EJECT                                                          22750002
*********************************************************************** 22800002
*                                                                     * 22850002
*                   BASIC ATTENTION HANDLING SHUTDOWN                 * 22900002
*                                                                     * 22950002
*          5.     CLEAR UCBTEB FIELD                                  * 23000002
*          6.     TURN OFF UCBGCB BITS, GINIT AND GBAS                * 23050002
*          7.     DECREMENT TEB UCB USE COUNT                         * 23100002
*                   A.  IF TEB UCB USE COUNT IS ZERO                  * 23150002
*                         1).  FREE IRBS                              * 23200002
*                         2).  FREE TEB                               * 23250002
*                                                                     * 23300002
*********************************************************************** 23350002
BAH0180  EQU   *                                                        23400002
         XC    UCBTEB(FOUR),UCBTEB    CLEAR UCBTE FIELD                 23450002
         NI    UCBGCB,UCBGSET         RESET TO IGNORE ATTNS     SA32068 23500002
         L     RCOUNT,TEBUCBCT        LOAD TEB UCB COUNT     LG ZA00500 23550000
         BCTR  RCOUNT,ZERO            DECREMENT USECNT (TE)  LG ZA00500 23600000
         ST    RCOUNT,TEBUCBCT        RESTORE USECNT         LG ZA00500 23650000
         LA    RLOC,FOUR(RLOC)             INCREMENT UCB PTR ADR        23700002
         BCT   REXT,BAH0140              BRANCH IF MORE UCBS            23750002
LL1OFF   SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGG0203Y(LL1ON)),   X23800002
               REGS=SAVE                                                23850002
         LTR   RCOUNT,RCOUNT             IS TEB STILL IN USE LG ZA00500 23900000
         BNE   CLOS0210                  IF YES, DO ABEND CK & PURGE    23950002
         EJECT                                                          24000002
*********************************************************************** 24050002
*                                                                     * 24100002
*                   BASIC ATTENTION HANDLING SHUTDOWN                 * 24150002
*                                                                     * 24200002
*       8.   FREE IRBS (INCLUDING THEIR PP SAVE AREA) AND TEB         * 24250002
*                                                                     * 24300002
*     NOTE: IRBS THAT ARE ACTIVE CAN NOT BE FREED; THE IRB ON  SM4120 * 24350002
*           THE TASK RB CHAIN IS LEFT FOR ABEND TO FREE.       SM4120 * 24400002
*                                                                     * 24450002
*********************************************************************** 24500002
         L     RIRB,TEBCKRB          IS THERE A CANCEL KEY IRB   SM4120 24550002
         LTR   RIRB,RIRB                                         SM4120 24600002
         BZ    BAH0190                  IF NO,CK FOR A GAR IRB   SM4120 24650002
         TM    RBSTAB2,RBFACTV       IS THIS IRB ACTIVE ?        SM4120 24700002
         BO    BAH0190                  IF YES, DO NOT REMOVE    SM4120 24750002
         L     RSIZE,REQUEST2           LOAD PPSVAREA REQUEST    SM4120 24800002
         L     RADR,ZERO(RIRB)          LOAD PPSVAREA ADDRESS    SM4120 24850002
         FREEMAIN   R,LV=(0),A=(1)      FREE PROB PROG SAVE AREA SM4120 24900002
         L     RSIZE,IRBSIZE              LOAD IRB BYTE REQUEST         24950002
         LR    RADR,RIRB                  LOAD IRB ADDRESS TO PARM REG  25000002
         FREEMAIN  R,LV=(0),A=(1)      FREE CANCEL KEY IRB              25050002
BAH0190  L     RIRB,TEBGARB     IS THERE A GAR IRB               SM4120 25100002
         LTR   RIRB,RIRB          IF NO, CK FOR A TEB            SM4120 25150002
         BZ    BAH0200                                           SM4120 25200002
         TM    RBSTAB2,RBFACTV     IS THIS IRB ACTIVE ?          SM4120 25250002
         BO    BAH0200                  IF YES, DO NOT REMOVE    SM4120 25300002
         L     RSIZE,REQUEST2           LOAD PPSVAREA REQUEST    SM4120 25350002
         L     RADR,ZERO(RIRB)         LOAD PPSVAREA ADDRESS FROM IRB   25400002
         FREEMAIN  R,LV=(0),A=(1)      FREE PROB PROG SAVE AREA         25450002
         L     RSIZE,IRBSIZE              LOAD IRB BYTE REQUEST         25500002
         LR    RADR,RIRB                  LOAD IRB ADDRESS TO PARM REG  25550002
         FREEMAIN  R,LV=(0),A=(1)      FREE GAR IRB                     25600002
BAH0200  L     RSIZE,TEBSIZE            LOAD TE BYTE REQUEST      M4120 25650002
         LR    RADR,RTEB                 LOAD TE ADDRESS IN PARM REG    25700002
         FREEMAIN  R,LV=(0),A=(1)          FREE TE                      25750002
         EJECT                                                          25800002
*********************************************************************** 25850002
*                                                                     * 25900002
*                COMMON PROCESSING IF NOT ABENDING                    * 25950002
*                                                                     * 26000002
*     1.  PURGE, THEN FREEMAIN, ALL IOBS                              * 26050002
*                                                                     * 26060002
*********************************************************************** 26070002
CLOS0210 EQU   *                                                        26350002
         LR    RTCB,RGMTCB                                              26400000
         TM    TCBFLGS1,TCBFA ABEND IN PROGRESS                         26450002
         BO    CLOS0240                                                 26500002
CLOS0220 EQU   *                                                        26550002
         MODESET  EXTKEY=DATAMGT                                        26600002
         L     RCORE,R4      GET ADDR OF WORK AREA                      26650002
         ST    RDEB,DXCCW6         STORE DEB ADDRESS         LI SA42542 26700002
         MVI   DXCCW6,X'A0'        PURGE OPTION              LI SA42542 26750002
*      PURGE OPTIONS: SPECIFIED ONLY; DON'T POST; HIO; RELATED ONLY     26800002
         XC    DXCCW6+4(EIGHT),DXCCW6+4 CLEAR FIELDS         LI SA42542 26850002
         LA    RADR,DEBNMEXT    GET IOB PURGE CHAINING ADDRESS FROM DEB 26900002
         ST    RADR,DXCCW6+8       FOR PURGE TO CHAIN IOB    LI SA42542 26950002
         LA    RADR,DXCCW6         GET ADDRESS OF LIST                  27000002
         SVC   16                                                       27050002
         WAIT  ECB=DXCCW6+4        WAIT ON PURGE ECB                    27100002
         SR    RCTR,RCTR                 ZERO REGISTER                  27150002
         IC    RCTR,DCBGNCP              LOAD NO.OF IOBS                27200002
         CLI   DCBGNCP,DCBGNCPH          IS GNCP EQUAL TO MAXIMUM       27250002
         BE    CLOS0230                     IF YES, DO NOT ADJUST CTR   27300002
         LA    RCTR,ONE(RCTR)                       FOR SPARE IOB       27350002
CLOS0230 EQU   *                                                        27400002
         LA    RCALC,IOBSIZE              LOAD IOB BLOCK SIZE           27450002
         MR    RSIZE,RCTR                  CALC SIZE TO RELEASE         27500002
         LA    RSIZE,EIGHT(RCALC)             ADD FINAL SIZE FACTOR     27550002
         O     RSIZE,IOBSPOOL             INDICATE IOB POOL             27600002
         L     RADR,DCBIOBAD             LOAD IOB ADDRESS               27650002
         S     RADR,IOBECB                                    LF YM7703 27700002
         FREEMAIN R,LV=(0),A=(1)                                        27750002
         EJECT                                                          27752002
*********************************************************************** 27760002
*                                                                     * 27770002
*                COMMON PROCESSING IF NOT ABENDING                    * 27780002
*                                                                     * 27790002
*     2.  RESTORE DCB FIELDS TO PRE-OPEN STATUS; I. E., ZERO FIELDS:  * 27792002
*          A.  BUFFER RELATED FIELDS:  STARTING ADDRESSES AND SIZE    * 27794002
*          B.  IOB ADDRESS                                            * 27796002
*                                                                     * 27798002
*********************************************************************** 27798402
         SR    RADR,RADR             INITIALIZE FIELDS TO ZEROS:        27800002
         STH   RADR,DCBBRSA              BUFFER RESTART ADDRESS         27850002
         ST    RADR,DCBBFRST             BUFFER STARTING ADDR & SIZE    27900002
         ST    RADR,DCBIOBAD             IOB CHAINING ADDRESS           27950002
         EJECT                                                          28000002
*********************************************************************** 28050002
*                                                                     * 28100002
*               CLOSE CHECK FOR ADDITIONAL DCBS TO PROCESS            * 28150002
*                                                                     * 28200002
*********************************************************************** 28250002
CLOS0240 EQU   *                                                        28300002
         MODESET  EXTKEY=DATAMGT                                        28350002
         LM    RCORE,RWTGC,R4        RESTORE INPUT REGS                 28400002
         XC    ZERO(TWO,RWTGC),ZERO(RWTGC)   CLEAR ID IND COMPLETION    28450002
CLOS0250 EQU   *                                                        28500002
         LA    RWTGC,WGOFF(RWTGC)      STEP TO NEXT ENTRY               28550002
         LA    RPARC,ADR(RPARC)        STEP TO NEXT ENTRY               28600002
         CLC   ZERO(TWO,RWTGC),GIDCNST1 CHECK FOR ID MATCH              28650002
         BE    CLOS0010                BRANCH IF HIT                    28700002
         CLC   ZERO(TWO,RWTGC),CLLDB    CHECK FOR ID MATCH              28750002
         BL    CLOS0250                BRANCH IF NO HIT                 28800002
         CLC   ZERO(TWO,RWTGC),CLLDG    CHECK FOR ID MATCH              28850002
         BH    CLOS0250                BACK TO LOOP IF HIGH             28900002
         LR    RPARC,RPAR              INITIALIZE REGISTER              28950002
         LA    RWTGC,WAOFF(RWTG)     INITIALIZE REGISTER                29000002
CLOS0260 EQU   *                                                        29050002
         CLI   ZERO(RWTGC),ZERO      IS THIS ENTRY ZERO?                29100002
         BNE   CLOS0270                BRANCH IF NO                     29150002
         LA    RWTGC,WGOFF(RWTGC)    INCREMENT POINTER                  29200002
         LA    RPARC,ADR(RPARC)    INCREMENT POINTER                    29250002
         B     CLOS0260                BRANCH UNCONDITIONALLY           29300002
CLOS0270 EQU   *                                                        29350002
         LR    RADR,RSAVE         PRIME ADDR REG                        29400002
         L     RSIZE,SAVSPSIZ     GET SAVE/WORK AREA DESCRIPTION        29450002
         FREEMAIN R,LV=(0),A=(1)                                        29500002
         MVC   SIX(TWO,RWTG),ZERO(RWTGC)  SET UP ID FOR XCTL            29550002
         MVC   TTROFF(THREE,RWTG),TWO(RWTGC)    ID TO TTR               29600002
         LA    RLINK,DXCCW12              POINT TO XCTL PARAMETER       29650002
         XCTL  DE=(RWTG),SF=(E,(RLINK))                                 29700002
         EJECT                                                          29750002
*********************************************************************** 29800002
*                                                                     * 29850002
*                  EXPRESS ATTENTION HANDLING SHUTDOWN                * 29900002
*                                                                     * 29950002
*   ABEND CHECK: SKIP POLST PROCESSING IF TASK ABENDING SINCE         * 30000002
*                POLST IS NO LONGER FUNCTIONAL                        * 30050002
*                                                                     * 30100002
*       1.     FREE/COMPRESS POLLING LIST (USER KEY)                  * 30150002
*                                                                     * 30200002
*********************************************************************** 30250002
EAH0280  TM    TCBFLGS1,TCBFA      IS ABEND IN PROGRESS                 30300002
         BO    CLOS0240               IF YES, NO PROCESSING REQUIRED    30350002
         L     RADR,DCBPOLST   GET POLL LIST ADDR FROM COPY DCB         30400002
         LA    RADR,ZERO(RADR)    CLEAR HIGH ORDER BYTE                 30450002
         LTR   RADR,RADR           DOES A LIST EXIST                    30500002
         BZ    CLOS0220              IF NO, CK FOR IOB PURGE            30550002
         CLI   ZERO(RADR),ZERO     IF YES, CK IF LIST IS ACTIVE         30600002
         BE    CLOS0220                IF NO, SKIP PROCESSING           30650002
         L     RLAST,ZERO(RADR)       IF YES, GET LAST ENTRY ADDR       30700002
         LA    RLAST,ZERO(RLAST)        CLEAR FLAG BYTE                 30750002
         LA    RLOC,FOUR(RADR)           GET LOCATION FIRST ENTRY       30800002
         L     RCORE,R4                  GET WORK AREA                  31000002
         L     RSCB1,DECBDCB             GET USER DCB FOR CHECK         31050002
         MODESET  KEYADDR=DXUKEY,WORKREG=7                              31100002
EAH0290  EQU   *                                                        31110002
         L     RSCB2,ZERO(RLOC)         GET DCB ADDR FROM ENTRY         31120002
         LA    RSCB2,ZERO(RSCB2)        CLEAR INDEX BYTE                31130002
         CLR   RSCB1,RSCB2               CLOSING DCB MATCH THIS ENTRY   31150002
         BE    EAH0300                     IF YES, REMOVE ENTRY         31200002
         CLR   RLOC,RLAST            IS THIS END OF LIST                31250002
         BE    CLOS0220                IF YES, PROCESSING DONE          31300002
         LA    RLOC,FOUR(RLOC)         IF NO, GET ADDR NEXT ENTRY       31350002
         B     EAH0290                        AND REPEAT PROCESSING     31400002
         EJECT                                                          31450002
*********************************************************************** 31500002
*                                                                     * 31550002
*                  EXPRESS ATTENTION HANDLING SHUTDOWN                * 31600002
*                                                                     * 31650002
*         1.    DCB MATCH FOUND (CLOSING DCB & POLL LIST ENTRY)       * 31700002
*                                                                     * 31750002
*                    RLOC  HAS ENTRY ADDR WITH MATCH                  * 31800002
*                    RLAST     ADDR OF LAST ENTRY IN POLL LIST        * 31850002
*                    RSCB2     ENTRY CONTENTS; I.E., DCB ADDR         * 31900002
*                                                                     * 31950002
*********************************************************************** 32000002
EAH0300  EQU   *                                                        32050002
         SR    RE,RE                 GET SOURCE OF ZEROS                32060002
         LA    RNEXT,FOUR(RLOC)      GET NEXT ENTRY LOCATION            32100002
EAH0310  EQU   *                                                        32150002
         CLR   RNEXT,RLAST           IS NEXT ENTRY LOC INSIDE LIST      32200002
         BH    EAH0330                 IF NO, REMOVE LAST ENTRY         32250002
         L     RSCB2,ZERO(RNEXT)       IF YES, GET NEXT ENTRY           32300002
         LA    RSCB2,ZERO(RSCB2)         CLEAR INDEX BYTE               32350002
         CLR   RSCB1,RSCB2               CLOSING DCB MATCH NEXT ENTRY   32400002
         BE    EAH0320                     IF YES, REMOVE ENTRY         32450002
         MVC   ZERO(FOUR,RLOC),ZERO(RNEXT)    IF NO, COMPRESS ENTRY     32500002
         LA    RLOC,FOUR(RLOC)        ADJUST LOCATION TO NEXT ENTRY     32550002
EAH0320  EQU   *                                                        32600002
         LA    RNEXT,FOUR(RNEXT)      GET NEW NEXT ENTRY LOCATION       32650002
         B     EAH0310                 AND REPEAT PROCESSING            32700002
*      DCB MATCH FOUND                                                  32750002
EAH0330  EQU   *                                                        32800002
         LR    RNEXT,RLOC                GET PREVIOUS ENTRY LOCATION    32850002
EAH0340  EQU   *                                                        32900002
         ST    RE,ZERO(RNEXT)            REMOVE ENTRY FROM LIST         32950002
         LA    RNEXT,ADR(RNEXT)          ADJUST POINTER TO NEXT ENTRY   33000002
         CLR   RNEXT,RLAST           IS NEXT ENTRY INSIDE LIST          33050002
         BNH   EAH0340                 IF YES, CONTINUE TO PROCESS      33100002
         S     RLOC,ENTRY              IF NO, BACK UP TO LAST ENTRY     33150002
         CLR   RADR,RLOC             ANY ENTRIES IN POLL LIST           33200002
         BE    EAH0350                 IF NO, RESET ACTIVE FLAG         33250002
         STCM  RLOC,SEVEN,ONE(RADR)    IF YES, INSERT NEW EOL PTR       33300002
         B     CLOS0220              CHECK FOR IOBS TO PURGE            33350002
EAH0350  EQU   *                                                        33400002
         STC   RE,ZERO(RADR)        RESET TO INACTIVE LIST (NO ENTRIES) 33450002
         B     CLOS0220             CHECK FOR IOBS TO PURGE I/O         33500002
         EJECT                                                          33550002
*********************************************************************** 33600002
*                                                                     * 33650002
*                      CONSTANTS                                      * 33700002
*                                                                     * 33750002
*********************************************************************** 33800002
ZEROS    DC    F'0'                MASK TO TURN OFF PFK LIGHTS  SA42814 33900002
HLTCCW   DC    X'0700000040000002'                                      33950002
         DC    X'0B00000060000002'                              SA42814 34000002
PFKCCW   DC    X'1B00000020000004'  CCW TO TURN OFF PFK'S       SA42814 34050002
IOBSPOOL DC    X'FA000000'             SP 250 FOR IOB                   34200002
IQESIZE  DC    X'E9000010'             SP 233     16 BYTE IQE     AOS/1 34300002
IRBSIZE  DC    X'E9000068'             SP 233     104 BYTE IRB    AOS/1 34400002
TEBSIZE  DC    X'EB000024'             SP 235    36 BYTE TEB LG @ZM2360 34500000
REQUEST2 DC    X'FA000048'             SP 250     72 BYTE PP SAVE AREA  34600002
SAVSPSIZ DC    X'E6000078'             SP 230     120 BYTE WORK AREA    34700002
ENTRY    DC    F'4'                    POLL LIST ENTRY SIZE IN BYTES    34900002
IOBECB   DC    F'8'                    IOB ECB SIZE IN BYTES            34910002
GIDCNST1 DC    C'3Y'                                                    34950002
CLLDB    DC    C'0B'                                                    35000002
CLLDG    DC    C'0G'                                                    35050002
         SPACE 5                                                        35060002
**********************************************************************  35070002
*                                                                    *  35080002
*                SPECIAL MAINTENANCE PATCH AREA FOR FIELD USE        *  35090002
*                                                                    *  35092002
**********************************************************************  35094002
PATCH    DC    C'IGG0203Y 50 BYTE PATCH AREA.'                          35096002
         DC    C'50 BYTE AREA ENDS HERE'                                35098002
         EJECT                                                          35100002
*********************************************************************** 35150002
*                                                                     * 35200002
*              DSECTS                                                 * 35250002
*                                                                     * 35300002
*********************************************************************** 35350002
         CVT   DSECT=YES                                                35400002
         EJECT                                                          35450002
         DCBD  DSORG=GS                                                 35500002
**********************************************************************  35550002
*                                                                     * 35600002
*                    ADDITIONAL DCB EQUATES FOR DSECT                 * 35650002
*                                                                     * 35700002
*********************************************************************** 35750002
DCBGNCPL EQU   X'00'   LOW END OF RANGE FOR CHANNEL PROGRAMS IS 1       35800002
DCBGNCPH EQU   X'63'   HIGH END OF RANGE FOR CHANNEL PROGRAMS IS 99     35850002
         EJECT                                                          35900002
         IEZDEB                                                         35950002
         IECDSECS MAIN,EXPAND=YES                                       36000002
*                                                                       36050002
*        ADDITIONAL IOB LABELS FOR GAM EXTENSION                        36100002
*                                                                       36150002
         ORG   DXIOB                                                    36200002
IOBDX    DS    8F          USE WORK AREA LABELS FOR STD FIELDS          36250002
*       GAM EXTENSION                                                   36300002
IOBUCBX  DS    0CL1               UCB INDEX                             36350002
IOBADRPT DS    F                  ADDRESSING LIST POINTER               36400002
IOBAVAIL DS    0CL1    BIT 0:  ON IF IOB NOT AVAILABLE FOR USE          36450002
IOBNXTPT DS    F       NEXT IOB POINTER                                 36500002
IOBCCW1  DS    2F      MAX NBR OF CCWS FOR A GRAPHIC CHANNEL PGM IS 4   36510002
IOBCCW2  DS    2F                                                       36520002
IOBCCW3  DS    2F                                                       36530002
IOBCCW4  DS    2F      * USED AS ECB FOR SHUTDOWN I/O *                 36540002
         EJECT                                                          36550002
GACB     DSECT                                                          36600002
GACBCOM  DS    F        ADDR OF:     USER COMMUNICATION AREA FOR ATNS   36650002
GACBDCB  DS    F                     DCB FOR DEVICE WITH ATTENTIONS     36700002
GACBPFK  DS    F        MASKS:       PFK ATTENTION SOURCES PERMITTED    36750002
GACBATYP DS    F                     ATTENTION TYPES PERMITTED          36800002
GACBEP1  DS    F        ADDR OF:     ENTRY POINT FOR USER'S ATN RTN     36850002
GACBEP2  DS    F                     ENTRY POINT FOR ATNQ, MODE=R       36900002
GACBSA   DS    F                     SAVE AREA FOR ATNQ                 36950002
GACBPKSA DS    F        MASKS:       SAVE AREA FOR PFK MASK             37000002
GACBATSA DS    F                     SAVE AREA FOR ATTENTION TYPES      37050002
GACBECB  DS    F                     ECB USED FOR ATNQ, MODE=W          37100002
GACBREB  DS    F        ADDR OF:     REB FOR THIS ATTENTION ROUTINE     37150002
GACBIDX  DS    C        INFO:        INDEX VALUE TO FIND 2260 UCBS      37200002
GACBLPR  DS    C                     BUFFER RESTART LOCATION FOR LP     37250002
GACBFLGS DS    H        FLAGS:                                          37300002
GACBCLOS EQU   X'01'                 CLOSE HAS ISSUED DAR               37350002
GACBATNQ DS    F        ADDR OF:     ATTENTION INQUIRY RTN (IGG019OK)   37400002
GACBRES  DS    F                     RESERVED                           37450002
         EJECT                                                          37500002
         IHAPSA                                                         37550002
         EJECT                                                          37600002
*             ROUTINE ENTRY BLOCK (REB)                                 37650002
*                                                                       37700002
*       1.  CREATED BY USER WITH GRAPHICS SPAR MACRO                    37750002
*       2.  SEE SVC MODULE, IGC0007C FOR FURTHER DETAILS                37800002
*                                                                       37850002
REB      DSECT                                                          37900002
REBL     DS    F        ADDR OF:     NEXT LOWER PRIORITY REB, OR ZEROS  37950002
REBH     DS    F                     NEXT HIGHER PRIORITY REB, OR TEB   38000002
REBUCB   DS    F                     UCB, OR LIST OF UCBS               38050002
REBGACB  DS    F                     GACB                               38100002
REBGEIRB DS    F                     GEIR'S IRB                         38150002
REBFLGS  DS    H       FLAGS:                                           38200002
REBPRTY  DS    H                     PRIORTY INDICATED BY USER IN SPAR  38250002
REBQ1    DS    F       ADDR OF:      IQE TO BE PROCESSED IF EP=0        38300002
REBQ2    DS    F                     IQE NEXT TO BE PROCESSED           38350002
REBTCB   DS    F                     TCB                                38400002
REBRES   DS    F                     RESERVED                           38450002
         EJECT                                                          38500002
         IHARB                                                          38550002
         EJECT                                                          38600002
         IKJTCB                                                         38650002
         EJECT                                                          38700002
TEB      DSECT                                                          38750002
TEBCKRB  DS    F       ADDR OF:      IRB FOR CANCEL KEY (IFFCAN03)      38800002
TEBREB   DS    F                     GAM ROUTINE ENTRY BLOCK            38850002
TEBTCB   DS    F                     TCB                                38900002
TEBCKQE  DS    F                     LIST OF CANCEL KEY IQES            38950002
TEBUCBCT DS    F       USE COUNT:    NBR OF UCBS USING THIS TEB         39000002
TEBFLGS  DS    F       FLAG BYTES:                                      39050002
TEBFLAG  EQU   X'80'                 TEB ID FLAG                        39100002
TEBGARB  DS    F       ADDR OF:      IRB FOR GAR (IGG019OE)             39150002
TEBGEIR  DS    F                     GEIR (IGG019OJ) ENTRY POINT        39200002
TEBGIOCR DS    F              GIOCR(IGG0190A)ENTRY POINT     LG @ZM2360 39210000
         EJECT                                                          39250002
UCB      DSECT                                                          39300002
         IEFUCBOB                                                       39350002
         EJECT                                                          39400002
**********************************************************************  39450002
*                                                                     * 39500002
*                    ADDITIONAL UCB EQUATES FOR DSECT                 * 39550002
*                                                                     * 39600002
*********************************************************************** 39650002
         SPACE 3                                                        39700002
*          UCBTYP, BYTE 2, BIT SETTINGS                                 39750002
         SPACE                                                          39800002
UCBTPFK  EQU   X'10'           UNIT TYPE BIT 3 FOR PFK FEATURE          39850002
         SPACE 3                                                        39900002
*          UCBTYP, BYTE 4, BIT SETTINGS                                 39950002
         SPACE                                                          40000002
UCBT2250 EQU   X'02'           UNIT TYPE ID FOR 2250 DEVICE             40050002
UCBT2260 EQU   X'03'                        FOR 2260                    40100002
UCBT1053 EQU   X'04'                        FOR 1053                    40150002
         SPACE 2                                                        40200002
*          UCBGCB, BIT SETTINGS                                         40250002
         SPACE                                                          40300002
UCBGINIT EQU   X'40'                   OK TO ACCEPT ATTNS NOW    A32068 40350002
UCBGBAS  EQU   X'08'                                                    40400002
UCBGSET  EQU   X'B7'                   RESET ABOVE BITS TO ZERO         40450002
         EJECT                                                          40500002
*********************************************************************** 40550002
*                                                                     * 40600002
*                        SAVE AREA DSECT                              * 40650002
*                                                                     * 40700002
*********************************************************************** 40750002
SAVEAREA DSECT                                                          40800002
WKSA     DS    5F             WORK WORDS FOR LOCAL LOCK WHEN REGS=SAV   40850002
R0       DS    F                       REG ZERO    *  REGS MAP INTO  *  41100002
R1       DS    F                       REG ONE      *  STANDARD OS  *   41150002
R2       DS    F                       REG TWO     *  DISPLACEMENTS  *  41200002
R3       DS    F                       REG THREE        *  FOR  *       41250002
R4       DS    F                       REG FOUR      *  SAVE AREA  *    41300002
R5       DS    F                       REG FIVE       *  CHAINING *     41350002
R6       DS    F                       REG SIX                          41400002
R7       DS    F                       REG SEVEN                        41450002
R8       DS    F                       REG EIGHT                        41500002
R9       DS    F                       REG NINE                         41550002
R10      DS    F                       REG TEN                          41600002
R11      DS    F                       REG ELEVEN                       41650002
R12      DS    F                       REG TWELVE                       41700002
EPCAN03  DS    F                       IFFCAN03 ADDRESS SAVE            41750002
EPGAR    DS    F                       GAR ADDRESS SAVE                 41800002
EPGEIR   DS    F                       GEIR ADDRESS SAVE                41850002
ASCBADR  DS    F                       ADDR OF CURRENT ASCB             41900002
*    THE FOLLOWING SECTION OF THE DSECT IS USED FOR THE GRAPHICS      * 41950002
*    SHUTDOWN I/O AND EXTERNAL LINKAGES.  THE GETMAIN AREA IS USED    * 42000002
*    TO MAKE THE MODULE REENTRANT.                                    * 42050002
*                                                                     * 42100002
*                        DECB                                         * 42150002
*                                                                     * 42200002
DECBECB  DS    F                       ECB WORD                         42250002
DECBTYPE DS    F                       TYPE OF I/O OPERATION            42300002
RMICODE  EQU   X'08'                   TYPE CODE FOR RMI                42350002
DECBDCB  DS    F                       POINTER TO DCB                   42400002
DECBADDR DS    F                       I/O BUFFER-DATA TO BE            42450002
*                                      TRANSFERRED                      42500002
DECBHEX  DS    C                       ECB POSTING CODE                 42550002
DECBCNT  DS    3C                      RESIDUAL COUNT FROM CSW AFTER    42600002
*                                      I/O COMPLETED                    42650002
DECBOCBP DS    F                       O/P CONTROL BLOCK POINTER        42700002
DECBSTRT DS    F                       START ADDR OF CONTROL ORDERS     42750002
DECBUNIT DS    C                       UNIT INDEX                       42800002
DECBBUFF DS    3C                      BUFFER ADDRESS                   42850002
         ORG   DECBECB                                                  42900002
DARPLGH  DS    F          LENGTH OF DAR'S PARAMETER LIST                42950002
DARGACB  DS    F          ADDRESS OF GACB TO BE DELETED                 43000002
         END                                                            43050002
./  ADD  SSI=72020099,NAME=IGG0203Z
         TITLE 'GRAPHICS TASK TERMINATION SECTION'                      00050002
*********************************************************************** 00100002
*                                                                       00150002
* MODULE NAME:            IGG0203Z (OS/VS2)                             00200002
*                                                                       00250002
* DESCRIPTIVE NAME:       GRAPHICS TASK TERMINATION                     00300002
*                                                                       00350002
* COPYRIGHT:              NONE                                          00400002
*                                                                       00450002
* STATUS:                 RELEASE 2.0                                   00500002
*                                                                       00550002
* FUNCTION:              THIS MODULE PERFORMS BOTH NORMAL AND ABNORMAL  00600002
*                        TASK TERMINATION FUNCTIONS FOR THE 2250S AND   00650002
*                        2260S SUPPORTED BY GPS.                        00700002
*                                                                       00750002
*                        THIS INCLUDES:                                 00800002
*                          1. NORMAL TERMINATION: DELETE ANY ATTENTION  00850002
*                             ROUTINES STILL ACTIVE BY ISSUING GPS      00900002
*                             MACRO DAR FOR ACTIVE TEB/REB CHAINS (DONE 00950002
*                             IN EARLIER RELEASES BY MODULE IFFGRTTR)   01000002
*                                                                       01050002
*                                                                       01100002
*                          2. ABNORMAL TERMINATION:                     01150002
*                                                                       01200002
*                            A. RECOVER THE UCB SO IT IS AVAILABLE FOR  01250002
*                               REALLOCATION (DONE IN EARLIER RELEASES  01300002
*                               BY THE FORCED CLOSE ABEND MACRO         01350002
*                               IGGIFF01) THE FIELDS RESET ARE:         01400002
*                                GCB   ZEROED SO ATTENTIONS ARE IGNORED 01450002
*                                OPEN  ZEROED TO INDICATE NO DCBS OPEN  01500002
*                                TEB   ZEROED TO PREVENT USING BAD CBS  01550002
*                                                                       01600002
*                            B. RELEASE 2250 ALLOCATED BUFFER FOR       01650002
*                               DEVICES ASSIGNED TO THE ABENDING MEMORY 01700002
*                                                                       01750002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 01800002
         EJECT                                                          01850002
*********************************************************************** 01900002
*                                                                       01950002
* NOTES:                                                                02000002
*                                                                       02050002
*     DEPENDENCIES:      NORMAL TERMINATION: USER MEMORY ADDRESSABILITY 02100002
*                        ABNORMAL TERMINATIONS:                         02150002
*                          GRAPHIC DEVICES ARE NOT SHARABLE; THUS:      02200002
*                          1. TERMINATION ASSUMES THE PRIMARY GOAL IS   02250002
*                             SUCCESSFUL REALLOCATION OF THE DEVICES    02300002
*                          2. LOCAL LOCK IS NOT NEEDED FOR UCB RESETS   02350002
*                                                                       02400002
*     RESTRICTION:       NONE                                           02450002
*                                                                       02500002
*     RESISTERS:         SEE EQUATE DEFINITIONS FOLLOWING PROLOG        02550002
*                                                                       02600002
*     PATCH LABEL:       PATCH, A 50 BYTE DC AREA AT END OF MODULE      02650002
*                                                                       02700002
* MODULE TYPE:           EXECUTABLE CODE                                02750002
*                                                                       02800002
*    PROCESSOR:          ASSEMBLER XF                                   02850002
*                                                                       02900002
*    MODULE SIZE:        SEE PAGE 1 OF THIS LISTING                     02950002
*                                                                       03000002
*    ATTRIBUTES:                                                        03050002
*       AT ENTRY:        REENTRANT  ENABLED  SUPERVISOR STATE IN KEY 0  03100002
*                                                                       03150002
* ENTRY POINT:           IGG0203Z                                       03200002
*                                                                       03250002
*    PURPOSE:            SEE 'FUNCTION' HEADING ABOVE                   03300002
*                                                                       03350002
*    LINKAGE:            SEE 'INPUT', NEXT HEADING                      03400002
*                                                                       03450002
* INPUT:                 REGISTERS AS FOLLOWS:                          03500002
*                          1  ADDR OF: RMPL ADDRESS                     03550002
*                         13           SAVE AREA OF 18 WORDS            03600002
*                         14           RETURN ADDRESS TO TASK CLOSE     03650002
*                         15           IGG0203Z ENTRY POINT             03700002
*                                                                       03750002
* OUTPUT:                SEE 'FUNCTION' HEADING ABOVE                   03800002
*                                                                       03850002
* EXITS:                                                                03900002
*                                                                       03950002
*    NORMAL:             RETURN MACRO, RC=0                             04000002
*                                                                       04050002
*    ERROR:              NOT USED                                       04100002
*                                                                       04150002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 04200002
         EJECT                                                          04250002
*********************************************************************** 04300002
*                                                                       04350002
* EXTERNAL REFERENCES:                                                  04400002
*                                                                       04450002
*     ROUTINES:          NORMAL TERMINATION:  IGC0007D                  04500002
*                                                                       04550002
*     DATA AREAS:        SEE DSECT SECTION AT END OF LISTING            04600002
*                                                                       04650002
*     CONTROL BLOCKS:    SEE DSECT SECTION AT END OF LISTING            04700002
*                                                                       04750002
* TABLES:                NONE                                           04800002
*                                                                       04850002
* MACROS:                FREEMAIN  GETMAIN   SAVE   RETURN              04900002
*                                                                       04950002
* CHANGE ACTIVITY:       MODULE IS NEW FOR VS2/R2                       05000002
*                                                                       05050002
*********************************************************************** 05100002
         SPACE 2                                                        05150002
IGG0203Z CSECT                                                          05200002
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   05250002
*C106000-122000                                               LF YM8208 05300002
*D160000,A160100-160200                                      LG Z30AALG 05310000
*C160500-161500,A196096                                     LG @ZM30151 05312000
*C167000,C168000,A195500-195920                             L5 @ZA02832 05314000
*A161100-161200                                             L5 @ZA03950 05316000
*A114700-114900,A373400                                     D11 ZA11330 05318000
*A283700-283800                                             D11 ZA10028 05319000
*                                                                       05320000
         EJECT                                                          05350002
*********************************************************************** 05400002
*                                                                     * 05450002
*                        REGISTER ASSIGNMENTS                         * 05500002
*                                                                     * 05550002
*********************************************************************** 05600002
         SPACE 2                                                        05650002
RSIZE    EQU   0     TEMPORARY:         GETMAIN SIZES                   05700002
RADR     EQU   1                        ADDRESS WORK REGISTER           06100002
RCALC    EQU   1                        CALCULATIONS                    06110002
RCODE    EQU   15                       RETURN CODE                     06120002
         SPACE                                                          06130002
RBASE    EQU   2     CONVENTIONS:       BASE REGISTER                   06150002
         SPACE                                                          06160002
RDEV     EQU   4     CALCULATIONS:      DEVICE INDEX NUMBER FROM UCB    06170002
RLOC     EQU   7                        LOCATION REG FOR INDEXING       06172002
         SPACE                                                          06180002
RRMPL    EQU   8     INPUT ADDRESS:     RESOURCE MGR PARAMETER LIST     06190002
         SPACE                                                          06192002
RBTAB    EQU   3     ADDRESSES:         BUFFER TABLE (FROM 2250 UCBS)   06200002
RDSAB    EQU   4                        DSAB  (FROM QDB & ACTIVE JSCB)  06202002
RENTRY   EQU   5                        CURRENT ENTRY IN TABLE          06250002
RLAST    EQU   6                        LAST ENTRY IN TABLE             06252002
RLIST    EQU   7                        INPUT PARAMETER LIST FOR DAR    06260002
RREB     EQU   9                        ROUTINE ENTRY BLOCK (UCB & TEB) 06550002
RTEB     EQU   10                       TASK ENTRY BLOCK (FROM UCB)     06600002
RTCB     EQU   11                       TCB IN CONTROL (CURRENT)        06650002
RUCB     EQU   12                       UCB                             06700002
RSAVE    EQU   13                       SAVE AREA OF CALLER             06750002
RSCB1    EQU   14                       TEMP SYS CB ADDRESSES           06800002
RSCB2    EQU   15                       TEMP SYS CB ADDRESSES           06810002
         EJECT                                                          06900002
*********************************************************************** 06950002
*                                                                     * 07000002
*                        EQUATES                                      * 07050002
*                                                                     * 07100002
*********************************************************************** 07150002
ZERO     EQU   0        DECIMAL/HEX NUMBERS FOR GENERAL USE             07200002
ONE      EQU   1                                                        07210002
TWO      EQU   2                                                        07250002
THREE    EQU   3                                                        07260002
SEVEN    EQU   7                                                        07300002
         SPACE                                                          07350002
DAR      EQU   74       SVC NUMBERS                                     07750002
         EJECT                                                          08500002
*********************************************************************** 08550002
*                                                                     * 08600002
*                        INITIALIZATION                               * 08650002
*                                                                     * 08700002
*         1. USING STATEMENTS IDENTIFY DSECT BASE REGISTERS           * 08750002
*         2. REGISTERS SAVED IN CALLER'S AREA                         * 08800002
*         3. BASE ESTABLISHED FOR ADDRESSABILITY OF MODULE            * 08850002
*         4. MODULE EYECATCHER ID FOR RELEASE LEVEL VERIFICATION      * 08900002
*                                                                     * 08950002
*********************************************************************** 09000002
         SPACE 2                                                        09050002
         USING CVT,RSCB1         CVT DSECT INITZ FROM LOC 16            09100002
         USING REB,RREB          STD DSECTS, KEY 0:  REB (SEE IGC0007C) 09150002
         USING RMPL,RRMPL                            RMPL (INPUT LIST)  09200002
         USING TEB,RTEB                              TEB                09250002
         USING TCB,RTCB                              TCB                09300002
         USING TIOENTRY,RENTRY                       TIOT               09350002
         USING UCB,RUCB                              UCB                09400002
         USING UCBCMEXT,RSCB2                        UCB EXTENSION      09450002
         SPACE                                                          09500002
         SAVE  (14,12)                                                  09550002
         BALR  RBASE,0                                                  09600002
         USING *,RBASE                                                  09650002
         B     *+24                                                     09700002
MODID    DC    C'IGG0203Z.VS2R2.75092'          MODULE EYECATCHER ID    09750000
         EJECT                                                          09800002
*********************************************************************** 09810002
*                                                                     * 09820002
*                        INITIALIZATION                               * 09830002
*                                                                     * 09840002
*         5. DETERMINE TYPE OF PROCESSING REQUIRED; THEN IF:          * 09842002
*                                                                     * 09844002
*              NORMAL TERMINATION:                                    * 09846002
*                1.  DAR ANY REBS ASSOCIATED WITH CURRENT TCB.        * 09848002
*                                                                     * 09848402
*              ABNORMAL TERMINATION:                                  * 09848802
*                1.  RESET 2250 BUFFER TABLE FOR REALLOCATION         * 09849202
*                2.  RESET UCB FIELDS  (OPEN, GCB, TEB)               * 09849602
*                                                                     * 09849702
*********************************************************************** 09849802
         L     RRMPL,ZERO(RADR)   GET RESOURCE MANAGER'S INPUT LIST     09850002
         TM    RMPLFLG1,RMPLTYPE    CHECK IF ABNORMAL TERMINATION       09900002
         BO    GTT0080                IF YES, RECOVER UCB AND BFR TAB   09950002
         CLI   RMPLASID+1,ONE     CHECK IF MASTER SCHEDULER MEMORY      10000002
         BE    GTT0010              IF YES, NOTHING TO DO               10050002
         L     RTCB,RMPLTCBA        IF NO, GET TCB ADR                  10100002
         LTR   RTCB,RTCB              IS A TCB AVAILABLE                10150002
         BZ    GTT0010                  IF NO, NOTHING TO DO            10160002
         SR    RSCB1,RSCB1                CLEAR FOR ICM INSTRUCTION     10200002
         ICM   RSCB1,SEVEN,TCBJSTCB+1   IF YES, SEE IF P/P TCB AVAIL:   10300002
         CR    RTCB,RSCB1             DOES CURRENT TCB = JOBSTEP TCB    10350002
         BNE   GTT0020                  IF NO, OK TO PROCESS            10400002
GTT0010  SR    RCODE,RCODE              IF YES, NOTHING TO PROCESS      10450002
         RETURN (14,12),T,RC=(15)                                       10500002
         EJECT                                                          10550002
*********************************************************************** 10560002
*                                                                     * 10570002
*                    NORMAL TASK TERMINATION                          * 10580002
*                                                                     * 10590002
*        1. SCAN DSAB CHAIN FOR GRAPHIC DD ENTRIES IN TIOT   LF YM8202* 10592002
*        2. VALIDATE TIOT UCBS ARE FOR GAM SUPPORTED DEVICES          * 10594002
*                                                                     * 10596002
*********************************************************************** 10598002
GTT0020  SR    RENTRY,RENTRY           CLEAR REGS FOR ICM INSTRUCTIONS  10600002
         SR    RDSAB,RDSAB                                              10650002
         SR    RUCB,RUCB                                                10700002
         ICM   RSCB1,SEVEN,TCBJSCBB    IS JSCB AVAILABLE                10750002
         BZ    GTT0010                    IF NO, NOTHING TO PROCESS     10800002
         USING IEZJSCB,RSCB1                                            10850002
         ICM   RSCB1,SEVEN,JSCBACT+1   IS ACTIVE JSCB AVAILABLE         10900002
         BZ    GTT0010                    IF NO, NOTHING TO PROCESS     10950002
         ICM   RSCB1,SEVEN,JSCDSABQ+1  IS QDB AVAILABLE                 11000002
         BZ    GTT0010                    IF NO, NOTHING TO PROCESS     11050002
         USING QDB,RSCB1                                                11100002
         ICM   RDSAB,SEVEN,QDBFELMP+1  IS DSAB AVAILABLE                11150002
         BZ    GTT0010                    IF NO, NOTHING TO PROCESS     11200002
         USING DSAB,RDSAB                                               11250002
GTT0030  ICM   RENTRY,SEVEN,DSABTIOT+1 IS TIOT AVAILABLE                11400002
         BZ    GTT0040                    IF NO, CHECK IF MORE DSABS    11450002
         TM    TIOESTTA,DYNALLOC   IS/WAS IT DYNAMICALLOC?  D11 ZA11330 11460000
         BO    GTT0040             YES,GO SEE IF MORE DSABS D11 ZA11330 11470000
         ICM   RUCB,SEVEN,TIOESTTB+1   IS UCB AVAILABLE                 11500002
         BZ    GTT0040                    IF NO, CHECK IF MORE DSABS    11550002
         CLI   UCBID,UCBSTND           CHECK IF SUBUCB          SA15459 11600002
         BNE   GTT0040                    IF YES, NOT GRAPHIC   SA15459 11650002
         CLI   UCBTBYT3,UCB3DISP       CHECK IF A GRAPHICS DEVICE       11700002
         BNE   GTT0040                    IF NO, CHECK IF MORE DSABS    11750002
         CLI   UCBTBYT4,UCBT2250       IS DEVICE 2250 TYPE              11800002
         BE    GTT0050                    IF YES,  OK TO PROCESS        11850002
         CLI   UCBTBYT4,UCBT2260       IS DEVICE 2260 TYPE              11900002
         BE    GTT0050                    IF YES, OK TO PROCESS         11950002
         CLI   UCBTBYT4,UCBT1053       IS DEVICE 1053                   12000002
         BE    GTT0050                    IF YES, OK TO PROCESS         12050002
GTT0040  ICM   RDSAB,SEVEN,DSABFCHN+1  CHECK IF MORE DSABS              12100002
         BZ    GTT0010                    IF NO, NOTHING TO PROCESS     12150002
         B     GTT0030                    IF YES, CHECK FOR TIOT        12200002
         EJECT                                                          12250002
*********************************************************************** 13100002
*                                                                     * 13150002
*                    NORMAL TASK TERMINATION                          * 13200002
*                                                                     * 13250002
*         3. DAR ANY REB ASSOCIATED WITH CURRENT TCB                  * 13300002
*                                                                     * 13350002
*********************************************************************** 13400002
GTT0050  SR    RTEB,RTEB                    (CLEAR FOR ICM INSTRUCTION) 13500002
         ICM   RTEB,SEVEN,UCBTEB+1    IS TEB AVAILABLE                  13550002
         BZ    GTT0040                 IF NO, CHECK IF MORE DSABS       13600002
         SR    RREB,RREB                    (CLEAR FOR ICM INSTRUCTION) 13800002
         ICM   RREB,SEVEN,TEBREB+1    IS REB AVAILABLE                  13850002
         BZ    GTT0040                 IF NO, CHECK IF MORE DSABS       13900002
         SR    RADR,RADR                    (CLEAR FOR ICM INSTRUCTION) 13950002
GTT0060  ICM   RADR,SEVEN,REBTCB+1                                      14150002
         CR    RADR,RTCB               IF YES, IS REB TCB = CURRENT TCB 14250002
         BE    GTT0070                   IF YES, OK TO DEACTIVATE       14300002
         ICM   RREB,SEVEN,REBL+1         IF NO, ARE MORE REBS AVAILABLE 14350002
         BZ    GTT0040                     IF NO, CHECK IF MORE DSABS   14450002
         B     GTT0060                     IF YES, CHECK FOR TCB MATCH  14500002
GTT0070  L     RSIZE,DARPLIST         GET SAVE/WORK AREA FOR DAR USE    14750002
         GETMAIN R,LV=(0)                                               14800002
         L     RLIST,REBGACB          SET UP PLIST FOR DAR              14850002
         ST    RLIST,ADR(RADR)          1. ADDRESS OF GACB              14900002
         LA    RLIST,TWO                                                14950002
         ST    RLIST,ZERO(RADR)         2. LENGTH OF PLIST IN WORDS     15000002
         L     RREB,REBL              KEEP NEXT REB ADR (IF ANY)        15050002
         LR    RLIST,RADR             SAVE ADDR FOR FREEMAIN            15100002
         SVC   DAR                    ISSUE DAR  SVC                    15150002
         LR    RADR,RLIST             FREE PLIST AREA                   15200002
         L     RSIZE,DARPLIST                                           15250002
         FREEMAIN R,LV=(0),A=(1)                                        15300002
         LTR   RREB,RREB              ANY MORE REBS ON THIS TEB         15350002
         BZ    GTT0040                 IF NO, CHECK IF MORE DSABS       15400002
         B     GTT0060                 IF YES, CHECK FOR TCB MATCH      15450002
         EJECT                                                          15650002
*********************************************************************** 15660002
*                                                                     * 15670002
*                  ABNORMAL TASK TERMINATION                          * 15680002
*                                                                     * 15690002
*         1. SCAN LOOKUP TABLE UCBS FOR GAM SUPPORTED DEVICES         * 15692002
*                                                                     * 15694002
*********************************************************************** 15696002
GTT0080  EQU   *                                                        15700002
         USING CVT,RSCB1                                                15750002
         L     RSCB1,CVTPTR           GET CVT ADDR: FIXED LOCATION 16   15800002
         L     RSCB1,CVTILK2          GET UCB LOOKUP TABLE ADDR         15850002
         DROP  RSCB1                                                    15900002
GTT0090  EQU   *                                                        15950002
         SR    RUCB,RUCB               CLEAR REGISTER        LG Z30AALG 16010000
         ICM   RUCB,THREE,ZERO(RSCB1)  GET 1'ST ENTRY        LG Z30AALG 16020000
         C     RUCB,TBLEND            END OF LOOKUP TABLE?  LG @ZM30151 16050000
         BE    GTT0010                YES,NOTHING TO DO.    LG @ZM30151 16100000
         LTR   RUCB,RUCB           IS ENTRY 0?              L5 @ZA03950 16110000
         BZ    GTT0100             YES,GET NEXT ENTRY       L5 @ZA03950 16120000
         B     GTT0110                CK IF GRAPHICS DEVICE LG @ZM30151 16150000
GTT0100  EQU   *                                                        16200002
         LA    RSCB1,TWO(RSCB1)       ADJUST TO NEXT ENTRY              16250002
         B     GTT0090                   CONTINUE SCANNING              16300002
GTT0110  EQU   *                                                        16350002
         L     RSCB2,UCBEXTPT         GET UCB EXTENTION ADDRESS         16400002
         CLC   UCBASID,RMPLASID       DO MEMORIES MATCH                 16450002
         BNE   GTT0100                   IF NO, CONTINUE SEARCH         16500002
         CLI   UCBTBYT3,UCB3DISP      CHECK IF GRAPHIC UCB              16550002
         BNE   GTT0100                   IF NO, CONTINUE SEARCH         16600002
         CLI   UCBTBYT4,UCBT1053         IF YES, CK IF GRAPHIC DEVICE   16650002
         BE    GTT0113                 IF YES, RESET UCB    L5 @ZA02832 16700000
         CLI   UCBTBYT4,UCBT2260                                        16750002
         BE    GTT0113                                      L5 @ZA02832 16800000
         CLI   UCBTBYT4,UCBT2250                                        16850002
         BNE   GTT0100                     IF NO, CONTINUE SEARCH       16900002
         EJECT                                                          17000002
*********************************************************************** 17087902
*                                                                     * 17137902
*                  ABNORMAL TASK TERMINATION                          * 17187902
*                                                                     * 17237902
*         2. FOR 2250S, RESET BUFFER TABLE FOR REALLOCATION           * 17287902
*                                                                     * 17297902
*********************************************************************** 17299902
         USING BUFTAB,RBTAB       ESTABLISH UCB BUFFER TABLE ADDRESSING 17349902
GTT0113  TM    RMPLFLG1,RMPLTERM   MEM TERM?                L5 @ZA02832 17359900
         BZ    GTT0165             NO,CHK TCB TERM          L5 @ZA02832 17369900
GTT0115  CLI   UCBTBYT4,UCBT2250   2250?                    L5 @ZA02832 17379900
         BNE   GTT0160             NO,PURGE UCB             L5 @ZA02832 17389900
*                                  YES,RESET BUFFER TABLE   L5 @ZA02832 17391900
*                                  BEFORE PURGE             L5 @ZA02832 17393900
         SR    RBTAB,RBTAB        CLEAR FOR ICM INSTRUCTION             17399902
         ICM   RBTAB,SEVEN,UCBBTB      IS BUFFER TABLE AVAILABLE        17449902
         BZ    GTT0160                   IF NO, SKIP BUFFER RESET CODE  17499902
         SR    RDEV,RDEV                 IF YES, RESET FOR THIS UCB     17549902
         IC    RDEV,UCBDI              GET DEVICE INDEX NUMBER FOR BT   17599902
         LR    RLOC,RDEV               CALC DEVICE DISPLACEMENT INTO BT 17649902
         BCTR  RLOC,ZERO                 REDUCE DEVICE NBR BY ONE &     17699902
         SLL   RLOC,THREE                MULTIPLY BY EIGHT BYTES        17749902
         LH    RCALC,BTDVAS(RLOC)      GET SECTIONS ASSIGNED TO DEVICE  17799902
         AH    RCALC,BTTOTAVL            MAKE SECTIONS AVAIL FOR REUSE  17849902
         STH   RCALC,BTTOTAVL                                           17899902
         SR    RCALC,RCALC             INDICATE NO SECTIONS ASSIGNED TO 17949902
         STH   RCALC,BTDVAS(RLOC)        THIS DEVICE                    17999902
         LH    RLAST,BTTOTSEC          GET TOTAL NUMBER OF SECTIONS     18049902
         TM    UCBTBYT1,UCBTMOD3       IS DEVICE A 2250-3               18099902
         BO    GTT0120                   IF YES, BT HAS 40 BYTE HEADER  18149902
         LA    RENTRY,BTASGMT1           IF NO,  BT HAS 16 BYTE HEADER  18199902
         B     GTT0130                 PREPARE FOR BT SCAN OF ASGMENTS  18249902
GTT0120  LA    RENTRY,BTASGMT3         GET ADDR OF FIRST ENTRY, 2250-3  18349902
GTT0130  AR    RLAST,RENTRY            CALC LAST ENTRY ADDR             18399902
GTT0140  EX    RDEV,ASSIGNED           IS SECTION ASSIGNED TO THIS UCB  18449902
         BNE   GTT0150                   IF NO, DO NOT FREE SECTION     18499902
         MVI   ZERO(RENTRY),ZERO         IF YES, FREE BY RESET TO ZERO  18549902
GTT0150  LA    RENTRY,ONE(RENTRY)      ADJUST TO NEXT ENTRY ADDRESS     18599902
         CR    RENTRY,RLAST            IS LAST ENTRY PROCESSED          18649902
         BNH   GTT0140                   IF NO, REPEAT SCANNING         18699902
         DROP  RBTAB                                                    18749902
         EJECT                                                          19000002
*********************************************************************** 19050002
*                                                                     * 19100002
*                  ABNORMAL TASK TERMINATION                          * 19110002
*                                                                     * 19120002
*          3.  RESET UCB FIELDS:  OPEN, GCB, TEB                      * 19150002
*                                                                     * 19200002
*********************************************************************** 19250002
GTT0160  EQU   *                                                        19300002
         SR    RADR,RADR       GET ZEROS TO REINITIALIZE:               19350002
         STH   RADR,UCBOPEN       DCBS OPEN COUNT AND GCB               19400002
         ST    RADR,UCBTEB        TEB TO DEACTIVATE ATTN HANDLING       19450002
         B     GTT0100         GET NEXT UCB FOR PROCESSING              19500002
GTT0165  SR    RTEB,RTEB           CLR TEB REG              L5 @ZA02832 19550000
         ICM   RTEB,SEVEN,UCBTEB+1  GET TEB ADDR            L5 @ZA02832 19560000
         BZ    GTT0100              NO TEB, GET NEXT UCB    L5 @ZA02832 19570000
         CLC   TEBTCB+1(THREE),RMPLTCBA+1  TEBTCB=ABEND TCB?   @ZA02832 19580000
         BNE   GTT0100             NO,GET NEXT UCB          L5 @ZA02832 19590000
         B     GTT0115                                      L5 @ZA02832 19592000
         EJECT                                                          19600002
**********************************************************************  19602002
*                                                                    *  19604002
*                           CONSTANTS                                *  19606002
*                                                                    *  19608002
**********************************************************************  19608402
         DS    0F                                                       19608802
DARPLIST DC    X'FF000040'        SUBPOOL/SIZE FOR GETMAIN    LI SM1709 19609202
TBLEND   DC    X'0000FFFF'        LOOKUP TBL END INDICATOR  LG @ZM30151 19609600
ASSIGNED CLI   ZERO(RENTRY),ZERO  COMPARE UCBDI WITH BT ENTRY           19610000
         SPACE 5                                                        19620002
**********************************************************************  19650002
*                                                                    *  19700002
*                SPECIAL MAINTENANCE PATCH AREA FOR FIELD USE        *  19750002
*                                                                    *  19800002
**********************************************************************  19850002
PATCH    DS    0F                  50 BYTE PATCH AREA       D11         19900000
         DC    50X'FF'                                      D11         19950000
         TITLE 'GRAPHICS TASK RECOVERY SECTION'                         20000002
*********************************************************************** 20050002
*                                                                       20100002
* MODULE NAME:           IGG0213Z (OS/VS2)                              20150002
*                                                                       20200002
* DESCRIPTIVE NAME:      GRAPHICS TASK RECOVERY                         20250002
*                                                                       20300002
* COPYRIGHT:             NONE                                           20350002
*                                                                       20400002
* STATUS:                RELEASE 2.0                                    20450002
*                                                                       20500002
* FUNCTION:              THIS MODULE PERFORMS TASK RECOVERY FUNCTIONS   20550002
*                        FOR THE 2250S AND 2260S SUPPORTED BY GPS WHEN  20600002
*                        OPEN/CLOSE ABENDS.                             20650002
*                                                                       20700002
*                        THIS INCLUDES:                                 20750002
*                          1. RECOVER THE UCB SO IT IS AVAILABLE FOR    20800002
*                             REALLOCATION (DONE IN EARLIER RELEASES    20850002
*                             BY THE FORCED CLOSE ABEND MACRO IGGIFF01) 20900002
*                             THE FIELDS RESET ARE:                     20950002
*                                GCB   ZEROED SO ATTENTIONS ARE IGNORED 21000002
*                                OPEN  ZEROED TO INDICATE NO DCBS OPEN  21050002
*                                TEB   ZEROED TO PREVENT USING BAD CBS  21100002
*                                                                       21150002
*                          2. RESTORE CONTROL BLOCKS TO PREOPEN STATUS  21200002
*                             IF POSSIBLE, USING INFO ONLY IN PROTECTED 21250002
*                             STORAGE TO HELP SUCCESSFUL RECOVERY.      21300002
*                                A. RELEASE 2250 ALLOCATED BUFFER       21350002
*                                B. DEACTIVATE EXPRESS USER POLL LIST   21400002
*                                                                       21450002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 21500002
         EJECT                                                          21550002
*********************************************************************** 21600002
* NOTES:                                                                21650002
*                                                                       21700002
*     DEPENDENCIES:      KEY 5 CONTROL IS RECEIVED FROM SYSTEM OPEN.    21750002
*                        USER DCB ADDRESS, KEY AVAIL FROM SYS WORKAREA. 21800002
*                        GRAPHIC DEVICES ARE NOT SHARABLE; THUS:        21850002
*                          1. RECOVERY ASSUMES SUCCESSFUL REALLOCATION  21900002
*                             IS THE PRIMARY GOAL                       21950002
*                          2. LOCAL LOCK IS NOT NEEDED FOR UCB RESETS   22000002
*                        SYSTEM CLOSE RESTORES DCB TO PREOPEN STATUS    22050002
*                          AND FREES DEB.                               22100002
*                                                                       22150002
*     RESTRICTION:       NONE                                           22200002
*                                                                       22250002
*     RESISTERS:         SEE EQUATE DEFINITIONS FOLLOWING PROLOG        22300002
*                                                                       22350002
*     PATCH LABEL:       PATCH1, A 50 BYTE DC AREA AT END OF MODULE     22400002
*                                                                       22450002
* MODULE TYPE:           EXECUTABLE CODE                                22500002
*                                                                       22550002
*    PROCESSOR:          ASSEMBLER XF                                   22600002
*                                                                       22650002
*    MODULE SIZE:        SEE PAGE 1 OF THIS LISTING                     22700002
*                                                                       22750002
*    ATTRIBUTES:                                                        22800002
*       AT ENTRY:        REENTRANT  ENABLED  SUPERVISOR STATE IN KEY 5  22850002
*       ASSUMED KEYS:    0, USER (AS RECORDED IN SYSTEM OPEN WORKAREA)  22900002
*                                                                       22950002
* ENTRY POINT:           IGG0213Z                                       23000002
*                                                                       23050002
*    PURPOSE:            SEE 'FUNCTION' HEADING ABOVE                   23100002
*                                                                       23150002
*    LINKAGE:            SEE 'INPUT', NEXT HEADING                      23200002
*                                                                       23250002
* INPUT:                 REGISTERS AS FOLLOWS:                          23300002
*                          2 ADDR OF: COPIED DCB IN WORK AREA           23350002
*                          4          WORK AREA                         23400002
*                          9          TIOT DD ENTRY, OR ZEROS           23450002
*                         11          DEB FOR DCB, OR ZEROS             23500002
*                         13          SAVE AREA OF 18 WORDS             23550002
*                         14          RETURN ADDRESS TO TASK RECOVERY   23600002
*                         15          IGG0213Z ENTRY POINT              23650002
*                                                                       23700002
* OUTPUT:                SEE 'FUNCTION' HEADING ABOVE                   23750002
*                                                                       23800002
******************* PROLOGUE*CONTINUED*NEXT*PAGE ********************** 23850002
         EJECT                                                          23900002
*********************************************************************** 23950002
* EXITS:                                                                24000002
*                                                                       24050002
*    NORMAL:             RETURN MACRO, RC=0                             24100002
*                                                                       24150002
*    ERROR:              RETURN MACRO, RC=4  NO RETRY                   24200002
*                                                                       24250002
*                                                                       24300002
* EXTERNAL REFERENCES:                                                  24350002
*                                                                       24400002
*     ROUTINES:          NONE                                           24450002
*                                                                       24500002
*     DATA AREAS:        SEE DSECT SECTION AT END OF LISTING            24550002
*                                                                       24600002
*     CONTROL BLOCKS:    SEE DSECT SECTION AT END OF LISTING            24650002
*                                                                       24700002
* TABLES:                NONE                                           24750002
*                                                                       24800002
* MACROS:                MODESET     SAVE       RESTORE                 24850002
*                                                                       24900002
* CHANGE ACTIVITY:       MODULE IS NEW FOR VS2/R2                       24950002
*                                                                       25000002
*********************************************************************** 25050002
         SPACE 3                                                        25100002
IGG0213Z CSECT                                                          25150002
         EJECT                                                          25200002
*********************************************************************** 25250002
*                                                                     * 25300002
*                 ADDITIONAL REGISTERS FOR IGG0213Z                   * 25350002
*                                                                     * 25400002
*********************************************************************** 25450002
RDCB     EQU   3          ADDR OF:     DCB BEING FORCED CLOSED          25500002
RCORE    EQU   4                       WORK AREA USED BY OPEN/CLOSE     25550002
REXT     EQU   5                       NUMBER OF EXTENTS (UCBS)         25600002
RRRPL    EQU   8                       RECOVERY ROUTINE PARM LIST       25700002
RTIOT    EQU   9                       DD ENTRY IN TIOT BEING PROCESSED 25750002
RDEB     EQU   11                      DEB                              25800002
RBACK    EQU   15                      NSI FOR SUBRTN RETURN            25850002
         SPACE 3                                                        25900002
*********************************************************************** 25950002
*                                                                     * 26000002
*                        EQUATES                                      * 26050002
*                                                                     * 26100002
*********************************************************************** 26150002
ADR      EQU   4                       INDEX FACTOR FOR ENTRIES         26200002
RC4      EQU   4                       RETURN CODE TO PREVENT RETRY     26250002
         EJECT                                                          26300002
*********************************************************************** 26350002
*                                                                     * 26400002
*                        INITIALIZATION                               * 26450002
*                                                                     * 26500002
*         1. USING STATEMENTS IDENTIFY DSECT BASE REGISTERS           * 26550002
*         2. REGISTERS SAVED IN CALLER'S AREA                         * 26600002
*         3. BASE ESTABLISHED FOR ADDRESSABILITY OF MODULE            * 26650002
*                                                                     * 26700002
*********************************************************************** 26750002
         USING IHADCB,RDCB                                              26800002
         USING FORCORE,RCORE                                            26850002
         USING IECRRPL,RRRPL                                            26900002
         USING DEBBASIC,RDEB                                            26950002
         USING TIOENTRY,RTIOT                                           27000002
         SAVE  (14,12)                                                  27050002
         LR    RDCB,RBASE     KEEP GAM OPEN/CLOSE CONVENTIONAL SETUPS   27100002
         BALR  RBASE,0                                                  27150002
         USING *,RBASE                                                  27200002
         EJECT                                                          27250002
*********************************************************************** 27300002
*                                                                     * 27350002
*                  CHECK FOR VALID INPUT TO PROCESS                   * 27400002
*                                                                     * 27450002
*          1.  TRY TO VERIFY UCBS ARE FOR 2250, 2260 OR 1053          * 27500002
*               A. USE TIOT AS SAFEST SOURCE OF INFO SINCE            * 27550002
*                  OPEN MAY HAVE ABENDED BEFORE DEB COMPLETED         * 27600002
*               B. USE DEB AS SECOND CHOICE FOR UCB INFO              * 27650002
*           2. IF GRAPHICS DEVICES CAN NOT BE VALIDATED:              * 27700002
*               A. USE RC=4+ TO PREVENT RETRIES FOR GAM               * 27750002
*               B. CK DCB AND DEACTIVATE POLL LIST IF A GAM           * 27800002
*                  DCB CAN BE VALIDATED.                              * 27850002
*                                                                     * 27900002
*********************************************************************** 27950002
         MODESET EXTKEY=ZERO                                            28000002
         LTR   RTIOT,RTIOT       IS A TIOT DD ENTRY AVAILABLE           28050002
         BZ    DEBCK               IF NO, CHECK FOR A DEB               28100002
         SR    REXT,REXT             CLEAR REG FOR LGH INSERT           28150002
TIOTOK   EQU   *                                                        28200002
         IC    REXT,TIOELNGH         GET LGH OF ENTRY TO CALC # OF UCBS 28250002
         LTR   REXT,REXT                IS THERE A DD ENTRY             28300002
         BZ    DEBCK                     IF NO, TRY TO USE DEB          28350002
         TM    TIOESTTA,DYNALLOC   THIS A DYNAMIC ENTRY?    D11 ZA10028 28360000
         BO    DEBCK               YES,NOGOOD,USE DEB       D11 ZA10028 28370000
         LA    RLOC,TIOESTTB             GET ADDR OF UCB DEVICE ENTRIES 28400002
         AR    RTIOT,REXT            ADJUST TO NEXT DD ENTRY            28450002
         SH    REXT,SIXTEEN              IF YES, CALC # ENTRIES         28500002
         BNP   DEBCK                        IF NEGATIVE, NO ENTRIES     28550002
         SRL   REXT,TWO                     IF POSITIVE, 4 BYTES/ENTRY  28600002
         BAL   RBACK,RESETUCB            CLEAR UCB FIELDS               28650002
         B     TIOTOK            CONTINUE WITH NEXT DD ENTRY            28700002
         EJECT                                                          28750002
*********************************************************************** 28800002
*                                                                     * 28850002
*                DEB USED AS SECOND CHOICE FOR UCB RESET INFO         * 28900002
*                                                                     * 28950002
*********************************************************************** 29000002
DEBCK    EQU   *                                                        29050002
         LTR   RDEB,RDEB       IS THERE A DEB                           29100002
         BZ    DCBCK             IF NO, CHECK IF A GAM DCB IS AVAILABLE 29150002
         SR    REXT,REXT         IF YES, CLEAR FOR NBR OF UCBS          29200002
         LA    RLOC,DEBSUCBA       GET ADDR OF UCB ENTRIES              29250002
         IC    REXT,DEBNMEXT       GET NBR OF UCBS                      29300002
         BAL   RBACK,RESETUCB     CLEAR UCB FIELDS                      29350002
         EJECT                                                          29400002
*********************************************************************** 29450002
*                                                                     * 29500002
*               DEACTIVATE POLL LIST OF DCBS IF:                      * 29550002
*                 1. DCB BEING RECOVERED IS FOR GRAPHICS              * 29600002
*                 2. EXPRESS ATTENTION HANDLING BEING USED            * 29650002
*                                                                     * 29700002
*           NOTE:  POLL LIST PROCESSING DONE IN USER'S KEY            * 29750002
*                                                                     * 29800002
*********************************************************************** 29850002
DCBCK    EQU   *                                                        29900002
         CLI   DCBDSRG2,DCBDSGGS     CK IF DCB IS GRAPHICS              29950002
         BE    DCBOK                    IF YES, OK TO CHECK POLL LIST   30000002
         LA    RCODE,RC4                IF NO, RETURN WITH RC, NO RETRY 30050002
         B     RETURN                                                   30100002
DCBOK    EQU   *                                                        30150002
         L     RADR,DCBPOLST         CK IF POLL LIST IS AVAILABLE       30200002
         LTR   RADR,RADR                IF NO, PROCESSING DONE          30250002
         BZ    DONE                                                     30300002
         CLI   DCBGTYPE,DCBGTEXP        IF YES, MUST BE EXPRESS         30350002
         BNE   DONE                        IF NOT, DON'T ZERO           30400002
         MODESET  KEYADDR=DXUKEY,WORKREG=15                             30450002
         SR    RLIST,RLIST              GET SOURCE OF ZEROS             30500002
         ST    RLIST,ZERO(RADR)         ZERO POLL LIST ACTIVE ENTRY     30550002
         MODESET  EXTKEY=DATAMGT                                        30600002
DONE     EQU   *                                                        30650002
         SR    RCODE,RCODE             INDICATE PROCESSING COMPLETED    30700002
RETURN   EQU   *                                                        30750002
         MODESET EXTKEY=DATAMGT                                         30800002
         RETURN (14,12),T,RC=(15)                                       30850002
         EJECT                                                          30900002
*********************************************************************** 30950002
*                                                                     * 31000002
*            RESET UCB FIELDS    (INTERNAL SUBROUTINE)                * 31050002
*                                                                     * 31100002
*        SEE PROLOG FUNCTION DESCRIPTION FOR DETAILS OF FIELDS        * 31150002
*                                                                     * 31200002
*********************************************************************** 31250002
RESETUCB EQU   *                                                        31300002
         L     RUCB,ZERO(RLOC)    LOAD FIRST/NEXT UCB ADDRESS           31350002
         CLI   UCBID,UCBSTND      CHECK FOR UCB VALIDITY                31400002
         BNE   NEXTUCB               IF INVALID, GET NEXT UCB           31450002
         CLI   UCBTBYT3,UCB3DISP     IS DEVICE GRAPHICS TYPE            31500002
         BNE   NEXTUCB                 IF NO, GET NEXT UCB              31550002
         CLI   UCBTBYT4,UCBT1053     IS DEVICE 1053 TYPE                31600002
         BE    UCBOK                   IF YES,  OK TO PROCESS           31650002
         CLI   UCBTBYT4,UCBT2260     IS DEVICE 2260 TYPE                31700002
         BE    UCBOK                   IF YES,  OK TO PROCESS           31750002
         CLI   UCBTBYT4,UCBT2250     IS DEVICE 2250 TYPE                31800002
         BNE   NEXTUCB                 IF NO, GET NEXT UCB              31850002
UCBOK    EQU   *                                                        31900002
         SR    RADR,RADR          GET SOURCE OF ZEROS                   31950002
         STH   RADR,UCBOPEN        RESET COUNTER AND CLEAR GCB          32000002
         ST    RADR,UCBTEB         PREVENT USE OF BAD CBS               32050002
NEXTUCB  EQU   *                                                        32100002
         LA    RLOC,ADR(RLOC)     ADJUST ADDR TO NEXT ENTRY             32150002
         BCT   REXT,RESETUCB       GET NEXT UCB ENTRY                   32200002
         BR    RBACK               RETURN FOR CONTINUED PROCESSING      32250002
SIXTEEN  DC    H'16'                                                    32300002
         SPACE 3                                                        32350002
**********************************************************************  32400002
*                                                                    *  32450002
*                SPECIAL MAINTENANCE PATCH AREA FOR FIELD USE        *  32500002
*                                                                    *  32550002
**********************************************************************  32600002
PATCH1   DS    0F         50 BYTE PATCH AREA.'              D11         32650000
         DC    50X'FF'                                      D11         32700000
         EJECT                                                          32750002
BUFTAB   DSECT                                                          32800002
*                                                                       32850002
BTTOTSEC DS    CL2  HEADER:  TOTAL NUMBER OF 256 BYTE SECTIONS          32900002
BTNUMDEV DS    CL2                           DEVICES SHARING BUFFER     32950002
BTEXPSIZ DS    CL2                           SECTIONS FOR EXPRESS       33000002
BTTOTAVL DS    CL2                           SECTIONS STILL AVAIL       33050002
*                                                                       33100002
BTDVAS   DS    CL2  DEVICES: CURRENT NBR OF SECTIONS ASGNED TO DEVICE   33150002
BTDVDZ   DS    CL2           DISPL INTO BT FOR THIS DEVICE'S ZONE       33200002
BTDVSZ   DS    CL2           NBR OF SECTIONS IN THIS DEVICE'S ZONE      33250002
BTDVGS   DS    CL2           NBR OF GUARANTEED SECTIONS FOR THIS DEVICE 33300002
*            START OF BUFFER ASSIGNMENTS FOR 2250-1S                    33350002
BTASGMT1 DS    CL56 ASGMT:   ASSIGNMENTS WILL CONTAIN DEVICE IDS        33400002
         SPACE 3                                                        33400102
         ORG   BTASGMT1                                                 33400402
*                                                                       33402002
BTDV2AS  DS    CL2  DEVICE2: CURRENT NBR OF SECTIONS ASGNED TO DEVICE   33404002
BTDV2DZ  DS    CL2           DISPL INTO BT FOR THIS DEVICE'S ZONE       33406002
BTDV2SZ  DS    CL2           NBR OF SECTIONS IN THIS DEVICE'S ZONE      33408002
BTDV2GS  DS    CL2           NBR OF GUARANTEED SECTIONS FOR THIS DEVICE 33408402
*                                                                       33408802
BTDV3AS  DS    CL2  DEVICE3: CURRENT NBR OF SECTIONS ASGNED TO DEVICE   33418802
BTDV3DZ  DS    CL2           DISPL INTO BT FOR THIS DEVICE'S ZONE       33428802
BTDV3SZ  DS    CL2           NBR OF SECTIONS IN THIS DEVICE'S ZONE      33438802
BTDV3GS  DS    CL2           NBR OF GUARANTEED SECTIONS FOR THIS DEVICE 33448802
*                                                                       33449202
BTDV4AS  DS    CL2  DEVICE4: CURRENT NBR OF SECTIONS ASGNED TO DEVICE   33449602
BTDV4DZ  DS    CL2           DISPL INTO BT FOR THIS DEVICE'S ZONE       33449702
BTDV4SZ  DS    CL2           NBR OF SECTIONS IN THIS DEVICE'S ZONE      33449802
BTDV4GS  DS    CL2           NBR OF GUARANTEED SECTIONS FOR THIS DEVICE 33449902
*            START OF BUFFER ASSIGNMENTS FOR 2250-3S                    33466602
BTASGMT3 DS    CL56 ASGMT:   ASSIGNMENTS WILL CONTAIN DEVICE IDS        33476602
         EJECT                                                          33483302
         CVT   DSECT=YES                                                33500002
         EJECT                                                          33550002
         DCBD  DSORG=GS                                                 33600002
         EJECT                                                          33650002
         IEZDEB                                                         33700002
         EJECT                                                          33750002
         IHADSAB                                                        33800002
         IECDSECS MAIN,EXPAND=YES                                       33850002
         IEZJSCB                                                        33900002
         EJECT                                                          33950002
         IHAQDB                                                         34000002
         EJECT                                                          34050002
*                  ROUTINE ENTRY BLOCK (REB)                            34100002
*                                                                       34150002
*       1.  CREATED BY USER WITH GRAPHICS SPAR MACRO                    34200002
*       2.  SEE SVC MODULE, IGC0007C FOR FURTHER DETAILS                34250002
*                                                                       34300002
REB      DSECT                                                          34350002
REBL     DS    F       ADDR OF:     NEXT LOWER PRIORITY REB, OR ZEROS   34400002
REBH     DS    F                     NEXT HIGHER PRIORITY REB, OR TEB   34450002
REBUCB   DS    F                     UCB, OR LIST OF UCBS               34500002
REBGACB  DS    F                     GACB                               34550002
REBGEIRB DS    F                     GEIR'S IRB                         34600002
REBFLGS  DS    H       FLAGS:                                           34650002
REBPRTY  DS    H                     PRIORTY INDICATED BY USER IN SPAR  34700002
REBQ1    DS    F       ADDR OF:      IQE TO BE PROCESSED IF EP=0        34750002
REBQ2    DS    F                     IQE NEXT TO BE PROCESSED           34800002
REBTCB   DS    F                     TCB                                34850002
REBRES   DS    F                     RESERVED                           34900002
         EJECT                                                          34950002
         IHARB                                                          35000002
         EJECT                                                          35050002
         IHARMPL                                                        35100002
         IECDSECS RRPL,EXPAND=YES                                       35150002
         IKJTCB DSECT=YES                                               35200002
         EJECT                                                          35250002
TEB      DSECT                                                          35300002
TEBCKRB  DS    F       ADDR OF:      IRB FOR CANCEL KEY (IFFCAN03)      35350002
TEBREB   DS    F                     GAM ROUTINE ENTRY BLOCK            35400002
TEBTCB   DS    F                     TCB                                35450002
TEBCKQE  DS    F                     LIST OF CANCEL KEY IQES            35500002
TEBUCBCT DS    F       USE COUNT:    NBR OF UCBS USING THIS TEB         35550002
TEBFLGS  DS    F       FLAG BYTES:                                      35600002
TEBFLAG  EQU   X'80'                 TEB ID FLAG                        35650002
TEBGARB  DS    F       ADDR OF:      IRB FOR GAR (IGG019OE)             35700002
TEBGEIR  DS    F                     ENTRY POINT FOR GEIR (IGG019OJ)    35750002
         EJECT                                                          35800002
TIOT     DSECT                                                          35850002
         IEFTIOT1                                                       35900002
         EJECT                                                          35950002
UCB      DSECT                                                          36000002
         IEFUCBOB                                                       36050002
**********************************************************************  36100002
*                                                                     * 36150002
*                    ADDITIONAL UCB EQUATES FOR DSECT                 * 36200002
*                                                                     * 36250002
*********************************************************************** 36300002
         SPACE 3                                                        36350002
*          UCBTYP, BYTE 1, BIT SETTINGS                                 36400002
         SPACE                                                          36450002
UCBTMOD3 EQU   X'33'           UNIT TYPE SETTING FOR 2250-3 MODEL       36500002
         SPACE 3                                                        36550002
*          UCBTYP, BYTE 2, BIT SETTINGS                                 36600002
         SPACE                                                          36650002
UCBTPFK  EQU   X'10'           UNIT TYPE BIT 3 FOR PFK FEATURE          36700002
         SPACE 3                                                        36750002
*          UCBTYP, BYTE 4, BIT SETTINGS                                 36800002
         SPACE                                                          36850002
UCBT2250 EQU   X'02'           UNIT TYPE ID FOR 2250 DEVICE             36900002
UCBT2260 EQU   X'03'                        FOR 2260                    36950002
UCBT1053 EQU   X'04'                        FOR 1053                    37000002
         SPACE 2                                                        37050002
*          UCBGCB, BIT SETTINGS                                         37100002
         SPACE                                                          37150002
UCBGINIT EQU   X'40'                   OK TO ACCEPT ATTNS NOW    A32068 37200002
UCBGBAS  EQU   X'08'                                                    37250002
UCBGSET  EQU   X'B7'                   RESET ABOVE BITS TO ZERO         37300002
*   END OF ADDITIONAL UCB BIT SETTINGS                      D11         37310000
DYNALLOC EQU   X'80'               TO TEST TIOTENTRY        D11 ZA11330 37320000
         END                                                            37350002
