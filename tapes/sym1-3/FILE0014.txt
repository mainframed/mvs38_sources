./  ADD  SSI=43530763,NAME=ICFBDF00
ICFBDF00 TITLE 'MCH APPENDAGE && DUMP ROUTINE FOR PWF'                  00100002
ICFBDE00 CSECT 0                                                        00150002
* MODULE NAME...                                                        00200002
*        ICFBDF00                                                       00250002
*                                                                       00300002
* FUNCTIONS...                                                          00350002
*         ICFBDF00 SERVES AS PART OF THE SOFTWARE SUPPORT FOR           00400002
*         THE POWER WARNING FEATURE. IT HAS THREE MAJOR SECTIONS:       00450002
*         THE APPENDAGE ROUTINE, THE USER ROUTINE, AND THE DUMP         00500002
*         ROUTINE. THE FUNCTIONS OF EACH ARE LISTED BELOW.              00550002
*          A. APPENDAGE ROUTINE                                         00600002
*             1. RECEIVE CONTROL FROM MCH VIA CALL                      00650002
*             2. DETERMINE WHETHER FUNCTION IS IMPLEMENTED.             00700002
*             3. DETERMINE WHETHER CONDITIONS WARRANT AN                00750002
*                IMMEDIATE DUMP.                                        00800002
*             4. DETERMINE IF THIS IS A TRANSIENT WARNING.              00850002
*             5. IF DUMP CONDITIONS DON'T EXIST, TO RETURN              00900002
*                TO THE MCH IN AN APPROPRIATE MANNER.                   00950002
*             6. IF DUMP CONDITIONS DO EXIST, TO GIVE CONTROL TO A      01000002
*                USER ROUTINE WHICH IS PHYSICALLY PART OF               01050002
*                THIS MODULE.                                           01100002
*             7. TO EXAMINE USER RETURN CODE, AND RETURN TO             01150002
*                MCH IF NECESSARY.                                      01200002
*             8. TO CLEAR PATHS TO THE DUMP DEVICES BY STOPPING         01250002
*                ALL I/O ACTIVITY ON EACH CHANNEL ON A PATH TO A        01300002
*                DUMP DEVICE.                                           01350002
*             9. TO GIVE CONTROL TO THE DUMP ROUTINE.                   01400002
*                                                                       01450002
*          B. USER ROUTINE                                              01500002
*             1. TO PROVIDE THE USER WITH A MEANS OF DOING              01550002
*                SOME HOUSE CLEANING BEFORE DUMPING, OR OF AVOIDING     01600002
*                DUMPING MEMORY.                                        01650002
*                                                                       01700002
*          C. DUMP ROUTINE                                              01750002
*             1. TO CREATE AN IMAGE OF STORAGE ON AN EXTERNAL           01800002
*                DIRECT ACCESS DEVICE.                                  01850002
*                ( SEE COMMENTS ON PAGE PRECEEDING LOCATION             01900002
*                LABELLED ICFBDE99)                                     01950002
*                                                                       02000002
*                                                                       02050002
* ATTRIBUTES...                                                         02100002
*        PERMANENTLY RESIDENT, SERIALLY REUSABLE, SUPERVISOR            02150002
*         MODE, AND USES PRIVILEGED INSTRUCTIONS.                       02200002
*                                                                       02250002
*                                                                       02300002
* ENTRY POINTS...                                                       02350002
*         ICFBDE00--ENTERED EITHER FROM MAIN LINE OF MCH BY             02400002
*                   A CALL, OR FROM THE UNEXPECTED ERROR                02450002
*                   HANDLER (SHUT) BY CALL.                             02500002
*                                                                       02550002
* EXITS...                                                              02600002
*                                                                       02650002
*       EXITS TO DISABLED WAIT STATE (CODE 26)...                       02700002
*         1. SUCCUSSFULCOMPLETION OF DUMP.                              02750002
*                                                                       02800002
*         EXITS TO DISABLED WAIT STATE (CODE 27)...                     02850002
*         1. MISSING INTERRUPT DURING I/O CLEAR ROUTINE IN THE          02900002
*            APPENDAGE.                                                 02950002
*         2. FAILURE TO COMPLETE DUMP ONCE DUMP WAS ENTERED.            03000002
*                                                                       03050002
*       EXIT TO THE MCH...                                              03100002
*       1. FUNCTION WAS NOT INITIALIZED (VIA BR 14).                    03150002
*       2. FUNCTION INOPERATIVE (VIA BR 14).                            03200002
*         3. TRANSIENT WARNING                                          03250002
*         4. USER RETURNED CODE OF 4                                    03300002
*                                                                       03350002
*                                                                       03400002
* INPUTS...                                                             03450002
*         A. FOR ENTRY VIA ICFBDE00                                     03500002
*          1. R0  HAS ENTRY CODE (0 FOR NORMAL ENTRY, 4 FROM SHUT)      03550002
*            2. R14 POINTS TO RETURN POINT                              03600002
*            3. R15 POINTS TO MY ENTRY POINT                            03650002
*            4. EC MODE                                                 03700002
*            5. MCIC (LOC XE8)                                          03750002
*                                                                       03800002
*                                                                       03850002
* OUTPUTS...                                                            03900002
*         1. FOR RETURN TO MCH, ENVIRONMENT IS RESTORED EXCEPT          03950002
*            FOR SOME NONESSENTIAL LOGOUT FIELDS.                       04000002
*          A. R15 = 0 IMPLIES CR14B7 SHOULD BE SET 0                    04050002
*          B. R15 = 4 IMPLIES CR14B7 SHOULD BE SET 1                    04100002
*         2. FOR USER ROUTINE, R15IS ITS ENTRY POINT, R14 IS            04150002
*            ITS RETURN ADDRESS, AND R13 POINTS TO A REGISTER           04200002
*            SAVE AREA.                                                 04250002
*         3. FOR DUMP ROUTINE, R13 HAS WORK AREA POINTER, R15           04300002
*            ITS ENTRY POINT, CR0BIT0=0,CR2=FFFFFFFF,CR14=              04350002
*            00000000, AND PSW IS DISABLED, SUPERVISOR MODE,            04400002
*            AND KEY ZERO.                                              04450002
*         4. MAINTAIN A FOOTPRINT TABLE, TRACKING CONTROL FLOW          04500002
*            THROUGH THE APPENDAGE.                                     04550002
*                                                                       04600002
*                                                                       04650002
* TABLES AND WORK AREAS                                                 04700002
*       PWF WORK AREA - MAPPED BY ICFWORK                               04750002
*                                                                       04800002
*                                                                       04850002
* REGISTER CONVENTIONS                                                  04900002
*          R9-- PWF WORK AREA POINTER                                   04950002
*          R10-- CVT BASE                                               05000002
*          R12-- ICFBDF00 BASE                                          05050002
*          R13-- SAVE AREA POINTER                                      05100002
*          R14-- RETURN ADDRESS                                         05150002
*          R15-- ENTRY ADDRESS (IF THROUGH ICFBDE00)                    05200002
*                                                                       05250002
*                                                                       05260003
* STATUS...                                                             05270003
*         APARS FIXED @ZA00508, @ZA00509, @ZA00510                      05280003
*                                                                       05290003
         EJECT                                                          05300002
CR1      EQU   1                                                        05350002
CR0      EQU   0                                                        05400002
CR2      EQU   2                                                        05450002
CR14     EQU   14                                                       05500002
CR15     EQU   15                                                       05550002
         SPACE 2                                                        05600002
R0       EQU   0                                                        05650002
R1       EQU   1                                                        05700002
R2       EQU   2                                                        05750002
R3       EQU   3                                                        05800002
R4       EQU   4                                                        05850002
R5       EQU   5                                                        05900002
R6       EQU   6                                                        05950002
R7       EQU   7                                                        06000002
R8       EQU   8                                                        06050002
R9       EQU   9                                                        06100002
R10      EQU   10                                                       06150002
R11      EQU   11                                                       06200002
R12      EQU   12                                                       06250002
R13      EQU   13                                                       06300002
R14      EQU   14                                                       06350002
R15      EQU   15                                                       06400002
W0       EQU   0                                                        06450002
W1       EQU   1                                                        06500002
W2       EQU   2                                                        06550002
W3       EQU   3                                                        06600002
W4       EQU   4                                                        06650002
W5       EQU   5                                                        06700002
W6       EQU   6                                                        06750002
W7       EQU   7                                                        06800002
W8       EQU   8                                                        06850002
         EJECT                                                          06900002
*        DECIMAL EQUATES                                                06950002
D0       EQU   0                                                        07000002
D1       EQU   1                                                        07050002
D2       EQU   2                                                        07100002
D3       EQU   3                                                        07150002
D4       EQU   4                                                        07200002
D5       EQU   5                                                        07250002
D6       EQU   6                                                        07300002
D7       EQU   7                                                        07350002
D8       EQU   8                                                        07400002
D9       EQU   9                                                        07450002
D10      EQU   10                                                       07500002
D12      EQU   12                                                       07550002
D13      EQU   13                                                       07600002
D16      EQU   16                                                       07650002
D20      EQU   20                                                       07700002
D24      EQU   24                                                       07750002
D23      EQU   23                                                       07800002
D26      EQU   26                                                       07850002
D27      EQU   27                                                       07900002
D28      EQU   28                                                       07950002
D232     EQU   232                                                      08000002
D244     EQU   244                 MCHAPNDG COMMON PTR DISPLACEMENT     08050002
D256     EQU   256                                                      08100002
D380     EQU   380                 CVT DISP OF WORK AREA PTR IN VS1     08150002
D488     EQU   488                                                      08200002
         EJECT                                                          08250002
*        HEXADECIMAL EQUATES                                            08300002
X00      EQU   X'00'                                                    08350002
X01      EQU   X'01'                                                    08400002
X02      EQU   X'02'                                                    08450002
X04      EQU   X'04'                                                    08500002
X08      EQU   X'08'                                                    08550002
X0C      EQU   X'0C'                                                    08600002
X0F      EQU   X'0F'                                                    08650002
X10      EQU   X'10'               CVTPTR ADDR                          08700002
X20      EQU   X'20'                                                    08750002
X22      EQU   X'22'                                                    08800002
X26      EQU   X'26'                                                    08850002
X27      EQU   X'27'                                                    08900002
X30      EQU   X'30'               MC OPSW LOC                          08950002
X3F      EQU   X'3F'                                                    09000002
X40      EQU   X'40'                                                    09050002
X50      EQU   X'50'                                                    09100002
X68      EQU   X'68'               PGM NPSW LOC                         09150002
X70      EQU   X'70'               MC NPSW LOC                          09200002
X72      EQU   X'72'                                                    09250002
X78      EQU   X'78'                                                    09300002
X7F      EQU   X'7F'                                                    09350002
X80      EQU   X'80'                                                    09400002
X88      EQU   X'88'                                                    09450002
X90      EQU   X'90'                                                    09500002
X98      EQU   X'98'                                                    09550002
XAF      EQU   X'AF'                                                    09600002
XBF      EQU   X'BF'                                                    09650002
XC0      EQU   X'C0'                                                    09700002
XD8      EQU   X'D8'               DISP OF CTLREGS IN MCHINLOG SV AREA  09750002
XE8      EQU   X'E8'               MCIC LOCATION                        09800002
XFD      EQU   X'FD'                                                    09850002
XFE      EQU   X'FE'                                                    09900002
XFF      EQU   X'FF'                                                    09950002
X100     EQU   X'100'                                                   10000002
X180     EQU   X'180'              DISP OF GPR SAVE AREA IN PSA         10050002
X1C0     EQU   X'1C0'              DISP OF CR SAVE AREA IN PSA          10100002
XA02     EQU   X'A02'                                                   10150002
XBFF     EQU   X'BFF'                                                   10200002
         EJECT                                                          10250002
*        MISCELLANEOUS EQUATES                                          10300002
CAW      EQU   X'48'                                                    10350002
CSW      EQU   X'40'                                                    10400002
EXOPSW   EQU   X'18'         EXTERNAL OLD PSW                           10450002
MCOPSW   EQU   X'30'                                                    10500002
IOOPSW   EQU   X'38'                                                    10550002
EXNPSW   EQU   X'58'         EXTERNAL NEW PSW                           10600002
PGNPSW   EQU   X'68'                                                    10650002
MCNPSW   EQU   X'70'                                                    10700002
IONPSW   EQU   X'78'                                                    10750002
MCIC     EQU   X'E8'                                                    10800002
SENSE    EQU   X'01'         EQUATE FOR SIGP SENSE CODE                 10850002
PRGRST   EQU   X'08'         EQUATE FOR SIGP PROGRAM RESET CODE         10900002
RESTART  EQU   X'06'         EQUATE FOR SIGP RESTART CODE               10950002
RC0      EQU   0                   NORMAL RETURN, TRANSIENT WARNING     11000002
RC4      EQU   4                   HARD CHECK W/ NO CONCURRENT WARNING  11050002
RC8      EQU   8                                                        11100002
RC12     EQU   12                                                       11150002
RC16     EQU   16                  FUNCTION INOPERATIVE                 11200002
         EJECT                                                          11250002
ICFBDE00 CSECT 0                                                        11300002
ICFTDE00 EQU   ICFBDE00                                                 11350002
         ENTRY ICFEND                                                   11400002
         ENTRY ICFEXT50,ICFEXT99                                        11450002
         SPACE 3                                                        11500002
         TS    ICFEFLAG-ICFBDE00(R15)  TEST ENTRY FLAG                  11550002
         BCR   D4,R15        IF SET, LOOP; R15 PTS TO ICFBDE00          11600002
         TM    ICFMFLGA-ICFBDE00(R15),ICF2CPUT  TEST FOR 2ND CPU THRU   11650002
         BNO   ICF1CPUI-ICFBDE00(R15)  IF SET, INIT 2ND CPU             11700002
         SPACE                                                          11750002
*        FROM HERE, ONLY THE 2ND CPU EXECUTES THE FOLLOWING CODE.       11800002
         SPACE                                                          11850002
         OI    ICFMFLGA-ICFBDE00(R15),ICF2CPUA  SET SECOND CPU ACTIVE   11900002
         LPSW  ICF2CPSW-ICFBDE00(R15)  DISABLE FOR MCI'S                11950002
ICF2CMCO EQU   *                                                        12000002
         STM   R0,R15,ICF2CGRS-ICFBDE00(R15)  SAVE 2ND CPU'S REGISTERS  12050002
         LR    R12,R15       SET UP BASE REG                            12100002
         USING ICFBDE00,R12                                             12150002
         STCTL CR0,CR15,ICF2CCRS  SAVE SECOND CPU'S CTLRS               12200002
         MVC   ICFCR02F(D4),ICFCR0MK   MOVE IN CR0 MASK                 12250002
         NC    ICFCR02F(D4),ICF2CCRS   'AND' IT WITH CPU2'S CR0         12300002
         OI    ICFCR02F+D2,X80    TURN ON MALFUNCTION ALERT MASK        12350002
         LCTL  CR0,CR0,ICFCR02F   INIT. CR0                             12400002
         MVC   ICF2CEOP(D8),EXOPSW     SAVE 2ND EXOPSW                  12450002
         MVC   ICF2CENP(D8),EXNPSW     SAVE 2ND EXNPSW                  12500002
         MVC   EXNPSW(D8),ICFEXPSW     SET UP 2ND EXNPSW                12550002
         STOSM ICFMWORK,X01  ENABLE FOR EXTERNALS                       12600002
         B     ICFDMPLL      GO TO DUMP LOCK LOOP                       12650002
         EJECT                                                          12700002
ICF1CPUI EQU   *                                                        12750002
         STM   R0,R15,ICFRDISP(R15) SAVE HIS REGS WHERE THEY WON'T      12800002
*                                  FOUL UP ANYTHING IN WARNA OR MCH     12850002
         LR    R12,R15             COPY MY BASE REG                     12900002
         USING ICFTDE00,R12        NOW CHANGE BASE                      12950002
         OI    ICFMFLGA,ICF2CPUT  SET SECOND CPU SIGNAL                 13000002
         MVI   ICFEFLAG,X00  RELEASE SECOND CPU                         13050002
         LA    R3,ICFSHENV         COPY SAVE AREA PTR                   13100002
         SPACE 3                                                        13150002
         L     R10,X10             LOAD CVT PTR                         13200002
         USING ICFCVTOR,R10                                             13250002
         USING ICFWORKA,R9                                              13300002
         SR    R15,R15             INIT RETURN CODE            @ZA00508 13310003
         TM    CVTVOLF2,CVTVOLI2   TEST FOR FUNCTION NOT INITIALIZED    13350002
         BO    ICFWNOFF            RETURN TO MCH WITH R15 = 0  @ZA00508 13400003
         L     R9,CVTVOLF2         GET WORK AREA PTR FOR VS2 & MVT      13450002
         DROP  R10                                                      13500002
         SPACE 3                                                        13550002
         LRA   R9,D0(R9)     GET REAL ADDR OF ICFWORK                   13600002
         BNZ   ICFWAT27                                                 13650002
         ST    R9,ICFREALW   SAVE REAL ADDR OF ICFWORK                  13700002
         EJECT                                                          13750002
* SET UP MP FLAGS                                                       13800002
         USING CSD,W8                                                   13850002
         L     W8,ICFADR3    GET REAL ADDR OF CSD                       13900002
         TM    CSDFLAGS,CSDMP     TEST FOR MP SYSTEM                    13950002
         DROP  W8                                                       14000002
         BNO   ICFNOMP                                                  14050002
         OI    ICFMFLGA,ICFMPSYS  SET MP SYSTEM FLAG                    14100002
ICFNOMP  EQU   *                                                        14150002
         SPACE 3                                                        14200002
         XC    ICFTRMCA(D4),ICFTRMCA  ZAP FOOTPRINT TABLE               14250002
         OI    ICFTRMCA,X80   SET FUNCTION ENTERED BIT                  14300002
         SPACE 3                                                        14350002
         LTR   R0,R0         TEST FOR 0 ENTRY CODE                      14400002
         BNZ   ICFNTC4S      IF NOT, SKIP CR14 TEST                     14450002
         TM    X1C0+CR14*D4,X01 TEST CR14 STORED AT INTERRUPT           14500002
*                               FOR BIT 7 OFF.                          14550002
         BNO   ICFINOPR       IF NOT ENABLED FOR WARNING,QUIT           14600002
*        THIS CAN HAPPEN ON SOME MACHINES WHEN THE WARNING              14650002
*        BIT COMES ON AS THE RESULT OF ANOTHER INTERRUPT.               14700002
         SPACE 3                                                        14750002
ICFNTC4S EQU   *                                                        14800002
         LA    R13,ICFSAVE         GET SAVE AREA PTR                    14850002
         ST    R3,D4(R13)          SAVE BACKWARD SAVE PTR               14900002
         TM    ICFFLAGA,X80        TEST FOR FUNCTION INOPERATIVE        14950002
         BZ    ICFENABL            CONTINUE IF NOT DISABLED             15000002
         OI    ICFTRMCA,X40   FUNCTION INOP BIT IS SET                  15050002
         B     ICFINOPR            IF NOT OPERATIVE,RETURN TO PROG      15100002
         EJECT                                                          15150002
*        COMPLETE SAVING ENVIRONMENT,ENABLE FOR MCI,RETURN ON TRANSIENT 15200002
ICFENABL EQU   *                                                        15250002
         OI    ICFTRMCA,X20  TURN ON FUNCTION IS OPERATIVE              15300002
         SPACE                                                          15350002
         MVC   ICF1CEOP(D8),EXOPSW     SAVE MCH'S EXTRN OPSW            15400002
         MVC   ICF1CENP(D8),EXNPSW     SAVE MCH'S EXTRN NPSW            15450002
         MVC   EXNPSW(D8),ICFEXPSW     SET UP MY EXTERNAL NPSW          15500002
         SPACE                                                          15550002
         STCTL CR0,CR0,ICFCR01S   SAVE CR0                              15600002
         MVC   ICFCR0FX(D4),ICFCR0MK   SET UP CR0 MASK                  15650002
         NC    ICFCR0FX(D4),ICFCR01S   'AND' IT W/ CR0                  15700002
         OI    ICFCR0FX+D2,X80    TURN ON MALFUNCTION ALERT MASK        15750002
         LCTL  CR0,CR0,ICFCR0FX   SET UP CTLR0                          15800002
         SPACE                                                          15850002
         L     W8,ICFMCPSW   LD MC DISABLED PSW                         15900002
         ST    W8,ICFIOPSW   CLEAR FIRST WORD OF NEW PSW                15950002
         LA    W8,ICFIMCOF   GET SET FOR NEW PSW ADDR FIELD             16000002
         ST    W8,ICFIOPSW+D4          SAVE IT                          16050002
         LPSW  ICFIOPSW      NOW DISABLE FOR MCI'S                      16100002
ICFIMCOF EQU   *                                                        16150002
         EJECT                                                          16200002
*  SET UP MC PSWS AND CR14                                              16250002
         SPACE                                                          16300002
         MVC   ICFMCOPS(D8),MCOPSW     SAVE MC OPSW                     16350002
         MVC   ICFSNMCP(D8),MCNPSW     SAVE MC NPSW                     16400002
         MVC   MCNPSW(D8),ICFMCPSW     SET UP MC NPSW                   16450002
         SPACE                                                          16500002
         STCTL CR14,CR14,ICFCR0FX      GET CTLR14                       16550002
         OI    ICFCR0FX,X01  TURN ON WARNING MASK                       16600002
         LCTL  CR14,CR14,ICFCR0FX      RESET CR14 W/ WARNING ON         16650002
         SPACE 3                                                        16700002
         LR    W8,R0         COPY ENTRY CODE                            16750002
         B     ICFENBTL(W8)  INDEX ENTRY BRANCH TABLE                   16800002
ICFENBTL EQU   *                                                        16850002
         B     ICFNRMEN      R0=0, GO TO NORMAL ENTRY PROCESSING        16900002
         B     ICFSHTEN      R0=4, GO TO SHUT ENTRY PROCESSING          16950002
         SPACE 3                                                        17000002
ICFNRMEN EQU   *                                                        17050002
         STCK  ICFTOD00            SAVE TOD CLOCK                       17100002
         MVC   ICFCTST(D8),ICFTOD00 COPY START TIME                     17150002
         BNZ   ICFCOMIT            COMMIT TO DUMP ON CLOCK FAILURE      17200002
         OI    ICFTRMCA,X10   1ST CLOCK OK                              17250002
         TM    MCIC,XC0            TEST FOR SYS OR INSTR PROC DAMAGE    17300002
         BNZ   ICFCOMIT            IF ONE OR BOTH IS ON, COMMIT TO      17350002
*                                  DUMP BECAUSE OF CONCURRENT HARD MC   17400002
         TM    ICFFLAGA,X40        TEST FOR DUMP IMMEDIATE              17450002
         BO    ICFCOMIT                                                 17500002
         OI    ICFTRMCA,X08   DUMP IMMEDIATE IS OFF                     17550002
         EJECT                                                          17600002
*        CALCULATE STOP TIME                                            17650002
         LA    W6,D1               LOAD CARRYBINCREMENT                 17700002
         L     W7,ICFTOD00         LOAD H.O. HALF OF START TIME         17750002
         L     W8,ICFTOD00+D4      LOAD L.O. HALF OF START TIME         17800002
         AL    W8,ICFTME01+D4      ADD L.O. HALF OF INTERVAL            17850002
         BC    D12,ICFNOCRY        TEST FOR NO CARRY                    17900002
         AR    W7,W6               INCREMENT H.O. PART ON CARRY         17950002
ICFNOCRY EQU   *                                                        18000002
         A     W7,ICFTME01         ADD H.O. PART OF INTERVAL            18050002
         ST    W7,ICFTOD99         SAVE H.O. PART OF STOP TIME          18100002
         ST    W8,ICFTOD99+D4      SAVE L.O. PART OF STOP TIME          18150002
         SPACE 3                                                        18200002
ICFMCKLP EQU   *                                                        18250002
         LPSW  ICFTSTWN            TEST FOR HARD MACHINE CHECK          18300002
ICFNOMCK EQU   *                                                        18350002
         LPSW  ICFMCOFF            TEMP. POWER FLUCTUATION, SO RETURN   18400002
*                                  AND MASK OFF MC'S                    18450002
ICFNOMC1 EQU   *             NOTE- THIS STATEMENT MUST FOLLOW LPSW      18500002
         OI    ICFTRMCA,X02   TRANSIENT WARNING                         18550002
         LA    R15,X04       SET RETURN CODE                            18600002
         B     ICFNORMR      GO TO NORMAL RETURN                        18650002
         SPACE 3                                                        18700002
ICFUSRTN EQU   *                                                        18750002
         OI    ICFTRMCA+D1,X08         USER RETURN CODE = 4             18800002
         OI    ICFFLAGA,X20  SET USER RC = 4 BIT IN FLAGA               18850002
         XR    R15,R15       SET RETURN CODE                            18900002
         B     ICFNORMR      GO TO NORMAL RETURN                        18950002
ICFSHRTN EQU   *                                                        19000002
         XR    R15,R15       SET RETURN CODE FOR RETURN TO SHUT         19050002
ICFSHRT1 EQU   *                                                        19100002
         OI    ICFTRMCA+D1,X04         SET RETURN TO SHUT BIT           19150002
         B     ICFNORMR      GO TO NORMAL RETURN                        19200002
         EJECT                                                          19250002
ICFMCKON EQU   *                                                        19300002
         STCK  ICFTOD01            GET CURRENT TIME                     19350002
         BNZ   ICFCOMIT            TEST FOR CLOCK FAILURE +             19400002
*                                  COMMIT IF BAD                        19450002
         CLC   ICFTOD01(D8),ICFTOD99  COMPARE CLOCK TO END              19500002
         BNL   ICFCOMI1       COMMIT TO DUMP IF END                     19550002
         TM    XE8+D1(R0),X80      TEST FOR MCIC WARNING (BIT 8)        19600002
         BO    ICFTCNCR            ON WARNING, GO TO CONCURRENCY TEST   19650002
         B     ICFCOMIT            IF NO WARNING, MUST HAVE BEEN A      19700002
*                                  HARD ERROR SO COMMIT TO DUMP         19750002
         EJECT                                                          19800002
ICFNORMR EQU   *                                                        19850002
         MVC   MCOPSW(D8),ICFMCOPS     RESET MC OLD PSW                 19900002
         MVC   MCNPSW(D8),ICFSNMCP     RESET MC NEW PSW                 19950002
         STNSM ICFMWORK,XFE  TURN OFF EXTERNALS                         20000002
         MVC   EXOPSW(D8),ICF1CEOP     RESET EXT OPSW                   20050002
         MVC   EXNPSW(D8),ICF1CENP     RESET EXT NPSW                   20100002
         LCTL  CR0,CR0,ICFCR01S   RESET CR0                             20150002
         B     ICFRTNCN      GO CONTINUE RETURN                         20200002
         SPACE                                                          20250002
ICFINOPR EQU   *                                                        20300002
         XR    R15,R15       ZERO RETURN CODE                           20350002
         SPACE                                                          20400002
ICFRTNCN EQU   *                                                        20450002
         OI    ICFTRMCA,X01  RETURN TO MCH                              20500002
ICFWNOFF EQU   *                                               @ZA00508 20550003
* 2 LINES OF CODE DELETED HERE                                 @ZA00509 20600003
         TS    ICFEFLAG      HAS SECOND CPU ENTERED?                    20650002
         BC    D8,ICFNMPRN   IF ZERO,RESET FLAGS AND RETURN             20700002
         SPACE                                                          20750002
ICFWTCIL EQU   *                                                        20800002
         TM    ICFMFLGA,ICFCPUIL  IS SECOND CPU IN LOOP?                20850002
         BNO   ICFWTCIL      IF NOT, WAIT TIL IT IS                     20900002
         STM   R0,R15,ICFRSTSG    SAVE GPRS                             20950002
         STCTL CR0,CR15,ICFRSTSC  SAVE CONTORL REGS                     21000002
         XC    ICFSTPSW(D4),ICFSTPSW   CLEAR FLAGS                      21050002
         LA    W8,ICF2CRTN                                              21100002
         ST    W8,ICFSTPSW+D4     SET UP SHTAP PSW                      21150002
         MVI   ICFDMPLK,X00  RELEASE OTHER CPU                          21200002
         SPACE                                                          21250002
ICFLOKW1 EQU   *                                                        21300002
         TM    ICFDMPLK,XFF  HAS OTHER CPU RELEASED?                    21350002
         BNO   ICFLOKW1      IF NOT, WAIT TIL IT DOES                   21400002
         SPACE                                                          21450002
ICFNMPRN EQU   *                                                        21500002
         XR    W8,W8                                                    21550002
         STC   W8,ICFMFLGS   RESET FLAGS                                21600002
         STH   W8,ICFMFLGS+D2     RESET FLAGS                           21650002
         LCTL  CR0,CR0,ICFCR01S   RESTORE CR0                           21700002
         STCTL CR14,CR14,ICFCR0FX      TURN OFF WARNING MASK            21750002
         NI    ICFCR0FX,XFE                                             21800002
         LCTL  CR14,CR14,ICFCR0FX                                       21850002
         MVC   ICFIOPSW(D4),ICFTSTWN   SET UP PSW TO ENABLE FOR MC'S    21900002
         LA    W8,ICFRENAB   SET UP ADDR OF ENABLE PSW                  21950002
         ST    W8,ICFIOPSW+D4          SAVE IT                          22000002
         LPSW  ICFIOPSW      LOAD ENABLE PSW                            22050002
ICFRENAB EQU   *                                                        22100002
         LM    R0,R14,ICFRDISP(R12)    RESTORE REGS                     22150002
         BR    R14           RETURN                                     22200002
         EJECT                                                          22250002
ICF2CRTN EQU   *                                                        22300002
*                                                                       22350002
*        NOTE R15 CONTAINS RETURN CODE                                  22400002
*                                                                       22450002
         LCTL  CR0,CR15,ICF2CCRS  RESTORE CTLRS                         22500002
         MVC   EXOPSW(D8),ICF2CEOP     RESET EXT OPSW                   22550002
         MVC   EXNPSW(D8),ICF2CENP     RESET EXT NPSW                   22600002
         MVC   ICFSTPSW(D4),ICFTSTWN   PSW SET FOR EC,Â¬DAT,AND MC'S     22650002
         LA    W8,ICF2CENB                                              22700002
         ST    W8,ICFSTPSW+D4                                           22750002
         LPSW  ICFSTPSW                                                 22800002
ICF2CENB EQU   *                                                        22850002
         LM    R0,R14,ICF2CGRS                                          22900002
         BR    R14           RETURN TO MCH                              22950002
         EJECT                                                          23000002
*        TEST FOR CONCURRENT HARD MACHINE CHECK                         23050002
ICFTCNCR EQU   *                                                        23100002
         TM    MCIC,XC0            TEST FOR SYS OR INSTR PROC DAMAGE    23150002
         BC    D5,ICFCOMIT         BRANCH ON NOT ZERO                   23200002
         B     ICFMCKLP            IF NO OTHER HARD MC, DO IT AGAIN     23250002
         EJECT                                                          23300002
ICFSHTEN EQU   *                                                        23350002
         OI    ICFTRMCA,X04         SET ENTRY VIA SHUT FLAG             23400002
         LA    R15,X04       SET RETURN CODE                            23450002
         TM    ICFFLAGA,X20  TEST FOR USER RC = 4                       23500002
         BO    ICFSHRTN      IF ON, RETURN W/ RC=0                      23550002
         XR    W8,W8         CLEAR REG                                  23600002
         ST    W8,MCNPSW     DISABLE MCNPSW                             23650002
         ST    W8,ICFDOUBL   DISABLE DISABLE PSW                        23700002
         LA    W8,ICFSHTST                                              23750002
         ST    W8,ICFIOPSW+D4                                           23800002
         LA    W8,ICFSHWON                                              23850002
         ST    W8,MCNPSW+D4                                             23900002
         LA    W8,ICFSHRT1                                              23950002
         ST    W8,ICFDOUBL+D4  POINT DIABLE PSW TO SKIP RC RESET        24000002
         MVC   ICFIOPSW(D4),ICFTSTWN   ENABLE FOR MC'S                  24050002
         STCK  ICFTOD00      SAVE TIME                                  24100002
         MVC   ICFCTST(D8),ICFTOD00  COPY IT                            24150002
         LPSW  ICFIOPSW      TEST FOR WARNING                           24200002
ICFSHTST EQU   *                                                        24250002
         LPSW  ICFDOUBL      NO WARNING,SO DISABLE & RETURN             24300002
         EJECT                                                          24350002
*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 24400002
*        PROVIDE A USER EXIT AND DETERMINE                              24450002
*        THE AVAILABLE PATH TO THE DUMP DATA SET                        24500002
*        WE ARE NOW COMMITED TO DUMP, SO MCH ENVIRONMENT IS             24550002
ICFCOMI1 EQU   *                                                        24600002
         OI    ICFTRMCA+D1,X80     COMMIT TO DUMP DUE TO HARD WARNING   24650002
*        NO LONGER A PROBLEM                                            24700002
ICFCOMIT EQU   *                                                        24750002
         L     R15,ICFEXT50        LOAD ADDR OF USER EXIT               24800002
*        !!!!!  WARNING  !!!!!                                          24850002
*        ALL I/O ACTIVITY IS IMMEDIATELY HALTED IN THE FOLLOWING        24900002
*        CODE, SO MAKE SURE THE USER ROUTINE'S I/O IS ALL FINISHED      24950002
*        BEFORE MAKING A RETURN !!!!!!!                                 25000002
*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 25050002
         OI    ICFTRMCA+D1,X40     SET USER ROUTINE ENTERED BIT         25100002
         BALR  R14,R15             LINK TO USER ROUTINE                 25150002
         EJECT                                                          25200002
*        USER 'EXIT RETURNS HERE                                        25250002
         B     ICFUSRRC(R15)       INDEX THE BRANCH WITH THE USER RC    25300002
ICFUSRRC EQU   *                                                        25350002
         B     ICFDMPCN            IF 0 CONTINUE WITH DUMP              25400002
         B     ICFUSRTN            GO RETURN TO MCH                     25450002
         SPACE 3                                                        25500002
ICFDMPCN EQU   *                                                        25550002
         OI    ICFTRMCA+D1,X20  USER RC = 0                             25600002
ICFSHWON EQU   *                                                        25650002
         OI    ICFMFLGA,ICFCTDST  SIGNAL COMMIT TO DUMP                 25700002
         USING CSD,W8                                                   25750002
         L     W8,ICFADR3    SET UP CSD BASE                            25800002
         TM    CSDFLAGS,CSDMP     TEST FOR MP SYSTEM                    25850002
         BNO   ICFNOTMP      GO HANDLE 2ND CPU NOT AVAILABLE CASE       25900002
         TM    ICFMFLGA,ICFCPUIL  TEST FOR CPU IN DUMP LOCK LOOP        25950002
         BO    ICF2CAVL      IF SO, GO TO 2ND CPU AVAIL CASE            26000002
         SPACE 3                                                        26050002
*  IF SECOND CPU ISN'T IN LOOP, MUST RESTART IT.                        26100002
*        STAP  ICFCPUAD      STORE PHYS ADR OF PROCESSOR                26150002
         DC    X'B212'       'STAP' OP CODE                             26200002
         DC    S(ICFCPUAD)   ADDRESS                                    26250002
         XI    ICFCPUAD+D1,X01    FORM OTHER CPU'S ADDR                 26300002
         L     W6,ICFWCPUA   PUT IN REG                                 26350002
         L     W7,ICFCPUMK   GET CPU MASK CONSTANT                      26400002
         SRL   W7,D0(W6)     FORM MASK FOR OTHER CPU                    26450002
         N     W7,CSDCPUAL   HAND' W/ CPU ACTIVE FIELD                  26500002
         BZ    ICFNOTMP      IF ZERO, IT ISN'T AVAILABLE                26550002
         DROP  W8                                                       26600002
         LR    W8,W6         COPY OTHER CPU'S ADDR                      26650002
         XR    W7,W7         CLEAR STATUS REG                           26700002
         EJECT                                                          26750002
*        SIGP  W7,W8,SENSE   ISSUE SIGP SENSE TO OTHER CPU (X01)        26800002
         DC    X'AE78'       'SIGP' OP CODE,R1,R3                       26850002
         DC    S(SENSE)      ADDRESS (SIGP COMMAND CODE)                26900002
         BNZ   ICFNOTMP      QUIT ON NON-ZERO RELEASE FROM SENSE        26950002
         SPACE                                                          27000002
*        SIGP  W7,W8,PRGRST  ISSUE SIGP PROGRAM RESET (X08)             27050002
         DC    X'AE78'       'SIGP' OP CODE, R1, R3                     27100002
         DC    S(PRGRST)     ADDRESS (SIGP COMMAND CODE)                27150002
         BNZ   ICFNOTMP      QUIT ON NON-ZERO RELEASE                   27200002
ICFTRSTC EQU   *                                                        27250002
         SPACE                                                          27300002
*        SIGP  W7,W8,SENSE   ISSUE SENSE TO DETERMINE COMPLETION (X01)  27350002
         DC    X'AE78'       'SIGP' OP CODE, R1, R3                     27400002
         DC    S(SENSE)      ADDRESS (SIGP COMMAND CODE)                27450002
         BC    D2,ICFTRSTC   CC=2,BUSY,GOT TEST AGAIN                   27500002
         BC    D9,ICFNOTMP   CC=0,3,UNEXPECTED, SO QUIT                 27550002
         SPACE                                                          27600002
*  CC=1, STATUS RETURNED, CHECK FURTHER                                 27650002
         LA    W6,X40        SET BIT 25 IN W6                           27700002
         CLR   W7,W6         TEST FOR BIT 25 (STOPPED) ON ALONE         27750002
         BNE   ICFNOTMP      IF NOT STOPPED, QUIT                       27800002
         USING PCCA,W6                                                  27850002
         L     W6,ICFADR2    GET REAL PCCAVT ORIGIN                     27900002
         SLL   W8,D2         ALIGN FOR FULL WORDS                       27950002
         L     W6,D0(W6,W8)  GET VIRTUAL PCCA ORIGIN FOR OTHER CPU      28000002
         SRL   W8,D2         REALIGN AS BEFORE                          28050002
         LRA   W6,D0(W6)     TRANSLATE IT                               28100002
         BNZ   ICFWAT27      IF TRANSLATION FAILS, GO TO WAIT 27        28150002
         L     W5,PCCAPSAR   GET REAL ADDR OF OTHER PCPU'S PSA          28200002
         DROP  W6                                                       28250002
         XC    D0(D4,W5),D0(W5)   CLEAR FLAGS IN HIS RESTART PSW        28300002
         LA    W6,ICFDMPL1   GET ADDR OF DUMP LOCK LOOP                 28350002
         ST    W6,D4(W5)     STORE IT IN HIS RESTART NPSW               28400002
         SPACE                                                          28450002
*        SIGP  W7,W8,RESTART ISSUE SIGP RESTART (X06)                   28500002
         DC    X'AE78'       'SIGP' OP CODE, R1,R3                      28550002
         DC    S(RESTART)    ADDRESS (SIGP COMMAND CODE)                28600002
         BNZ   ICFNOTMP      IF NOT ACCEPTED, QUIT                      28650002
ICFRSTLP EQU   *                                                        28700002
         SPACE                                                          28750002
*        SIGP  W7,W8,SENSE   ISSUE SIGP SENSE (X01)                     28800002
         DC    X'AE78'       'SIGP' OP CODE, R1, R3                     28850002
         DC    S(SENSE)      ADDRESS (SIGP COMMAND CODE)                28900002
         BC    D2,ICFRSTLP   IF BUSY, WAIT TIL COMPLETED                28950002
         BC    D5,ICFNOTMP   IF CC=1,3,QUIT                             29000002
*  IF CC=0,MUST HAVE COMPLETED, SO WAIT FOR IT TO ENTER LOCK LOOP       29050002
ICFWFETL EQU   *                                                        29100002
         TM    ICFMFLGA,ICFCPUIL  TEST FOR OTHER CPU IN LOOP            29150002
         BNO   ICFWFETL      IF NOT, WAIT FOR ENTRY TO LOOP             29200002
ICF2CAVL EQU   *                                                        29250002
         OI    ICFMFLGA,ICFMPSYS  SET MP SYSTEM FLAG                    29300002
         B     ICFGTBCM      IF SO, GO TO BC MODE                       29350002
         EJECT                                                          29400002
ICFNOTMP EQU   *                                                        29450002
         NI    ICFMFLGA,XFF-ICFMPSYS   TURN OFF MPSYS FLAG,IE,SIGNAL    29500002
*                            OTHER CPU NOT AVAILABLE                    29550002
ICFGTBCM EQU   *                                                        29600002
         XR    W8,W8         CLEAR WORK REG                             29650002
         ST    W8,ICFIOPSW   SET UP BC MODE, DISABLED PSW               29700002
         LA    W8,ICFBCDMP   SET UP PSW ADDR                            29750002
         ST    W8,ICFIOPSW+D4          STORE ADDR                       29800002
         LPSW  ICFIOPSW      GO TO BC MODE, DISABLED                    29850002
ICFBCDMP EQU   *             THIS LABEL MUST FOLLOW LPSW                29900002
         SPACE 3                                                        29950002
         USING ICFCVTOR,R10                                             30000002
         MVC   ICFLRDAT(D4),CVTDATE  SAVE DATE FOR DUMP ROUTINE         30050002
         DROP  R10                                                      30100002
         L     W7,ICFTOD00         LD H.O. PART OF TIME OF INTERRUPT    30150002
         XR    W6,W6               CLEAR REMAINDER REG                  30200002
         SLDL  W6,D13              MULT BY 8192                         30250002
         D     W6,K15625           1 CLOCK UNIT = 1.04 SEC= 16384/15625 30300002
         SLL   W7,D1               MULT QUOTIENT BY 2(2*8192=16384)     30350002
*                                  THIS IS DONE FOR PROPER ROUNDING     30400002
         XR    W6,W6               CLEAR REMAINDER                      30450002
         D     W6,K86400           DIV BY SEC PER DAY TO GET DAYS       30500002
*                                  W6 IS REMAINDER & HAS NUMBER         30550002
*                                  OF SECONDS IN THIS DAY FOR HH.MM.SS  30600002
         LR    W7,W6               SET UP DIVIDEND                      30650002
         XR    W6,W6               CLEAR REMAINDER                      30700002
         D     W6,K60              GET NUMBER OF MINUTES IN THIS DAY    30750002
*                                  W6 HAS SECONDS LEFT OVER             30800002
         LR    W5,W6               COPY SECONDS                         30850002
         XR    W6,W6               CLEAR REMAINDER                      30900002
         D     W6,K60              GET NUMBER OF HOURS IN THIS DAY      30950002
         MH    R6,HK100            MULT NO. OF MIN. BY 100              31000002
         AR    W5,W6               ADD TO SECONDS                       31050002
         MH    W7,HK10T4           MULT NO. OF HOURS BY 10000           31100002
         AR    W5,W7               ADD TO SEC AND MIN                   31150002
         CVD   W5,ICFDOUBL         MAKE TIME PACKED DEC.                31200002
         L     W5,ICFDOUBL+D4      LOAD LOW ORDER HALF                  31250002
         SRL   W5,D4               CLEAR DECIMAL SIGN                   31300002
         SLL   W5,D8               ALIGN  IN FIELD                      31350002
         ST    W5,ICFLRTIM         SAVE FOR DUMP ROUTINE                31400002
         EJECT                                                          31450002
*        SET UP FOR WARNA DATASET                                       31500002
*        CONTROL FLAG FOR WARNA OR WARNB IS ICFPTLPF                    31550002
ICFPTCL1 EQU   *                                                        31600002
         OI    ICFPTLPF,X80  SET ON FIRST EXTENT FLAG                   31650002
         L     W1,ICFWAUCB   SET UP UCB ADDR REG                        31700002
         LA    W7,ICFWADEV   SET UP DEVICE ADDR PTR REG                 31750002
         LA    W2,ICFTRMCA+D2     SET UP FOOTPRINT TABLE PTR            31800002
         LA    W0,D10        SET UP CHANNEL LOGOUT COUNT                31850002
ICFPTCLR EQU   *                                                        31900002
*  FOR IOSGEN,                                                          31950002
*  W1 TPS TO UCB                                                        32000002
*  W8 PTS TO IOSGEN MAP AREA                                            32050002
*  R14 IS LINK REG                                                      32100002
*  R13 PTS TO 16 WORD SAVE AREA                                         32150002
         LPSW  ICFDNPSW      IOSGEN MUST BE IN DAT MODE TO WORK         32200002
ICFDATON EQU   *                                                        32250002
         USING ICFCVTOR,R10                                             32300002
         L     R10,X10                                                  32350002
         L     R9,CVTVOLF2             GET LOGICAL ADDR OF ICFWORK      32400002
         DROP R10                                                       32450002
         LA    W8,ICFIOMAP   SET UP IOSGEN MAP PTR                      32500002
         LA    R14,ICFMAPMK  SET UP LINK REG                            32550002
         LA    R13,ICFIOMAP+D8    SET UP SAVE AREA PTR                  32600002
         EJECT                                                          32650002
         IOSGEN  MAP,TABLE=(W8),UCB=(W1),VAR=1                          32700002
         EJECT                                                          32750002
ICFMAPMK EQU   *                                                        32800002
*        HERE IOSGEN MAP IS CONVERTED TO ANOTHER FORMAT                 32850002
*             ****************************************************      32900002
*             * 4 BIT      * 4 BIT      * 4 BIT      * 4 BIT      *     32950002
*             * ONLINE/    * CHANNEL    * CONTROL    * DEVICE     *     33000002
*             * OFFLINE    * ADDRESS    * UNIT       * ADDRESS    *     33050002
*             * INDICATOR  *            * ADDRESS    *            *     33100002
*             ****************************************************      33150002
*              WHERE 0000 = ONLINE (PATH AVAILABLE)                     33200002
*                    0001 = LAST ENTRY IN MAP                           33250002
*                    0010 = OFFLINE (PATH NOT AVAILABLE)                33300002
         LPSW  ICFDFPSW      GO BACK TO BC MODE                         33350002
ICFDATOF EQU   *                                                        33400002
         L     R9,ICFREALW             GET REAL ADDR OF WORK AREA       33450002
         LA    R13,ICFSAVE   RELOAD SAVE AREA PTR                       33500002
         MVC   ICF0CMAP(D2),ICFIOMAP   CPY PRIME PTH ADDR TO CPU0'S MAP 33550002
         MVC   ICF0CMAP+D2(D2),ICFIOMAP+D4  COPY 2ND PATH ADDR          33600002
         MVC   ICF1CMAP(D4),ICF0CMAP   COPY INTO CPU1'S MAP             33650002
         LA    W4,D2         SET UP INDEX                               33700002
         XR    W6,W6                                                    33750002
         XR    W3,W3                                                    33800002
ICFMPFIN EQU   *                                                        33850002
         IC    W6,ICFIOMAP(W4)    GET PRIMARY AVAIL. FLAG               33900002
         IC    W3,ICFIOMAP+D4(W4)      GET 2ND AVAIL FLAG               33950002
         AR    W3,W3         WEIGH 2ND PATH BY 2                        34000002
         AR    W6,W3         COMPUTE INDEX                              34050002
         SLL   W6,D2         ALIGN FOR FULL WORDS                       34100002
         L     W5,ICFMMASK(W6)    INDEX MASK TABLE                      34150002
         LA    W3,D3         GET COMPARAND                              34200002
         CR    W4,W3         TEST WHETHER CPU1 IS DONE                  34250002
         BE    ICFMAPCP      YES, DONE                                  34300002
         O     W5,ICF0CMAP   NO, 'OR' FLAGS IN CPU0'S MAP               34350002
         ST    W5,ICF0CMAP   STORE IT                                   34400002
         LR    W4,W3         SET UP INDEX FOR CPU 1                     34450002
         B     ICFMPFIN      GO FINISH                                  34500002
ICFMAPCP EQU   *                                                        34550002
         O     W5,ICF1CMAP   'OR' FLAGS IN CPU1'S MAP                   34600002
         ST    W5,ICF1CMAP   STORE IT                                   34650002
         EJECT                                                          34700002
*  MAPS ARE NOW COMPLETE, SO SET UP FOR PATH CLEAR                      34750002
         XR    W3,W3                                                    34800002
         XR    W4,W4                                                    34850002
         NI    ICFMFLGA,XFF-ICFBCACC-ICFWDAC0-ICFWDAC1  RESET FLAGS     34900002
         IC    W3,ICFIOMAP+D2     GET FIRST CPU0 FLAF BYTE              34950002
         IC    W4,ICFIOMAP+D6     GET 2ND CPU0 FLAG BIT                 35000002
         OR    W3,W4         IS WARN DATASET ACCESSIBLE FORM CPU0?      35050002
         BZ    ICFWDUT0      IF NOT, SKIP SETTING FLAG                  35100002
         OI    ICFMFLGA,ICFWDAC0  SET WARN DS ACC. FROM CPU 0 FLAG      35150002
ICFWDUT0 EQU   *                                                        35200002
         LR    W5,W3         COPY REG                                   35250002
         IC    W3,ICFIOMAP+D3     GET FIRST FLAG BYTE FOR CPU1          35300002
         IC    W4,ICFIOMAP+D7     GET SECOND FLAG BYTE FOR CPU1         35350002
         OR    W3,W4         IS WARN DS ACC. FORM CPU1?                 35400002
         BZ    ICFWDUT1      IF NOT, SKIP SETTING FLAG                  35450002
         OI    ICFMFLGA,ICFWDAC1  SET WARN DS ACC. FROM CPU 1 FLAG      35500002
ICFWDUT1 EQU   *                                                        35550002
         NR    W3,W5         IS WARN DS ACC. FROM BOTH SIDES?           35600002
         BZ    ICFWDUTB      IF NOT, SKIP SETTING FLAG                  35650002
         OI    ICFMFLGA,ICFBCACC  SET WARN DS ACC. FROM BOTH SIDES BIT  35700002
         EJECT                                                          35750002
ICFWDUTB EQU   *                                                        35800002
         TM    ICFMFLGA,ICFMPSYS  TEST FOR MP SYSTEM                    35850002
         BO    ICFMPCAV      IF SO, GO HANDLE MP CASE AVAIL.            35900002
         LA    W8,ICF0CMAP   SET UP MAP ADR FOR PHYS CPU 0              35950002
         TM    ICFMFLGA,ICFWDAC0  TEST FOR PCPU0 AVAIL                  36000002
         BO    ICFDEVLP      YES, GO CLEAR                              36050002
         LA    W8,ICF1CMAP   SET UP MAP FOR PCPU1                       36100002
         TM    ICFMFLGA,ICFWDAC1  TEST FOR CPU 1 AVAIL.                 36150002
         BO    ICFDEVLP      YES, GO CLEAR                              36200002
         B     ICFZAPAD      NO, QUIT THIS EXTENT                       36250002
ICFMPCAV EQU   *                                                        36300002
*        STAP  ICFCPUAD      GET PCPU ADDR                              36350002
         DC    X'B212'       'STAP' OP CODE                             36400002
         DC    S(ICFCPUAD)   ADDRESS                                    36450002
         L     W6,ICFWCPUA   PUT IT IN REG                              36500002
         LTR   W6,W6         AM I ON 0 OR 1?                            36550002
         BNZ   ICFTAVC1      IF 1, GO SET UP CHECK FOR CPU1             36600002
         LA    W8,ICF0CMAP   PT W8 TO PCPU0 MAP                         36650002
         TM    ICFMFLGA,ICFWDAC0  IS WARN DS ACC. FORM THIS CPU?        36700002
         BO    ICFDEVLP      IF SO, GO CLEAR IT                         36750002
         LA    W8,ICF1CMAP   PT W8 TO PCPU1 MAP                         36800002
         TM    ICFMFLGA,ICFWDAC1  IS IT AVAIL FROM OTHER CPU?           36850002
         BNO   ICFZAPAD      IF NOT, ZAP THIS EXTENT                    36900002
ICFSUSTC EQU   *                                                        36950002
         XC    ICFSTPSW(D4),ICFSTPSW   CLEAR FLAG FIELD OF SHTAP PSW    37000002
         LA    W6,ICFDEVLP   GET DEV LOOP ADDR                          37050002
         ST W6,ICFSTPSW+D4   PUT IT IN SHTAP PSW                        37100002
         TM    ICFMFLGA,ICFCPUIL  IS OTHER CPU IN LOCK?                 37150002
         BNO   ICFZAPAD      IF NOT, ZAP THIS EXTENT                    37200002
         B     ICFSHTAP      IF SO, SHOILDER TAP IT                     37250002
ICFTAVC1 EQU   *                                                        37300002
         LA    W8,ICF1CMAP   PT W8 TO PCPU1 MAP                         37350002
         TM    ICFMFLGA,ICFWDAC1  IS WARN DS AVAIL FORM PCPU1?          37400002
         BO    ICFDEVLP      IF SO, GO CLEAR IT                         37450002
         LA    W8,ICF0CMAP   PT W8 TO PCPU0 MAP                         37500002
         TM    ICFMFLGA,ICFWDAC0  IS WARN DS AVAIL FORM PCPU0?          37550002
         BNO   ICFZAPAD      IF NOT, QUIT THIS EXTENT                   37600002
         B     ICFSUSTC      IF SO, GO SET UP SHTAP FOR CLEAR           37650002
         EJECT                                                          37700002
*        PATH CLEARING AND PATH CHECKING ROUTINE                        37750002
*        W8 PTS TO IOSGEN MAP                                           37800002
*        W7 PTS TO ICFWXDEV (X= A OR B)                                 37850002
*        W1 PTS TO ONE OF THE UCBS FOR THE PATH UNDER CONSIDERATION     37900002
*        W2 PTS TO BYTE IN FOOTPRINT TABLE                              37950002
*        W0 HAS CHANNEL LOGOUT COUNT                                    38000002
         SPACE 3                                                        38050002
*        SET UP CLEARING LOOP                                           38100002
ICFDEVLP EQU   *                                                        38150002
         OI    D0(W2),X80          IOS DONE, NOW CLEAR PATH             38200002
         LR    W6,W8          COPY IOSGEN MAP ORG                       38250002
ICFPTHOT EQU   *                                                        38300002
         TM    D0(W6),X20     TEST FOR PATH OFFLINE                     38350002
         BO    ICFTLSPT       IF SO, GO TO TEST LAST PATH               38400002
         OI    D0(W2),X40          AT LEAST 1 PATH AVAIL FROM IOS       38450002
         IC    W5,D0(W6)      GET FLAG AND CHANNEL NUMBER BYTE          38500002
         SLL   W5,D28         SHIFT OUT FLAG DIGIT                      38550002
         SRL   W5,D20         SET UP C00 ADDRESS                        38600002
         TCH   D0(W5)         DETERMINE STATE OF CHANNEL                38650002
         BC    D8,ICFHCTDV    CC=0,AVAILABLE,ISSUE HDV                  38700002
         BC    D4,ICFINTPD    CC=1,INTERRUPT PENDING,GO ENABLE          38750002
         BC    D2,ICFBRTIP    CC=2,BURST IN PROG,HIO                    38800002
         BC    D1,ICFPTHUA    CC=3,NOT OPER.,SET OFFLINE BIT            38850002
         SPACE 3                                                        38900002
ICFPTHUA EQU   *                                                        38950002
         LA    W0,D10        RESET CHANNEL LOGOUT COUNT                 39000002
         OI    D0(W6),X20      SET PATH NOT AVAIL (OFFLINE)             39050002
*                             IN IOSGEN MAP                             39100002
ICFTLSPT EQU   *                                                        39150002
         TM    D0(W6),X10      TEST FOR LAST PATH IN MAP                39200002
         BO    ICFPTHCK       IF SO, GO CONFIRM A PATH                  39250002
         LA    W6,D2(W6)      IF NOT, GET NEST MAP ENTRY                39300002
         B     ICFPTHOT       GO TEST PATH AND CLEAR IT                 39350002
         EJECT                                                          39400002
ICFBRTIP EQU   *                                                        39450002
*        W5 CONTAINS"CXX" ADDR                                          39500002
*        W6 PTS TO MAP ENTRY                                            39550002
*        W7 PTS TO "CUD" LOCATION                                       39600002
*        W8 PTS TO IOSGEN MAP                                           39650002
*        W1 POINTS TO UCB OF ONE OF THE PATHS                           39700002
         SPACE 3                                                        39750002
         HIO   D0(W5)         STOP CHANNEL BURST OPERATION              39800002
         BC    D8,ICFINTPD    CC=0,INT.PENDING,GO ENABLE                39850002
         BC    D4,ICFHCSWC    CC=1,CSW STORED,GO CHECK IT               39900002
         BC    D2,ICFHITCH    CC=2,BURST OP STOPPED, GO TEST AGAIN      39950002
         BC    D1,ICFADSKP    CC=3,NOT OPER,SKIP THIS ADDR              40000002
         SPACE 3                                                        40050002
ICFHCSWC EQU   *                                                        40100002
         TM    CSW,X04        TEST FOR LOGOUT PENDING                   40150002
         BNO   ICFHCTDV       IF NOT, GO ISSUE HALT DEVICE              40200002
         TM    CSW+D5,X04     TEST FOR CONCURRENT CHAN CNTL CHECK       40250002
         BNO   ICFHCTDV       IF NOT, GO ISSUE HDV                      40300002
         BCT   W0,ICFINTPD         GO ENABLE FOR LOGOUT PENDING         40350002
         B     ICFPTHUA            IF >10 LOGOUTS ON THIS CHANNEL,      40400002
*                                  FLAG PATH AS UNAVAILABLE             40450002
         SPACE 3                                                        40500002
ICFHITCH EQU   *                                                        40550002
         TCH   D0(W5)         DETERMINE CHANNEL STATE                   40600002
         BC    D8,ICFHCTDV    CC=00,AVAIL,ISSUE HDV                     40650002
         BC    D4,ICFINTPD    CC=1,INT PENDING,GO ENABLE                40700002
         BC    D2,ICFBRTIP    CC=2,BURST MODE,ISSUE HIO                 40750002
         BC    D1,ICFADSKP    CC=3,NOT OPER,SKIP THIS ADDR              40800002
         EJECT                                                          40850002
ICFINTPD EQU   *                                                        40900002
         LR    W4,W5          COPY 'CXX' ADDR                           40950002
         SLL   W4,D2               ALIGN CHANNEL ADDR FOR FULL WORDS    41000002
         SRL   W4,D8          EXTRACT CHANNEL ADDR                      41050002
         LA    W4,ICFCHTBL(W4)     FORM CHANNEL MASK ADDR               41100002
         LCTL  CR2,CR2,D0(W4)      SET CHANNEL MASK IN CTLR2            41150002
         LA    W3,ICFCHTBL+D6*D4 FORM ADDR OF CHAN 6 MASK               41200002
         CLR   W4,W3          COMPARE CHAN SELECTED W/ 6                41250002
         BL    ICFCHLT6       IF <6,GO ELSEWHERE                        41300002
         LR    W4,W3          IF =>6,COPY MASK ADDR                     41350002
ICFCHLT6 EQU   *                                                        41400002
         MVC   ICFIOPSW(D4),D0(W4) SET UP SYS MASK                      41450002
         LA    W3,X27                                                   41500002
         ST    W3,ICFIOPSW+D4 SET WAIT STATE CODE                       41550002
         OI    ICFIOPSW+D1,X02     SET WAIT BIT                         41600002
         XC    IONPSW(D4),IONPSW   ZAP I/O NPSW                         41650002
         LA    W3,ICFHCTDV                                              41700002
         ST    W3,IONPSW+D4   POINT I/O NPSW TO HDV                     41750002
         LPSW  ICFIOPSW       ENABLE SELECTED CHANNEL                   41800002
         SPACE 3                                                        41850002
ICFHCTDV EQU   *                                                        41900002
         TIO   D0(W5)              DETERMINE DEVICE STATE               41950002
         BC    D8,ICFADSKP         CC=0,AVAIL,GO DO NEXT ADDR           42000002
         BC    D4,ICFFTCSC         CC=1,CSW STORED, TEST FOR UC         42050002
         BC    D2,ICFBRTIP         CC=2,BUSY, ISSUE HIO                 42100002
         BC    D1,ICFADSKP         CC=3,NOT OPER, GO DO NEXT ADDR       42150002
ICFFTCSC EQU   *                                                        42200002
         TM    CSW+D4,X02          TEST FOR UC                          42250002
         BO    ICFTIOSN      IF SO, GO SENSE IT                         42300002
*                                  IF NOT, GO ON WITH HCT SEQ           42350002
*  FIX FOR CONTIGENT CONNECTION PROBLEM                                 42400002
*  UNIT CAUSING CONTIGENT CONNECTION MAY PRESENT CU END-BUSY STATUS     42450002
*  (X30)ON A TIO, SO TEST AGAIN FOR UNIT CHECK                          42500002
         TM    CSW+D4,X30    CU END-BUSY?                               42550002
         BO    ICFHCTDV      IF SO, CHECK FOR UNIT CHECK                42600002
         HDV   D0(W5)         STOP DEVICE REQUESTS                      42650002
*        CLRIO D0(W5)         CLEAR STATUS                              42700002
         DC    X'9D015000'                                              42750002
         TIO   D0(W5)         DETERMINE DEVICE STATE                    42800002
         BC    D8,ICFADSKP    CC=0,AVAIL,GO DO NEXT ADDR                42850002
         BC    D4,ICFTCSWC    CC=1,CSW STORED,CHECK IT                  42900002
         BC    D2,ICFBRTIP    CC=2,BUSY,ISSUE HIO                       42950002
         BC    D1,ICFADSKP    CC=3,NOT OPER,GO DO NEXT ADDR             43000002
         EJECT                                                          43050002
ICFTIOSN EQU   *                                                        43100002
*                                                                       43150002
*        W5 HAS THE DEVICE ADDR (CUD)                                   43200002
   SPACE                                                                43250002
*        SET UP CCW & CAW                                               43300002
         SPACE                                                          43350002
         LA    W4,ICFSENSA         LOAD ADDR OF SENSE SAVE AREA         43400002
         ST    W4,ICFSNCCW         STORE IT IN THE SENSE CCW            43450002
         LA    W4,X04                                                   43500002
         STC   W4,ICFSNCCW         SAVE THE SENCE COMD CODE IN THE CCW  43550002
         LA    W4,D24                                                   43600002
         ST    W4,ICFSNCCW+D4      SET UP LENGTH & FLAGS IN CCW         43650002
         LA    W4,ICFSNCCW                                              43700002
         ST    W4,CAW              PUT CCW ADDR IN CH ADDR WORD         43750002
         SPACE                                                          43800002
*        SET U P I/O NPSW                                               43850002
         SPACE                                                          43900002
         XC    IONPSW(D4),IONPSW       ZAP IO NEW PSW                   43950002
         LA    W4,ICFTSNCD                                              44000002
         ST    W4,IONPSW+D4        POINT I/O NPSW TO CHECK CE/DE        44050002
         SPACE                                                          44100002
*        COPY DEVICE ADDR                                               44150002
         SPACE                                                          44200002
         LR    W4,W5                                                    44250002
         SPACE                                                          44300002
*        ISSUE  SENIO & ENABLE                                          44350002
         SPACE                                                          44400002
         XC    ICFIOPSW(D8),ICFIOPSW   ZAP ICFIOPSW                     44450002
         SRL   W4,D8               ISOLATE CHANNEL ADDR                 44500002
         SLL   W4,D2               ALIGN FOR FULL WORDS                 44550002
         LA    W4,ICFCHTBL(W4)     GET ADDR OF CR2 CHAN MASK            44600002
         LCTL  CR2,CR2,D0(W4)      LOAD THE CHAN MASK                   44650002
         STH   W5,IOOPSW+D2  STORE 'CUD' ADR FOR COMPARE                44700002
         CLI   IOOPSW+D2,D6        TEST FOR CHAN < OR => 6              44750002
         BL    ICFTSCL6            IF LT 6, SKIP NEXT INSTRUCTION       44800002
         LA    W4,ICFCHTBL+D6*D4   SET UP W4 FOR SYS MASK => 6          44850002
ICFTSCL6 EQU   *                                                        44900002
         MVC   ICFIOPSW(D1),D0(W4)  SET UP SYSTEM MASK IN PSW           44950002
         MVI   ICFIOPSW+D1,X02     SET THE WAIT BIT                     45000002
         LA    W4,X27                                                   45050002
         ST    W4,ICFIOPSW+D4      SET WAIT STATE CODE                  45100002
         EJECT                                                          45150002
         SPACE                                                          45200002
         SIO   D0(W5)              ISSUE SENSE I/O                      45250002
         SPACE                                                          45300002
         BC    D7,ICFADSKP         CC=1,2, OR 3,SKIP THIS ADDR          45350002
*                                  OTHERWISE ENABLE                     45400002
ICFTSNCE EQU   *                                                        45450002
         LPSW  ICFIOPSW            ENABLE & WAIT FOR CE/DE              45500002
         SPACE                                                          45550002
*        NOW T EST FOR CE/DE                                            45600002
         SPACE                                                          45650002
ICFTSNCD       EQU           *                                          45700002
         CH    W5,IOOPSW+D2  WAS INTERRUPT FROM SENSED DEVICE?          45750002
         BNE   ICFTSNCE      IF NOT,WAIT FOR COMPLETION                 45800002
         B     ICFADSKP      IF SO, GO TO NEXT ADDRESS                  45850002
         EJECT                                                          45900002
ICFTCSWC EQU   *                                                        45950002
         TM    CSW,X04        TEST FOR LOGOUT PENDING                   46000002
         BNO   ICFADSKP       IF NOT SKIP THIS ADDR                     46050002
         TM    CSW+D5,X04     TEST FOR CHAN CNTL CHECK                  46100002
         BNO   ICFADSKP       IF NOT SKIP THIS ADDR                     46150002
         BCT   W0,ICFINTPD         GO ENABLE FOR INTERRUPTS             46200002
         B     ICFPTHUA            IF >10 LOGOUTS ON THIS CHANNEL,      46250002
*                                  GO FLAG THIS PATH AS UNAVAILABLE     46300002
         SPACE 3                                                        46350002
ICFADSKP EQU   *                                                        46400002
         LA    W5,D1(W5)      INCR DEV ADDR                             46450002
         LR    W4,W5          COPY NEW DEV ADDR                         46500002
         SLL   W4,D24         GET RID OF "C" PART                       46550002
         LTR   W4,W4          CHECK FOR "UD" = 0                        46600002
         BNZ   ICFHCTDV            IF NOT DONE, GO HDV                  46650002
         OI    D0(W2),X20          AT LEAST 1 PATH CLEARED              46700002
         B     ICFTLSPT            IF 0,CHANNEL'S DONE,DO NXT PATH      46750002
         EJECT                                                          46800002
ICFPTHCK EQU   *                                                        46850002
*        W7 PTS TO "CUD" ADDR                                           46900002
*        W8 PTS TO IOSGEN MAP ORG                                       46950002
*        W1 PTS TO UCB OF ONE OF THE PATHS                              47000002
         SPACE 3                                                        47050002
         OI    D0(W2),X10          SET PATH CHECK ENTERED               47100002
         TM    D0(W8),X20     TEST PATH AVAILABILITY                    47150002
         BNO   ICFCHCNT       IF AVAILABLE, CONTINUE                    47200002
ICFINMPT EQU   *                                                        47250002
         TM    D0(W8),X10     TEST FOR LAST PATH DONE                   47300002
         BNO   ICFMAPBP      IF NOT LAST PATH, GO BUMP AMP PTR          47350002
         TM    ICFMFLGA,ICFBCACC  ACCESSIBLE FROM OTHER CPU?            47400002
         BO    ICFCOCPU      IF SO, GO CLEAR IT FROM OTHER SIDE         47450002
         B     ICFZAPAD      IF NOT, QUIT THIS EXTENT                   47500002
ICFMAPBP EQU   *                                                        47550002
         LA    W8,D2(W8)      BUMP MAP PTR                              47600002
         B     ICFPTHCK       KEEP CHECKING                             47650002
ICFCHCNT EQU   *                                                        47700002
         OI    D0(W2),X08          AT LEAST 1 PATH AVAIL AFTER CLEAR    47750002
         IC    W5,D0(W8)      GET FLAGS AND CHAN ADDR                   47800002
         SLL   W5,D28         GET RID OF FLAGS                          47850002
         SRL   W5,D26         ALIGN FOR FULL WORDS                      47900002
         LA    W5,ICFCHTBL(W5) INDEX CHANNEL TABLE                      47950002
         LCTL  CR2,CR2,D0(W5) SET UP CTL2 CHAN MASK                     48000002
         XC    IONPSW(D8),IONPSW ZAP I/O NPSW                           48050002
         LA    W4,ICFCHTCH                                              48100002
         ST    W4,IONPSW+D4   PT I/O NPSW TO TEST AGAIN FOR INT         48150002
         LA    W4,ICFCHTBL+D4*D6 LOAD CHAN 6 MASK ADDR                  48200002
         CR    W5,W4          IS CHAN NO. <6 OR =>6?                    48250002
         BL    ICFCCHL6       GOSET SYS MASK FOR CH <6                  48300002
         LR    W5,W4          PT W5 TO PROPER SYS MASK FOR =>6          48350002
ICFCCHL6 EQU   *                                                        48400002
         XC    ICFIOPSW(D8),ICFIOPSW ZAP PSW FIELD                      48450002
         MVC   ICFIOPSW(D1),D0(W5) MOVE IN SYSTEM MASK                  48500002
         LA    W4,ICFCHTCH                                              48550002
         ST    W4,ICFIOPSW+D4 PT PSW TO TEST CHANNEL                    48600002
         LH    W4,D0(W8)      LOAD DEVICE "CUD"                         48650002
         SLL   W4,D20                                                   48700002
         SRL   W4,D20         CLEAR OUT FLAGS                           48750002
ICFCHTCH EQU   *                                                        48800002
         TCH   D0(W4)         CHECK FOR ANY MORE INT PEND               48850002
         BC    D8,ICFSENIO    CC=0,AVAIL,ISSUE SIO                      48900002
         BC    D3,ICFINMPT    CC=2 OR 3,TRY ANOTHER PATH                48950002
         LPSW  ICFIOPSW       CC=1,INTERRUPT PEND,CLEAR IT              49000002
         EJECT                                                          49050002
ICFSENIO EQU   *                                                        49100002
*        W5 PTS TO PROPER SYSTEM MASK                                   49150002
*        CTLR2 HAS PROPER CHANNEL ENABLED                               49200002
         SPACE 3                                                        49250002
*        SET UP SENSE CCW AND CAW                                       49300002
         LA    W4,ICFSENSA    LOAD ADDR OF SENSE SAVE AREA              49350002
         ST    W4,ICFSNCCW    STORE IT IN SENSE CCW                     49400002
         LA    W4,X04         SET UP SENSE COMMAND CODE                 49450002
         STC   W4,ICFSNCCW    STORE COMMAND CODE                        49500002
         LA    W4,D24                                                   49550002
         ST    W4,ICFSNCCW+D4      SET UP FLAGS & COUNT FOR SENIO CCW   49600002
         LA    W4,ICFSNCCW    LOAD SENSE CCW ADDR                       49650002
         ST    W4,CAW         STORE IT IN CHN ADDR WORD                 49700002
*        SET UP I/O NPSW                                                49750002
         XC    IONPSW(D8),IONPSW ZAP IO NPSW                            49800002
         LA    W4,ICFCEDE                                               49850002
         ST    W4,IONPSW+D4   POINT IT TO CE/DE ROUTINE                 49900002
         XC    ICFIOPSW(D8),ICFIOPSW ZAP PSW                            49950002
         MVC   ICFIOPSW(D1),D0(W5)  SET UP NEW SYSTEM MASK              50000002
         LA    W4,X27                                                   50050002
         ST    W4,ICFIOPSW+D4 SET UP WAIT STATE CODE                    50100002
         MVI   ICFIOPSW+D1,X02 SET WAIT BIT                             50150002
*        SET UP DEVICE ADDR                                             50200002
         LH    W4,D0(W8)           LOAD FLAGS AND CUD ADDR              50250002
         SLL   W4,D20                                                   50300002
         SRL   W4,D20              CLEAR FLAGS                          50350002
         SPACE                                                          50400002
         TIO   D0(W4)        IS PATH CLEAR?                             50450002
         BC    D3,ICFINMPT   IF BUSY OR NOT OP., TRY ANOTHER PATH       50500002
         BC    D8,ICFCHEXT   CC=0,OK AND GO ON                          50550002
         SPACE                                                          50600002
         TM    CSW+D4,X02    UNIT CHECK STATUS?                         50650002
         BNO   ICFINMPT      IF NOT, TRY ANOTHER PATH                   50700002
ICFCHSEN EQU   *                                                        50750002
         SIO   D0(W4)        ISSUE SENSE                                50800002
         BC    D7,ICFINMPT   TRY ANOTHER PATH IF NOT ACCEPTED           50850002
ICFSNCC0 EQU   *                                                        50900002
         OI    D0(W2),X04          CC=0 ON SENSE I/O                    50950002
         LPSW  ICFIOPSW       ENABLE FOR THE INTERRUPT                  51000002
ICFCEDE  EQU   *                                                        51050002
         TM    CSW+D4,X0C        TEST FOR CHANNEL END/DEVICE END        51100002
         BNO   ICFZAPAD            IF NOT CE/DE,GO ZAP THIS ADDR        51150002
         OI    D0(W2),X02          SET CE/DE FOR SIO                    51200002
         B     ICFINMPT      IF BOTH CE/DE, TRY ANOTHER PATH            51250002
         EJECT                                                          51300002
ICFCOCPU EQU   *                                                        51350002
*  CHECK OTHER CPU ROUTINE                                              51400002
*  ENTERED WHEN A BUSY IS FOUND WHEN CHECKING A DATASET AND AVAIL ON    51450002
*  OTHER CPU IS INDICATED                                               51500002
*        STAP  ICFCPUAD      GET PCPU ADDR                              51550002
         DC    X'B212'       'STAP' OP CODE                             51600002
         DC    S(ICFCPUAD)   ADDRESS                                    51650002
         LA    W8,ICF0CMAP   PT W8 TO PCPU0 MAP                         51700002
         L W6,ICFWCPUA       PUT PCPU ADDR IN REG                       51750002
         LTR   W6,W6         TEST FOR CPU 0                             51800002
         BNZ   ICFCNC01      IF NOT ZERO, WE'LL GO THERE                51850002
         LA    W8,ICF1CMAP   IF 0,WE'LL GO TO PCPU1                     51900002
ICFCNC01 EQU   *                                                        51950002
         TM    ICFMFLGA,ICFCPUIL  IS OTHER CPU IN LOOP?                 52000002
         BNO   ICFZAPAD      IF NOT, QUIT THIS EXTENT                   52050002
         NI    ICFMFLGA,XFF-ICFBCACC   TURN OFF  AVAIL TO BOTH CPU FLAG 52100002
         XC    ICFSTPSW(D4),ICFSTPSW   CLEAR FLAGS OF SHTAP PSW         52150002
         LA    W6,ICFDEVLP   GET BRANCH ADDR                            52200002
         ST    W6,ICFSTPSW+D4     SET UP SHTAP PSW                      52250002
         B     ICFSHTAP      IF SO, GO SHOULDER TAP                     52300002
         EJECT                                                          52350002
ICFZAPAD EQU   *                                                        52400002
         TM    ICFPTLPF,X80  ARE WE ON FIRST EXTENT?                    52450002
         BNO   ICFWAT27      IF NOT, FIRST TIME MUST HAVE FAILED ALSO,  52500002
*                            SO SIGNAL DUMP FAILED                      52550002
         XR    W4,W4         ZAP DEV ADDR REG                           52600002
         STNSM ICFMWORK,X00  TURN OFF SYSTEM MASK                       52650002
ICFCHEXT EQU   *                                                        52700002
         STH   W4,D2(W7)     STORE DEV ADDR OF OPEN PATH                52750002
         OI    D0(W2),X01    WARNX PROCESSING COMPLETE                  52800002
         B     ICFDCTLR      GO TO DUMP CONTROL ROUTINE                 52850002
         EJECT                                                          52900002
ICFDCTLR EQU   *                                                        52950002
         USING CSD,W8                                                   53000002
         L     W8,ICFADR3    SET UP REAL BASE FOR CSD                   53050002
         TM    CSDFLAGS,CSDMP     IS THIS SUPPOSED TO BE AN MP SYSTEM?  53100002
         DROP  W8                                                       53150002
         BNO   ICFDCUP1      IF NOT, GO TO UP CODE                      53200002
*        STPX  ICFPXREG      STORE PREFIX REG IN COMMON AREA            53250002
         DC    X'B211'       'STPX' OP CODE                             53300002
         DC    S(ICFPXREG)   ADDRESS                                    53350002
         B     ICFDCMU1      GO TO COMMON SECTION                       53400002
ICFDCUP1 EQU   *                                                        53450002
         MVC   ICFPXREG(D4),ICFALL0S   FOR UP SET PREFIX REG TO 0       53500002
ICFDCMU1 EQU   *                                                        53550002
         STM   R0,R15,ICFRSTSG    SAVE GPRS FOR RETURN FROM DUMP        53600002
         STCTL CR0,CR15,ICFRSTSC  SAVE CTLRS ALSO                       53650002
         LCTL  CR0,CR0,ICFALL0S   DISABLE CR0                           53700002
         LCTL  CR2,CR2,ICFALL1S ENABLE ALL CHANNELS IN CR2              53750002
         XC    ICFCR0FX(D4),ICFCR0FX                                    53800002
         MVI   ICFCR0FX,X80                                             53850002
         LCTL  CR14,CR14,ICFCR0FX ENABLE CR14 FOR CHECK STOP ONLY       53900002
         LR    R13,R9        SET UP COMMON BASE FOR DUMP                53950002
         STNSM ICFMWORK,X'00'     MAKE SURE PSW IS DISABLED             54000002
         OI    ICFTRMCA+D1,X10    SET 'IN DUMP' BIT                     54050002
         L     R15,ICFEXT99  LOAD DST ADDR IN DUMP ROUTINE              54100002
         LA    R14,ICFDMPRN  SET UP RETURN ADDR                         54150002
         BR    R15 GO TO DUMP ROUTINE                                   54200002
         EJECT                                                          54250002
ICFDMPRN EQU   *                                                        54300002
*  AT THIS POINT, DUMP GIVES ME ADDR OF ICFDMPRN IN REG 12 AND RETURN   54350002
*  ADDR IN REG 14. HE HAS SAVED ALL HIS OWN REGS AND CTLRS AND WILL     54400002
*  RESTORE THEM WHEN I RETURN. ALSO, I GET AN ENTRY CODE IN R15.        54450002
         LA    W6,ICFDMPRN-ICFBDE00    GET DISP OF ICFDMPRN             54500002
         SR    R12,W6        COMPUTE ADDR OF ICFBDE00                   54550002
         LM    R0,R13,ICFRSTSG    RESTORE GPRS                          54600002
*                            DON'T RESTORE 14  OR 15 AS THEY HAVE RTN   54650002
*                            ADDR AND ENTRY CODE                        54700002
         LCTL  CR0,CR15,ICFRSTSC  RESTORE CTLRS                         54750002
         LTR   R15,R15       TEST FOR ZERO RTN CODE                     54800002
         BZ    ICFWAT26      IF 0, DUMP WAS SUCCESSFUL                  54850002
         TM    ICFPTLPF,X80  IF NOT 0, CHECK FOR WARN B DONE            54900002
         BNO   ICFWAT27      IF Â¬0 AND WARN B DONE,DUMP HAS FAILED      54950002
         NI    ICFPTLPF,X7F  TURN OF 'ON WARNA' FLAG                    55000002
         ST    R14,ICFEXT99  POINT NEXT DUMP ENTRY CORRECTLY            55050002
         L     W1,ICFWBUCB   SET UP UCB ADDR                            55100002
         LA    W2,ICFTRMCA+D3     SET UP FOOTPRINT TABLE PTR            55150002
         LA    W7,ICFWBDEV   SET UP DEV ADDR PTR                        55200002
         LA    W8,ICFIOMAP   SET IOSGEN MAP PTR                         55250002
         LA    W0,D10        SET UP LOGOUT COUNTER                      55300002
         B     ICFPTCLR      GO CLEAR PATH FOR WARN B                   55350002
         EJECT                                                          55400002
ICFMAHDL EQU   *                                                        55450002
*  MALFUNCTION ALERT HANDLER                                            55500002
         LPSW  ICFWAIT7      OTHER CPU CHECKSTOPPED IN PWF CODE SO      55550002
*                            CAN'T RECOVER                              55600002
         EJECT                                                          55650002
*                                                                       55700002
*        SHOULDER TAPPING ROUTINE                                       55750002
*                                                                       55800002
*  ICFSTPSW HAS PSW POINTING TO DESIRED LOCATION                        55850002
*  ICFRSTSG IS A 16 WORD SAVE AREA FOR GPRS                             55900002
*  ICFRSTSC IS 16 WORD SAVE AREA FOR CONTROL REGS                       55950002
*                                                                       56000002
ICFSHTAP EQU   *                                                        56050002
         STM   R0,R15,ICFRSTSG    SAVE GPRS                             56100002
         STCTL CR0,CR15,ICFRSTSC  SAVE CTLRS                            56150002
         MVI   ICFDMPLK,X00  RESET TS FLAG                              56200002
         STOSM ICFMWORK,X01  ENABLE FOR EXTERNALS                       56250002
ICFLOKWT EQU   *                                                        56300002
         TM    ICFDMPLK,XFF  TEST FOR OTHER CPU AT INTERLOCK            56350002
         BNO   ICFLOKWT      IF NOT, WAIT TIL IT GETS THRU              56400002
         B     ICFDMPLL      GO TO DUMP LOCK LOOP                       56450002
         EJECT                                                          56500002
*                                                                       56550002
*        DUMP LOCK LOOP ROUTINE                                         56600002
*                                                                       56650002
*  CPU SPIN LOOP FOR MP SYSTEMS                                         56700002
ICFDMPL1 EQU   *             LOCK ENTRY POINT ON RESTART                56750002
         LA    R12,ICFDMPL1-ICFBDE00   LOAD DISPLACEMENT                56800002
         S     R12,D4        SUBTRACT ENTRY POINT (FROM RESTART PSW)    56850002
         LCR   R12,R12       FORM EP-DISP=ICFBDE00                      56900002
         STCTL CR0,CR15,ICF2CCRS  SAVE SECOND CPU'S CTLRS               56950002
         MVC   ICFCR02F(D4),ICFCR0MK   MOVE IN CR0 MASK                 57000002
         NC    ICFCR02F(D4),ICF2CCRS   'AND' IT WITH CPU2'S CR0         57050002
         OI    ICFCR02F+D2,X80    TURN ON MALFUNCTION ALERT MASK        57100002
         LCTL  CR0,CR0,ICFCR02F   INIT. CR0                             57150002
         STOSM ICFMWORK,X01  ENABLE FOR EXTERNALS                       57200002
*  NOW ENTER MAIN LOOP                                                  57250002
ICFDMPLL EQU   *                                                        57300002
*        R12 (BASE)MUST POINT TO ICFBDE00 AT THIS POINT                 57350002
         OI    ICFMFLGA,ICFCPUIL  TURN ON CPU IN LOCK FLAG              57400002
ICFLTSAG EQU   *                                                        57450002
         TS    ICFDMPLK      TEST LOCK                                  57500002
         BC    D4,ICFLTSAG   IF CC=1,WAIT IN LOOP                       57550002
         NI    ICFMFLGA,XFF-ICFCPUIL   TURN OFF IN LOCK FLAG            57600002
         STNSM ICFMWORK,X00  TURN OFF EXTERNAL INTERRUPTS               57650002
         LM    R0,R15,ICFRSTSG    RESTORE SAVED GPRS                    57700002
         LCTL  CR0,CR15,ICFRSTSC  RESTORE SAVED CTLRS                   57750002
         LPSW  ICFSTPSW      GO TO BRANCH POINT                         57800002
         EJECT                                                          57850002
*                                                                       57900002
*  ICFWAT26 AND 27 ROUTINES                                             57950002
*                                                                       58000002
ICFWAT26 EQU   *                                                        58050002
         XC    ICFWAIT(D8),ICFWAIT     CLEAR PSW                        58100002
         MVI   ICFWAIT+D7,X26     SET WAIT STATE CODE                   58150002
         B     ICFWAITC      GO TO WAIT COMMON CODE                     58200002
ICFWAT27 EQU   *                                                        58250002
         XC    ICFWAIT(D8),ICFWAIT     CLEAR WAIT PSW                   58300002
         MVI   ICFWAIT+D7,X27     SET UNSUCESSFUL WAIT CODE             58350002
ICFWAITC EQU   *                                                        58400002
         MVI   ICFWAIT+D1,X02     SET WAIT BIT                          58450002
         TM    ICFMFLGA,ICFMPSYS  TEST FOR MP SYSTEM                    58500002
         BO    ICFWATMP      IF MP, GO HANDLE IT                        58550002
         LPSW  ICFWAIT       TERMINATE THE UP SYSTEM                    58600002
ICFWATMP EQU   *                                                        58650002
*        STAP  ICFCPUAD      GET ADDR OF THIS PCPU                      58700002
         DC    X'B212'       'STAP' OP CODE                             58750002
         DC    S(ICFCPUAD)   ADDRESS                                    58800002
         XI    ICFCPUAD+D1,X01    GET ADDR OF OTHER CPU                 58850002
         USING PCCA,W2                                                  58900002
         L     W2,ICFWCPUA   GET CPU ADDRESS                            58950002
         SLL   W2,D2         ALIGN FOR FULL WORDS                       59000002
         A     W2,ICFADR2    ADD ORIGIN OF PCCAVT                       59050002
         L     W2,D0(W2)     GET LADDR OF OTHER CPU'S PCCA              59100002
         LRA   W2,D0(W2)     TRANSLATE IT                               59150002
         BZ    ICFLSTOK      IF 0, LAST TRANSLATE WAS OK                59200002
         LPSW  ICFWAIT       OTHERWISE, STOP JUST THIS CPU              59250002
ICFLSTOK EQU   *                                                        59300002
         L     W2,PCCAPSAR   GET REAL ADDR OF HIS PSA                   59350002
         DROP W2                                                        59400002
         MVC   D0(D8,W2),ICFWAIT  SET UP RESTART PSW                    59450002
         XR    W2,W2         CLEAR STATUS REG                           59500002
         L     W3,ICFWCPUA   PUT OTHER CPU'S PADDR IN REG               59550002
*        SIGP  W2,W3,PRGRST  ISSUE SIGP PROGRAM RESET (X08)             59600002
         DC    X'AE23'       'SIGP' OP CODE, R1, R3                     59650002
         DC    S(PRGRST)     ADDRESS (SIGP COMMAND CODE)                59700002
ICFWATLP EQU   *                                                        59750002
*        SIGP  W2,W3,RESTART ISSUE SIGP RESTART (X06)                   59800002
         DC    X'AE23'       'SIGP' OP CODE, R1, R3                     59850002
         DC    S(RESTART)    ADDRESS (SIGP COMMAND CODE)                59900002
         BNZ   ICFWATLP      WAIT TIL ACCEPTED                          59950002
         LPSW  ICFWAIT       FINISHED!                                  60000002
         EJECT                                                          60050002
*        PROGRAM DC'S                                                   60100002
         DS    0F                                                       60150002
ICFMFLGS DC    X'00FF0000'   FULL WORD FOR MP LOCKS AND FLAGS           60200002
ICFEFLAG EQU   ICFMFLGS      ENTRY LOCK                                 60250002
ICFDMPLK EQU   ICFMFLGS+D1   MAIN DUMP WAITING LOCK; INIT TO XFF        60300002
ICFMFLGA EQU   ICFMFLGS+D2   MVM  FLAG A BYTE                           60350002
ICF2CPUT EQU   X'01'         BIT 7 IS 2ND CPU THRU FLAG                 60400002
ICFCTDST EQU   X'02'         BIT 6 IS COMMIT TO DUMP SIGNALLED          60450002
ICFCPUIL EQU   X'04'         BIT 5 IS SECOND CPU IN DUMP LOCK LOOP      60500002
ICF2CPUA EQU   X'08'         BIT 4 IS 2ND CPU IN BDF CODE               60550002
ICFMPSYS EQU   X'10'         BIT 3 IS MP SYSTEM FLAG                    60600002
ICFBCACC EQU   X'20'         BIT 2 IS DEVICE ACCESSIBLE FROM OTHER CPU  60650002
ICFWDAC1 EQU   X'40'         BIT 1 IS WARN DS AVAIL FROM PCPU1          60700002
ICFWDAC0 EQU   X'80'         BIT 0 IS WARN DS AVAIL FROM PCPU0          60750002
ICFMWORK EQU   ICFMFLGS+D3   WORK BYTE FOR STOSM AND STNSM              60800002
ICFPTLPF DC    X'00'               PATH LOOP FLAG                       60850002
         DS 0D                                                          60900002
ICFMCPSW DC    X'00080000'   MODULE MC NPSW (EC MODE,Â¬DAT,Â¬MC)          60950002
         DC    A(ICFMCKON)                                              61000002
ICFTSTWN DC    X'000C0000'   PSW ENABLED FOR HARD MC'S                  61050002
         DC    A(ICFNOMCK)                                              61100002
ICFMCOFF DC    X'00080000'   PSW FOR CASE OF TRANSIENT                  61150002
         DC    A(ICFNOMCK+D4)                                           61200002
ICFWAIT7 DC    X'0002000000000027'     WAIT 27 PSW                      61250002
ICFDNPSW DC    X'04080000'   DAT MODE ON PSW                            61300002
         DC    A(ICFDATON)                                              61350002
ICFDFPSW DC    F'0'          DAT MODE OFF PSW                           61400002
         DC    A(ICFDATOF)                                              61450002
ICFEXPSW DC    F'0'          EXTERNAL NPSW FOR MALFUNCTION ALERTS       61500002
         DC    A(ICFMAHDL)                                              61550002
ICF2CPSW DC    F'0'          2ND CPU PSW DISABLING MC'S                 61600002
         DC    A(ICF2CMCO)                                              61650002
ICF1CEOP DC    D'0'          1ST CPU EXOPSW S.A.                        61700002
ICF1CENP DC    D'0'          1ST CPU EXNPSW S.A.                        61750002
ICF2CEOP DC    D'0'          2ND CPU EXOPSW S.A.                        61800002
ICF2CENP DC    D'0'          2ND CPU EXNPSW S.A.                        61850002
ICFWAIT  DC    D'0'          TERMINATION PSW                            61900002
ICFSTPSW DC    D'0'          SHOULDER TAP PSW                           61950002
ICFIOPSW DC    D'0'                DOUBLE WORD FOR PSW FOR I/O          62000002
ICFSNCCW DC    D'0'                DOUBLE WORD FOR SENIO CCW            62050002
ICFDOUBL DC    D'0'                DOUBLE WORD WORK AREA                62100002
ICFCHTBL DC    X'80000000'         CTLR2 MASKS (CHANNEL TABLE)          62150002
         DC    X'40000000'                                              62200002
         DC    X'20000000'                                              62250002
         DC    X'10000000'                                              62300002
         DC    X'08000000'                                              62350002
         DC    X'04000000'                                              62400002
         DC    X'02000000'                                              62450002
         DC    X'01000000'                                              62500002
         DC    X'00800000'                                              62550002
         DC    X'00400000'                                              62600002
         DC    X'00200000'                                              62650002
         DC    X'00100000'                                              62700002
         EJECT                                                          62750002
ICFMMASK DC    X'20003000'   MAP CONVERSION MASKS - BOTH PATHS OFFLINE  62800002
         DC    X'00003000'   PRIMARY ONLINE- SECONDARY OFFLINE          62850002
         DC    X'20001000'   PRIMARY OFFLINE - SECONDARY ONLINE         62900002
         DC    X'00001000'   BOTH PATHS ONLINE                          62950002
ICF0CMAP DC    F'0'          MAP FOR PCPU0                              63000002
ICF1CMAP DC    F'0'          MAP FOR PCPU1                              63050002
ICFWCPUA DC    F'0'          FULL WORD FOR CPU ADDR                     63100002
ICFCPUAD  EQU  ICFWCPUA+D2                                              63150002
ICFREALW DC    F'0'          REAL ADDR OF PWF WORK AREA                 63200002
ICF2CGRS DC    16F'0'        2ND CPU'S GPR S.A.                         63250002
ICF2CCRS DC    16F'0'        2ND CPU'S CTLR S.A.                        63300002
ICFRSTSG DC    16F'0'        16 WORD SAVE AREA FOR SHTAP GPRS           63350002
ICFRSTSC DC    16F'0'        16 WORD SAVE AREA FOR SHTAP CTLRS          63400002
ICFCPUMK DC    X'80000000'   CONST FOR FORMING CPU MASK                 63450002
ICFCR01S DC    F'0'          SAVE AREA FOR 1ST CPU'S CR0                63500002
ICFCR02F DC    F'0'          SECOND CPU WORK AREA                       63550002
ICFCR0MK DC    X'00F80000'   MASK OFF ALL BUT PAGE & SEGMENT LENGTHS    63600002
ICFSHENV DC    16F'0'              16 WORD SAVE AREA FOR MCH REGS       63650002
ICFRDISP EQU   ICFSHENV-ICFTDE00   DISPLACEMENT FOR SAVING MCH REGS     63700002
ICFALL0S DC    F'0'                FULL WORD OF ZEROS                   63750002
ICFALL1S DC    X'FFFFFFFF'         ALL 1'S FOR CTLR2 RESET              63800002
ICFCR0FX DC    F'0'                STORAGE FOR FIXING CTL REGS          63850002
ICFEXT50 DC    A(ICFBDE50)         USER EXIT ADCON                      63900002
ICFEXT99 DC    A(ICFBDE99)         NORMAL DUMP EXIT VCON                63950002
K86400   DC    F'86400'            NUMBER OF SEC PER DAY                64000002
K15625   DC    F'15625'                                                 64050002
K60      DC    F'60'                                                    64100002
HK100    DC    H'100'                                                   64150002
HK10T4   DC    H'10000'                                                 64200002
         DS    0H                                                       64250002
         DC    100X'77'            100 BYTE CE PATCH AREA               64300002
ICFSENSA DC    24X'00'             24 BYTE SAVE AREA FOR SENIO          64350002
         TITLE 'ICFBDF00 - POWER WARNING FEATURE - DUMP'                64400002
*********************************************************************** 64450002
*********************************************************************** 64500002
*                                                                     * 64550002
*                                                                     * 64600002
*  THIS ROUTINE DUMPS STORAGE ON DISK. IT TOLERATES ONE TRACK ERROR   * 64650002
*PER CYLINDER.                                                        * 64700002
*                                                                     * 64750002
*  ROUTINE WILL SWITCH TO ALTERNATE DEVICE IF--                       * 64800002
*   1.TWO TRACK ERRORS ON ONE CYLINDER.                               * 64850002
*   2.CHANNEL ERRORS (NOT DATA READ OR WRITE).                        * 64900002
*   3.DEVICE NOT AVAILABLE.                                           * 64950002
*                                                                     * 65000002
*  STORAGE IS SCANNED FOR SIZE, CONFIGURATION, AND UNCORRECTABLE      * 65050002
*ERRORS. VALIDATION IS ATTEMPTED (LIMIT 3 ATTEMPTS PER ERROR) BY      * 65100002
*WRITING ZEROES OR ONES IN THE QUADWORD INVOLVED. ACTUAL WRITE TO     * 65150002
*DISK IS EXECUTED WITH MACHINE CHECK MASK OFF.                        * 65200002
*                                                                     * 65250002
*  TERMINATIONS-PSW WAIT, IC=026, SUCCESSFUL DUMP.                    * 65300002
*               PSW WAIT, IC=027,  ALTERNATE DEVICE ALSO FAILED.      * 65350002
*                                                                     * 65400002
*  LINKAGE--PRESET BY MCK HANDLER APPENDAGE ROUTINE                   * 65450002
*           REGISTER 15, ENTRY AND BASE REGISTER (ICFBDE00)           * 65500002
*           REGISTER 13, TABLE POINTER (ICFWORKA).                    * 65550002
*                                                                     * 65600002
*********************************************************************** 65650002
         SPACE 3                                                        65700002
         EJECT                                                          65750002
         SPACE 2                                                        65800002
*** INITIALIZATION ***                                                  65850002
         SPACE 1                                                        65900002
* SET PSWS, CCWS, ETC.--ROUTINE IS MOVEABLE                             65950002
ICFBDE99 EQU   *                                                        66000002
         USING ICFBDE00,R15                                             66050002
         USING ICFBDE99,R15                                             66100002
         USING ICFWORKA,RTAB       POINTS TO ICFWORK                    66150002
         MVC   ICFNEWPG(Q8),ICFBUM SET PROG PSW                         66200002
* RTAB IS PRELOADED BY MCK HANDLER APPENDAGE ROUTINE                    66250002
         ST    R14,ICFDRTAD  SAVE RETURN ADDR                           66300002
         LA    RFP,ICFTRDMP        GET FOOTPRINT TABLE ADDRESS          66350002
         XC    Q0(Q4,RFP),Q0(RFP)  CLEAR AREA FOR USE                   66400002
*** FOOTPRINT TABLE-HALF WORD-ICFTRDMP-BIT 0 DUMP ROUTINE STARTED ***   66450002
         OI    Q0(RFP),Q80        SET                                   66500002
         LA    RM,ICFPGIN         SET NEW PGM PSW                       66550002
         ST    RM,ICFPGADR                                              66600002
         LA    RM,ICFMCKIN        SET NEW MACHINE CHECK PSW             66650002
         ST    RM,ICFMCADR                                              66700002
         LA    RM,ICFSCAN         PSW-ENABLE MACHINE CHECKS             66750002
         ST    RM,ICFMEN+4                                              66800002
         LA    RM,ICFESCAN        PSW--DISABLE MACH CKS                 66850002
         ST    RM,ICFMDIS+4                                             66900002
         LA    RM,ICFSPCH         SP KEYS UCB ADR                       66950002
         STCM  RM,M7,ICFPSEK+1    SEEK CCW                              67000002
         LA    RM,Q2(RM)                                                67050002
         STCM  RM,M7,ICFPSER+1    SERCH CCW                             67100002
         LA    RM,ICFPSER                                               67150002
         STCM  RM,M7,ICFPTIC+1    TIC TO SERCH                          67200002
         LA    RM,ICFSPCH1        2ND SEEK                              67250002
         STCM  RM,M7,ICFPSEK1+1                                         67300002
         LA    RM,Q2(RM)                                                67350002
         STCM  RM,M7,ICFPSER1+1   2ND SERCH                             67400002
         LA    RM,ICFPSER1                                              67450002
         STCM  RM,M7,ICFPTIC1+1   2ND TIC                               67500002
         LA    RM,ICF16F          CCW TO ERASE CNTL TRACK               67550002
         STCM  RM,M7,ICFT1CCW+1                                         67600002
         LA    R4,ICFWRD00   ADR OF FIRST WRITE CCW                     67650002
         ST    R4,ICFSV4     SAVE ADR                                   67700002
         MVC   ICFCCSV(Q8),Q0(R4)  SAVE CCW                             67750002
         EJECT                                                          67800002
*** INIT CONTINUE ***                                                   67850002
         SPACE 1                                                        67900002
         LA    RM,ICFCNTRK        SET CNTL CCW                          67950002
         STCM  RM,M7,ICFTWCCW+1   ADR FOR WRITE CCW                     68000002
         STCM  RM,M7,ICFTRCCW+1   ADR FOR READ CCW                      68050002
         LA    RM,ICFSDATA        SET SENSE CCW                         68100002
         STCM  RM,M7,ICFSCCW+1                                          68150002
         XC    ICFPFLAG(L'ICFPFLAG),ICFPFLAG  CLEAR PROGRAM FLAGS       68200002
         LA    RM,ICFSERCH        SEARCH ID ADR                         68250002
         STCM  RM,M7,ICFRDTIC+1   STORE IN READ TIC                     68300002
         L     RUNIT,ICFWADEV     FIRST UNIT ADDRESS                    68350002
         LA    RCH,ICFWACHR       STARTING CYLINDER                     68400002
         MVC   ICFDMPWA(Q160),ICFCHR00  SAVE UCBS                       68450002
ICFINIT2 EQU   *                                                        68500002
         MVI   ICFQFLAG,Q0        CLEAR TRK ERR FLAG                    68550002
         TM    ICFRFLAG,Q80       TEST FIRST OR SECOND ATTEMPT          68600002
         BZ    ICFINIT3           NOT SET-FIRST ATTEMPT                 68650002
         L     R4,ICFSV4     GET ADR OF FIRST WRITE CCW                 68700002
         MVC   Q0(Q8,R4),ICFCCSV       RESTORE CCW                      68750002
         L     RUNIT,ICFWBDEV     ALTERNATE DEVICE ADDRESS              68800002
         LA    RCH,ICFWBCHR       ALTERNATE CYLINDER ADR                68850002
         LA    RFP,ICFTRDMP+2     FOOTPRINT TABLE SECONDARY DEVICE      68900002
* FOOTPRINT TABLE FOR SECONDARY IS HALFWORD-ICFTRDMP+2                  68950002
         OI    Q0(RFP),Q80        START SECONDARY ATTEMPT               69000002
ICFINIT3 EQU   *                                                        69050002
         ST    RCH,ICFSVCYL       SAVE STARTING ADR                     69100002
         STCM  RCH,M7,ICFRSEEK+1  SET SEEK FOR CNTL READ                69150002
         LA    RCH,Q2(RCH)        SET ID ADR                            69200002
         STCM  RCH,M7,ICFSERCH+1                                        69250002
*** FOOTPRINT BIT 1-INITIALIZATION COMPLETE ***                         69300002
         OI    Q0(RFP),Q40                                              69350002
         BAL   RBL,ICFTIO         TEST AVAILABILITY                     69400002
         NOP   *                                                        69450002
         NOP   *                  SKIP ERRORS                           69500002
         MVC   ICFRCCW(Q8),ICFTRCCW    SET READ CCW                     69550002
         LA    RCW,ICFRSEEK       SET TO READ CNTL                      69600002
         BAL   RBL,ICFSIO         GO READ                               69650002
         NOP   *                                                        69700002
         MVC   ICFRCCW(Q8),ICFT1CCW  ERASE CNTL TRACK                   69750002
         LA    RCW,ICFRSEEK                                             69800002
         BAL   RBL,ICFSIO                                               69850002
         NOP   *                  SKIP ERRORS                           69900002
*** FOOTPRINT BIT 2-CONTROL TRACK READ AND ERASED ***                   69950002
         OI    Q0(RFP),Q20                                              70000002
         EJECT                                                          70050002
*** SCAN STOR, SIZE, CONFIGURATION, ERRORS ***                          70100002
         SPACE 1                                                        70150002
         LM    R1,R3,ICFNDEX          SCAN STORAGE FOR SIZE,            70200002
         LM    R6,R7,ICFNDEX2         CONFIGURATION AND ERRORS          70250002
         MVI   ICFZFLAG,Q0            CLEAR PGM CK FLAG                 70300002
         MVC   ICFFADR(Q4),ICFN16     PRESET FAIL ADR FOR MISCOMPARE    70350002
         LA    R4,ICFCTB11            STARTING ADDRESS BLOCK            70400002
         LA    R5,ICFCTB13            END ADR BLOCK                     70450002
         MVC   ICFNEWPG(Q16),ICFPSWS SET NEW PSWS                       70500002
         LPSW  ICFMEN                 ENABLE MACHINE CHECKS             70550002
ICFSCAN  EQU   *                                                        70600002
         ST    R1,Q0(R4)              STORE ADR IN BLOCK                70650002
         LA    RZ,ICFSCAN1        RETURN ADR                            70700002
ICFSCAN1 EQU   *                                                        70750002
         OC    Q0(Q16,R1),Q0(R1)      READ STORAGE UNTIL PGM CK         70800002
         BXLE  R1,R2,ICFSCAN1                                           70850002
         B     ICFPGIN1              MAX STORAGE                        70900002
ICFSCAN2 EQU   *                                                        70950002
         TS    Q0(R4)                FLAG LAST BLOCK USED               71000002
         LPSW  ICFMDIS               END OF SCAN                        71050002
ICFPGIN  EQU   *                     PROGRAM INTERRUPT HANDLER          71100002
         CLI   ICFTYPIN,Q5           INVALID ADDRESS?                   71150002
         BE    ICFPGIN1              YES-EXPECTED                       71200002
         LPSW  ICFBUM                NO-OTHER--TERMINATE                71250002
ICFPGIN1 EQU   *                                                        71300002
         TS    ICFZFLAG              FIRST PCK THIS BLOCK               71350002
         BM    ICFPGIN2              NO                                 71400002
         S     R1,ICFQ1                                                 71450002
         ST    R1,Q0(R5)             YES-ENDING ADDRESS                 71500002
         A     R1,ICFQ1                                                 71550002
         LA    R4,Q16(R4)            NEXT BLOCK                         71600002
         LA    R5,Q16(R5)                                               71650002
         LA    RZ,ICFPGIN3        RETURN ADR                            71700002
ICFPGIN2 EQU   *                                                        71750002
         BXH   R1,R6,ICFSCAN2     INCREMENT BY 256K OR END              71800002
         OC    Q0(Q16,R1),Q0(R1)  TRY 256K HIGHER                       71850002
ICFPGIN3 EQU   *                                                        71900002
         MVI   ICFZFLAG,Q0        NO INTERRUPT, GO READ SOME MORE       71950002
         B     ICFSCAN                                                  72000002
         EJECT                                                          72050002
* * * MACHINE CHECKS * * *                                              72100002
         SPACE 1                                                        72150002
ICFMCKIN EQU   *                                                        72200002
         TM    ICFMCIC,Q80        UNCORRECTABLE STOR ERR?               72250002
         BZ    ICFMCKIS           NO                                    72300002
         NC    ICFSFAIL(Q4),ICFN16 ALIGN QUADWORD BOUNDARY              72350002
         C     R1,ICFSFAIL        FAIL ADR SAME?                        72400002
         BNE   ICFMCKIS           NO                                    72450002
*** FOOTPRINT BIT 9-1 OR MORE UNCORRECT STORAGE ERRORS VALIDATED ***    72500002
         OI    Q1(RFP),Q40                                              72550002
         MVC   ICFVALX(Q16),ICFVAL RIPPLE VALIDATE PATTERN              72600002
         MVC   ICFVAL(Q48),ICF16F                                       72650002
         MVC   Q0(Q16,R1),ICFVAL  TRY VALIDATE-WRITE ONES OR ZEROES     72700002
         C     R1,ICFFADR         IS THIS REPEAT THIS ADR?              72750002
         BE    ICFMCKI            YES-IS IT SECOND  <<                  72800002
         MVI   ICFQFLAG,Q0                                              72850002
         ST    R1,ICFFADR         NO-SAVE ERROR ADR                     72900002
         B     ICFMCKIR           AND TRY AGAIN                         72950002
ICFMCKI  EQU   *                                                        73000002
         TS    ICFQFLAG                                                 73050002
         BZ    ICFMCKIR                                                 73100002
         AR    R1,R2              NEXT ADR                              73150002
ICFMCKIR EQU   *                                                        73200002
         ST    RZ,ICFMC4          SET RETURN ADR                        73250002
ICFMCKIS EQU   *                                                        73300002
         LPSW  ICFMCOLD           RETURN, RE-ENABLE MACH CKS            73350002
ICFESCAN EQU   *                                                        73400002
*** FOOTPRINT BIT 3-STORAGE SCAN COMPLETE ***                           73450002
         OI    Q0(RFP),Q16                                              73500002
         MVC   ICFNEWPG(Q8),ICFBUM  SET PROG PSW                        73550002
         EJECT                                                          73600002
* * * THIS SECTION DOES DUMP * * *                                      73650002
*USING REGS R1,R2,R3 INDEX UCBS, RCH CYLINDER NUMBER                    73700002
*USING REGS R5,R6,R7 INDEX STORAGE ADRS, R4 CCW POINTER                 73750002
         L      RCH,ICFSVCYL       FIRST CYLINDER--CNTL TRACK           73800002
         L      RCH,Q0(RCH)                                             73850002
         ST     RCH,ICFSPCH        SET CYL IN SP UCBS                   73900002
         ST     RCH,ICFSPCH1                                            73950002
         LA     RM,ICFCTB11                                             74000002
         MVI    ICFQFLAG,Q0        CLEAR ERROR FLAG                     74050002
         MVC   ICFCHR00(Q160),ICFDMPWA  RESTORE UCBS                    74100002
ICFRSCAN EQU    *                                                       74150002
         TM     Q0(RM),Q80         LAST BLOCK?                          74200002
         BNZ    ICFEWR1            YES--GO WRITE CNTL TRACK             74250002
         L      R5,Q0(RM)          FIRST ADDRESS                        74300002
         L      R6,ICFTRSIZ        BYTES PER TRACK                      74350002
         L      R7,Q8(RM)          END OF STORAGE                       74400002
         LA     R2,Q8              INCREMENT UCBS BY 8                  74450002
         LA     R3,Q160            8X20 TRACKS                          74500002
         LA     R1,ICFCHR00        ADR FIRST UCB                        74550002
         AR     R3,R1                                                   74600002
         LA     RCH,Q1(RCH)        INCREASE CYL BY 1                    74650002
         STH    RCH,Q4(RM)         SET CYL FIRST BLOCK                  74700002
         XC    D6(D2,RM),D6(RM)   ZERO TRACK FIRST BLOCK                74750002
         B      ICFWSET1                                                74800002
ICFWSET  EQU    *                                                       74850002
         LA     RCH,Q1(RCH)        INCREASE CYL BY 1                    74900002
         STH    RCH,Q12(RM)        SET CYL LAST BLOCK                   74950002
ICFWSET1 EQU    *                                                       75000002
         LA     R1,ICFCHR00        FIRST UCB                            75050002
ICFWSET2 EQU    *                                                       75100002
         ST     RCH,Q0(R1)         SET CYL ADR IN 20 UCBS               75150002
         BXLE   R1,R2,ICFWSET2                                          75200002
         LA     R4,ICFWRD00        FIRST CCW                            75250002
         SR     RZ,RZ              TRACK COUNTER                        75300002
         B      ICFWSET4                                                75350002
ICFWSET3 EQU    *                                                       75400002
         LA     R4,Q32(R4)                                              75450002
         EJECT                                                          75500002
***DUMP CONTINUE ***                                                    75550002
         SPACE 2                                                        75600002
ICFWSET4 EQU    *                                                       75650002
         STCM   R5,M7,Q1(R4)       SET ADR IN WRITECCCW                 75700002
         STH    RZ,Q14(RM)         COUNT TRACKS                         75750002
         A      RZ,ICFQ1                                                75800002
         BXH    R5,R6,ICFEBLK      END OF STORAGE BLOCK                 75850002
         TM     Q4(R4),Q40         LAST CCW AND TRACK                   75900002
         BO     ICFWSET3           NO-SETNEXT CCW                       75950002
         MVC    ICFCCSV(Q8),Q0(R4) SAVE LAST USED CCW                   76000002
         ST    R4,ICFSV4     SAVE ADR OF LAST CCW USED                  76050002
         LA     RCW,ICFSEK00       YES-WRITE CYLINDER                   76100002
         BAL    RBL,ICFSIO                                              76150002
         BAL    RBL,ICFWOK         WRITE WAS OK                         76200002
         BAL    RBL,ICFWNOK        WRITE IN ERROR                       76250002
*** FOOTPRINT BIT 4-1 OR MORE CYLINDERS WRITTEN ***                     76300002
         OI     Q0(RFP),Q8                                              76350002
         B      ICFWSET            NEXT CYLINDER                        76400002
         SPACE 1                                                        76450002
ICFEBLK  EQU    *                  END STORAGE BLOCK                    76500002
         SR     R5,R7              GET STORAGE OVERRUN                  76550002
         S     R5,ICFQ1                                                 76600002
         SR     R6,R5              COMPUTE NEW COUNT                    76650002
         MVC    ICFCCSV(Q8),Q0(R4) SAVE CCW                             76700002
         ST    R4,ICFSV4     SAVECCW ADR                                76750002
         STH    R6,Q6(R4)          SET COUNT IN CCW                     76800002
         MVI    Q4(R4),Q20         TURN OFF COMMAND CHAIN               76850002
         LA     RCW,ICFSEK00       WRITE LAST(PARTIAL)CYLINDER          76900002
         BAL    RBL,ICFSIO                                              76950002
         BAL    RBL,ICFWOK        WRITE OK                              77000002
         BAL    RBL,ICFWNOK       NOT OK                                77050002
         MVC    Q0(Q8,R4),ICFCCSV  RESTORE LAST CCW                     77100002
         LA     RM,Q16(RM)         NEXT STORAGE BLOCK                   77150002
         B      ICFRSCAN                                                77200002
         EJECT                                                          77250002
* * * WRITE CONTROL TRACK * * *                                         77300002
         SPACE 2                                                        77350002
ICFEWR1  EQU    *                  WRITE CONTROL TRACK                  77400002
*** FOOTPRINT BIT 5-DATA WRITE COMPLETE ***                             77450002
         OI     Q0(RFP),Q4                                              77500002
         OI     ICFCTFLA,Q80      SET FLAG FOR SUCCESS                  77550002
         MVC   ICFCTDAT(D8),ICFLRDAT  PUT DATE & TIME IN CTRL TRACK     77600002
         MVC   ICFCTPXR(D4),ICFPXREG PUT CONTENTS OF PREFIX REG IN      77650002
*                                  CONTROL TRACK                        77700002
ICFEWR1A EQU    *                                                       77750002
         L      R1,ICFSVCYL     GET CNTL TRACK LOCATION                 77800002
         L      R3,ICFTPC       GET NUMBER OF TRACKS                    77850002
         S      R3,ICFQ3        LESS 3                                  77900002
ICFEWR2  EQU    *                                                       77950002
         MVC    ICFRCCW(Q8),ICFTWCCW CHANGE READ CCW TO WRITE           78000002
         STCK   ICFCTED            ENDING TIME                          78050002
         LA     RCW,ICFRSEEK       WRITE CONTROL TRACK                  78100002
         BAL    RBL,ICFSIO                                              78150002
         B      ICFENRD            FINISHED                             78200002
* * * ERROR WHILE WRITTING CNTL TRACK * * *                             78250002
         MVC    ICFRCCW(Q8),ICFT1CCW  ERASE CNTL TRACK                  78300002
         LA     RCW,ICFRSEEK         BY WRITING 4 FF'S                  78350002
         BAL    RBL,ICFSIO           AND ZEROES                         78400002
         NOP    *                  IGNORE ERRORS                        78450002
         L      R2,Q4(R1)          GET HEAD NUMBER                      78500002
         A      R2,ICF10000        UPDATE HEAD BY 1                     78550002
         ST     R2,Q4(R1)          SAVE                                 78600002
         BCT    R3,ICFEWR2         TRY WRITING AGAIN                    78650002
*** FOOTPRINT BIT 14-FAILED TO WRITE CONTROL TRACK ***                  78700002
         OI    Q1(RFP),Q2                                               78750002
         B      ICFBOMB            NO MORE TRACKS-QUIT                  78800002
        SPACE 1                                                         78850002
* * * ALL WRITE DATA TRACKS RETURN HERE * * *                           78900002
         SPACE 1                                                        78950002
ICFWOK   EQU   *            * * * WRITE WAS OK * * *                    79000002
         STM   RBL,RCH,ICFRBLSV   SAVE REGS                             79050002
         LA    RCH,ICFCTCF        CYLINDER FLAGS                        79100002
ICFWOK1  EQU   *                                                        79150002
         TM    Q0(RCH),QC         TEST IF FLAG BEEN USED                79200002
         BZ    ICFWOK2            NO                                    79250002
         LA    RCH,Q1(RCH)        LOOK AT NEXT ONE                      79300002
         B     ICFWOK1                                                  79350002
ICFWOK2  EQU   *                                                        79400002
         OI    Q0(RCH),Q40        SET FLAG USED                         79450002
         LM    RBL,RCH,ICFRBLSV   RESTORE REGS                          79500002
         B     Q4(RBL)            RETURN                                79550002
         EJECT                                                          79600002
ICFWNOK  EQU   *   * * * ERROR HANDLER * * * WRITE NO GOOD              79650002
*** FOOTPRINT BIT 10-RETRYING WRITE USING SPARE TRACK ***               79700002
         OI    Q1(RFP),Q20                                              79750002
         STM   RBL,RCH,ICFRBLSV   SAVE REGS                             79800002
         L     R1,ICFSVCSW        GET CCW ADR                           79850002
ICFWNOK1 EQU   *                                                        79900002
         S     R1,ICFQ8            LOOK AT FAILING CCW                  79950002
         CLI   Q0(R1),M7           ADJUST TO POINT AT SEEK              80000002
         BNE   ICFWNOK1                                                 80050002
         L     R1,Q0(R1)           GET UCB ADR                          80100002
         LA    RCH,ICFCTCF         CYL FLAG                             80150002
ICFWNOK2 EQU   *                                                        80200002
         TM    Q0(RCH),QC          LOOK FOR UNUSED CYL FLAG             80250002
         BZ    ICFWNOK3            FOUND                                80300002
         LA    RCH,Q1(RCH)        NOT FOUND, LOOK MORE                  80350002
         B     ICFWNOK2                                                 80400002
ICFWNOK3 EQU   *                                                        80450002
         MVC   Q0(Q1,RCH),Q5(R1) STORE TRACK IN ERROR                   80500002
         OI    Q0(RCH),Q80       FLAG IT BAD                            80550002
         OI    ICFCTFLA,Q4       SET DUMP FLAG AS BAD TRACK             80600002
         STH   RZ,Q14(RM)         STORE LAST TRACK USED                 80650002
         LA    RCH,ICFCHR19+8    ADR OF LAST UCB+8                      80700002
         SR    RCH,R1            COMPUTE NUMBER OF BYTES TOMOVE         80750002
         EX    RCH,ICFMOVE       MOVE UCBS TO SKIP ONE TRACK            80800002
         LA    RCW,ICFSEK00      REWRITE CYL                            80850002
         BAL   RBL,ICFSIO                                               80900002
         B     ICFW2OK          SECOND WRITE OK                         80950002
         TS    ICFQFLAG         NOT OK-FLAG 2 BAD TRACKS                81000002
ICFW2OK  EQU   *                                                        81050002
         NI    Q1(RFP),QC         CLEAR CURRENT FOOTPRINT               81100002
         MVC   ICFCHR00(Q160),ICFDMPWA  RESTORE UCBS                    81150002
         LM    RBL,RCH,ICFRBLSV   RESTORE REGS                          81200002
         TM    ICFQFLAG,Q80       TWO ERRORS                            81250002
         BZR   RBL                NO                                    81300002
*** FOOTPRINT BIT 13-TWO TRACK ERRORS ON 1 CYLINDER ***                 81350002
         OI    Q1(RFP),Q4                                               81400002
         MVC   Q0(Q8,R4),ICFCCSV  YES--RESTORE CCW                      81450002
         MVI   ICFCTFLA,Q8      SETFLAG PARTIAL                         81500002
         B     ICFEWR1A         GO WRITE CNTL                           81550002
ICFMOVE  MVC   Q0(Q0,R1),Q8(R1) MOVE UCBS * *EXECUTE* *                 81600002
         EJECT                                                          81650002
***DUMP STOR PROT KEYS ***                                              81700002
         SPACE 1                                                        81750002
ICFENRD  EQU    *                  CNTL TRACK WAS WRITTEN               81800002
*** FOOTPRINT BIT 6-CONTROL TRACK WRITTEN ***                           81850002
         OI     Q0(RFP),Q2                                              81900002
         TM     ICFQFLAG,Q8        TWO TRACK ERROR                      81950002
         BO     ICFBOMB            TES-GO TO SECONDARY                  82000002
         OI     ICFSIO2+1,C'0'     SET SUCCESSFUL END SWITCH            82050002
         L      R2,Q4(R1)          GET HEAD NUMBER                      82100002
         A      R2,ICF10000     BUMP HEAD BY 1                          82150002
         ST     R2,ICFSPCH+4       SET IN UCB                           82200002
         A      R2,ICF10000     NEXT HEAD                               82250002
         ST     R2,ICFSPCH1+4      2ND UCB                              82300002
         L      R1,ICFCTB13    GET END STORAGE                          82350002
         A     R1,ICFQ1                                                 82400002
ICFSP    EQU    *                                                       82450002
         S      R1,ICF4K       SUBTRACT 4096                            82500002
         STCM   R1,M7,ICFPCCW1+1 SET SECOND WR CCW                      82550002
         S      R1,ICF4K       SUB 4096                                 82600002
         STCM   R1,M7,ICFPCCW+1  SET FIRST CCW                          82650002
         NOP    ICFSP1         SWITCH IF SP OVERLAPS PROG               82700002
         OI     *-3,C'0'                                                82750002
         LR     R3,R1                                                   82800002
         S      R3,ICF4K                                                82850002
         CR     R3,R15         IS SP OVERLAP PROG                       82900002
         BNL    ICFSP1         NO                                       82950002
         LR     R1,R15         YES--PUT SP AREA BELOW PROG              83000002
         B      ICFSP                                                   83050002
ICFSP1   EQU    *                                                       83100002
         LA     R2,Q1                                                   83150002
         LA     RM,ICFCTB11     GET FIRST ADDRESS                       83200002
ICFSP2   EQU    *                                                       83250002
         TM     Q0(RM),Q80       LAST BLOCK?                            83300002
         BNZ    ICFSP4           YES                                    83350002
         L      R5,Q0(RM)        FIRST ADR                              83400002
         L      R6,ICF2K         INCREMENT 2 K                          83450002
         L      R7,Q8(RM)        LAST ADR                               83500002
ICFSP3   EQU    *                                                       83550002
         ISK    RZ,R5            READ KEY                               83600002
         STC    RZ,Q0(R1)        STORE                                  83650002
         AR     R1,R2            UPDATE STORE ADR                       83700002
         BXLE   R5,R6,ICFSP3     NEXT KEY                               83750002
         LA     RM,Q16(RM)       NEXT BLOCK                             83800002
         B      ICFSP2                                                  83850002
ICFSP4   EQU    *                                                       83900002
         TS     Q0(R1)         END SP KEYS                              83950002
         LA     RCW,ICFPSEK                                             84000002
* * * GO SIO--WRITE SP KEYS * * *                                       84050002
         EJECT                                                          84100002
* * * START I/O ROUTINE * * *                                           84150002
         SPACE 1                                                        84200002
ICFSIO   EQU   *                  EXPECTS CAW IN RCW                    84250002
*** FOOTPRINT BIT 11-IN I/O SUBROUTINE ***                              84300002
         OI    Q1(RFP),Q16                                              84350002
         MVI   ICFSFLAG,Q0        CLEAR SENSE FLAG                      84400002
ICFSIO0  EQU   *                 UNIT ADR IN RUNIT                      84450002
         ST    RCW,ICFCAW        CCW ADR IN CAW                         84500002
ICFSIO1  EQU   *                                                        84550002
         SIO   Q0(RUNIT)         ISSUE START I/O-UNIT ADR IN RUNIT      84600002
ICFSIO2  EQU   *     AFTER CNTL TRACK WRITTEN SUCESSFUL END             84650002
         NOP   ICFPGEND     NEXT I/O OP                                 84700002
         BC    BUSY,ICFSIO1      CC=2, BUSY GO LOOP SIO                 84750002
         BC    STAT,ICFSSIO      CC=4, STATUS STORED GO CKECK           84800002
         BC    NOTAV,ICFBOMBX    CC=3, NOT AVAILABLE TERMINATE          84850002
ICFTIO   EQU   *                                                        84900002
         OI    Q1(RFP),Q16                                              84950002
         TIO   Q0(RUNIT)         ISSUE TEST I/O                         85000002
         BC    BUSY,ICFTIO       BUSY, LOOP                             85050002
         BC    STAT,ICFSTIO       STATUS STORED GO CHECK                85100002
         BC    NOTAV,ICFBOMBX     NOT AVAILABLE                         85150002
         NI    Q1(RFP),QE         CLEAR CURRENT FOOTPRINT               85200002
         BR    RBL                CLEAR--RETURN                         85250002
ICFSSIO  EQU   *                                                        85300002
         TM    ICFCSW+4,Q40       TEST FOR STATUS MODIFIER              85350002
         BO    ICFSIO1            CONTROL UNIT BUSY                     85400002
ICFSTIO  EQU   *                                                        85450002
         TM    ICFSFLAG,QFF  IS SENSE FOR UNIT CHECK IN PROGRESS?       85500002
         BO    ICFBOMB       IF SO, TRY OTHER EXTENT                    85550002
*  IF THIS WAS A SENSE,CSW+D4 SHOULD SHOW CE/DE,BUT EVEN IF IT          85600002
*  WASN'T, MUST SEE IF ANOTHER EXTENT IS AVAILABLE.                     85650002
         L     RCW,Q63F           ANY ENDING STATUS?                    85700002
         N     RCW,ICFCSW+4                                             85750002
         BZ    ICFTIO             NO-LOOP                               85800002
         TM    ICFCSW+5,Q3F       ANY CHANNEL ERRORS?                   85850002
         BNZ   ICFBOMBX           YES-GO TERMONATE                      85900002
         TM    ICFCSW+4,Q2        UNIT CHECK?                           85950002
         BZ    ICFTIO             NO-CLEAR AND RETURN                   86000002
* * * UNIT CHECK * * *                                                  86050002
*** FOOTPRINT BIT 8-1 OR MORE UNIT CHECKS OCCURRED ***                  86100002
         OI    Q1(RFP),Q80                                              86150002
         TS    ICFSFLAG           FIRST OR SECOND UNIT CHECK            86200002
         BM    ICFBOMB                                                  86250002
*** FOOTPRINT BIT 12-DOING SENSE OP ***                                 86300002
         OI    Q1(RFP),Q8                                               86350002
         MVC   ICFSVCSW(L'ICFSVCSW),ICFCSW  SAVE OLD CSW                86400002
         LA    RBL,Q4(RBL)        SET ERROR RETURN                      86450002
         LA    RCW,ICFSCCW        SET FOR SENSE                         86500002
         B     ICFSIO0            GO PERFORM SENSE                      86550002
         EJECT                                                          86600002
ICFBOMBX EQU   *                                                        86650002
*** FOOTPRINT BIT 15-CHANNEL CKS. OR DEVICE NOT OPERATIVE ***           86700002
         OI    Q1(RFP),Q1                                               86750002
ICFBOMB  EQU   *      * * * THIS EXTENT HAS HAD IT * * *                86800002
         TS    ICFRFLAG           SET FLAG                              86850002
         STM   R0,R15,ICFBOMSG    SAVE REGS FOR NEXT ENTRY              86900002
         STCTL CR0,CR15,ICFBOMSC  SAVE CTLRS FOR NEXT ENTRY             86950002
         L     R12,ICFDRTAD  LOAD BRANCH ADDR                           87000002
         LA    R14,ICFBDE98  LOAD RETURN ADDR                           87050002
         LA    R15,D4        LOAD RC OF 4                               87100002
         BR    R12           RETURN TO MCH APPENDAGE                    87150002
ICFBDE98 EQU   *                                                        87200002
*  AT THIS ENTRY, R15 CONTAINS ADDR OF ICFBDE98                         87250002
         LA    R6,ICFBDE98-ICFBDE99    GET DISPLACEMENT OF ICFBDE98     87300002
         SR    R15,R6        FORM ICFBDE98-(ICFBDE98-ICFBDE99)=ICFBDE99 87350002
*  NOW BASE IS SET UP                                                   87400002
         LM    R0,R15,ICFBOMSG    RESTORE REGS                          87450002
         LCTL  CR0,CR15,ICFBOMSC  RESTORE CTLRS                         87500002
         B     ICFINIT2      GO HANDLE SECOND EXTENT                    87550002
         SPACE 1                                                        87600002
ICFPGEND EQU   *                                                        87650002
*** FOOTPRINT BIT 7-SP KEYS READ, WRITTEN, DUMP COMPLETE ***            87700002
         OI    Q0(RFP),Q1                                               87750002
         L     R12,ICFDRTAD  GET APPENDAGE RETURN ADDR                  87800002
         XR    R15,R15       SET RETURN CODE                            87850002
         BR    R12           RETURN TO APPENDAGE FOR TERMINATION        87900002
         SPACE 2                                                        87950002
* * * DOUBLE WORD CONSTANTS * * *                                       88000002
*     '*' CONSTANTS MUST BE CONTIGUOS                                   88050002
         SPACE 1                                                        88100002
ICFRSEEK CCW   7,0,X'60',6       *SEEK FOR READ, WRITE, ERASE           88150002
ICFSERCH CCW   X'31',0,X'60',5   *SEARCH ID EQUAL                       88200002
ICFRDTIC CCW   8,0,X'60',0       *TIC                                   88250002
ICFRCCW  CCW   6,0,X'20',512     *CCW FOR CONTROL TRACK                 88300002
ICFSCCW  CCW   4,0,X'20',24       SENSE                                 88350002
ICFT1CCW CCW   5,0,X'20',4        ERASE CCW--WRITE 4 'FF'S              88400002
ICFTRCCW CCW   6,0,X'20',512      READ CCW                              88450002
ICFTWCCW CCW   5,0,X'20',512      WRITE CCW                             88500002
ICFPSEK  CCW   7,0,96,6          *SEEK FOR SP KEYS                      88550002
ICFPSER  CCW   49,0,96,5         *SERCH ID                              88600002
ICFPTIC  CCW   8,0,96,0          *TIC TO SERCH                          88650002
ICFPCCW  CCW   5,0,96,4096       *WRITE 4096 SP KEYS                    88700002
ICFPSEK1 CCW   7,0,96,6          *2ND SEEK SP                           88750002
ICFPSER1 CCW   49,0,96,5        *SERCH ID                               88800002
ICFPTIC1 CCW   8,0,96,0         *TIC TO SERCH                           88850002
ICFPCCW1 CCW   5,0,32,4096      *WRITE 2ND 4096 SP KEYS                 88900002
ICFSPCH  DC    X'0000CCCC00000100' *UCB FOR SP KEYS                     88950002
ICFSPCH1 DC    X'0000CCCC00000100' *2ND UCB                             89000002
ICFTOD   DC    1D'0'              STARTING TIME                         89050002
ICFCCSV  DC    1D'0'               CCW SAVER                            89100002
ICFRBLSV DC    1D'0'               REG SAVER                            89150002
ICFVAL   DC    2D'0'              *STORAGE VALIDATION PATTERN           89200002
ICF16F   DC    16X'FF'            *2ND PATTERN                          89250002
ICFEPAT0 DC    2XL8'0002000000004000' *3RD PATTERN                      89300002
ICFVALX  DC    2D'0'                 *PATTERN RIPPLER                   89350002
ICFSVCSW DC    1D'0'                  CSW SAVER                         89400002
ICFBUM   DC    X'0002000000000027'  WAIT-CODE INVALID DUMP              89450002
ICFDMPDN DC    X'0002000000000026' WAIT-CODE VALID DUMP                 89500002
ICFMEN   DC    X'0004000000000000'  ENABLE MACHINE CHECKS               89550002
ICFMDIS  DC    X'0000000000000000'  DISABLE MACH CKS                    89600002
         EJECT                                                          89650002
* * * FULL WORD CONSTANTS * * *                                         89700002
         SPACE 1                                                        89750002
ICFPSWS  DC    X'00040000'       *PROGRAM NEW                           89800002
ICFPGADR DC    F'0'              *ADDRESS                               89850002
         DC    F'0'              *MACHINE NEW                           89900002
ICFMCADR DC    F'0'              *ADDRESS                               89950002
ICFQ1    DC    F'1'                                                     90000002
ICFQ3    DC    F'3'                                                     90050002
ICFQ8    DC    F'8'                                                     90100002
ICF2K    DC    F'2048'                                                  90150002
ICF4K    DC    F'4096'                                                  90200002
ICFNDEX  DC    F'0'  *                                                  90250002
         DC    F'16'  *                                                 90300002
         DC    X'00FFFFFF'  *                                           90350002
ICFNDEX2 DC    F'262144'  *                                             90400002
         DC    X'00FFFFFF'  *                                           90450002
ICFN16   DC    X'00FFFFF0'                                              90500002
ICFSVCYL DC    F'0'                                                     90550002
ICFFADR  DC    F'0'                                                     90600002
ICFSV4   DC    F'0'                                                     90650002
Q63F     DC    X'063F0000'       END STATUS CONSTANT                    90700002
ICF10000 DC    X'00010000'        HEAD INCREMENTER                      90750002
ICFBOMSG DC    16F'0'        16 WORD GPR SAVE AREA                      90800002
ICFBOMSC DC    16F'0'        16 WORD CTLR SAVE AREA                     90850002
ICFDRTAD DC    F'0'          RETURN ADDR FOR APPENDAGE                  90900002
ICFPFLAG DC    F'0'              PROGRAM FLAGS                          90950002
ICFRFLAG EQU   ICFPFLAG           1ST EXTENT FAIL FLAG                  91000002
ICFSFLAG EQU   ICFPFLAG+1         UNIT CHECK FLAG                       91050002
ICFZFLAG EQU   ICFPFLAG+2         PROGRAM CHECK FLAG                    91100002
ICFQFLAG EQU   ICFPFLAG+3         TWO TRACKS ERROR FLAG                 91150002
ICFSDATA DC    24X'0'                                                   91200002
* * * PATCH AREA * * *                                                  91250002
ICFPATCH DS    25F                                                      91300002
ICFBDE50 EQU   *                                                        91350002
*        INSERT USER ROUTINE HERE                                       91400002
         XR    R15,R15           ZAP RETURN CODE                        91450002
         BR    R14               RETURN                                 91500002
         EJECT                                                          91550002
* * * EQUATES * * *                                                     91600002
RFP      EQU   14                                                       91650002
RTAB     EQU   13                TABLE POINTER-DSECT BASE               91700002
RUNIT    EQU   12                UNIT ADDRESS                           91750002
RCH      EQU   11                CYLINDER REFERENCE                     91800002
RBL      EQU   10                BRANCH AND LINK                        91850002
RCW      EQU   9                 CCW ADDRESS                            91900002
RM       EQU   8                  MISC USE                              91950002
RZ       EQU   0                                                        92000002
NOTAV    EQU   1                  CC=3                                  92050002
BUSY     EQU   2                  CC=2                                  92100002
STAT     EQU   4                  CC=1                                  92150002
Q16      EQU   16                                                       92200002
ICFNEWPG EQU   X'68'                                                    92250002
M7       EQU   7                                                        92300002
Q2       EQU   2                                                        92350002
Q1       EQU   1                                                        92400002
Q0       EQU   0                                                        92450002
Q40      EQU   X'40'                                                    92500002
Q3F      EQU   X'3F'                                                    92550002
Q4       EQU   4                                                        92600002
ICFCAW   EQU   72                  CAW ADDRESS                          92650002
ICFCSW   EQU   64                  CSW                                  92700002
ICFMCIC  EQU   X'EA'               THIRD BYTE OF MCIC          @ZA00510 92750003
Q80      EQU   X'80'                                                    92800002
ICFSFAIL EQU   248                                                      92850002
Q48      EQU   48                                                       92900002
ICFMC4   EQU   X'34'                                                    92950002
ICFTYPIN EQU   43                                                       93000002
Q8       EQU   8                                                        93050002
Q160     EQU   160                                                      93100002
Q6       EQU   6                                                        93150002
Q20      EQU   X'20'                                                    93200002
Q32      EQU   32                                                       93250002
Q5       EQU   5                                                        93300002
Q12      EQU   12                                                       93350002
QFF      EQU   X'FF'                                                    93400002
Q14      EQU   14                                                       93450002
QC       EQU   X'C0'                                                    93500002
QE       EQU   X'E0'                                                    93550002
ICFMCOLD EQU   48                                                       93600002
ICFEND   EQU   *                                                        93650002
         EJECT                                                          93700002
         ICFWORK                                                        93750002
         EJECT                                                          93800002
ICFCVTOR DSECT                                                          93850002
         CVT                                                            93900002
         EJECT                                                          93950002
         IHACSD                                                         94000002
         EJECT                                                          94050002
         IHAPCCA                                                        94100002
         EJECT                                                          94150002
         IEFUCBOB                                                       94200002
         IECDLCH                                                        94250002
         EJECT                                                          94300002
         IECDCAT                                                        94350002
         EJECT                                                          94400002
ICFBDE00 CSECT               RESUME CONTROL SECTION                     94450002
          END                                                           94500002
./  ADD  SSI=32251285,NAME=ICFBDX00
         TITLE 'ICFBDX00 - DUMMY M.C.H. APPENDAGE'                      03000002
*********************************************************************** 06000002
*                                                                     * 09000002
* FUNCTION-IMMEDIATELY RETURN CONTROL TO THE CALLING MCH MODULE       * 18000002
*                                                                     * 27000002
*********************************************************************** 30000002
         SPACE 5                                                        33000002
ICFBDE00 CSECT                                                          36000002
R14      EQU   14             .RETURN REGISTER                          39000002
R15      EQU   15             .RETURN CODE REGISTER                     42000002
         SPACE 5                                                        45000002
         SR    R15,R15        .SET RETURN CODE TO ZERO                  48000002
         BR    R14            .RETURN TO CALLER                         51000002
         END                                                            54000002
./  ADD  SSI=80610030,NAME=ICFBIF00
ICFBIF00 TITLE 'POWER WARNING FEATURE INITIALIZATION MODULE'            00040002
*********************************************************************** 00080002
*                                                                     * 00120002
*   THIS MODULE IS PART OF THE POWER WARNING FEATURE SUPPORT            00160002
*                                                                     * 00200002
*                                                                     * 00240002
*                                                                     * 00280002
* FUNCTION - A. CHECK THE PWF TIME PARAMETER IN THE CVT TO SEE IF THE * 00320002
*               FUNCTION IS SUPPORTED.                                * 00360002
*                                                                     * 00400002
*            B. GETMAIN A 2K COMMUNICATION AREA FROM SUBPOOL 245 AND  * 00440002
*               STORE ITS ADDRESS IN THE CVT.                         * 00480002
*                                                                     * 00520002
*            C. ADJUST TIME PARAMETER ACCORDING TO ENGINEERING SPECS  * 00560002
*               AND SAVE IT IN THE COMMUNICATION AREA.                * 00600002
*                                                                     * 00640002
*            D. IF T=1 SPECIFIED SET 'COMMIT TO DUMP' FLG IN COMM.AREA* 00680002
*               AND NOTIFY THE OPERATOR THAT DUMP WILL OCCUR ON FIRST * 00720002
*               WARNING.                                              * 00760002
*                                                                     * 00800002
*            E. LOCATE THE WARN DATASETS. MAKE SURE THAT EACH WARN    * 00840002
*               DATASET RESIDES ON A SINGLE VOLUME AND THAT BOTH OF   * 00880002
*               THEM DON'T RESIDE ON THE SAME VOLUME.                 * 00920002
*                                                                     * 00960002
*            F. DYNAMICALLY ALLOCATE THE WARN DATASETS, THEN          * 01000002
*               FIND THE UCB'S FOR THE WARN DATASETS. MAKE SURE THEY  * 01040002
*               ARE D.A.DEVICES, UPS SUPPORTED AND OF THE SAME TYPE.  * 01080002
*                                                                     * 01120002
*            G. USING THE DEVTYPE MACRO                               * 01160002
*                     GET THE PHYSICAL CHARACTERISTICS OF THE DEVICE  * 01200002
*               ON WHICH THE WARN DATASETS RESIDE. SAVE THESE DATA IN * 01240002
*               THE COMM.AREA.                                        * 01280002
*                                                                     * 01320002
*            H. OPEN THE WARN DATASETS AND GET THE START AND SIZE OF  * 01360002
*               THE EXTENT FROM THE DEB. SAVE THE START OF EXTENT IN  * 01400002
*               THE COMM.AREA.                                        * 01440002
*                                                                     * 01480002
*            I. FROM THE CVT GET THE STORAGE SIZE AND MAKE SURE THAT  * 01520002
*               BOTH DATASETS ARE LARGE ENOUGH TO CONTAIN ALL STORAGE.* 01560002
*                                                                     * 01600002
*            J. READ THE CONTROL TRACK. MAKE SURE THE DATASET IS EMPTY* 01640002
*               BY CHECKING THE APPROPRIATE FLAG IN THE CNTL TRK.     * 01680002
*                                                                     * 01720002
*            K. IF MORE THAN 24 HOURS HAVE ELAPSED SINCE THE LAST     * 01760002
*               FORMATTING OF THE DATASETS, REFORMAT THEM.            * 01800002
*                                                                     * 01840002
*            L. INITIALIZE AND WRITE THE CONTROL TRACK TO REFLECT THE * 01880002
*               ENVIRONMENT AT THIS IPL.                              * 01920002
*            M. FIND AN AVAILABLE PATH TO THE WARN DEVICE (VIA IOSGEN * 01960002
*               MACRO) AND SAVE DEVICE ADDRESS AND UCB ADDRESS IN THE * 02000002
*               COMM.AREA.                                            * 02040002
*                                                                     * 02080002
*            N. COMPLETE INITIALIZATION OF THE COMM.AREA BY SETTING   * 02120002
*               UP THE CCW CHAIN (FOR FULL CYLINDER WRITE) AND THE    * 02160002
*               SEEK/SEARCH ADDRESSES FOR THE DUMP ROUTINE.           * 02200002
*                                                                     * 02240002
*            O. SET 'VOLUME BIT' IN THE WARN UCB'S. FLAG THE WARN UCBS* 02280002
*               'PERMANENTLY RESIDENT'.                               * 02320002
*                                                                     * 02360002
*            P. RESET THE 'WARN NOT INITIALIZED' FLAG IN THE CVT AND  * 02400002
*               TURN ON THE WARNING MASK IN CONTROL REGISTER 14.      * 02440002
*                                                                     * 02480002
*            Q. WRITE THE 'PWF INITIALIZATION COMPLETE' MESSAGE AND   * 02520002
*               RETURN TO THE CALLING MODULE.                         * 02560002
*                                                                     * 02600002
*            R. IF A WARN DATASET CONTAINS A VALID DUMP, ASK THE      * 02640002
*               OPERATOR IF HE WANTS TO RESTORE STORAGE OR ERASE THE  * 02680002
*               DUMP FROM THE DATASET.                                * 02720002
*                                                                     * 02760002
*            S. IF THE OPERATOR REQUESTS A RESTORE MAKE SURE THAT     * 02800002
*               THE STORAGE CONFIGURATION PRESENTLY ONLINE IS NOT     * 02840002
*               SMALLER THAN THE ONE ONLINE AT DUMP TIME, SET UP THE  * 02880002
*               INTERFACE TO THE RESTORE ROUTINE AND GIVE IT CONTROL  * 02920002
*               IN B.C.MODE, FULLY DISABLED AND WITH S.P.K.=0.        * 02960002
*                                                                     * 03000002
*            T. IF ANY UNUSUAL CONDITION IS ENCOUNTERED, NOTIFY THE   * 03040002
*               OPERATOR GIVING HIM THE CHOICE OF CONTINUING SYSTEM   * 03080002
*               OPERATION WITHOUT PWF SUPPORT OR TO STOP THE SYSTEM,  * 03120002
*               CORRECT THE PROBLEM AND RE-IPL.                       * 03160002
*                                                                     * 03200002
*            U. MAINTAIN AN INTERNAL 'FOOTPRINT TABLE'.               * 03240002
*                                                                     * 03280002
*                                                                     * 03320002
*                                                                     * 03360002
* ENTRY -    THE ONLY ENTRY TO THIS MODULE IS ICFBIE00.               * 03400002
*                                                                     * 03440002
*                                                                     * 03480002
*                                                                     * 03520002
* INPUT -    REGISTER 14 CONTAINS RETURN ADDRESS.                     * 03560002
*            CVTVOLF2 = 'WARN NOT INITIALIZED' FLAG.                  * 03600002
*            CVTVOLT2 = USER SUPPLIED TIME PARAMETER.                 * 03640002
*                                                                     * 03680002
*                                                                     * 03720002
*                                                                     * 03760002
* OUTPUT -   CVTVOLF2 RESET TO ZERO.                                  * 03800002
*            CVTVOLT2 CONTAINING ADDRESS OF PWF COMMUNICATION AREA.   * 03840002
*            WARN UCB'S MARKED AS 'PERMANENTLY RESIDENT' AND WITH     * 03880002
*               THE VOLUME BIT SET.                                   * 03920002
*            PWF COMMUNICATION AREA FULLY INITIALIZED.                * 03960002
*            WARN DATASETS FORMATTED AND WITH INITIALIZED CONTROL TRK.* 04000002
*                                                                     * 04040002
*                                                                     * 04080002
*                                                                     * 04120002
* EXTERNAL                                                            * 04160002
*  ROUTINES- GETMAIN.                                                 * 04200002
*            WTO.                                                     * 04240002
*            FREEMAIN.                                                * 04280002
*            WTOR.                                                    * 04320002
*            WAIT.                                                    * 04360002
*            STIMER.                                                  * 04400002
*            LOCATE.                                                  * 04440002
*            OBTAIN.                                                  * 04480002
*            DEVTYPE.                                                 * 04520002
*            OPEN.                                                    * 04560002
*            EXCP.                                                    * 04600002
*            CLOSE.                                                   * 04640002
*            IGF01MMM.                                                * 04680002
*            ESTAE.                                                   * 04720002
*                                                                     * 04760002
*                                                                     * 04800002
*                                                                     * 04840002
* REGISTER                                                            * 04880002
*  USAGE -   REGISTER 10 - BASE FOR COMMUNICATION AREA.               * 04920002
*                     11 - FIRST BASE FOR MODULE.                     * 04960002
*                     12 - SECOND BASE FOR MODULE.                    * 05000002
*                     13 - BASE FOR REGISTER SAVE AREA AND WORK AREA. * 05040002
*                     14 - RETURN REGISTER AND WORK REGISTER.         * 05080002
*                     15 - BASE FOR RESTORE ROUTINE AND WORK.         * 05120002
*                                                                     * 05160002
*                                                                     * 05200002
*                                                                     * 05240002
* MACROS -   GETMAIN.                                                 * 05280002
*            WTO.                                                     * 05320002
*            FREEMAIN.                                                * 05360002
*            IOSGEN.                                                  * 05400002
*            WTOR.                                                    * 05440002
*            WAIT.                                                    * 05480002
*            STIMER.                                                  * 05520002
*            LOCATE.                                                  * 05560002
*            OBTAIN.                                                  * 05600002
*            DEVTYPE.                                                 * 05640002
*            OPEN.                                                    * 05680002
*            EXCP.                                                    * 05720002
*            CLOSE.                                                   * 05760002
*            DCB.                                                     * 05800002
*            CAMLST.                                                  * 05840002
*            CVT.                                                     * 05880002
*            ICFWORK.                                                 * 05920002
*            IEFUCBOB.                                                * 05960002
*            IKJTCB.                                                  * 06000002
*            DCBD.                                                    * 06040002
*            IEZDEB.                                                  * 06080002
*            IEZJSCB.                                                 * 06120002
*            IEFTIOT1.                                                * 06160002
*            IECDLCH.                                                 * 06200002
*            IHAPSA.                                                  * 06240002
*            IECDCAT.                                                 * 06280002
*            IHAPCCA.                                                 * 06320002
*            IHACSD.                                                  * 06360002
*            IHASDWA.                                                 * 06400002
*            ESTAE.                                                   * 06440002
*            SETRP.                                                   * 06480002
*                                                                     * 06520002
*                                                                     * 06560002
* STATUS -                                                              06600000
*          APARS FIXED @ZA00760,@ZA00521,@ZA30392                       06610003
*                                                                       06612003
*       R 256800-257200                                        @ZA30392 06614003
*                                                                       06620000
*********************************************************************** 06640002
         SPACE 5                                                        06680002
ICFBIE00 CSECT                                                          06720002
         SPACE 5                                                        06760002
*              REGISTER EQUATES                                         06800002
         SPACE                                                          06840002
R0       EQU   0                                                        06880002
R1       EQU   1                                                        06920002
R2       EQU   2                                                        06960002
R3       EQU   3                                                        07000002
R4       EQU   4                                                        07040002
R5       EQU   5                                                        07080002
R6       EQU   6                                                        07120002
R7       EQU   7                                                        07160002
R8       EQU   8                                                        07200002
R9       EQU   9                                                        07240002
R10      EQU   10            *BASE FOR ICFWORKA                         07280002
R11      EQU   11            *BASE FOR MODULE                           07320002
R12      EQU   12            *SECOND BASE FOR MODULE                    07360002
R13      EQU   13            *BASE FOR REGISTER SAVE AREA & WORK AREA   07400002
R14      EQU   14            *RETURN REGISTER                           07440002
R15      EQU   15                                                       07480002
         SPACE 3                                                        07520002
*              DECIMAL EQUATES                                          07560002
         SPACE                                                          07600002
D0       EQU   0                                                        07640002
D1       EQU   1                                                        07680002
D2       EQU   2                                                        07720002
D3       EQU   3                                                        07760002
D4       EQU   4                                                        07800002
D5       EQU   5                                                        07840002
D6       EQU   6                                                        07880002
D7       EQU   7                                                        07920002
D8       EQU   8                                                        07960002
D9       EQU   9                                                        08000002
D10      EQU   10                                                       08040002
D11      EQU   11                                                       08080002
D12      EQU   12                                                       08120002
D13      EQU   13                                                       08160002
D15      EQU   15                                                       08200002
D16      EQU   16                                                       08240002
D18      EQU   18                                                       08280002
D20      EQU   20                                                       08320002
D23      EQU   23                                                       08360002
D24      EQU   24                                                       08400002
D25      EQU   25                                                       08440002
D26      EQU   26                                                       08480002
D27      EQU   27                                                       08520002
D28      EQU   28                                                       08560002
D30      EQU   30                                                       08600002
D32      EQU   32                                                       08640002
D33      EQU   33                                                       08680002
D34      EQU   34                                                       08720002
D35      EQU   35                                                       08760002
D36      EQU   36                                                       08800002
D37      EQU   37                                                       08840002
D39      EQU   39                                                       08880002
D40      EQU   40                                                       08920002
D43      EQU   43                                                       08960002
D44      EQU   44                                                       09000002
D46      EQU   46                                                       09040002
D48      EQU   48                                                       09080002
D56      EQU   56                                                       09120002
D76      EQU   76                                                       09160002
D119     EQU   119                                                      09200002
D127     EQU   127                                                      09240002
D128     EQU   128                                                      09280002
D223     EQU   223                                                      09320002
D244     EQU   244                                                      09360002
D380     EQU   380                                                      09400002
D2047    EQU   2047                                                     09440002
D4095    EQU   4095                                                     09480002
D12288   EQU   12288                                                    09520002
         SPACE 3                                                        09560002
*              CHARACTER EQUATES                                        09600002
         SPACE                                                          09640002
CA       EQU   C'A'                                                     09680002
CB       EQU   C'B'                                                     09720002
CBLK     EQU   C' '                                                     09760002
         SPACE 3                                                        09800002
*              HEXADECIMAL EQUATES                                      09840002
         SPACE                                                          09880002
X00      EQU   X'00'                                                    09920002
X01      EQU   X'01'                                                    09960002
X02      EQU   X'02'                                                    10000002
X04      EQU   X'04'                                                    10040002
X05      EQU   X'05'                                                    10080002
X06      EQU   X'06'                                                    10120002
X07      EQU   X'07'                                                    10160002
X08      EQU   X'08'                                                    10200002
X0C      EQU   X'0C'                                                    10240002
X0F      EQU   X'0F'                                                    10280002
X10      EQU   X'10'                                                    10320002
X20      EQU   X'20'                                                    10360002
X31      EQU   X'31'                                                    10400002
X40      EQU   X'40'                                                    10440002
X50      EQU   X'50'                                                    10480002
X60      EQU   X'60'                                                    10520002
X7F      EQU   X'7F'                                                    10560002
X80      EQU   X'80'                                                    10600002
X87      EQU   X'87'                                                    10640002
X8C      EQU   X'8C'                                                    10680002
XDF      EQU   X'DF'                                                    10720002
XEE      EQU   X'EE'                                                    10760002
XF0      EQU   X'F0'                                                    10800002
XF9      EQU   X'F9'                                                    10840002
XFC      EQU   X'FC'                                                    10880002
XFE      EQU   X'FE'                                                    10920002
XFF      EQU   X'FF'                                                    10960002
         EJECT                                                          11000002
         STM   R14,R12,D12(R13)   *SAVE REGS IN ATTACHOR'S SAVE AREA    11040002
         LR    R11,R15       *LOAD BASE REGISTER FOR MODULE             11080002
         USING ICFBIE00,R11,R12     *ESTABLISH MODULE ADDRESSABILITY    11120002
         LA    R12,D4095(R11)     *LOAD SECOND BASE                     11160002
         LA    R12,D1(R12)   *REGISTER FOR MODULE                       11200002
         GETMAIN R,LV=ICFDSSIZ    *GETMAIN SAVE & WORK AREA             11240002
         ST    R1,D8(R13)    *FORWARD CHAINING OF SAVE AREAS            11280002
         ST    R13,D4(R1)    *BACKWARD CHAINING OF SAVE AREAS           11320002
         LR    R13,R1        *INITIALIZE POINTER TO OUR SAVE AREA       11360002
         USING ICFTIFDS,R13  *ESTABLISH ADDRESSABILITY TO WORK AREA     11400002
*****************************************************************       11440002
         XC    ICFESTPR(ICFPRMLS-ICFESTPR),ICFESTPR  *CLEAN ESTAE PARM  11480002
         LA    R10,ICFINRTR  *GET ADDRESS OF ERROR RETURN 1             11520002
         ST    R10,ICFESTPR  *SAVE IT IN ESTAE PARM AREA                11560002
         LA    R10,ICFEREX   *GET ADDRESS OF ERROR RETURN 2             11600002
         ST    R10,ICFESTPR+D4    *SAVE IT IN ESTAE PARM AREA           11640002
         LA    R10,ICFFREMB  *GET ADDRESS OF ERROR RETURN 3             11680002
         ST    R10,ICFESTPR+D8    *SAVE IT IN ESTAE PARM AREA           11720002
         LA    R10,ICFESTPR  *GET POINTER TO ESTAE PARAM AREA           11760002
         ESTAE ICFESTAE,CT,PARAM=(R10),RECORD=YES  *SETUP ESTAE ENV.    11800002
*****************************************************************       11840002
         GETMAIN R,LV=2048,SP=245      *GETMAIN COMMUNICATION AREA      11880002
         LR    R10,R1        *SAVE POINTER TO COMMUNICATION AREA        11920002
         USING ICFWORKA,R10  *ESTABLISH COMM.AREA ADDRESSABILITY        11960002
         MVI   ICFFLAGA,X80  *SET 'FUNCTION INOPER.' FLAG IN COMM.AREA  12000002
         L     R14,CVTPTR    *GET CVT POINTER                           12040002
         USING CVT,R14       *ESTABLISH CVT ADDRESSABILITY              12080002
         L     R8,CVTCSD     *GET REAL ADDRESS OF CSD                   12120002
         LRA   R8,D0(R8)     *DITTO                                     12160002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  12200002
         ST    R8,ICFADR3    *SAVE IT IN COMM. AREA                     12240002
         L     R8,CVTPCCAT   *GET REAL ADDRESS OF PCCA VECTOR TABLE     12280002
         LRA   R8,D0(R8)     *DITTO                                     12320002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  12360002
         ST    R8,ICFADR2    *SAVE IT IN COMM. AREA                     12400002
         L     R8,CVTTCBP    *GET POINTER TO NEW/OLD TCB                12440002
         MVC   ICFTCBSV,D4(R8)    SAVE OUR TCB ADDRESS                  12480002
         MVC   ICFLRDAT,CVTDATE   *COPY DATE TO COMM. AREA              12520002
         XC    ICFLRTIM,ICFLRTIM  *SET TIME TO ZERO IN COMM. AREA       12560002
         STIDP ICFLRCPU      *STORE CPU ID IN COMM. AREA                12600002
         L     R8,CVTDCB     *GET POINTER TO LOGREC DCB                 12640002
         S     R8,CF8        *LOGREC DCB - 8 CONTAINS POINTER           12680002
         L     R8,D0(R8)     *TO CHANNEL ASSIGNMENT TABLE               12720002
         MVC   ICFLRCHA,D0(R8)    *SAVE CHAN ASSGNMNT TBL IN COMM.AREA  12760002
         MVC   ICFFLAGB,CVTDCB    *COPY SYSTEM TYPE TO COMM.AREA        12800002
         LA    R8,CVTVOLF2-CVTTCBP  *GET DISPLACEMENT FOR MVT,SVM,MVM   12840002
         L     R9,D0(R8,R14) *GET CONTENTS OF OUR CVT SLOT              12880002
         ST    R10,D0(R8,R14) *SET PNTR TO COMM.AREA IN OUR CVT SLOT    12920002
         AR    R8,R14        *GET ADDR. OF OUR CVT SLOT                 12960002
         NI    D0(R8),X7F         *RESET 'WARN NOT INIT.' FLAG IN CVT   13000002
         XC    ICFTRMSA(D12),ICFTRMSA  *CLEAR FOOTPRINT TABLE           13040002
         LA    R8,ICFTRMSA   *GET ADDRESS OF FOOTPRINT TABLE            13080002
         ST    R8,ICFADR1    *SAVE IT IN FIRST SLOT OF COMM.AREA        13120002
         ST    R13,ICFTRDMP  ***SAVE PTR TO WORKAREA FOR DEBUG*******   13160002
******************************************************************      13200002
         OI    ICFTRMSA+D0,X80    *UPDATE FOOTPRINT TABLE***********    13240002
******************************************************************      13280002
         ST    R11,ICFADR4   *SAVE MODULE E.P.A. IN COMM.AREA           13320002
         DROP  R14                                                      13360002
         SPACE 3                                                        13400002
*        THIS COMPLETES THE INITIAL HOUSEKEEPING                        13440002
         SPACE 3                                                        13480002
         LA    R9,D0(R9)     *GET RID OF FLAG                           13520002
         LTR   R9,R9         *IS WARN FUNCTION INOPERATIVE?             13560002
         BZ    ICFSFI        *YES, GO SET FLAG FOR OTHER MODULES        13600002
         BCTR  R9,R0         *GET CORRECT TIME IN MSEC                  13640002
         ST    R9,ICFTME00   *SAVE IT IN COMM AREA                      13680002
         LTR   R9,R9         *WAS ORIGINAL TIME 1?                      13720002
         BZ    ICFCMTDP      *YES, GO SEND MESSAGE                      13760002
ICFSEMTD EQU   *                                                        13800002
         C     R9,ICFEMTD    *IS SPECIFIED T N.L.THAN ENG.MINIMUM?      13840002
         BNL   ICFSKCCW      YES, SPECIFIED T IS OK                     13880002
         MVC   ICFTME00,ICFEMTD   *NO, SET T TO ENGINEERING MINIMUM     13920002
******************************************************************      13960002
         OI    ICFTRMSA+D0,X40    *UPDATE FOOTPRINT TABLE***********    14000002
******************************************************************      14040002
         SPACE 5                                                        14080002
ICFSKCCW EQU   *             *BUILD SKELETON OF CCW CHAIN IN WORK AREA  14120002
         LRA   R9,ICFCHR00   *GET SK/SRCH REAL ADDRESS                  14160002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  14200002
         ST    R9,ICFCCW1    *STORE IN SEEK CCW                         14240002
         LA    R9,D2(R9)     *GET SEARCH REAL ADDRESS                   14280002
         ST    R9,ICFCCW2    *STORE IN SEARCH CCW                       14320002
         LRA   R9,ICFSRC00   *GET TIC REAL ADDRESS                      14360002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  14400002
         ST    R9,ICFCCW3    *STORE IN TIC CCW                          14440002
         SR    R9,R9         *ZERO FOR DATA ADDRESS                     14480002
         ST    R9,ICFCCW4    *STORE IN WRITE CCW                        14520002
         LA    R9,D6         *COUNT FOR SEEK                            14560002
         ST    R9,ICFCCW1+D4 *STORE IN SEEK CCW                         14600002
         LA    R9,D5         *COUNT FOR SEARCH                          14640002
         ST    R9,ICFCCW2+D4 *STORE IN SEARCH CCW                       14680002
         LA    R9,D1         *COUNT FOR TIC                             14720002
         ST    R9,ICFCCW3+D4 *STORE IN TIC CCW                          14760002
         MVI   ICFCCW1,X07   *SEEK COMMAND IN PLACE                     14800002
         MVI   ICFCCW1+D4,X60     *CC & SLI FLAGS IN PLACE              14840002
         MVI   ICFCCW2,X31   *SEARCH COMMAND IN PLACE                   14880002
         MVI   ICFCCW2+D4,X60     *FLAGS IN PLACE                       14920002
         MVI   ICFCCW3,X08   *TIC COMMAND IN PLACE                      14960002
         MVI   ICFCCW3+D4,X60     *FLAGS IN PLACE                       15000002
         MVI   ICFCCW4,X05   *WRITE COMMAND IN PLACE                    15040002
         MVI   ICFCCW4+D4,X40     *CC FLAG IN PLACE                     15080002
         EJECT                                                          15120002
*        LOCATE SYS1.WARN DATASETS AND DYNAMICALLY ALLOCATE THEM,    *  15160002
*                                      OPEN THEM, CHCK THE           *  15200002
*        CONTROL TRACKS, WRITE FORMAT AND CLOSE THEM.                *  15240002
*        ALSO FIND PATH STATUS AND UPDATE COMMUNICATION AREA.        *  15280002
         SPACE                                                          15320002
         MVI   ICFDSN,CBLK   *CLEAN DSN AREA FOR LOCATE                 15360002
         MVC   ICFDSN+D1(D43),ICFDSN   *DITTO                           15400002
         MVC   ICFDSN(D9),CCWARN  *BUILD DSN FOR LOCATE                 15440002
         MVI   ICFDSN+D9,CA  *SET DSN FOR LOCATE TO WARNA               15480002
******************************************************************      15520002
         OI    ICFTRMSA+D0,X02    *UPDATE FOOTPRINT TABLE*************  15560002
****************************************************************        15600002
         BAL   R8,ICFWRNCH   *GO TO CHECKOUT SUBROUTINE                 15640002
         SPACE 3                                                        15680002
         ST    R7,ICFWAUCB   *SAVE WARNA UCB ADDR IN COMM AREA          15720002
         LA    R5,ICFIOMAP   *PREPARE TO FIND AVAILABLE PATH            15760002
         LR    R8,R13        *SAVE POINTER TO OUR SAVE & WORK AREA      15800002
         LA    R13,D12(R13)  *ADJUST POINTER TO SAVE AREA FOR IOSGEN    15840002
         BAL   R14,ICFNDPTH  *GO FIND AVAILABLE PATH                    15880002
         LR    R13,R8        *RESET POINTER TO OUR SAVE & WORK AREA     15920002
******************************************************************      15960002
         OI    ICFTRMSA+D2,X08    *UPDATE FOOTPRINT TABLE*************  16000002
******************************************************************      16040002
         XC    ICFWADEV,ICFWADEV  *CLEAN ICFWADEV FIELD                 16080002
         LA    R7,ICFWADEV   *PREPARE TO CHECK WARNA PATHS              16120002
         BAL   R8,ICFSDADD   *GO CHECK WARNA PATHS                      16160002
         MVC   ICFWACHR(D6),ICFDEBCH   *SAVE INITIAL CCHH IN COMM AREA  16200002
         MVI   ICFWACHR+D6,X01    *SET INITIAL R = 1 IN COMM AREA       16240002
******************************************************************      16280002
         OI    ICFTRMSA+D2,X04    *UPDATE FOOTPRINT TABLE*************  16320002
******************************************************************      16360002
         EJECT                                                          16400002
*        REPEAT SAME PROCEDURE FOR SYS1.WARNB.                       *  16440002
         SPACE                                                          16480002
         MVI   ICFDSN+D9,CB  *SET DSN FOR LOCATE TO WARNB               16520002
******************************************************************      16560002
         OI    ICFTRMSA+D0,X01    *UPDATE FOOTPRINT TABLE*************  16600002
******************************************************************      16640002
         BAL   R8,ICFWRNCH   *GO TO CHECKOUT SUBROUTINE                 16680002
         SPACE 3                                                        16720002
         ST    R7,ICFWBUCB   *SAVE UCB ADDRESS IN COMM AREA             16760002
         LA    R5,ICFIOMAP   *PREPARE TO FIND AVAILABLE PATH            16800002
         LR    R8,R13        *SAVE POINTER TO OUR SAVE & WORK AREA      16840002
         LA    R13,D12(R13)  *ADJUST POINTER TO SAVE AREA FOR IOSGEN    16880002
         BAL   R14,ICFNDPTH  *GO FIND AVAILABLE PATH                    16920002
         LR    R13,R8        *RESET POINTER TO OUR SAVE & WORK AREA     16960002
******************************************************************      17000002
         OI    ICFTRMSA+D2,X08    *UPDATE FOOTPRINT TABLE*************  17040002
******************************************************************      17080002
         XC    ICFWBDEV,ICFWBDEV  *CLEAN ICFWBDEV FIELD                 17120002
         LA    R7,ICFWBDEV   *PREPARE TO CHECK WARNB PATHS              17160002
         BAL   R8,ICFSDADD   *GO CHECK WARNB PATHS                      17200002
         MVC   ICFWBCHR(D6),ICFDEBCH   *SAVE INITIAL CCHH IN COMM AREA  17240002
         MVI   ICFWBCHR+D6,X01    *SET INITIAL R = 1 IN COMM. AREA      17280002
******************************************************************      17320002
         OI    ICFTRMSA+D2,X08    *UPDATE FOOTPRINT TABLE*************  17360002
******************************************************************      17400002
         EJECT                                                          17440002
*        THIS SECTION COMPLETES THE INITIALIZATION OF THE            *  17480002
*         COMMUNICATION AREA.                                        *  17520002
         SPACE 3                                                        17560002
         L     R9,ICFTRSIZ   *GET TRACK SIZE                            17600002
         ST    R9,ICFCCW4+D4 *COMPLETE SKELETON CCWS. COUNT IN WRT CCW  17640002
         MVI   ICFCCW4+D4,X40     *CC FLAG IN PLACE                     17680002
         L     R9,ICFTPC     *GET TRACKS PER CYLINDER                   17720002
         BCTR  R9,R0         *LESS 1                                    17760002
         LA    R8,ICFSEK00   *POINT TO CCW CHAIN IN COMM AREA           17800002
ICFCCWLP EQU   *             *SET CCW CHAIN IN COMMUNICATION AREA       17840002
         MVC   D0(D32,R8),ICFCCW1 *COPY ONE SET OF CCWS                 17880002
         L     R7,ICFCCW1    *GET SEEK ADRESS FROM SEEK CCW             17920002
         A     R7,CF8        *UPDATE IT                                 17960002
         ST    R7,ICFCCW1    *SET IT BACK                               18000002
         A     R7,CF2        *UPDATE SRC ADDRESS                        18040002
         ST    R7,ICFCCW2    *STORE IT IN SRCH CCW                      18080002
         MVI   ICFCCW2,X31   *DON'T FORGET COMMAND                      18120002
         L     R7,ICFCCW3    *GET TIC ADDRESS                           18160002
         A     R7,CF32       *UPDATE IT                                 18200002
         ST    R7,ICFCCW3    *SET IT BACK                               18240002
         LA    R8,D32(R8)    *POINT TO NEXT SET OF CCWS                 18280002
         BCT   R9,ICFCCWLP   *REPEAT IF NOT FINISHED                    18320002
         S     R8,CF32       *GO BACK TO LAST CCW SET                   18360002
         MVI   D28(R8),X00   *BREAK CCW CHAIN - CC FLAG OFF             18400002
******************************************************************      18440002
         OI    ICFTRMSA+D0,X20    *UPDATE FOOTPRINT TABLE***********    18480002
******************************************************************      18520002
         MVC   ICFCHR,ICFWACHR    *INITIALIZE SET OF SK/SRC ADDRESSES   18560002
         MVI   ICFCHR+D7,X00 *CLEAN LOW ORDER BYTE                      18600002
         L     R9,ICFTPC     *GET TRACKS PER CYLINDER                   18640002
         BCTR  R9,R0         *LESS 1                                    18680002
         LA    R8,ICFCHR00   *POINT TO FIRST SK/SRC ADDR FIELD          18720002
ICFCHRLP EQU   *                                                        18760002
         MVC   D0(D8,R8),ICFCHR   *FILL IN SK/SRC ADDRESS               18800002
         L     R7,ICFCHR+D4  *GET HHHHRR00                              18840002
         A     R7,CF65536    *UPDATE HHHH BY 1                          18880002
         ST    R7,ICFCHR+D4  *STORE IT BACK                             18920002
         LA    R8,D8(R8)     *UPDATE POINTER TO NEXT SK/SRC ADDR FLD    18960002
         BCT   R9,ICFCHRLP   *REPEAT IF NOT FINISHED                    19000002
******************************************************************      19040002
         OI    ICFTRMSA+D0,X10    *UPDATE FOOTPRINT TABLE***********    19080002
******************************************************************      19120002
         SR    R8,R8         *CONVERT                                   19160002
         L     R9,ICFTME00   *ORIGINAL                                  19200002
         M     R8,CF1000     *TIME IN                                   19240002
         SLDL  R8,D12        *TOD CLOCK                                 19280002
         STM   R8,R9,ICFTME01     *UNITS AND SAVE                       19320002
ICFRTRN  EQU   *             *WRITE INITIALIZATION COMPLETE MESSAGES    19360002
         B     ICFNXMSG      *PETE DOESN'T WANT THIS MESSAGE            19400002
         LA    R1,ICFEXTMS   *VOLUME+START-OF-EXTENT MESSAGE            19440002
         WTO   MF=(E,(1))                                               19480002
ICFNXMSG EQU   *                                                        19520002
         USING UCBD,R7       *ESTABLISH UCB ADDRESSABILITY              19560002
         L     R7,ICFWAUCB   *GET WARNA UCB                             19600002
         OI    UCBTYP+D1,X02 *SET VOLUME BIT FOR DDR                    19640002
         NI    SRTESTAT,XDF  *RESET RESERVED BIT IN UCB                 19680002
         OI    SRTESTAT,X04  *SET PERM.RES. BIT IN UCB                  19720002
         L     R7,ICFWBUCB   *GET WARNB UCB                             19760002
         OI    UCBTYP+D1,X02 *SET VOLUME BIT FOR DDR                    19800002
         NI    SRTESTAT,XDF  *RESET RESERVED BIT IN UCB                 19840002
         OI    SRTESTAT,X04  *SET PERM.RES. BIT IN UCB                  19880002
         DROP  R7                                                       19920002
******************************************************************      19960002
         OI    ICFTRMSA+D0,X08    *UPDATE FOOTPRINT TABLE***********    20000002
******************************************************************      20040002
         LA    R1,ICFICMSG   *INITIALIZATION COMPLETE MESSAGE           20080002
         WTO   MF=(E,(R1))                                              20120002
         NI    ICFFLAGA,X7F  *RESET 'FUNCTION INOP.' FLAG IN COMM.AREA  20160002
         STCTL R14,R14,ICFSV8     *GET CONTENTS OF OUR CONTROL REG. 14  20200002
         TM    ICFSV8,X01    *IS WARNING BIT ON?                        20240002
         BZ    ICFWRHIT      *NO, GO SEND 'WARNING BEFORE INIT' MSG     20280002
         EJECT                                                          20320002
ICFRTRN2 EQU  *              *RETURN SEQUENCE                           20360002
******************************************************************      20400002
         OI    ICFTRMSA+D0,X04    *UPDATE FOOTPRINT TABLE***********    20440002
******************************************************************      20480002
         LR    R1,R13        *GET POINTER TO SAVE & WORK AREA           20520002
         L     R13,D4(R13)   *GET BACWARD POINTER                       20560002
         FREEMAIN R,LV=ICFDSSIZ,A=(1)                                   20600002
*****************************************************************       20640002
         ESTAE 0             *CANCEL ESTAE ENVIRONMENT                  20680002
*****************************************************************       20720002
         L     R15,ICFTIFRC  *SET RETURN CODE                           20760002
         L     R14,D12(R13)  *RESTORE RETURN REG                        20800002
         LM    R0,R12,D20(R13)    *RESTORE OTHER REGISTERS              20840002
         BR    R14           *RETURN                                    20880002
         EJECT                                                          20920002
ICFNDPTH EQU   *             *FIND AVAILABLE PATH                       20960002
         IOSGEN MAP,TABLE=(R5),UCB=(R7),VAR=1                           21000002
         SPACE 5                                                        21040002
ICFSDADD EQU   *         *SET DEVICE ADDR.AND PATH FLAGS IN ICFWXDEV    21080002
         CLC   D2(D2,R5),CF1 *PRIMARY PATH ONLINE ON EITHER CPU?        21120002
         BNE   ICFPAXX       *YES, GO SEE ON WHICH CPU                  21160002
         LA    R5,D4(R5)     *NO, TRY SECONDARY PATHS                   21200002
         CLC   D2(D2,R5),CF1 *SECONDARY PATH ONLINE ON EITHER CPU?      21240002
         BE    ICFPNA        *NO, GO SEND MESSAGE                       21280002
ICFPAXX  EQU   *                                                        21320002
         TM    D2(R5),X01    *PATH ONLINE ON CPU 0?                     21360002
         BNO   ICFSOPC1      *NO, GO SET 'PATH ON CPU 1' FLAG           21400002
         OI    D1(R7),X01    *SET 'PATH ON CPU 0' FLAG                  21440002
         TM    D3(R5),X01     *PATH ONLINE ON CPU 1?                    21480002
         BNO   ICFSDEVA      *NO, GO SAVE DEVICE ADDRESS                21520002
ICFSOPC1 EQU   *                                                        21560002
         OI    D1(R7),X02    *SET 'PATH ON CPU 1' FLAG                  21600002
ICFSDEVA EQU   *                                                        21640002
         MVC   D2(D2,R7),D0(R5)   *SAVE DEVICE ADDRESS IN ICFWXDEV      21680002
         BR    R8            *BACK WHERE WE CAME FROM                   21720002
         SPACE 5                                                        21760002
ICFSFI   EQU   *             *TELL OPERATOR FUNCTION IS INOPERATIVE     21800002
         LA    R8,ICFINPMS   *MSG TEXT POINTER                          21840002
         LA    R5,ICFINRTR   *RETURN ADDR                               21880002
         B     ICFMSGR       *TO MESSAGE ROUTINE                        21920002
         SPACE 5                                                        21960002
ICFCMTDP EQU   *                                                        22000002
         OI    ICFFLAGA,X40  *SET COMMIT TO DUMP FLAG                   22040002
         LA    R8,ICFCTDMS   *LOAD MSG POINTER                          22080002
         BAL   R5,ICFMSGR    *GO TO MSG ROUT                            22120002
         LA    R1,ICFCTDM    *PREPARE COMMIT TO DUMP MSG                22160002
         WTO   MF=(E,(R1))                                              22200002
         B     ICFSEMTD      *BACK TO MAINLINE                          22240002
         SPACE 5                                                        22280002
ICFPNA   EQU   *                                                        22320002
         LA    R8,ICFPNAMS   *LOAD MSG POINTER                          22360002
         LA    R5,ICFINRTR   *PREPARE FOR RETURN                        22400002
         B     ICFMSGR       *TO MSG ROUT                               22440002
         SPACE 5                                                        22480002
ICFINRTR EQU   *             *'FUNCTION INOPERATIVE' RETURN             22520002
         OI    ICFFLAGA,X80  *SET FUNCTION INOPERATIVE FLAG             22560002
         LA    R1,ICFQUITM   *GET POINTER TO MSG                        22600002
         WTO   MF=(E,(R1))                                              22640002
         B     ICFRTRN2      *BACK TO MASTER SCHEDULER INITIALIZATION   22680002
         SPACE 5                                                        22720002
ICFWRHIT EQU   *                                                        22760002
         LA    R1,ICFWHMSG   *GET POINTER TO 'WARNING BEFOR INIT' MSG   22800002
         WTO   MF=(E,(1))    *SEND THE MESSAGE OUT                      22840002
         B     ICFWAITR      *GO QUIT WITH CODE 027                     22880002
         SPACE 5                                                        22920002
ICFMSGR  EQU   *             *WTOR MESSAGE ROUTINE                      22960002
         MVC   ICFMSWRD(D43),D0(R8)    *SET MESSAGE IN WTOR             23000002
ICFMSGR2 EQU   *              * RE-WRITE MESSAGE               @ZA00521 23010000
         LA    R1,ICFWTOR    *GET MSG POINTER                           23040002
         XC    ICFANSW(D4),ICFANSW     *CLEAN REPLY AREA                23080002
         MVC   ICFWTOR+D1(D3),ICFANSAD *PUT REPLY AREA ADDR IN WTOR     23120002
         MVC   ICFWTOR+D4(D4),ICFREPAD *SET ECB ADDR IN WTOR            23160002
         XC    ICFREPLY,ICFREPLY  *ZERO ECB                             23200002
         WTOR  MF=(E,(R1))                                              23240002
         WAIT  ECB=ICFREPLY  *WAIT FOR REPLY                            23280002
         OC    ICFANSW,C4BLK *XLATE TO UPPER CASE                       23320002
         CLC   ICFANSW(D4),CCGO   *IS REPLY GO?                @ZA00521 23360000
         BCR   D8,R5         *YES, GO BACK TO CALLER                    23400002
         CLC   ICFANSW(D4),CCSTOP *Q. IS REPLY STOP?           @ZA00521 23450000
         BE    ICFWAITR           *YES, STOP WITH 027 WAIT     @ZA00521 23460000
         B     ICFMSGR2           *REPLY INVALID - REISSUE MSG @ZA00521 23470000
         EJECT                                                          23480002
ICFWRNCH EQU   *                                                        23520002
         ST    R8,ICFSV8     *SAVE REG 8                                23560002
         LOCATE ICFWVOL      *LOCATE SYS1.WARNX DATASET                 23600002
         LTR   R15,R15       *WAS LOCATE SUCCESSFUL?                    23640002
         BNZ   ICFNCVOL      *NO, GO SEND MSG                           23680002
*****************************************************************       23720002
         OI    ICFTRMSA+D1,X80    *UPDATE FOOTPRINT TABLE************** 23760002
*****************************************************************       23800002
         CLC   ICFNVOL,CH1   *MORE THAN 1 VOLUME?                       23840002
         BNE   ICFMULTV      *YES, GO SEND MSG                          23880002
         CLC   ICFVOLS,ICFPREV    *ON SAME VOLUME AS OTHER DATASET?     23920002
         BE    ICFSAMV       *YES, GO SEND MSG                          23960002
         MVC   ICFPREV,ICFVOLS    *SAVE VOLSER FOR NEXT TIME AROUND     24000002
         MVC   ICFTUDSN+D15(D1),ICFDSN+D9  *SET CORRECT DSN FOR DYNALL  24040002
         MVC   ICFTUDDN+D12(D1),ICFDSN+D9  *SET CORRECT DDN FOR DYNALL  24080002
         MVC   ICFPDSIN+D6(D1),ICFDSN+D9   *SET CORRECT DDN FOR DEVTYP  24120002
*  THE FOLLOWING CODE IS TEMPORARY UNTIL MAST SCHED DYNALL IS FIXED     24160002
         L     R6,ICFTCBSV   *GET OUR TCB ADDRESS                       24200002
         USING TCB,R6        *ESTABLISH TCB ADDRESSABILITY              24240002
         L     R7,TCBJSCB    *GET OUR JSCB ADDRESS                      24280002
         ST    R7,ICFJSCBS   *SAVE IT FOR LATER                         24320002
         USING IEZJSCB,R7    *ESTABLISH JSCB ADDRESSABILITY             24360002
         MVC   ICFJSTCS,JSCBTCBP  *SAVE ORIGINAL JSCBTCBP               24400002
         ST    R6,JSCBTCBP   *SET MAST.SCHED. TCB ADDR.INTO JSCBTCBP    24440002
         DROP  R6,R7                                                    24480002
*  END OF THE TEMPORARY CODE FOR MAST.SCHED. DYNALL ***************     24520002
         LA    R1,ICFRBPTR   *SET POINTER TO OUR IRB PTR FOR DYNALLOC   24560002
         DYNALLOC                                                       24600002
         L     R6,ICFTCBSV   *GET OUR TCB ADDRESS                       24640002
         USING TCB,R6        *ESTABLISH TCB ADDRESSABILITY              24680002
         L     R6,TCBTIO     *GET OUR TIOT ADDRESS                      24720002
         USING TIOT1,R6      *ESTABLISH TIOT ADDRESSABILITY             24760002
         ST    R6,ICFTIOTS   *SAVE TIOT ADDRESS FOR LATER               24800002
         SR    R7,R7         *CLEAR R7                                  24840002
ICFTIOLP EQU   *             *LOOK FOR THE TIOT ENTRY FOR THIS DATASET  24880002
         IC    R7,TIOELNGH   *IS THIS THE END OF THE TIOT?              24920002
         LTR   R7,R7         *IT IS IF ZERO                             24960002
         BZ    ICFNOTON      *VOLSER NOT MOUNTED - GO SEND MSG          25000002
         CLC   ICFPDSIN,TIOEDDNM  *IS THIS OUR DD ENTRY?                25040002
         BE    ICFGOTDD      *YES, GO HANDLE IT                         25080002
         AR    R6,R7         *GET NEXT TIOT ENTRY                       25120002
         B     ICFTIOLP      *GO TAKE CARE OF IT                        25160002
ICFGOTDD EQU   *                                                        25200002
         L     R7,TIOESTTB   *GET UCB POINTER                           25240002
         DROP  R6                                                       25280002
         LA    R7,D0(R7)     *CLEAR HI ORDER BYTE                       25320002
ICFUCBFD EQU   *                                                        25360002
         USING UCBD,R7       *ESTABLISH UCB ADDRESSABILITY              25400002
         TM    UCBTYP+D2,X20 *IS THIS A DA DEVICE?                      25440002
         BNO   ICFNSDEV      *NO, SEND 'UNSUPP.DEVICE' MSG              25480002
         CLC   SRTEVOLI(D6),ICFPREV    *IS THIS OUR VOLUME?             25520002
         BNE   ICFNCVOL      *NO, SEND 'VOLUME NOT FOUND' MSG           25560002
         TM    UCBTYP+D1,X01 *IS IT UPS SUPPORTED?                      25600002
         BNO   ICFNOUPS      *NO, GO SEND MSG                           25640002
* /* TEST FOR SYSRES DEVICE REMOVED BY OZ30392               @ZA30392*/ 25680003
         CLI   ICFDSN+D9,CA  *WARNA DATASET?                            25760002
         BE    ICFSVDT       *YES, GO SAVE DEVICE TYPE                  25800002
         CLC   ICFDVPRE+D3(D1),UCBTYP+D3  *IS WARNB ON SAME UNTTYP AS A 25840002
         BNE   ICFDDT        *NO, GO SEND MSG                           25880002
ICFBLJFC EQU   *                                                        25920002
         OBTAIN ICFWDSN      *OBTAIN SYS1.WARNX DSCB                    25960002
         LTR   R15,R15       *WAS OBTAIN SUCCESSFUL?                    26000002
         BNZ   ICFNCVOL      *NO, GO SEND MESSAGE                       26040002
*****************************************************************       26080002
         OI    ICFTRMSA+D1,X40    *UPDATE FOOTPRINT TABLE************** 26120002
*****************************************************************       26160002
         MVC   ICFJFCB(D10),ICFDSN     *SET DSN IN JFCB                 26200002
         L     R9,ICFTIOTS   *GET OUR TIOT ADDRESS                      26240002
         LA    R3,ICFPRMLS   *GET ADDRESS OF PARM LIST FOR OPEN         26280002
         DEVTYPE ICFPDSIN,ICFDVTYP,DEVTAB                               26320002
         L     R6,ICFDVTYP+D4     *GET TRACK CAPACITY                   26360002
         SRL   R6,D11        *ROUND DOWN                                26400002
         SLL   R6,D11        *TO NEXT 2K                                26440002
         ST    R6,ICFTRSIZ   *SAVE IN COMMUNICATION AREA                26480002
         LH    R6,ICFDVTYP+D10    *GET TRACKS PER CYLINDER              26520002
         LA    R5,D20        *GET MAXIMUM TRKS/CYL SUPPORTED BY PWF     26560002
         CR    R6,R5         *DOES THE WARNX DEVICE SATISFY THIS LIMIT? 26600002
         BH    ICFNSDEV      *NO, GO SEND 'UNSUPPORTED DEVICE' MSG      26640002
         ST    R6,ICFTPC     *SAVE IN COMM AREA                         26680002
*****************************************************************       26720002
         OI    ICFTRMSA+D1,X20    *UPDATE FOOTPRINT TABLE************** 26760002
*****************************************************************       26800002
         SPACE 3                                                        26840002
*        PREPARE TO OPEN SYS1.WARNX.                                    26880002
         SPACE                                                          26920002
         ST    R9,D12(R3)    *SAVE TIOT POINTER                         26960002
         MVC   ICFPRVOL(D6),SRTEVOLI   *VOLSER FROM UCB TO JFCB         27000002
         LA    R5,ICFDCB     *GET DCB POINTER                           27040002
         USING IHADCB,R5     *ESTABLISH DCB ADDRESSABILITY              27080002
         MVC   DCBDDNAM+D6(D1),ICFDSN+D9  *SET CORRECT DDN IN DCB       27120002
         ST    R3,D0(R3)     *POINTER TO PARM LIST                      27160002
         MVC   DCBEXLST+D1(D3),D1(R3)  *INTO DCB                        27200002
         LA    R6,ICFJFCB    *GET JFCB POINTER                          27240002
         ST    R6,D0(R3)     *GOES TO FIRST WORD PLACE                  27280002
         MVI   D0(R3),X87    *'LAST ONE' INDICATOR                      27320002
         MVI   D4(R3),X80    *DITTO                                     27360002
         LA    R1,D4(R3)     *PARM AREA FOR USE OF MACRO EXPANSION      27400002
         OPEN  ((R5),INOUT),TYPE=J,MF=(E,(1))                           27440002
         TM    DCBOFLGS,X10   *WAS OPEN SUCCESSFUL?                     27480002
         BNO   ICFNOPN       *NO, GO SEND MSG                           27520002
         STM   R3,R5,ICFSV35 *SAVE REGS 3 TO 5                          27560002
         OI    ICFESTPR,X0F  *SET FLAG FOR RETURN FROM ESTAE            27600002
         L     R6,DCBDEBAD    *GET DEB ADDRESS FROM DCB                 27640002
         DROP  R5                                                       27680002
         USING DEBBASIC,R6   *ESTABLISH BASIC DEB ADDRESSABILITY        27720002
         LA    R6,DEBBASND-DEBBASIC(R6)  *POINT TO DASD SECTION         27760002
         USING DEBDASD,R6    *ESTABLISH DASD SECT. ADDRESSABILITY       27800002
         MVC   ICFDEBCH,DEBBINUM   *SAVE START BBCCHH                   27840002
*****************************************************************       27880002
         OI    ICFTRMSA+D1,X10    *UPDATE FOOTPRINT TABLE************** 27920002
*****************************************************************       27960002
         L     R3,X10        *GET CVT POINTER                           28000002
         USING CVT,R3        *ESTABLISH CVT ADDRESSABILITY              28040002
         L     R3,CVTEORM    *GET REAL STORAGE SIZE FROM CVT            28080002
         DROP  R3                                                       28120002
         ST    R3,ICFSTSIZ   *STORE IT IN COMM AREA                     28160002
         SR    R2,R2         *CLEAR REG 2                               28200002
         D     R2,ICFTRSIZ   *DIVIDE STRG SIZE BY TRACK CAPACITY        28240002
         LTR   R2,R2         *IS THERE A REMAINDER?                     28280002
         BZ    ICFNORMD      *NO, WE HAVE THE NUMBER OF TRACKS NEEDED   28320002
         LA    R3,D1(R3)     *YES, ADD 1 TO NO OF TRCKS REQRD           28360002
         SR    R2,R2         *AND CLEAN REMAINDER                       28400002
ICFNORMD EQU   *                                                        28440002
         L     R4,ICFTPC     *GET TRACKS PER CYLINDER                   28480002
         BCTR  R4,R0         *MINUS 1                                   28520002
         DR    R2,R4         *FIND NO OF CYLINDERS REQRD                28560002
         LTR   R2,R2         *ANY REMAINDER?                            28600002
         BZ    ICFNOCRM      *NO, WE HAVE NO OF CYLINDERS REQRD         28640002
         LA    R3,D1(R3)     *YES, ADD 1 TO NO CYL REQRD                28680002
         SR    R2,R2         *AND CLEAN REMAINDER                       28720002
ICFNOCRM EQU   *                                                        28760002
         LA    R3,D1(R3)     *ADD 1 CYLINDER FOR CNTRL TRK              28800002
         LA    R4,D1(R4)     *RESTORE CORRECT NO TRKS PER CYL           28840002
         MR    R2,R4         *TRACKS REQUIRED IN DATASET                28880002
         LR    R2,R3         *SAVE THIS VALUE                           28920002
         CH    R2,DEBNMTRK    *COMPARE WITH TRKS IN EXTENT              28960002
         BH    ICFSMEXT      *EXTENT TOO SMALL. GO SEND MSG             29000002
         SPACE 3                                                        29040002
*        PREPARE TO USE EXCP TO READ CONTROL TRACK.                     29080002
         SPACE                                                          29120002
         MVC   ICFIOB+D33(D6),ICFDEBCH *SET SK/SRC ADDR IN IOB          29160002
         MVI   ICFIOB+D39,X01     *SET R = 1                            29200002
         LA    R3,ICFCNTRK   *GET ADDR OF CNTRL TRK BUFFER              29240002
         O     R3,ICFRDCMD   *SET RD COMMAND IN PLACE                   29280002
         ST    R3,ICFCCWS+D24     *STORE IN RD/WR CCW                   29320002
         MVC   ICFCCWS+D30(D2),CH512   *SET COUNT IN RD/WR CCW          29360002
ICFRCT   EQU   *                                                        29400002
         XC    ICFECB,ICFECB *ZERO OUT ECB                              29440002
         EXCP  ICFIOB                                                   29480002
         WAIT  ECB=ICFECB    *WAIT FOR COMPL. OF READ                   29520002
         TM    ICFECB,X7F    *WAS READ SUCCESSFUL?                      29560002
         BNO   ICFRDERR      *NO, GO TRY NEXT TRK OR SEND MSG           29600002
ICFGOTCT EQU   *                                                        29640002
         CLC   ICFCTID,CCCNTL     *IS IT GOOD CNTRL TRK?                29680002
         BNE   ICFRDERR      *NO, GO TRY NEXT TRK OR SEND MSG           29720002
ICFGODCT EQU   *                                                        29760002
*****************************************************************       29800002
         OI    ICFTRMSA+D1,X08    *UPDATE FOOTPRINT TABLE************** 29840002
*****************************************************************       29880002
         TM    ICFCTFLA,X80  *DOES DATASET STILL CONTAIN DUMP?          29920002
         BO    ICFDMPIN      *YES, GO TAKE CARE OF IT                   29960002
         STCK  ICFCTED       *GET CURRENT DATE/TIME                     30000002
         L     R4,ICFCTED    *PUT IT IN GPR                             30040002
         S     R4,ICFCTST    *SUBTRACT DATE/TIME OF LAST FORMAT         30080002
         BM    ICFORMAT      *SOMETHING'S WRONG - GO FORMAT             30120002
         C     R4,CTOD24HR   *IS DIFFERENCE SMALLER THAN 24 HRS?        30160002
         BL    ICFSKFRM      *YES, SKIP FORMATTING                      30200002
         SPACE 3                                                        30240002
*        THE FOLLOWING SECTION WILL FORMAT THE WARNX DATASET.           30280002
         SPACE                                                          30320002
ICFORMAT EQU   *                                                        30360002
         MVC   ICFIOB+D33(D6),ICFDEBCH *SK/SRC ADDRESS IN IOB           30400002
         MVI   ICFIOB+D39,X00     *RR = 0 IN IOB                        30440002
         L     R4,ICFTRSIZ   *GET TRACK SIZE                            30480002
         LA    R4,D8(R4)     *INCREMENT BY 8 FOR COUNT FIELD            30520002
         GETMAIN R,LV=(R4)   *GET FORMAT BUFFER                         30560002
         OI    ICFESTPR,XF0  *SET FLAG FOR RETURN FROM ESTAE            30600002
         ST    R1,ICFRMBUF   *SAVE ADDRESS OF BUFFER                    30640002
         MVC   D0(D4,R1),ICFIOB+D35    *SET CCHH IN COUNT FIELD         30680002
         MVI   D4(R1),X01    *SET RR IN COUNT FIELD                     30720002
         MVI   D5(R1),X00    *SET KL IN COUNT FIELD                     30760002
         LA    R4,D5(R1)     *ADDRESS OF SECOND OPERAND                 30800002
         LA    R2,D8(R1)     *ADDRESS OF FIRST OPERAND                  30840002
         L     R3,ICFTRSIZ   *LNGTH OF FIRST OPERAND                    30880002
         LA    R5,D1         *LNGTH OF SECND OPRND & PADDING            30920002
         MVCL  R2,R4         *CLEAN ALL FORMAT BUFFER                   30960002
         LA    R1,D0(R1)     *CLEAN HIGH ORDER BYTE                     31000002
         LR    R2,R1         *SAVE POINTER TO BUFFER                    31040002
         O     R1,ICFWRCMD   *SET WRITE CKD COMMAND                     31080002
         ST    R1,ICFCCWS+D24     *STORE IN RD/WR CCW                   31120002
*****************************************************************       31160002
         OI    ICFTRMSA+D1,X04    *UPDATE FOOTPRINT TABLE************** 31200002
*****************************************************************       31240002
         SPACE 3                                                        31280002
*        WRITE FORMAT FOR THE CONTROL TRACK                             31320002
         SPACE                                                          31360002
         MVC   ICFCCWS+D30(D2),CH520   *SET COUNT IN RD/WR CCW          31400002
         MVC   D6(D2,R2),CH512         *SET D L IN COUNT FIELD          31440002
         XC    ICFECB,ICFECB           *CLEAR ECB                       31480002
         EXCP  ICFIOB        *WRITE FORMAT FOR CNTRL TRK                31520002
         WAIT  ECB=ICFECB                                               31560002
         TM    ICFECB,X7F    *ANY ERRORS?                               31600002
         BNO   ICFWRER2      *YES, GO SEND MSG                          31640002
*****************************************************************       31680002
         OI    ICFTRMSA+D1,X02    *UPDATE FOOTPRINT TABLE************** 31720002
*****************************************************************       31760002
         SPACE 3                                                        31800002
*        WRITE FORMAT FOR THE REST OF THE DATASET                       31840002
         SPACE                                                          31880002
         L     R3,ICFIOB+D36      *GET CCHHHHRR                         31920002
         A     R3,CF256           *INCREMENT HHHH BY 1                  31960002
         ST    R3,ICFIOB+D36      *SET BACK IN IOB                      32000002
         MVC   D0(D4,R2),ICFIOB+D35    *SET CCHH IN COUNT FIELD         32040002
         L     R4,ICFTRSIZ        *GET TRACK SIZE                       32080002
         STH    R4,D6(R2)         *SET D L IN COUNT FIELD               32120002
         LA    R4,D8(R4)          *INCREMENT BY 8 FOR COUNT FIELD       32160002
         STH   R4,ICFCCWS+D30     *SET COUNT IN RD/WR CCW               32200002
         LH    R4,DEBNMTRK    *GET NO. TRKS IN EXTENT                   32240002
         DROP  R6                                                       32280002
         BCTR  R4,R0         *LESS 1 (CNTRL TRK)                        32320002
         L     R5,ICFTPC     *GET TRKS PER CYL                          32360002
         BCTR  R5,R0         *LESS 1 (CNTRL TRK)                        32400002
ICFFMTLP EQU   *                                                        32440002
         XC    ICFECB,ICFECB *CLEAR ECB                                 32480002
         EXCP  ICFIOB        *WRITE COUNT, KEY AND DATA                 32520002
         WAIT  ECB=ICFECB                                               32560002
         TM    ICFECB,X7F    *ANY ERRORS?                               32600002
         BNO   ICFWRER2      *YES, GO SEND MSG                          32640002
         L     R3,ICFIOB+D36 *GET CCHHHHRR FROM IOB                     32680002
         A     R3,CF256      *INCREMENT HHHH BY 1                       32720002
         ST    R3,ICFIOB+D36      *SET IT BACK                          32760002
         MVC   D0(D4,R2),ICFIOB+D35    *SET CCHH IN COUNT FIELD         32800002
         BCT   R4,ICFWRT01   *MORE TRACKS TO FORMAT?                    32840002
*****************************************************************       32880002
         OI    ICFTRMSA+D1,X01    *UPDATE FOOTPRINT TABLE************** 32920002
*****************************************************************       32960002
         L     R1,ICFRMBUF   *NO, PREPARE TO FREEMAIN                   33000002
         LH    R4,ICFCCWS+D30     *LNGTH OF BUFFER AREA                 33040002
         FREEMAIN R,LV=(R4),A=(R1)     *FREE IT                         33080002
         NI    ICFESTPR,X0F  *RESET FLAG FOR RETURN FROM ESTAE          33120002
ICFSKFRM EQU   *                                                        33160002
         SPACE 3                                                        33200002
*        THE FOLLOWING SECTION WILL INITIALIZE                          33240002
*        AND WRITE THE CONTROL TRACK.                                   33280002
         SPACE                                                          33320002
         MVC   ICFCTID,CCCNTL     *SET CNTRL TRK IDENTIFIER             33360002
         L     R2,ICFTPC     *GET NO. TRKS PER CYL                      33400002
         BCTR  R2,R0         *LESS 1 - LAST TRK NO.                     33440002
         STC   R2,ICFCTCF    *INITIALIZE:                               33480002
         MVC   ICFCTCF+D1(D127),ICFCTCF      *CYLINDER FLAGS            33520002
         MVI   ICFCTFLA,X00  *FLAG A FIELD                              33560002
         MVC   ICFCTTS,ICFTRSIZ   *NO. BYTES PER TRACK                  33600002
         LRA   R3,D0(R10)    *GET REAL ADDR. OF COMM.AREA               33640002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  33680002
         ST    R3,ICFCTAWA   *COMMUNICATION AREA ADDR                   33720002
         XC    ICFCTB11,ICFCTB11  *S.O.B. STORAGE ADDRESS               33760002
         MVC   ICFCTB12,ICFDEBCH+D2    *S.O.B. CCCCHHHH                 33800002
         MVI   ICFCTB13,XFF  *ALL OTHER                                 33840002
         MVC   ICFCTB13+D1(D119),ICFCTB13    *STORAGE BLOCKS            33880002
         STCK  ICFCTST       *DATE/TIME OF FORMAT                       33920002
         XC    ICFCTED(D48),ICFCTED     *ICFCTED THRU ICFCTCHA          33960002
         MVC   ICFCTTPC,ICFTPC    *SAVE TRKS/CYL IN CNTL TRK            34000002
         MVC   ICFCTSTS,ICFSTSIZ  *SAVE HIGHEST STRG ADDR IN CNTL TRK   34040002
         MVC   ICFCTDAT(D8),ICFLRDAT   *DATE & TIME OF DUMP -           34080002
*        THESE TWO FIELDS WILL BE UPDATED BY MCH APPNDG AT PROPER TIME. 34120002
         MVC   ICFCTCPU,ICFLRCPU  *CPU ID                               34160002
         MVC   ICFCTCHA,ICFLRCHA  *CHANNEL ASSIGNMENT                   34200002
         MVI   ICFCTRSV,XEE     *TO EASE IDENTIFICATION OF              34240002
         MVC   ICFCTRSV+D1(ICFCTEND-ICFCTRSV-D1),ICFCTRSV *CNTL TRK     34280002
*****************************************************************       34320002
         OI    ICFTRMSA+D2,X80    *UPDATE FOOTPRINT TABLE************** 34360002
*****************************************************************       34400002
         XC    ICFECB,ICFECB *CLEAR ECB                                 34440002
         MVC   ICFIOB+D33(D6),ICFDEBCH *SET SK/SRC ADDR IN IOB          34480002
         MVI   ICFIOB+D39,X01     *SET RR = 1 IN IOB                    34520002
         LA    R3,ICFCNTRK   *GET ADDR OF CNTRL TRK BUFFER              34560002
         O     R3,ICFWDCMD   *SET WRITE DATA COMMAND                    34600002
         ST    R3,ICFCCWS+D24      *STORE IN RD/WR CCW                  34640002
         MVC   ICFCCWS+D30(D2),CH512   *SET COUNT IN RD/WR CCW          34680002
         EXCP  ICFIOB                                                   34720002
         WAIT  ECB=ICFECB                                               34760002
         TM    ICFECB,X7F    *ANY ERRORS?                               34800002
         BNO   ICFWRERR      *YES, GO SEND MSG                          34840002
*****************************************************************       34880002
         OI    ICFTRMSA+D2,X40    *UPDATE FOOTPRINT TABLE************** 34920002
*****************************************************************       34960002
         MVO   ICFMVO,ICFDEBCH+D2(D2)  *CONVERT CCCC TO                 35000002
         UNPK  ICFUNPK,ICFMVO     *PRINTABLE CHARACTERS                 35040002
         SR    R3,R3         *TAKE                                      35080002
         LA    R4,ICFUNPK    *CARE*                                     35120002
         BAL   R8,ICFTRBYT   *OF                                        35160002
         LA    R4,ICFUNPK+D1 *ALPHA                                     35200002
         BAL   R8,ICFTRBYT   *NUMBERS                                   35240002
         LA    R4,ICFUNPK+D2 *BYTE                                      35280002
         BAL   R8,ICFTRBYT   *BY                                        35320002
         LA    R4,ICFUNPK+D3 *BYTE                                      35360002
         BAL   R8,ICFTRBYT   *SAME                                      35400002
         CLI   ICFDSN+D9,CA  *IS THIS WARNA?                            35440002
         BNE   ICFWRNB       *NO, GO HANDLE WARNB                       35480002
         MVC   ICFEXTMS+D13(D6),ICFPREV   *SET VOLSER IN OPR MSG        35520002
         MVC   ICFEXTMS+D20(D4),ICFUNPK   *SET CCCC IN OPR MSG          35560002
         B     ICFEXMDN      *ALL DONE FOR WARNA                        35600002
ICFWRNB  EQU   *             *HANDLE WARNB MSG PORTION                  35640002
         MVC   ICFEXTMS+D27(D6),ICFPREV   *SET VOLSER IN OPR MSG        35680002
         MVC   ICFEXTMS+D34(D4),ICFUNPK   *SET CCCC IN OPR MSG          35720002
ICFEXMDN EQU   *             *ALL DONE FOR WARNB TOO                    35760002
         LM    R3,R5,ICFSV35   *RESTORE REGS 3 TO 5                     35800002
         L     R8,ICFSV8     *RESTORE REG 8                             35840002
*****************************************************************       35880002
         OI    ICFTRMSA+D2,X20    *UPDATE FOOTPRINT TABLE************** 35920002
*****************************************************************       35960002
ICFEREX  EQU   *                                                        36000002
         LA    R1,D4(R3)     *SETUP TO CLOSE                            36040002
         MVI   D4(R3),X80    *'LAST ONE' INDICATOR                      36080002
         CLOSE ((R5)),MF=(E,(1))  *CLOSE WARNX DATASET                  36120002
         NI    ICFESTPR,XF0  *RESET FLAG FOR RETURN FROM ESTAE          36160002
*  THE FOLLOWING CODE IS TEMPORARY UNTIL MAST.SCHED.DYNALL IS FIXED     36200002
         L     R6,ICFJSCBS   *GET POINTER TO OUR JSCB                   36240002
         USING IEZJSCB,R6    *ESTABLISH JSCB ADDRESSABILITY             36280002
         MVC   JSCBTCBP,ICFJSTCS  *RESTORE JSCBTCBP FIELD               36320002
         DROP  R6                                                       36360002
*  END OF THE TEMPORARY CODE FOR MAST.SCHED. DYNALL *********           36400002
*****************************************************************       36440002
         OI    ICFTRMSA+D2,X10    *UPDATE FOOTPRINT TABLE************** 36480002
*****************************************************************       36520002
         BR    R8       *ALL DONE WITH THIS DATASET. BACK TO MAINLINE   36560002
         EJECT                                                          36600002
ICFWRT01 EQU   *                                                        36640002
         BCT   R5,ICFFMTLP   *END OF CYLINDER?                          36680002
         LM    R2,R3,ICFIOB+D32   *YES, UPDATE CCCC                     36720002
         SLDL  R2,D8         *PUT BBBBCCCC IN R2                        36760002
         A     R2,CF1        *INCREMENT CCCC BY 1                       36800002
         SRDL  R2,D8         *REALIGN                                   36840002
         STM   R2,R3,ICFIOB+D32   *PUT BACK IN IOB                      36880002
         XC    ICFIOB+D37(D2),ICFIOB+D37   *ZERO HHHH IN IOB            36920002
         L     R2,ICFRMBUF   *RESTORE PTR TO BUFFER                     36960002
         MVC   D0(D4,R2),ICFIOB+D35   *SET CCHH IN COUNT FLD            37000002
         L     R5,ICFTPC     *INIT BCT REG FOR NEXT CYL                 37040002
         B     ICFFMTLP      *BACK FOR NEXT CYLINDER                    37080002
         SPACE 5                                                        37120002
ICFSVDT  EQU   *                                                        37160002
         MVC   ICFDVPRE,UCBTYP    *SAVE DEVICE TYPE                     37200002
         B     ICFBLJFC      *BACK TO MAINLINE                          37240002
         SPACE 5                                                        37280002
ICFTRBYT EQU   *                                                        37320002
         IC    R3,D0(R4)     *GET BYTE TO BE XLATED                     37360002
         C     R3,CFF9       *IS THIS ALPHA NUMBER?                     37400002
         BNH   ICFTREXT      *NO, LEAVE IT ALONE                        37440002
         S     R3,CF39       *YES, XLATE IT TO PRINTABLE CHAR           37480002
         STC   R3,D0(R4)     *PUT BACK XLATED BYTE                      37520002
ICFTREXT EQU   *                                                        37560002
         BR    R8            *BACK TO MAINLINE                          37600002
         SPACE 5                                                        37640002
ICFNCVOL EQU   *                                                        37680002
         LA    R8,ICFNCVMS   *LOAD MSG PTR                              37720002
         MVC   ICFNCVMS+D37(D1),ICFDSN+D9   *SET DS IDENT IN MSG        37760002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           37800002
         B     ICFMSGR       *GO TO MSG ROUTINE                         37840002
         SPACE 5                                                        37880002
ICFMULTV EQU   *                                                        37920002
         LA    R8,ICFMVMSG   *LOAD MSG POINTER                          37960002
         MVC   ICFMVMSG+D12(D1),ICFDSN+D9   *SET DS IDENT IN MSG        38000002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           38040002
         B     ICFMSGR       *GO TO MSG ROUTINE                         38080002
         SPACE 5                                                        38120002
ICFSAMV  EQU   *                                                        38160002
         LA    R8,ICFSVMSG   *LOAD MSG PTR                              38200002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           38240002
         B     ICFMSGR       *GO TO MSG ROUTINE                         38280002
         SPACE 5                                                        38320002
ICFNOTON EQU   *                                                        38360002
         LA    R8,ICFNOMSG   *LOAD MSG PTR                              38400002
         MVC   ICFNOMSG+D10(D6),ICFPREV           *FILL IN              38440002
         MVC   ICFNOMSG+D30(D1),ICFDSN+D9         *MESSAGE              38480002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           38520002
         B     ICFMSGR       *GO TO MSG ROUTINE                         38560002
         SPACE 5                                                        38600002
ICFNSDEV EQU   *                                                        38640002
         LA    R8,ICFNSDMS   *LOAD MSG POINTER                          38680002
         MVC   ICFNSDMS+D12(D1),ICFDSN+D9  *FILL IN MSG                 38720002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           38760002
         B     ICFMSGR       *GO TO MSG ROUTINE                         38800002
         SPACE 5                                                        38840002
ICFNOUPS EQU   *                                                        38880002
         LA    R8,ICFNPMSG   *LOAD MSG PTR                              38920002
         MVC   ICFNPMSG+D10(D6),ICFPREV      *FILL IN MSG               38960002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           39000002
         B     ICFMSGR       *GO TO MSG ROUTINE                         39040002
         SPACE 5                                                        39080002
ICFDDT   EQU   *                                                        39120002
         LA    R8,ICFDDTMS   *LOAD MSG PTR                              39160002
         LA    R5,ICFINRTR   *PREPARE TO QUIT                           39200002
         B     ICFMSGR       *GO TO MSG ROUTINE                         39240002
         SPACE 5                                                        39280002
ICFNOPN  EQU   *                                                        39320002
         LA    R8,ICFNOPMS   *LOAD MSG PTR                              39360002
         MVC   ICFNOPMS+D27(D1),ICFDSN+D9   *SET DSN IN MSG             39400002
         BAL   R5,ICFMSGR    *GO TO MSG ROUTINE                         39440002
         B     ICFINRTR      *GO QUIT                                   39480002
         SPACE 5                                                        39520002
ICFSMEXT EQU   *                                                        39560002
         LA    R8,ICFSEMSG   *LOAD MSG PTR                              39600002
         MVC   ICFSEMSG+D12(D1),ICFDSN+D9   *SET DSN IN MSG             39640002
ICFCLRTR EQU   *             *CLOSE BEFORE QUITTING                     39680002
         BAL   R5,ICFMSGR    *GO TO MSG ROUTINE                         39720002
         LA    R8,ICFINRTR   *PREPARE TO QUIT (AFTER CLOSING)           39760002
         LM    R3,R5,ICFSV35      *RESTORE REGS 3 TO 5                  39800002
         B     ICFEREX       *GO TO APPROPRIATE POINT IN MAINLINE       39840002
         SPACE 5                                                        39880002
ICFRDERR EQU   *             *READ ERROR MSG ROUTINE                    39920002
         MVC   ICFWH1,ICFIOB+D37  *GET HHHH OF CNTL TRK                 39960002
         LH    R8,ICFWH1     *PUT IT IN GPR                             40000002
         LA    R8,D1(R8)     *BUMP IT BY 1                              40040002
         C     R8,ICFTPC     *TRYED ALL CYLINDER?                       40080002
         BNL   ICFREMR       *YES, GO SEND ERROR MSG                    40120002
         STH   R8,ICFWH1     *UPDATE HHHH                               40160002
         MVC   ICFIOB+D37(D2),ICFWH1   *IN IOB                          40200002
         B     ICFRCT        *TRY READ NEXT TRACK                       40240002
ICFREMR  EQU   *                                                        40280002
         LA    R8,ICFREMSG   *LOAD MSG PTR                              40320002
         MVC   ICFREMSG+D30(D1),ICFDSN+D9   *SET DSN IN MSG             40360002
         LA    R5,ICFORMAT   *PREPARE TO FORMAT  (WAS ICFCLRTR)         40400002
         B     ICFMSGR       *GO SEND MSG                               40440002
         SPACE 5                                                        40480002
ICFDMPIN EQU   *             *DATASET CONTAINS VALID DUMP               40520002
         MVC   ICFVDMSG+D44(D1),ICFDSN+D9   *DSN IN MSG                 40560002
ICFRFMR  EQU   *                                                        40600002
         LA    R1,ICFVDMSG   *GET MSG POINTER                           40640002
         XC    ICFANSW(D4),ICFANSW     *CLEAN REPLY AREA                40680002
         MVC   ICFVDMSG+D1(D3),ICFANSAD   *PUT REPLY ADDR IN WTOR       40720002
         MVC   ICFVDMSG+D4(D4),ICFREPAD   *PUT ECB ADDR IN WTOR         40760002
         XC    ICFREPLY,ICFREPLY  *ZERO ECB                             40800002
         WTOR  MF=(E,(R1))                                              40840002
         WAIT  ECB=ICFREPLY  *WAIT FOR REPLY                            40880002
         OC    ICFANSW,C4BLK *XLATE TO UPPER CASE                       40920002
         CLC   ICFANSW(D4),CCREST *IS RESTORE REQUESTED?                40960002
         BE    ICFREST       *YES, GO DO IT                             41000002
         CLC   ICFANSW(D4),CCFORM *IS FORMAT REQUESTED?                 41040002
         BNE   ICFRFMR       *NO, REISSUE THIS MESSAGE                  41080002
         SPACE 3                                                        41120002
**************************************************************          41160002
*                                                                     * 41200002
*        WRITE ENTRY ON LOGREC TO RECORD PREVIOUS POWER FAILURE       * 41240002
*                                                                     * 41280002
**************************************************************          41320002
         SPACE                                                          41360002
         XC    ICFLRBUF(D56),ICFLRBUF  *CLEAN LOGREC BUFFER             41400002
         L     R1,X10        *GET CVT POINTER                           41440002
         S     R1,CF4        *GET POINTER TO CVTRELNO                   41480002
         MVC   ICFLRBUF+D5(D1),D2(R1)  *SET RELEASE LEVEL               41520002
         PACK  ICFLRBUF+D48(D8),D0(D2,R1)   *PACK RELEASE NO.           41560002
         CVB   R1,ICFLRBUF+D48    *CONVERT RELEASE NO. TO BINARY        41600002
         MVI   ICFLRBUF,X50  *SET RECORD TYPE                           41640002
         STC   R1,ICFLRBUF+D1     *RELEASE NO.                          41680002
         MVI   ICFLRBUF+D2,X08    *WHATEVER IT IS                       41720002
         MVC   ICFLRBUF+D8(D16),ICFCTDAT    *DATE, TIME & CPU ID        41760002
         MVI   ICFLRBUF+D24,X10   *WHATEVER IT IS                       41800002
         MVC   ICFLRBUF+D24(D2),CCEN     *DITTO                         41840002
         MVC   ICFLRBUF+D32(D8),ICFCTCHA   *CHAN. ASSIGNMNT             41880002
         MVC   ICFLRBUF+D40(D4),ICFCTSTS   *HIGHEST STRG ADDR           41920002
         LA    R0,D48        *GET RECORD LENGTH                         41960002
         LNR   R0,R0         *MAKE IT NEGATIVE                          42000002
         LA    R1,ICFLRBUF   *GET POINTER TO RECORD                     42040002
         SVC   D76           *GO WRITE LOGREC RECORD                    42080002
         SPACE 3                                                        42120002
**************************************************************          42160002
*                                                                     * 42200002
*        SET UP FOR AND GO TO USER EXIT ROUTINE                       * 42240002
*                                                                     * 42280002
**************************************************************          42320002
         SPACE                                                          42360002
         ST    R9,ICFUSPRM   *SAVE IT IN USER PARM LIST                 42400002
         LA    R1,ICFUSPRM   *LOAD POINTER TO PARM LIST FOR USER        42440002
         L     R15,ICFTIUEP  *GET USER ROUTINE E.P.A.                   42480002
         BALR  R14,R15       *PASS CONTROL TO USER ROUTINE              42520002
         B     ICFORMAT      *NOW GO FORMAT THE DATASET                 42560002
         SPACE 3                                                        42600002
ICFWRER2 EQU   *                                                        42640002
         LA    R8,ICFWEMSG   *LOAD MSG PTR                              42680002
         MVC   ICFWEMSG+D30(D1),ICFDSN+D9   *DSN IN MSG                 42720002
         BAL   R5,ICFMSGR    *GO TO MSG ROUTINE                         42760002
ICFFREMB EQU   *             *                                          42800002
         L     R1,ICFRMBUF   *PREPARE TO FREEMAIN                       42840002
         LH    R4,ICFCCWS+D30     *LNGTH OF AREA TO FREE                42880002
         FREEMAIN R,LV=(R4),A=(R1)     *FREE IT                         42920002
         NI    ICFESTPR,X0F  *RESET FLAG FOR RETURN FROM ESTAE          42960002
         LA    R8,ICFINRTR   *PREPARE TO QUIT                           43000002
         LM    R3,R5,ICFSV35      *RESTORE REGS 3 TO 5                  43040002
         B     ICFEREX       *GO QUIT (AFTER CLOSING THOUGH)            43080002
         SPACE 5                                                        43120002
ICFWRERR EQU   *                                                        43160002
         LA    R8,ICFWEMSG   *LOAD MSG POINTER                          43200002
         MVC   ICFWEMSG+D30(D1),ICFDSN+D9   *DSN IN MSG                 43240002
         B     ICFCLRTR      *GO QUIT AFTER CLOSING                     43280002
         EJECT                                                          43320002
********************************************************************    43360002
*                                                                     * 43400002
*              ESTAE EXIT ROUTINE                                     * 43440002
*                                                                     * 43480002
********************************************************************    43520002
         SPACE 1                                                        43560002
ICFESTAE EQU   *                                                        43600002
         STM   R14,R12,D12(R13)   *SAVE REGISTERS AT ABEND              43640002
         USING SDWA,R1       *ESTABLISH SDWA ADDRESSABILITY             43680002
         LM    R2,R13,SDWASR02      *REINIT REGISTERS FOR THIS MODULE   43720002
         SETRP RETADDR=ICFRETRY,DUMP=YES,RC=4  *SET UP FOR RETRY ROUT.  43760002
         LM    R1,R12,D24(R13)   *RESTORE APPROPRIATE REGISTERS         43800002
         LA    R15,D4        *INDICATE RETRY HAS TO TAKE PLACE          43840002
         BR    R14           *GO BACK TO TERMINATION PROCESSING         43880002
         SPACE 5                                                        43920002
ICFRETRY EQU   *                                                        43960002
         USING SDWA,R1       *ESTABLISH SDWA ADDRESSABILITY             43970002
         LM    R2,R13,SDWASR02      *REINIT REGISTERS FOR THIS MODULE   44000002
         LA    R1,ICFUNEMS   *GET 'UNEXPECTED ERROR' MESSAGE POINTER    44040002
         WTO   MF=(E,(1))    *WRITE MESSAGE OUT                         44080002
         TM    ICFESTPR,XF0  *DO WE HAVE TO FREEMAIN FORMAT BUFFER?     44120002
         BO    ICFSER01      *YES, GO SET CORRECT RETURN ADDRESS        44160002
         TM    ICFESTPR,X0F  *DO WE HAVE TO CLOSE WARNX DCB?            44200002
         BO    ICFSER02      *YES, GO SET CORRECT RETURN ADDRESS        44240002
         L     R14,ICFESTPR+D0    *PREPARE RETURN TO MASTER SCHEDULER   44280002
         BR    R14           *GO SET FUNCTION INOPERATIVE               44320002
         SPACE 3                                                        44360002
ICFSER01 EQU   *                                                        44400002
         L     R14,ICFESTPR+D8    *PREPARE RETURN TO MASTER SCHEDULER   44440002
         BR    R14           *GO FREEMAIN FORMAT BUFFER,CLOSE WARNX AND 44480002
*                            *SET FUNCTION INOPERATIVE                  44520002
         SPACE 3                                                        44560002
ICFSER02 EQU   *                                                        44600002
         LA    R8,ICFINRTR        *PREPARE CORRECT RETURN               44640002
         L     R14,ICFESTPR+D4    *PATH BACK TO MASTER SCHEDULER        44680002
         BR    R14           *GO CLOSE WARNX AND SET FUNCTION INOPER.   44720002
         SPACE 3                                                        44760002
         EJECT                                                          44800002
*        JOB FILE CONTROL BLOCK                                         44840002
         SPACE                                                          44880002
ICFJFCB  EQU   *                                                        44920002
         DC    CL44' '       *DATASET NAME                              44960002
         DC    CL8' '        *EL. NAME, GEN#                            45000002
         DC    B'00001000'   JOB-DATA MGMT INTFC                        45040002
         DC    XL13'0'       SYSTEM CODE                                45080002
         DC    X'01'         NO LABEL                                   45120002
         DC    X'0'          SPARE                                      45160002
         DC    XL2'0'        FILE SEQUENCE                              45200002
         DC    XL2'0'        *VOLUME SEQUENCE                           45240002
         DC    XL8'0'        *DATA MGMT MASK                            45280002
         DC    XL6'0'        *DATES                                     45320002
         DC    X'0'          *INDICATOR 1                               45360002
         DC    X'40'         *INDICATOR 2 - OLD                         45400002
         DC    XL28'0'       *DCB FIELDS                                45440002
         DC    X'0'          *BLOCK & TRACK                             45480002
         DC    X'0'          *VOL SER COUNT                             45520002
ICFPRVOL DC    CL30' '       *VOL SERS                                  45560002
         DC    XL4'0'        *VOL INFO                                  45600002
         DC    XL3'0'        *PRIMARY DA QUANT.                         45640002
         DC    X'0'          *DA QUANT.                                 45680002
         DC    XL3'0'        *2NDARY DA QUANT.                          45720002
         DC    X'0'          *INDICATOR EXTENT                          45760002
         DC    XL3'0'        *DIRECTORY QUANT.                          45800002
         DC    XL3'0'        *SPLIT JFCB                                45840002
         DC    XL2'0'        *TTR 1ST ALLOC                             45880002
         DC    XL3'0'        *JFCB SUB ALLOC                            45920002
         DC    XL3'0'        *AV REC LENGTH                             45960002
         DC    X'1'          *VOL COUNT                                 46000002
         DC    X'0'          *SPLIT                                     46040002
         EJECT                                                          46080002
         SPACE 3                                                        46120002
*        DATA CONTROL BLOCK                                             46160002
         SPACE                                                          46200002
ICFDCB   DCB  DSORG=PS,DEVD=DA,MACRF=(E),IOBAD=ICFIOB,DDNAME=DDWARNX    46240002
         EJECT                                                          46280002
         SPACE 3                                                        46320002
*        IOB, ECB AND CCWS                                              46360002
         SPACE                                                          46400002
         DS    0D            *FOR ALIGNMENT                             46440002
ICFIOB   DS    0CL40                                                    46480002
         DC    X'42'         *+00 COMM CHAIN & UNRELATED                46520002
         DC    XL4'0'        *+01                                       46560002
         DC    AL3(ICFECB)   *+05 ECB ADDRESS                           46600002
         DC    XL9'0'        *+08                                       46640002
         DC    AL3(ICFCCWS)  *+17 CCW CHAIN ADDR                        46680002
         DC    X'0'          *+20                                       46720002
         DC    AL3(ICFDCB)   *+21 DCB ADDRESS                           46760002
         DC    XL8'0'        *+24                                       46800002
         DC    X'0'          *+32                                       46840002
         DC    XL7'1'        *+33 SEEK/SEARCH ADDR. WITH RR=01          46880002
         SPACE 5                                                        46920002
ICFECB   DC    F'0'          *ECB FOR EXCP                              46960002
         SPACE 5                                                        47000002
ICFCCWS  DS    0D                                                       47040002
         DC    X'1B',AL3(ICFIOB+D33),X'6000',XL2'6'   *SEEK CCW         47080002
         DC    X'31',AL3(ICFIOB+D35),X'6000',XL2'5'   *SEARCH CCW       47120002
         DC    X'08',AL3(ICFCCWS+D8),X'6000',XL2'1'   *TIC CCW          47160002
         DC    X'06',AL3(0),XL2'0',H'512'             *RD/WR CCW        47200002
         SPACE 5                                                        47240002
ICFRDCMD DC    XL4'06000000' *READ COMMAND                              47280002
ICFWRCMD DC    XL4'1D000000' *WRITE CKD COMMAND                         47320002
ICFWDCMD DC    XL4'05000000' *WRITE DATA COMMAND                        47360002
         EJECT                                                          47400002
         SPACE 3                                                        47440002
*        MISCELLANEOUS CONSTANTS AND FIELDS                             47480002
         SPACE                                                          47520002
         DS    0D            *ALIGN TO DOUBLEWORD                       47560002
ICFRBPTR DC    X'80'                                                    47600002
         DC    AL3(ICFRBLNG)                                            47640002
*                                                                       47680002
ICFRBLNG DC    X'14'         *RB LENGTH                                 47720002
ICFRBVRB DC    X'01'         *   VERB CODE                              47760002
ICFRBFL1 DC    X'2000'       *   FLAGS1 - S99NOMNT=1                    47800002
ICFRBERC DC    H'0'          *   ERROR CODE                             47840002
ICFRBINF DC    H'0'          *   INFO CODE                              47880002
ICFRBTXP DC    A(ICFTPTU1)   *   TEXT POINTERS                          47920002
ICFRBRSV DC    F'0'          *   RESERVED                               47960002
ICFRBFL2 DC    X'20000000'   *   FLAGS2 -S99NORES=1                     48000002
*                                                                       48040002
ICFTPTU1 DC    A(ICFTUDSN)   *TEXT POINTER 1                            48080002
ICFTPTU2 DC    A(ICFTUDSS)   *TEXT POINTER 2                            48120002
ICFTPTU3 DC    X'80'         *TEXT POINTER 3                            48160002
         DC    AL3(ICFTUDDN) *DITTO                                     48200002
*                                                                       48240002
ICFTUDSN DC    XL2'2'        *TEXT UNIT 1 - DATASET NAME                48280002
         DC    XL2'1'        *                                          48320002
         DC    XL2'A'        *                                          48360002
         DC    C'SYS1.WARNX'                                            48400002
ICFTUDSS DC    XL2'4'        *TEXT UNIT 2 - DATASET STATUS              48440002
         DC    XL2'1'        *                                          48480002
         DC    XL2'1'        *                                          48520002
         DC    X'01'         *                                          48560002
         DS    0F                                                       48600002
ICFTUDDN DC    XL2'1'        *TEXT UNIT 3 - DDNAME                      48640002
         DC    XL2'1'        *                                          48680002
         DC    XL2'7'        *                                          48720002
         DC    C'DDWARNX'    *                                          48760002
         DS    0D                                                       48800002
ICFDDWA  DC    CL8'DDWARNA'  *                                          48840002
ICFDDWB  DC    CL8'DDWARNB'  *                                          48880002
ICFDEBCH DC    XL6'0'        *                                          48920002
ICFDEBTS DC    XL2'0'        *                                          48960002
CF8      DC    F'8'          *                                          49000002
CF1      DC    F'1'          *                                          49040002
CF2      DC    F'2'          *                                          49080002
CF3      DC    F'3'          *                                          49120002
CF4      DC    F'4'          *                                          49160002
CF65536  DC    F'65536'      *                                          49200002
CF32     DC    F'32'         *                                          49240002
CF256    DC    F'256'        *                                          49280002
CF1000   DC    F'1000'       *                                          49320002
CTOD24HR DC    F'86400'      *APRROX. 24 HRS IN TOD SECS                49360002
ICFEMTD  DC    F'10'          *ENGINEERING MINIMUM TIME PARAM. 10 MSEC  49400002
CF6      DC    F'6'          *                                          49440002
CFF9     DC    X'000000F9'   *                                          49480002
CF39     DC    X'00000039'   *                                          49520002
CH1      DC    H'1'          *                                          49560002
CH520    DC    H'520'        *                                          49600002
CH512    DC    H'512'        *                                          49640002
ICFUNPK  DC    XL4'0'        *                                          49680002
ICFMVO   DC    XL3'F'        *                                          49720002
CCWARN   DC    C'SYS1.WARN'  *                                          49760002
CCCNTL   DC    C'CNTL'       *                                          49800002
ICFTIFRC DC    F'0'          *RETURN CODE FIELD                         49840002
ICFPDSIN DC    CL8'DDWARNX'  *FOR DEVTYPE MACRO                         49880002
ICFPREV  DC    CL6' '        *VOLSER SAVE FIELD                         49920002
CCEN     DC    C'EN'         *                                          49960002
CCGO     DC    C'GO  '       *                                 @ZA00521 50000000
CCSTOP   DC    C'STOP'       *                                 @ZA00521 50010000
C4BLK    DC    CL4' '        *                                          50040002
CCFORM   DC    C'FORM'       *                                          50080002
CCREST   DC    C'REST'       *                                          50120002
ICFBRFEP DC    A(ICFBRE00)   *RESTORE E.P.A.                            50160002
ICFTIUEP DC    A(ICFBIE50)   *USER EXIT ROUTINE ENTRY POINT             50200002
         SPACE 3                                                        50240002
ICFWDSN  CAMLST SEARCH,ICFDSN,ICFPREV,ICFWKA                            50280002
         SPACE 3                                                        50320002
ICFWVOL  CAMLST NAME,ICFDSN,,ICFWKA                                     50360002
         SPACE 3                                                        50400002
ICFDSN   DS    CL44          *DSNAME FOR LOCATE                         50440002
         DS    F             *                                          50480002
         DS    0D            *                                          50520002
ICFWKA   DS    0CL265        *WORK AREA FOR LOCATE MACRO                50560002
ICFNVOL  DS    CL2           *DITTO                                     50600002
ICFDEVCD DS    CL4           *DITTO                                     50640002
ICFVOLS  DS    CL6           *DITTO                                     50680002
ICFSEQN  DS    CL2           *DITTO                                     50720002
ICFOTVOL DS    19CL12        *DITTO                                     50760002
ICFZERS1 DS    CL10          *DITTO                                     50800002
ICFTTR1  DS    CL3           *DITTO                                     50840002
ICFZER2  DS    CL1           *DITTO                                     50880002
ICFTTR2  DS    CL3           *DITTO                                     50920002
ICFBLKVL DS    CL6           *DITTO                                     50960002
         EJECT                                                          51000002
         SPACE 3                                                        51040002
*        MESSAGES AND RELATED COSTANTS AND FIELDS                       51080002
         SPACE                                                          51120002
ICFANSW  DC    CL4'STOP'     *FIELD FOR OPERATOR REPLY                  51160002
ICFREPLY DC    F'0'          *ECB FOR WTOR                              51200002
ICFREPAD DC    A(ICFREPLY)   *ITS ADDRESS                               51240002
ICFANSAD DC    AL3(ICFANSW)  *REPLY FLD ADDRESS                         51280002
ICFINPMS DC    CL43'11 WARN TIME PARAMETER IS ZERO'                     51320002
ICFCTDMS DC    CL43'12 WARN TIME PARAMETER IS ONE'                      51360002
ICFNCVMS DC    CL43'13 LOCATE/OBTAIN FAILED FOR SYS1.WARNX'             51400002
ICFMVMSG DC    CL43'14 SYS1.WARNX RESIDES ON MORE THAN 1 VOLUME'        51440002
ICFSVMSG DC    CL43'15 BOTH SYS1.WARN DATASETS ON SAME VOLUME'          51480002
ICFNOMSG DC    CL43'16 VOLUME XXXXXX FOR SYS1.WARNX NOT MOUNTED'        51520002
ICFNPMSG DC    CL43'17 VOLUME XXXXXX ON UNPOWERED DEVICE'               51560002
ICFDDTMS DC    CL43'18 WARN DATASETS ON DIFFERENT DEVICE TYPES'         51600002
ICFNOPMS DC    CL43'19 COULD NOT OPEN SYS1.WARNX'                       51640002
ICFSEMSG DC    CL43'20 SYS1.WARNX TOO SMALL FOR STORAGE SIZE'           51680002
ICFPNAMS DC    CL43'22 PATH NOT AVAILABLE FOR WARN DATASET'             51720002
ICFNSDMS DC    CL43'23 SYS1.WARNX RESIDES ON UNSUPPORTED DEVICE'        51760002
ICFREMSG DC    CL43'31 I/O ERROR READING SYS1.WARNX'                    51800002
ICFWEMSG DC    CL43'32 I/O ERROR WRITING SYS1.WARNX'                    51840002
         SPACE 5                                                        51880002
ICFWTOR  WTOR  'ICFTIMXX XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX - REPC51920002
               LY STOP OR GO',,4,ROUTCDE=(1,2,10),DESC=2,MF=L           51960002
ICFVDMSG WTOR  'ICFTIM21 VALID DUMP IN SYS1.WARNX - REPLY FORM OR REST'C52000002
               ,,4,ROUTCDE=(1,2,10),DESC=2,MF=L                         52040002
ICFCTDM  WTO   'ICFTIM51 WARN WILL DUMP AT FIRST WARNING',             C52080002
               ROUTCDE=(1),DESC=2,MF=L                                  52120002
ICFQUITM WTO   'ICFTIM99 POWER WARNING FEATURE  - FUNCTION INOPERATIVE'C52160002
               ,ROUTCDE=(1,10),DESC=2,MF=L                              52200002
ICFEXTMS WTO   'ICFTIM58 XXXXXX CCCC - YYYYYY CCCC',                   C52240002
               ROUTCDE=(1),DESC=2,MF=L                                  52280002
ICFICMSG WTO   'ICFTIM59 POWER WARNING FEATURE - INITIALIZATION COMPLETC52320002
               E',ROUTCDE=(2),DESC=4,MF=L                               52360002
ICFUNEMS WTO   'ICFTIM90 POWER WARNING FEATURE - UNEXPECTED ERROR',DESCC52400002
               =2,ROUTCDE=(1),MF=L                                      52440002
ICFWHMSG WTO   'ICFTIM91 WARNING DETECTED BEFORE PWF INITIALIZATION',DEC52480002
               SC=2,ROUTCDE=(1),MF=L                                    52520002
         SPACE 3                                                        52560002
ICFPATCH DC    25CL4'DDDD'   *PATCH AREA                                52600002
         EJECT                                                          52640002
ICFTIFDS DSECT                                                          52680002
ICFSAVEA DS    18F           *SAVE AREA                                 52720002
ICFIOSGS DS    F             *FOR IOSGEN SAVING MECHANISM               52760002
ICFSV35  DS    3F            *SAVE AREA FOR REGS 3 TO 5                 52800002
ICFSV8   DS    F             *SAVE AREA FOR REG 8                       52840002
ICFSV5   DS    F             *SAVE AREA FOR REG 5                       52880002
ICFCCW1  DS    D             *WORK AREA FOR SEEK CCW                    52920002
ICFCCW2  DS    D             *WORK AREA FOR SEARCH CCW                  52960002
ICFCCW3  DS    D             *WORK AREA FOR TIC CCW                     53000002
ICFCCW4  DS    D             *WORK AREA FOR WRITE CCW                   53040002
ICFCHR   DS    D             *                                          53080002
ICFRMBUF DS    F             *SAVE FORMAT BUFFER POINTER                53120002
ICFDVTYP DS    5F            *WORK AREA FOR DEVTYPE MACRO               53160002
ICFDVPRE DS    F             *SAVE DEVICE TYPE                          53200002
ICFWH1   DS    H             *WORK HALFWORD 1                           53240002
ICFWH2   DS    H             *WORK HALFWORD 2                           53280002
ICFLRBUF DS    7D            *LOGREC BUFFER                             53320002
ICFUSPRM DS    F             *PARAMETER LIST FOR USER                   53360002
ICFTIOTS DS    F             *SAVE AREA FOR OUR TIOT POINTER            53400002
ICFTCBSV DS    F             *SAVE AREA FOR OUR TCB POINTER             53440002
ICFJSCBS DS    F             *SAVE AREA FOR OUR JSCBTCBP POINTER        53480002
ICFJSTCS DS    F             *SAVE AREA FOR OUR JSCBTCBP FIELD          53520002
ICFESTPR DS    3F            *PARAMETER AREA FOR ESTAE                  53560002
ICFPRMLS DS    4F            *PARAMETER LIST FOR OPEN                   53600002
ICFDSEND EQU   *             *END OF WORK AREA                          53640002
         EJECT                                                          53680002
         CVT   DSECT=YES                                                53720002
         EJECT                                                          53760002
         ICFWORK                                                        53800002
         EJECT                                                          53840002
UCBD     DSECT                                                          53880002
         IEFUCBOB                                                       53920002
         EJECT                                                          53960002
         IKJTCB                                                         54000002
         EJECT                                                          54040002
         PRINT ON,NOGEN                                                 54080002
         DCBD  DSORG=(PS)                                               54120002
         PRINT ON,GEN                                                   54160002
         EJECT                                                          54200002
TIOTDSEC DSECT                                                          54240002
         IEFTIOT1                                                       54280002
         EJECT                                                          54320002
         IEZJSCB                                                        54360002
         EJECT                                                          54400002
         IEZDEB                                                         54440002
         EJECT                                                          54480002
         IECDLCH                                                        54520002
         EJECT                                                          54560002
         IHAPSA                                                         54600002
         EJECT                                                          54640002
         IHASDWA                                                        54680002
         EJECT                                                          54720002
         IECDCAT                                                        54760002
         EJECT                                                          54800002
         IHAPCCA                                                        54840002
         EJECT                                                          54880002
         IHACSD                                                         54920002
         EJECT                                                          54960002
ICFBIE00 CSECT                                                          55000002
         SPACE 5                                                        55040002
ICFDSSIZ EQU   ICFDSEND-ICFSAVEA                                        55080002
ICFMSWRD EQU   ICFWTOR+D18                                              55120002
         DROP  R10                                                      55160002
         DROP  R11                                                      55200002
         DROP  R12                                                      55240002
         DROP  R13                                                      55280002
         TITLE 'POWER WARNING FEATURE - RESTORE ROUTINE'                55320002
*********************************************************************** 55360002
*********************************************************************** 55400002
*                                                                     * 55440002
*                                                                     * 55480002
*  THIS ROUTINE RESTORES STORAGE FROM DISK PREVIOUSLY DUMPED BY       * 55520002
*        ICFBDF00--DUMP ROUTINE                                       * 55560002
*                                                                     * 55600002
*  TERMINATIONS--PSW WAIT, IC=26 SUCCESSFUL RESTORE                   * 55640002
*                PSW WAIT, IC=27 ALL OR PART NOT RESTORED             * 55680002
*                                                                     * 55720002
*  LINKAGE--REGISTER 15, ENTRY AND BASE REG                           * 55760002
*           REGISTER 10, TABLE POINTER-COMMUNICATION AREA             * 55800002
*           REGISTER  9, CCCCHHHH CONTROL TRACK                       * 55840002
*                                                                     * 55880002
*           REGISTER 14--POINTS TO A FOOTPRINT TABLE(1 WORD),         * 55920002
*                        FOLLOWED BY A RECORD OF TRACKS AND           * 55960002
*                        STORAGE THAT FAILED TO RESTORE               * 56000002
*          TRACK RECORDS-(3 WORDS EACH TRACK)                         * 56040002
*                WORD 1.-CCCCHHHH FAILING TRACK                       * 56080002
*                     2.-00AAAAAA BEGINNING ADR                       * 56120002
*                     3.-00AAAAAA ENDING ADR                          * 56160002
*                                                                     * 56200002
*          SENSE INFORMATION FROM LAST UNIT CHECK MAY BE              * 56240002
*          FOUND 24 BYTES PRECEDING FOOTPRINT TABLE                   * 56280002
*                                                                     * 56320002
*********************************************************************** 56360002
         EJECT                                                          56400002
*********************************************************************** 56440002
*                                                                     * 56480002
*  FOOTPRINT TABLE-(ADR IN REG 14)-(1 WORD, BIT ON CONDITION)         * 56520002
*                                                                     * 56560002
*                HISTORICAL                                           * 56600002
*                 BIT 0.-RESTORE STARTED                              * 56640002
*                     1.-MOVED TO HEX 1000                            * 56680002
*                     2.-INITIALIZATION COMPLETE-START SP RESTORE     * 56720002
*                     3.-SP KEYS RESTORED-START DATA RESTORE          * 56760002
*                      X                                              * 56800002
*                     4.-DATA(LESS FIRST TRACK) RESTORED-MOVE PROGRAM * 56840002
*                     5.-PROGRAM MOVED TO DUMP WORK AREA              * 56880002
*                     6.-RE-INITIALIZATION COMPLETE-START FIRST TRK   * 56920002
*                     7.-FIRST TRK RESTORE COMPLETE-RESTORE COMPLETE  * 56960002
*                 SUB-HISTORY                                         * 57000002
*                 BIT 8.-1 OR BOTH SP TRKS READ                       * 57040002
*                     9.-1 OR MORE DATA TRKS RESTORED                 * 57080002
*                    1O.-1 OR MORE CYLS RESTORED                      * 57120002
*                    11.-1 OR MORE STORAGE BLOCKS RESTORED            * 57160002
*                      X                                              * 57200002
*                    12.-SP END FLAGGED BY LAST STORAGE BLOCK         * 57240002
*                    13.-SP END FLAGGED BY LAST SP KEY                * 57280002
*                    14.-DATA END FLAGGED BY LAST STORAGE BLOCK       * 57320002
*                    15.-DATA END FLAGGED BY LAST CYL FLAG            * 57360002
*                 CURRENT                                             * 57400002
*                BIT 16.-IN I/O ROUTINE                               * 57440002
*                    17.-GOING TO TIO                                 * 57480002
*                    18.-UNIT CHECK-DOING SENSE                       * 57520002
*                    19.-IN CORRECTABLE ERROR ROUTINE                 * 57560002
*                      X                                              * 57600002
*                    20.-IN TRACK RETRY                               * 57640002
*                    21.-IN CHANNEL ERROR HANDLER                     * 57680002
*                 ERROR RECORD                                        * 57720002
*                BIT 22.-1 OR MORE CORRECTABLE ERRORS OCCURRED        * 57760002
*                    23.-1 OR MORE TRACKS RETRIED                     * 57800002
*                      X                                              * 57840002
*                    24.-1 OR MORE TRACKS FAILED TO RESTORE           * 57880002
*                    25.-FIRST TRACK NOT RESTORED                     * 57920002
*                    26.-SP KEYS NOT RESTORED                         * 57960002
*                    27.-1 OR MORE CHANNEL ERRORS                     * 58000002
*                 TERMINATIONS                                        * 58040002
*                BIT 28.-UNIT CHECK ON SENSE                          * 58080002
*                    29.-10 TRACKS UNRESTORABLE                       * 58120002
*                    30.-10 CHANNEL ERRORS                            * 58160002
*                    31.-DEVICE NOT OPERATIVE                         * 58200002
*                                                                     * 58240002
*********************************************************************** 58280002
         EJECT                                                          58320002
         SPACE 3                                                        58360002
* * * EQUATES * * *                                                     58400002
RZ       EQU   0                                                        58440002
RTAB     EQU   10                                                       58480002
RCH      EQU   9                                                        58520002
RCW      EQU   12                                                       58560002
RBL      EQU   13                                                       58600002
RM       EQU   8                                                        58640002
Q0       EQU   0                                                        58680002
Q1       EQU   1                                                        58720002
Q2       EQU   2                                                        58760002
Q3       EQU   3                                                        58800002
Q4       EQU   4                                                        58840002
Q5       EQU   5                                                        58880002
Q6       EQU   6                                                        58920002
Q8       EQU   8                                                        58960002
Q12      EQU   12                                                       59000002
Q14      EQU   14                                                       59040002
Q16      EQU   16                                                       59080002
QX12     EQU   X'12'                                                    59120002
Q24      EQU   24                                                       59160002
Q20      EQU   X'20'                                                    59200002
Q40      EQU   X'40'                                                    59240002
Q42      EQU   X'42'                                                    59280002
Q80      EQU   X'80'                                                    59320002
Q128     EQU   128                                                      59360002
Q136     EQU   136                                                      59400002
Q3F      EQU   X'3F'                                                    59440002
QC0      EQU   X'C0'                                                    59480002
QEE      EQU   X'EE'                                                    59520002
QFF      EQU   255                                                      59560002
M7       EQU   7                                                        59600002
ICFPGNEW EQU   104                                                      59640002
ICFCAW   EQU   72                                                       59680002
ICFCSW   EQU   64                                                       59720002
ICFMCH   EQU   112                                                      59760002
ICFMCHA  EQU   116                                                      59800002
ICFION   EQU   120                                                      59840002
BUSY     EQU   2                                                        59880002
STAT     EQU   4                                                        59920002
NOTOP    EQU   1                                                        59960002
         EJECT                                                          60000002
         SPACE 3                                                        60040002
* * * RELOCATION AND INITIALIZATION * * *                               60080002
         SPACE 1                                                        60120002
ICFBRE00 DS    0D             ****ENTRY****                             60160002
         USING ICFBRE00,R15                                             60200002
         USING ICFWORKA,RTAB                                            60240002
ICFFIRST EQU   *                                                        60280002
         B     ICFIDER                                                  60320002
         DC    C'RESTORE PROGRAM ' IDENTIFY PROGRAM FOR DUMPS           60360002
ICFIDER  EQU   *                                                        60400002
         LA    R14,ICFFOOT        FOOTPRINT ADR                         60440002
         XC    ICFFOOT,ICFFOOT    CLEAR FOOTPRINT                       60480002
***FOOTPRINT--BIT 0--RESTORE STARTED***                                 60520002
         OI    Q0(R14),Q80                                              60560002
         MVC   ICFPGNEW(Q16),ICFBUM SET PROG, MCH PSWS                  60600002
         L     R2,ICFX1000         SET MOVE TO ADDRESS                  60640002
         L     R3,ICFX800          MOVE 2048 BYTES                      60680002
         LR    R4,R15              FROM ADDRESS                         60720002
         L     R5,ICFPCT          COUNT OF PROGRAM                      60760002
         MVCL  R2,R4              MOVE FROM PRESENT ADR TO HEX 1000     60800002
         L     R15,ICFX1000       SHIFT AND RUN AT 1000                 60840002
         B     *+4                                                      60880002
         LA    R14,ICFFOOT        FOOTPRINT ADR                         60920002
***FOOTPRINT--BIT 1--MOVED TO X1000***                                  60960002
         OI    Q0(R14),Q40                                              61000002
         MVC   ICFCYFL(Q128),ICFCTCF   CONTROL INFO                     61040002
         MVC   ICFBPT(Q136),ICFCTTS MORE INFO                           61080002
         MVC   ICFTRPC(Q4),ICFCTTPC                                     61120002
         MVC   ICFPX(Q4),ICFCTPXR                                       61160002
         MVC   ICFSIOA+2(Q2),ICFCTRDA+2 DEVICE ADR                      61200002
         MVC   ICFTIOA+2(Q2),ICFCTRDA+2                                 61240002
         CLI   ICFTIOA+2,Q6       SET MASK TO ENABLE RESTORE CHANNEL    61280002
         BNL   ICFHI              CH6 OR HIGHER                         61320002
         MVC   ICFMCH(Q1),ICFTIOA+2                                     61360002
         TR    ICFMCH(Q1),ICFMASK  TRANSLATE CHANNEL TO MASK            61400002
         EJECT                                                          61440002
         SPACE 3                                                        61480002
ICFHI    EQU   *                                                        61520002
         LA    RM,ICFCCH          CCHH ADR                              61560002
         STCM  RM,M7,ICFSEEK+1    SET IN SEEK CCW                       61600002
         LA    RM,Q2(RM)          BUMP BY 2                             61640002
         STCM  RM,M7,ICFSERCH+1   SET IN SEARCH CCW                     61680002
         LA    RM,ICFSERCH        ADR OF SERCH CCW                      61720002
         STCM  RM,M7,ICFTIC+1     SET IN TIC CCW                        61760002
         LA    RM,ICFCCHX         DUMMY CCHH ADR                        61800002
         STCM  RM,M7,ICFSEEKX+1   DUMMY SEEK CCW                        61840002
         MVC   ICFREAD+6(Q2),ICFBPT+2 SET CCW COUNT                     61880002
         MVC   ICFREAD+2(Q2),ICFBPT+2 SET CCW ADR                       61920002
         LA    RM,ICFSDAT         SENSE FIELD                           61960002
         STCM  RM,M7,ICFSENSE+1   SET IN SENSE CCW                      62000002
         ST    RCH,ICFCCHA        CCCCHHHH OF CNTL TRACK                62040002
         LA    RM,ICFEINT         SET PSWS                              62080002
         ST    RM,ICFMCHA         ENABLE PSW                            62120002
         MVC   ICFION(Q8),ICFMCH  I/O NEW                               62160002
         MVC   ICFPSAVE(Q24),ICFPGNEW    *SAVE PSWS                     62200002
         LA    RM,ICFDINT                                               62240002
         ST    RM,ICFDPSW+4       DISABLE PSW                           62280002
         SPACE 1                                                        62320002
* * * RESTORE SP KEYS * * *                                             62360002
         SPACE 1                                                        62400002
***FOOTPRINT BIT 2-INITIALIZATION COMPLETE-START SP RESTORE***          62440002
         OI    Q0(R14),Q20                                              62480002
ICFSPMOR EQU   *                                                        62520002
         L     RCH,ICFCCHA        CCCCHHHH OF SP TRACK                  62560002
         LA    RCH,Q1(RCH)        UP TRACK BY 1 FOR SP KEYS             62600002
         ST    RCH,ICFCCHA        SET IN CCHH                           62640002
         BAL   RBL,ICFSIO         GO READ SP KEYS                       62680002
         B     ICFSPOK            NO ERROR                              62720002
         BAL   RBL,ICFERR         ERROR                                 62760002
***FOOTPRINT BIT 26-SP KEYS NOT RESTORED***                             62800002
         OI    Q3(R14),Q20                                              62840002
         NI    Q2(R14),Q3                                               62880002
         XC    ICFRTCT,ICFRTCT CLEAAR RETRY CTR                         62920002
         XC    Q4(Q8,RCW),Q4(RCW) NO ADR FOR SP TRACK RECORDS           62960002
         MVC   ICFGOOD(Q8),ICFBUM SET WAIT CODE TO PARTIAL              63000002
         B     ICFSPNG                                                  63040002
         EJECT                                                          63080002
         SPACE 3                                                        63120002
ICFSPOK  EQU   *                                                        63160002
***FOOTPRINT BIT 8-1 OR MORE SP TRACKS READ***                          63200002
         OI    Q1(R14),Q80                                              63240002
         NI    Q2(R14),Q3                                               63280002
         XC    ICFRTCT,ICFRTCT    CLEAR RETRY CTR                       63320002
         L     R1,ICFBPT          ADR FIRST SP KEY                      63360002
         LA    R2,Q1              INCREMENTER                           63400002
         L     R3,ICF4095         MAX SP ON ONE TRACK                   63440002
         AR    R3,R1              SET COMPARAND                         63480002
         TS    ICFKFLAG           FIRST TIME                            63520002
         BM    ICFSPSET           NO-CK KEY                             63560002
         LA    RM,ICFCONF         GET CONFIGURATION MAP ADR             63600002
         SR    R1,R2              ADJUST R1 FOR BXH                     63640002
ICFCFIN  EQU   *                                                        63680002
         TM    Q0(RM),QFF         USED?                                 63720002
         BO    ICFSPEN1           LAST OF SP                            63760002
         L     R5,Q0(RM)          STARTING STOR ADR                     63800002
         L     R6,ICFX800         INCREMENT                             63840002
         L     R7,Q8(RM)          ENDING STOR ADR                       63880002
         LA    RM,Q16(RM)         TRY NEXT                              63920002
         BXH   R1,R2,ICFSPMOR                                           63960002
ICFSPSET EQU   *                                                        64000002
         TM    Q0(R1),QFF         LAST KEY                              64040002
         BO    ICFSPEN2           YES                                   64080002
         IC    RZ,Q0(R1)          GET KEY                               64120002
         SSK   RZ,R5              SET                                   64160002
         BXH   R5,R6,ICFCFIN      NEXT STORAGE BLOCK                    64200002
         BXLE  R1,R2,ICFSPSET     NEXT KEY                              64240002
         B     ICFSPMOR           GET MORE SP KEYS                      64280002
***FOOTPRINT BIT 12-SP END FLAGGED BY LAST STORAGE BLOCK***             64320002
ICFSPEN1 EQU   *                                                        64360002
         OI    Q1(R14),Q8                                               64400002
         B     ICFSPEN                                                  64440002
***FOOTPRINT BIT 13-SP END FLAGGED BY LAST SP KEY***                    64480002
ICFSPEN2 EQU   *                                                        64520002
         OI    Q1(R14),Q4                                               64560002
         B     ICFSPEN                                                  64600002
         EJECT                                                          64640002
         SPACE 3                                                        64680002
* * * THIS SECTION RESTORES ALL BUT FIRST TRACK * * *                   64720002
ICFSPEN  EQU   *                                                        64760002
***FOOTPRINT BIT 3-SP KEYS RESTORED-START DATA RESTORE***               64800002
        OI    Q0(R14),Q16                                               64840002
        SPACE 1                                                         64880002
*R1 STORAGE ADDRESS                                                     64920002
*R2 INCREMENT BY TRACK SIZE                                             64960002
*R3 END OF STORAGE BLOCK                                                65000002
*R4 CYL FLAG ADDRESS                                                    65040002
*R5 0000HHHH                                                            65080002
*R6 INCREMENT HEAD BY 1                                                 65120002
*R7 NO. TRACKS PER CYL                                                  65160002
*RCH 0000CCCC                                                           65200002
*RM CONFIGURATION MAP ADDRESS                                           65240002
         SPACE 1                                                        65280002
ICFSPNG   EQU   *                                                       65320002
         LA    RM,ICFCONF         CONFIGURATION MAP                     65360002
         LA    R4,ICFCYFL         CYL FLAGS                             65400002
         LA    R6,Q1                                                    65440002
         L     R1,ICFBPT          SKIP FIRST TRACK                      65480002
         LR    R5,R6              **                                    65520002
         MVC   ICFCHSV(Q4),Q4(RM) SAVE FIRST TRACK ADDRESS              65560002
         TM    Q0(R4),Q3F         IS FIRST TRACK SPARE?                 65600002
         BNZ   ICFSR              NO                                    65640002
         STH   R5,ICFCHSV+2       UPDATE THIS                           65680002
         AR    R5,R6              SELECT NEXT TRACK                     65720002
ICFSR    EQU   *                                                        65760002
         STH   R5,Q6(RM)           POINT AT 2ND TRACK                   65800002
         ST    R1,Q0(RM)           ADR 0 + BYTES PER TRACK              65840002
ICFSR1   EQU   *      * NEW BLOCK *                                     65880002
         TM    Q0(RM),QFF         LAST BLOCK USED?                      65920002
         BO    ICFLT1             YES                                   65960002
         MVI   ICFBFLAG,Q0        CLEAR BLOCK FLAG                      66000002
         LH    R5,Q6(RM)          STARTING TRACK                        66040002
         L     R1,Q0(RM)          STARTING ADR                          66080002
         L     R3,Q8(RM)          ENDING ADR                            66120002
         ST    R3,ICFTOP          FOR ERR COR                           66160002
         LH    RCH,Q4(RM)         STARTING CYL                          66200002
         EJECT                                                          66240002
         SPACE 3                                                        66280002
ICFSR2   EQU   *      * NEW CYL *                                       66320002
         TM    Q0(R4),QC0         CYL USED?                             66360002
         BZ    ICFLT2             NO-END                                66400002
         L     R2,ICFBPT          BYTES PER TRACK                       66440002
         LH    R7,Q14(RM)         LAST TRACK TO BE USED                 66480002
         CH    RCH,Q12(RM)        IS THIS LAST CYL?                     66520002
         BE    ICFSR3             YES                                   66560002
         L     R7,ICFTRPC         TRACKS PER CYL                        66600002
         S     R7,ICF2            DOWN 2-ADJUST FOR BXLE                66640002
         TM    Q0(R4),Q80         BAD TRACK THIS CYL?                   66680002
         BZ    ICFSR3             NO                                    66720002
         LA    R7,Q1(R7)          YES-BUMP COUNT BY 1                   66760002
        SPACE 1                                                         66800002
ICFSR3   EQU   *                                                        66840002
         NI    Q0(R4),Q3F         CLEAR FLAG--GET SPARE TRACK           66880002
ICFSR4   EQU   *                                                        66920002
         STH   RCH,ICFCCHA        SET CCCC                              66960002
         STH   R5,ICFCCHA+2       SET TRACK TO READ                     67000002
         CLC   ICFCCHA+3(Q1),Q0(R4) IS THIS SPARE TRACK                 67040002
         BNE   ICFSR5             NO                                    67080002
         LA    R5,Q1(R5)          YES-GO TO NEXT TRACK                  67120002
         B     ICFSR4                                                   67160002
ICFSR5   EQU   *                                                        67200002
         STCM  R1,M7,ICFREAD+1    SET ADR IN CCW                        67240002
         BXH   R1,R2,ICFLST       UPDATE ADR                            67280002
ICFSR6   EQU   *                                                        67320002
         STH   R2,ICFREAD+6       SET COUNT IN CCW                      67360002
         BAL   RBL,ICFSIO        GO RAED A TRACK                        67400002
         B     ICFTROK           TRACK OK                               67440002
         MVC   ICFGOOD(Q8),ICFBUM SET PARTIAL RESTORE                   67480002
         B     ICFTROK1                                                 67520002
         EJECT                                                          67560002
         SPACE 3                                                        67600002
ICFTROK  EQU   *                                                        67640002
***FOOTPRINT BIT 9-1 OR MORE DATA TRACKS RESTORED***                    67680002
        OI    Q1(R14),Q40                                               67720002
ICFTROK1 EQU   *                                                        67760002
         XC    ICFRTCT,ICFRTCT    CLEAR RETRY CTR                       67800002
         NI    Q2(R14),Q3                                               67840002
         TM    ICFBFLAG,Q80        NEED NEW BLOCK?                      67880002
         BO    ICFSR1              YES                                  67920002
         BXLE  R5,R6,ICFSR4                                             67960002
         SR    R5,R5               START NEXT AT TRACK 0                68000002
         LA    R4,Q1(R4)           NEXT CYL FLAG                        68040002
         LA    RCH,Q1(RCH)         NEXT CYL                             68080002
***FOOTPRINT BIT 10-1 OR MORE CYLS RESTORED***                          68120002
         OI    Q1(R14),Q20                                              68160002
         B     ICFSR2                                                   68200002
ICFLST   EQU   *                                                        68240002
         SR    R1,R3              GET COUNT DIFFERENT                   68280002
         SR    R2,R1              SET IN R2                             68320002
         LA    RM,Q16(RM)         SET FOR NEW BLOCK                     68360002
         TS    ICFBFLAG                                                 68400002
***FOOTPRINT BIT 11-1 OR MORE STORAGE BLOCKS RESTORED***                68440002
         OI    Q1(R14),Q16                                              68480002
         B     ICFSR6                                                   68520002
***FOOTPRINT BIT 14-DAT END FLAGGED BY LAST STOR BLOCK***               68560002
ICFLT1   EQU   *                                                        68600002
         OI    Q1(R14),Q2                                               68640002
         B     ICFLT                                                    68680002
***FOOTPRINT BIT 15-DATA FLAGGED BY LAST CYL FLAG***                    68720002
ICFLT2   EQU   *                                                        68760002
         OI    Q1(R14),Q1                                               68800002
         EJECT                                                          68840002
ICFLT    EQU   *                                                        68880002
* * * THIS SECTION RESTORES FIRST TRACK--ADR 0 * * *                    68920002
***FOOTPRINT BIT 4-DATA(LESS FIRST TRACK) RESTORED***                   68960002
        OI    Q0(R14),Q8                                                69000002
         L     R2,ICFRADR          GET RAEDY TO MOVE                    69040002
         L     R3,ICFX800          2048 BYTES                           69080002
         LR    R4,R15              FROM PRESENT LOCATION                69120002
         LR    R5,R3               2048 BYTES                           69160002
         MVCL  R2,R4               MOVE                                 69200002
         L     R15,ICFRADR         SET BASE REG TO NEW LOCATION         69240002
         B     *+4                 CHANGE                               69280002
         LA    R14,ICFFOOT         KEEP FOOTPRINT HANDY                 69320002
***FOOTPRINT BIT 5-PROGRAM MOVED TO DUMP WORK AREA***                   69360002
         OI    Q0(R14),Q4                                               69400002
         LA    RM,ICFCCH           EXTENT ADR                           69440002
         STCM  RM,M7,ICFSEEK+1     SET IN SEEK CCW                      69480002
         LA    RM,Q2(RM)                                                69520002
         STCM  RM,M7,ICFSERCH+1    SET IN SEARCH CCW                    69560002
         LA    RM,ICFSERCH         ADR OF SEARCH                        69600002
         STCM  RM,M7,ICFTIC+1      SET IN TIC                           69640002
         LA    RM,ICFCCHX          DUMMY EXTENT                         69680002
         STCM  RM,M7,ICFSEEKX+1                                         69720002
         MVC   ICFREAD+6(Q2),ICFBPT+2 CCW COUNT                         69760002
         XC    ICFREAD+1(Q3),ICFREAD+1 READ TO ADR 0                    69800002
         LA    RM,ICFSDAT          SENSE                                69840002
         STCM  RM,M7,ICFSENSE+1                                         69880002
         MVC   ICFCCHA(Q4),ICFCHSV  EXTENT FIRST TRACK                  69920002
         LA    RM,ICFEINT         RE-INIT PSWS                          69960002
         ST    RM,ICFMCHA                                               70000002
         MVC   ICFION(Q8),ICFMCH                                        70040002
         LA    RM,ICFDINT                                               70080002
         ST    RM,ICFDPSW+4                                             70120002
         ICM   RCW,M7,ICFPX+1      CHECK FOR PREFIX                     70160002
         BZ    ICFNPX              NONE                                 70200002
         MVC   ICFPGNEW(Q24,RCW),ICFPGNEW MOVE PSWS IF PREFIXING        70240002
*        SPX   ICFPX               SET PREFIX                           70280002
         DC    X'B210',S(ICFPX) TEMP DC FOR ASM                         70320002
ICFNPX   EQU   *                                                        70360002
         MVC   ICFPSAVE(Q24),ICFPGNEW    *SAVE PSWS                     70400002
***FOOTPRINT BIT 6-RE-INITIALIZATION COMPLETE***                        70440002
         OI    Q0(R14),Q2                                               70480002
         BAL   RBL,ICFSIO           READ                                70520002
         B     ICFLTOK                                                  70560002
         BAL   RBL,ICFERR                                               70600002
***FOOTPRINT BIT 25-FIRST TRACK NOT RESTORED***                         70640002
         OI    Q3(R14),Q40                                              70680002
         LPSW  ICFBUM                                                   70720002
         EJECT                                                          70760002
ICFLTOK  EQU   *                                                        70800002
***FOOTPRINT BIT 7-FIRST TRACK RESTORE COMPLETE-RESTORE COMPLETE***     70840002
         OI    Q0(R14),Q1                                               70880002
         LPSW  ICFGOOD                                                  70920002
         SPACE 2                                                        70960002
* ERROR HANDLING *                                                      71000002
        SPACE 1                                                         71040002
ICFERR   EQU   *                                                        71080002
         TM    ICFSDAT,QC0        COMMAND REJECT OR INTERVENTION?       71120002
         BNZ   ICFBOMB1           YES-QUIT                              71160002
         TM    ICFSDAT,Q8          DATA ERROR?                          71200002
         BZ    ICFERND             NO-GO TO RETRY                       71240002
         TM    ICFSDAT+2,Q40       CORRECTABLE?                         71280002
         BO    ICFERC              YES-GO CORRECT                       71320002
ICFERND  EQU   *                                                        71360002
         ST    RBL,ICFRBLSV       SAVE LINK REG                         71400002
***FOOTPRINT BIT 20-IN TRACK RETRY***                                   71440002
***FOOTPRINT BIT 23-1 OR MORE TRACKS RETRIED***                         71480002
         OI    Q2(R14),Q8                                               71520002
         OI    Q2(R14),Q1                                               71560002
         LH    RCW,ICFRTCT         GET RETRY COUNT                      71600002
         LA    RCW,Q1(RCW)         ADD 1                                71640002
         STH   RCW,ICFRTCT         SAVE                                 71680002
         CH    RCW,ICFTEN          TEN RETRIES?                         71720002
         BH    ICFFAIL             YES-GIVE UP ON THIS TRACK            71760002
         L     RBL,ICFCCHA         PICK FAILING TRACK                   71800002
         C     RCW,ICF2           FIRST OR SECOND RETRY?                71840002
         BH    ICFSTAY            NEITHER                               71880002
         BE    ICFDOWN            SECOND                                71920002
         LA    RBL,Q1(RBL)        UP NEXT TRACK                         71960002
         B     ICFSTAY                                                  72000002
ICFDOWN  EQU   *                                                        72040002
         S     RBL,ICF1           DOWN 1 TRACK                          72080002
ICFSTAY  EQU   *                                                        72120002
         ST    RBL,ICFCCHXA       SET TRACK EXTENT                      72160002
         LA    RCW,ICFSEEKX       DO DUMMY SEEK                         72200002
         BAL   RBL,ICFSIO0                                              72240002
         NOP   *                  IGNORE ERRORS                         72280002
         L     RBL,ICFRBLSV                                             72320002
         S     RBL,ICF12                                                72360002
         BR    RBL                RETURN TO ORIGIN                      72400002
         EJECT                                                          72440002
ICFERC   EQU   *                                                        72480002
         TM    ICFSDAT+1,Q1        INCOMPLETE?                          72520002
         BO    ICFERND             YES-RETRY                            72560002
***FOOTPRINT BIT 19-IN CORRECTABLE ERROR ROUTINE***                     72600002
***FOOTPRINT BIT 22-1 OR MORE CORRECTABLE ERRORS OCCURRED***            72640002
         OI    Q2(R14),QX12                                             72680002
         ICM   RCW,M7,ICFSDAT+15   GET RESTART DISPLACEMENT             72720002
         LH    RZ,ICFSDAT+18       GET ERROR DISPLACEMENT               72760002
         SR    RCW,RZ              COMPUTE FORWARD DISPLACEMENT         72800002
         ICM   RZ,M7,ICFREAD+1     GET STARTING ADR                     72840002
         AR    RCW,RZ              ADR OF ERROR                         72880002
         L     RZ,ICFTOP           TOP OF STORAGE?                      72920002
         SR    RZ,RCW              GET DIFFERENCE                       72960002
         C     RZ,ICF3             LESS THAN 3?                         73000002
         BNL   ICFERC1             NO                                   73040002
         STC   RZ,ICFXOR+1         YES-CHANGE COUNT                     73080002
ICFERC1  EQU   *                                                        73120002
ICFXOR   XC    Q0(Q3,RCW),ICFSDAT+20 CORRECT ERROR                      73160002
         MVI   ICFXOR+1,Q2                                              73200002
         S     RBL,ICF8                                                 73240002
         BR    RBL                                                      73280002
         SPACE 1                                                        73320002
* * *MAPS UNRESTORABLE TRACKS* * *                                      73360002
         SPACE 1                                                        73400002
ICFFAIL  EQU   *                                                        73440002
***FOOTPRINT BIT 24-1 OR MORE TRACKS FAILED TO RESTORE***               73480002
         OI    Q3(R14),Q80                                              73520002
         LH    RCW,ICFTFCT        COUNT TRACK FAILURES                  73560002
         LA    RCW,Q1(RCW)        ADD  1                                73600002
         STH   RCW,ICFTFCT        SAVE                                  73640002
         CH    RCW,ICFTEN         TEN TRACKS FAILED?                    73680002
         BH    ICFBOMB4           YES-QUIT                              73720002
         LA    RCW,ICFLAST        FIND SPOT TO MAP                      73760002
ICFFAIL1 EQU   *                                                        73800002
         CLI   Q0(RCW),QEE        USED SPOT?                            73840002
         BE    ICFFAIL2           NO-USE IT                             73880002
         LA    RCW,Q12(RCW)       YES-LOOK AT NEXT                      73920002
         B     ICFFAIL1                                                 73960002
ICFFAIL2 EQU   *                                                        74000002
         MVC   Q0(Q4,RCW),ICFCCHA SAVE CCCCHHHH                         74040002
         MVI   Q4(RCW),Q0                                               74080002
         MVC   Q5(Q3,RCW),ICFREAD+1 SAVE STARTING ADR                   74120002
         L     RZ,Q4(RCW)                                               74160002
         A     RZ,ICFBPT         COMPUTE ENDING ADR                     74200002
         ST    RZ,Q8(RCW)                                               74240002
         BR    RBL               RETURN                                 74280002
ICFBOMB4 EQU   *                                                        74320002
***FOOTPRINT BIT 29-10 TRACKS FAILED TO RESTORE***                      74360002
         OI    Q3(R14),Q4                                               74400002
         LPSW  ICFBUM                                                   74440002
         EJECT                                                          74480002
* * *I/O SUB-ROUTINE* * *                                               74520002
        SPACE 1                                                         74560002
ICFSIO   EQU   *                                                        74600002
***FOOTPRINT BIT 16-CURRENT-IN I/O ROUTINE***                           74640002
         OI    Q2(R14),Q80                                              74680002
         ST    RBL,ICFRBLSV                                             74720002
         LA    RCW,ICFSEEK                                              74760002
         NI    ICFSFLAG,Q0                                              74800002
ICFSIO0  EQU   *                                                        74840002
         ST    RCW,ICFCAW                                               74880002
ICFSIOA  SIO   Q0                                                       74920002
         BC    BUSY,ICFSIOA       CC=2 BUSY                             74960002
         BC    STAT,ICFSTIO       CC=1 STATUS STORED                    75000002
         BC    NOTOP,ICFBOMB1     CC=3 NOT OPERATIONAL                  75040002
ICFTIO   EQU   *                                                        75080002
***FOOTPRINT BIT 17-GOING TO TIO***                                     75120002
         OI    Q2(R14),Q40                                              75160002
ICFTIOA  TIO   Q0                                                       75200002
         BC    BUSY,ICFTIOA                                             75240002
         BC    STAT,ICFSTIO                                             75280002
         BC    NOTOP,ICFBOMB1                                           75320002
         NI    Q2(R14),Q3F                                              75360002
         BR    RBL                                                      75400002
ICFBOMB1 EQU   *                                                        75440002
***FOOTPRINT BIT 31-DEVICE NOT OPERATIVE***                             75480002
         OI    Q3(R14),Q1                                               75520002
         LPSW  ICFBUM                                                   75560002
ICFBOMB8 EQU   *                                                        75600002
***FOOTPRINT BIT 28-UNIT CHECK ON SENSE***                              75640002
         OI    Q3(R14),Q8                                               75680002
         LPSW  ICFBUM                                                   75720002
ICFSTIO  EQU   *                                                        75760002
         NC    ICFCSW+4(Q2),ICFENMSK ANY ENDING STATUS?                 75800002
         BZ    ICFTIO             NO-LOOP UNTIL END                     75840002
         TM    ICFCSW,Q4          LOGOUT PENDING?                       75880002
         BO    ICFTRY             YES                                   75920002
         TM    ICFCSW+5,Q3F       CHANNEL ERRORS?                       75960002
         BNZ   ICFTRY             YES-GO CLEAR                          76000002
         TM    ICFCSW+4,Q42       UNIT CHECK-STATUS MODIFIER?           76040002
         BZ    ICFTIO             NO-CLEAR AND RETURN                   76080002
         TM    ICFCSW+4,Q40       STATUS MODIFIER?                      76120002
         BZ    ICFCK              NO-ASSUME UNIT CK                     76160002
         B     ICFLPSWE           GO ENABLE FOR I/O INTERRUPT           76200002
         EJECT                                                          76240002
         SPACE 3                                                        76280002
* * * UNIT CHECK * * *                                                  76320002
         SPACE 1                                                        76360002
ICFCK    EQU   *                                                        76400002
         TS    ICFSFLAG                                                 76440002
         BM    ICFBOMB8                                                 76480002
***FOOTPRINT BIT 18-UNIT CHECK, DOING SENSE***                          76520002
         OI    Q2(R14),Q20                                              76560002
         LA    RBL,Q4(RBL)                                              76600002
         LA    RCW,ICFSENSE                                             76640002
         XC    ICFSDAT,ICFSDAT    CLEAR SENSE FIELD                     76680002
         B     ICFSIO0                                                  76720002
         SPACE 1                                                        76760002
* * *THIS SECTION ENABLES CHANNELS TO CLEAR CHANNEL ERRORS* * *         76800002
***FOOTPRINT BIT 21-IN CHANNEL ERROR HANDLER***                         76840002
***FOOTPRINT BIT 27-1 OR MORE CHANNEL ERRORS***                         76880002
ICFTRY   EQU   *                                                        76920002
         OI    Q2(R14),Q4                                               76960002
         OI    Q3(R14),Q16                                              77000002
         LH    RCW,ICFCECT        GET ERROR COUNT                       77040002
         LA    RCW,Q1(RCW)        ADD 1                                 77080002
         STH   RCW,ICFCECT        SAVE                                  77120002
         CH    RCW,ICFTEN         TEN ERRORS?                           77160002
         BNL   ICFBOMB2           YES-QUIT                              77200002
ICFLPSWE EQU   *                                                        77240002
         MVC   ICFPGNEW(Q24),ICFPSAVE    *RESTORE PSWS                  77280002
         LPSW  ICFMCH            ENABLE                                 77320002
ICFEINT  EQU   *                                                        77360002
         BAL   RBL,ICFTIO        GO DO TIO AGAIN                        77400002
         LPSW  ICFDPSW           DISABLE                                77440002
ICFDINT  EQU   *                                                        77480002
         L     RBL,ICFRBLSV                                             77520002
         B     ICFSIO          GO TO SIO                                77560002
ICFBOMB2 EQU   *                                                        77600002
***FOOTPRINT BIT 30-10 CHANNEL ERRORS***                                77640002
         OI    Q3(R14),Q2                                               77680002
         LPSW  ICFBUM                                                   77720002
         EJECT                                                          77760002
* * * DOUBLE WORDS, CCW S, ETC. * * *                                   77800002
*     *=MUST BE CONTIGUOUS                                              77840002
ICFSEEK  CCW   7,0,X'60',6        *                                     77880002
ICFSERCH CCW   X'31',0,X'60',5    *                                     77920002
ICFTIC   CCW   8,0,X'60',0        *                                     77960002
ICFREAD  CCW   6,0,X'20',0        *                                     78000002
ICFSENSE CCW   4,0,X'20',24                                             78040002
ICFSEEKX CCW   7,0,X'60',6        *                                     78080002
ICFREADX CCW   6,0,X'30',1        *                                     78120002
ICFGOOD  DC    X'0002000000000026'                                      78160002
ICFBUM   DC    X'0002000000000027'                                      78200002
ICFEPSW  DC    X'0204000000000000'                                      78240002
ICFDPSW  DC    D'0'                                                     78280002
ICFPSAVE DC    3D'0'         *                                          78320002
         DC    H'0'               *SPACER                               78360002
ICFCCH   DC    H'0'               *                                     78400002
ICFCCHA  DC    C'CCHH'            *                                     78440002
         DC    X'0100'            *                                     78480002
ICFCCHX  DC    H'0'               *                                     78520002
ICFCCHXA DC    C'CCHH'            *                                     78560002
         DC    X'0100'            *                                     78600002
* * * FULL WORDS * * *                                                  78640002
         DS    0F                                                       78680002
ICFPCT   DC    X'EE'               PADDING CHARACTER MVCL               78720002
         DC    AL3(ICFLAST-ICFFIRST) COUNT OF PROG                      78760002
ICFX800  DC    F'2048'                                                  78800002
ICF4095  DC    F'4095'                                                  78840002
ICFX1000 DC    F'4096'                                                  78880002
ICFCHSV  DC    F'0'                                                     78920002
ICFRBLSV DC    F'0'                                                     78960002
ICF1     DC    F'1'                                                     79000002
ICF2    DC    F'2'                                                      79040002
ICF3    DC    F'3'                                                      79080002
ICF4    DC    F'4'                                                      79120002
ICF8    DC    F'8'                                                      79160002
ICF12   DC    F'12'                                                     79200002
ICFENMSK DC    X'463F0000'                                              79240002
ICFTOP   DC    F'0'                                                     79280002
         EJECT                                                          79320002
         SPACE 3                                                        79360002
* * * MISCELLANEOUS * * *                                               79400002
ICFFLAG  DC    F'0'                FLAGS                                79440002
ICFSFLAG EQU   ICFFLAG            UNIT CHECK                            79480002
ICFBFLAG EQU   ICFFLAG+1          STORAGE BLOCK                         79520002
ICF1FLAG EQU   ICFFLAG+2          FIRST TRACK                           79560002
ICFKFLAG EQU   ICFFLAG+3          STOR PROT                             79600002
ICFTEN   DC    H'10'                                                    79640002
ICFRTCT  DC    H'0'                                                     79680002
ICFCECT  DC    H'0'                                                     79720002
ICFTFCT  DC    H'0'                                                     79760002
ICFMASK  DC    X'8040201008040200'                                      79800002
ICFCYFL  DC    32F'0'             * CYL FLAGS                           79840002
ICFBPT   DC    F'0'               * BYTES PER TRACK                     79880002
ICFRADR  DC    F'0'               * OVERLAY ADDRESS                     79920002
ICFCONF  DC    32F'0'             * CONFIG MAP                          79960002
ICFTRPC  DC    F'0'               * TRKS PER CYL                        80000002
ICFPX    DC    F'0'                                                     80040002
ICFRSPTC DC    100X'EE'    *******PATCH AREA*******                     80080002
ICFSDAT  DC    XL24'0'            SENSE FIELD                           80120002
ICFFOOT  DC    F'0'                                                     80160002
ICFLAST  EQU   *                                                        80200002
         DS    30F                                                      80240002
         TITLE 'POWER WARNING FEATURE INITIALIZATION MODULE'            80280002
         DROP  R15                                                      80320002
         DROP  RTAB                                                     80360002
         USING ICFBIE00,R11,R12   *REESTABLISH MODULE ADDRESSABILITY    80400002
         USING ICFTIFDS,R13  *REESTABLISH ADDRESSABILITY TO WORK AREA   80440002
         USING ICFWORKA,R10  *REESTABLISH COMM.AREA ADDRESSABILITY      80480002
         SPACE 3                                                        80520002
ICFREST  EQU   *             *SET UP FOR RESTORE                        80560002
         LA    R5,ICFIOMAP   *PREPARE TO FIND AVAILABLE PATH            80600002
         LR    R8,R13        *SAVE POINTER TO OUR SAVE & WORK AREA      80640002
         LA    R13,D12(R13)  *ADJUST POINTER TO SAVE AREA FOR IOSGEN    80680002
         BAL   R14,ICFNDPTH  *GO FIND AVLBL PATH TO WARN DEVICE         80720002
         LR    R13,R8        *RESET POINTER TO OUR SAVE & WORK AREA     80760002
         XC    ICFCTRDA,ICFCTRDA  *CLEAN ICFCTRDA FIELD                 80800002
         LA    R7,ICFCTRDA   *PREPARE TO CHECK RESTORE PATH             80840002
         BAL   R8,ICFSDADD   *GO CHECK PATH FOR RESTORE                 80880002
         MVC   ICFSV8,ICFIOB+D35  *GET CCCCHHHH OF CNTL TRK             80920002
         L     R9,ICFSV8     *PUT IT IN R9 FOR RESTORE ROUTINE          80960002
*******************************************************************     81000002
         ESTAE 0    *CANCEL ESTAE  (LEAVING THE SYSTEM BEHIND)          81040002
*******************************************************************     81080002
         SPACE 3                                                        81120002
*   MAKE SURE THAT THE RESTORE ROUTINE IS ALL CONTAINED               * 81160002
*   WHITHIN A 4K PAGE. IF IT CROSSES A 4K PAGE BOUNDARY               * 81200000
*   RELOCATE IT WITHIN A PAGE OVERLAYING THE INITIAL                  * 81240002
*   PART OF ICFBIF00.                                                 * 81280002
         SPACE 1                                                        81320002
         LA    R4,ICFBRE00   *GET START OF RESTORE ROUTINE              81360002
         LR    R14,R4        *SAVE FOR LATER USE                        81400002
         LR    R15,R4         SAVE FOR LATER                   @ZA00760 81410000
         LA    R6,ICFBCODE   *GET END OF CODE TO BE RELOCATED           81440002
         LR    R7,R6         *SAVE IT FOR LATER USE                     81480002
         SRL   R4,D12         ALIGN TO 4K PAGE BOUNDARY        @ZA00760 81520000
         SRL   R6,D12         ALIGN TO 4K PAGE BOUNDARY        @ZA00760 81560000
         CR    R4,R6          DOES ROUTINE CROSS PAGE BOUNDARY @ZA00760 81600000
         BE    ICFNOREL      *NO, DON'T RELOCATE RESTORE ROUTINE        81640002
**********************************************************************  81680002
         OI    ICFTRMSA+D3,X80    *UPDATE FOOTPRINT TABLE***********    81720002
**********************************************************************  81760002
         LA    R4,ICFBIE00   *GET START OF MODULE                       81800002
         LA    R4,D4095(R4)   ALIGN TO NEXT 4K BOUNDARY        @ZA00760 81840000
         SRL   R4,D12                                          @ZA00760 81880000
         SLL   R4,D12                                          @ZA00760 81920000
         LR    R15,R4        *SET UP BASE REGISTER FOR RESTORE          81960002
         SR    R14,R15       *COMPUTE RELOCATION FACTOR                 82000002
         LA    R6,ICFBRE00   *GET START OF RESTORE ROUTINE              82040002
         SR    R7,R6         *GET LENGTH OF RESTORE ROUTINE             82080002
         LR    R5,R7         *IN BOTH LENGTH REGISTERS                  82120002
         MVCL  R4,R6         *RELOCATE RESTORE ROUTINE SO THAT          82160002
*                            *IT FITS WITHIN A 2K PAGE                  82200002
         SR    R11,R14       *ADJUST FIRST BASE REGISTER                82240002
         SR    R12,R14       *ADJUST SECOND BASE REGISTER               82280002
         B     ICFNOREL      *START EXECUTING RELOCATED CODE            82320002
ICFNOREL EQU   *                                                        82360002
         SPACE 3                                                        82400002
         LRA   R7,ICFMCIL    *GET REAL ADDR.OF STRG.CHK INNER LOOP      82440002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  82480002
         LRA   R15,D0(R15)   *RESTORE NEEDS REAL ADDRESS                82520002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  82560002
         LRA   R2,ICFCTB11   *GET REAL ADDR.OF 1ST STRG BLK FLD         82600002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  82640002
         LRA   R8,ICFMCOL    *GET REAL ADDR.OF OUTER LOOP               82680002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  82720002
         ST    R8,ICFBCPSW+D4     *SET REAL INST.ADDR.IN B.C. MODE PSW  82760002
         LA    R4,ICFBRE00   *COMPUTE DISPLACEMENT OF                   82800002
         SR    R4,R11        *RESTORE ROUTINE ENTRY POINT               82840002
         LRA   R3,ICFBRE00   *GET REAL ADDRESS OF RESTORE ROUTINE E.P.  82880002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  82920002
         SR    R3,R4         *NOW BACK UP TO MODULE ENTRY POINT         82960002
         ST    R3,ICFADR4    *SAVE REAL ADDRESS OF THIS MODULE'S E.P.   83000002
         LRA   R10,D0(R10)   *GET REAL ADDR.OF COMM. AREA               83040002
         BNZ   ICFLRAER      *IF ERROR GO SEND MESSAGE                  83080002
         USING PSA,R0        *ESTABLISH PSA ADDRESSABILITY              83120002
         MVC   ICFSVPIN,PINPSW  *SAVE PGM NEW PSW                       83160002
         LA    R3,ICFMCR     *GET POINTER TO OUR PGM INTR ROUT          83200002
         ST    R3,PINPSW+D4  *SET IT IN PGM NEW PSW                     83240002
         STOSM PINPSW,X00    *SET CURRENT SYSTEM MASK IN PGM NEW PSW    83280002
         NI    PINPSW,XFC     *DISABLE AGAINST I/O AND EXTERNALS        83320002
         STOSM ICFRSM+D1,X00 *SAVE CURRENT SYSTEM MASK FOR LATER USE    83360002
         LPSW  ICFBCPSW      *NOW SWITCH TO B.C. MODE                   83400002
ICFMCOL  EQU   *                                                        83440002
         L     R3,D0(R2)     *GET STRG ADR OF S.O.B.                    83480002
         LA    R4,D4         *SET INCREMENT FOR BXLE                    83520002
         L     R5,D8(R2)     *GET STRG ADR OF E.O.B.                    83560002
         BCTR  R5,D0         *DON'T GO                                  83600002
         BCTR  R5,D0         *OUT OF                                    83640002
         BCTR  R5,D0         *STORAGE BLOCK                             83680002
ICFMCIL  EQU   *                                                        83720002
         L     R6,D0(R3)     *ACCESS 1 WORD OF STRG - IF STRG IS NOT    83760002
*              ONLINE A PGM CHK INTERRUPT WILL OCCUR GIVING CONTROL TO  83800002
*              ICFMCR. OTHERWISE CONTROL WILL GO TO NEXT INSTRUCTION.   83840002
         BXLE  R3,R4,D0(R7)  *KEEP SCANNING STRG BLOCK                  83880002
         LA    R2,D16(R2)     *GET NEXT STRG BLK FIELD                  83920002
         TM    D0(R2),XFF    *ARE WE FINISHED?                          83960002
         BNO   D0(R8)        *NO, GO HANDLE NEXT STRG BLK               84000002
         SPACE 3                                                        84040002
         L     R11,ICFADR4   *ADJUST THE BASE REGISTERS                 84080002
         LA    R12,D4095(R11)     *OF THIS MODULE                       84120002
         LA    R12,D1(R12)   *FOR BASIC CONTROL MODE                    84160002
         MVC   PINPSW(D8),ICFPSW27     *NO PGM CHKS SHOULD OCCUR        84200002
         L     R2,ICFADR3    *GET REAL POINTER TO CSD FROM COMM.AREA    84240002
         USING CSD,R2        *ESTABLISH CSD ADDRESSABILITY              84280002
         CLI   CSDCPUOL+D1,X01    *IS MORE THAN ONE CPU ONLINE?         84320002
         BH    ICFRMPPR       *YES, GO TO MP INTERFACE PROCESSING       84360002
         TM    CSDFLAGS,CSDMP     *ARE WE ON MP SYST?                   84400002
         BO    ICFCPUOK       *YES, GO SET PREFIX REGISTER TO ZERO      84440002
         B     ICFNOTMP      *NO, BYPASS MP CODE                        84480002
         DROP  R2                                                       84520002
ICFRMPPR EQU   *    *SET UP RESTORE INTFC.FOR MP                        84560002
*        STAP  ICFIOMAP+D10  *STORE CPU ADDRESS                         84600002
         DC    X'B212',S(ICFIOMAP+D10) *SIMULATE STAP INSTR.            84640002
         MVC   ICFIOMAP+D8(D2),ICFIOMAP+D10  *SAVE IT FOR LATER         84680002
         XI    ICFIOMAP+D11,X01   *GET OTHER CPU'S ADDRESS              84720002
         LH    R3,ICFIOMAP+D10    *SET IT IN REGISTER FOR SIGP          84760002
         SLL   R3,D2         *MULTIPLY BY 4 TO INDEX PCCA VECTOR TABLE  84800002
         L     R6,ICFADR2    *GET REAL ADDRESS OF PCCA VECTOR TABLE     84840002
         L     R6,D0(R3,R6)  *GET VIRTUAL ADDR. OF OTHER CPU'S PCCA     84880002
         SRL   R3,D2         *RESET OTHER CPU'S ADDR. FOR SIGP          84920002
         LRA   R6,D0(R6)     *GET REAL ADDR. OF OTHER CPU'S PCCA        84960002
         USING PCCA,R6       *ESTABLISH PCCA ADDRESSABILITY             85000002
         L     R6,PCCAPSAR   *GET REAL ADDRESS OF PSA                   85040002
         DROP  R6                                                       85080002
         MVC   D0(D8,R6),ICFPSW26 *PREPARE TO PUT OTHER CPU IN WAIT 026 85120002
         SR    R2,R2         *CLEAN STATUS REGISTER FOR SIGP            85160002
ICFIROCP EQU   *                                                        85200002
*        SIGP  R2,R3,ICFSIGPR     *ISSUE 'PRGM RESET' SIGP              85240002
         DC    X'AE230008'   *SIMULATE SIGP INSTRUCTION                 85280002
         BNZ   ICFIROCP      *IF NOT ACCEPTED TRY IT AGAIN              85320002
         SR    R2,R2         *CLEAN STATUS REGISTER FOR SIGP            85360002
ICFISOCP EQU   *                                                        85400002
*        SIGP  R2,R3,ICFSIGPS     *ISSUE 'RESTART' TO OTHER CPU         85440002
         DC    X'AE230006'   *SIMULATE SIGP INSTRUCTION                 85480002
         BNZ   ICFISOCP      *IF NOT ACCEPTED TRY IT AGAIN              85520002
         LH    R5,ICFIOMAP+D8     *GET ADDRESS OF OUR CPU               85560002
         LA    R4,D1         *SET MASK BIT IN R4                        85600002
*        USING THE CPU ADDRESS TO INDEX THE 'PATH ON CPU' FLAGS         85640002
*        IN ICFCTRDA, SEE IF WE HAVE A PATH TO THE                      85680002
         SLL   R4,D0(R5)     *RESTORE DEVICE FROM THIS CPU              85720002
         EX    R4,ICFTMINS   *DO WE HAVE A PATH FOR RESTORE ON THIS CPU 85760002
         BO    ICFCPUOK      *YES, WE ARE NOW READY TO RESTORE          85800002
         MVC   D0(D8,R6),ICFBCPSW *SET RESTART PSW FOR OTHER CPU        85840002
         MVI   D7(R6),X8C    *SET INSTR.ADDR. IN RESTART PSW            85880002
         XC    D4(D3,R6),D4(R6)   *CLEAN REST OF INSTR.ADDR.            85920002
         MVC   X8C(D12,R6),ICFRSCOD    *SET RESTART CODE FOR OTHER CPU  85960002
         STM   R10,R12,X80(R6)    *SAVE BASE REGISTERS IN OTHER PSA     86000002
         STM   R13,R9,ICFIOMAP+D12     *SAVE OTHER GPR'S IN COMM.AREA   86040002
         SR    R2,R2         *CLEAR STATUS REGISTER FOR SIGP            86080002
ICFROCPU EQU   *                                                        86120002
*        SIGP  R2,R3,ICFSIGPR  *ISSUE 'PRGM RESET' TO OTHER CPU         86160002
         DC    X'AE230008'   *SIMULATE SIGP INSTRUCTION                 86200002
         BNZ   ICFROCPU      *IF NOT ACCEPTED TRY IT AGAIN              86240002
         SR    R2,R2         *CLEAR STATUS REGISTER FOR SIGP            86280002
ICFSOCPU EQU   *                                                        86320002
*        SIGP  R2,R3,ICFSIGPS     *ISSUE 'RESTART' TO OTHER CPU.        86360002
         DC    X'AE230006'   *SIMULATE SIGP INSTRUCTION                 86400002
         BNZ   ICFSOCPU      *IF NOT ACCEPTED TRY IT AGAIN              86440002
*                                                                       86480002
*        AT THIS POINT THE OTHER CPU (WHICH HAS A PATH TO THE           86520002
*        RESTORE DEVICE) WILL LOAD ITS GPR'S FROM WHERE WE              86560002
*        JUST SAVED THEM AND BRANCH TO ICFCPUOK TO ENTER THE            86600002
*        RESTORE ROUTINE.                                               86640002
*                                                                       86680002
         LPSW  ICFPSW26  *THIS CPU WILL GO TO THE WAIT STATE (CODE 026) 86720002
         SPACE 3                                                        86760002
ICFCPUOK EQU   *             *WE ARE NOW RUNNING ON THE RIGHT CPU       86800002
*        SPX   ICFBCPSW      *SET PREFIX REGISTER TO ZERO               86840002
         DC    X'B210',S(ICFBCPSW)  *SIMULATE SPX INSTRUCTION           86880002
ICFNOTMP EQU   *                                                        86920002
         BR    R15           *GO TO RESTORE IN B.C.MODE & DISABLED      86960002
         SPACE 3                                                        87000002
ICFMCR   EQU   *             *CONTROL WILL BE GIVEN TO THIS CODE IF     87040002
*              DURING A STORAGE SCAN A PROGRAM INTERRUPT OCCURRED.      87080002
*              THIS MEANS THAT WE DON'T HAVE THE SAME REAL STORAGE      87120002
*              CONFIGURATION AS AT THE TIME OF DUMP. THIS SECTION WILL  87160002
*              NOTIFY THE OPERATOR AND GO TO WAIT STATE (CODE 027).     87200002
         MVC   PINPSW(D8),ICFSVPIN     *RESTORE PGM NEW PSW             87240002
ICFRSM   STOSM ICFSVPIN,X00  *RESET ORIGINAL SYSTEM MASK (ENABLED)      87280002
         LA    R1,ICFISCMS   *GET MSG POINTER                           87320002
         WTO   MF=(E,(R1))   *SEND 'INVALID STRG CONFIG' MSG            87360002
         B     ICFWAITR      *GO QUIT WITH WAIT 027                     87400002
         SPACE 3                                                        87440002
ICFLRAER EQU   *             *LRA INSTRUCTION FAILED                    87480002
         LA    R1,ICFLRAMS   *GET MESSAGE POINTER                       87520002
         WTO   MF=(E,(1))    *SEND 'LRA ERROR' MESSAGE                  87560002
         SPACE 1                                                        87600002
ICFWAITR EQU   *                                                        87640002
         LA    R1,ICFREIPL   *SEND REIPL MESSAGE                        87680002
         WTO   MF=(E,(1))                                               87720002
         STIMER WAIT,BINTVL=CFBI20S    *GIVE MSG TIME TO BE DISPLAYED   87760002
         LPSW  ICFPSW27      *LOAD DISABLED WAIT PSW (CODE 027)         87800002
         SPACE 5                                                        87840002
ICFRSCOD EQU   *             *RESTART CODE TO BE MOVED TO OTHER PSA     87880002
         LM    R10,R12,X80(R0)    *INITIALIZE BASE REGISTERS            87920002
         LM    R13,R9,ICFIOMAP+D12     *INITIALIZE OTHER GPR'S          87960002
         B     ICFCPUOK      *GO TO RESTORE ROUTINE                     88000002
*        END OF THE RESTART CODE TO BE MOVED TO OTHER PSA               88040002
ICFTMINS TM    ICFCTRDA+D1,X00    *IS PATH ON THIS CPU AVAILABLE        88080002
ICFSIGPR EQU   X08           *SIGP CODE FOR PROGRAM RESET               88120002
ICFSIGPS EQU   X06           *SIGP CODE FOR RESTART                     88160002
         SPACE 5                                                        88200002
ICFSVPIN DC    D'0'          *SAVE AREA FOR PGM NEW PSW                 88240002
ICFBCPSW DC    D'0'          *PSW USED TO SWITCH TO B.C. MODE           88280002
ICFPSW27 DC    X'0002000000000027'  *DISABLED WAIT PSW (CODE 027)       88320002
ICFPSW26 DC    X'0002000000000026'  *SUCCESSFUL COMPLETION PSW          88360002
CFBI20S  DC    F'300'        *3 SECS IN BINARY INTERVALS                88400002
ICFREIPL WTO   'ICFTIM98 CORRECT PROBLEM AND RE-IPL',                  C88440002
               DESC=2,ROUTCDE=(1),MF=L                                  88480002
ICFISCMS WTO   'ICFTIM97 INVALID STORAGE CONFIGURATION FOR RESTORE',DESC88520002
               C=2,ROUTCDE=(1),MF=L                                     88560002
ICFLRAMS WTO   'ICFTIM96 ERROR DURING EXECUTION OF LRA INSTRUCTION',DESC88600002
               C=2,ROUTCDE=(1),MF=L                                     88640002
ICFBCODE EQU   *             *END OF CODE TO BE RELOCATED               88680002
         DROP  R10                                                      88720002
         DROP  R11                                                      88760002
         DROP  R12                                                      88800002
         DROP  R13                                                      88840002
         TITLE 'ICFBIX50 - DUMMY USER EXIT ROUTINE FOR PWF'             88880002
*********************************************************************** 88920002
*                                                                     * 88960002
*  THIS MODULE IS PART OF THE POWER WARNING FEATURE SUPPORT.          * 89000002
*                                                                     * 89040002
* FUNCTION-IMMEDIATELY RETURN CONTROL TO THE CALLING MODULE           * 89080002
*          WHEN THE USER DOES NOT SUPPLY HIS EXIT ROUTINE.            * 89120002
*                                                                     * 89160002
*********************************************************************** 89200002
         SPACE 5                                                        89240002
ICFBIE50 EQU  *                                                         89280002
         USING ICFBIE50,R15  *ESTABLISH ADDRESSABILITY FOR USER EXIT    89320002
         SR    R15,R15        .SET RETURN CODE TO ZERO                  89360002
         BR    R14            RETURN TO CALLER                          89370002
         DROP  R15                                                      89400002
         TITLE 'POWER WARNING FEATURE INITIALIZATION MODULE'            89440002
         END                                                            89480002
./  ADD  SSI=32251288,NAME=ICFBIX00
         TITLE 'ICFBIX00 - DUMMY M.S.I. APPENDAGE'                      03000002
*********************************************************************** 06000002
*                                                                     * 09000002
* FUNCTION-IMMEDIATELY RETURN CONTROL TO THE CALLING MSI MODULE       * 18000002
*                                                                     * 27000002
*********************************************************************** 30000002
         SPACE 5                                                        33000002
ICFBIE00 CSECT                                                          36000002
R14      EQU   14             .RETURN REGISTER                          39000002
R15      EQU   15             .RETURN CODE REGISTER                     42000002
         SPACE 5                                                        45000002
         SR    R15,R15        .SET RETURN CODE TO ZERO                  48000002
         BR    R14            .RETURN TO CALLER                         51000002
         END                                                            54000002
